(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const f of o)if(f.type==="childList")for(const c of f.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function i(o){const f={};return o.integrity&&(f.integrity=o.integrity),o.referrerPolicy&&(f.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?f.credentials="include":o.crossOrigin==="anonymous"?f.credentials="omit":f.credentials="same-origin",f}function n(o){if(o.ep)return;o.ep=!0;const f=i(o);fetch(o.href,f)}})();class je{constructor(){this.down=new Set,this.pressedThisFrame=new Set,window.addEventListener("keydown",t=>{this.down.has(t.code)||this.pressedThisFrame.add(t.code),this.down.add(t.code),["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","KeyW","KeyA","KeyS","KeyD"].includes(t.code)&&t.preventDefault()},{passive:!1}),window.addEventListener("keyup",t=>this.down.delete(t.code))}beginFrame(){this.pressedThisFrame.clear()}endFrame(){}isDown(t){return this.down.has(t)}wasPressed(t){return this.pressedThisFrame.has(t)}getMovementDirection(){return{x:(this.isDown("ArrowRight")?1:0)+(this.isDown("ArrowLeft")?-1:0),y:(this.isDown("ArrowDown")?1:0)+(this.isDown("ArrowUp")?-1:0)}}getWASDHorizontal(){return(this.isDown("KeyD")?1:0)+(this.isDown("KeyA")?-1:0)}}class $e{constructor(t){this.lastTime=0,this.running=!1,this.scene=null,this.loop=n=>{if(!this.running||!this.scene)return;const o=Math.min(1/30,(n-this.lastTime)/1e3);this.lastTime=n,this.input.beginFrame(),this.scene.update(o,this),this.scene.render(this.ctx,this),this.input.endFrame(),requestAnimationFrame(this.loop)},this.canvas=t;const i=t.getContext("2d");if(!i)throw new Error("2D context not available");this.ctx=i,this.input=new je,this.resizeToDisplay()}resizeToDisplay(){var f,c;const t=Math.max(1,Math.min(window.devicePixelRatio||1,2)),i=this.canvas.getBoundingClientRect(),n=Math.floor(i.width*t)||800,o=Math.floor(i.height*t)||600;(this.canvas.width!==n||this.canvas.height!==o)&&(this.canvas.width=n,this.canvas.height=o),this.ctx.setTransform(1,0,0,1,0,0),(c=(f=this.scene)==null?void 0:f.onResize)==null||c.call(f,this)}setScene(t){this.scene=t,t.init(this),this.running||(this.running=!0,this.lastTime=performance.now(),requestAnimationFrame(this.loop))}}class At{constructor(t=50,i=50,n=28,o=28,f){this.vx=0,this.vy=0,this._score=0,this.hp=3,this.maxHp=3,this.fireCooldown=0,this.x=t,this.y=i,this.width=n,this.height=o}setPosition(t,i){this.x=t,this.y=i}passObstacle(){this._score+=1}update(t){this.x+=this.vx*t,this.y+=this.vy*t,this.fireCooldown>0&&(this.fireCooldown=Math.max(0,this.fireCooldown-t))}get score(){return Math.max(0,this._score)}set score(t){this._score=Math.max(0,t)}}class rt{constructor(t,i,n,o,f=120){this.x=t,this.y=i,this.width=n,this.height=o,this.speed=f}update(t){this.x-=this.speed*t}isOffScreen(){return this.x+this.width<0}}class te{render(t,i,n,o,f){t.fillStyle="#e8e8f0",t.font="700 20px system-ui, sans-serif",typeof n=="number"?t.fillText(`P1: ${i}   P2: ${n}`,16,24):t.fillText(`Score: ${i}`,16,24);const c=(a,p,x)=>{if(x!=null)for(let m=0;m<x;m++){t.fillStyle="#ff7b72",t.beginPath();const w=m*18;t.moveTo(a+w+6,p+10),t.arc(a+w+3,p+8,3,0,Math.PI),t.arc(a+w+9,p+8,3,0,Math.PI),t.lineTo(a+w+6,p+14),t.closePath(),t.fill()}};c(16,36,o),f!=null&&c(120,36,f)}}const bt=class bt{static applyGravity(t,i){t.vy+=bt.gravity*i}static jump(t){t.vy=bt.jumpVelocity}static checkCollision(t,i){return!(t.x+t.width<i.x||t.x>i.x+i.width||t.y+t.height<i.y||t.y>i.y+i.height)}};bt.gravity=900,bt.jumpVelocity=-300;let W=bt;class ee{constructor(t,i){this.canvas=t,this.ctx=i,this.t=0,this.cloudOffset=0,this.palette={top:"#0f1630",bottom:"#0b1022"}}setPalette(t,i){this.palette.top=t,this.palette.bottom=i}clear(t=0){const{ctx:i}=this,n=this.canvas.width,o=this.canvas.height;this.t+=t,this.cloudOffset=(this.cloudOffset+t*20)%(n+200);const f=i.createLinearGradient(0,0,0,o);f.addColorStop(0,this.palette.top),f.addColorStop(1,this.palette.bottom),i.fillStyle=f,i.fillRect(0,0,n,o);const c=(a,p,x)=>{i.fillStyle="#ffffff14",i.beginPath(),i.roundRect(a,p,120*x,40*x,20*x),i.fill()};for(let a=0;a<4;a++){const p=n-(this.cloudOffset+a*180)%(n+200),x=40+a*45%(o*.5);c(p,x,1)}i.fillStyle="#1a2446",i.fillRect(0,o-20,n,20),i.fillStyle="#111a36";for(let a=0;a<n;a+=16)i.fillRect(a,o-22,8,2)}drawBird(t,i){const{ctx:n}=this,o=Math.min(t.width,t.height)/2,f=t.x+o,c=t.y+o,a=Math.sin(this.t*10)*.6;n.fillStyle=i,n.beginPath(),n.arc(f,c,o,0,Math.PI*2),n.fill(),n.fillStyle="#ffffff88",n.beginPath(),n.arc(f-o*.2,c+o*.1,o*.7,Math.PI*.1,Math.PI*1.2),n.fill(),n.save(),n.translate(f-o*.2,c),n.rotate(-.8+a),n.fillStyle="#00000022",n.beginPath(),n.ellipse(0,0,o*.9,o*.5,0,0,Math.PI*2),n.fill(),n.restore(),n.fillStyle="#ffd166",n.beginPath(),n.moveTo(f+o*.9,c),n.lineTo(f+o*1.4,c-o*.2),n.lineTo(f+o*.9,c+o*.2),n.closePath(),n.fill(),n.fillStyle="#fff",n.beginPath(),n.arc(f+o*.2,c-o*.3,o*.22,0,Math.PI*2),n.fill(),n.fillStyle="#000",n.beginPath(),n.arc(f+o*.25,c-o*.3,o*.1,0,Math.PI*2),n.fill()}drawPlayer(t,i="#58a6ff"){this.drawBird(t,i)}drawObstacle(t){const{ctx:i}=this,n=i.createLinearGradient(t.x,t.y,t.x+t.width,t.y);n.addColorStop(0,"#2bc072"),n.addColorStop(1,"#3be688"),i.fillStyle=n,i.fillRect(t.x,t.y,t.width,t.height),i.fillStyle="#ffffff18",i.fillRect(t.x+6,t.y,6,t.height)}drawHUD(t){this.ctx.fillStyle="#e8e8f0",this.ctx.font="700 24px system-ui, sans-serif",this.ctx.fillText(t,16,32)}drawProjectile(t,i="#ffd166"){const{ctx:n}=this;n.fillStyle=t.color||i,n.fillRect(t.x,t.y,t.width,t.height)}drawEnemy(t){const{ctx:i}=this,n=t.variant||"drone";n==="tank"?(i.fillStyle="#c65353",i.beginPath(),i.roundRect(t.x,t.y,t.width,t.height,4),i.fill(),i.fillStyle="#00000055",i.fillRect(t.x+3,t.y+t.height-6,t.width-6,4)):n==="bee"?(i.fillStyle="#ffd166",i.beginPath(),i.ellipse(t.x+t.width/2,t.y+t.height/2,t.width/2,t.height/2,0,0,Math.PI*2),i.fill(),i.fillStyle="#00000066",i.fillRect(t.x+4,t.y+4,t.width-8,4),i.fillRect(t.x+4,t.y+10,t.width-8,4)):n==="kamikaze"?(i.fillStyle="#ff7b72",i.beginPath(),i.ellipse(t.x+t.width/2,t.y+t.height/2,t.width/2,t.height/2,0,0,Math.PI*2),i.fill(),i.fillStyle="#ffffffaa",i.beginPath(),i.arc(t.x+t.width/2+3,t.y+t.height/2-2,3,0,Math.PI*2),i.fill()):(i.fillStyle="#ff7b72",i.beginPath(),i.ellipse(t.x+t.width/2,t.y+t.height/2,t.width/2,t.height/2,0,0,Math.PI*2),i.fill(),i.fillStyle="#00000055",i.fillRect(t.x+2,t.y+2,t.width-4,3))}drawPowerUp(t){const{ctx:i}=this,n={heal:"#7ee787",rapid:"#f7b84a",shield:"#8b8efb",multishot:"#38bdf8",bigshot:"#fb7185",slowmo:"#a78bfa",magnet:"#f472b6"};i.fillStyle=n[t.type]||"#f7b84a",i.beginPath(),i.roundRect(t.x,t.y,t.width,t.height,4),i.fill(),i.fillStyle="#0f172a",i.font="700 10px system-ui";const o=t.x+t.width/2,f=t.y+t.height/2+3,a={heal:"+",rapid:"R",shield:"S",multishot:"M",bigshot:"B",slowmo:"⌛",magnet:"U"}[t.type]||"?",p=i.measureText(a).width;i.fillText(a,o-p/2,f)}}class Ge{constructor(){this.ctx=null,this._muted=!1}get muted(){return this._muted}set muted(t){this._muted=t;try{localStorage.setItem("mute",t?"1":"0")}catch{}}ensure(){this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext))}beep(t,i=.08,n="sine",o=.05){if(this._muted)return;this.ensure();const f=this.ctx,c=f.createOscillator(),a=f.createGain();c.type=n,c.frequency.value=t,a.gain.value=o,c.connect(a).connect(f.destination);const p=f.currentTime;c.start(p),c.stop(p+i)}flap(){this.beep(660,.05,"square",.05)}score(){this.beep(880,.08,"triangle",.06)}hit(){this.beep(120,.15,"sawtooth",.08)}combo(t){if(this._muted)return;const i=900+Math.min(4,t)*80;this.beep(i,.05,"triangle",.05)}}const F=new Ge;try{F.muted=localStorage.getItem("mute")==="1"}catch{}class jt{constructor(){this.pool=[],this.active=[]}spawn(t,i,n){const o=this.pool.pop()||{x:t,y:i,vx:0,vy:0,life:.5,maxLife:.5,size:3,color:"#fff"};o.x=t,o.y=i,o.vx=(n==null?void 0:n.vx)??Math.random()*80-40,o.vy=(n==null?void 0:n.vy)??Math.random()*-80,o.life=(n==null?void 0:n.life)??.5,o.maxLife=o.life,o.size=(n==null?void 0:n.size)??3,o.color=(n==null?void 0:n.color)??"#ffffff88",o.g=(n==null?void 0:n.g)??200,this.active.push(o)}burst(t,i,n,o){for(let f=0;f<n;f++)this.spawn(t,i,{color:o,size:2+Math.random()*2,life:.4+Math.random()*.3})}update(t){for(let i=this.active.length-1;i>=0;i--){const n=this.active[i];n.vy+=(n.g||0)*t,n.x+=n.vx*t,n.y+=n.vy*t,n.life-=t,n.life<=0&&(this.pool.push(n),this.active.splice(i,1))}}render(t){for(const i of this.active){const n=Math.max(0,i.life/i.maxLife);t.fillStyle=i.color.replace(/\d?\.?\d*\)$/,"")||i.color,t.globalAlpha=n,t.beginPath(),t.arc(i.x,i.y,i.size,0,Math.PI*2),t.fill(),t.globalAlpha=1}}}function We(l){return l===2?"shoot":"flap"}class qe{constructor(t,i,n,o,f="player"){this.width=10,this.height=4,this.active=!0,this.damage=1,this.x=t,this.y=i,this.vx=n,this.vy=o,this.owner=f}update(t){this.x+=this.vx*t,this.y+=this.vy*t}isOffScreen(t,i){return this.x>t+20||this.x+this.width<-20||this.y>i+20||this.y+this.height<-20}}class Ke{constructor(t,i,n=-120,o=0,f="drone"){this.x=t,this.y=i,this.vx=n,this.vy=o,this.variant=f,f==="tank"?(this.width=34,this.height=26,this.health=3):(this.width=24,this.height=18,this.health=1)}update(t){this.x+=this.vx*t,this.y+=this.vy*t}isOffScreen(){return this.x+this.width<-40}}class He{constructor(t,i,n){this.width=16,this.height=16,this.vx=-80,this.vy=0,this.x=t,this.y=i,this.type=n}update(t){this.x+=this.vx*t,this.y+=this.vy*t}isOffScreen(){return this.x+this.width<-40}}const _e="scores:v1",Kt="playerName";function le(){try{const l=localStorage.getItem(_e);if(!l)return[];const t=JSON.parse(l);return Array.isArray(t)?t.map(i=>({score:Number(i.score)||0,date:Number(i.date)||Date.now(),name:typeof i.name=="string"?i.name:void 0})).filter(i=>i.score>=0&&Number.isFinite(i.date)):[]}catch{return[]}}function ce(l){try{localStorage.setItem(_e,JSON.stringify(l))}catch{}}const et={addScore(l,t=Date.now(),i){const n=le(),o=(i??localStorage.getItem(Kt)??"Anon").toString().slice(0,18).trim()||"Anon";n.push({score:Math.max(0,Math.floor(l)),date:t,name:o}),n.sort((c,a)=>a.score-c.score||a.date-c.date);const f=n.slice(0,10);ce(f)},getTop(l=5){const t=le();return t.sort((i,n)=>n.score-i.score||n.date-i.date),t.slice(0,l)},clear(){ce([])},getPlayerName(){try{return localStorage.getItem(Kt)}catch{return null}},setPlayerName(l){try{localStorage.setItem(Kt,(l||"").toString().slice(0,18).trim()||"Anon")}catch{}}},It=class It{constructor(){var t;this._reducedMotion=!1,this._usingSystemPreference=!0;try{const i=localStorage.getItem(It.STORAGE_KEY);if(i!=null)this._reducedMotion=i==="1",this._usingSystemPreference=!1;else if(typeof window<"u"&&"matchMedia"in window){const n=window.matchMedia("(prefers-reduced-motion: reduce)");this._reducedMotion=n.matches,this._usingSystemPreference=!0;try{(t=n.addEventListener)==null||t.call(n,"change",o=>{this._usingSystemPreference&&(this._reducedMotion=o.matches)})}catch{}}}catch{}}get reducedMotion(){return this._reducedMotion}set reducedMotion(t){this._reducedMotion=t,this._usingSystemPreference=!1;try{localStorage.setItem(It.STORAGE_KEY,t?"1":"0")}catch{}}toggleReducedMotion(){this.reducedMotion=!this.reducedMotion}};It.STORAGE_KEY="reducedMotion";let Vt=It;const it=new Vt;function Ve(l,t=Math.random){let i={heal:2.2,shield:1.6,rapid:1.2,multishot:1,bigshot:.9,slowmo:.9,magnet:1};if(l<5)i.multishot*=.3,i.bigshot*=.3,i.slowmo*=.4,i.magnet*=.5,i.heal*=1.3,i.shield*=1.2;else if(l<15){const c=(l-5)/10;i.multishot*=.3+.7*c,i.bigshot*=.3+.7*c,i.slowmo*=.4+.6*c,i.magnet*=.5+.5*c}else i.rapid*=1.1,i.multishot*=1.15,i.bigshot*=1.1;const n=Object.entries(i).filter(([c,a])=>a>0),o=n.reduce((c,[,a])=>c+a,0);let f=t()*o;for(const[c,a]of n)if(f-=a,f<=0)return c;return n[n.length-1][0]}const Rt=class Rt{constructor(){this.player=new At(80,150,26,26),this.obstacles=[],this.hud=new te,this.timeToNext=0,this.score=0,this.best=0,this.gameOver=!1,this.paused=!1,this.speed=120,this.particles=new jt,this.shakeT=0,this.hintT=4,this.bullets=[],this.enemies=[],this.powerUps=[],this.enemyTimer=0,this.powerTimer=5,this.lastGapCenter=null,this.floats=[],this.playerName=null,this.hurtT=0,this.combo=0,this.comboT=0,this.ended=!1,this.multishotT=0,this.bigshotT=0,this.slowmoT=0,this.magnetT=0,this.rapidT=0,this.pickupBadgeT=0,this.mobileMoveX=0,this.isTouch="ontouchstart"in window,this.btnLeftDown=!1,this.btnRightDown=!1,this.btnShootDown=!1,this.btnRects=null,this.restartRect=null}init(t){this.renderer=new ee(t.canvas,t.ctx),this.obstacles=[],this.score=0,this.timeToNext=0,this.gameOver=!1,this.paused=!1,this.speed=120,this.player.x=80,this.player.y=Math.max(0,(t.canvas.height-this.player.height)*.5),this.player.vx=0,this.player.vy=0,this.player.hp=this.player.maxHp=3,this.player.fireCooldown=0,this.bullets=[],this.enemies=[],this.powerUps=[],this.enemyTimer=2.5,this.powerTimer=5,this.hintT=4,this.shakeT=0,this.floats=[],this.lastGapCenter=null,this.ended=!1,this.btnLeftDown=this.btnRightDown=this.btnShootDown=!1,this.restartRect=null,this.multishotT=0,this.bigshotT=0,this.slowmoT=0,this.magnetT=0,this.rapidT=0;const i=()=>{const p=t.canvas.width,x=t.canvas.height,m=Math.max(60,Math.min(120,Math.floor(Math.min(p,x)*.14))),w=24;this.btnRects={left:{x:w,y:x-m-w,w:m,h:m},right:{x:w+m+16,y:x-m-w,w:m,h:m},shoot:{x:p-m-w,y:x-m-w,w:m,h:m}}},n=()=>{const p=t.canvas.width,x=t.canvas.height,m=Math.max(64,Math.min(120,Math.floor(Math.min(p,x)*.16)));this.restartRect={x:(p-m)/2,y:x*.55,w:m,h:m}},o=(p,x,m)=>{if(!this.btnRects)return!1;const w=this.btnRects[p];return x>=w.x&&x<=w.x+w.w&&m>=w.y&&m<=w.y+w.h},f=p=>{i(),this.btnLeftDown=this.btnRightDown=this.btnShootDown=!1;const x=t.canvas.getBoundingClientRect(),m=t.canvas.width/x.width,w=t.canvas.height/x.height;for(let u=0;u<p.touches.length;u++){const g=p.touches.item(u),S=(g.clientX-x.left)*m,v=(g.clientY-x.top)*w;o("left",S,v)?this.btnLeftDown=!0:o("right",S,v)?this.btnRightDown=!0:o("shoot",S,v)&&(this.btnShootDown=!0)}},c=p=>{var w;if(this.gameOver){if(p.touches!==void 0){n();const u=p,g=t.canvas.getBoundingClientRect(),S=t.canvas.width/g.width,v=t.canvas.height/g.height;for(let M=0;M<u.touches.length;M++){const T=u.touches.item(M),_=(T.clientX-g.left)*S,E=(T.clientY-g.top)*v,I=this.restartRect;if(_>=I.x&&_<=I.x+I.w&&E>=I.y&&E<=I.y+I.h){this.init(t);return}}}else{n();const u=this.restartRect,g=p,S=t.canvas.getBoundingClientRect(),v=t.canvas.width/S.width,M=t.canvas.height/S.height,T=(g.clientX-S.left)*v,_=(g.clientY-S.top)*M;if(T>=u.x&&T<=u.x+u.w&&_>=u.y&&_<=u.y+u.h){this.init(t);return}}return}if(p.touches!==void 0){const u=p;if(f(u),this.btnLeftDown||this.btnRightDown||this.btnShootDown){this.btnShootDown&&this.fireWeapon();return}const g=t.canvas.width,S=t.canvas.height,v=t.canvas.getBoundingClientRect(),M=g/v.width,T=S/v.height;let _=!1;for(let I=0;I<u.touches.length;I++){const A=u.touches.item(I),C=(A.clientX-v.left)*M,K=(A.clientY-v.top)*T;if(C>g*.7&&K>S*.6){_=!0;break}}if(_){this.fireWeapon();return}(((w=u.touches)==null?void 0:w.length)??0)>=2?this.fireWeapon():(W.jump(this.player),F.flap(),this.particles.burst(this.player.x+this.player.width*.2,this.player.y+this.player.height,it.reducedMotion?4:8,"#88ccff88"));return}const x=p.button??0,m=We(x);m==="flap"?(W.jump(this.player),F.flap()):m==="shoot"&&this.fireWeapon()};t.canvas.oncontextmenu=p=>{p.preventDefault()},t.canvas.onpointerdown=c;const a=p=>{const x=t.canvas.getBoundingClientRect();let m=0,w=0;for(let u=0;u<p.touches.length;u++){const S=p.touches.item(u).clientX-x.left;S<x.width*.45?m=1:S>x.width*.55&&(w=1)}this.mobileMoveX=w-m};t.canvas.ontouchstart=p=>{a(p),c(p)},t.canvas.ontouchmove=p=>{a(p),f(p)},t.canvas.ontouchend=p=>{a(p),f(p)};try{const p=localStorage.getItem("best");p&&(this.best=parseInt(p,10)||0)}catch{}try{this.playerName=et.getPlayerName()}catch{this.playerName=null}document.addEventListener("visibilitychange",()=>{document.hidden&&(this.paused=!0)})}fireWeapon(){if(this.player.fireCooldown>0)return;const t=this.player.x+this.player.width,i=this.player.y+this.player.height*.5-2,n=f=>{const a=Math.cos(f)*360,p=Math.sin(f)*360,x=new qe(t,i,a,p,"player");return this.bigshotT>0&&(x.width=14,x.damage=2,x.color="#ffa6a6"),x};this.multishotT>0?(this.bullets.push(n(0-.13)),this.bullets.push(n(0)),this.bullets.push(n(0+.13))):this.bullets.push(n(0));let o=this.bigshotT>0?.22:this.multishotT>0?.2:.18;this.rapidT>0&&(o=Math.max(.08,o*.55)),this.player.fireCooldown=o,F.beep(980,.05,"square",.05)}update(t,i){var m,w;const n=i.canvas.height;if(i.input.wasPressed("KeyP")&&(this.paused=!this.paused),i.input.wasPressed("KeyR")&&this.init(i),this.paused)return;const o=this.slowmoT>0?.7:1,f=t*o;(i.input.wasPressed("Space")||i.input.wasPressed("ArrowUp")||i.input.wasPressed("KeyW"))&&(W.jump(this.player),F.flap(),this.particles.burst(this.player.x+this.player.width*.2,this.player.y+this.player.height,it.reducedMotion?4:8,"#88ccff88")),(i.input.isDown("KeyJ")||i.input.isDown("ControlLeft")||i.input.isDown("ControlRight")||this.btnShootDown)&&this.fireWeapon();const c=i.input.getMovementDirection(),a=((w=(m=i.input).getWASDHorizontal)==null?void 0:w.call(m))??(i.input.isDown("KeyD")?1:0)+(i.input.isDown("KeyA")?-1:0),p=(this.btnRightDown?1:0)-(this.btnLeftDown?1:0);if(this.player.vx=(c.x+a+this.mobileMoveX+p)*80,W.applyGravity(this.player,f),this.player.update(f),this.player.y=Math.max(0,Math.min(n-this.player.height,this.player.y)),this.timeToNext-=f,this.timeToNext<=0){const u=Math.min(1,this.score/30);this.speed=Math.min(280,120+u*140);const g=Math.max(150,230-this.score*2.2);this.timeToNext=Math.max(1.1,1.8-this.score*.02);const S=g,v=60,M=v+S/2,T=n-v-S/2,_=this.lastGapCenter??n/2,E=140+Math.min(100,this.score*2),I=Math.max(M,_-E),A=Math.min(T,_+E),C=I<=A?I+Math.random()*(A-I):Math.min(T,Math.max(M,_)),K=Math.floor(C-S/2);this.lastGapCenter=C;const q=80,$=i.canvas.width+q;this.obstacles.push(new rt($,0,q,K,this.speed)),this.obstacles.push(new rt($,K+S,q,n-(K+S),this.speed))}for(const u of this.obstacles)u.update(f);this.obstacles=this.obstacles.filter(u=>!u.isOffScreen());for(const u of this.obstacles)W.checkCollision(this.player,u)&&(this.player.hp-=1,F.hit(),this.particles.burst(this.player.x+this.player.width/2,this.player.y+this.player.height/2,it.reducedMotion?6:12,"#ff7b72aa"),this.shakeT=it.reducedMotion?0:.2,this.hurtT=.35,this.combo=0,this.comboT=0,this.player.x-=10,this.player.hp<=0&&this.finalizeGameOver());for(let u=0;u<this.obstacles.length;u+=2){const g=this.obstacles[u],S=g.x+g.width/2;!this.gameOver&&S<this.player.x&&g.counted!==!0&&(g.counted=!0,this.score+=1,this.player.passObstacle(),F.score())}if(this.enemyTimer-=f,this.enemyTimer<=0){let u=40,g=n-40;if(this.obstacles.length>=2){let q=0,$=-1/0;for(let J=0;J<this.obstacles.length-1;J+=2){const st=this.obstacles[J];st.x>$&&($=st.x,q=J)}const ht=this.obstacles[q],X=this.obstacles[q+1];u=ht.height,g=X.y}const S=12,v=Math.max(0,u+S),M=Math.min(n-20,g-S-18),T=i.canvas.width+40,_=v<M?v+(M-v)*(.35+Math.random()*.3):40+Math.random()*(n-120);let E="drone";this.score>6&&Math.random()<.5&&(E="bee"),this.score>15&&Math.random()<.35&&(E="tank"),this.score>25&&Math.random()<.25&&(E="kamikaze");const A=-((E==="tank"?90:120)+Math.random()*60+this.score*1.2),C=new Ke(T,_,A,0,E);C.minY=isFinite(v)?v:20,C.maxY=isFinite(M)?M:n-40,C.phase=Math.random()*Math.PI*2,this.enemies.push(C);const K=2.4-Math.min(1.2,this.score*.03);this.enemyTimer=Math.max(.8,K+(E==="tank"?.3:0))}if(this.powerTimer-=f,this.powerTimer<=0){const u=Ve(this.score);this.powerUps.push(new He(i.canvas.width+20,80+Math.random()*(n-160),u)),this.powerTimer=8+Math.random()*6}for(const u of this.bullets)u.update(f);for(const u of this.enemies){const g=(u.phase??0)+performance.now()/1e3;if(u.variant==="kamikaze"){const T=this.player.y-6-u.y;u.vy=Math.max(-120,Math.min(120,T*2))}else u.variant==="bee"?u.vy=Math.sin(g*1.5)*55:u.variant==="tank"?u.vy=Math.sin(g*.6)*24:u.vy=Math.sin(g)*35;u.update(f);const S=u.minY??20,v=u.maxY??n-40;u.y<S&&(u.y=S),u.y+u.height>v&&(u.y=v-u.height)}for(const u of this.powerUps){if(this.magnetT>0){const g=this.player.x+this.player.width/2,S=this.player.y+this.player.height/2,v=g-(u.x+u.width/2),M=S-(u.y+u.height/2);v*v+M*M<200*200&&(u.vx+=Math.sign(v)*20,u.vy+=Math.sign(M)*20,!it.reducedMotion&&Math.random()<.25&&this.particles.burst(u.x+u.width/2,u.y+u.height/2,1,"#f472b6aa"))}u.update(f)}this.bullets=this.bullets.filter(u=>!u.isOffScreen(i.canvas.width,n)&&u.active),this.enemies=this.enemies.filter(u=>!u.isOffScreen()),this.powerUps=this.powerUps.filter(u=>!u.isOffScreen());const x=(u,g,S,v,M,T,_,E)=>u<M+_&&u+S>M&&g<T+E&&g+v>T;for(const u of this.bullets)for(const g of this.enemies)if(u.active&&x(u.x,u.y,u.width,u.height,g.x,g.y,g.width,g.height)&&(u.active=!1,g.health-=u.damage??1,this.particles.burst(g.x+g.width/2,g.y+g.height/2,it.reducedMotion?6:10,"#ffd166aa"),g.health<=0)){const S=g.x+g.width/2,v=g.y+g.height/2;this.particles.burst(S,v,it.reducedMotion?10:22,"#ffb347aa"),this.particles.burst(S,v,it.reducedMotion?8:14,"#ff7b72aa"),g.x=-9999;const M=g.variant==="tank"?Rt.KILL_POINTS+1:Rt.KILL_POINTS,T=2.2;this.comboT>0?this.combo++:this.combo=1,this.comboT=T;const _=Math.max(0,this.combo-1);this.score+=M+_,this.floats.push({x:S,y:v,text:`+${M}`,ttl:.9,vy:-32}),_>0&&(this.floats.push({x:S+14,y:v-18,text:`x${this.combo}`,ttl:.8,vy:-26}),F.combo(this.combo)),this.shakeT=it.reducedMotion?0:Math.max(this.shakeT,.12),F.score()}this.enemies=this.enemies.filter(u=>u.x>-9e3);for(const u of this.enemies)x(this.player.x,this.player.y,this.player.width,this.player.height,u.x,u.y,u.width,u.height)&&(this.player.hp-=1,F.hit(),this.particles.burst(u.x+u.width/2,u.y+u.height/2,10,"#ff7b72aa"),u.x=-9999,this.player.hp<=0&&this.finalizeGameOver());for(const u of this.powerUps)x(this.player.x,this.player.y,this.player.width,this.player.height,u.x,u.y,u.width,u.height)&&(u.type==="heal"&&(this.player.hp=Math.min(this.player.maxHp,this.player.hp+1)),u.type==="rapid"&&(this.rapidT=Math.max(this.rapidT,8)),u.type==="shield"&&(this.player.maxHp=Math.min(5,this.player.maxHp+1),this.player.hp=Math.min(this.player.maxHp,this.player.hp+1)),u.type==="multishot"&&(this.multishotT=Math.max(this.multishotT,8)),u.type==="bigshot"&&(this.bigshotT=Math.max(this.bigshotT,8)),u.type==="slowmo"&&(this.slowmoT=Math.max(this.slowmoT,3.5)),u.type==="magnet"&&(this.magnetT=Math.max(this.magnetT,8)),this.particles.burst(u.x+u.width/2,u.y+u.height/2,14,"#7ee787aa"),u.x=-9999,this.pickupBadgeT=1.4);this.particles.update(f),this.shakeT=Math.max(0,this.shakeT-t),this.hurtT=Math.max(0,this.hurtT-t),this.comboT>0&&(this.comboT=Math.max(0,this.comboT-t)),this.slowmoT=Math.max(0,this.slowmoT-t),this.multishotT=Math.max(0,this.multishotT-t),this.bigshotT=Math.max(0,this.bigshotT-t),this.magnetT=Math.max(0,this.magnetT-t),this.rapidT=Math.max(0,this.rapidT-t);for(const u of this.floats)u.ttl-=t,u.y+=u.vy*t;this.floats=this.floats.filter(u=>u.ttl>0),this.hintT=Math.max(0,this.hintT-t)}finalizeGameOver(){if(this.ended)return;this.ended=!0,this.gameOver=!0,this.best=Math.max(this.best,this.score);try{localStorage.setItem("best",String(this.best))}catch{}let t=et.getPlayerName()||"";try{const i=typeof window<"u"?window.prompt("Name for high score?",t||"Anon"):null;i!=null&&(t=i,et.setPlayerName(t))}catch{}et.addScore(this.score,Date.now(),t),this.playerName=t}render(t,i){const n=this.shakeT>0?(Math.random()-.5)*8:0;t.save(),t.translate(n,n),this.renderer.clear(1/60);for(const c of this.obstacles)this.renderer.drawObstacle(c);for(const c of this.enemies)this.renderer.drawEnemy(c);for(const c of this.powerUps)this.renderer.drawPowerUp(c);const o=this.hurtT>0?"#f87171":"#58a6ff";if(this.renderer.drawPlayer(this.player,o),this.playerName){const c=this.playerName.slice(0,18),a=this.player.x+this.player.width/2;let p=this.player.y-6;p<14&&(p=this.player.y+this.player.height+14),t.save(),t.textAlign="center",t.font="600 12px system-ui",t.lineWidth=3,t.strokeStyle="#00000077",t.strokeText(c,a,p),t.fillStyle="#cdd9e5",t.fillText(c,a,p),t.restore()}for(const c of this.bullets)this.renderer.drawProjectile(c);this.particles.render(t),this.hud.render(t,this.score,void 0,this.player.hp);{const c=[{active:this.rapidT>0,color:"#f7b84a",glyph:"R",rem:this.rapidT,dur:8},{active:this.multishotT>0,color:"#38bdf8",glyph:"M",rem:this.multishotT,dur:8},{active:this.bigshotT>0,color:"#fb7185",glyph:"B",rem:this.bigshotT,dur:8},{active:this.slowmoT>0,color:"#a78bfa",glyph:"⌛",rem:this.slowmoT,dur:3.5},{active:this.magnetT>0,color:"#f472b6",glyph:"U",rem:this.magnetT,dur:8}],p=16+(this.player.hp??0)*18+12;let x=p,m=36;const w=12,u=12,g=3,S=6,v=i.canvas.width-16;for(const M of c){if(!M.active)continue;x+w>v&&(x=p,m+=u+6),t.save(),t.globalAlpha=.95,t.fillStyle=M.color,t.beginPath(),t.roundRect(x,m+2,w,u,g),t.fill();const T=Math.max(0,Math.min(1,M.rem/M.dur));t.strokeStyle="#0f172a",t.lineWidth=1.5,t.beginPath(),t.arc(x+w/2,m+2+u/2,6,-Math.PI/2,-Math.PI/2+T*Math.PI*2),t.stroke(),t.fillStyle="#0f172a",t.font="700 9px system-ui";const _=t.measureText(M.glyph).width;t.fillText(M.glyph,x+(w-_)/2,m+11),t.restore(),x+=w+S}}if(this.pickupBadgeT>0){const c=Math.min(1,this.pickupBadgeT/1.4);t.save(),t.globalAlpha=c*.9;const a=[{label:"Rapid",active:this.rapidT>0,color:"#f7b84a"},{label:"Multi",active:this.multishotT>0,color:"#38bdf8"},{label:"Big",active:this.bigshotT>0,color:"#fb7185"},{label:"Slow",active:this.slowmoT>0,color:"#a78bfa"},{label:"Mag",active:this.magnetT>0,color:"#f472b6"}].filter(m=>m.active);let p=16,x=82;for(const m of a)t.fillStyle="#0f172acc",t.beginPath(),t.roundRect(p,x,86,22,8),t.fill(),t.fillStyle=m.color+"dd",t.beginPath(),t.roundRect(p+2,x+2,82,18,6),t.strokeStyle=m.color+"66",t.lineWidth=2,t.stroke(),t.fillStyle="#e8e8f0",t.font="700 12px system-ui",t.fillText(m.label,p+10,x+15),p+=94;t.restore()}if(this.slowmoT>0){const c=Math.min(.25,.15+this.slowmoT/4*.1);t.save(),t.globalAlpha=c,t.fillStyle="#0b1022",t.fillRect(0,0,i.canvas.width,i.canvas.height),t.restore()}const f=[];if(this.rapidT>0&&f.push({label:"Rapid",t:this.rapidT,d:8,color:"#f7b84a"}),this.multishotT>0&&f.push({label:"Multi",t:this.multishotT,d:8,color:"#38bdf8"}),this.bigshotT>0&&f.push({label:"Big",t:this.bigshotT,d:8,color:"#fb7185"}),this.slowmoT>0&&f.push({label:"Slow",t:this.slowmoT,d:4,color:"#a78bfa"}),this.magnetT>0&&f.push({label:"Mag",t:this.magnetT,d:8,color:"#f472b6"}),f.length){let c=16,a=56;for(const p of f){t.save(),t.globalAlpha=.9,t.fillStyle="#0f172acc",t.beginPath(),t.roundRect(c,a,74,20,8),t.fill();const u=Math.max(0,Math.min(1,p.t/p.d));t.fillStyle=p.color+"aa",t.beginPath(),t.roundRect(c+2,a+20-6,70*u,4,3),t.fill(),t.fillStyle="#e8e8f0",t.font="600 12px system-ui",t.fillText(p.label,c+8,a+14),t.restore(),c+=82}}if(this.comboT>0&&this.combo>1&&(t.save(),t.fillStyle="#ffd166",t.font="700 14px system-ui",t.fillText(`Combo x${this.combo}`,16,46),t.restore()),this.floats.length)for(const c of this.floats){const a=Math.max(0,Math.min(1,c.ttl/.9));t.save(),t.globalAlpha=a,t.fillStyle="#ffd166",t.font="700 18px system-ui",t.fillText(c.text,c.x,c.y),t.restore()}if(this.isTouch){const c=i.canvas.width,a=i.canvas.height,p=Math.max(60,Math.min(120,Math.floor(Math.min(c,a)*.14))),x=24;this.btnRects={left:{x,y:a-p-x,w:p,h:p},right:{x:x+p+16,y:a-p-x,w:p,h:p},shoot:{x:c-p-x,y:a-p-x,w:p,h:p}};const m=(w,u,g)=>{t.save(),t.globalAlpha=.5,t.fillStyle=u?"#58a6ff":"#0f172a",t.strokeStyle="#58a6ff88",t.lineWidth=4,t.beginPath(),t.roundRect(w.x,w.y,w.w,w.h,16),t.fill(),t.stroke(),t.fillStyle="#e8e8f0",t.font="700 28px system-ui";const S=g==="L"?"◀":g==="R"?"▶":"●",v=t.measureText(S).width;t.fillText(S,w.x+(w.w-v)/2,w.y+w.h/2+10),t.restore()};m(this.btnRects.left,this.btnLeftDown,"L"),m(this.btnRects.right,this.btnRightDown,"R"),m(this.btnRects.shoot,this.btnShootDown,"S")}if(this.hintT>0){const c=Math.min(.8,this.hintT/4);t.save(),t.globalAlpha=c,t.fillStyle="#00000088",t.fillRect(20,70,520,56),t.fillStyle="#e8e8f0",t.font="600 16px system-ui",t.fillText("Flap: Space/ArrowUp/W or Click • Move: Arrows or A/D • Shoot: Right Click or Ctrl/J (hold)",28,100),t.restore()}if(t.restore(),this.paused&&(t.fillStyle="#00000088",t.fillRect(0,0,i.canvas.width,i.canvas.height),t.fillStyle="#e8e8f0",t.font="700 28px system-ui",t.fillText("Paused (P). R = Restart, Esc = Title",40,120)),this.gameOver){t.fillStyle="#00000088",t.fillRect(0,0,i.canvas.width,i.canvas.height),t.fillStyle="#e8e8f0",t.font="700 28px system-ui",t.fillText(`Game Over — Score ${this.score}  Best ${this.best}`,40,120),t.font="500 18px system-ui",t.fillText("Press R or tap the restart button",40,160);const c=i.canvas.width,a=i.canvas.height,p=Math.max(64,Math.min(120,Math.floor(Math.min(c,a)*.16))),x=(c-p)/2,m=a*.55;this.restartRect={x,y:m,w:p,h:p},t.save(),t.globalAlpha=.9,t.fillStyle="#0f172a",t.strokeStyle="#58a6ff88",t.lineWidth=5,t.beginPath(),t.roundRect(x,m,p,p,18),t.fill(),t.stroke(),t.fillStyle="#e8e8f0",t.font="700 28px system-ui",t.fillText("⟲",x+p/2-10,m+p/2+12),t.restore()}}};Rt.KILL_POINTS=2;let kt=Rt;class Yt{constructor(){this.p1=new At(80,140,26,26),this.p2=new At(120,220,26,26),this.obstacles=[],this.hud=new te,this.timeToNext=0,this.s1=0,this.s2=0,this.paused=!1,this.speed=140,this.particles=new jt,this.shakeT=0}init(t){this.renderer=new ee(t.canvas,t.ctx),this.obstacles=[],this.timeToNext=0,this.s1=0,this.s2=0,this.paused=!1,this.speed=140;const i=()=>{W.jump(this.p1),F.flap()};t.canvas.ontouchstart=i,t.canvas.onpointerdown=i}update(t,i){const n=i.canvas.height;if(i.input.wasPressed("KeyP")&&(this.paused=!this.paused),i.input.wasPressed("KeyR")&&this.init(i),this.paused)return;(i.input.wasPressed("Space")||i.input.wasPressed("ArrowUp"))&&(W.jump(this.p1),F.flap(),this.particles.burst(this.p1.x,this.p1.y+this.p1.height,6,"#88ccff88")),i.input.wasPressed("KeyW")&&(W.jump(this.p2),F.flap(),this.particles.burst(this.p2.x,this.p2.y+this.p2.height,6,"#ffb08888"));const o=i.input.getMovementDirection();if(this.p1.vx=o.x*80,this.p2.vx=0,this.p2.vy+=(i.input.isDown("KeyS")?1:0)*300*t,W.applyGravity(this.p1,t),W.applyGravity(this.p2,t),this.p1.update(t),this.p2.update(t),this.p1.y=Math.max(0,Math.min(n-this.p1.height,this.p1.y)),this.p2.y=Math.max(0,Math.min(n-this.p2.height,this.p2.y)),this.timeToNext-=t,this.timeToNext<=0){this.speed=Math.min(260,this.speed+2);const f=Math.max(130,180-Math.max(this.s1,this.s2)*2);this.timeToNext=Math.max(1,1.7-Math.max(this.s1,this.s2)*.02);const c=40,a=n-f-40,p=Math.floor(Math.random()*(a-c+1))+c,x=80,m=i.canvas.width+x;this.obstacles.push(new rt(m,0,x,p,this.speed)),this.obstacles.push(new rt(m,p+f,x,n-(p+f),this.speed))}for(const f of this.obstacles)f.update(t);this.obstacles=this.obstacles.filter(f=>!f.isOffScreen());for(const f of this.obstacles)if(W.checkCollision(this.p1,f)||W.checkCollision(this.p2,f)){F.hit(),this.particles.burst((this.p1.x+this.p2.x)/2,(this.p1.y+this.p2.y)/2,16,"#ff7b72aa"),this.shakeT=.25,this.init(i);return}for(let f=0;f<this.obstacles.length;f+=2){const c=this.obstacles[f],a=c.x+c.width/2;a<this.p1.x&&c.p1c!==!0&&(c.p1c=!0,this.s1+=1,this.p1.passObstacle(),F.score()),a<this.p2.x&&c.p2c!==!0&&(c.p2c=!0,this.s2+=1,this.p2.passObstacle(),F.score())}}render(t,i){const n=this.shakeT>0?(Math.random()-.5)*8:0;t.save(),t.translate(n,n),this.renderer.clear(1/60);for(const o of this.obstacles)this.renderer.drawObstacle(o);this.renderer.drawPlayer(this.p1,"#58a6ff"),this.renderer.drawPlayer(this.p2,"#ff7b72"),this.particles.render(t),this.hud.render(t,this.s1,this.s2),t.restore(),this.paused&&(t.fillStyle="#00000088",t.fillRect(0,0,i.canvas.width,i.canvas.height),t.fillStyle="#e8e8f0",t.font="700 28px system-ui",t.fillText("Paused (P). R = Restart, Esc = Title",40,120))}}class zt extends Error{constructor(t){super(t),this.name="AbortError"}}function Ye(l,t){const{cleanupBeforeAbort:i,abortSignal:n,abortErrorMsg:o}=t??{};return new Promise((f,c)=>{function a(){c(new zt(o??"The operation was aborted."))}function p(){n==null||n.removeEventListener("abort",x)}function x(){i==null||i(),p(),a()}if(n!=null&&n.aborted)return a();try{l(m=>{p(),f(m)},m=>{p(),c(m)})}catch(m){c(m)}n==null||n.addEventListener("abort",x)})}const ze="The delay was aborted.";function Ut(l,t){let i;const{abortSignal:n,abortErrorMsg:o}={};return Ye(f=>{i=setTimeout(f,l)},{cleanupBeforeAbort:()=>clearTimeout(i),abortSignal:n,abortErrorMsg:o??ze})}function Je(l){return l&&l.__esModule&&Object.prototype.hasOwnProperty.call(l,"default")?l.default:l}var ie={exports:{}},xt=typeof Reflect=="object"?Reflect:null,fe=xt&&typeof xt.apply=="function"?xt.apply:function(t,i,n){return Function.prototype.apply.call(t,i,n)},Nt;xt&&typeof xt.ownKeys=="function"?Nt=xt.ownKeys:Object.getOwnPropertySymbols?Nt=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:Nt=function(t){return Object.getOwnPropertyNames(t)};function Xe(l){console&&console.warn&&console.warn(l)}var Te=Number.isNaN||function(t){return t!==t};function k(){k.init.call(this)}ie.exports=k;ie.exports.once=ei;k.EventEmitter=k;k.prototype._events=void 0;k.prototype._eventsCount=0;k.prototype._maxListeners=void 0;var ue=10;function Gt(l){if(typeof l!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof l)}Object.defineProperty(k,"defaultMaxListeners",{enumerable:!0,get:function(){return ue},set:function(l){if(typeof l!="number"||l<0||Te(l))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+l+".");ue=l}});k.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};k.prototype.setMaxListeners=function(t){if(typeof t!="number"||t<0||Te(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function Ee(l){return l._maxListeners===void 0?k.defaultMaxListeners:l._maxListeners}k.prototype.getMaxListeners=function(){return Ee(this)};k.prototype.emit=function(t){for(var i=[],n=1;n<arguments.length;n++)i.push(arguments[n]);var o=t==="error",f=this._events;if(f!==void 0)o=o&&f.error===void 0;else if(!o)return!1;if(o){var c;if(i.length>0&&(c=i[0]),c instanceof Error)throw c;var a=new Error("Unhandled error."+(c?" ("+c.message+")":""));throw a.context=c,a}var p=f[t];if(p===void 0)return!1;if(typeof p=="function")fe(p,this,i);else for(var x=p.length,m=Be(p,x),n=0;n<x;++n)fe(m[n],this,i);return!0};function Ie(l,t,i,n){var o,f,c;if(Gt(i),f=l._events,f===void 0?(f=l._events=Object.create(null),l._eventsCount=0):(f.newListener!==void 0&&(l.emit("newListener",t,i.listener?i.listener:i),f=l._events),c=f[t]),c===void 0)c=f[t]=i,++l._eventsCount;else if(typeof c=="function"?c=f[t]=n?[i,c]:[c,i]:n?c.unshift(i):c.push(i),o=Ee(l),o>0&&c.length>o&&!c.warned){c.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+c.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=l,a.type=t,a.count=c.length,Xe(a)}return l}k.prototype.addListener=function(t,i){return Ie(this,t,i,!1)};k.prototype.on=k.prototype.addListener;k.prototype.prependListener=function(t,i){return Ie(this,t,i,!0)};function Ze(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Re(l,t,i){var n={fired:!1,wrapFn:void 0,target:l,type:t,listener:i},o=Ze.bind(n);return o.listener=i,n.wrapFn=o,o}k.prototype.once=function(t,i){return Gt(i),this.on(t,Re(this,t,i)),this};k.prototype.prependOnceListener=function(t,i){return Gt(i),this.prependListener(t,Re(this,t,i)),this};k.prototype.removeListener=function(t,i){var n,o,f,c,a;if(Gt(i),o=this._events,o===void 0)return this;if(n=o[t],n===void 0)return this;if(n===i||n.listener===i)--this._eventsCount===0?this._events=Object.create(null):(delete o[t],o.removeListener&&this.emit("removeListener",t,n.listener||i));else if(typeof n!="function"){for(f=-1,c=n.length-1;c>=0;c--)if(n[c]===i||n[c].listener===i){a=n[c].listener,f=c;break}if(f<0)return this;f===0?n.shift():Qe(n,f),n.length===1&&(o[t]=n[0]),o.removeListener!==void 0&&this.emit("removeListener",t,a||i)}return this};k.prototype.off=k.prototype.removeListener;k.prototype.removeAllListeners=function(t){var i,n,o;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[t]),this;if(arguments.length===0){var f=Object.keys(n),c;for(o=0;o<f.length;++o)c=f[o],c!=="removeListener"&&this.removeAllListeners(c);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(i=n[t],typeof i=="function")this.removeListener(t,i);else if(i!==void 0)for(o=i.length-1;o>=0;o--)this.removeListener(t,i[o]);return this};function Ae(l,t,i){var n=l._events;if(n===void 0)return[];var o=n[t];return o===void 0?[]:typeof o=="function"?i?[o.listener||o]:[o]:i?ti(o):Be(o,o.length)}k.prototype.listeners=function(t){return Ae(this,t,!0)};k.prototype.rawListeners=function(t){return Ae(this,t,!1)};k.listenerCount=function(l,t){return typeof l.listenerCount=="function"?l.listenerCount(t):ke.call(l,t)};k.prototype.listenerCount=ke;function ke(l){var t=this._events;if(t!==void 0){var i=t[l];if(typeof i=="function")return 1;if(i!==void 0)return i.length}return 0}k.prototype.eventNames=function(){return this._eventsCount>0?Nt(this._events):[]};function Be(l,t){for(var i=new Array(t),n=0;n<t;++n)i[n]=l[n];return i}function Qe(l,t){for(;t+1<l.length;t++)l[t]=l[t+1];l.pop()}function ti(l){for(var t=new Array(l.length),i=0;i<t.length;++i)t[i]=l[i].listener||l[i];return t}function ei(l,t){return new Promise(function(i,n){function o(c){l.removeListener(t,f),n(c)}function f(){typeof l.removeListener=="function"&&l.removeListener("error",o),i([].slice.call(arguments))}Ce(l,t,f,{once:!0}),t!=="error"&&ii(l,o,{once:!0})})}function ii(l,t,i){typeof l.on=="function"&&Ce(l,"error",t,i)}function Ce(l,t,i,n){if(typeof l.on=="function")n.once?l.once(t,i):l.on(t,i);else if(typeof l.addEventListener=="function")l.addEventListener(t,function o(f){n.once&&l.removeEventListener(t,o),i(f)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof l)}var si=ie.exports;const ni=Je(si);class Dt extends Error{constructor(t,i){super(t),this.name="SendMessageError",this.ackId=i.ackId,this.errorDetail=i.errorDetail}}function ri(...l){if(l.length>0){const t=String(l[0]);t.includes(":error")?console.error(...l):t.includes(":warning")?console.warn(...l):t.includes(":info")?console.info(...l):t.includes(":verbose")?console.debug(...l):console.debug(...l)}}var de={};const pe=typeof process<"u"&&de&&de.DEBUG||void 0;let Pe,Jt=[],Xt=[];const $t=[];pe&&se(pe);const gt=Object.assign(l=>Le(l),{enable:se,enabled:ne,disable:oi,log:ri});function se(l){Pe=l,Jt=[],Xt=[];const t=/\*/g,i=l.split(",").map(n=>n.trim().replace(t,".*?"));for(const n of i)n.startsWith("-")?Xt.push(new RegExp(`^${n.substr(1)}$`)):Jt.push(new RegExp(`^${n}$`));for(const n of $t)n.enabled=ne(n.namespace)}function ne(l){if(l.endsWith("*"))return!0;for(const t of Xt)if(t.test(l))return!1;for(const t of Jt)if(t.test(l))return!0;return!1}function oi(){const l=Pe||"";return se(""),l}function Le(l){const t=Object.assign(i,{enabled:ne(l),destroy:ai,log:gt.log,namespace:l,extend:hi});function i(...n){t.enabled&&(n.length>0&&(n[0]=`${l} ${n[0]}`),t.log(...n))}return $t.push(t),t}function ai(){const l=$t.indexOf(this);return l>=0?($t.splice(l,1),!0):!1}function hi(l){const t=Le(`${this.namespace}:${l}`);return t.log=this.log,t}var ye={};const Zt=["verbose","info","warning","error"],me={verbose:400,info:300,warning:200,error:100};function we(l,t){t.log=(...i)=>{l.log(...i)}}function ge(l){return Zt.includes(l)}function Oe(l){const t=new Set,i=typeof process<"u"&&ye&&ye[l.logLevelEnvVarName]||void 0;let n;const o=gt(l.namespace);o.log=(...m)=>{gt.log(...m)};function f(m){if(m&&!ge(m))throw new Error(`Unknown log level '${m}'. Acceptable values: ${Zt.join(",")}`);n=m;const w=[];for(const u of t)c(u)&&w.push(u.namespace);gt.enable(w.join(","))}i&&(ge(i)?f(i):console.error(`${l.logLevelEnvVarName} set to unknown log level '${i}'; logging is not enabled. Acceptable values: ${Zt.join(", ")}.`));function c(m){return!!(n&&me[m.level]<=me[n])}function a(m,w){const u=Object.assign(m.extend(w),{level:w});if(we(m,u),c(u)){const g=gt.disable();gt.enable(g+","+u.namespace)}return t.add(u),u}function p(){return n}function x(m){const w=o.extend(m);return we(o,w),{error:a(w,"error"),warning:a(w,"warning"),info:a(w,"info"),verbose:a(w,"verbose")}}return{setLogLevel:f,getLogLevel:p,createClientLogger:x,logger:o}}Oe({logLevelEnvVarName:"TYPESPEC_RUNTIME_LOG_LEVEL",namespace:"typeSpecRuntime"});const li=Oe({logLevelEnvVarName:"AZURE_LOG_LEVEL",namespace:"azure"});function ci(l){return li.createClientLogger(l)}const z=ci("web-pubsub-client");var re={},Wt={};Wt.byteLength=di;Wt.toByteArray=yi;Wt.fromByteArray=gi;var ot=[],tt=[],fi=typeof Uint8Array<"u"?Uint8Array:Array,Ht="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var wt=0,ui=Ht.length;wt<ui;++wt)ot[wt]=Ht[wt],tt[Ht.charCodeAt(wt)]=wt;tt[45]=62;tt[95]=63;function Fe(l){var t=l.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=l.indexOf("=");i===-1&&(i=t);var n=i===t?0:4-i%4;return[i,n]}function di(l){var t=Fe(l),i=t[0],n=t[1];return(i+n)*3/4-n}function pi(l,t,i){return(t+i)*3/4-i}function yi(l){var t,i=Fe(l),n=i[0],o=i[1],f=new fi(pi(l,n,o)),c=0,a=o>0?n-4:n,p;for(p=0;p<a;p+=4)t=tt[l.charCodeAt(p)]<<18|tt[l.charCodeAt(p+1)]<<12|tt[l.charCodeAt(p+2)]<<6|tt[l.charCodeAt(p+3)],f[c++]=t>>16&255,f[c++]=t>>8&255,f[c++]=t&255;return o===2&&(t=tt[l.charCodeAt(p)]<<2|tt[l.charCodeAt(p+1)]>>4,f[c++]=t&255),o===1&&(t=tt[l.charCodeAt(p)]<<10|tt[l.charCodeAt(p+1)]<<4|tt[l.charCodeAt(p+2)]>>2,f[c++]=t>>8&255,f[c++]=t&255),f}function mi(l){return ot[l>>18&63]+ot[l>>12&63]+ot[l>>6&63]+ot[l&63]}function wi(l,t,i){for(var n,o=[],f=t;f<i;f+=3)n=(l[f]<<16&16711680)+(l[f+1]<<8&65280)+(l[f+2]&255),o.push(mi(n));return o.join("")}function gi(l){for(var t,i=l.length,n=i%3,o=[],f=16383,c=0,a=i-n;c<a;c+=f)o.push(wi(l,c,c+f>a?a:c+f));return n===1?(t=l[i-1],o.push(ot[t>>2]+ot[t<<4&63]+"==")):n===2&&(t=(l[i-2]<<8)+l[i-1],o.push(ot[t>>10]+ot[t>>4&63]+ot[t<<2&63]+"=")),o.join("")}var oe={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */oe.read=function(l,t,i,n,o){var f,c,a=o*8-n-1,p=(1<<a)-1,x=p>>1,m=-7,w=i?o-1:0,u=i?-1:1,g=l[t+w];for(w+=u,f=g&(1<<-m)-1,g>>=-m,m+=a;m>0;f=f*256+l[t+w],w+=u,m-=8);for(c=f&(1<<-m)-1,f>>=-m,m+=n;m>0;c=c*256+l[t+w],w+=u,m-=8);if(f===0)f=1-x;else{if(f===p)return c?NaN:(g?-1:1)*(1/0);c=c+Math.pow(2,n),f=f-x}return(g?-1:1)*c*Math.pow(2,f-n)};oe.write=function(l,t,i,n,o,f){var c,a,p,x=f*8-o-1,m=(1<<x)-1,w=m>>1,u=o===23?Math.pow(2,-24)-Math.pow(2,-77):0,g=n?0:f-1,S=n?1:-1,v=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,c=m):(c=Math.floor(Math.log(t)/Math.LN2),t*(p=Math.pow(2,-c))<1&&(c--,p*=2),c+w>=1?t+=u/p:t+=u*Math.pow(2,1-w),t*p>=2&&(c++,p/=2),c+w>=m?(a=0,c=m):c+w>=1?(a=(t*p-1)*Math.pow(2,o),c=c+w):(a=t*Math.pow(2,w-1)*Math.pow(2,o),c=0));o>=8;l[i+g]=a&255,g+=S,a/=256,o-=8);for(c=c<<o|a,x+=o;x>0;l[i+g]=c&255,g+=S,c/=256,x-=8);l[i+g-S]|=v*128};/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(l){const t=Wt,i=oe,n=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;l.Buffer=a,l.SlowBuffer=_,l.INSPECT_MAX_BYTES=50;const o=2147483647;l.kMaxLength=o,a.TYPED_ARRAY_SUPPORT=f(),!a.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function f(){try{const r=new Uint8Array(1),e={foo:function(){return 42}};return Object.setPrototypeOf(e,Uint8Array.prototype),Object.setPrototypeOf(r,e),r.foo()===42}catch{return!1}}Object.defineProperty(a.prototype,"parent",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.buffer}}),Object.defineProperty(a.prototype,"offset",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.byteOffset}});function c(r){if(r>o)throw new RangeError('The value "'+r+'" is invalid for option "size"');const e=new Uint8Array(r);return Object.setPrototypeOf(e,a.prototype),e}function a(r,e,s){if(typeof r=="number"){if(typeof e=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return w(r)}return p(r,e,s)}a.poolSize=8192;function p(r,e,s){if(typeof r=="string")return u(r,e);if(ArrayBuffer.isView(r))return S(r);if(r==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof r);if(nt(r,ArrayBuffer)||r&&nt(r.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(nt(r,SharedArrayBuffer)||r&&nt(r.buffer,SharedArrayBuffer)))return v(r,e,s);if(typeof r=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const h=r.valueOf&&r.valueOf();if(h!=null&&h!==r)return a.from(h,e,s);const d=M(r);if(d)return d;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof r[Symbol.toPrimitive]=="function")return a.from(r[Symbol.toPrimitive]("string"),e,s);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof r)}a.from=function(r,e,s){return p(r,e,s)},Object.setPrototypeOf(a.prototype,Uint8Array.prototype),Object.setPrototypeOf(a,Uint8Array);function x(r){if(typeof r!="number")throw new TypeError('"size" argument must be of type number');if(r<0)throw new RangeError('The value "'+r+'" is invalid for option "size"')}function m(r,e,s){return x(r),r<=0?c(r):e!==void 0?typeof s=="string"?c(r).fill(e,s):c(r).fill(e):c(r)}a.alloc=function(r,e,s){return m(r,e,s)};function w(r){return x(r),c(r<0?0:T(r)|0)}a.allocUnsafe=function(r){return w(r)},a.allocUnsafeSlow=function(r){return w(r)};function u(r,e){if((typeof e!="string"||e==="")&&(e="utf8"),!a.isEncoding(e))throw new TypeError("Unknown encoding: "+e);const s=E(r,e)|0;let h=c(s);const d=h.write(r,e);return d!==s&&(h=h.slice(0,d)),h}function g(r){const e=r.length<0?0:T(r.length)|0,s=c(e);for(let h=0;h<e;h+=1)s[h]=r[h]&255;return s}function S(r){if(nt(r,Uint8Array)){const e=new Uint8Array(r);return v(e.buffer,e.byteOffset,e.byteLength)}return g(r)}function v(r,e,s){if(e<0||r.byteLength<e)throw new RangeError('"offset" is outside of buffer bounds');if(r.byteLength<e+(s||0))throw new RangeError('"length" is outside of buffer bounds');let h;return e===void 0&&s===void 0?h=new Uint8Array(r):s===void 0?h=new Uint8Array(r,e):h=new Uint8Array(r,e,s),Object.setPrototypeOf(h,a.prototype),h}function M(r){if(a.isBuffer(r)){const e=T(r.length)|0,s=c(e);return s.length===0||r.copy(s,0,0,e),s}if(r.length!==void 0)return typeof r.length!="number"||qt(r.length)?c(0):g(r);if(r.type==="Buffer"&&Array.isArray(r.data))return g(r.data)}function T(r){if(r>=o)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+o.toString(16)+" bytes");return r|0}function _(r){return+r!=r&&(r=0),a.alloc(+r)}a.isBuffer=function(e){return e!=null&&e._isBuffer===!0&&e!==a.prototype},a.compare=function(e,s){if(nt(e,Uint8Array)&&(e=a.from(e,e.offset,e.byteLength)),nt(s,Uint8Array)&&(s=a.from(s,s.offset,s.byteLength)),!a.isBuffer(e)||!a.isBuffer(s))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===s)return 0;let h=e.length,d=s.length;for(let y=0,b=Math.min(h,d);y<b;++y)if(e[y]!==s[y]){h=e[y],d=s[y];break}return h<d?-1:d<h?1:0},a.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},a.concat=function(e,s){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(e.length===0)return a.alloc(0);let h;if(s===void 0)for(s=0,h=0;h<e.length;++h)s+=e[h].length;const d=a.allocUnsafe(s);let y=0;for(h=0;h<e.length;++h){let b=e[h];if(nt(b,Uint8Array))y+b.length>d.length?(a.isBuffer(b)||(b=a.from(b)),b.copy(d,y)):Uint8Array.prototype.set.call(d,b,y);else if(a.isBuffer(b))b.copy(d,y);else throw new TypeError('"list" argument must be an Array of Buffers');y+=b.length}return d};function E(r,e){if(a.isBuffer(r))return r.length;if(ArrayBuffer.isView(r)||nt(r,ArrayBuffer))return r.byteLength;if(typeof r!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof r);const s=r.length,h=arguments.length>2&&arguments[2]===!0;if(!h&&s===0)return 0;let d=!1;for(;;)switch(e){case"ascii":case"latin1":case"binary":return s;case"utf8":case"utf-8":return lt(r).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return s*2;case"hex":return s>>>1;case"base64":return he(r).length;default:if(d)return h?-1:lt(r).length;e=(""+e).toLowerCase(),d=!0}}a.byteLength=E;function I(r,e,s){let h=!1;if((e===void 0||e<0)&&(e=0),e>this.length||((s===void 0||s>this.length)&&(s=this.length),s<=0)||(s>>>=0,e>>>=0,s<=e))return"";for(r||(r="utf8");;)switch(r){case"hex":return Bt(this,e,s);case"utf8":case"utf-8":return ft(this,e,s);case"ascii":return dt(this,e,s);case"latin1":case"binary":return Mt(this,e,s);case"base64":return st(this,e,s);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return St(this,e,s);default:if(h)throw new TypeError("Unknown encoding: "+r);r=(r+"").toLowerCase(),h=!0}}a.prototype._isBuffer=!0;function A(r,e,s){const h=r[e];r[e]=r[s],r[s]=h}a.prototype.swap16=function(){const e=this.length;if(e%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let s=0;s<e;s+=2)A(this,s,s+1);return this},a.prototype.swap32=function(){const e=this.length;if(e%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let s=0;s<e;s+=4)A(this,s,s+3),A(this,s+1,s+2);return this},a.prototype.swap64=function(){const e=this.length;if(e%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let s=0;s<e;s+=8)A(this,s,s+7),A(this,s+1,s+6),A(this,s+2,s+5),A(this,s+3,s+4);return this},a.prototype.toString=function(){const e=this.length;return e===0?"":arguments.length===0?ft(this,0,e):I.apply(this,arguments)},a.prototype.toLocaleString=a.prototype.toString,a.prototype.equals=function(e){if(!a.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e?!0:a.compare(this,e)===0},a.prototype.inspect=function(){let e="";const s=l.INSPECT_MAX_BYTES;return e=this.toString("hex",0,s).replace(/(.{2})/g,"$1 ").trim(),this.length>s&&(e+=" ... "),"<Buffer "+e+">"},n&&(a.prototype[n]=a.prototype.inspect),a.prototype.compare=function(e,s,h,d,y){if(nt(e,Uint8Array)&&(e=a.from(e,e.offset,e.byteLength)),!a.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(s===void 0&&(s=0),h===void 0&&(h=e?e.length:0),d===void 0&&(d=0),y===void 0&&(y=this.length),s<0||h>e.length||d<0||y>this.length)throw new RangeError("out of range index");if(d>=y&&s>=h)return 0;if(d>=y)return-1;if(s>=h)return 1;if(s>>>=0,h>>>=0,d>>>=0,y>>>=0,this===e)return 0;let b=y-d,R=h-s;const D=Math.min(b,R),O=this.slice(d,y),U=e.slice(s,h);for(let B=0;B<D;++B)if(O[B]!==U[B]){b=O[B],R=U[B];break}return b<R?-1:R<b?1:0};function C(r,e,s,h,d){if(r.length===0)return-1;if(typeof s=="string"?(h=s,s=0):s>2147483647?s=2147483647:s<-2147483648&&(s=-2147483648),s=+s,qt(s)&&(s=d?0:r.length-1),s<0&&(s=r.length+s),s>=r.length){if(d)return-1;s=r.length-1}else if(s<0)if(d)s=0;else return-1;if(typeof e=="string"&&(e=a.from(e,h)),a.isBuffer(e))return e.length===0?-1:K(r,e,s,h,d);if(typeof e=="number")return e=e&255,typeof Uint8Array.prototype.indexOf=="function"?d?Uint8Array.prototype.indexOf.call(r,e,s):Uint8Array.prototype.lastIndexOf.call(r,e,s):K(r,[e],s,h,d);throw new TypeError("val must be string, number or Buffer")}function K(r,e,s,h,d){let y=1,b=r.length,R=e.length;if(h!==void 0&&(h=String(h).toLowerCase(),h==="ucs2"||h==="ucs-2"||h==="utf16le"||h==="utf-16le")){if(r.length<2||e.length<2)return-1;y=2,b/=2,R/=2,s/=2}function D(U,B){return y===1?U[B]:U.readUInt16BE(B*y)}let O;if(d){let U=-1;for(O=s;O<b;O++)if(D(r,O)===D(e,U===-1?0:O-U)){if(U===-1&&(U=O),O-U+1===R)return U*y}else U!==-1&&(O-=O-U),U=-1}else for(s+R>b&&(s=b-R),O=s;O>=0;O--){let U=!0;for(let B=0;B<R;B++)if(D(r,O+B)!==D(e,B)){U=!1;break}if(U)return O}return-1}a.prototype.includes=function(e,s,h){return this.indexOf(e,s,h)!==-1},a.prototype.indexOf=function(e,s,h){return C(this,e,s,h,!0)},a.prototype.lastIndexOf=function(e,s,h){return C(this,e,s,h,!1)};function q(r,e,s,h){s=Number(s)||0;const d=r.length-s;h?(h=Number(h),h>d&&(h=d)):h=d;const y=e.length;h>y/2&&(h=y/2);let b;for(b=0;b<h;++b){const R=parseInt(e.substr(b*2,2),16);if(qt(R))return b;r[s+b]=R}return b}function $(r,e,s,h){return Ft(lt(e,r.length-s),r,s,h)}function ht(r,e,s,h){return Ft(Lt(e),r,s,h)}function X(r,e,s,h){return Ft(he(e),r,s,h)}function J(r,e,s,h){return Ft(Ot(e,r.length-s),r,s,h)}a.prototype.write=function(e,s,h,d){if(s===void 0)d="utf8",h=this.length,s=0;else if(h===void 0&&typeof s=="string")d=s,h=this.length,s=0;else if(isFinite(s))s=s>>>0,isFinite(h)?(h=h>>>0,d===void 0&&(d="utf8")):(d=h,h=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const y=this.length-s;if((h===void 0||h>y)&&(h=y),e.length>0&&(h<0||s<0)||s>this.length)throw new RangeError("Attempt to write outside buffer bounds");d||(d="utf8");let b=!1;for(;;)switch(d){case"hex":return q(this,e,s,h);case"utf8":case"utf-8":return $(this,e,s,h);case"ascii":case"latin1":case"binary":return ht(this,e,s,h);case"base64":return X(this,e,s,h);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return J(this,e,s,h);default:if(b)throw new TypeError("Unknown encoding: "+d);d=(""+d).toLowerCase(),b=!0}},a.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function st(r,e,s){return e===0&&s===r.length?t.fromByteArray(r):t.fromByteArray(r.slice(e,s))}function ft(r,e,s){s=Math.min(r.length,s);const h=[];let d=e;for(;d<s;){const y=r[d];let b=null,R=y>239?4:y>223?3:y>191?2:1;if(d+R<=s){let D,O,U,B;switch(R){case 1:y<128&&(b=y);break;case 2:D=r[d+1],(D&192)===128&&(B=(y&31)<<6|D&63,B>127&&(b=B));break;case 3:D=r[d+1],O=r[d+2],(D&192)===128&&(O&192)===128&&(B=(y&15)<<12|(D&63)<<6|O&63,B>2047&&(B<55296||B>57343)&&(b=B));break;case 4:D=r[d+1],O=r[d+2],U=r[d+3],(D&192)===128&&(O&192)===128&&(U&192)===128&&(B=(y&15)<<18|(D&63)<<12|(O&63)<<6|U&63,B>65535&&B<1114112&&(b=B))}}b===null?(b=65533,R=1):b>65535&&(b-=65536,h.push(b>>>10&1023|55296),b=56320|b&1023),h.push(b),d+=R}return ut(h)}const vt=4096;function ut(r){const e=r.length;if(e<=vt)return String.fromCharCode.apply(String,r);let s="",h=0;for(;h<e;)s+=String.fromCharCode.apply(String,r.slice(h,h+=vt));return s}function dt(r,e,s){let h="";s=Math.min(r.length,s);for(let d=e;d<s;++d)h+=String.fromCharCode(r[d]&127);return h}function Mt(r,e,s){let h="";s=Math.min(r.length,s);for(let d=e;d<s;++d)h+=String.fromCharCode(r[d]);return h}function Bt(r,e,s){const h=r.length;(!e||e<0)&&(e=0),(!s||s<0||s>h)&&(s=h);let d="";for(let y=e;y<s;++y)d+=Ue[r[y]];return d}function St(r,e,s){const h=r.slice(e,s);let d="";for(let y=0;y<h.length-1;y+=2)d+=String.fromCharCode(h[y]+h[y+1]*256);return d}a.prototype.slice=function(e,s){const h=this.length;e=~~e,s=s===void 0?h:~~s,e<0?(e+=h,e<0&&(e=0)):e>h&&(e=h),s<0?(s+=h,s<0&&(s=0)):s>h&&(s=h),s<e&&(s=e);const d=this.subarray(e,s);return Object.setPrototypeOf(d,a.prototype),d};function N(r,e,s){if(r%1!==0||r<0)throw new RangeError("offset is not uint");if(r+e>s)throw new RangeError("Trying to access beyond buffer length")}a.prototype.readUintLE=a.prototype.readUIntLE=function(e,s,h){e=e>>>0,s=s>>>0,h||N(e,s,this.length);let d=this[e],y=1,b=0;for(;++b<s&&(y*=256);)d+=this[e+b]*y;return d},a.prototype.readUintBE=a.prototype.readUIntBE=function(e,s,h){e=e>>>0,s=s>>>0,h||N(e,s,this.length);let d=this[e+--s],y=1;for(;s>0&&(y*=256);)d+=this[e+--s]*y;return d},a.prototype.readUint8=a.prototype.readUInt8=function(e,s){return e=e>>>0,s||N(e,1,this.length),this[e]},a.prototype.readUint16LE=a.prototype.readUInt16LE=function(e,s){return e=e>>>0,s||N(e,2,this.length),this[e]|this[e+1]<<8},a.prototype.readUint16BE=a.prototype.readUInt16BE=function(e,s){return e=e>>>0,s||N(e,2,this.length),this[e]<<8|this[e+1]},a.prototype.readUint32LE=a.prototype.readUInt32LE=function(e,s){return e=e>>>0,s||N(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+this[e+3]*16777216},a.prototype.readUint32BE=a.prototype.readUInt32BE=function(e,s){return e=e>>>0,s||N(e,4,this.length),this[e]*16777216+(this[e+1]<<16|this[e+2]<<8|this[e+3])},a.prototype.readBigUInt64LE=ct(function(e){e=e>>>0,V(e,"offset");const s=this[e],h=this[e+7];(s===void 0||h===void 0)&&Y(e,this.length-8);const d=s+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24,y=this[++e]+this[++e]*2**8+this[++e]*2**16+h*2**24;return BigInt(d)+(BigInt(y)<<BigInt(32))}),a.prototype.readBigUInt64BE=ct(function(e){e=e>>>0,V(e,"offset");const s=this[e],h=this[e+7];(s===void 0||h===void 0)&&Y(e,this.length-8);const d=s*2**24+this[++e]*2**16+this[++e]*2**8+this[++e],y=this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+h;return(BigInt(d)<<BigInt(32))+BigInt(y)}),a.prototype.readIntLE=function(e,s,h){e=e>>>0,s=s>>>0,h||N(e,s,this.length);let d=this[e],y=1,b=0;for(;++b<s&&(y*=256);)d+=this[e+b]*y;return y*=128,d>=y&&(d-=Math.pow(2,8*s)),d},a.prototype.readIntBE=function(e,s,h){e=e>>>0,s=s>>>0,h||N(e,s,this.length);let d=s,y=1,b=this[e+--d];for(;d>0&&(y*=256);)b+=this[e+--d]*y;return y*=128,b>=y&&(b-=Math.pow(2,8*s)),b},a.prototype.readInt8=function(e,s){return e=e>>>0,s||N(e,1,this.length),this[e]&128?(255-this[e]+1)*-1:this[e]},a.prototype.readInt16LE=function(e,s){e=e>>>0,s||N(e,2,this.length);const h=this[e]|this[e+1]<<8;return h&32768?h|4294901760:h},a.prototype.readInt16BE=function(e,s){e=e>>>0,s||N(e,2,this.length);const h=this[e+1]|this[e]<<8;return h&32768?h|4294901760:h},a.prototype.readInt32LE=function(e,s){return e=e>>>0,s||N(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},a.prototype.readInt32BE=function(e,s){return e=e>>>0,s||N(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},a.prototype.readBigInt64LE=ct(function(e){e=e>>>0,V(e,"offset");const s=this[e],h=this[e+7];(s===void 0||h===void 0)&&Y(e,this.length-8);const d=this[e+4]+this[e+5]*2**8+this[e+6]*2**16+(h<<24);return(BigInt(d)<<BigInt(32))+BigInt(s+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24)}),a.prototype.readBigInt64BE=ct(function(e){e=e>>>0,V(e,"offset");const s=this[e],h=this[e+7];(s===void 0||h===void 0)&&Y(e,this.length-8);const d=(s<<24)+this[++e]*2**16+this[++e]*2**8+this[++e];return(BigInt(d)<<BigInt(32))+BigInt(this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+h)}),a.prototype.readFloatLE=function(e,s){return e=e>>>0,s||N(e,4,this.length),i.read(this,e,!0,23,4)},a.prototype.readFloatBE=function(e,s){return e=e>>>0,s||N(e,4,this.length),i.read(this,e,!1,23,4)},a.prototype.readDoubleLE=function(e,s){return e=e>>>0,s||N(e,8,this.length),i.read(this,e,!0,52,8)},a.prototype.readDoubleBE=function(e,s){return e=e>>>0,s||N(e,8,this.length),i.read(this,e,!1,52,8)};function H(r,e,s,h,d,y){if(!a.isBuffer(r))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>d||e<y)throw new RangeError('"value" argument is out of bounds');if(s+h>r.length)throw new RangeError("Index out of range")}a.prototype.writeUintLE=a.prototype.writeUIntLE=function(e,s,h,d){if(e=+e,s=s>>>0,h=h>>>0,!d){const R=Math.pow(2,8*h)-1;H(this,e,s,h,R,0)}let y=1,b=0;for(this[s]=e&255;++b<h&&(y*=256);)this[s+b]=e/y&255;return s+h},a.prototype.writeUintBE=a.prototype.writeUIntBE=function(e,s,h,d){if(e=+e,s=s>>>0,h=h>>>0,!d){const R=Math.pow(2,8*h)-1;H(this,e,s,h,R,0)}let y=h-1,b=1;for(this[s+y]=e&255;--y>=0&&(b*=256);)this[s+y]=e/b&255;return s+h},a.prototype.writeUint8=a.prototype.writeUInt8=function(e,s,h){return e=+e,s=s>>>0,h||H(this,e,s,1,255,0),this[s]=e&255,s+1},a.prototype.writeUint16LE=a.prototype.writeUInt16LE=function(e,s,h){return e=+e,s=s>>>0,h||H(this,e,s,2,65535,0),this[s]=e&255,this[s+1]=e>>>8,s+2},a.prototype.writeUint16BE=a.prototype.writeUInt16BE=function(e,s,h){return e=+e,s=s>>>0,h||H(this,e,s,2,65535,0),this[s]=e>>>8,this[s+1]=e&255,s+2},a.prototype.writeUint32LE=a.prototype.writeUInt32LE=function(e,s,h){return e=+e,s=s>>>0,h||H(this,e,s,4,4294967295,0),this[s+3]=e>>>24,this[s+2]=e>>>16,this[s+1]=e>>>8,this[s]=e&255,s+4},a.prototype.writeUint32BE=a.prototype.writeUInt32BE=function(e,s,h){return e=+e,s=s>>>0,h||H(this,e,s,4,4294967295,0),this[s]=e>>>24,this[s+1]=e>>>16,this[s+2]=e>>>8,this[s+3]=e&255,s+4};function pt(r,e,s,h,d){Q(e,h,d,r,s,7);let y=Number(e&BigInt(4294967295));r[s++]=y,y=y>>8,r[s++]=y,y=y>>8,r[s++]=y,y=y>>8,r[s++]=y;let b=Number(e>>BigInt(32)&BigInt(4294967295));return r[s++]=b,b=b>>8,r[s++]=b,b=b>>8,r[s++]=b,b=b>>8,r[s++]=b,s}function Ct(r,e,s,h,d){Q(e,h,d,r,s,7);let y=Number(e&BigInt(4294967295));r[s+7]=y,y=y>>8,r[s+6]=y,y=y>>8,r[s+5]=y,y=y>>8,r[s+4]=y;let b=Number(e>>BigInt(32)&BigInt(4294967295));return r[s+3]=b,b=b>>8,r[s+2]=b,b=b>>8,r[s+1]=b,b=b>>8,r[s]=b,s+8}a.prototype.writeBigUInt64LE=ct(function(e,s=0){return pt(this,e,s,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeBigUInt64BE=ct(function(e,s=0){return Ct(this,e,s,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeIntLE=function(e,s,h,d){if(e=+e,s=s>>>0,!d){const D=Math.pow(2,8*h-1);H(this,e,s,h,D-1,-D)}let y=0,b=1,R=0;for(this[s]=e&255;++y<h&&(b*=256);)e<0&&R===0&&this[s+y-1]!==0&&(R=1),this[s+y]=(e/b>>0)-R&255;return s+h},a.prototype.writeIntBE=function(e,s,h,d){if(e=+e,s=s>>>0,!d){const D=Math.pow(2,8*h-1);H(this,e,s,h,D-1,-D)}let y=h-1,b=1,R=0;for(this[s+y]=e&255;--y>=0&&(b*=256);)e<0&&R===0&&this[s+y+1]!==0&&(R=1),this[s+y]=(e/b>>0)-R&255;return s+h},a.prototype.writeInt8=function(e,s,h){return e=+e,s=s>>>0,h||H(this,e,s,1,127,-128),e<0&&(e=255+e+1),this[s]=e&255,s+1},a.prototype.writeInt16LE=function(e,s,h){return e=+e,s=s>>>0,h||H(this,e,s,2,32767,-32768),this[s]=e&255,this[s+1]=e>>>8,s+2},a.prototype.writeInt16BE=function(e,s,h){return e=+e,s=s>>>0,h||H(this,e,s,2,32767,-32768),this[s]=e>>>8,this[s+1]=e&255,s+2},a.prototype.writeInt32LE=function(e,s,h){return e=+e,s=s>>>0,h||H(this,e,s,4,2147483647,-2147483648),this[s]=e&255,this[s+1]=e>>>8,this[s+2]=e>>>16,this[s+3]=e>>>24,s+4},a.prototype.writeInt32BE=function(e,s,h){return e=+e,s=s>>>0,h||H(this,e,s,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[s]=e>>>24,this[s+1]=e>>>16,this[s+2]=e>>>8,this[s+3]=e&255,s+4},a.prototype.writeBigInt64LE=ct(function(e,s=0){return pt(this,e,s,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),a.prototype.writeBigInt64BE=ct(function(e,s=0){return Ct(this,e,s,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function _t(r,e,s,h,d,y){if(s+h>r.length)throw new RangeError("Index out of range");if(s<0)throw new RangeError("Index out of range")}function Pt(r,e,s,h,d){return e=+e,s=s>>>0,d||_t(r,e,s,4),i.write(r,e,s,h,23,4),s+4}a.prototype.writeFloatLE=function(e,s,h){return Pt(this,e,s,!0,h)},a.prototype.writeFloatBE=function(e,s,h){return Pt(this,e,s,!1,h)};function P(r,e,s,h,d){return e=+e,s=s>>>0,d||_t(r,e,s,8),i.write(r,e,s,h,52,8),s+8}a.prototype.writeDoubleLE=function(e,s,h){return P(this,e,s,!0,h)},a.prototype.writeDoubleBE=function(e,s,h){return P(this,e,s,!1,h)},a.prototype.copy=function(e,s,h,d){if(!a.isBuffer(e))throw new TypeError("argument should be a Buffer");if(h||(h=0),!d&&d!==0&&(d=this.length),s>=e.length&&(s=e.length),s||(s=0),d>0&&d<h&&(d=h),d===h||e.length===0||this.length===0)return 0;if(s<0)throw new RangeError("targetStart out of bounds");if(h<0||h>=this.length)throw new RangeError("Index out of range");if(d<0)throw new RangeError("sourceEnd out of bounds");d>this.length&&(d=this.length),e.length-s<d-h&&(d=e.length-s+h);const y=d-h;return this===e&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(s,h,d):Uint8Array.prototype.set.call(e,this.subarray(h,d),s),y},a.prototype.fill=function(e,s,h,d){if(typeof e=="string"){if(typeof s=="string"?(d=s,s=0,h=this.length):typeof h=="string"&&(d=h,h=this.length),d!==void 0&&typeof d!="string")throw new TypeError("encoding must be a string");if(typeof d=="string"&&!a.isEncoding(d))throw new TypeError("Unknown encoding: "+d);if(e.length===1){const b=e.charCodeAt(0);(d==="utf8"&&b<128||d==="latin1")&&(e=b)}}else typeof e=="number"?e=e&255:typeof e=="boolean"&&(e=Number(e));if(s<0||this.length<s||this.length<h)throw new RangeError("Out of range index");if(h<=s)return this;s=s>>>0,h=h===void 0?this.length:h>>>0,e||(e=0);let y;if(typeof e=="number")for(y=s;y<h;++y)this[y]=e;else{const b=a.isBuffer(e)?e:a.from(e,d),R=b.length;if(R===0)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(y=0;y<h-s;++y)this[y+s]=b[y%R]}return this};const j={};function L(r,e,s){j[r]=class extends s{constructor(){super(),Object.defineProperty(this,"message",{value:e.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${r}]`,this.stack,delete this.name}get code(){return r}set code(d){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:d,writable:!0})}toString(){return`${this.name} [${r}]: ${this.message}`}}}L("ERR_BUFFER_OUT_OF_BOUNDS",function(r){return r?`${r} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),L("ERR_INVALID_ARG_TYPE",function(r,e){return`The "${r}" argument must be of type number. Received type ${typeof e}`},TypeError),L("ERR_OUT_OF_RANGE",function(r,e,s){let h=`The value of "${r}" is out of range.`,d=s;return Number.isInteger(s)&&Math.abs(s)>2**32?d=G(String(s)):typeof s=="bigint"&&(d=String(s),(s>BigInt(2)**BigInt(32)||s<-(BigInt(2)**BigInt(32)))&&(d=G(d)),d+="n"),h+=` It must be ${e}. Received ${d}`,h},RangeError);function G(r){let e="",s=r.length;const h=r[0]==="-"?1:0;for(;s>=h+4;s-=3)e=`_${r.slice(s-3,s)}${e}`;return`${r.slice(0,s)}${e}`}function yt(r,e,s){V(e,"offset"),(r[e]===void 0||r[e+s]===void 0)&&Y(e,r.length-(s+1))}function Q(r,e,s,h,d,y){if(r>s||r<e){const b=typeof e=="bigint"?"n":"";let R;throw e===0||e===BigInt(0)?R=`>= 0${b} and < 2${b} ** ${(y+1)*8}${b}`:R=`>= -(2${b} ** ${(y+1)*8-1}${b}) and < 2 ** ${(y+1)*8-1}${b}`,new j.ERR_OUT_OF_RANGE("value",R,r)}yt(h,d,y)}function V(r,e){if(typeof r!="number")throw new j.ERR_INVALID_ARG_TYPE(e,"number",r)}function Y(r,e,s){throw Math.floor(r)!==r?(V(r,s),new j.ERR_OUT_OF_RANGE("offset","an integer",r)):e<0?new j.ERR_BUFFER_OUT_OF_BOUNDS:new j.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${e}`,r)}const at=/[^+/0-9A-Za-z-_]/g;function mt(r){if(r=r.split("=")[0],r=r.trim().replace(at,""),r.length<2)return"";for(;r.length%4!==0;)r=r+"=";return r}function lt(r,e){e=e||1/0;let s;const h=r.length;let d=null;const y=[];for(let b=0;b<h;++b){if(s=r.charCodeAt(b),s>55295&&s<57344){if(!d){if(s>56319){(e-=3)>-1&&y.push(239,191,189);continue}else if(b+1===h){(e-=3)>-1&&y.push(239,191,189);continue}d=s;continue}if(s<56320){(e-=3)>-1&&y.push(239,191,189),d=s;continue}s=(d-55296<<10|s-56320)+65536}else d&&(e-=3)>-1&&y.push(239,191,189);if(d=null,s<128){if((e-=1)<0)break;y.push(s)}else if(s<2048){if((e-=2)<0)break;y.push(s>>6|192,s&63|128)}else if(s<65536){if((e-=3)<0)break;y.push(s>>12|224,s>>6&63|128,s&63|128)}else if(s<1114112){if((e-=4)<0)break;y.push(s>>18|240,s>>12&63|128,s>>6&63|128,s&63|128)}else throw new Error("Invalid code point")}return y}function Lt(r){const e=[];for(let s=0;s<r.length;++s)e.push(r.charCodeAt(s)&255);return e}function Ot(r,e){let s,h,d;const y=[];for(let b=0;b<r.length&&!((e-=2)<0);++b)s=r.charCodeAt(b),h=s>>8,d=s%256,y.push(d),y.push(h);return y}function he(r){return t.toByteArray(mt(r))}function Ft(r,e,s,h){let d;for(d=0;d<h&&!(d+s>=e.length||d>=r.length);++d)e[d+s]=r[d];return d}function nt(r,e){return r instanceof e||r!=null&&r.constructor!=null&&r.constructor.name!=null&&r.constructor.name===e.name}function qt(r){return r!==r}const Ue=function(){const r="0123456789abcdef",e=new Array(256);for(let s=0;s<16;++s){const h=s*16;for(let d=0;d<16;++d)e[h+d]=r[s]+r[d]}return e}();function ct(r){return typeof BigInt>"u"?Ne:r}function Ne(){throw new Error("BigInt not supported")}})(re);function bi(l){if(typeof l!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!l)throw new Error("No input");const t=JSON.parse(l),i=t;let n;if(i.type==="system")if(i.event==="connected")n=Object.assign(Object.assign({},t),{kind:"connected"});else if(i.event==="disconnected")n=Object.assign(Object.assign({},t),{kind:"disconnected"});else return null;else if(i.type==="message")if(i.from==="group"){const o=xe(t.data,t.dataType);if(o===null)return null;n=Object.assign(Object.assign({},t),{data:o,kind:"groupData"})}else if(i.from==="server"){const o=xe(t.data,t.dataType);if(o===null)return null;n=Object.assign(Object.assign({},t),{data:o,kind:"serverData"})}else return null;else if(i.type==="ack")n=Object.assign(Object.assign({},t),{kind:"ack"});else return null;return n}function xi(l){let t;switch(l.kind){case"joinGroup":{t={type:"joinGroup",group:l.group,ackId:l.ackId};break}case"leaveGroup":{t={type:"leaveGroup",group:l.group,ackId:l.ackId};break}case"sendEvent":{t={type:"event",event:l.event,ackId:l.ackId,dataType:l.dataType,data:be(l.data,l.dataType)};break}case"sendToGroup":{t={type:"sendToGroup",group:l.group,ackId:l.ackId,dataType:l.dataType,data:be(l.data,l.dataType),noEcho:l.noEcho};break}case"sequenceAck":{t={type:"sequenceAck",sequenceId:l.sequenceId};break}default:throw new Error(`Unsupported type: ${l.kind}`)}return JSON.stringify(t)}function be(l,t){switch(t){case"text":{if(typeof l!="string")throw new TypeError("Message must be a string.");return l}case"json":return l;case"binary":case"protobuf":{if(l instanceof ArrayBuffer)return re.Buffer.from(l).toString("base64");throw new TypeError("Message must be a ArrayBuffer")}}}function xe(l,t){if(t==="text"){if(typeof l!="string")throw new TypeError("Message must be a string when dataType is text");return l}else{if(t==="json")return l;if(t==="binary"||t==="protobuf"){const i=re.Buffer.from(l,"base64");return i.buffer.slice(i.byteOffset,i.byteOffset+i.byteLength)}else return null}}class vi{constructor(){this.isReliableSubProtocol=!0,this.name="json.reliable.webpubsub.azure.v1"}parseMessages(t){return bi(t)}writeMessage(t){return xi(t)}}const Mi=()=>new vi;class Si{constructor(t,i){this._socket=new WebSocket(t,i),this._socket.binaryType="arraybuffer"}onopen(t){this._socket.onopen=t}onclose(t){this._socket.onclose=i=>t(i.code,i.reason)}onerror(t){this._socket.onerror=i=>t(i)}onmessage(t){this._socket.onmessage=i=>t(i.data)}close(t,i){this._socket.close(t,i)}send(t,i){return new Promise((n,o)=>{try{this._socket.send(t),n()}catch(f){o(f)}})}isOpen(){return this._socket.readyState===WebSocket.OPEN}}class _i{create(t,i){return new Si(t,i)}}async function Ti(l,t){if(t.aborted)throw new zt("The operation was aborted.");let i;const n=new Promise((o,f)=>{i=()=>{f(new zt("The operation was aborted."))},t.addEventListener("abort",i)});try{return await Promise.race([l,n])}finally{t.removeEventListener("abort",i)}}var Z;(function(l){l.Stopped="Stopped",l.Disconnected="Disconnected",l.Connecting="Connecting",l.Connected="Connected",l.Recovering="Recovering"})(Z||(Z={}));class Ei{nextAckId(){return this._ackId=this._ackId+1,this._ackId}constructor(t,i){this._quickSequenceAckDiff=300,this._activeTimeoutInMs=2e4,this._emitter=new ni,this._isStopping=!1,this._isInitialConnected=!1,typeof t=="string"?this._credential={getClientAccessUrl:t}:this._credential=t,i==null&&(i={}),this._buildDefaultOptions(i),this._options=i,this._messageRetryPolicy=new ve(this._options.messageRetryOptions),this._reconnectRetryPolicy=new ve(this._options.reconnectRetryOptions),this._protocol=this._options.protocol,this._groupMap=new Map,this._ackMap=new Map,this._sequenceId=new Ai,this._state=Z.Stopped,this._ackId=0}async start(t){if(this._isStopping)throw new Error("Can't start a client during stopping");if(this._state!==Z.Stopped)throw new Error("Client can be only started when it's Stopped");let i;t&&(i=t.abortSignal),this._activeKeepaliveTask||(this._activeKeepaliveTask=this._getActiveKeepaliveTask());try{await this._startCore(i)}catch(n){throw this._changeState(Z.Stopped),this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0),this._isStopping=!1,n}}async _startFromRestarting(t){if(this._state!==Z.Disconnected)throw new Error("Client can be only restarted when it's Disconnected");try{z.verbose("Staring reconnecting."),await this._startCore(t)}catch(i){throw this._changeState(Z.Disconnected),i}}async _startCore(t){if(this._changeState(Z.Connecting),z.info("Staring a new connection"),this._sequenceId.reset(),this._isInitialConnected=!1,this._lastCloseEvent=void 0,this._lastDisconnectedMessage=void 0,this._connectionId=void 0,this._reconnectionToken=void 0,this._uri=void 0,typeof this._credential.getClientAccessUrl=="string"?this._uri=this._credential.getClientAccessUrl:this._uri=await this._credential.getClientAccessUrl({abortSignal:t}),typeof this._uri!="string")throw new Error(`The clientAccessUrl must be a string but currently it's ${typeof this._uri}`);await this._connectCore(this._uri)}stop(){this._state===Z.Stopped||this._isStopping||(this._isStopping=!0,this._wsClient&&this._wsClient.isOpen()?this._wsClient.close():this._isStopping=!1,this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0))}on(t,i){this._emitter.on(t,i)}off(t,i){this._emitter.removeListener(t,i)}_emitEvent(t,i){this._emitter.emit(t,i)}async sendEvent(t,i,n,o){return this._operationExecuteWithRetry(()=>this._sendEventAttempt(t,i,n,o),o==null?void 0:o.abortSignal)}async _sendEventAttempt(t,i,n,o){var f;if(!((f=o==null?void 0:o.fireAndForget)!==null&&f!==void 0?f:!1))return this._sendMessageWithAckId(p=>({kind:"sendEvent",dataType:n,data:i,ackId:p,event:t}),o==null?void 0:o.ackId,o==null?void 0:o.abortSignal);const a={kind:"sendEvent",dataType:n,data:i,event:t};return await this._sendMessage(a,o==null?void 0:o.abortSignal),{isDuplicated:!1}}async joinGroup(t,i){return this._operationExecuteWithRetry(()=>this._joinGroupAttempt(t,i),i==null?void 0:i.abortSignal)}async _joinGroupAttempt(t,i){const n=this._getOrAddGroup(t),o=await this._joinGroupCore(t,i);return n.isJoined=!0,o}async _joinGroupCore(t,i){return this._sendMessageWithAckId(n=>({group:t,ackId:n,kind:"joinGroup"}),i==null?void 0:i.ackId,i==null?void 0:i.abortSignal)}async leaveGroup(t,i){return this._operationExecuteWithRetry(()=>this._leaveGroupAttempt(t,i),i==null?void 0:i.abortSignal)}async _leaveGroupAttempt(t,i){const n=this._getOrAddGroup(t),o=await this._sendMessageWithAckId(f=>({group:t,ackId:f,kind:"leaveGroup"}),i==null?void 0:i.ackId,i==null?void 0:i.abortSignal);return n.isJoined=!1,o}async sendToGroup(t,i,n,o){return this._operationExecuteWithRetry(()=>this._sendToGroupAttempt(t,i,n,o),o==null?void 0:o.abortSignal)}async _sendToGroupAttempt(t,i,n,o){var f,c;const a=(f=o==null?void 0:o.fireAndForget)!==null&&f!==void 0?f:!1,p=(c=o==null?void 0:o.noEcho)!==null&&c!==void 0?c:!1;if(!a)return this._sendMessageWithAckId(m=>({kind:"sendToGroup",group:t,dataType:n,data:i,ackId:m,noEcho:p}),o==null?void 0:o.ackId,o==null?void 0:o.abortSignal);const x={kind:"sendToGroup",group:t,dataType:n,data:i,noEcho:p};return await this._sendMessage(x,o==null?void 0:o.abortSignal),{isDuplicated:!1}}_getWebSocketClientFactory(){return new _i}async _trySendSequenceAck(){if(!this._protocol.isReliableSubProtocol)return;const[t,i]=this._sequenceId.tryGetSequenceId();if(t&&i!==null&&i!==void 0){const n={kind:"sequenceAck",sequenceId:i};try{await this._sendMessage(n)}catch{this._sequenceId.tryUpdate(i)}}}_connectCore(t){if(this._isStopping)throw new Error("Can't start a client during stopping");return new Promise((i,n)=>{const o=this._wsClient=this._getWebSocketClientFactory().create(t,this._protocol.name);o.onopen(()=>{if(this._isStopping){try{o.close()}catch{}n(new Error("The client is stopped"))}z.verbose("WebSocket connection has opened"),this._changeState(Z.Connected),this._protocol.isReliableSubProtocol&&(this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),this._sequenceAckTask=new Me(async()=>{await this._trySendSequenceAck()},1e3)),i()}),o.onerror(f=>{this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),n(f)}),o.onclose((f,c)=>{this._state===Z.Connected?(z.verbose("WebSocket closed after open"),this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),z.info(`WebSocket connection closed. Code: ${f}, Reason: ${c}`),this._lastCloseEvent={code:f,reason:c},this._handleConnectionClose.call(this)):(z.verbose("WebSocket closed before open"),n(new Error(`Failed to start WebSocket: ${f}`)))}),o.onmessage(f=>{const c=u=>{if(this._ackMap.has(u.ackId)){const g=this._ackMap.get(u.ackId);this._ackMap.delete(u.ackId);const S=u.error!=null&&u.error.name==="Duplicate";u.success||S?g.resolve({ackId:u.ackId,isDuplicated:S}):g.reject(new Dt("Failed to send message.",{ackId:u.ackId,errorDetail:u.error}))}},a=async u=>{if(this._connectionId=u.connectionId,this._reconnectionToken=u.reconnectionToken,!this._isInitialConnected){if(this._isInitialConnected=!0,this._options.autoRejoinGroups){const g=[];this._groupMap.forEach(S=>{S.isJoined&&g.push((async()=>{try{await this._joinGroupCore(S.name)}catch(v){this._safeEmitRejoinGroupFailed(S.name,v)}})())}),await Promise.all(g).catch(()=>{})}this._safeEmitConnected(u.connectionId,u.userId)}},p=u=>{this._lastDisconnectedMessage=u},x=u=>{if(u.sequenceId!=null){const g=this._sequenceId.tryUpdate(u.sequenceId);if(g===0)return;g>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitGroupMessage(u)},m=u=>{if(u.sequenceId!=null){const g=this._sequenceId.tryUpdate(u.sequenceId);if(g===0)return;g>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitServerMessage(u)};let w;try{let u;if(Array.isArray(f)?u=Buffer.concat(f):u=f,w=this._protocol.parseMessages(u),w===null)return}catch(u){throw z.warning("An error occurred while parsing the message from service",u),u}Array.isArray(w)||(w=[w]),w.forEach(u=>{try{switch(u.kind){case"ack":{c(u);break}case"connected":{a(u);break}case"disconnected":{p(u);break}case"groupData":{x(u);break}case"serverData":{m(u);break}}}catch(g){z.warning(`An error occurred while handling the message with kind: ${u.kind} from service`,g)}})})})}async _handleConnectionCloseAndNoRecovery(){this._state=Z.Disconnected,this._safeEmitDisconnected(this._connectionId,this._lastDisconnectedMessage),this._options.autoReconnect?await this._autoReconnect():await this._handleConnectionStopped()}async _autoReconnect(){let t=!1,i=0;try{for(;!this._isStopping;)try{await this._startFromRestarting(),t=!0;break}catch(n){z.warning("An attempt to reconnect connection failed.",n),i++;const o=this._reconnectRetryPolicy.nextRetryDelayInMs(i);if(o==null)break;z.verbose(`Delay time for reconnect attempt ${i}: ${o}`),await Ut(o).catch(()=>{})}}finally{t||this._handleConnectionStopped()}}_handleConnectionStopped(){this._isStopping=!1,this._state=Z.Stopped,this._safeEmitStopped()}_getActiveKeepaliveTask(){return new Me(async()=>{this._sequenceId.tryUpdate(0)},this._activeTimeoutInMs)}async _sendMessage(t,i){if(!this._wsClient||!this._wsClient.isOpen())throw new Error("The connection is not connected.");const n=this._protocol.writeMessage(t);await this._wsClient.send(n,i)}async _sendMessageWithAckId(t,i,n){i==null&&(i=this.nextAckId());const o=t(i);this._ackMap.has(i)||this._ackMap.set(i,new Ri(i));const f=this._ackMap.get(i);try{await this._sendMessage(o,n)}catch(c){this._ackMap.delete(i);let a="";throw c instanceof Error&&(a=c.message),new Dt(a,{ackId:i})}if(n)try{return await Ti(f.promise(),n)}catch(c){throw c instanceof Error&&c.name==="AbortError"?new Dt("Cancelled by abortSignal",{ackId:i}):c}return f.promise()}async _handleConnectionClose(){if(this._ackMap.forEach((o,f)=>{this._ackMap.delete(f)&&o.reject(new Dt("Connection is disconnected before receive ack from the service",{ackId:o.ackId}))}),this._isStopping){z.warning("The client is stopping state. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(this._lastCloseEvent&&this._lastCloseEvent.code===1008){z.warning("The websocket close with status code 1008. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(!this._protocol.isReliableSubProtocol){z.warning("The protocol is not reliable, recovery is not applicable"),this._handleConnectionCloseAndNoRecovery();return}const t=this._buildRecoveryUri();if(!t){z.warning("Connection id or reconnection token is not available"),this._handleConnectionCloseAndNoRecovery();return}let i=!1;this._state=Z.Recovering;const n=AbortSignal.timeout(30*1e3);try{for(;!n.aborted||this._isStopping;)try{await this._connectCore.call(this,t),i=!0;return}catch{await Ut(1e3)}}finally{i||(z.warning("Recovery attempts failed more then 30 seconds or the client is stopping"),this._handleConnectionCloseAndNoRecovery())}}_safeEmitConnected(t,i){this._emitEvent("connected",{connectionId:t,userId:i})}_safeEmitDisconnected(t,i){this._emitEvent("disconnected",{connectionId:t,message:i})}_safeEmitGroupMessage(t){this._emitEvent("group-message",{message:t})}_safeEmitServerMessage(t){this._emitEvent("server-message",{message:t})}_safeEmitStopped(){this._emitEvent("stopped",{})}_safeEmitRejoinGroupFailed(t,i){this._emitEvent("rejoin-group-failed",{group:t,error:i})}_buildDefaultOptions(t){return t.autoReconnect==null&&(t.autoReconnect=!0),t.autoRejoinGroups==null&&(t.autoRejoinGroups=!0),t.protocol==null&&(t.protocol=Mi()),this._buildMessageRetryOptions(t),this._buildReconnectRetryOptions(t),t}_buildMessageRetryOptions(t){t.messageRetryOptions||(t.messageRetryOptions={}),(t.messageRetryOptions.maxRetries==null||t.messageRetryOptions.maxRetries<0)&&(t.messageRetryOptions.maxRetries=3),(t.messageRetryOptions.retryDelayInMs==null||t.messageRetryOptions.retryDelayInMs<0)&&(t.messageRetryOptions.retryDelayInMs=1e3),(t.messageRetryOptions.maxRetryDelayInMs==null||t.messageRetryOptions.maxRetryDelayInMs<0)&&(t.messageRetryOptions.maxRetryDelayInMs=3e4),t.messageRetryOptions.mode==null&&(t.messageRetryOptions.mode="Fixed")}_buildReconnectRetryOptions(t){t.reconnectRetryOptions||(t.reconnectRetryOptions={}),(t.reconnectRetryOptions.maxRetries==null||t.reconnectRetryOptions.maxRetries<0)&&(t.reconnectRetryOptions.maxRetries=Number.MAX_VALUE),(t.reconnectRetryOptions.retryDelayInMs==null||t.reconnectRetryOptions.retryDelayInMs<0)&&(t.reconnectRetryOptions.retryDelayInMs=1e3),(t.reconnectRetryOptions.maxRetryDelayInMs==null||t.reconnectRetryOptions.maxRetryDelayInMs<0)&&(t.reconnectRetryOptions.maxRetryDelayInMs=3e4),t.reconnectRetryOptions.mode==null&&(t.reconnectRetryOptions.mode="Fixed")}_buildRecoveryUri(){if(this._connectionId&&this._reconnectionToken&&this._uri){const t=new URL(this._uri);return t.searchParams.append("awps_connection_id",this._connectionId),t.searchParams.append("awps_reconnection_token",this._reconnectionToken),t.toString()}return null}_getOrAddGroup(t){return this._groupMap.has(t)||this._groupMap.set(t,new Ii(t)),this._groupMap.get(t)}_changeState(t){z.verbose(`The client state transfer from ${this._state.toString()} to ${t.toString()}`),this._state=t}async _operationExecuteWithRetry(t,i){let n=0;for(;;)try{return await t.call(this)}catch(o){n++;const f=this._messageRetryPolicy.nextRetryDelayInMs(n);if(f==null||(await Ut(f),i!=null&&i.aborted))throw o}}}class ve{constructor(t){this._retryOptions=t,this._maxRetriesToGetMaxDelay=Math.ceil(Math.log2(this._retryOptions.maxRetryDelayInMs)-Math.log2(this._retryOptions.retryDelayInMs)+1)}nextRetryDelayInMs(t){return t>this._retryOptions.maxRetries?null:this._retryOptions.mode==="Fixed"?this._retryOptions.retryDelayInMs:this._calculateExponentialDelay(t)}_calculateExponentialDelay(t){return t>=this._maxRetriesToGetMaxDelay?this._retryOptions.maxRetryDelayInMs:(1<<t-1)*this._retryOptions.retryDelayInMs}}class Ii{constructor(t){this.isJoined=!1,this.name=t}}class Ri{constructor(t){this._promise=new Promise((i,n)=>{this._resolve=i,this._reject=n}),this.ackId=t}promise(){return this._promise}resolve(t){this._resolve(t)}reject(t){this._reject(t)}}class Ai{constructor(){this._sequenceId=0,this._isUpdate=!1}tryUpdate(t){if(this._isUpdate=!0,t>this._sequenceId){const i=t-this._sequenceId;return this._sequenceId=t,i}return 0}tryGetSequenceId(){return this._isUpdate?(this._isUpdate=!1,[!0,this._sequenceId]):[!1,null]}reset(){this._sequenceId=0,this._isUpdate=!1}}class Me{constructor(t,i,n){this._func=t,this._abortController=new AbortController,this._interval=i,this._obj=n,this._start()}abort(){try{this._abortController.abort()}catch{}}async _start(){const t=this._abortController.signal;for(;!t.aborted;)try{await this._func(this._obj)}catch{}finally{await Ut(this._interval)}}}class Se{constructor(t){this.negotiateUrl=t,this.client=null,this.group=null,this.connected=!1,this.onDisc=[],this.onErr=[],this.mode="azure",this.bc=null,this.lastError=null,this.onMsgHandler=null,this.id=Math.random().toString(36).slice(2,8)}async connect(t){this.group=`room_${t}`;try{const i=await fetch(this.negotiateUrl,{credentials:"include"});if(!i.ok){const f=await i.text().catch(()=>"");throw this.lastError=`negotiate ${i.status}: ${f==null?void 0:f.slice(0,180)}`,new Error(this.lastError)}const{url:n}=await i.json().catch(()=>({url:null}));if(!n)throw new Error("no url");const o=new Ei(n);this.client=o,this.mode="azure",o.on("connected",()=>{this.connected=!0}),o.on("disconnected",()=>{this.connected=!1,this.onDisc.forEach(f=>f())}),o.on("stopped",()=>{this.connected=!1,this.onDisc.forEach(f=>f())}),o.on("group-message",({message:f})=>{var c;try{(c=this.onMsgHandler)==null||c.call(this,JSON.parse(String(f.data)))}catch{}}),await o.start(),await o.joinGroup(this.group),this.connected=!0}catch(i){this.lastError=(i==null?void 0:i.message)||String(i);const n=typeof window<"u"&&window.location.hostname||"";if(!(n==="localhost"||n==="127.0.0.1"||n.endsWith(".local")))throw this.onErr.forEach(f=>f(i)),i;try{this.mode="local",this.bc=new BroadcastChannel(this.group),this.bc.onmessage=f=>{var a;const c=f.data;try{(a=this.onMsgHandler)==null||a.call(this,c)}catch{}},this.connected=!0}catch{throw this.onErr.forEach(c=>c(i)),i}}}onMessage(t){this.onMsgHandler=t}onDisconnected(t){this.onDisc.push(t)}onError(t){this.onErr.push(t)}async send(t){if(!(!this.client||!this.connected||!this.group))try{this.mode==="azure"?await this.client.sendToGroup(this.group,JSON.stringify(t),"text"):this.mode==="local"&&this.bc&&this.bc.postMessage(t)}catch(i){this.onErr.forEach(n=>n(i))}}close(){var t;try{(t=this.bc)==null||t.close()}catch{}}getTransport(){return this.mode}getLastError(){return this.lastError}}class Qt{constructor(t,i){this.p1=new At(80,140,26,26),this.p2=new At(120,220,26,26),this.obstacles=[],this.hud=new te,this.s1=0,this.s2=0,this.speed=140,this.timeToNext=0,this.paused=!1,this.rt=null,this.remoteHistory=[],this.sendAccum=0,this.toast=null,this.isLeader=!1,this.remoteId=null,this.reconnecting=!1,this.retries=0,this.unloadHandler=null,this.waiting=!0,this.bothReady=!1,this.presenceAccum=0,this.myId=null,this.lastMsgAt=0,this.starting=!1,this.startAt=0,this.lastCountdownSecond=0,this.trailAccum=0,this.particles=new jt,this.remoteParticles=new jt,this.paletteIdx=0,this.endBanner=null,this.hurtT=0,this.scoreFlashT=0,this.emotes=[],this.nameColorSelf="#7cc1ff",this.nameColorOther="#ff9da0",this.roomId=t,this.name=i}async init(t){this.renderer=new ee(t.canvas,t.ctx),this.paletteIdx=Math.random()<.5?0:1;const n=[{top:"#0f1630",bottom:"#0b1022"},{top:"#0b2a3a",bottom:"#051a26"}][this.paletteIdx];this.renderer.setPalette(n.top,n.bottom);const o="/api/negotiate";this.rt=new Se(o);try{await this.rt.connect(this.roomId)}catch{this.toast={text:"Online: failed to connect",t:3};return}const f=this.rt.id;this.myId=f,this.rt.onMessage(c=>{if(this.lastMsgAt=performance.now(),c.type==="state"&&c.id!==f)this.remoteHistory.push({t:c.t,x:c.x,y:c.y,vy:c.vy,score:c.score,hp:c.hp,name:c.name}),this.remoteHistory.length>30&&this.remoteHistory.shift(),this.remoteName=c.name||this.remoteName;else if(c.type==="spawn"&&this.isLeader===!1){const a=t.canvas.height,p=80,x=t.canvas.width+p,m=c.topH,w=c.gap;this.speed=c.speed,this.obstacles.push(new rt(x,0,p,m,this.speed)),this.obstacles.push(new rt(x,m+w,p,a-(m+w),this.speed))}else if(c.type==="join"&&c.id!==f)this.remoteId=c.id,this.remoteName=c.name,this.isLeader=f<c.id,this.toast={text:`${c.name||"Opponent"} joined`,t:2.5},this.bothReady=!0,this.isLeader&&this.waiting&&setTimeout(()=>{var x;const p=performance.now()+2e3;(x=this.rt)==null||x.send({type:"start",id:f,roomId:this.roomId,t:performance.now(),startAt:p,delayMs:2e3}),this.startAt=p,this.waiting=!1,this.starting=!0,this.lastCountdownSecond=4},600);else if(c.type==="start"){const a=c.startAt,p=c.delayMs;typeof a=="number"?this.startAt=a:this.startAt=performance.now()+(typeof p=="number"?p:1500),this.waiting=!1,this.starting=!0,this.lastCountdownSecond=4}else c.type==="leave"&&c.id!==f&&(this.toast={text:"Opponent left",t:3},this.waiting=!0,this.bothReady=!1,this.remoteId=null);if(c.type==="emote"&&c.id!==f){const a=this.p2.x+this.p2.width/2,p=this.p2.y-12;this.emotes.push({x:a,y:p,text:c.emoji||"👍",ttl:1.6,me:!1})}}),this.toast={text:`Connected • Room ${this.roomId} • ${this.rt.getTransport().toUpperCase()}`,t:2.5},this.rt.send({type:"join",id:f,roomId:this.roomId,name:this.name}),this.rt.onDisconnected(()=>{this.toast={text:"Online: disconnected",t:3},!this.reconnecting&&this.retries<2&&(this.reconnecting=!0,this.retries++,setTimeout(()=>this.reconnect(o),1500))}),this.unloadHandler=c=>{var a;try{(a=this.rt)==null||a.send({type:"leave",id:f,roomId:this.roomId})}catch{}},window.addEventListener("beforeunload",this.unloadHandler)}dispose(){var t;try{this.rt&&this.myId&&this.rt.send({type:"leave",id:this.myId,roomId:this.roomId})}catch{}try{this.unloadHandler&&window.removeEventListener("beforeunload",this.unloadHandler)}catch{}try{(t=this.rt)==null||t.close()}catch{}}async reconnect(t){this.rt;const i=this.name;this.rt=new Se(t);try{await this.rt.connect(this.roomId);const n=this.rt.id;this.toast={text:"Online: reconnected",t:2.5},this.rt.onMessage(o=>{if(this.lastMsgAt=performance.now(),o.type==="state"&&o.id!==n)this.remoteHistory.push({t:o.t,x:o.x,y:o.y,vy:o.vy,score:o.score,hp:o.hp,name:o.name}),this.remoteHistory.length>30&&this.remoteHistory.shift(),this.remoteName=o.name||this.remoteName;else if(o.type==="spawn"&&this.isLeader===!1){const f=this.renderer.canvas.height,c=80,a=this.renderer.canvas.width+c,p=o.topH,x=o.gap;this.speed=o.speed,this.obstacles.push(new rt(a,0,c,p,this.speed)),this.obstacles.push(new rt(a,p+x,c,f-(p+x),this.speed))}else o.type==="join"&&o.id!==n?(this.remoteId=o.id,this.remoteName=o.name,this.isLeader=n<o.id):o.type==="leave"&&o.id!==n&&(this.toast={text:"Opponent left",t:3})}),this.rt.onDisconnected(()=>{this.toast={text:"Online: disconnected",t:3}}),this.rt.send({type:"join",id:this.rt.id,roomId:this.roomId,name:i})}catch{this.toast={text:"Online: reconnection failed",t:3}}finally{this.reconnecting=!1}}update(t,i){var m,w,u,g,S,v;if(this.paused)return;if(this.waiting){this.rt&&this.myId&&(this.presenceAccum+=t,this.presenceAccum>=1&&(this.presenceAccum=0,this.rt.send({type:"join",id:this.myId,roomId:this.roomId,name:this.name})));return}if(this.starting){const M=performance.now(),T=Math.max(0,this.startAt-M),_=Math.ceil(T/1e3);if(_!==this.lastCountdownSecond)if(this.lastCountdownSecond=_,_>0){const E=800-(3-Math.min(3,_))*120;F.beep(E,.08,"triangle",.06)}else F.beep(1e3,.1,"square",.07);if(T<=0)this.starting=!1;else{this.particles.update(t),this.remoteParticles.update(t);return}}(i.input.wasPressed("Space")||i.input.wasPressed("ArrowUp"))&&(W.jump(this.p1),F.flap(),this.particles.burst(this.p1.x+this.p1.width*.2,this.p1.y+this.p1.height*.7,10,"#9bd1ff")),i.input.wasPressed("Digit1")&&(this.emotes.push({x:this.p1.x+this.p1.width/2,y:this.p1.y-12,text:"👍",ttl:1.6,me:!0}),(m=this.rt)==null||m.send({type:"state",id:this.rt.id,t:performance.now(),x:this.p1.x,y:this.p1.y,vy:this.p1.vy,score:this.s1,hp:this.p1.hp,name:this.name}),(u=this.rt)==null||u.send({type:"emote",id:(w=this.rt)==null?void 0:w.id,roomId:this.roomId,emoji:"👍"})),i.input.wasPressed("Digit2")&&(this.emotes.push({x:this.p1.x+this.p1.width/2,y:this.p1.y-12,text:"😅",ttl:1.6,me:!0}),(S=this.rt)==null||S.send({type:"emote",id:(g=this.rt)==null?void 0:g.id,roomId:this.roomId,emoji:"😅"}));const n=i.input.getMovementDirection();this.p1.vx=n.x*80,W.applyGravity(this.p1,t),this.p1.update(t);const o=i.canvas.height;if(this.p1.y=Math.max(0,Math.min(o-this.p1.height,this.p1.y)),this.rt){this.sendAccum+=t;const M=1/25;if(this.sendAccum>=M){this.sendAccum=0;const T={type:"state",id:this.rt.id,t:performance.now(),x:this.p1.x,y:this.p1.y,vy:this.p1.vy,score:this.s1,hp:this.p1.hp,name:this.name};this.rt.send(T)}}const c=performance.now()-100;for(;this.remoteHistory.length>=2&&this.remoteHistory[1].t<=c;)this.remoteHistory.shift();const a=this.remoteHistory[0],p=this.remoteHistory[1];if(a&&p){const M=(c-a.t)/Math.max(1,p.t-a.t),T=(_,E,I)=>_+(E-_)*Math.max(0,Math.min(1,I));this.p2.x=T(a.x,p.x,M),this.p2.y=T(a.y,p.y,M),this.p2.vy=T(a.vy,p.vy,M),this.s2=Math.max(a.score,p.score)}else a&&(this.p2.x=a.x,this.p2.y=a.y,this.p2.vy=a.vy,this.s2=a.score);this.trailAccum+=t;const x=(M,T,_)=>{this.particles.spawn(M,T,{vx:-40+Math.random()*20,vy:20+Math.random()*20,size:2.2,color:_+"cc",life:.35,g:150})};if(this.trailAccum>=.05&&(this.trailAccum=0,x(this.p1.x-4,this.p1.y+this.p1.height*.6,"#7cc1ff"),this.remoteParticles.spawn(this.p2.x-4,this.p2.y+this.p2.height*.6,{vx:-30+Math.random()*20,vy:20+Math.random()*15,size:2.2,color:"#ff9da0cc",life:.35,g:150})),this.particles.update(t),this.remoteParticles.update(t),this.timeToNext-=t,this.timeToNext<=0){this.speed=Math.min(260,this.speed+2);const M=Math.max(130,180-Math.max(this.s1,this.s2)*2);this.timeToNext=Math.max(1,1.7-Math.max(this.s1,this.s2)*.02);const T=40,_=o-M-40,E=Math.floor(Math.random()*(_-T+1))+T,I=80,A=i.canvas.width+I;this.isLeader&&(this.obstacles.push(new rt(A,0,I,E,this.speed)),this.obstacles.push(new rt(A,E+M,I,o-(E+M),this.speed)),(v=this.rt)==null||v.send({type:"spawn",id:this.rt.id,t:performance.now(),w:I,gap:M,topH:E,speed:this.speed}))}for(const M of this.obstacles)M.update(t);this.obstacles=this.obstacles.filter(M=>!M.isOffScreen());for(const M of this.obstacles)if(W.checkCollision&&W.checkCollision(this.p1,M)&&(this.p1.hp=Math.max(0,(this.p1.hp??3)-1),this.hurtT=.3,F.hit(),this.p1.hp<=0)){this.paused=!0;const T=this.s1>=this.s2?"You lose":"You win!";this.endBanner={text:T,t:2.5}}for(let M=0;M<this.obstacles.length;M+=2){const T=this.obstacles[M],_=T.x+T.width/2;T.counted!==!0&&_<this.p1.x&&(T.counted=!0,this.s1+=1,this.scoreFlashT=.25,F.score())}this.hurtT=Math.max(0,this.hurtT-t),this.scoreFlashT=Math.max(0,this.scoreFlashT-t);for(const M of this.emotes)M.ttl-=t;this.emotes=this.emotes.filter(M=>M.ttl>0)}render(t,i){var g,S;if(this.renderer.clear(1/60),this.waiting){t.fillStyle="#e8e8f0",t.font="700 24px system-ui";const v=this.bothReady?"Found opponent! Starting…":`Waiting in room ${this.roomId}…`,M=t.measureText(v).width;t.fillText(v,Math.max(20,(i.canvas.width-M)/2),120),t.font="600 14px system-ui",t.fillStyle="#94a3b8";const T="Share the code with your friend. Game starts when they join.",_=t.measureText(T).width;t.fillText(T,Math.max(20,(i.canvas.width-_)/2),150);const E=(S=(g=this.rt)==null?void 0:g.getLastError)==null?void 0:S.call(g);if(E){t.fillStyle="#fca5a5",t.font="600 13px system-ui";const st=t.measureText(E).width;t.fillText(E,Math.max(20,(i.canvas.width-st)/2),170)}const A=`Connected players: ${1+(this.remoteId?1:0)}/2`;t.fillStyle="#cdd9e5",t.font="700 14px system-ui";const C=t.measureText(A).width,K=Math.max(20,(i.canvas.width-C)/2),q=180;t.fillText(A,K+18,q);const $=performance.now(),ht=$-this.lastMsgAt;let X="#ef4444";ht<2e3?X="#22c55e":ht<5e3&&(X="#facc15");const J=.6+.4*Math.sin($/250);t.save(),t.fillStyle=X,t.beginPath(),t.arc(K+8,q-4,5*J,0,Math.PI*2),t.fill(),t.restore()}if(this.starting){const v=Math.max(0,this.startAt-performance.now()),M=Math.ceil(v/1e3);t.fillStyle="#e8e8f0",t.font="800 54px system-ui";const T=M>0?String(M):"GO!",_=t.measureText(T).width;t.fillText(T,(i.canvas.width-_)/2,i.canvas.height*.35)}const n=this.hurtT>0?"#f87171":"#58a6ff";this.renderer.drawPlayer(this.p1,n),this.renderer.drawPlayer(this.p2,"#ff7b72"),this.particles.render(t),this.remoteParticles.render(t);for(const v of this.obstacles)this.renderer.drawObstacle(v);this.hud.render(t,this.s1,this.s2),t.font="700 12px system-ui";const o=(v,M,T,_)=>{const E=M,I=Math.max(12,T);t.save(),t.textAlign="left",t.fillStyle=_,t.beginPath(),t.roundRect(E-4,I-12,Math.max(20,t.measureText(v).width+8),14,6),t.fill(),t.fillStyle="#0f172a",t.fillText(v,E,I-2),t.restore()};this.name&&o(this.name,this.p1.x,this.p1.y-6,this.nameColorSelf),this.remoteName&&o(this.remoteName,this.p2.x,this.p2.y-6,this.nameColorOther),t.fillStyle="#94a3b8",t.font="600 12px system-ui";const f=this.isLeader?"Leader":"Follower",c=1+(this.remoteId?1:0),a=`Online • Room ${this.roomId} • ${f} • Players ${c}/2`;t.fillText(a,32,i.canvas.height-8);const p=performance.now(),x=p-this.lastMsgAt;let m="#ef4444";x<2e3?m="#22c55e":x<5e3&&(m="#facc15");const w=.6+.4*Math.sin(p/250);t.save(),t.fillStyle=m,t.beginPath(),t.arc(16,i.canvas.height-12,5*w,0,Math.PI*2),t.fill(),t.restore(),t.fillStyle="#94a3b8",t.font="600 12px system-ui";const u=Math.max(0,Math.min(9999,Math.round(x)));t.fillText(`${u}ms`,28,i.canvas.height-8);for(const v of this.emotes){const M=Math.max(0,Math.min(1,v.ttl/1.6));t.save(),t.globalAlpha=M,t.fillStyle="#0f172acc",t.beginPath(),t.roundRect(v.x-10,v.y-16,24,18,8),t.fill(),t.fillStyle="#e8e8f0",t.font="700 14px system-ui",t.fillText(v.text,v.x-4,v.y-2),t.restore()}if(this.endBanner){this.endBanner.t-=1/60;const v=Math.max(0,Math.min(1,this.endBanner.t/2.5));t.save(),t.globalAlpha=v,t.fillStyle="#0f172acc";const M=220,T=48,_=(i.canvas.width-M)/2,E=60;t.beginPath(),t.roundRect(_,E,M,T,10),t.fill(),t.fillStyle="#e8e8f0",t.font="800 20px system-ui";const I=this.endBanner.text,A=t.measureText(I).width;t.fillText(I,_+(M-A)/2,E+30),t.restore()}if(this.toast){this.toast.t-=1/60,t.save(),t.globalAlpha=Math.max(0,Math.min(1,this.toast.t/3)),t.fillStyle="#000000aa";const v=this.toast.text;t.font="700 16px system-ui";const M=t.measureText(v).width+20;t.fillRect(20,20,M,34),t.fillStyle="#e8e8f0",t.fillText(v,30,42),t.restore(),this.toast.t<=0&&(this.toast=null)}}}class ki{constructor(){this.t=0,this.onlineModalOpen=!1,this.modalCreateBtn=null,this.modalJoinBtn=null,this.modalCancelBtn=null,this.shareRoomCode=null,this.shareRoomName=null,this.btnS=null,this.btnV=null,this.btnVO=null,this.btnEditName=null}launchOnline(t){this.onlineModalOpen=!0}onResize(t){t.ctx.setTransform(1,0,0,1,0,0)}init(t){t.canvas.focus();try{const w=new URL(window.location.href),u=w.searchParams.get("room"),g=w.searchParams.get("name");u&&(this.shareRoomCode=u.toLowerCase(),g&&(this.shareRoomName=g),this.onlineModalOpen=!0)}catch{}let i=!1;const n=()=>{t.canvas.onpointerdown=null,t.canvas.ontouchstart=null,t.canvas.onclick=null,document.removeEventListener("touchstart",x),document.removeEventListener("pointerdown",p),document.removeEventListener("click",m)},o=(w,u=!1)=>{if(w&&u){this.launchOnline(t);return}this.onlineModalOpen||i||(i=!0,n(),t.setScene(w?new Yt:new kt))},f=w=>{try{w.stopPropagation()}catch{}if(this.btnS||this.btnV||this.btnEditName){const u=t.canvas.getBoundingClientRect(),g=t.canvas.width/u.width,S=t.canvas.height/u.height,v=(w.clientX-u.left)*g,M=(w.clientY-u.top)*S;if(this.onlineModalOpen){const T=_=>_&&v>=_.x&&v<=_.x+_.w&&M>=_.y&&M<=_.y+_.h;if(T(this.modalCreateBtn)){const _=et.getPlayerName()||this.shareRoomName||"Anon",E=typeof window<"u"&&window.prompt("Your name",_)||_;et.setPlayerName(E);const I=Math.random().toString(36).slice(2,6).toUpperCase();try{const A=new URL(window.location.href);A.searchParams.set("room",I.toLowerCase()),A.searchParams.delete("name");const C=A.toString();if(navigator.clipboard&&navigator.clipboard.writeText)(async()=>{try{await navigator.clipboard.writeText(C);try{window.alert(`Room code: ${I}
Invite link copied to clipboard!
${C}`)}catch{}}catch{try{window.alert(`Room code: ${I}
Share this link:
${C}`)}catch{}}})();else try{window.alert(`Room code: ${I}
Share this link:
${C}`)}catch{}}catch{}if(i)return;i=!0,n(),t.setScene(new Qt(I.toLowerCase(),E));return}if(T(this.modalJoinBtn)){const _=et.getPlayerName()||this.shareRoomName||"Anon",E=typeof window<"u"&&window.prompt("Your name",_)||_;et.setPlayerName(E);let I=this.shareRoomCode||"";if(I||(I=((typeof window<"u"?window.prompt("Enter room code to join",""):"")||"").trim()),!I){this.onlineModalOpen=!1;return}if(i)return;i=!0,n(),t.setScene(new Qt(I.toLowerCase(),E));return}if(T(this.modalCancelBtn)){this.onlineModalOpen=!1;return}return}if(this.btnS&&v>=this.btnS.x&&v<=this.btnS.x+this.btnS.w&&M>=this.btnS.y&&M<=this.btnS.y+this.btnS.h)return o(!1);if(this.btnV&&v>=this.btnV.x&&v<=this.btnV.x+this.btnV.w&&M>=this.btnV.y&&M<=this.btnV.y+this.btnV.h)return o(!0);if(this.btnVO&&v>=this.btnVO.x&&v<=this.btnVO.x+this.btnVO.w&&M>=this.btnVO.y&&M<=this.btnVO.y+this.btnVO.h)return o(!0,!0);if(this.btnEditName&&v>=this.btnEditName.x&&v<=this.btnEditName.x+this.btnEditName.w&&M>=this.btnEditName.y&&M<=this.btnEditName.y+this.btnEditName.h){try{const T=et.getPlayerName()||"Anon",_=typeof window<"u"?window.prompt("Your name",T):null;_!=null&&et.setPlayerName(_)}catch{}return}}o(!1)},c=w=>{var g;try{w.stopPropagation()}catch{}const u=((g=w.touches)==null?void 0:g.length)??0;o(u>=2)},a=w=>{try{w.stopPropagation()}catch{}o(!1)},p=w=>{this.onlineModalOpen||o(!1)},x=w=>{var g;const u=((g=w.touches)==null?void 0:g.length)??0;this.onlineModalOpen||o(u>=2)},m=w=>{this.onlineModalOpen||o(!1)};t.canvas.onpointerdown=f,t.canvas.ontouchstart=c,t.canvas.onclick=a,document.addEventListener("pointerdown",p,{passive:!0}),document.addEventListener("touchstart",x,{passive:!0}),document.addEventListener("click",m,{passive:!0})}update(t,i){this.t+=t,i.input.wasPressed("KeyS")&&i.setScene(new kt),i.input.wasPressed("KeyV")&&i.setScene(new Yt),i.input.wasPressed("KeyO")&&this.launchOnline(i),i.input.wasPressed("Escape")&&this.onlineModalOpen&&(this.onlineModalOpen=!1),i.input.wasPressed("KeyM")&&(F.muted=!F.muted),i.input.wasPressed("KeyR")&&it.toggleReducedMotion(),i.input.wasPressed("KeyC")&&et.clear();const{ctx:n}=i,o=i.canvas.width,f=i.canvas.height,c=n.createLinearGradient(0,0,0,f);c.addColorStop(0,"#0b1023"),c.addColorStop(1,"#1a2247"),n.fillStyle=c,n.fillRect(0,0,o,f),n.save(),n.globalAlpha=.2;for(let P=0;P<60;P++){const j=P*91%o,L=P*53%f;n.fillStyle=P%2?"#d0e0ff":"#a0b8ff",n.fillRect(j,L+(Math.sin(this.t+P)*2+2)|0,2,2)}n.restore();const a=Math.sin(this.t*2)*6;n.textBaseline="top";const p="CrappBird";n.font="900 72px system-ui, ui-sans-serif, -apple-system, Segoe UI";const x=n.measureText(p).width,m=Math.max(24,(o-x)/2),w=56+a,u=n.createLinearGradient(m,w,m,w+72);u.addColorStop(0,"#e6f0ff"),u.addColorStop(1,"#9cc9ff"),n.save(),n.shadowColor="#3b82f6aa",n.shadowBlur=18,n.fillStyle=u,n.fillText(p,m,w),n.restore(),n.strokeStyle="#58a6ff",n.lineWidth=5,n.beginPath(),n.moveTo(m,w+72+6),n.lineTo(m+Math.min(520,x*.65),w+72+6),n.stroke();const g=m-80,S=w+10,v=18,M=Math.sin(this.t*10)*.6;n.fillStyle="#58a6ff",n.beginPath(),n.arc(g,S,v,0,Math.PI*2),n.fill(),n.fillStyle="#ffffffaa",n.beginPath(),n.arc(g-v*.2,S+v*.1,v*.7,Math.PI*.1,Math.PI*1.2),n.fill(),n.save(),n.translate(g-v*.2,S),n.rotate(-.8+M),n.fillStyle="#00000022",n.beginPath(),n.ellipse(0,0,v*.9,v*.5,0,0,Math.PI*2),n.fill(),n.restore(),n.fillStyle="#ffd166",n.beginPath(),n.moveTo(g+v*.9,S),n.lineTo(g+v*1.4,S-v*.2),n.lineTo(g+v*.9,S+v*.2),n.closePath(),n.fill(),n.fillStyle="#fff",n.beginPath(),n.arc(g+v*.2,S-v*.3,v*.22,0,Math.PI*2),n.fill(),n.fillStyle="#000",n.beginPath(),n.arc(g+v*.25,S-v*.3,v*.1,0,Math.PI*2),n.fill(),n.save();const T=n.createRadialGradient(o/2,f/2,Math.min(o,f)*.2,o/2,f/2,Math.max(o,f)*.6);T.addColorStop(0,"rgba(0,0,0,0)"),T.addColorStop(1,"rgba(0,0,0,0.35)"),n.fillStyle=T,n.fillRect(0,0,o,f),n.restore();const _=Math.min(560,o-64),E=170,I=(o-_)/2;n.fillStyle="#0f172ae6",n.beginPath(),n.roundRect(I,E,_,150,14),n.fill(),n.fillStyle="#cdd9e5",n.font="700 22px system-ui",n.fillText("Play",I+16,E+16);const A=18,C=44,K=16,q=3,$=Math.floor((_-K*2-A*(q-1))/q),ht=$*q+A*(q-1),X=I+Math.max(K,(_-ht)/2),J=E+56,st=(P,j,L,G)=>{n.fillStyle="#15223f",n.strokeStyle="#58a6ffaa",n.lineWidth=3,n.beginPath(),n.roundRect(P,j,$,C,10),n.fill(),n.stroke(),G&&(n.fillStyle="#9cc9ff",n.font="700 18px system-ui",n.fillText(G,P+12,j+28)),n.fillStyle="#e8e8f0",n.font="600 18px system-ui",n.fillText(L,P+(G?36:14),j+28)};st(X,J,"S — Singleplayer","🎮"),st(X+$+A,J,"V — Versus (Local)","🤝"),st(X+($+A)*2,J,"O — Versus (Online)","🌐"),this.btnS={x:X,y:J,w:$,h:C},this.btnV={x:X+$+A,y:J,w:$,h:C},this.btnVO={x:X+($+A)*2,y:J,w:$,h:C};const ft=E+170,vt=Math.min(760,o-64),ut=(o-vt)/2;n.fillStyle="#0f172acc",n.beginPath(),n.roundRect(ut,ft,vt,160,14),n.fill(),n.fillStyle="#cdd9e5",n.font="700 20px system-ui",n.fillText("Controls",ut+16,ft+16),n.font="500 16px system-ui";let dt=ft+46;n.fillText("Singleplayer: Flap = Space/ArrowUp/W or Click/Tap • Move = ArrowLeft/Right or A/D • Shoot = Right Click or Ctrl/J (hold)",ut+16,dt),dt+=28,n.fillText("Versus (Local): P1 = Arrows + Space • P2 = W (flap), S (nudge down)",ut+16,dt),dt+=28,n.fillText(`Online: O — create or join room • Mute = M (${F.muted?"Muted":"Sound on"}) • Reduced motion = R (${it.reducedMotion?"On":"Off"}) • Esc returns here`,ut+16,dt);const Mt=ft+170,Bt=Math.min(760,o-64),St=(o-Bt)/2;n.fillStyle="#0f172acc",n.beginPath(),n.roundRect(St,Mt,Bt,130,14),n.fill(),n.fillStyle="#cdd9e5",n.font="700 20px system-ui",n.fillText("Power-ups",St+16,Mt+16),n.font="500 14px system-ui";let N=Mt+44;const H=[["+ Heal","gain 1 heart"],["R Rapid","shorter cooldown"],["S Shield","+1 max heart and heal"],["M Multishot","fires 3 bullets"],["B Bigshot","bigger bullets, +1 dmg"],["⌛ Slowmo","world slows briefly"],["U Magnet","pulls pickups nearby"]];for(const[P,j]of H)n.fillText(`${P} — ${j}`,St+16,N),N+=20;const pt=et.getTop(5);if(pt.length){const P=Math.min(420,o-40),j=28+pt.length*22+20,L=(o-P)/2,G=f-j-80;n.fillStyle="#0f172acc",n.beginPath(),n.roundRect(L,G,P,j,10),n.fill(),n.fillStyle="#cdd9e5",n.font="700 16px system-ui",n.fillText("Top Scores",L+12,G+20),n.font="500 14px system-ui";for(let at=0;at<pt.length;at++){const mt=pt[at],lt=`${at+1}. ${(mt.name||"Anon").slice(0,18)} — ${mt.score}`;n.fillText(lt,L+12,G+44+at*22)}n.font="400 12px system-ui",n.fillStyle="#94a3b8",n.fillText("Press C to clear • Name is saved locally",L+12,G+j-10);const yt=92,Q=22,V=L+P-yt-10,Y=G+10;n.fillStyle="#15223f",n.strokeStyle="#58a6ff88",n.lineWidth=2,n.beginPath(),n.roundRect(V,Y,yt,Q,6),n.fill(),n.stroke(),n.fillStyle="#e8e8f0",n.font="600 12px system-ui",n.fillText("Edit name",V+12,Y+15),this.btnEditName={x:V,y:Y,w:yt,h:Q}}const Ct=.5+.5*Math.sin(this.t*3);n.save(),n.globalAlpha=.6+.4*Ct,n.fillStyle="#7dd3fc",n.font="700 18px system-ui";const _t="Tap to start • Starts easy, ramps up • Two-finger tap for Versus (S/V)",Pt=n.measureText(_t).width;if(n.fillText(_t,Math.max(20,(o-Pt)/2),f-60),n.restore(),this.onlineModalOpen){n.save(),n.fillStyle="rgba(0,0,0,0.5)",n.fillRect(0,0,o,f);const P=Math.min(420,o-40),j=200,L=(o-P)/2,G=Math.max(60,f*.25);n.fillStyle="#0f172ae6",n.beginPath(),n.roundRect(L,G,P,j,12),n.fill(),n.strokeStyle="#58a6ff55",n.stroke(),n.fillStyle="#cdd9e5",n.font="700 20px system-ui",n.fillText("Online Match",L+16,G+16),n.font="500 14px system-ui",n.fillStyle="#94a3b8";const yt=this.shareRoomCode?`You were invited to room ${this.shareRoomCode.toUpperCase()}. Join to continue.`:"Create a room to host, or join with a code from a friend.";n.fillText(yt,L+16,G+44);const Q=(P-16*3)/2,V=40,Y=G+j-V-20;n.fillStyle="#15223f",n.strokeStyle="#58a6ffaa",n.lineWidth=3,n.beginPath(),n.roundRect(L+16,Y,Q,V,10),n.fill(),n.stroke(),n.fillStyle="#e8e8f0",n.font="600 16px system-ui",n.fillText("Create Room",L+16+14,Y+26),this.modalCreateBtn={x:L+16,y:Y,w:Q,h:V},n.fillStyle="#15223f",n.strokeStyle="#58a6ffaa",n.lineWidth=3,n.beginPath(),n.roundRect(L+16*2+Q,Y,Q,V,10),n.fill(),n.stroke(),n.fillStyle="#e8e8f0",n.font="600 16px system-ui";const at=this.shareRoomCode?`Join Room ${this.shareRoomCode.toUpperCase()}`:"Join Room";n.fillText(at,L+16*2+Q+14,Y+26),this.modalJoinBtn={x:L+16*2+Q,y:Y,w:Q,h:V},n.fillStyle="#9cc9ff",n.font="600 14px system-ui";const mt="Cancel (Esc)",lt=n.measureText(mt).width,Lt=L+P-lt-16,Ot=G+16;n.fillText(mt,Lt,Ot+2),this.modalCancelBtn={x:Lt-6,y:Ot-6,w:lt+12,h:24},n.restore()}else this.modalCreateBtn=this.modalJoinBtn=this.modalCancelBtn=null}render(){}}const ae=document.getElementById("gameCanvas");ae.style.width="100vw";ae.style.height="100vh";const Tt=new $e(ae);let De="title";const Et=l=>{switch(De=l,l){case"title":Tt.setScene(new ki);break;case"single":Tt.setScene(new kt);break;case"versus":Tt.setScene(new Yt);break;case"versusOnline":{const t="Anon",i="test";Tt.setScene(new Qt(i,t));break}}};Et("title");window.addEventListener("keydown",l=>{De==="title"?(l.code==="KeyS"&&Et("single"),l.code==="KeyV"&&Et("versus"),l.code==="KeyO"&&Et("versusOnline")):l.code==="Escape"&&Et("title")});window.addEventListener("resize",()=>Tt.resizeToDisplay());
