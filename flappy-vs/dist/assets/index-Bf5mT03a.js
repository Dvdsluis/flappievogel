(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const l of n)if(l.type==="childList")for(const f of l.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&r(f)}).observe(document,{childList:!0,subtree:!0});function s(n){const l={};return n.integrity&&(l.integrity=n.integrity),n.referrerPolicy&&(l.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?l.credentials="include":n.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function r(n){if(n.ep)return;n.ep=!0;const l=s(n);fetch(n.href,l)}})();class je{constructor(){this.down=new Set,this.pressedThisFrame=new Set,window.addEventListener("keydown",t=>{this.down.has(t.code)||this.pressedThisFrame.add(t.code),this.down.add(t.code),["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","KeyW","KeyA","KeyS","KeyD"].includes(t.code)&&t.preventDefault()},{passive:!1}),window.addEventListener("keyup",t=>this.down.delete(t.code))}beginFrame(){this.pressedThisFrame.clear()}endFrame(){}isDown(t){return this.down.has(t)}wasPressed(t){return this.pressedThisFrame.has(t)}getMovementDirection(){return{x:(this.isDown("ArrowRight")?1:0)+(this.isDown("ArrowLeft")?-1:0),y:(this.isDown("ArrowDown")?1:0)+(this.isDown("ArrowUp")?-1:0)}}getWASDHorizontal(){return(this.isDown("KeyD")?1:0)+(this.isDown("KeyA")?-1:0)}}class Ge{constructor(t){this.lastTime=0,this.running=!1,this.scene=null,this.loop=r=>{if(!this.running||!this.scene)return;const n=Math.min(1/30,(r-this.lastTime)/1e3);this.lastTime=r,this.input.beginFrame(),this.scene.update(n,this),this.scene.render(this.ctx,this),this.input.endFrame(),requestAnimationFrame(this.loop)},this.canvas=t;const s=t.getContext("2d");if(!s)throw new Error("2D context not available");this.ctx=s,this.input=new je,this.resizeToDisplay()}resizeToDisplay(){var l,f;const t=Math.max(1,Math.min(window.devicePixelRatio||1,2)),s=this.canvas.getBoundingClientRect(),r=Math.floor(s.width*t)||800,n=Math.floor(s.height*t)||600;(this.canvas.width!==r||this.canvas.height!==n)&&(this.canvas.width=r,this.canvas.height=n),this.ctx.setTransform(1,0,0,1,0,0),(f=(l=this.scene)==null?void 0:l.onResize)==null||f.call(l,this)}setScene(t){this.scene=t,t.init(this),this.running||(this.running=!0,this.lastTime=performance.now(),requestAnimationFrame(this.loop))}}class _t{constructor(t=50,s=50,r=28,n=28,l){this.vx=0,this.vy=0,this._score=0,this.hp=3,this.maxHp=3,this.fireCooldown=0,this.x=t,this.y=s,this.width=r,this.height=n}setPosition(t,s){this.x=t,this.y=s}passObstacle(){this._score+=1}update(t){this.x+=this.vx*t,this.y+=this.vy*t,this.fireCooldown>0&&(this.fireCooldown=Math.max(0,this.fireCooldown-t))}get score(){return Math.max(0,this._score)}set score(t){this._score=Math.max(0,t)}}class Z{constructor(t,s,r,n,l=120){this.x=t,this.y=s,this.width=r,this.height=n,this.speed=l}update(t){this.x-=this.speed*t}isOffScreen(){return this.x+this.width<0}}class Vt{render(t,s,r,n,l){t.fillStyle="#e8e8f0",t.font="700 20px system-ui, sans-serif",typeof r=="number"?t.fillText(`P1: ${s}   P2: ${r}`,16,24):t.fillText(`Score: ${s}`,16,24);const f=(c,p,x)=>{if(x!=null)for(let m=0;m<x;m++){t.fillStyle="#ff7b72",t.beginPath();const g=m*18;t.moveTo(c+g+6,p+10),t.arc(c+g+3,p+8,3,0,Math.PI),t.arc(c+g+9,p+8,3,0,Math.PI),t.lineTo(c+g+6,p+14),t.closePath(),t.fill()}};f(16,36,n),l!=null&&f(120,36,l)}}const dt=class dt{static applyGravity(t,s){t.vy+=dt.gravity*s}static jump(t){t.vy=dt.jumpVelocity}static checkCollision(t,s){return!(t.x+t.width<s.x||t.x>s.x+s.width||t.y+t.height<s.y||t.y>s.y+s.height)}};dt.gravity=900,dt.jumpVelocity=-300;let G=dt;class Yt{constructor(t,s){this.canvas=t,this.ctx=s,this.t=0,this.cloudOffset=0}clear(t=0){const{ctx:s}=this,r=this.canvas.width,n=this.canvas.height;this.t+=t,this.cloudOffset=(this.cloudOffset+t*20)%(r+200);const l=s.createLinearGradient(0,0,0,n);l.addColorStop(0,"#0f1630"),l.addColorStop(1,"#0b1022"),s.fillStyle=l,s.fillRect(0,0,r,n);const f=(c,p,x)=>{s.fillStyle="#ffffff14",s.beginPath(),s.roundRect(c,p,120*x,40*x,20*x),s.fill()};for(let c=0;c<4;c++){const p=r-(this.cloudOffset+c*180)%(r+200),x=40+c*45%(n*.5);f(p,x,1)}s.fillStyle="#1a2446",s.fillRect(0,n-20,r,20),s.fillStyle="#111a36";for(let c=0;c<r;c+=16)s.fillRect(c,n-22,8,2)}drawBird(t,s){const{ctx:r}=this,n=Math.min(t.width,t.height)/2,l=t.x+n,f=t.y+n,c=Math.sin(this.t*10)*.6;r.fillStyle=s,r.beginPath(),r.arc(l,f,n,0,Math.PI*2),r.fill(),r.fillStyle="#ffffff88",r.beginPath(),r.arc(l-n*.2,f+n*.1,n*.7,Math.PI*.1,Math.PI*1.2),r.fill(),r.save(),r.translate(l-n*.2,f),r.rotate(-.8+c),r.fillStyle="#00000022",r.beginPath(),r.ellipse(0,0,n*.9,n*.5,0,0,Math.PI*2),r.fill(),r.restore(),r.fillStyle="#ffd166",r.beginPath(),r.moveTo(l+n*.9,f),r.lineTo(l+n*1.4,f-n*.2),r.lineTo(l+n*.9,f+n*.2),r.closePath(),r.fill(),r.fillStyle="#fff",r.beginPath(),r.arc(l+n*.2,f-n*.3,n*.22,0,Math.PI*2),r.fill(),r.fillStyle="#000",r.beginPath(),r.arc(l+n*.25,f-n*.3,n*.1,0,Math.PI*2),r.fill()}drawPlayer(t,s="#58a6ff"){this.drawBird(t,s)}drawObstacle(t){const{ctx:s}=this,r=s.createLinearGradient(t.x,t.y,t.x+t.width,t.y);r.addColorStop(0,"#2bc072"),r.addColorStop(1,"#3be688"),s.fillStyle=r,s.fillRect(t.x,t.y,t.width,t.height),s.fillStyle="#ffffff18",s.fillRect(t.x+6,t.y,6,t.height)}drawHUD(t){this.ctx.fillStyle="#e8e8f0",this.ctx.font="700 24px system-ui, sans-serif",this.ctx.fillText(t,16,32)}drawProjectile(t,s="#ffd166"){const{ctx:r}=this;r.fillStyle=t.color||s,r.fillRect(t.x,t.y,t.width,t.height)}drawEnemy(t){const{ctx:s}=this,r=t.variant||"drone";r==="tank"?(s.fillStyle="#c65353",s.beginPath(),s.roundRect(t.x,t.y,t.width,t.height,4),s.fill(),s.fillStyle="#00000055",s.fillRect(t.x+3,t.y+t.height-6,t.width-6,4)):r==="bee"?(s.fillStyle="#ffd166",s.beginPath(),s.ellipse(t.x+t.width/2,t.y+t.height/2,t.width/2,t.height/2,0,0,Math.PI*2),s.fill(),s.fillStyle="#00000066",s.fillRect(t.x+4,t.y+4,t.width-8,4),s.fillRect(t.x+4,t.y+10,t.width-8,4)):r==="kamikaze"?(s.fillStyle="#ff7b72",s.beginPath(),s.ellipse(t.x+t.width/2,t.y+t.height/2,t.width/2,t.height/2,0,0,Math.PI*2),s.fill(),s.fillStyle="#ffffffaa",s.beginPath(),s.arc(t.x+t.width/2+3,t.y+t.height/2-2,3,0,Math.PI*2),s.fill()):(s.fillStyle="#ff7b72",s.beginPath(),s.ellipse(t.x+t.width/2,t.y+t.height/2,t.width/2,t.height/2,0,0,Math.PI*2),s.fill(),s.fillStyle="#00000055",s.fillRect(t.x+2,t.y+2,t.width-4,3))}drawPowerUp(t){const{ctx:s}=this,r={heal:"#7ee787",rapid:"#f7b84a",shield:"#8b8efb",multishot:"#38bdf8",bigshot:"#fb7185",slowmo:"#a78bfa",magnet:"#f472b6"};s.fillStyle=r[t.type]||"#f7b84a",s.beginPath(),s.roundRect(t.x,t.y,t.width,t.height,4),s.fill(),s.fillStyle="#0f172a",s.font="700 10px system-ui";const n=t.x+t.width/2,l=t.y+t.height/2+3,c={heal:"+",rapid:"R",shield:"S",multishot:"M",bigshot:"B",slowmo:"⌛",magnet:"U"}[t.type]||"?",p=s.measureText(c).width;s.fillText(c,n-p/2,l)}}class $e{constructor(){this.ctx=null,this._muted=!1}get muted(){return this._muted}set muted(t){this._muted=t;try{localStorage.setItem("mute",t?"1":"0")}catch{}}ensure(){this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext))}beep(t,s=.08,r="sine",n=.05){if(this._muted)return;this.ensure();const l=this.ctx,f=l.createOscillator(),c=l.createGain();f.type=r,f.frequency.value=t,c.gain.value=n,f.connect(c).connect(l.destination);const p=l.currentTime;f.start(p),f.stop(p+s)}flap(){this.beep(660,.05,"square",.05)}score(){this.beep(880,.08,"triangle",.06)}hit(){this.beep(120,.15,"sawtooth",.08)}combo(t){if(this._muted)return;const s=900+Math.min(4,t)*80;this.beep(s,.05,"triangle",.05)}}const U=new $e;try{U.muted=localStorage.getItem("mute")==="1"}catch{}class ge{constructor(){this.pool=[],this.active=[]}spawn(t,s,r){const n=this.pool.pop()||{x:t,y:s,vx:0,vy:0,life:.5,maxLife:.5,size:3,color:"#fff"};n.x=t,n.y=s,n.vx=(r==null?void 0:r.vx)??Math.random()*80-40,n.vy=(r==null?void 0:r.vy)??Math.random()*-80,n.life=(r==null?void 0:r.life)??.5,n.maxLife=n.life,n.size=(r==null?void 0:r.size)??3,n.color=(r==null?void 0:r.color)??"#ffffff88",n.g=(r==null?void 0:r.g)??200,this.active.push(n)}burst(t,s,r,n){for(let l=0;l<r;l++)this.spawn(t,s,{color:n,size:2+Math.random()*2,life:.4+Math.random()*.3})}update(t){for(let s=this.active.length-1;s>=0;s--){const r=this.active[s];r.vy+=(r.g||0)*t,r.x+=r.vx*t,r.y+=r.vy*t,r.life-=t,r.life<=0&&(this.pool.push(r),this.active.splice(s,1))}}render(t){for(const s of this.active){const r=Math.max(0,s.life/s.maxLife);t.fillStyle=s.color.replace(/\d?\.?\d*\)$/,"")||s.color,t.globalAlpha=r,t.beginPath(),t.arc(s.x,s.y,s.size,0,Math.PI*2),t.fill(),t.globalAlpha=1}}}function We(h){return h===2?"shoot":"flap"}class qe{constructor(t,s,r,n,l="player"){this.width=10,this.height=4,this.active=!0,this.damage=1,this.x=t,this.y=s,this.vx=r,this.vy=n,this.owner=l}update(t){this.x+=this.vx*t,this.y+=this.vy*t}isOffScreen(t,s){return this.x>t+20||this.x+this.width<-20||this.y>s+20||this.y+this.height<-20}}class Ke{constructor(t,s,r=-120,n=0,l="drone"){this.x=t,this.y=s,this.vx=r,this.vy=n,this.variant=l,l==="tank"?(this.width=34,this.height=26,this.health=3):(this.width=24,this.height=18,this.health=1)}update(t){this.x+=this.vx*t,this.y+=this.vy*t}isOffScreen(){return this.x+this.width<-40}}class He{constructor(t,s,r){this.width=16,this.height=16,this.vx=-80,this.vy=0,this.x=t,this.y=s,this.type=r}update(t){this.x+=this.vx*t,this.y+=this.vy*t}isOffScreen(){return this.x+this.width<-40}}const be="scores:v1",Ut="playerName";function se(){try{const h=localStorage.getItem(be);if(!h)return[];const t=JSON.parse(h);return Array.isArray(t)?t.map(s=>({score:Number(s.score)||0,date:Number(s.date)||Date.now(),name:typeof s.name=="string"?s.name:void 0})).filter(s=>s.score>=0&&Number.isFinite(s.date)):[]}catch{return[]}}function re(h){try{localStorage.setItem(be,JSON.stringify(h))}catch{}}const Y={addScore(h,t=Date.now(),s){const r=se(),n=(s??localStorage.getItem(Ut)??"Anon").toString().slice(0,18).trim()||"Anon";r.push({score:Math.max(0,Math.floor(h)),date:t,name:n}),r.sort((f,c)=>c.score-f.score||c.date-f.date);const l=r.slice(0,10);re(l)},getTop(h=5){const t=se();return t.sort((s,r)=>r.score-s.score||r.date-s.date),t.slice(0,h)},clear(){re([])},getPlayerName(){try{return localStorage.getItem(Ut)}catch{return null}},setPlayerName(h){try{localStorage.setItem(Ut,(h||"").toString().slice(0,18).trim()||"Anon")}catch{}}},xt=class xt{constructor(){var t;this._reducedMotion=!1,this._usingSystemPreference=!0;try{const s=localStorage.getItem(xt.STORAGE_KEY);if(s!=null)this._reducedMotion=s==="1",this._usingSystemPreference=!1;else if(typeof window<"u"&&"matchMedia"in window){const r=window.matchMedia("(prefers-reduced-motion: reduce)");this._reducedMotion=r.matches,this._usingSystemPreference=!0;try{(t=r.addEventListener)==null||t.call(r,"change",n=>{this._usingSystemPreference&&(this._reducedMotion=n.matches)})}catch{}}}catch{}}get reducedMotion(){return this._reducedMotion}set reducedMotion(t){this._reducedMotion=t,this._usingSystemPreference=!1;try{localStorage.setItem(xt.STORAGE_KEY,t?"1":"0")}catch{}}toggleReducedMotion(){this.reducedMotion=!this.reducedMotion}};xt.STORAGE_KEY="reducedMotion";let jt=xt;const z=new jt;function Ve(h,t=Math.random){let s={heal:2.2,shield:1.6,rapid:1.2,multishot:1,bigshot:.9,slowmo:.9,magnet:1};if(h<5)s.multishot*=.3,s.bigshot*=.3,s.slowmo*=.4,s.magnet*=.5,s.heal*=1.3,s.shield*=1.2;else if(h<15){const f=(h-5)/10;s.multishot*=.3+.7*f,s.bigshot*=.3+.7*f,s.slowmo*=.4+.6*f,s.magnet*=.5+.5*f}else s.rapid*=1.1,s.multishot*=1.15,s.bigshot*=1.1;const r=Object.entries(s).filter(([f,c])=>c>0),n=r.reduce((f,[,c])=>f+c,0);let l=t()*n;for(const[f,c]of r)if(l-=c,l<=0)return f;return r[r.length-1][0]}const vt=class vt{constructor(){this.player=new _t(80,150,26,26),this.obstacles=[],this.hud=new Vt,this.timeToNext=0,this.score=0,this.best=0,this.gameOver=!1,this.paused=!1,this.speed=120,this.particles=new ge,this.shakeT=0,this.hintT=4,this.bullets=[],this.enemies=[],this.powerUps=[],this.enemyTimer=0,this.powerTimer=5,this.lastGapCenter=null,this.floats=[],this.playerName=null,this.hurtT=0,this.combo=0,this.comboT=0,this.ended=!1,this.multishotT=0,this.bigshotT=0,this.slowmoT=0,this.magnetT=0,this.rapidT=0,this.pickupBadgeT=0,this.mobileMoveX=0,this.isTouch="ontouchstart"in window,this.btnLeftDown=!1,this.btnRightDown=!1,this.btnShootDown=!1,this.btnRects=null,this.restartRect=null}init(t){this.renderer=new Yt(t.canvas,t.ctx),this.obstacles=[],this.score=0,this.timeToNext=0,this.gameOver=!1,this.paused=!1,this.speed=120,this.player.x=80,this.player.y=Math.max(0,(t.canvas.height-this.player.height)*.5),this.player.vx=0,this.player.vy=0,this.player.hp=this.player.maxHp=3,this.player.fireCooldown=0,this.bullets=[],this.enemies=[],this.powerUps=[],this.enemyTimer=2.5,this.powerTimer=5,this.hintT=4,this.shakeT=0,this.floats=[],this.lastGapCenter=null,this.ended=!1,this.btnLeftDown=this.btnRightDown=this.btnShootDown=!1,this.restartRect=null,this.multishotT=0,this.bigshotT=0,this.slowmoT=0,this.magnetT=0,this.rapidT=0;const s=()=>{const p=t.canvas.width,x=t.canvas.height,m=Math.max(60,Math.min(120,Math.floor(Math.min(p,x)*.14))),g=24;this.btnRects={left:{x:g,y:x-m-g,w:m,h:m},right:{x:g+m+16,y:x-m-g,w:m,h:m},shoot:{x:p-m-g,y:x-m-g,w:m,h:m}}},r=()=>{const p=t.canvas.width,x=t.canvas.height,m=Math.max(64,Math.min(120,Math.floor(Math.min(p,x)*.16)));this.restartRect={x:(p-m)/2,y:x*.55,w:m,h:m}},n=(p,x,m)=>{if(!this.btnRects)return!1;const g=this.btnRects[p];return x>=g.x&&x<=g.x+g.w&&m>=g.y&&m<=g.y+g.h},l=p=>{s(),this.btnLeftDown=this.btnRightDown=this.btnShootDown=!1;const x=t.canvas.getBoundingClientRect(),m=t.canvas.width/x.width,g=t.canvas.height/x.height;for(let u=0;u<p.touches.length;u++){const b=p.touches.item(u),v=(b.clientX-x.left)*m,_=(b.clientY-x.top)*g;n("left",v,_)?this.btnLeftDown=!0:n("right",v,_)?this.btnRightDown=!0:n("shoot",v,_)&&(this.btnShootDown=!0)}},f=p=>{var g;if(this.gameOver){if(p.touches!==void 0){r();const u=p,b=t.canvas.getBoundingClientRect(),v=t.canvas.width/b.width,_=t.canvas.height/b.height;for(let M=0;M<u.touches.length;M++){const E=u.touches.item(M),I=(E.clientX-b.left)*v,L=(E.clientY-b.top)*_,B=this.restartRect;if(I>=B.x&&I<=B.x+B.w&&L>=B.y&&L<=B.y+B.h){this.init(t);return}}}else{r();const u=this.restartRect,b=p,v=t.canvas.getBoundingClientRect(),_=t.canvas.width/v.width,M=t.canvas.height/v.height,E=(b.clientX-v.left)*_,I=(b.clientY-v.top)*M;if(E>=u.x&&E<=u.x+u.w&&I>=u.y&&I<=u.y+u.h){this.init(t);return}}return}if(p.touches!==void 0){const u=p;if(l(u),this.btnLeftDown||this.btnRightDown||this.btnShootDown){this.btnShootDown&&this.fireWeapon();return}const b=t.canvas.width,v=t.canvas.height,_=t.canvas.getBoundingClientRect(),M=b/_.width,E=v/_.height;let I=!1;for(let B=0;B<u.touches.length;B++){const P=u.touches.item(B),N=(P.clientX-_.left)*M,$=(P.clientY-_.top)*E;if(N>b*.7&&$>v*.6){I=!0;break}}if(I){this.fireWeapon();return}(((g=u.touches)==null?void 0:g.length)??0)>=2?this.fireWeapon():(G.jump(this.player),U.flap(),this.particles.burst(this.player.x+this.player.width*.2,this.player.y+this.player.height,z.reducedMotion?4:8,"#88ccff88"));return}const x=p.button??0,m=We(x);m==="flap"?(G.jump(this.player),U.flap()):m==="shoot"&&this.fireWeapon()};t.canvas.oncontextmenu=p=>{p.preventDefault()},t.canvas.onpointerdown=f;const c=p=>{const x=t.canvas.getBoundingClientRect();let m=0,g=0;for(let u=0;u<p.touches.length;u++){const v=p.touches.item(u).clientX-x.left;v<x.width*.45?m=1:v>x.width*.55&&(g=1)}this.mobileMoveX=g-m};t.canvas.ontouchstart=p=>{c(p),f(p)},t.canvas.ontouchmove=p=>{c(p),l(p)},t.canvas.ontouchend=p=>{c(p),l(p)};try{const p=localStorage.getItem("best");p&&(this.best=parseInt(p,10)||0)}catch{}try{this.playerName=Y.getPlayerName()}catch{this.playerName=null}document.addEventListener("visibilitychange",()=>{document.hidden&&(this.paused=!0)})}fireWeapon(){if(this.player.fireCooldown>0)return;const t=this.player.x+this.player.width,s=this.player.y+this.player.height*.5-2,r=l=>{const c=Math.cos(l)*360,p=Math.sin(l)*360,x=new qe(t,s,c,p,"player");return this.bigshotT>0&&(x.width=14,x.damage=2,x.color="#ffa6a6"),x};this.multishotT>0?(this.bullets.push(r(0-.13)),this.bullets.push(r(0)),this.bullets.push(r(0+.13))):this.bullets.push(r(0));let n=this.bigshotT>0?.22:this.multishotT>0?.2:.18;this.rapidT>0&&(n=Math.max(.08,n*.55)),this.player.fireCooldown=n,U.beep(980,.05,"square",.05)}update(t,s){var m,g;const r=s.canvas.height;if(s.input.wasPressed("KeyP")&&(this.paused=!this.paused),s.input.wasPressed("KeyR")&&this.init(s),this.paused)return;const n=this.slowmoT>0?.7:1,l=t*n;(s.input.wasPressed("Space")||s.input.wasPressed("ArrowUp")||s.input.wasPressed("KeyW"))&&(G.jump(this.player),U.flap(),this.particles.burst(this.player.x+this.player.width*.2,this.player.y+this.player.height,z.reducedMotion?4:8,"#88ccff88")),(s.input.isDown("KeyJ")||s.input.isDown("ControlLeft")||s.input.isDown("ControlRight")||this.btnShootDown)&&this.fireWeapon();const f=s.input.getMovementDirection(),c=((g=(m=s.input).getWASDHorizontal)==null?void 0:g.call(m))??(s.input.isDown("KeyD")?1:0)+(s.input.isDown("KeyA")?-1:0),p=(this.btnRightDown?1:0)-(this.btnLeftDown?1:0);if(this.player.vx=(f.x+c+this.mobileMoveX+p)*80,G.applyGravity(this.player,l),this.player.update(l),this.player.y=Math.max(0,Math.min(r-this.player.height,this.player.y)),this.timeToNext-=l,this.timeToNext<=0){const u=Math.min(1,this.score/30);this.speed=Math.min(280,120+u*140);const b=Math.max(150,230-this.score*2.2);this.timeToNext=Math.max(1.1,1.8-this.score*.02);const v=b,_=60,M=_+v/2,E=r-_-v/2,I=this.lastGapCenter??r/2,L=140+Math.min(100,this.score*2),B=Math.max(M,I-L),P=Math.min(E,I+L),N=B<=P?B+Math.random()*(P-B):Math.min(E,Math.max(M,I)),$=Math.floor(N-v/2);this.lastGapCenter=N;const K=80,q=s.canvas.width+K;this.obstacles.push(new Z(q,0,K,$,this.speed)),this.obstacles.push(new Z(q,$+v,K,r-($+v),this.speed))}for(const u of this.obstacles)u.update(l);this.obstacles=this.obstacles.filter(u=>!u.isOffScreen());for(const u of this.obstacles)G.checkCollision(this.player,u)&&(this.player.hp-=1,U.hit(),this.particles.burst(this.player.x+this.player.width/2,this.player.y+this.player.height/2,z.reducedMotion?6:12,"#ff7b72aa"),this.shakeT=z.reducedMotion?0:.2,this.hurtT=.35,this.combo=0,this.comboT=0,this.player.x-=10,this.player.hp<=0&&this.finalizeGameOver());for(let u=0;u<this.obstacles.length;u+=2){const b=this.obstacles[u],v=b.x+b.width/2;!this.gameOver&&v<this.player.x&&b.counted!==!0&&(b.counted=!0,this.score+=1,this.player.passObstacle(),U.score())}if(this.enemyTimer-=l,this.enemyTimer<=0){let u=40,b=r-40;if(this.obstacles.length>=2){let K=0,q=-1/0;for(let et=0;et<this.obstacles.length-1;et+=2){const it=this.obstacles[et];it.x>q&&(q=it.x,K=et)}const tt=this.obstacles[K],rt=this.obstacles[K+1];u=tt.height,b=rt.y}const v=12,_=Math.max(0,u+v),M=Math.min(r-20,b-v-18),E=s.canvas.width+40,I=_<M?_+(M-_)*(.35+Math.random()*.3):40+Math.random()*(r-120);let L="drone";this.score>6&&Math.random()<.5&&(L="bee"),this.score>15&&Math.random()<.35&&(L="tank"),this.score>25&&Math.random()<.25&&(L="kamikaze");const P=-((L==="tank"?90:120)+Math.random()*60+this.score*1.2),N=new Ke(E,I,P,0,L);N.minY=isFinite(_)?_:20,N.maxY=isFinite(M)?M:r-40,N.phase=Math.random()*Math.PI*2,this.enemies.push(N);const $=2.4-Math.min(1.2,this.score*.03);this.enemyTimer=Math.max(.8,$+(L==="tank"?.3:0))}if(this.powerTimer-=l,this.powerTimer<=0){const u=Ve(this.score);this.powerUps.push(new He(s.canvas.width+20,80+Math.random()*(r-160),u)),this.powerTimer=8+Math.random()*6}for(const u of this.bullets)u.update(l);for(const u of this.enemies){const b=(u.phase??0)+performance.now()/1e3;if(u.variant==="kamikaze"){const E=this.player.y-6-u.y;u.vy=Math.max(-120,Math.min(120,E*2))}else u.variant==="bee"?u.vy=Math.sin(b*1.5)*55:u.variant==="tank"?u.vy=Math.sin(b*.6)*24:u.vy=Math.sin(b)*35;u.update(l);const v=u.minY??20,_=u.maxY??r-40;u.y<v&&(u.y=v),u.y+u.height>_&&(u.y=_-u.height)}for(const u of this.powerUps){if(this.magnetT>0){const b=this.player.x+this.player.width/2,v=this.player.y+this.player.height/2,_=b-(u.x+u.width/2),M=v-(u.y+u.height/2);_*_+M*M<200*200&&(u.vx+=Math.sign(_)*20,u.vy+=Math.sign(M)*20,!z.reducedMotion&&Math.random()<.25&&this.particles.burst(u.x+u.width/2,u.y+u.height/2,1,"#f472b6aa"))}u.update(l)}this.bullets=this.bullets.filter(u=>!u.isOffScreen(s.canvas.width,r)&&u.active),this.enemies=this.enemies.filter(u=>!u.isOffScreen()),this.powerUps=this.powerUps.filter(u=>!u.isOffScreen());const x=(u,b,v,_,M,E,I,L)=>u<M+I&&u+v>M&&b<E+L&&b+_>E;for(const u of this.bullets)for(const b of this.enemies)if(u.active&&x(u.x,u.y,u.width,u.height,b.x,b.y,b.width,b.height)&&(u.active=!1,b.health-=u.damage??1,this.particles.burst(b.x+b.width/2,b.y+b.height/2,z.reducedMotion?6:10,"#ffd166aa"),b.health<=0)){const v=b.x+b.width/2,_=b.y+b.height/2;this.particles.burst(v,_,z.reducedMotion?10:22,"#ffb347aa"),this.particles.burst(v,_,z.reducedMotion?8:14,"#ff7b72aa"),b.x=-9999;const M=b.variant==="tank"?vt.KILL_POINTS+1:vt.KILL_POINTS,E=2.2;this.comboT>0?this.combo++:this.combo=1,this.comboT=E;const I=Math.max(0,this.combo-1);this.score+=M+I,this.floats.push({x:v,y:_,text:`+${M}`,ttl:.9,vy:-32}),I>0&&(this.floats.push({x:v+14,y:_-18,text:`x${this.combo}`,ttl:.8,vy:-26}),U.combo(this.combo)),this.shakeT=z.reducedMotion?0:Math.max(this.shakeT,.12),U.score()}this.enemies=this.enemies.filter(u=>u.x>-9e3);for(const u of this.enemies)x(this.player.x,this.player.y,this.player.width,this.player.height,u.x,u.y,u.width,u.height)&&(this.player.hp-=1,U.hit(),this.particles.burst(u.x+u.width/2,u.y+u.height/2,10,"#ff7b72aa"),u.x=-9999,this.player.hp<=0&&this.finalizeGameOver());for(const u of this.powerUps)x(this.player.x,this.player.y,this.player.width,this.player.height,u.x,u.y,u.width,u.height)&&(u.type==="heal"&&(this.player.hp=Math.min(this.player.maxHp,this.player.hp+1)),u.type==="rapid"&&(this.rapidT=Math.max(this.rapidT,8)),u.type==="shield"&&(this.player.maxHp=Math.min(5,this.player.maxHp+1),this.player.hp=Math.min(this.player.maxHp,this.player.hp+1)),u.type==="multishot"&&(this.multishotT=Math.max(this.multishotT,8)),u.type==="bigshot"&&(this.bigshotT=Math.max(this.bigshotT,8)),u.type==="slowmo"&&(this.slowmoT=Math.max(this.slowmoT,3.5)),u.type==="magnet"&&(this.magnetT=Math.max(this.magnetT,8)),this.particles.burst(u.x+u.width/2,u.y+u.height/2,14,"#7ee787aa"),u.x=-9999,this.pickupBadgeT=1.4);this.particles.update(l),this.shakeT=Math.max(0,this.shakeT-t),this.hurtT=Math.max(0,this.hurtT-t),this.comboT>0&&(this.comboT=Math.max(0,this.comboT-t)),this.slowmoT=Math.max(0,this.slowmoT-t),this.multishotT=Math.max(0,this.multishotT-t),this.bigshotT=Math.max(0,this.bigshotT-t),this.magnetT=Math.max(0,this.magnetT-t),this.rapidT=Math.max(0,this.rapidT-t);for(const u of this.floats)u.ttl-=t,u.y+=u.vy*t;this.floats=this.floats.filter(u=>u.ttl>0),this.hintT=Math.max(0,this.hintT-t)}finalizeGameOver(){if(this.ended)return;this.ended=!0,this.gameOver=!0,this.best=Math.max(this.best,this.score);try{localStorage.setItem("best",String(this.best))}catch{}let t=Y.getPlayerName()||"";try{const s=typeof window<"u"?window.prompt("Name for high score?",t||"Anon"):null;s!=null&&(t=s,Y.setPlayerName(t))}catch{}Y.addScore(this.score,Date.now(),t),this.playerName=t}render(t,s){const r=this.shakeT>0?(Math.random()-.5)*8:0;t.save(),t.translate(r,r),this.renderer.clear(1/60);for(const f of this.obstacles)this.renderer.drawObstacle(f);for(const f of this.enemies)this.renderer.drawEnemy(f);for(const f of this.powerUps)this.renderer.drawPowerUp(f);const n=this.hurtT>0?"#f87171":"#58a6ff";if(this.renderer.drawPlayer(this.player,n),this.playerName){const f=this.playerName.slice(0,18),c=this.player.x+this.player.width/2;let p=this.player.y-6;p<14&&(p=this.player.y+this.player.height+14),t.save(),t.textAlign="center",t.font="600 12px system-ui",t.lineWidth=3,t.strokeStyle="#00000077",t.strokeText(f,c,p),t.fillStyle="#cdd9e5",t.fillText(f,c,p),t.restore()}for(const f of this.bullets)this.renderer.drawProjectile(f);this.particles.render(t),this.hud.render(t,this.score,void 0,this.player.hp);{const f=[{active:this.rapidT>0,color:"#f7b84a",glyph:"R",rem:this.rapidT,dur:8},{active:this.multishotT>0,color:"#38bdf8",glyph:"M",rem:this.multishotT,dur:8},{active:this.bigshotT>0,color:"#fb7185",glyph:"B",rem:this.bigshotT,dur:8},{active:this.slowmoT>0,color:"#a78bfa",glyph:"⌛",rem:this.slowmoT,dur:3.5},{active:this.magnetT>0,color:"#f472b6",glyph:"U",rem:this.magnetT,dur:8}],p=16+(this.player.hp??0)*18+12;let x=p,m=36;const g=12,u=12,b=3,v=6,_=s.canvas.width-16;for(const M of f){if(!M.active)continue;x+g>_&&(x=p,m+=u+6),t.save(),t.globalAlpha=.95,t.fillStyle=M.color,t.beginPath(),t.roundRect(x,m+2,g,u,b),t.fill();const E=Math.max(0,Math.min(1,M.rem/M.dur));t.strokeStyle="#0f172a",t.lineWidth=1.5,t.beginPath(),t.arc(x+g/2,m+2+u/2,6,-Math.PI/2,-Math.PI/2+E*Math.PI*2),t.stroke(),t.fillStyle="#0f172a",t.font="700 9px system-ui";const I=t.measureText(M.glyph).width;t.fillText(M.glyph,x+(g-I)/2,m+11),t.restore(),x+=g+v}}if(this.pickupBadgeT>0){const f=Math.min(1,this.pickupBadgeT/1.4);t.save(),t.globalAlpha=f*.9;const c=[{label:"Rapid",active:this.rapidT>0,color:"#f7b84a"},{label:"Multi",active:this.multishotT>0,color:"#38bdf8"},{label:"Big",active:this.bigshotT>0,color:"#fb7185"},{label:"Slow",active:this.slowmoT>0,color:"#a78bfa"},{label:"Mag",active:this.magnetT>0,color:"#f472b6"}].filter(m=>m.active);let p=16,x=82;for(const m of c)t.fillStyle="#0f172acc",t.beginPath(),t.roundRect(p,x,86,22,8),t.fill(),t.fillStyle=m.color+"dd",t.beginPath(),t.roundRect(p+2,x+2,82,18,6),t.strokeStyle=m.color+"66",t.lineWidth=2,t.stroke(),t.fillStyle="#e8e8f0",t.font="700 12px system-ui",t.fillText(m.label,p+10,x+15),p+=94;t.restore()}if(this.slowmoT>0){const f=Math.min(.25,.15+this.slowmoT/4*.1);t.save(),t.globalAlpha=f,t.fillStyle="#0b1022",t.fillRect(0,0,s.canvas.width,s.canvas.height),t.restore()}const l=[];if(this.rapidT>0&&l.push({label:"Rapid",t:this.rapidT,d:8,color:"#f7b84a"}),this.multishotT>0&&l.push({label:"Multi",t:this.multishotT,d:8,color:"#38bdf8"}),this.bigshotT>0&&l.push({label:"Big",t:this.bigshotT,d:8,color:"#fb7185"}),this.slowmoT>0&&l.push({label:"Slow",t:this.slowmoT,d:4,color:"#a78bfa"}),this.magnetT>0&&l.push({label:"Mag",t:this.magnetT,d:8,color:"#f472b6"}),l.length){let f=16,c=56;for(const p of l){t.save(),t.globalAlpha=.9,t.fillStyle="#0f172acc",t.beginPath(),t.roundRect(f,c,74,20,8),t.fill();const u=Math.max(0,Math.min(1,p.t/p.d));t.fillStyle=p.color+"aa",t.beginPath(),t.roundRect(f+2,c+20-6,70*u,4,3),t.fill(),t.fillStyle="#e8e8f0",t.font="600 12px system-ui",t.fillText(p.label,f+8,c+14),t.restore(),f+=82}}if(this.comboT>0&&this.combo>1&&(t.save(),t.fillStyle="#ffd166",t.font="700 14px system-ui",t.fillText(`Combo x${this.combo}`,16,46),t.restore()),this.floats.length)for(const f of this.floats){const c=Math.max(0,Math.min(1,f.ttl/.9));t.save(),t.globalAlpha=c,t.fillStyle="#ffd166",t.font="700 18px system-ui",t.fillText(f.text,f.x,f.y),t.restore()}if(this.isTouch){const f=s.canvas.width,c=s.canvas.height,p=Math.max(60,Math.min(120,Math.floor(Math.min(f,c)*.14))),x=24;this.btnRects={left:{x,y:c-p-x,w:p,h:p},right:{x:x+p+16,y:c-p-x,w:p,h:p},shoot:{x:f-p-x,y:c-p-x,w:p,h:p}};const m=(g,u,b)=>{t.save(),t.globalAlpha=.5,t.fillStyle=u?"#58a6ff":"#0f172a",t.strokeStyle="#58a6ff88",t.lineWidth=4,t.beginPath(),t.roundRect(g.x,g.y,g.w,g.h,16),t.fill(),t.stroke(),t.fillStyle="#e8e8f0",t.font="700 28px system-ui";const v=b==="L"?"◀":b==="R"?"▶":"●",_=t.measureText(v).width;t.fillText(v,g.x+(g.w-_)/2,g.y+g.h/2+10),t.restore()};m(this.btnRects.left,this.btnLeftDown,"L"),m(this.btnRects.right,this.btnRightDown,"R"),m(this.btnRects.shoot,this.btnShootDown,"S")}if(this.hintT>0){const f=Math.min(.8,this.hintT/4);t.save(),t.globalAlpha=f,t.fillStyle="#00000088",t.fillRect(20,70,520,56),t.fillStyle="#e8e8f0",t.font="600 16px system-ui",t.fillText("Flap: Space/ArrowUp/W or Click • Move: Arrows or A/D • Shoot: Right Click or Ctrl/J (hold)",28,100),t.restore()}if(t.restore(),this.paused&&(t.fillStyle="#00000088",t.fillRect(0,0,s.canvas.width,s.canvas.height),t.fillStyle="#e8e8f0",t.font="700 28px system-ui",t.fillText("Paused (P). R = Restart, Esc = Title",40,120)),this.gameOver){t.fillStyle="#00000088",t.fillRect(0,0,s.canvas.width,s.canvas.height),t.fillStyle="#e8e8f0",t.font="700 28px system-ui",t.fillText(`Game Over — Score ${this.score}  Best ${this.best}`,40,120),t.font="500 18px system-ui",t.fillText("Press R or tap the restart button",40,160);const f=s.canvas.width,c=s.canvas.height,p=Math.max(64,Math.min(120,Math.floor(Math.min(f,c)*.16))),x=(f-p)/2,m=c*.55;this.restartRect={x,y:m,w:p,h:p},t.save(),t.globalAlpha=.9,t.fillStyle="#0f172a",t.strokeStyle="#58a6ff88",t.lineWidth=5,t.beginPath(),t.roundRect(x,m,p,p,18),t.fill(),t.stroke(),t.fillStyle="#e8e8f0",t.font="700 28px system-ui",t.fillText("⟲",x+p/2-10,m+p/2+12),t.restore()}}};vt.KILL_POINTS=2;let Mt=vt;class Gt{constructor(){this.p1=new _t(80,140,26,26),this.p2=new _t(120,220,26,26),this.obstacles=[],this.hud=new Vt,this.timeToNext=0,this.s1=0,this.s2=0,this.paused=!1,this.speed=140,this.particles=new ge,this.shakeT=0}init(t){this.renderer=new Yt(t.canvas,t.ctx),this.obstacles=[],this.timeToNext=0,this.s1=0,this.s2=0,this.paused=!1,this.speed=140;const s=()=>{G.jump(this.p1),U.flap()};t.canvas.ontouchstart=s,t.canvas.onpointerdown=s}update(t,s){const r=s.canvas.height;if(s.input.wasPressed("KeyP")&&(this.paused=!this.paused),s.input.wasPressed("KeyR")&&this.init(s),this.paused)return;(s.input.wasPressed("Space")||s.input.wasPressed("ArrowUp"))&&(G.jump(this.p1),U.flap(),this.particles.burst(this.p1.x,this.p1.y+this.p1.height,6,"#88ccff88")),s.input.wasPressed("KeyW")&&(G.jump(this.p2),U.flap(),this.particles.burst(this.p2.x,this.p2.y+this.p2.height,6,"#ffb08888"));const n=s.input.getMovementDirection();if(this.p1.vx=n.x*80,this.p2.vx=0,this.p2.vy+=(s.input.isDown("KeyS")?1:0)*300*t,G.applyGravity(this.p1,t),G.applyGravity(this.p2,t),this.p1.update(t),this.p2.update(t),this.p1.y=Math.max(0,Math.min(r-this.p1.height,this.p1.y)),this.p2.y=Math.max(0,Math.min(r-this.p2.height,this.p2.y)),this.timeToNext-=t,this.timeToNext<=0){this.speed=Math.min(260,this.speed+2);const l=Math.max(130,180-Math.max(this.s1,this.s2)*2);this.timeToNext=Math.max(1,1.7-Math.max(this.s1,this.s2)*.02);const f=40,c=r-l-40,p=Math.floor(Math.random()*(c-f+1))+f,x=80,m=s.canvas.width+x;this.obstacles.push(new Z(m,0,x,p,this.speed)),this.obstacles.push(new Z(m,p+l,x,r-(p+l),this.speed))}for(const l of this.obstacles)l.update(t);this.obstacles=this.obstacles.filter(l=>!l.isOffScreen());for(const l of this.obstacles)if(G.checkCollision(this.p1,l)||G.checkCollision(this.p2,l)){U.hit(),this.particles.burst((this.p1.x+this.p2.x)/2,(this.p1.y+this.p2.y)/2,16,"#ff7b72aa"),this.shakeT=.25,this.init(s);return}for(let l=0;l<this.obstacles.length;l+=2){const f=this.obstacles[l],c=f.x+f.width/2;c<this.p1.x&&f.p1c!==!0&&(f.p1c=!0,this.s1+=1,this.p1.passObstacle(),U.score()),c<this.p2.x&&f.p2c!==!0&&(f.p2c=!0,this.s2+=1,this.p2.passObstacle(),U.score())}}render(t,s){const r=this.shakeT>0?(Math.random()-.5)*8:0;t.save(),t.translate(r,r),this.renderer.clear(1/60);for(const n of this.obstacles)this.renderer.drawObstacle(n);this.renderer.drawPlayer(this.p1,"#58a6ff"),this.renderer.drawPlayer(this.p2,"#ff7b72"),this.particles.render(t),this.hud.render(t,this.s1,this.s2),t.restore(),this.paused&&(t.fillStyle="#00000088",t.fillRect(0,0,s.canvas.width,s.canvas.height),t.fillStyle="#e8e8f0",t.font="700 28px system-ui",t.fillText("Paused (P). R = Restart, Esc = Title",40,120))}}class $t extends Error{constructor(t){super(t),this.name="AbortError"}}function Ye(h,t){const{cleanupBeforeAbort:s,abortSignal:r,abortErrorMsg:n}=t??{};return new Promise((l,f)=>{function c(){f(new $t(n??"The operation was aborted."))}function p(){r==null||r.removeEventListener("abort",x)}function x(){s==null||s(),p(),c()}if(r!=null&&r.aborted)return c();try{h(m=>{p(),l(m)},m=>{p(),f(m)})}catch(m){f(m)}r==null||r.addEventListener("abort",x)})}const ze="The delay was aborted.";function At(h,t){let s;const{abortSignal:r,abortErrorMsg:n}={};return Ye(l=>{s=setTimeout(l,h)},{cleanupBeforeAbort:()=>clearTimeout(s),abortSignal:r,abortErrorMsg:n??ze})}function Xe(h){return h&&h.__esModule&&Object.prototype.hasOwnProperty.call(h,"default")?h.default:h}var zt={exports:{}},pt=typeof Reflect=="object"?Reflect:null,ne=pt&&typeof pt.apply=="function"?pt.apply:function(t,s,r){return Function.prototype.apply.call(t,s,r)},kt;pt&&typeof pt.ownKeys=="function"?kt=pt.ownKeys:Object.getOwnPropertySymbols?kt=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:kt=function(t){return Object.getOwnPropertyNames(t)};function Je(h){console&&console.warn&&console.warn(h)}var xe=Number.isNaN||function(t){return t!==t};function A(){A.init.call(this)}zt.exports=A;zt.exports.once=ei;A.EventEmitter=A;A.prototype._events=void 0;A.prototype._eventsCount=0;A.prototype._maxListeners=void 0;var oe=10;function Ct(h){if(typeof h!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof h)}Object.defineProperty(A,"defaultMaxListeners",{enumerable:!0,get:function(){return oe},set:function(h){if(typeof h!="number"||h<0||xe(h))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+h+".");oe=h}});A.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};A.prototype.setMaxListeners=function(t){if(typeof t!="number"||t<0||xe(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function ve(h){return h._maxListeners===void 0?A.defaultMaxListeners:h._maxListeners}A.prototype.getMaxListeners=function(){return ve(this)};A.prototype.emit=function(t){for(var s=[],r=1;r<arguments.length;r++)s.push(arguments[r]);var n=t==="error",l=this._events;if(l!==void 0)n=n&&l.error===void 0;else if(!n)return!1;if(n){var f;if(s.length>0&&(f=s[0]),f instanceof Error)throw f;var c=new Error("Unhandled error."+(f?" ("+f.message+")":""));throw c.context=f,c}var p=l[t];if(p===void 0)return!1;if(typeof p=="function")ne(p,this,s);else for(var x=p.length,m=Te(p,x),r=0;r<x;++r)ne(m[r],this,s);return!0};function _e(h,t,s,r){var n,l,f;if(Ct(s),l=h._events,l===void 0?(l=h._events=Object.create(null),h._eventsCount=0):(l.newListener!==void 0&&(h.emit("newListener",t,s.listener?s.listener:s),l=h._events),f=l[t]),f===void 0)f=l[t]=s,++h._eventsCount;else if(typeof f=="function"?f=l[t]=r?[s,f]:[f,s]:r?f.unshift(s):f.push(s),n=ve(h),n>0&&f.length>n&&!f.warned){f.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+f.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=h,c.type=t,c.count=f.length,Je(c)}return h}A.prototype.addListener=function(t,s){return _e(this,t,s,!1)};A.prototype.on=A.prototype.addListener;A.prototype.prependListener=function(t,s){return _e(this,t,s,!0)};function Ze(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Me(h,t,s){var r={fired:!1,wrapFn:void 0,target:h,type:t,listener:s},n=Ze.bind(r);return n.listener=s,r.wrapFn=n,n}A.prototype.once=function(t,s){return Ct(s),this.on(t,Me(this,t,s)),this};A.prototype.prependOnceListener=function(t,s){return Ct(s),this.prependListener(t,Me(this,t,s)),this};A.prototype.removeListener=function(t,s){var r,n,l,f,c;if(Ct(s),n=this._events,n===void 0)return this;if(r=n[t],r===void 0)return this;if(r===s||r.listener===s)--this._eventsCount===0?this._events=Object.create(null):(delete n[t],n.removeListener&&this.emit("removeListener",t,r.listener||s));else if(typeof r!="function"){for(l=-1,f=r.length-1;f>=0;f--)if(r[f]===s||r[f].listener===s){c=r[f].listener,l=f;break}if(l<0)return this;l===0?r.shift():Qe(r,l),r.length===1&&(n[t]=r[0]),n.removeListener!==void 0&&this.emit("removeListener",t,c||s)}return this};A.prototype.off=A.prototype.removeListener;A.prototype.removeAllListeners=function(t){var s,r,n;if(r=this._events,r===void 0)return this;if(r.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):r[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete r[t]),this;if(arguments.length===0){var l=Object.keys(r),f;for(n=0;n<l.length;++n)f=l[n],f!=="removeListener"&&this.removeAllListeners(f);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(s=r[t],typeof s=="function")this.removeListener(t,s);else if(s!==void 0)for(n=s.length-1;n>=0;n--)this.removeListener(t,s[n]);return this};function Ee(h,t,s){var r=h._events;if(r===void 0)return[];var n=r[t];return n===void 0?[]:typeof n=="function"?s?[n.listener||n]:[n]:s?ti(n):Te(n,n.length)}A.prototype.listeners=function(t){return Ee(this,t,!0)};A.prototype.rawListeners=function(t){return Ee(this,t,!1)};A.listenerCount=function(h,t){return typeof h.listenerCount=="function"?h.listenerCount(t):Se.call(h,t)};A.prototype.listenerCount=Se;function Se(h){var t=this._events;if(t!==void 0){var s=t[h];if(typeof s=="function")return 1;if(s!==void 0)return s.length}return 0}A.prototype.eventNames=function(){return this._eventsCount>0?kt(this._events):[]};function Te(h,t){for(var s=new Array(t),r=0;r<t;++r)s[r]=h[r];return s}function Qe(h,t){for(;t+1<h.length;t++)h[t]=h[t+1];h.pop()}function ti(h){for(var t=new Array(h.length),s=0;s<t.length;++s)t[s]=h[s].listener||h[s];return t}function ei(h,t){return new Promise(function(s,r){function n(f){h.removeListener(t,l),r(f)}function l(){typeof h.removeListener=="function"&&h.removeListener("error",n),s([].slice.call(arguments))}Ie(h,t,l,{once:!0}),t!=="error"&&ii(h,n,{once:!0})})}function ii(h,t,s){typeof h.on=="function"&&Ie(h,"error",t,s)}function Ie(h,t,s,r){if(typeof h.on=="function")r.once?h.once(t,s):h.on(t,s);else if(typeof h.addEventListener=="function")h.addEventListener(t,function n(l){r.once&&h.removeEventListener(t,n),s(l)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof h)}var si=zt.exports;const ri=Xe(si);class Rt extends Error{constructor(t,s){super(t),this.name="SendMessageError",this.ackId=s.ackId,this.errorDetail=s.errorDetail}}function ni(...h){if(h.length>0){const t=String(h[0]);t.includes(":error")?console.error(...h):t.includes(":warning")?console.warn(...h):t.includes(":info")?console.info(...h):t.includes(":verbose")?console.debug(...h):console.debug(...h)}}var ae={};const he=typeof process<"u"&&ae&&ae.DEBUG||void 0;let Re,Wt=[],qt=[];const Bt=[];he&&Xt(he);const ut=Object.assign(h=>Ae(h),{enable:Xt,enabled:Jt,disable:oi,log:ni});function Xt(h){Re=h,Wt=[],qt=[];const t=/\*/g,s=h.split(",").map(r=>r.trim().replace(t,".*?"));for(const r of s)r.startsWith("-")?qt.push(new RegExp(`^${r.substr(1)}$`)):Wt.push(new RegExp(`^${r}$`));for(const r of Bt)r.enabled=Jt(r.namespace)}function Jt(h){if(h.endsWith("*"))return!0;for(const t of qt)if(t.test(h))return!1;for(const t of Wt)if(t.test(h))return!0;return!1}function oi(){const h=Re||"";return Xt(""),h}function Ae(h){const t=Object.assign(s,{enabled:Jt(h),destroy:ai,log:ut.log,namespace:h,extend:hi});function s(...r){t.enabled&&(r.length>0&&(r[0]=`${h} ${r[0]}`),t.log(...r))}return Bt.push(t),t}function ai(){const h=Bt.indexOf(this);return h>=0?(Bt.splice(h,1),!0):!1}function hi(h){const t=Ae(`${this.namespace}:${h}`);return t.log=this.log,t}var ce={};const Kt=["verbose","info","warning","error"],le={verbose:400,info:300,warning:200,error:100};function fe(h,t){t.log=(...s)=>{h.log(...s)}}function ue(h){return Kt.includes(h)}function ke(h){const t=new Set,s=typeof process<"u"&&ce&&ce[h.logLevelEnvVarName]||void 0;let r;const n=ut(h.namespace);n.log=(...m)=>{ut.log(...m)};function l(m){if(m&&!ue(m))throw new Error(`Unknown log level '${m}'. Acceptable values: ${Kt.join(",")}`);r=m;const g=[];for(const u of t)f(u)&&g.push(u.namespace);ut.enable(g.join(","))}s&&(ue(s)?l(s):console.error(`${h.logLevelEnvVarName} set to unknown log level '${s}'; logging is not enabled. Acceptable values: ${Kt.join(", ")}.`));function f(m){return!!(r&&le[m.level]<=le[r])}function c(m,g){const u=Object.assign(m.extend(g),{level:g});if(fe(m,u),f(u)){const b=ut.disable();ut.enable(b+","+u.namespace)}return t.add(u),u}function p(){return r}function x(m){const g=n.extend(m);return fe(n,g),{error:c(g,"error"),warning:c(g,"warning"),info:c(g,"info"),verbose:c(g,"verbose")}}return{setLogLevel:l,getLogLevel:p,createClientLogger:x,logger:n}}ke({logLevelEnvVarName:"TYPESPEC_RUNTIME_LOG_LEVEL",namespace:"typeSpecRuntime"});const ci=ke({logLevelEnvVarName:"AZURE_LOG_LEVEL",namespace:"azure"});function li(h){return ci.createClientLogger(h)}const j=li("web-pubsub-client");var Zt={},Lt={};Lt.byteLength=di;Lt.toByteArray=yi;Lt.fromByteArray=gi;var Q=[],V=[],fi=typeof Uint8Array<"u"?Uint8Array:Array,Nt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var ft=0,ui=Nt.length;ft<ui;++ft)Q[ft]=Nt[ft],V[Nt.charCodeAt(ft)]=ft;V[45]=62;V[95]=63;function Be(h){var t=h.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var s=h.indexOf("=");s===-1&&(s=t);var r=s===t?0:4-s%4;return[s,r]}function di(h){var t=Be(h),s=t[0],r=t[1];return(s+r)*3/4-r}function pi(h,t,s){return(t+s)*3/4-s}function yi(h){var t,s=Be(h),r=s[0],n=s[1],l=new fi(pi(h,r,n)),f=0,c=n>0?r-4:r,p;for(p=0;p<c;p+=4)t=V[h.charCodeAt(p)]<<18|V[h.charCodeAt(p+1)]<<12|V[h.charCodeAt(p+2)]<<6|V[h.charCodeAt(p+3)],l[f++]=t>>16&255,l[f++]=t>>8&255,l[f++]=t&255;return n===2&&(t=V[h.charCodeAt(p)]<<2|V[h.charCodeAt(p+1)]>>4,l[f++]=t&255),n===1&&(t=V[h.charCodeAt(p)]<<10|V[h.charCodeAt(p+1)]<<4|V[h.charCodeAt(p+2)]>>2,l[f++]=t>>8&255,l[f++]=t&255),l}function mi(h){return Q[h>>18&63]+Q[h>>12&63]+Q[h>>6&63]+Q[h&63]}function wi(h,t,s){for(var r,n=[],l=t;l<s;l+=3)r=(h[l]<<16&16711680)+(h[l+1]<<8&65280)+(h[l+2]&255),n.push(mi(r));return n.join("")}function gi(h){for(var t,s=h.length,r=s%3,n=[],l=16383,f=0,c=s-r;f<c;f+=l)n.push(wi(h,f,f+l>c?c:f+l));return r===1?(t=h[s-1],n.push(Q[t>>2]+Q[t<<4&63]+"==")):r===2&&(t=(h[s-2]<<8)+h[s-1],n.push(Q[t>>10]+Q[t>>4&63]+Q[t<<2&63]+"=")),n.join("")}var Qt={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */Qt.read=function(h,t,s,r,n){var l,f,c=n*8-r-1,p=(1<<c)-1,x=p>>1,m=-7,g=s?n-1:0,u=s?-1:1,b=h[t+g];for(g+=u,l=b&(1<<-m)-1,b>>=-m,m+=c;m>0;l=l*256+h[t+g],g+=u,m-=8);for(f=l&(1<<-m)-1,l>>=-m,m+=r;m>0;f=f*256+h[t+g],g+=u,m-=8);if(l===0)l=1-x;else{if(l===p)return f?NaN:(b?-1:1)*(1/0);f=f+Math.pow(2,r),l=l-x}return(b?-1:1)*f*Math.pow(2,l-r)};Qt.write=function(h,t,s,r,n,l){var f,c,p,x=l*8-n-1,m=(1<<x)-1,g=m>>1,u=n===23?Math.pow(2,-24)-Math.pow(2,-77):0,b=r?0:l-1,v=r?1:-1,_=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(c=isNaN(t)?1:0,f=m):(f=Math.floor(Math.log(t)/Math.LN2),t*(p=Math.pow(2,-f))<1&&(f--,p*=2),f+g>=1?t+=u/p:t+=u*Math.pow(2,1-g),t*p>=2&&(f++,p/=2),f+g>=m?(c=0,f=m):f+g>=1?(c=(t*p-1)*Math.pow(2,n),f=f+g):(c=t*Math.pow(2,g-1)*Math.pow(2,n),f=0));n>=8;h[s+b]=c&255,b+=v,c/=256,n-=8);for(f=f<<n|c,x+=n;x>0;h[s+b]=f&255,b+=v,f/=256,x-=8);h[s+b-v]|=_*128};/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(h){const t=Lt,s=Qt,r=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;h.Buffer=c,h.SlowBuffer=I,h.INSPECT_MAX_BYTES=50;const n=2147483647;h.kMaxLength=n,c.TYPED_ARRAY_SUPPORT=l(),!c.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function l(){try{const o=new Uint8Array(1),e={foo:function(){return 42}};return Object.setPrototypeOf(e,Uint8Array.prototype),Object.setPrototypeOf(o,e),o.foo()===42}catch{return!1}}Object.defineProperty(c.prototype,"parent",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.buffer}}),Object.defineProperty(c.prototype,"offset",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.byteOffset}});function f(o){if(o>n)throw new RangeError('The value "'+o+'" is invalid for option "size"');const e=new Uint8Array(o);return Object.setPrototypeOf(e,c.prototype),e}function c(o,e,i){if(typeof o=="number"){if(typeof e=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return g(o)}return p(o,e,i)}c.poolSize=8192;function p(o,e,i){if(typeof o=="string")return u(o,e);if(ArrayBuffer.isView(o))return v(o);if(o==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof o);if(J(o,ArrayBuffer)||o&&J(o.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(J(o,SharedArrayBuffer)||o&&J(o.buffer,SharedArrayBuffer)))return _(o,e,i);if(typeof o=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const a=o.valueOf&&o.valueOf();if(a!=null&&a!==o)return c.from(a,e,i);const d=M(o);if(d)return d;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof o[Symbol.toPrimitive]=="function")return c.from(o[Symbol.toPrimitive]("string"),e,i);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof o)}c.from=function(o,e,i){return p(o,e,i)},Object.setPrototypeOf(c.prototype,Uint8Array.prototype),Object.setPrototypeOf(c,Uint8Array);function x(o){if(typeof o!="number")throw new TypeError('"size" argument must be of type number');if(o<0)throw new RangeError('The value "'+o+'" is invalid for option "size"')}function m(o,e,i){return x(o),o<=0?f(o):e!==void 0?typeof i=="string"?f(o).fill(e,i):f(o).fill(e):f(o)}c.alloc=function(o,e,i){return m(o,e,i)};function g(o){return x(o),f(o<0?0:E(o)|0)}c.allocUnsafe=function(o){return g(o)},c.allocUnsafeSlow=function(o){return g(o)};function u(o,e){if((typeof e!="string"||e==="")&&(e="utf8"),!c.isEncoding(e))throw new TypeError("Unknown encoding: "+e);const i=L(o,e)|0;let a=f(i);const d=a.write(o,e);return d!==i&&(a=a.slice(0,d)),a}function b(o){const e=o.length<0?0:E(o.length)|0,i=f(e);for(let a=0;a<e;a+=1)i[a]=o[a]&255;return i}function v(o){if(J(o,Uint8Array)){const e=new Uint8Array(o);return _(e.buffer,e.byteOffset,e.byteLength)}return b(o)}function _(o,e,i){if(e<0||o.byteLength<e)throw new RangeError('"offset" is outside of buffer bounds');if(o.byteLength<e+(i||0))throw new RangeError('"length" is outside of buffer bounds');let a;return e===void 0&&i===void 0?a=new Uint8Array(o):i===void 0?a=new Uint8Array(o,e):a=new Uint8Array(o,e,i),Object.setPrototypeOf(a,c.prototype),a}function M(o){if(c.isBuffer(o)){const e=E(o.length)|0,i=f(e);return i.length===0||o.copy(i,0,0,e),i}if(o.length!==void 0)return typeof o.length!="number"||Ot(o.length)?f(0):b(o);if(o.type==="Buffer"&&Array.isArray(o.data))return b(o.data)}function E(o){if(o>=n)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+n.toString(16)+" bytes");return o|0}function I(o){return+o!=o&&(o=0),c.alloc(+o)}c.isBuffer=function(e){return e!=null&&e._isBuffer===!0&&e!==c.prototype},c.compare=function(e,i){if(J(e,Uint8Array)&&(e=c.from(e,e.offset,e.byteLength)),J(i,Uint8Array)&&(i=c.from(i,i.offset,i.byteLength)),!c.isBuffer(e)||!c.isBuffer(i))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===i)return 0;let a=e.length,d=i.length;for(let y=0,w=Math.min(a,d);y<w;++y)if(e[y]!==i[y]){a=e[y],d=i[y];break}return a<d?-1:d<a?1:0},c.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(e,i){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(e.length===0)return c.alloc(0);let a;if(i===void 0)for(i=0,a=0;a<e.length;++a)i+=e[a].length;const d=c.allocUnsafe(i);let y=0;for(a=0;a<e.length;++a){let w=e[a];if(J(w,Uint8Array))y+w.length>d.length?(c.isBuffer(w)||(w=c.from(w)),w.copy(d,y)):Uint8Array.prototype.set.call(d,w,y);else if(c.isBuffer(w))w.copy(d,y);else throw new TypeError('"list" argument must be an Array of Buffers');y+=w.length}return d};function L(o,e){if(c.isBuffer(o))return o.length;if(ArrayBuffer.isView(o)||J(o,ArrayBuffer))return o.byteLength;if(typeof o!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof o);const i=o.length,a=arguments.length>2&&arguments[2]===!0;if(!a&&i===0)return 0;let d=!1;for(;;)switch(e){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":return Dt(o).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return i*2;case"hex":return i>>>1;case"base64":return ie(o).length;default:if(d)return a?-1:Dt(o).length;e=(""+e).toLowerCase(),d=!0}}c.byteLength=L;function B(o,e,i){let a=!1;if((e===void 0||e<0)&&(e=0),e>this.length||((i===void 0||i>this.length)&&(i=this.length),i<=0)||(i>>>=0,e>>>=0,i<=e))return"";for(o||(o="utf8");;)switch(o){case"hex":return Ft(this,e,i);case"utf8":case"utf-8":return yt(this,e,i);case"ascii":return Pt(this,e,i);case"latin1":case"binary":return St(this,e,i);case"base64":return it(this,e,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return O(this,e,i);default:if(a)throw new TypeError("Unknown encoding: "+o);o=(o+"").toLowerCase(),a=!0}}c.prototype._isBuffer=!0;function P(o,e,i){const a=o[e];o[e]=o[i],o[i]=a}c.prototype.swap16=function(){const e=this.length;if(e%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let i=0;i<e;i+=2)P(this,i,i+1);return this},c.prototype.swap32=function(){const e=this.length;if(e%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let i=0;i<e;i+=4)P(this,i,i+3),P(this,i+1,i+2);return this},c.prototype.swap64=function(){const e=this.length;if(e%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let i=0;i<e;i+=8)P(this,i,i+7),P(this,i+1,i+6),P(this,i+2,i+5),P(this,i+3,i+4);return this},c.prototype.toString=function(){const e=this.length;return e===0?"":arguments.length===0?yt(this,0,e):B.apply(this,arguments)},c.prototype.toLocaleString=c.prototype.toString,c.prototype.equals=function(e){if(!c.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e?!0:c.compare(this,e)===0},c.prototype.inspect=function(){let e="";const i=h.INSPECT_MAX_BYTES;return e=this.toString("hex",0,i).replace(/(.{2})/g,"$1 ").trim(),this.length>i&&(e+=" ... "),"<Buffer "+e+">"},r&&(c.prototype[r]=c.prototype.inspect),c.prototype.compare=function(e,i,a,d,y){if(J(e,Uint8Array)&&(e=c.from(e,e.offset,e.byteLength)),!c.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(i===void 0&&(i=0),a===void 0&&(a=e?e.length:0),d===void 0&&(d=0),y===void 0&&(y=this.length),i<0||a>e.length||d<0||y>this.length)throw new RangeError("out of range index");if(d>=y&&i>=a)return 0;if(d>=y)return-1;if(i>=a)return 1;if(i>>>=0,a>>>=0,d>>>=0,y>>>=0,this===e)return 0;let w=y-d,S=a-i;const F=Math.min(w,S),C=this.slice(d,y),D=e.slice(i,a);for(let k=0;k<F;++k)if(C[k]!==D[k]){w=C[k],S=D[k];break}return w<S?-1:S<w?1:0};function N(o,e,i,a,d){if(o.length===0)return-1;if(typeof i=="string"?(a=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),i=+i,Ot(i)&&(i=d?0:o.length-1),i<0&&(i=o.length+i),i>=o.length){if(d)return-1;i=o.length-1}else if(i<0)if(d)i=0;else return-1;if(typeof e=="string"&&(e=c.from(e,a)),c.isBuffer(e))return e.length===0?-1:$(o,e,i,a,d);if(typeof e=="number")return e=e&255,typeof Uint8Array.prototype.indexOf=="function"?d?Uint8Array.prototype.indexOf.call(o,e,i):Uint8Array.prototype.lastIndexOf.call(o,e,i):$(o,[e],i,a,d);throw new TypeError("val must be string, number or Buffer")}function $(o,e,i,a,d){let y=1,w=o.length,S=e.length;if(a!==void 0&&(a=String(a).toLowerCase(),a==="ucs2"||a==="ucs-2"||a==="utf16le"||a==="utf-16le")){if(o.length<2||e.length<2)return-1;y=2,w/=2,S/=2,i/=2}function F(D,k){return y===1?D[k]:D.readUInt16BE(k*y)}let C;if(d){let D=-1;for(C=i;C<w;C++)if(F(o,C)===F(e,D===-1?0:C-D)){if(D===-1&&(D=C),C-D+1===S)return D*y}else D!==-1&&(C-=C-D),D=-1}else for(i+S>w&&(i=w-S),C=i;C>=0;C--){let D=!0;for(let k=0;k<S;k++)if(F(o,C+k)!==F(e,k)){D=!1;break}if(D)return C}return-1}c.prototype.includes=function(e,i,a){return this.indexOf(e,i,a)!==-1},c.prototype.indexOf=function(e,i,a){return N(this,e,i,a,!0)},c.prototype.lastIndexOf=function(e,i,a){return N(this,e,i,a,!1)};function K(o,e,i,a){i=Number(i)||0;const d=o.length-i;a?(a=Number(a),a>d&&(a=d)):a=d;const y=e.length;a>y/2&&(a=y/2);let w;for(w=0;w<a;++w){const S=parseInt(e.substr(w*2,2),16);if(Ot(S))return w;o[i+w]=S}return w}function q(o,e,i,a){return It(Dt(e,o.length-i),o,i,a)}function tt(o,e,i,a){return It(De(e),o,i,a)}function rt(o,e,i,a){return It(ie(e),o,i,a)}function et(o,e,i,a){return It(Oe(e,o.length-i),o,i,a)}c.prototype.write=function(e,i,a,d){if(i===void 0)d="utf8",a=this.length,i=0;else if(a===void 0&&typeof i=="string")d=i,a=this.length,i=0;else if(isFinite(i))i=i>>>0,isFinite(a)?(a=a>>>0,d===void 0&&(d="utf8")):(d=a,a=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const y=this.length-i;if((a===void 0||a>y)&&(a=y),e.length>0&&(a<0||i<0)||i>this.length)throw new RangeError("Attempt to write outside buffer bounds");d||(d="utf8");let w=!1;for(;;)switch(d){case"hex":return K(this,e,i,a);case"utf8":case"utf-8":return q(this,e,i,a);case"ascii":case"latin1":case"binary":return tt(this,e,i,a);case"base64":return rt(this,e,i,a);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return et(this,e,i,a);default:if(w)throw new TypeError("Unknown encoding: "+d);d=(""+d).toLowerCase(),w=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function it(o,e,i){return e===0&&i===o.length?t.fromByteArray(o):t.fromByteArray(o.slice(e,i))}function yt(o,e,i){i=Math.min(o.length,i);const a=[];let d=e;for(;d<i;){const y=o[d];let w=null,S=y>239?4:y>223?3:y>191?2:1;if(d+S<=i){let F,C,D,k;switch(S){case 1:y<128&&(w=y);break;case 2:F=o[d+1],(F&192)===128&&(k=(y&31)<<6|F&63,k>127&&(w=k));break;case 3:F=o[d+1],C=o[d+2],(F&192)===128&&(C&192)===128&&(k=(y&15)<<12|(F&63)<<6|C&63,k>2047&&(k<55296||k>57343)&&(w=k));break;case 4:F=o[d+1],C=o[d+2],D=o[d+3],(F&192)===128&&(C&192)===128&&(D&192)===128&&(k=(y&15)<<18|(F&63)<<12|(C&63)<<6|D&63,k>65535&&k<1114112&&(w=k))}}w===null?(w=65533,S=1):w>65535&&(w-=65536,a.push(w>>>10&1023|55296),w=56320|w&1023),a.push(w),d+=S}return nt(a)}const Et=4096;function nt(o){const e=o.length;if(e<=Et)return String.fromCharCode.apply(String,o);let i="",a=0;for(;a<e;)i+=String.fromCharCode.apply(String,o.slice(a,a+=Et));return i}function Pt(o,e,i){let a="";i=Math.min(o.length,i);for(let d=e;d<i;++d)a+=String.fromCharCode(o[d]&127);return a}function St(o,e,i){let a="";i=Math.min(o.length,i);for(let d=e;d<i;++d)a+=String.fromCharCode(o[d]);return a}function Ft(o,e,i){const a=o.length;(!e||e<0)&&(e=0),(!i||i<0||i>a)&&(i=a);let d="";for(let y=e;y<i;++y)d+=Ue[o[y]];return d}function O(o,e,i){const a=o.slice(e,i);let d="";for(let y=0;y<a.length-1;y+=2)d+=String.fromCharCode(a[y]+a[y+1]*256);return d}c.prototype.slice=function(e,i){const a=this.length;e=~~e,i=i===void 0?a:~~i,e<0?(e+=a,e<0&&(e=0)):e>a&&(e=a),i<0?(i+=a,i<0&&(i=0)):i>a&&(i=a),i<e&&(i=e);const d=this.subarray(e,i);return Object.setPrototypeOf(d,c.prototype),d};function T(o,e,i){if(o%1!==0||o<0)throw new RangeError("offset is not uint");if(o+e>i)throw new RangeError("Trying to access beyond buffer length")}c.prototype.readUintLE=c.prototype.readUIntLE=function(e,i,a){e=e>>>0,i=i>>>0,a||T(e,i,this.length);let d=this[e],y=1,w=0;for(;++w<i&&(y*=256);)d+=this[e+w]*y;return d},c.prototype.readUintBE=c.prototype.readUIntBE=function(e,i,a){e=e>>>0,i=i>>>0,a||T(e,i,this.length);let d=this[e+--i],y=1;for(;i>0&&(y*=256);)d+=this[e+--i]*y;return d},c.prototype.readUint8=c.prototype.readUInt8=function(e,i){return e=e>>>0,i||T(e,1,this.length),this[e]},c.prototype.readUint16LE=c.prototype.readUInt16LE=function(e,i){return e=e>>>0,i||T(e,2,this.length),this[e]|this[e+1]<<8},c.prototype.readUint16BE=c.prototype.readUInt16BE=function(e,i){return e=e>>>0,i||T(e,2,this.length),this[e]<<8|this[e+1]},c.prototype.readUint32LE=c.prototype.readUInt32LE=function(e,i){return e=e>>>0,i||T(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+this[e+3]*16777216},c.prototype.readUint32BE=c.prototype.readUInt32BE=function(e,i){return e=e>>>0,i||T(e,4,this.length),this[e]*16777216+(this[e+1]<<16|this[e+2]<<8|this[e+3])},c.prototype.readBigUInt64LE=st(function(e){e=e>>>0,lt(e,"offset");const i=this[e],a=this[e+7];(i===void 0||a===void 0)&&wt(e,this.length-8);const d=i+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24,y=this[++e]+this[++e]*2**8+this[++e]*2**16+a*2**24;return BigInt(d)+(BigInt(y)<<BigInt(32))}),c.prototype.readBigUInt64BE=st(function(e){e=e>>>0,lt(e,"offset");const i=this[e],a=this[e+7];(i===void 0||a===void 0)&&wt(e,this.length-8);const d=i*2**24+this[++e]*2**16+this[++e]*2**8+this[++e],y=this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+a;return(BigInt(d)<<BigInt(32))+BigInt(y)}),c.prototype.readIntLE=function(e,i,a){e=e>>>0,i=i>>>0,a||T(e,i,this.length);let d=this[e],y=1,w=0;for(;++w<i&&(y*=256);)d+=this[e+w]*y;return y*=128,d>=y&&(d-=Math.pow(2,8*i)),d},c.prototype.readIntBE=function(e,i,a){e=e>>>0,i=i>>>0,a||T(e,i,this.length);let d=i,y=1,w=this[e+--d];for(;d>0&&(y*=256);)w+=this[e+--d]*y;return y*=128,w>=y&&(w-=Math.pow(2,8*i)),w},c.prototype.readInt8=function(e,i){return e=e>>>0,i||T(e,1,this.length),this[e]&128?(255-this[e]+1)*-1:this[e]},c.prototype.readInt16LE=function(e,i){e=e>>>0,i||T(e,2,this.length);const a=this[e]|this[e+1]<<8;return a&32768?a|4294901760:a},c.prototype.readInt16BE=function(e,i){e=e>>>0,i||T(e,2,this.length);const a=this[e+1]|this[e]<<8;return a&32768?a|4294901760:a},c.prototype.readInt32LE=function(e,i){return e=e>>>0,i||T(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},c.prototype.readInt32BE=function(e,i){return e=e>>>0,i||T(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},c.prototype.readBigInt64LE=st(function(e){e=e>>>0,lt(e,"offset");const i=this[e],a=this[e+7];(i===void 0||a===void 0)&&wt(e,this.length-8);const d=this[e+4]+this[e+5]*2**8+this[e+6]*2**16+(a<<24);return(BigInt(d)<<BigInt(32))+BigInt(i+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24)}),c.prototype.readBigInt64BE=st(function(e){e=e>>>0,lt(e,"offset");const i=this[e],a=this[e+7];(i===void 0||a===void 0)&&wt(e,this.length-8);const d=(i<<24)+this[++e]*2**16+this[++e]*2**8+this[++e];return(BigInt(d)<<BigInt(32))+BigInt(this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+a)}),c.prototype.readFloatLE=function(e,i){return e=e>>>0,i||T(e,4,this.length),s.read(this,e,!0,23,4)},c.prototype.readFloatBE=function(e,i){return e=e>>>0,i||T(e,4,this.length),s.read(this,e,!1,23,4)},c.prototype.readDoubleLE=function(e,i){return e=e>>>0,i||T(e,8,this.length),s.read(this,e,!0,52,8)},c.prototype.readDoubleBE=function(e,i){return e=e>>>0,i||T(e,8,this.length),s.read(this,e,!1,52,8)};function R(o,e,i,a,d,y){if(!c.isBuffer(o))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>d||e<y)throw new RangeError('"value" argument is out of bounds');if(i+a>o.length)throw new RangeError("Index out of range")}c.prototype.writeUintLE=c.prototype.writeUIntLE=function(e,i,a,d){if(e=+e,i=i>>>0,a=a>>>0,!d){const S=Math.pow(2,8*a)-1;R(this,e,i,a,S,0)}let y=1,w=0;for(this[i]=e&255;++w<a&&(y*=256);)this[i+w]=e/y&255;return i+a},c.prototype.writeUintBE=c.prototype.writeUIntBE=function(e,i,a,d){if(e=+e,i=i>>>0,a=a>>>0,!d){const S=Math.pow(2,8*a)-1;R(this,e,i,a,S,0)}let y=a-1,w=1;for(this[i+y]=e&255;--y>=0&&(w*=256);)this[i+y]=e/w&255;return i+a},c.prototype.writeUint8=c.prototype.writeUInt8=function(e,i,a){return e=+e,i=i>>>0,a||R(this,e,i,1,255,0),this[i]=e&255,i+1},c.prototype.writeUint16LE=c.prototype.writeUInt16LE=function(e,i,a){return e=+e,i=i>>>0,a||R(this,e,i,2,65535,0),this[i]=e&255,this[i+1]=e>>>8,i+2},c.prototype.writeUint16BE=c.prototype.writeUInt16BE=function(e,i,a){return e=+e,i=i>>>0,a||R(this,e,i,2,65535,0),this[i]=e>>>8,this[i+1]=e&255,i+2},c.prototype.writeUint32LE=c.prototype.writeUInt32LE=function(e,i,a){return e=+e,i=i>>>0,a||R(this,e,i,4,4294967295,0),this[i+3]=e>>>24,this[i+2]=e>>>16,this[i+1]=e>>>8,this[i]=e&255,i+4},c.prototype.writeUint32BE=c.prototype.writeUInt32BE=function(e,i,a){return e=+e,i=i>>>0,a||R(this,e,i,4,4294967295,0),this[i]=e>>>24,this[i+1]=e>>>16,this[i+2]=e>>>8,this[i+3]=e&255,i+4};function X(o,e,i,a,d){ee(e,a,d,o,i,7);let y=Number(e&BigInt(4294967295));o[i++]=y,y=y>>8,o[i++]=y,y=y>>8,o[i++]=y,y=y>>8,o[i++]=y;let w=Number(e>>BigInt(32)&BigInt(4294967295));return o[i++]=w,w=w>>8,o[i++]=w,w=w>>8,o[i++]=w,w=w>>8,o[i++]=w,i}function ot(o,e,i,a,d){ee(e,a,d,o,i,7);let y=Number(e&BigInt(4294967295));o[i+7]=y,y=y>>8,o[i+6]=y,y=y>>8,o[i+5]=y,y=y>>8,o[i+4]=y;let w=Number(e>>BigInt(32)&BigInt(4294967295));return o[i+3]=w,w=w>>8,o[i+2]=w,w=w>>8,o[i+1]=w,w=w>>8,o[i]=w,i+8}c.prototype.writeBigUInt64LE=st(function(e,i=0){return X(this,e,i,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeBigUInt64BE=st(function(e,i=0){return ot(this,e,i,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeIntLE=function(e,i,a,d){if(e=+e,i=i>>>0,!d){const F=Math.pow(2,8*a-1);R(this,e,i,a,F-1,-F)}let y=0,w=1,S=0;for(this[i]=e&255;++y<a&&(w*=256);)e<0&&S===0&&this[i+y-1]!==0&&(S=1),this[i+y]=(e/w>>0)-S&255;return i+a},c.prototype.writeIntBE=function(e,i,a,d){if(e=+e,i=i>>>0,!d){const F=Math.pow(2,8*a-1);R(this,e,i,a,F-1,-F)}let y=a-1,w=1,S=0;for(this[i+y]=e&255;--y>=0&&(w*=256);)e<0&&S===0&&this[i+y+1]!==0&&(S=1),this[i+y]=(e/w>>0)-S&255;return i+a},c.prototype.writeInt8=function(e,i,a){return e=+e,i=i>>>0,a||R(this,e,i,1,127,-128),e<0&&(e=255+e+1),this[i]=e&255,i+1},c.prototype.writeInt16LE=function(e,i,a){return e=+e,i=i>>>0,a||R(this,e,i,2,32767,-32768),this[i]=e&255,this[i+1]=e>>>8,i+2},c.prototype.writeInt16BE=function(e,i,a){return e=+e,i=i>>>0,a||R(this,e,i,2,32767,-32768),this[i]=e>>>8,this[i+1]=e&255,i+2},c.prototype.writeInt32LE=function(e,i,a){return e=+e,i=i>>>0,a||R(this,e,i,4,2147483647,-2147483648),this[i]=e&255,this[i+1]=e>>>8,this[i+2]=e>>>16,this[i+3]=e>>>24,i+4},c.prototype.writeInt32BE=function(e,i,a){return e=+e,i=i>>>0,a||R(this,e,i,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[i]=e>>>24,this[i+1]=e>>>16,this[i+2]=e>>>8,this[i+3]=e&255,i+4},c.prototype.writeBigInt64LE=st(function(e,i=0){return X(this,e,i,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),c.prototype.writeBigInt64BE=st(function(e,i=0){return ot(this,e,i,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function mt(o,e,i,a,d,y){if(i+a>o.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function at(o,e,i,a,d){return e=+e,i=i>>>0,d||mt(o,e,i,4),s.write(o,e,i,a,23,4),i+4}c.prototype.writeFloatLE=function(e,i,a){return at(this,e,i,!0,a)},c.prototype.writeFloatBE=function(e,i,a){return at(this,e,i,!1,a)};function ht(o,e,i,a,d){return e=+e,i=i>>>0,d||mt(o,e,i,8),s.write(o,e,i,a,52,8),i+8}c.prototype.writeDoubleLE=function(e,i,a){return ht(this,e,i,!0,a)},c.prototype.writeDoubleBE=function(e,i,a){return ht(this,e,i,!1,a)},c.prototype.copy=function(e,i,a,d){if(!c.isBuffer(e))throw new TypeError("argument should be a Buffer");if(a||(a=0),!d&&d!==0&&(d=this.length),i>=e.length&&(i=e.length),i||(i=0),d>0&&d<a&&(d=a),d===a||e.length===0||this.length===0)return 0;if(i<0)throw new RangeError("targetStart out of bounds");if(a<0||a>=this.length)throw new RangeError("Index out of range");if(d<0)throw new RangeError("sourceEnd out of bounds");d>this.length&&(d=this.length),e.length-i<d-a&&(d=e.length-i+a);const y=d-a;return this===e&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(i,a,d):Uint8Array.prototype.set.call(e,this.subarray(a,d),i),y},c.prototype.fill=function(e,i,a,d){if(typeof e=="string"){if(typeof i=="string"?(d=i,i=0,a=this.length):typeof a=="string"&&(d=a,a=this.length),d!==void 0&&typeof d!="string")throw new TypeError("encoding must be a string");if(typeof d=="string"&&!c.isEncoding(d))throw new TypeError("Unknown encoding: "+d);if(e.length===1){const w=e.charCodeAt(0);(d==="utf8"&&w<128||d==="latin1")&&(e=w)}}else typeof e=="number"?e=e&255:typeof e=="boolean"&&(e=Number(e));if(i<0||this.length<i||this.length<a)throw new RangeError("Out of range index");if(a<=i)return this;i=i>>>0,a=a===void 0?this.length:a>>>0,e||(e=0);let y;if(typeof e=="number")for(y=i;y<a;++y)this[y]=e;else{const w=c.isBuffer(e)?e:c.from(e,d),S=w.length;if(S===0)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(y=0;y<a-i;++y)this[y+i]=w[y%S]}return this};const H={};function ct(o,e,i){H[o]=class extends i{constructor(){super(),Object.defineProperty(this,"message",{value:e.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${o}]`,this.stack,delete this.name}get code(){return o}set code(d){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:d,writable:!0})}toString(){return`${this.name} [${o}]: ${this.message}`}}}ct("ERR_BUFFER_OUT_OF_BOUNDS",function(o){return o?`${o} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),ct("ERR_INVALID_ARG_TYPE",function(o,e){return`The "${o}" argument must be of type number. Received type ${typeof e}`},TypeError),ct("ERR_OUT_OF_RANGE",function(o,e,i){let a=`The value of "${o}" is out of range.`,d=i;return Number.isInteger(i)&&Math.abs(i)>2**32?d=Tt(String(i)):typeof i=="bigint"&&(d=String(i),(i>BigInt(2)**BigInt(32)||i<-(BigInt(2)**BigInt(32)))&&(d=Tt(d)),d+="n"),a+=` It must be ${e}. Received ${d}`,a},RangeError);function Tt(o){let e="",i=o.length;const a=o[0]==="-"?1:0;for(;i>=a+4;i-=3)e=`_${o.slice(i-3,i)}${e}`;return`${o.slice(0,i)}${e}`}function Le(o,e,i){lt(e,"offset"),(o[e]===void 0||o[e+i]===void 0)&&wt(e,o.length-(i+1))}function ee(o,e,i,a,d,y){if(o>i||o<e){const w=typeof e=="bigint"?"n":"";let S;throw e===0||e===BigInt(0)?S=`>= 0${w} and < 2${w} ** ${(y+1)*8}${w}`:S=`>= -(2${w} ** ${(y+1)*8-1}${w}) and < 2 ** ${(y+1)*8-1}${w}`,new H.ERR_OUT_OF_RANGE("value",S,o)}Le(a,d,y)}function lt(o,e){if(typeof o!="number")throw new H.ERR_INVALID_ARG_TYPE(e,"number",o)}function wt(o,e,i){throw Math.floor(o)!==o?(lt(o,i),new H.ERR_OUT_OF_RANGE("offset","an integer",o)):e<0?new H.ERR_BUFFER_OUT_OF_BOUNDS:new H.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${e}`,o)}const Pe=/[^+/0-9A-Za-z-_]/g;function Fe(o){if(o=o.split("=")[0],o=o.trim().replace(Pe,""),o.length<2)return"";for(;o.length%4!==0;)o=o+"=";return o}function Dt(o,e){e=e||1/0;let i;const a=o.length;let d=null;const y=[];for(let w=0;w<a;++w){if(i=o.charCodeAt(w),i>55295&&i<57344){if(!d){if(i>56319){(e-=3)>-1&&y.push(239,191,189);continue}else if(w+1===a){(e-=3)>-1&&y.push(239,191,189);continue}d=i;continue}if(i<56320){(e-=3)>-1&&y.push(239,191,189),d=i;continue}i=(d-55296<<10|i-56320)+65536}else d&&(e-=3)>-1&&y.push(239,191,189);if(d=null,i<128){if((e-=1)<0)break;y.push(i)}else if(i<2048){if((e-=2)<0)break;y.push(i>>6|192,i&63|128)}else if(i<65536){if((e-=3)<0)break;y.push(i>>12|224,i>>6&63|128,i&63|128)}else if(i<1114112){if((e-=4)<0)break;y.push(i>>18|240,i>>12&63|128,i>>6&63|128,i&63|128)}else throw new Error("Invalid code point")}return y}function De(o){const e=[];for(let i=0;i<o.length;++i)e.push(o.charCodeAt(i)&255);return e}function Oe(o,e){let i,a,d;const y=[];for(let w=0;w<o.length&&!((e-=2)<0);++w)i=o.charCodeAt(w),a=i>>8,d=i%256,y.push(d),y.push(a);return y}function ie(o){return t.toByteArray(Fe(o))}function It(o,e,i,a){let d;for(d=0;d<a&&!(d+i>=e.length||d>=o.length);++d)e[d+i]=o[d];return d}function J(o,e){return o instanceof e||o!=null&&o.constructor!=null&&o.constructor.name!=null&&o.constructor.name===e.name}function Ot(o){return o!==o}const Ue=function(){const o="0123456789abcdef",e=new Array(256);for(let i=0;i<16;++i){const a=i*16;for(let d=0;d<16;++d)e[a+d]=o[i]+o[d]}return e}();function st(o){return typeof BigInt>"u"?Ne:o}function Ne(){throw new Error("BigInt not supported")}})(Zt);function bi(h){if(typeof h!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!h)throw new Error("No input");const t=JSON.parse(h),s=t;let r;if(s.type==="system")if(s.event==="connected")r=Object.assign(Object.assign({},t),{kind:"connected"});else if(s.event==="disconnected")r=Object.assign(Object.assign({},t),{kind:"disconnected"});else return null;else if(s.type==="message")if(s.from==="group"){const n=pe(t.data,t.dataType);if(n===null)return null;r=Object.assign(Object.assign({},t),{data:n,kind:"groupData"})}else if(s.from==="server"){const n=pe(t.data,t.dataType);if(n===null)return null;r=Object.assign(Object.assign({},t),{data:n,kind:"serverData"})}else return null;else if(s.type==="ack")r=Object.assign(Object.assign({},t),{kind:"ack"});else return null;return r}function xi(h){let t;switch(h.kind){case"joinGroup":{t={type:"joinGroup",group:h.group,ackId:h.ackId};break}case"leaveGroup":{t={type:"leaveGroup",group:h.group,ackId:h.ackId};break}case"sendEvent":{t={type:"event",event:h.event,ackId:h.ackId,dataType:h.dataType,data:de(h.data,h.dataType)};break}case"sendToGroup":{t={type:"sendToGroup",group:h.group,ackId:h.ackId,dataType:h.dataType,data:de(h.data,h.dataType),noEcho:h.noEcho};break}case"sequenceAck":{t={type:"sequenceAck",sequenceId:h.sequenceId};break}default:throw new Error(`Unsupported type: ${h.kind}`)}return JSON.stringify(t)}function de(h,t){switch(t){case"text":{if(typeof h!="string")throw new TypeError("Message must be a string.");return h}case"json":return h;case"binary":case"protobuf":{if(h instanceof ArrayBuffer)return Zt.Buffer.from(h).toString("base64");throw new TypeError("Message must be a ArrayBuffer")}}}function pe(h,t){if(t==="text"){if(typeof h!="string")throw new TypeError("Message must be a string when dataType is text");return h}else{if(t==="json")return h;if(t==="binary"||t==="protobuf"){const s=Zt.Buffer.from(h,"base64");return s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength)}else return null}}class vi{constructor(){this.isReliableSubProtocol=!0,this.name="json.reliable.webpubsub.azure.v1"}parseMessages(t){return bi(t)}writeMessage(t){return xi(t)}}const _i=()=>new vi;class Mi{constructor(t,s){this._socket=new WebSocket(t,s),this._socket.binaryType="arraybuffer"}onopen(t){this._socket.onopen=t}onclose(t){this._socket.onclose=s=>t(s.code,s.reason)}onerror(t){this._socket.onerror=s=>t(s)}onmessage(t){this._socket.onmessage=s=>t(s.data)}close(t,s){this._socket.close(t,s)}send(t,s){return new Promise((r,n)=>{try{this._socket.send(t),r()}catch(l){n(l)}})}isOpen(){return this._socket.readyState===WebSocket.OPEN}}class Ei{create(t,s){return new Mi(t,s)}}async function Si(h,t){if(t.aborted)throw new $t("The operation was aborted.");let s;const r=new Promise((n,l)=>{s=()=>{l(new $t("The operation was aborted."))},t.addEventListener("abort",s)});try{return await Promise.race([h,r])}finally{t.removeEventListener("abort",s)}}var W;(function(h){h.Stopped="Stopped",h.Disconnected="Disconnected",h.Connecting="Connecting",h.Connected="Connected",h.Recovering="Recovering"})(W||(W={}));class Ti{nextAckId(){return this._ackId=this._ackId+1,this._ackId}constructor(t,s){this._quickSequenceAckDiff=300,this._activeTimeoutInMs=2e4,this._emitter=new ri,this._isStopping=!1,this._isInitialConnected=!1,typeof t=="string"?this._credential={getClientAccessUrl:t}:this._credential=t,s==null&&(s={}),this._buildDefaultOptions(s),this._options=s,this._messageRetryPolicy=new ye(this._options.messageRetryOptions),this._reconnectRetryPolicy=new ye(this._options.reconnectRetryOptions),this._protocol=this._options.protocol,this._groupMap=new Map,this._ackMap=new Map,this._sequenceId=new Ai,this._state=W.Stopped,this._ackId=0}async start(t){if(this._isStopping)throw new Error("Can't start a client during stopping");if(this._state!==W.Stopped)throw new Error("Client can be only started when it's Stopped");let s;t&&(s=t.abortSignal),this._activeKeepaliveTask||(this._activeKeepaliveTask=this._getActiveKeepaliveTask());try{await this._startCore(s)}catch(r){throw this._changeState(W.Stopped),this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0),this._isStopping=!1,r}}async _startFromRestarting(t){if(this._state!==W.Disconnected)throw new Error("Client can be only restarted when it's Disconnected");try{j.verbose("Staring reconnecting."),await this._startCore(t)}catch(s){throw this._changeState(W.Disconnected),s}}async _startCore(t){if(this._changeState(W.Connecting),j.info("Staring a new connection"),this._sequenceId.reset(),this._isInitialConnected=!1,this._lastCloseEvent=void 0,this._lastDisconnectedMessage=void 0,this._connectionId=void 0,this._reconnectionToken=void 0,this._uri=void 0,typeof this._credential.getClientAccessUrl=="string"?this._uri=this._credential.getClientAccessUrl:this._uri=await this._credential.getClientAccessUrl({abortSignal:t}),typeof this._uri!="string")throw new Error(`The clientAccessUrl must be a string but currently it's ${typeof this._uri}`);await this._connectCore(this._uri)}stop(){this._state===W.Stopped||this._isStopping||(this._isStopping=!0,this._wsClient&&this._wsClient.isOpen()?this._wsClient.close():this._isStopping=!1,this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0))}on(t,s){this._emitter.on(t,s)}off(t,s){this._emitter.removeListener(t,s)}_emitEvent(t,s){this._emitter.emit(t,s)}async sendEvent(t,s,r,n){return this._operationExecuteWithRetry(()=>this._sendEventAttempt(t,s,r,n),n==null?void 0:n.abortSignal)}async _sendEventAttempt(t,s,r,n){var l;if(!((l=n==null?void 0:n.fireAndForget)!==null&&l!==void 0?l:!1))return this._sendMessageWithAckId(p=>({kind:"sendEvent",dataType:r,data:s,ackId:p,event:t}),n==null?void 0:n.ackId,n==null?void 0:n.abortSignal);const c={kind:"sendEvent",dataType:r,data:s,event:t};return await this._sendMessage(c,n==null?void 0:n.abortSignal),{isDuplicated:!1}}async joinGroup(t,s){return this._operationExecuteWithRetry(()=>this._joinGroupAttempt(t,s),s==null?void 0:s.abortSignal)}async _joinGroupAttempt(t,s){const r=this._getOrAddGroup(t),n=await this._joinGroupCore(t,s);return r.isJoined=!0,n}async _joinGroupCore(t,s){return this._sendMessageWithAckId(r=>({group:t,ackId:r,kind:"joinGroup"}),s==null?void 0:s.ackId,s==null?void 0:s.abortSignal)}async leaveGroup(t,s){return this._operationExecuteWithRetry(()=>this._leaveGroupAttempt(t,s),s==null?void 0:s.abortSignal)}async _leaveGroupAttempt(t,s){const r=this._getOrAddGroup(t),n=await this._sendMessageWithAckId(l=>({group:t,ackId:l,kind:"leaveGroup"}),s==null?void 0:s.ackId,s==null?void 0:s.abortSignal);return r.isJoined=!1,n}async sendToGroup(t,s,r,n){return this._operationExecuteWithRetry(()=>this._sendToGroupAttempt(t,s,r,n),n==null?void 0:n.abortSignal)}async _sendToGroupAttempt(t,s,r,n){var l,f;const c=(l=n==null?void 0:n.fireAndForget)!==null&&l!==void 0?l:!1,p=(f=n==null?void 0:n.noEcho)!==null&&f!==void 0?f:!1;if(!c)return this._sendMessageWithAckId(m=>({kind:"sendToGroup",group:t,dataType:r,data:s,ackId:m,noEcho:p}),n==null?void 0:n.ackId,n==null?void 0:n.abortSignal);const x={kind:"sendToGroup",group:t,dataType:r,data:s,noEcho:p};return await this._sendMessage(x,n==null?void 0:n.abortSignal),{isDuplicated:!1}}_getWebSocketClientFactory(){return new Ei}async _trySendSequenceAck(){if(!this._protocol.isReliableSubProtocol)return;const[t,s]=this._sequenceId.tryGetSequenceId();if(t&&s!==null&&s!==void 0){const r={kind:"sequenceAck",sequenceId:s};try{await this._sendMessage(r)}catch{this._sequenceId.tryUpdate(s)}}}_connectCore(t){if(this._isStopping)throw new Error("Can't start a client during stopping");return new Promise((s,r)=>{const n=this._wsClient=this._getWebSocketClientFactory().create(t,this._protocol.name);n.onopen(()=>{if(this._isStopping){try{n.close()}catch{}r(new Error("The client is stopped"))}j.verbose("WebSocket connection has opened"),this._changeState(W.Connected),this._protocol.isReliableSubProtocol&&(this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),this._sequenceAckTask=new me(async()=>{await this._trySendSequenceAck()},1e3)),s()}),n.onerror(l=>{this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),r(l)}),n.onclose((l,f)=>{this._state===W.Connected?(j.verbose("WebSocket closed after open"),this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),j.info(`WebSocket connection closed. Code: ${l}, Reason: ${f}`),this._lastCloseEvent={code:l,reason:f},this._handleConnectionClose.call(this)):(j.verbose("WebSocket closed before open"),r(new Error(`Failed to start WebSocket: ${l}`)))}),n.onmessage(l=>{const f=u=>{if(this._ackMap.has(u.ackId)){const b=this._ackMap.get(u.ackId);this._ackMap.delete(u.ackId);const v=u.error!=null&&u.error.name==="Duplicate";u.success||v?b.resolve({ackId:u.ackId,isDuplicated:v}):b.reject(new Rt("Failed to send message.",{ackId:u.ackId,errorDetail:u.error}))}},c=async u=>{if(this._connectionId=u.connectionId,this._reconnectionToken=u.reconnectionToken,!this._isInitialConnected){if(this._isInitialConnected=!0,this._options.autoRejoinGroups){const b=[];this._groupMap.forEach(v=>{v.isJoined&&b.push((async()=>{try{await this._joinGroupCore(v.name)}catch(_){this._safeEmitRejoinGroupFailed(v.name,_)}})())}),await Promise.all(b).catch(()=>{})}this._safeEmitConnected(u.connectionId,u.userId)}},p=u=>{this._lastDisconnectedMessage=u},x=u=>{if(u.sequenceId!=null){const b=this._sequenceId.tryUpdate(u.sequenceId);if(b===0)return;b>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitGroupMessage(u)},m=u=>{if(u.sequenceId!=null){const b=this._sequenceId.tryUpdate(u.sequenceId);if(b===0)return;b>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitServerMessage(u)};let g;try{let u;if(Array.isArray(l)?u=Buffer.concat(l):u=l,g=this._protocol.parseMessages(u),g===null)return}catch(u){throw j.warning("An error occurred while parsing the message from service",u),u}Array.isArray(g)||(g=[g]),g.forEach(u=>{try{switch(u.kind){case"ack":{f(u);break}case"connected":{c(u);break}case"disconnected":{p(u);break}case"groupData":{x(u);break}case"serverData":{m(u);break}}}catch(b){j.warning(`An error occurred while handling the message with kind: ${u.kind} from service`,b)}})})})}async _handleConnectionCloseAndNoRecovery(){this._state=W.Disconnected,this._safeEmitDisconnected(this._connectionId,this._lastDisconnectedMessage),this._options.autoReconnect?await this._autoReconnect():await this._handleConnectionStopped()}async _autoReconnect(){let t=!1,s=0;try{for(;!this._isStopping;)try{await this._startFromRestarting(),t=!0;break}catch(r){j.warning("An attempt to reconnect connection failed.",r),s++;const n=this._reconnectRetryPolicy.nextRetryDelayInMs(s);if(n==null)break;j.verbose(`Delay time for reconnect attempt ${s}: ${n}`),await At(n).catch(()=>{})}}finally{t||this._handleConnectionStopped()}}_handleConnectionStopped(){this._isStopping=!1,this._state=W.Stopped,this._safeEmitStopped()}_getActiveKeepaliveTask(){return new me(async()=>{this._sequenceId.tryUpdate(0)},this._activeTimeoutInMs)}async _sendMessage(t,s){if(!this._wsClient||!this._wsClient.isOpen())throw new Error("The connection is not connected.");const r=this._protocol.writeMessage(t);await this._wsClient.send(r,s)}async _sendMessageWithAckId(t,s,r){s==null&&(s=this.nextAckId());const n=t(s);this._ackMap.has(s)||this._ackMap.set(s,new Ri(s));const l=this._ackMap.get(s);try{await this._sendMessage(n,r)}catch(f){this._ackMap.delete(s);let c="";throw f instanceof Error&&(c=f.message),new Rt(c,{ackId:s})}if(r)try{return await Si(l.promise(),r)}catch(f){throw f instanceof Error&&f.name==="AbortError"?new Rt("Cancelled by abortSignal",{ackId:s}):f}return l.promise()}async _handleConnectionClose(){if(this._ackMap.forEach((n,l)=>{this._ackMap.delete(l)&&n.reject(new Rt("Connection is disconnected before receive ack from the service",{ackId:n.ackId}))}),this._isStopping){j.warning("The client is stopping state. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(this._lastCloseEvent&&this._lastCloseEvent.code===1008){j.warning("The websocket close with status code 1008. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(!this._protocol.isReliableSubProtocol){j.warning("The protocol is not reliable, recovery is not applicable"),this._handleConnectionCloseAndNoRecovery();return}const t=this._buildRecoveryUri();if(!t){j.warning("Connection id or reconnection token is not available"),this._handleConnectionCloseAndNoRecovery();return}let s=!1;this._state=W.Recovering;const r=AbortSignal.timeout(30*1e3);try{for(;!r.aborted||this._isStopping;)try{await this._connectCore.call(this,t),s=!0;return}catch{await At(1e3)}}finally{s||(j.warning("Recovery attempts failed more then 30 seconds or the client is stopping"),this._handleConnectionCloseAndNoRecovery())}}_safeEmitConnected(t,s){this._emitEvent("connected",{connectionId:t,userId:s})}_safeEmitDisconnected(t,s){this._emitEvent("disconnected",{connectionId:t,message:s})}_safeEmitGroupMessage(t){this._emitEvent("group-message",{message:t})}_safeEmitServerMessage(t){this._emitEvent("server-message",{message:t})}_safeEmitStopped(){this._emitEvent("stopped",{})}_safeEmitRejoinGroupFailed(t,s){this._emitEvent("rejoin-group-failed",{group:t,error:s})}_buildDefaultOptions(t){return t.autoReconnect==null&&(t.autoReconnect=!0),t.autoRejoinGroups==null&&(t.autoRejoinGroups=!0),t.protocol==null&&(t.protocol=_i()),this._buildMessageRetryOptions(t),this._buildReconnectRetryOptions(t),t}_buildMessageRetryOptions(t){t.messageRetryOptions||(t.messageRetryOptions={}),(t.messageRetryOptions.maxRetries==null||t.messageRetryOptions.maxRetries<0)&&(t.messageRetryOptions.maxRetries=3),(t.messageRetryOptions.retryDelayInMs==null||t.messageRetryOptions.retryDelayInMs<0)&&(t.messageRetryOptions.retryDelayInMs=1e3),(t.messageRetryOptions.maxRetryDelayInMs==null||t.messageRetryOptions.maxRetryDelayInMs<0)&&(t.messageRetryOptions.maxRetryDelayInMs=3e4),t.messageRetryOptions.mode==null&&(t.messageRetryOptions.mode="Fixed")}_buildReconnectRetryOptions(t){t.reconnectRetryOptions||(t.reconnectRetryOptions={}),(t.reconnectRetryOptions.maxRetries==null||t.reconnectRetryOptions.maxRetries<0)&&(t.reconnectRetryOptions.maxRetries=Number.MAX_VALUE),(t.reconnectRetryOptions.retryDelayInMs==null||t.reconnectRetryOptions.retryDelayInMs<0)&&(t.reconnectRetryOptions.retryDelayInMs=1e3),(t.reconnectRetryOptions.maxRetryDelayInMs==null||t.reconnectRetryOptions.maxRetryDelayInMs<0)&&(t.reconnectRetryOptions.maxRetryDelayInMs=3e4),t.reconnectRetryOptions.mode==null&&(t.reconnectRetryOptions.mode="Fixed")}_buildRecoveryUri(){if(this._connectionId&&this._reconnectionToken&&this._uri){const t=new URL(this._uri);return t.searchParams.append("awps_connection_id",this._connectionId),t.searchParams.append("awps_reconnection_token",this._reconnectionToken),t.toString()}return null}_getOrAddGroup(t){return this._groupMap.has(t)||this._groupMap.set(t,new Ii(t)),this._groupMap.get(t)}_changeState(t){j.verbose(`The client state transfer from ${this._state.toString()} to ${t.toString()}`),this._state=t}async _operationExecuteWithRetry(t,s){let r=0;for(;;)try{return await t.call(this)}catch(n){r++;const l=this._messageRetryPolicy.nextRetryDelayInMs(r);if(l==null||(await At(l),s!=null&&s.aborted))throw n}}}class ye{constructor(t){this._retryOptions=t,this._maxRetriesToGetMaxDelay=Math.ceil(Math.log2(this._retryOptions.maxRetryDelayInMs)-Math.log2(this._retryOptions.retryDelayInMs)+1)}nextRetryDelayInMs(t){return t>this._retryOptions.maxRetries?null:this._retryOptions.mode==="Fixed"?this._retryOptions.retryDelayInMs:this._calculateExponentialDelay(t)}_calculateExponentialDelay(t){return t>=this._maxRetriesToGetMaxDelay?this._retryOptions.maxRetryDelayInMs:(1<<t-1)*this._retryOptions.retryDelayInMs}}class Ii{constructor(t){this.isJoined=!1,this.name=t}}class Ri{constructor(t){this._promise=new Promise((s,r)=>{this._resolve=s,this._reject=r}),this.ackId=t}promise(){return this._promise}resolve(t){this._resolve(t)}reject(t){this._reject(t)}}class Ai{constructor(){this._sequenceId=0,this._isUpdate=!1}tryUpdate(t){if(this._isUpdate=!0,t>this._sequenceId){const s=t-this._sequenceId;return this._sequenceId=t,s}return 0}tryGetSequenceId(){return this._isUpdate?(this._isUpdate=!1,[!0,this._sequenceId]):[!1,null]}reset(){this._sequenceId=0,this._isUpdate=!1}}class me{constructor(t,s,r){this._func=t,this._abortController=new AbortController,this._interval=s,this._obj=r,this._start()}abort(){try{this._abortController.abort()}catch{}}async _start(){const t=this._abortController.signal;for(;!t.aborted;)try{await this._func(this._obj)}catch{}finally{await At(this._interval)}}}class we{constructor(t){this.negotiateUrl=t,this.client=null,this.group=null,this.connected=!1,this.onDisc=[],this.onErr=[],this.mode="azure",this.bc=null,this.onMsgHandler=null,this.id=Math.random().toString(36).slice(2,8)}async connect(t){this.group=`room:${t}`;try{const s=await fetch(this.negotiateUrl,{credentials:"include"});if(!s.ok)throw new Error("negotiate failed");const{url:r}=await s.json();if(!r)throw new Error("no url");const n=new Ti(r);this.client=n,this.mode="azure",n.on("connected",()=>{this.connected=!0}),n.on("disconnected",()=>{this.connected=!1,this.onDisc.forEach(l=>l())}),n.on("stopped",()=>{this.connected=!1,this.onDisc.forEach(l=>l())}),await n.start(),await n.joinGroup(this.group),this.connected=!0}catch(s){try{this.mode="local",this.bc=new BroadcastChannel(this.group),this.bc.onmessage=r=>{var l;const n=r.data;try{(l=this.onMsgHandler)==null||l.call(this,n)}catch{}},this.connected=!0}catch{throw s}}}onMessage(t){var s;this.onMsgHandler=t,this.mode==="azure"&&((s=this.client)==null||s.on("group-message",({message:r})=>{try{t(JSON.parse(String(r.data)))}catch{}}))}onDisconnected(t){this.onDisc.push(t)}onError(t){this.onErr.push(t)}async send(t){if(!(!this.client||!this.connected||!this.group))try{this.mode==="azure"?await this.client.sendToGroup(this.group,JSON.stringify(t),"text"):this.mode==="local"&&this.bc&&this.bc.postMessage(t)}catch(s){this.onErr.forEach(r=>r(s))}}close(){var t;try{(t=this.bc)==null||t.close()}catch{}}}class Ht{constructor(t,s){this.p1=new _t(80,140,26,26),this.p2=new _t(120,220,26,26),this.obstacles=[],this.hud=new Vt,this.s1=0,this.s2=0,this.speed=140,this.timeToNext=0,this.paused=!1,this.rt=null,this.remoteHistory=[],this.sendAccum=0,this.toast=null,this.isLeader=!1,this.remoteId=null,this.reconnecting=!1,this.retries=0,this.unloadHandler=null,this.waiting=!0,this.bothReady=!1,this.roomId=t,this.name=s}async init(t){this.renderer=new Yt(t.canvas,t.ctx);const s="/api/negotiate";this.rt=new we(s);try{await this.rt.connect(this.roomId)}catch{this.toast={text:"Online: failed to connect",t:3};return}const r=this.rt.id;this.toast={text:`Connected • Room ${this.roomId}`,t:2.5},this.rt.send({type:"join",id:r,roomId:this.roomId,name:this.name}),this.rt.onMessage(n=>{if(n.type==="state"&&n.id!==r)this.remoteHistory.push({t:n.t,x:n.x,y:n.y,vy:n.vy,score:n.score,hp:n.hp,name:n.name}),this.remoteHistory.length>30&&this.remoteHistory.shift(),this.remoteName=n.name||this.remoteName;else if(n.type==="spawn"&&this.isLeader===!1){const l=t.canvas.height,f=80,c=t.canvas.width+f,p=n.topH,x=n.gap;this.speed=n.speed,this.obstacles.push(new Z(c,0,f,p,this.speed)),this.obstacles.push(new Z(c,p+x,f,l-(p+x),this.speed))}else n.type==="join"&&n.id!==r?(this.remoteId=n.id,this.remoteName=n.name,this.isLeader=r<n.id,this.toast={text:`${n.name||"Opponent"} joined`,t:2.5},this.bothReady=!0,this.isLeader&&this.waiting&&setTimeout(()=>{var l;(l=this.rt)==null||l.send({type:"start",id:r,roomId:this.roomId,t:performance.now()}),this.waiting=!1},800)):n.type==="start"?this.waiting=!1:n.type==="leave"&&n.id!==r&&(this.toast={text:"Opponent left",t:3},this.waiting=!0,this.bothReady=!1,this.remoteId=null)}),this.rt.onDisconnected(()=>{this.toast={text:"Online: disconnected",t:3},!this.reconnecting&&this.retries<2&&(this.reconnecting=!0,this.retries++,setTimeout(()=>this.reconnect(s),1500))}),this.unloadHandler=n=>{var l;try{(l=this.rt)==null||l.send({type:"leave",id:r,roomId:this.roomId})}catch{}},window.addEventListener("beforeunload",this.unloadHandler)}async reconnect(t){this.rt;const s=this.name;this.rt=new we(t);try{await this.rt.connect(this.roomId);const r=this.rt.id;this.toast={text:"Online: reconnected",t:2.5},this.rt.onMessage(n=>{if(n.type==="state"&&n.id!==r)this.remoteHistory.push({t:n.t,x:n.x,y:n.y,vy:n.vy,score:n.score,hp:n.hp,name:n.name}),this.remoteHistory.length>30&&this.remoteHistory.shift(),this.remoteName=n.name||this.remoteName;else if(n.type==="spawn"&&this.isLeader===!1){const l=this.renderer.canvas.height,f=80,c=this.renderer.canvas.width+f,p=n.topH,x=n.gap;this.speed=n.speed,this.obstacles.push(new Z(c,0,f,p,this.speed)),this.obstacles.push(new Z(c,p+x,f,l-(p+x),this.speed))}else n.type==="join"&&n.id!==r?(this.remoteId=n.id,this.remoteName=n.name,this.isLeader=r<n.id):n.type==="leave"&&n.id!==r&&(this.toast={text:"Opponent left",t:3})}),this.rt.onDisconnected(()=>{this.toast={text:"Online: disconnected",t:3}}),this.rt.send({type:"join",id:this.rt.id,roomId:this.roomId,name:s})}catch{this.toast={text:"Online: reconnection failed",t:3}}finally{this.reconnecting=!1}}update(t,s){var x;if(this.paused||this.waiting)return;(s.input.wasPressed("Space")||s.input.wasPressed("ArrowUp"))&&(G.jump(this.p1),U.flap());const r=s.input.getMovementDirection();this.p1.vx=r.x*80,G.applyGravity(this.p1,t),this.p1.update(t);const n=s.canvas.height;if(this.p1.y=Math.max(0,Math.min(n-this.p1.height,this.p1.y)),this.rt){this.sendAccum+=t;const m=1/25;if(this.sendAccum>=m){this.sendAccum=0;const g={type:"state",id:this.rt.id,t:performance.now(),x:this.p1.x,y:this.p1.y,vy:this.p1.vy,score:this.s1,hp:this.p1.hp,name:this.name};this.rt.send(g)}}const f=performance.now()-100;for(;this.remoteHistory.length>=2&&this.remoteHistory[1].t<=f;)this.remoteHistory.shift();const c=this.remoteHistory[0],p=this.remoteHistory[1];if(c&&p){const m=(f-c.t)/Math.max(1,p.t-c.t),g=(u,b,v)=>u+(b-u)*Math.max(0,Math.min(1,v));this.p2.x=g(c.x,p.x,m),this.p2.y=g(c.y,p.y,m),this.p2.vy=g(c.vy,p.vy,m),this.s2=Math.max(c.score,p.score)}else c&&(this.p2.x=c.x,this.p2.y=c.y,this.p2.vy=c.vy,this.s2=c.score);if(this.timeToNext-=t,this.timeToNext<=0){this.speed=Math.min(260,this.speed+2);const m=Math.max(130,180-Math.max(this.s1,this.s2)*2);this.timeToNext=Math.max(1,1.7-Math.max(this.s1,this.s2)*.02);const g=40,u=n-m-40,b=Math.floor(Math.random()*(u-g+1))+g,v=80,_=s.canvas.width+v;this.isLeader&&(this.obstacles.push(new Z(_,0,v,b,this.speed)),this.obstacles.push(new Z(_,b+m,v,n-(b+m),this.speed)),(x=this.rt)==null||x.send({type:"spawn",id:this.rt.id,t:performance.now(),w:v,gap:m,topH:b,speed:this.speed}))}for(const m of this.obstacles)m.update(t);this.obstacles=this.obstacles.filter(m=>!m.isOffScreen())}render(t,s){if(this.renderer.clear(1/60),this.waiting){t.fillStyle="#e8e8f0",t.font="700 24px system-ui";const n=this.bothReady?"Found opponent! Starting…":`Waiting in room ${this.roomId}…`,l=t.measureText(n).width;t.fillText(n,Math.max(20,(s.canvas.width-l)/2),120),t.font="600 14px system-ui",t.fillStyle="#94a3b8";const f="Share the code with your friend. Game starts when they join.",c=t.measureText(f).width;t.fillText(f,Math.max(20,(s.canvas.width-c)/2),150)}this.renderer.drawPlayer(this.p1,"#58a6ff"),this.renderer.drawPlayer(this.p2,"#ff7b72");for(const n of this.obstacles)this.renderer.drawObstacle(n);this.hud.render(t,this.s1,this.s2),t.fillStyle="#cdd9e5",t.font="700 12px system-ui",this.name&&t.fillText(this.name,this.p1.x,Math.max(12,this.p1.y-6)),this.remoteName&&t.fillText(this.remoteName,this.p2.x,Math.max(12,this.p2.y-6)),t.fillStyle="#94a3b8",t.font="600 12px system-ui";const r=this.isLeader?"Leader":"Follower";if(t.fillText(`Online • Room ${this.roomId} • ${r}`,16,s.canvas.height-8),this.toast){this.toast.t-=1/60,t.save(),t.globalAlpha=Math.max(0,Math.min(1,this.toast.t/3)),t.fillStyle="#000000aa";const n=this.toast.text;t.font="700 16px system-ui";const l=t.measureText(n).width+20;t.fillRect(20,20,l,34),t.fillStyle="#e8e8f0",t.fillText(n,30,42),t.restore(),this.toast.t<=0&&(this.toast=null)}}}class ki{constructor(){this.t=0,this.btnS=null,this.btnV=null,this.btnVO=null,this.btnEditName=null}onResize(t){t.ctx.setTransform(1,0,0,1,0,0)}init(t){t.canvas.focus();let s=!1;const r=()=>{t.canvas.onpointerdown=null,t.canvas.ontouchstart=null,t.canvas.onclick=null,document.removeEventListener("touchstart",x),document.removeEventListener("pointerdown",p),document.removeEventListener("click",m)},n=(g,u=!1)=>{if(!s)if(s=!0,r(),g&&u){const b=Y.getPlayerName()||"Anon",v=typeof window<"u"&&window.prompt("Your name",b)||b;Y.setPlayerName(v);const _=Math.random().toString(36).slice(2,6),M=typeof window<"u"&&window.prompt("Room code (share with friend)",_)||_;t.setScene(new Ht(M,v))}else t.setScene(g?new Gt:new Mt)},l=g=>{if(this.btnS||this.btnV||this.btnEditName){const u=t.canvas.getBoundingClientRect(),b=t.canvas.width/u.width,v=t.canvas.height/u.height,_=(g.clientX-u.left)*b,M=(g.clientY-u.top)*v;if(this.btnS&&_>=this.btnS.x&&_<=this.btnS.x+this.btnS.w&&M>=this.btnS.y&&M<=this.btnS.y+this.btnS.h)return n(!1);if(this.btnV&&_>=this.btnV.x&&_<=this.btnV.x+this.btnV.w&&M>=this.btnV.y&&M<=this.btnV.y+this.btnV.h)return n(!0);if(this.btnVO&&_>=this.btnVO.x&&_<=this.btnVO.x+this.btnVO.w&&M>=this.btnVO.y&&M<=this.btnVO.y+this.btnVO.h)return n(!0,!0);if(this.btnEditName&&_>=this.btnEditName.x&&_<=this.btnEditName.x+this.btnEditName.w&&M>=this.btnEditName.y&&M<=this.btnEditName.y+this.btnEditName.h){try{const E=Y.getPlayerName()||"Anon",I=typeof window<"u"?window.prompt("Your name",E):null;I!=null&&Y.setPlayerName(I)}catch{}return}}n(!1)},f=g=>{var b;const u=((b=g.touches)==null?void 0:b.length)??0;n(u>=2)},c=g=>n(!1),p=g=>n(!1),x=g=>{var b;const u=((b=g.touches)==null?void 0:b.length)??0;n(u>=2)},m=g=>n(!1);t.canvas.onpointerdown=l,t.canvas.ontouchstart=f,t.canvas.onclick=c,document.addEventListener("pointerdown",p,{passive:!0}),document.addEventListener("touchstart",x,{passive:!0}),document.addEventListener("click",m,{passive:!0})}update(t,s){if(this.t+=t,s.input.wasPressed("KeyS")&&s.setScene(new Mt),s.input.wasPressed("KeyV")&&s.setScene(new Gt),s.input.wasPressed("KeyO")){const O=Y.getPlayerName()||"Anon",T=typeof window<"u"&&window.prompt("Your name",O)||O;Y.setPlayerName(T);const R=Math.random().toString(36).slice(2,6),X=typeof window<"u"&&window.prompt("Room code (share with friend)",R)||R;s.setScene(new Ht(X,T))}s.input.wasPressed("KeyM")&&(U.muted=!U.muted),s.input.wasPressed("KeyR")&&z.toggleReducedMotion(),s.input.wasPressed("KeyC")&&Y.clear();const{ctx:r}=s,n=s.canvas.width,l=s.canvas.height,f=r.createLinearGradient(0,0,0,l);f.addColorStop(0,"#0b1023"),f.addColorStop(1,"#1a2247"),r.fillStyle=f,r.fillRect(0,0,n,l),r.save(),r.globalAlpha=.2;for(let O=0;O<60;O++){const T=O*91%n,R=O*53%l;r.fillStyle=O%2?"#d0e0ff":"#a0b8ff",r.fillRect(T,R+(Math.sin(this.t+O)*2+2)|0,2,2)}r.restore();const c=Math.sin(this.t*2)*6;r.textBaseline="top";const p="CrappBird";r.font="900 72px system-ui, ui-sans-serif, -apple-system, Segoe UI";const x=r.measureText(p).width,m=Math.max(24,(n-x)/2),g=56+c,u=r.createLinearGradient(m,g,m,g+72);u.addColorStop(0,"#e6f0ff"),u.addColorStop(1,"#9cc9ff"),r.save(),r.shadowColor="#3b82f6aa",r.shadowBlur=18,r.fillStyle=u,r.fillText(p,m,g),r.restore(),r.strokeStyle="#58a6ff",r.lineWidth=5,r.beginPath(),r.moveTo(m,g+72+6),r.lineTo(m+Math.min(520,x*.65),g+72+6),r.stroke(),r.save();const b=r.createRadialGradient(n/2,l/2,Math.min(n,l)*.2,n/2,l/2,Math.max(n,l)*.6);b.addColorStop(0,"rgba(0,0,0,0)"),b.addColorStop(1,"rgba(0,0,0,0.35)"),r.fillStyle=b,r.fillRect(0,0,n,l),r.restore();const v=Math.min(560,n-64),_=170,M=(n-v)/2;r.fillStyle="#0f172ae6",r.beginPath(),r.roundRect(M,_,v,150,14),r.fill(),r.fillStyle="#cdd9e5",r.font="700 22px system-ui",r.fillText("Play",M+16,_+16);const E=180,I=44,L=18,B=M+16,P=_+56,N=(O,T,R)=>{r.fillStyle="#15223f",r.strokeStyle="#58a6ffaa",r.lineWidth=3,r.beginPath(),r.roundRect(O,T,E,I,10),r.fill(),r.stroke(),r.fillStyle="#e8e8f0",r.font="600 18px system-ui",r.fillText(R,O+14,T+28)};N(B,P,"S — Singleplayer"),N(B+E+L,P,"V — Versus (Local)"),N(B+(E+L)*2,P,"O — Versus (Online)"),this.btnS={x:B,y:P,w:E,h:I},this.btnV={x:B+E+L,y:P,w:E,h:I},this.btnVO={x:B+(E+L)*2,y:P,w:E,h:I};const $=_+170,K=Math.min(760,n-64),q=(n-K)/2;r.fillStyle="#0f172acc",r.beginPath(),r.roundRect(q,$,K,160,14),r.fill(),r.fillStyle="#cdd9e5",r.font="700 20px system-ui",r.fillText("Controls",q+16,$+16),r.font="500 16px system-ui";let tt=$+46;r.fillText("Singleplayer: Flap = Space/ArrowUp/W or Click/Tap • Move = ArrowLeft/Right or A/D • Shoot = Right Click or Ctrl/J (hold)",q+16,tt),tt+=28,r.fillText("Versus (Local): P1 = Arrows + Space • P2 = W (flap), S (nudge down)",q+16,tt),tt+=28,r.fillText(`Online: O — enter room code and share it • Mute = M (${U.muted?"Muted":"Sound on"}) • Reduced motion = R (${z.reducedMotion?"On":"Off"}) • Esc returns here`,q+16,tt);const rt=$+170,et=Math.min(760,n-64),it=(n-et)/2;r.fillStyle="#0f172acc",r.beginPath(),r.roundRect(it,rt,et,130,14),r.fill(),r.fillStyle="#cdd9e5",r.font="700 20px system-ui",r.fillText("Power-ups",it+16,rt+16),r.font="500 14px system-ui";let yt=rt+44;const Et=[["+ Heal","gain 1 heart"],["R Rapid","shorter cooldown"],["S Shield","+1 max heart and heal"],["M Multishot","fires 3 bullets"],["B Bigshot","bigger bullets, +1 dmg"],["⌛ Slowmo","world slows briefly"],["U Magnet","pulls pickups nearby"]];for(const[O,T]of Et)r.fillText(`${O} — ${T}`,it+16,yt),yt+=20;const nt=Y.getTop(5);if(nt.length){const O=Math.min(420,n-40),T=28+nt.length*22+20,R=(n-O)/2,X=l-T-80;r.fillStyle="#0f172acc",r.beginPath(),r.roundRect(R,X,O,T,10),r.fill(),r.fillStyle="#cdd9e5",r.font="700 16px system-ui",r.fillText("Top Scores",R+12,X+20),r.font="500 14px system-ui";for(let H=0;H<nt.length;H++){const ct=nt[H],Tt=`${H+1}. ${(ct.name||"Anon").slice(0,18)} — ${ct.score}`;r.fillText(Tt,R+12,X+44+H*22)}r.font="400 12px system-ui",r.fillStyle="#94a3b8",r.fillText("Press C to clear • Name is saved locally",R+12,X+T-10);const ot=92,mt=22,at=R+O-ot-10,ht=X+10;r.fillStyle="#15223f",r.strokeStyle="#58a6ff88",r.lineWidth=2,r.beginPath(),r.roundRect(at,ht,ot,mt,6),r.fill(),r.stroke(),r.fillStyle="#e8e8f0",r.font="600 12px system-ui",r.fillText("Edit name",at+12,ht+15),this.btnEditName={x:at,y:ht,w:ot,h:mt}}const Pt=.5+.5*Math.sin(this.t*3);r.save(),r.globalAlpha=.6+.4*Pt,r.fillStyle="#7dd3fc",r.font="700 18px system-ui";const St="Tap to start • Starts easy, ramps up • Two-finger tap for Versus (S/V)",Ft=r.measureText(St).width;r.fillText(St,Math.max(20,(n-Ft)/2),l-60),r.restore()}render(){}}const te=document.getElementById("gameCanvas");te.style.width="100vw";te.style.height="100vh";const gt=new Ge(te);let Ce="title";const bt=h=>{switch(Ce=h,h){case"title":gt.setScene(new ki);break;case"single":gt.setScene(new Mt);break;case"versus":gt.setScene(new Gt);break;case"versusOnline":{const t="Anon",s="test";gt.setScene(new Ht(s,t));break}}};bt("title");window.addEventListener("keydown",h=>{Ce==="title"?(h.code==="KeyS"&&bt("single"),h.code==="KeyV"&&bt("versus"),h.code==="KeyO"&&bt("versusOnline")):h.code==="Escape"&&bt("title")});window.addEventListener("resize",()=>gt.resizeToDisplay());
