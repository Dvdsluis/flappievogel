(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const h of r)if(h.type==="childList")for(const f of h.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&s(f)}).observe(document,{childList:!0,subtree:!0});function i(r){const h={};return r.integrity&&(h.integrity=r.integrity),r.referrerPolicy&&(h.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?h.credentials="include":r.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function s(r){if(r.ep)return;r.ep=!0;const h=i(r);fetch(r.href,h)}})();class We{constructor(){this.down=new Set,this.pressedThisFrame=new Set,window.addEventListener("keydown",t=>{this.down.has(t.code)||this.pressedThisFrame.add(t.code),this.down.add(t.code),["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","KeyW","KeyA","KeyS","KeyD"].includes(t.code)&&t.preventDefault()},{passive:!1}),window.addEventListener("keyup",t=>this.down.delete(t.code))}beginFrame(){this.pressedThisFrame.clear()}endFrame(){}isDown(t){return this.down.has(t)}wasPressed(t){return this.pressedThisFrame.has(t)}getMovementDirection(){return{x:(this.isDown("ArrowRight")?1:0)+(this.isDown("ArrowLeft")?-1:0),y:(this.isDown("ArrowDown")?1:0)+(this.isDown("ArrowUp")?-1:0)}}getWASDHorizontal(){return(this.isDown("KeyD")?1:0)+(this.isDown("KeyA")?-1:0)}}class He{constructor(t){this.lastTime=0,this.running=!1,this.scene=null,this.loop=s=>{if(!this.running||!this.scene)return;const r=Math.min(1/30,(s-this.lastTime)/1e3);this.lastTime=s,this.input.beginFrame(),this.scene.update(r,this),this.scene.render(this.ctx,this),this.input.endFrame(),requestAnimationFrame(this.loop)},this.canvas=t;const i=t.getContext("2d");if(!i)throw new Error("2D context not available");this.ctx=i,this.input=new We,this.resizeToDisplay()}resizeToDisplay(){var h,f;const t=Math.max(1,Math.min(window.devicePixelRatio||1,2)),i=this.canvas.getBoundingClientRect(),s=Math.floor(i.width*t)||800,r=Math.floor(i.height*t)||600;(this.canvas.width!==s||this.canvas.height!==r)&&(this.canvas.width=s,this.canvas.height=r),this.ctx.setTransform(1,0,0,1,0,0),(f=(h=this.scene)==null?void 0:h.onResize)==null||f.call(h,this)}setScene(t){this.scene=t,t.init(this),this.running||(this.running=!0,this.lastTime=performance.now(),requestAnimationFrame(this.loop))}}class At{constructor(t=50,i=50,s=28,r=28,h){this.vx=0,this.vy=0,this._score=0,this.hp=3,this.maxHp=3,this.fireCooldown=0,this.x=t,this.y=i,this.width=s,this.height=r}setPosition(t,i){this.x=t,this.y=i}passObstacle(){this._score+=1}update(t){this.x+=this.vx*t,this.y+=this.vy*t,this.fireCooldown>0&&(this.fireCooldown=Math.max(0,this.fireCooldown-t))}get score(){return Math.max(0,this._score)}set score(t){this._score=Math.max(0,t)}}class rt{constructor(t,i,s,r,h=120){this.x=t,this.y=i,this.width=s,this.height=r,this.speed=h}update(t){this.x-=this.speed*t}isOffScreen(){return this.x+this.width<0}}class ie{render(t,i,s,r,h){t.fillStyle="#e8e8f0",t.font="700 20px system-ui, sans-serif",typeof s=="number"?t.fillText(`P1: ${i}   P2: ${s}`,16,24):t.fillText(`Score: ${i}`,16,24);const f=(a,p,b)=>{if(b!=null)for(let w=0;w<b;w++){t.fillStyle="#ff7b72",t.beginPath();const g=w*18;t.moveTo(a+g+6,p+10),t.arc(a+g+3,p+8,3,0,Math.PI),t.arc(a+g+9,p+8,3,0,Math.PI),t.lineTo(a+g+6,p+14),t.closePath(),t.fill()}};f(16,36,r),h!=null&&f(120,36,h)}renderStatus(t,i,s,r,h){if(typeof r=="number"){const f=Math.max(0,Math.min(1,r)),a=120,p=6;t.fillStyle="#334155",t.fillRect(i,s,a,p),t.fillStyle="#facc15",t.fillRect(i,s,a*(1-f),p),t.strokeStyle="#0f172a",t.strokeRect(i-.5,s-.5,a+1,p+1)}if(h&&h.length){let f=0;for(const a of h){const p=a.remain?`${a.label} ${Math.ceil(a.remain)}`:a.label;t.font="700 10px system-ui, sans-serif";const b=t.measureText(p).width,w=6,g=6;t.fillStyle=a.color||"#94a3b8",t.beginPath(),t.roundRect(i+f,s+10,b+w*2,16,g),t.fill(),t.fillStyle="#0f172a",t.fillText(p,i+f+w,s+10+12),f+=b+w*2+6}}}}const bt=class bt{static applyGravity(t,i){t.vy+=bt.gravity*i}static jump(t){t.vy=bt.jumpVelocity}static checkCollision(t,i){return!(t.x+t.width<i.x||t.x>i.x+i.width||t.y+t.height<i.y||t.y>i.y+i.height)}};bt.gravity=900,bt.jumpVelocity=-300;let W=bt;class se{constructor(t,i){this.canvas=t,this.ctx=i,this.t=0,this.cloudOffset=0}clear(t=0){const{ctx:i}=this,s=this.canvas.width,r=this.canvas.height;this.t+=t,this.cloudOffset=(this.cloudOffset+t*20)%(s+200);const h=i.createLinearGradient(0,0,0,r);h.addColorStop(0,"#0f1630"),h.addColorStop(1,"#0b1022"),i.fillStyle=h,i.fillRect(0,0,s,r);const f=(a,p,b)=>{i.fillStyle="#ffffff14",i.beginPath(),i.roundRect(a,p,120*b,40*b,20*b),i.fill()};for(let a=0;a<4;a++){const p=s-(this.cloudOffset+a*180)%(s+200),b=40+a*45%(r*.5);f(p,b,1)}i.fillStyle="#1a2446",i.fillRect(0,r-20,s,20),i.fillStyle="#111a36";for(let a=0;a<s;a+=16)i.fillRect(a,r-22,8,2)}drawBird(t,i){const{ctx:s}=this,r=Math.min(t.width,t.height)/2,h=t.x+r,f=t.y+r,a=Math.sin(this.t*10)*.6;s.fillStyle=i,s.beginPath(),s.arc(h,f,r,0,Math.PI*2),s.fill(),s.fillStyle="#ffffff88",s.beginPath(),s.arc(h-r*.2,f+r*.1,r*.7,Math.PI*.1,Math.PI*1.2),s.fill(),s.save(),s.translate(h-r*.2,f),s.rotate(-.8+a),s.fillStyle="#00000022",s.beginPath(),s.ellipse(0,0,r*.9,r*.5,0,0,Math.PI*2),s.fill(),s.restore(),s.fillStyle="#ffd166",s.beginPath(),s.moveTo(h+r*.9,f),s.lineTo(h+r*1.4,f-r*.2),s.lineTo(h+r*.9,f+r*.2),s.closePath(),s.fill(),s.fillStyle="#fff",s.beginPath(),s.arc(h+r*.2,f-r*.3,r*.22,0,Math.PI*2),s.fill(),s.fillStyle="#000",s.beginPath(),s.arc(h+r*.25,f-r*.3,r*.1,0,Math.PI*2),s.fill()}drawPlayer(t,i="#58a6ff"){this.drawBird(t,i)}drawObstacle(t){const{ctx:i}=this,s=i.createLinearGradient(t.x,t.y,t.x+t.width,t.y);s.addColorStop(0,"#2bc072"),s.addColorStop(1,"#3be688"),i.fillStyle=s,i.fillRect(t.x,t.y,t.width,t.height),i.fillStyle="#ffffff18",i.fillRect(t.x+6,t.y,6,t.height)}drawHUD(t){this.ctx.fillStyle="#e8e8f0",this.ctx.font="700 24px system-ui, sans-serif",this.ctx.fillText(t,16,32)}drawProjectile(t,i="#ffd166"){const{ctx:s}=this;s.fillStyle=t.color||i,s.fillRect(t.x,t.y,t.width,t.height)}drawEnemy(t){const{ctx:i}=this,s=t.variant||"drone";s==="tank"?(i.fillStyle="#c65353",i.beginPath(),i.roundRect(t.x,t.y,t.width,t.height,4),i.fill(),i.fillStyle="#00000055",i.fillRect(t.x+3,t.y+t.height-6,t.width-6,4)):s==="bee"?(i.fillStyle="#ffd166",i.beginPath(),i.ellipse(t.x+t.width/2,t.y+t.height/2,t.width/2,t.height/2,0,0,Math.PI*2),i.fill(),i.fillStyle="#00000066",i.fillRect(t.x+4,t.y+4,t.width-8,4),i.fillRect(t.x+4,t.y+10,t.width-8,4)):s==="kamikaze"?(i.fillStyle="#ff7b72",i.beginPath(),i.ellipse(t.x+t.width/2,t.y+t.height/2,t.width/2,t.height/2,0,0,Math.PI*2),i.fill(),i.fillStyle="#ffffffaa",i.beginPath(),i.arc(t.x+t.width/2+3,t.y+t.height/2-2,3,0,Math.PI*2),i.fill()):(i.fillStyle="#ff7b72",i.beginPath(),i.ellipse(t.x+t.width/2,t.y+t.height/2,t.width/2,t.height/2,0,0,Math.PI*2),i.fill(),i.fillStyle="#00000055",i.fillRect(t.x+2,t.y+2,t.width-4,3))}drawPowerUp(t){const{ctx:i}=this,s={heal:"#7ee787",rapid:"#f7b84a",shield:"#8b8efb",multishot:"#38bdf8",bigshot:"#fb7185",slowmo:"#a78bfa",magnet:"#f472b6"};i.fillStyle=s[t.type]||"#f7b84a",i.beginPath(),i.roundRect(t.x,t.y,t.width,t.height,4),i.fill(),i.fillStyle="#0f172a",i.font="700 10px system-ui";const r=t.x+t.width/2,h=t.y+t.height/2+3,a={heal:"+",rapid:"R",shield:"S",multishot:"M",bigshot:"B",slowmo:"⌛",magnet:"U"}[t.type]||"?",p=i.measureText(a).width;i.fillText(a,r-p/2,h)}}class qe{constructor(){this.ctx=null,this._muted=!1}get muted(){return this._muted}set muted(t){this._muted=t;try{localStorage.setItem("mute",t?"1":"0")}catch{}}ensure(){this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext))}beep(t,i=.08,s="sine",r=.05){if(this._muted)return;this.ensure();const h=this.ctx,f=h.createOscillator(),a=h.createGain();f.type=s,f.frequency.value=t,a.gain.value=r,f.connect(a).connect(h.destination);const p=h.currentTime;f.start(p),f.stop(p+i)}flap(){this.beep(660,.05,"square",.05)}score(){this.beep(880,.08,"triangle",.06)}hit(){this.beep(120,.15,"sawtooth",.08)}combo(t){if(this._muted)return;const i=900+Math.min(4,t)*80;this.beep(i,.05,"triangle",.05)}}const P=new qe;try{P.muted=localStorage.getItem("mute")==="1"}catch{}class $t{constructor(){this.pool=[],this.active=[]}spawn(t,i,s){const r=this.pool.pop()||{x:t,y:i,vx:0,vy:0,life:.5,maxLife:.5,size:3,color:"#fff"};r.x=t,r.y=i,r.vx=(s==null?void 0:s.vx)??Math.random()*80-40,r.vy=(s==null?void 0:s.vy)??Math.random()*-80,r.life=(s==null?void 0:s.life)??.5,r.maxLife=r.life,r.size=(s==null?void 0:s.size)??3,r.color=(s==null?void 0:s.color)??"#ffffff88",r.g=(s==null?void 0:s.g)??200,this.active.push(r)}burst(t,i,s,r){for(let h=0;h<s;h++)this.spawn(t,i,{color:r,size:2+Math.random()*2,life:.4+Math.random()*.3})}update(t){for(let i=this.active.length-1;i>=0;i--){const s=this.active[i];s.vy+=(s.g||0)*t,s.x+=s.vx*t,s.y+=s.vy*t,s.life-=t,s.life<=0&&(this.pool.push(s),this.active.splice(i,1))}}render(t){for(const i of this.active){const s=Math.max(0,i.life/i.maxLife);t.fillStyle=i.color.replace(/\d?\.?\d*\)$/,"")||i.color,t.globalAlpha=s,t.beginPath(),t.arc(i.x,i.y,i.size,0,Math.PI*2),t.fill(),t.globalAlpha=1}}}function Ke(c){return c===2?"shoot":"flap"}class Vt{constructor(t,i,s,r,h="player"){this.width=10,this.height=4,this.active=!0,this.damage=1,this.x=t,this.y=i,this.vx=s,this.vy=r,this.owner=h}update(t){this.x+=this.vx*t,this.y+=this.vy*t}isOffScreen(t,i){return this.x>t+20||this.x+this.width<-20||this.y>i+20||this.y+this.height<-20}}class Ve{constructor(t,i,s=-120,r=0,h="drone"){this.x=t,this.y=i,this.vx=s,this.vy=r,this.variant=h,h==="tank"?(this.width=34,this.height=26,this.health=3):(this.width=24,this.height=18,this.health=1)}update(t){this.x+=this.vx*t,this.y+=this.vy*t}isOffScreen(){return this.x+this.width<-40}}class Yt{constructor(t,i,s){this.width=16,this.height=16,this.vx=-80,this.vy=0,this.x=t,this.y=i,this.type=s}update(t){this.x+=this.vx*t,this.y+=this.vy*t}isOffScreen(){return this.x+this.width<-40}}const Te="scores:v1",qt="playerName";function fe(){try{const c=localStorage.getItem(Te);if(!c)return[];const t=JSON.parse(c);return Array.isArray(t)?t.map(i=>({score:Number(i.score)||0,date:Number(i.date)||Date.now(),name:typeof i.name=="string"?i.name:void 0})).filter(i=>i.score>=0&&Number.isFinite(i.date)):[]}catch{return[]}}function ue(c){try{localStorage.setItem(Te,JSON.stringify(c))}catch{}}const et={addScore(c,t=Date.now(),i){const s=fe(),r=(i??localStorage.getItem(qt)??"Anon").toString().slice(0,18).trim()||"Anon";s.push({score:Math.max(0,Math.floor(c)),date:t,name:r}),s.sort((f,a)=>a.score-f.score||a.date-f.date);const h=s.slice(0,10);ue(h)},getTop(c=5){const t=fe();return t.sort((i,s)=>s.score-i.score||s.date-i.date),t.slice(0,c)},clear(){ue([])},getPlayerName(){try{return localStorage.getItem(qt)}catch{return null}},setPlayerName(c){try{localStorage.setItem(qt,(c||"").toString().slice(0,18).trim()||"Anon")}catch{}}},It=class It{constructor(){var t;this._reducedMotion=!1,this._usingSystemPreference=!0;try{const i=localStorage.getItem(It.STORAGE_KEY);if(i!=null)this._reducedMotion=i==="1",this._usingSystemPreference=!1;else if(typeof window<"u"&&"matchMedia"in window){const s=window.matchMedia("(prefers-reduced-motion: reduce)");this._reducedMotion=s.matches,this._usingSystemPreference=!0;try{(t=s.addEventListener)==null||t.call(s,"change",r=>{this._usingSystemPreference&&(this._reducedMotion=r.matches)})}catch{}}}catch{}}get reducedMotion(){return this._reducedMotion}set reducedMotion(t){this._reducedMotion=t,this._usingSystemPreference=!1;try{localStorage.setItem(It.STORAGE_KEY,t?"1":"0")}catch{}}toggleReducedMotion(){this.reducedMotion=!this.reducedMotion}};It.STORAGE_KEY="reducedMotion";let zt=It;const it=new zt,Ye={heal:{color:"#7ee787",glyph:"+",label:"Heal",description:"Gain 1 heart"},shield:{color:"#8b8efb",glyph:"S",label:"Shield",description:"+1 max heart and heal"},rapid:{color:"#f7b84a",glyph:"R",label:"Rapid",description:"Shorter cooldown",duration:8,cooldownMul:.55},multishot:{color:"#38bdf8",glyph:"M",label:"Multi",description:"Fires 3 bullets",duration:8},bigshot:{color:"#fb7185",glyph:"B",label:"Big",description:"Bigger bullets, +1 dmg",duration:8},slowmo:{color:"#a78bfa",glyph:"⌛",label:"Slow",description:"World slows briefly",duration:3.5},magnet:{color:"#f472b6",glyph:"U",label:"Mag",description:"Pulls pickups nearby",duration:8}};function Ie(c,t=Math.random){let i={heal:2.2,shield:1.6,rapid:1.2,multishot:1,bigshot:.9,slowmo:.9,magnet:1};if(c<5)i.multishot*=.3,i.bigshot*=.3,i.slowmo*=.4,i.magnet*=.5,i.heal*=1.3,i.shield*=1.2;else if(c<15){const f=(c-5)/10;i.multishot*=.3+.7*f,i.bigshot*=.3+.7*f,i.slowmo*=.4+.6*f,i.magnet*=.5+.5*f}else i.rapid*=1.1,i.multishot*=1.15,i.bigshot*=1.1;const s=Object.entries(i).filter(([f,a])=>a>0),r=s.reduce((f,[,a])=>f+a,0);let h=t()*r;for(const[f,a]of s)if(h-=a,h<=0)return f;return s[s.length-1][0]}const Rt=class Rt{constructor(){this.player=new At(80,150,26,26),this.obstacles=[],this.hud=new ie,this.timeToNext=0,this.score=0,this.best=0,this.gameOver=!1,this.paused=!1,this.speed=120,this.particles=new $t,this.shakeT=0,this.hintT=4,this.bullets=[],this.enemies=[],this.powerUps=[],this.enemyTimer=0,this.powerTimer=5,this.lastGapCenter=null,this.floats=[],this.playerName=null,this.hurtT=0,this.combo=0,this.comboT=0,this.ended=!1,this.multishotT=0,this.bigshotT=0,this.slowmoT=0,this.magnetT=0,this.rapidT=0,this.pickupBadgeT=0,this.mobileMoveX=0,this.isTouch="ontouchstart"in window,this.btnLeftDown=!1,this.btnRightDown=!1,this.btnShootDown=!1,this.btnRects=null,this.restartRect=null}init(t){this.renderer=new se(t.canvas,t.ctx),this.obstacles=[],this.score=0,this.timeToNext=0,this.gameOver=!1,this.paused=!1,this.speed=120,this.player.x=80,this.player.y=Math.max(0,(t.canvas.height-this.player.height)*.5),this.player.vx=0,this.player.vy=0,this.player.hp=this.player.maxHp=3,this.player.fireCooldown=0,this.bullets=[],this.enemies=[],this.powerUps=[],this.enemyTimer=2.5,this.powerTimer=5,this.hintT=4,this.shakeT=0,this.floats=[],this.lastGapCenter=null,this.ended=!1,this.btnLeftDown=this.btnRightDown=this.btnShootDown=!1,this.restartRect=null,this.multishotT=0,this.bigshotT=0,this.slowmoT=0,this.magnetT=0,this.rapidT=0;const i=()=>{const p=t.canvas.width,b=t.canvas.height,w=Math.max(60,Math.min(120,Math.floor(Math.min(p,b)*.14))),g=24;this.btnRects={left:{x:g,y:b-w-g,w,h:w},right:{x:g+w+16,y:b-w-g,w,h:w},shoot:{x:p-w-g,y:b-w-g,w,h:w}}},s=()=>{const p=t.canvas.width,b=t.canvas.height,w=Math.max(64,Math.min(120,Math.floor(Math.min(p,b)*.16)));this.restartRect={x:(p-w)/2,y:b*.55,w,h:w}},r=(p,b,w)=>{if(!this.btnRects)return!1;const g=this.btnRects[p];return b>=g.x&&b<=g.x+g.w&&w>=g.y&&w<=g.y+g.h},h=p=>{i(),this.btnLeftDown=this.btnRightDown=this.btnShootDown=!1;const b=t.canvas.getBoundingClientRect(),w=t.canvas.width/b.width,g=t.canvas.height/b.height;for(let u=0;u<p.touches.length;u++){const m=p.touches.item(u),_=(m.clientX-b.left)*w,M=(m.clientY-b.top)*g;r("left",_,M)?this.btnLeftDown=!0:r("right",_,M)?this.btnRightDown=!0:r("shoot",_,M)&&(this.btnShootDown=!0)}},f=p=>{var g;if(this.gameOver){if(p.touches!==void 0){s();const u=p,m=t.canvas.getBoundingClientRect(),_=t.canvas.width/m.width,M=t.canvas.height/m.height;for(let E=0;E<u.touches.length;E++){const v=u.touches.item(E),S=(v.clientX-m.left)*_,T=(v.clientY-m.top)*M,I=this.restartRect;if(S>=I.x&&S<=I.x+I.w&&T>=I.y&&T<=I.y+I.h){this.init(t);return}}}else{s();const u=this.restartRect,m=p,_=t.canvas.getBoundingClientRect(),M=t.canvas.width/_.width,E=t.canvas.height/_.height,v=(m.clientX-_.left)*M,S=(m.clientY-_.top)*E;if(v>=u.x&&v<=u.x+u.w&&S>=u.y&&S<=u.y+u.h){this.init(t);return}}return}if(p.touches!==void 0){const u=p;if(h(u),this.btnLeftDown||this.btnRightDown||this.btnShootDown){this.btnShootDown&&this.fireWeapon();return}const m=t.canvas.width,_=t.canvas.height,M=t.canvas.getBoundingClientRect(),E=m/M.width,v=_/M.height;let S=!1;for(let I=0;I<u.touches.length;I++){const R=u.touches.item(I),k=(R.clientX-M.left)*E,H=(R.clientY-M.top)*v;if(k>m*.7&&H>_*.6){S=!0;break}}if(S){this.fireWeapon();return}(((g=u.touches)==null?void 0:g.length)??0)>=2?this.fireWeapon():(W.jump(this.player),P.flap(),this.particles.burst(this.player.x+this.player.width*.2,this.player.y+this.player.height,it.reducedMotion?4:8,"#88ccff88"));return}const b=p.button??0,w=Ke(b);w==="flap"?(W.jump(this.player),P.flap()):w==="shoot"&&this.fireWeapon()};t.canvas.oncontextmenu=p=>{p.preventDefault()},t.canvas.onpointerdown=f;const a=p=>{const b=t.canvas.getBoundingClientRect();let w=0,g=0;for(let u=0;u<p.touches.length;u++){const _=p.touches.item(u).clientX-b.left;_<b.width*.45?w=1:_>b.width*.55&&(g=1)}this.mobileMoveX=g-w};t.canvas.ontouchstart=p=>{a(p),f(p)},t.canvas.ontouchmove=p=>{a(p),h(p)},t.canvas.ontouchend=p=>{a(p),h(p)};try{const p=localStorage.getItem("best");p&&(this.best=parseInt(p,10)||0)}catch{}try{this.playerName=et.getPlayerName()}catch{this.playerName=null}document.addEventListener("visibilitychange",()=>{document.hidden&&(this.paused=!0)})}fireWeapon(){if(this.player.fireCooldown>0)return;const t=this.player.x+this.player.width,i=this.player.y+this.player.height*.5-2,s=h=>{const a=Math.cos(h)*360,p=Math.sin(h)*360,b=new Vt(t,i,a,p,"player");return this.bigshotT>0&&(b.width=14,b.damage=2,b.color="#ffa6a6"),b};this.multishotT>0?(this.bullets.push(s(0-.13)),this.bullets.push(s(0)),this.bullets.push(s(0+.13))):this.bullets.push(s(0));let r=this.bigshotT>0?.22:this.multishotT>0?.2:.18;this.rapidT>0&&(r=Math.max(.08,r*.55)),this.player.fireCooldown=r,P.beep(980,.05,"square",.05)}update(t,i){var w,g;const s=i.canvas.height;if(i.input.wasPressed("KeyP")&&(this.paused=!this.paused),i.input.wasPressed("KeyR")&&this.init(i),this.paused)return;const r=this.slowmoT>0?.7:1,h=t*r;(i.input.wasPressed("Space")||i.input.wasPressed("ArrowUp")||i.input.wasPressed("KeyW"))&&(W.jump(this.player),P.flap(),this.particles.burst(this.player.x+this.player.width*.2,this.player.y+this.player.height,it.reducedMotion?4:8,"#88ccff88")),(i.input.isDown("KeyJ")||i.input.isDown("ControlLeft")||i.input.isDown("ControlRight")||this.btnShootDown)&&this.fireWeapon();const f=i.input.getMovementDirection(),a=((g=(w=i.input).getWASDHorizontal)==null?void 0:g.call(w))??(i.input.isDown("KeyD")?1:0)+(i.input.isDown("KeyA")?-1:0),p=(this.btnRightDown?1:0)-(this.btnLeftDown?1:0);if(this.player.vx=(f.x+a+this.mobileMoveX+p)*80,W.applyGravity(this.player,h),this.player.update(h),this.player.y=Math.max(0,Math.min(s-this.player.height,this.player.y)),this.timeToNext-=h,this.timeToNext<=0){const u=Math.min(1,this.score/30);this.speed=Math.min(280,120+u*140);const m=Math.max(150,230-this.score*2.2);this.timeToNext=Math.max(1.1,1.8-this.score*.02);const _=m,M=60,E=M+_/2,v=s-M-_/2,S=this.lastGapCenter??s/2,T=140+Math.min(100,this.score*2),I=Math.max(E,S-T),R=Math.min(v,S+T),k=I<=R?I+Math.random()*(R-I):Math.min(v,Math.max(E,S)),H=Math.floor(k-_/2);this.lastGapCenter=k;const L=80,D=i.canvas.width+L;this.obstacles.push(new rt(D,0,L,H,this.speed)),this.obstacles.push(new rt(D,H+_,L,s-(H+_),this.speed))}for(const u of this.obstacles)u.update(h);this.obstacles=this.obstacles.filter(u=>!u.isOffScreen());for(const u of this.obstacles)W.checkCollision(this.player,u)&&(this.player.hp-=1,P.hit(),this.particles.burst(this.player.x+this.player.width/2,this.player.y+this.player.height/2,it.reducedMotion?6:12,"#ff7b72aa"),this.shakeT=it.reducedMotion?0:.2,this.hurtT=.35,this.combo=0,this.comboT=0,this.player.x-=10,this.player.hp<=0&&this.finalizeGameOver());for(let u=0;u<this.obstacles.length;u+=2){const m=this.obstacles[u],_=m.x+m.width/2;!this.gameOver&&_<this.player.x&&m.counted!==!0&&(m.counted=!0,this.score+=1,this.player.passObstacle(),P.score())}if(this.enemyTimer-=h,this.enemyTimer<=0){let u=40,m=s-40;if(this.obstacles.length>=2){let L=0,D=-1/0;for(let X=0;X<this.obstacles.length-1;X+=2){const st=this.obstacles[X];st.x>D&&(D=st.x,L=X)}const ht=this.obstacles[L],J=this.obstacles[L+1];u=ht.height,m=J.y}const _=12,M=Math.max(0,u+_),E=Math.min(s-20,m-_-18),v=i.canvas.width+40,S=M<E?M+(E-M)*(.35+Math.random()*.3):40+Math.random()*(s-120);let T="drone";this.score>6&&Math.random()<.5&&(T="bee"),this.score>15&&Math.random()<.35&&(T="tank"),this.score>25&&Math.random()<.25&&(T="kamikaze");const R=-((T==="tank"?90:120)+Math.random()*60+this.score*1.2),k=new Ve(v,S,R,0,T);k.minY=isFinite(M)?M:20,k.maxY=isFinite(E)?E:s-40,k.phase=Math.random()*Math.PI*2,this.enemies.push(k);const H=2.4-Math.min(1.2,this.score*.03);this.enemyTimer=Math.max(.8,H+(T==="tank"?.3:0))}if(this.powerTimer-=h,this.powerTimer<=0){const u=Ie(this.score);this.powerUps.push(new Yt(i.canvas.width+20,80+Math.random()*(s-160),u)),this.powerTimer=8+Math.random()*6}for(const u of this.bullets)u.update(h);for(const u of this.enemies){const m=(u.phase??0)+performance.now()/1e3;if(u.variant==="kamikaze"){const v=this.player.y-6-u.y;u.vy=Math.max(-120,Math.min(120,v*2))}else u.variant==="bee"?u.vy=Math.sin(m*1.5)*55:u.variant==="tank"?u.vy=Math.sin(m*.6)*24:u.vy=Math.sin(m)*35;u.update(h);const _=u.minY??20,M=u.maxY??s-40;u.y<_&&(u.y=_),u.y+u.height>M&&(u.y=M-u.height)}for(const u of this.powerUps){if(this.magnetT>0){const m=this.player.x+this.player.width/2,_=this.player.y+this.player.height/2,M=m-(u.x+u.width/2),E=_-(u.y+u.height/2);M*M+E*E<200*200&&(u.vx+=Math.sign(M)*20,u.vy+=Math.sign(E)*20,!it.reducedMotion&&Math.random()<.25&&this.particles.burst(u.x+u.width/2,u.y+u.height/2,1,"#f472b6aa"))}u.update(h)}this.bullets=this.bullets.filter(u=>!u.isOffScreen(i.canvas.width,s)&&u.active),this.enemies=this.enemies.filter(u=>!u.isOffScreen()),this.powerUps=this.powerUps.filter(u=>!u.isOffScreen());const b=(u,m,_,M,E,v,S,T)=>u<E+S&&u+_>E&&m<v+T&&m+M>v;for(const u of this.bullets)for(const m of this.enemies)if(u.active&&b(u.x,u.y,u.width,u.height,m.x,m.y,m.width,m.height)&&(u.active=!1,m.health-=u.damage??1,this.particles.burst(m.x+m.width/2,m.y+m.height/2,it.reducedMotion?6:10,"#ffd166aa"),m.health<=0)){const _=m.x+m.width/2,M=m.y+m.height/2;this.particles.burst(_,M,it.reducedMotion?10:22,"#ffb347aa"),this.particles.burst(_,M,it.reducedMotion?8:14,"#ff7b72aa"),m.x=-9999;const E=m.variant==="tank"?Rt.KILL_POINTS+1:Rt.KILL_POINTS,v=2.2;this.comboT>0?this.combo++:this.combo=1,this.comboT=v;const S=Math.max(0,this.combo-1);this.score+=E+S,this.floats.push({x:_,y:M,text:`+${E}`,ttl:.9,vy:-32}),S>0&&(this.floats.push({x:_+14,y:M-18,text:`x${this.combo}`,ttl:.8,vy:-26}),P.combo(this.combo)),this.shakeT=it.reducedMotion?0:Math.max(this.shakeT,.12),P.score()}this.enemies=this.enemies.filter(u=>u.x>-9e3);for(const u of this.enemies)b(this.player.x,this.player.y,this.player.width,this.player.height,u.x,u.y,u.width,u.height)&&(this.player.hp-=1,P.hit(),this.particles.burst(u.x+u.width/2,u.y+u.height/2,10,"#ff7b72aa"),u.x=-9999,this.player.hp<=0&&this.finalizeGameOver());for(const u of this.powerUps)b(this.player.x,this.player.y,this.player.width,this.player.height,u.x,u.y,u.width,u.height)&&(u.type==="heal"&&(this.player.hp=Math.min(this.player.maxHp,this.player.hp+1)),u.type==="rapid"&&(this.rapidT=Math.max(this.rapidT,8)),u.type==="shield"&&(this.player.maxHp=Math.min(5,this.player.maxHp+1),this.player.hp=Math.min(this.player.maxHp,this.player.hp+1)),u.type==="multishot"&&(this.multishotT=Math.max(this.multishotT,8)),u.type==="bigshot"&&(this.bigshotT=Math.max(this.bigshotT,8)),u.type==="slowmo"&&(this.slowmoT=Math.max(this.slowmoT,3.5)),u.type==="magnet"&&(this.magnetT=Math.max(this.magnetT,8)),this.particles.burst(u.x+u.width/2,u.y+u.height/2,14,"#7ee787aa"),u.x=-9999,this.pickupBadgeT=1.4);this.particles.update(h),this.shakeT=Math.max(0,this.shakeT-t),this.hurtT=Math.max(0,this.hurtT-t),this.comboT>0&&(this.comboT=Math.max(0,this.comboT-t)),this.slowmoT=Math.max(0,this.slowmoT-t),this.multishotT=Math.max(0,this.multishotT-t),this.bigshotT=Math.max(0,this.bigshotT-t),this.magnetT=Math.max(0,this.magnetT-t),this.rapidT=Math.max(0,this.rapidT-t);for(const u of this.floats)u.ttl-=t,u.y+=u.vy*t;this.floats=this.floats.filter(u=>u.ttl>0),this.hintT=Math.max(0,this.hintT-t)}finalizeGameOver(){if(this.ended)return;this.ended=!0,this.gameOver=!0,this.best=Math.max(this.best,this.score);try{localStorage.setItem("best",String(this.best))}catch{}let t=et.getPlayerName()||"";try{const i=typeof window<"u"?window.prompt("Name for high score?",t||"Anon"):null;i!=null&&(t=i,et.setPlayerName(t))}catch{}et.addScore(this.score,Date.now(),t),this.playerName=t}render(t,i){const s=this.shakeT>0?(Math.random()-.5)*8:0;t.save(),t.translate(s,s),this.renderer.clear(1/60);for(const f of this.obstacles)this.renderer.drawObstacle(f);for(const f of this.enemies)this.renderer.drawEnemy(f);for(const f of this.powerUps)this.renderer.drawPowerUp(f);const r=this.hurtT>0?"#f87171":"#58a6ff";if(this.renderer.drawPlayer(this.player,r),this.playerName){const f=this.playerName.slice(0,18),a=this.player.x+this.player.width/2;let p=this.player.y-6;p<14&&(p=this.player.y+this.player.height+14),t.save(),t.textAlign="center",t.font="600 12px system-ui",t.lineWidth=3,t.strokeStyle="#00000077",t.strokeText(f,a,p),t.fillStyle="#cdd9e5",t.fillText(f,a,p),t.restore()}for(const f of this.bullets)this.renderer.drawProjectile(f);this.particles.render(t),this.hud.render(t,this.score,void 0,this.player.hp);{const f=[{active:this.rapidT>0,color:"#f7b84a",glyph:"R",rem:this.rapidT,dur:8},{active:this.multishotT>0,color:"#38bdf8",glyph:"M",rem:this.multishotT,dur:8},{active:this.bigshotT>0,color:"#fb7185",glyph:"B",rem:this.bigshotT,dur:8},{active:this.slowmoT>0,color:"#a78bfa",glyph:"⌛",rem:this.slowmoT,dur:3.5},{active:this.magnetT>0,color:"#f472b6",glyph:"U",rem:this.magnetT,dur:8}],p=16+(this.player.hp??0)*18+12;let b=p,w=36;const g=12,u=12,m=3,_=6,M=i.canvas.width-16;for(const E of f){if(!E.active)continue;b+g>M&&(b=p,w+=u+6),t.save(),t.globalAlpha=.95,t.fillStyle=E.color,t.beginPath(),t.roundRect(b,w+2,g,u,m),t.fill();const v=Math.max(0,Math.min(1,E.rem/E.dur));t.strokeStyle="#0f172a",t.lineWidth=1.5,t.beginPath(),t.arc(b+g/2,w+2+u/2,6,-Math.PI/2,-Math.PI/2+v*Math.PI*2),t.stroke(),t.fillStyle="#0f172a",t.font="700 9px system-ui";const S=t.measureText(E.glyph).width;t.fillText(E.glyph,b+(g-S)/2,w+11),t.restore(),b+=g+_}}if(this.pickupBadgeT>0){const f=Math.min(1,this.pickupBadgeT/1.4);t.save(),t.globalAlpha=f*.9;const a=[{label:"Rapid",active:this.rapidT>0,color:"#f7b84a"},{label:"Multi",active:this.multishotT>0,color:"#38bdf8"},{label:"Big",active:this.bigshotT>0,color:"#fb7185"},{label:"Slow",active:this.slowmoT>0,color:"#a78bfa"},{label:"Mag",active:this.magnetT>0,color:"#f472b6"}].filter(w=>w.active);let p=16,b=82;for(const w of a)t.fillStyle="#0f172acc",t.beginPath(),t.roundRect(p,b,86,22,8),t.fill(),t.fillStyle=w.color+"dd",t.beginPath(),t.roundRect(p+2,b+2,82,18,6),t.strokeStyle=w.color+"66",t.lineWidth=2,t.stroke(),t.fillStyle="#e8e8f0",t.font="700 12px system-ui",t.fillText(w.label,p+10,b+15),p+=94;t.restore()}if(this.slowmoT>0){const f=Math.min(.25,.15+this.slowmoT/4*.1);t.save(),t.globalAlpha=f,t.fillStyle="#0b1022",t.fillRect(0,0,i.canvas.width,i.canvas.height),t.restore()}const h=[];if(this.rapidT>0&&h.push({label:"Rapid",t:this.rapidT,d:8,color:"#f7b84a"}),this.multishotT>0&&h.push({label:"Multi",t:this.multishotT,d:8,color:"#38bdf8"}),this.bigshotT>0&&h.push({label:"Big",t:this.bigshotT,d:8,color:"#fb7185"}),this.slowmoT>0&&h.push({label:"Slow",t:this.slowmoT,d:4,color:"#a78bfa"}),this.magnetT>0&&h.push({label:"Mag",t:this.magnetT,d:8,color:"#f472b6"}),h.length){let f=16,a=56;for(const p of h){t.save(),t.globalAlpha=.9,t.fillStyle="#0f172acc",t.beginPath(),t.roundRect(f,a,74,20,8),t.fill();const u=Math.max(0,Math.min(1,p.t/p.d));t.fillStyle=p.color+"aa",t.beginPath(),t.roundRect(f+2,a+20-6,70*u,4,3),t.fill(),t.fillStyle="#e8e8f0",t.font="600 12px system-ui",t.fillText(p.label,f+8,a+14),t.restore(),f+=82}}if(this.comboT>0&&this.combo>1&&(t.save(),t.fillStyle="#ffd166",t.font="700 14px system-ui",t.fillText(`Combo x${this.combo}`,16,46),t.restore()),this.floats.length)for(const f of this.floats){const a=Math.max(0,Math.min(1,f.ttl/.9));t.save(),t.globalAlpha=a,t.fillStyle="#ffd166",t.font="700 18px system-ui",t.fillText(f.text,f.x,f.y),t.restore()}if(this.isTouch){const f=i.canvas.width,a=i.canvas.height,p=Math.max(60,Math.min(120,Math.floor(Math.min(f,a)*.14))),b=24;this.btnRects={left:{x:b,y:a-p-b,w:p,h:p},right:{x:b+p+16,y:a-p-b,w:p,h:p},shoot:{x:f-p-b,y:a-p-b,w:p,h:p}};const w=(g,u,m)=>{t.save(),t.globalAlpha=.5,t.fillStyle=u?"#58a6ff":"#0f172a",t.strokeStyle="#58a6ff88",t.lineWidth=4,t.beginPath(),t.roundRect(g.x,g.y,g.w,g.h,16),t.fill(),t.stroke(),t.fillStyle="#e8e8f0",t.font="700 28px system-ui";const _=m==="L"?"◀":m==="R"?"▶":"●",M=t.measureText(_).width;t.fillText(_,g.x+(g.w-M)/2,g.y+g.h/2+10),t.restore()};w(this.btnRects.left,this.btnLeftDown,"L"),w(this.btnRects.right,this.btnRightDown,"R"),w(this.btnRects.shoot,this.btnShootDown,"S")}if(this.hintT>0){const f=Math.min(.8,this.hintT/4);t.save(),t.globalAlpha=f,t.fillStyle="#00000088",t.fillRect(20,70,520,56),t.fillStyle="#e8e8f0",t.font="600 16px system-ui",t.fillText("Flap: Space/ArrowUp/W or Click • Move: Arrows or A/D • Shoot: Right Click or Ctrl/J (hold)",28,100),t.restore()}if(t.restore(),this.paused&&(t.fillStyle="#00000088",t.fillRect(0,0,i.canvas.width,i.canvas.height),t.fillStyle="#e8e8f0",t.font="700 28px system-ui",t.fillText("Paused (P). R = Restart, Esc = Title",40,120)),this.gameOver){t.fillStyle="#00000088",t.fillRect(0,0,i.canvas.width,i.canvas.height),t.fillStyle="#e8e8f0",t.font="700 28px system-ui",t.fillText(`Game Over — Score ${this.score}  Best ${this.best}`,40,120),t.font="500 18px system-ui",t.fillText("Press R or tap the restart button",40,160);const f=i.canvas.width,a=i.canvas.height,p=Math.max(64,Math.min(120,Math.floor(Math.min(f,a)*.16))),b=(f-p)/2,w=a*.55;this.restartRect={x:b,y:w,w:p,h:p},t.save(),t.globalAlpha=.9,t.fillStyle="#0f172a",t.strokeStyle="#58a6ff88",t.lineWidth=5,t.beginPath(),t.roundRect(b,w,p,p,18),t.fill(),t.stroke(),t.fillStyle="#e8e8f0",t.font="700 28px system-ui",t.fillText("⟲",b+p/2-10,w+p/2+12),t.restore()}}};Rt.KILL_POINTS=2;let kt=Rt;class Xt{constructor(){this.p1=new At(80,140,26,26),this.p2=new At(120,220,26,26),this.obstacles=[],this.hud=new ie,this.timeToNext=0,this.s1=0,this.s2=0,this.paused=!1,this.speed=140,this.particles=new $t,this.shakeT=0}init(t){this.renderer=new se(t.canvas,t.ctx),this.obstacles=[],this.timeToNext=0,this.s1=0,this.s2=0,this.paused=!1,this.speed=140;const i=()=>{W.jump(this.p1),P.flap()};t.canvas.ontouchstart=i,t.canvas.onpointerdown=i}update(t,i){const s=i.canvas.height;if(i.input.wasPressed("KeyP")&&(this.paused=!this.paused),i.input.wasPressed("KeyR")&&this.init(i),this.paused)return;(i.input.wasPressed("Space")||i.input.wasPressed("ArrowUp"))&&(W.jump(this.p1),P.flap(),this.particles.burst(this.p1.x,this.p1.y+this.p1.height,6,"#88ccff88")),i.input.wasPressed("KeyW")&&(W.jump(this.p2),P.flap(),this.particles.burst(this.p2.x,this.p2.y+this.p2.height,6,"#ffb08888"));const r=i.input.getMovementDirection();if(this.p1.vx=r.x*80,this.p2.vx=0,this.p2.vy+=(i.input.isDown("KeyS")?1:0)*300*t,W.applyGravity(this.p1,t),W.applyGravity(this.p2,t),this.p1.update(t),this.p2.update(t),this.p1.y=Math.max(0,Math.min(s-this.p1.height,this.p1.y)),this.p2.y=Math.max(0,Math.min(s-this.p2.height,this.p2.y)),this.timeToNext-=t,this.timeToNext<=0){this.speed=Math.min(260,this.speed+2);const h=Math.max(130,180-Math.max(this.s1,this.s2)*2);this.timeToNext=Math.max(1,1.7-Math.max(this.s1,this.s2)*.02);const f=40,a=s-h-40,p=Math.floor(Math.random()*(a-f+1))+f,b=80,w=i.canvas.width+b;this.obstacles.push(new rt(w,0,b,p,this.speed)),this.obstacles.push(new rt(w,p+h,b,s-(p+h),this.speed))}for(const h of this.obstacles)h.update(t);this.obstacles=this.obstacles.filter(h=>!h.isOffScreen());for(const h of this.obstacles)if(W.checkCollision(this.p1,h)||W.checkCollision(this.p2,h)){P.hit(),this.particles.burst((this.p1.x+this.p2.x)/2,(this.p1.y+this.p2.y)/2,16,"#ff7b72aa"),this.shakeT=.25,this.init(i);return}for(let h=0;h<this.obstacles.length;h+=2){const f=this.obstacles[h],a=f.x+f.width/2;a<this.p1.x&&f.p1c!==!0&&(f.p1c=!0,this.s1+=1,this.p1.passObstacle(),P.score()),a<this.p2.x&&f.p2c!==!0&&(f.p2c=!0,this.s2+=1,this.p2.passObstacle(),P.score())}}render(t,i){const s=this.shakeT>0?(Math.random()-.5)*8:0;t.save(),t.translate(s,s),this.renderer.clear(1/60);for(const r of this.obstacles)this.renderer.drawObstacle(r);this.renderer.drawPlayer(this.p1,"#58a6ff"),this.renderer.drawPlayer(this.p2,"#ff7b72"),this.particles.render(t),this.hud.render(t,this.s1,this.s2),t.restore(),this.paused&&(t.fillStyle="#00000088",t.fillRect(0,0,i.canvas.width,i.canvas.height),t.fillStyle="#e8e8f0",t.font="700 28px system-ui",t.fillText("Paused (P). R = Restart, Esc = Title",40,120))}}class Jt extends Error{constructor(t){super(t),this.name="AbortError"}}function ze(c,t){const{cleanupBeforeAbort:i,abortSignal:s,abortErrorMsg:r}=t??{};return new Promise((h,f)=>{function a(){f(new Jt(r??"The operation was aborted."))}function p(){s==null||s.removeEventListener("abort",b)}function b(){i==null||i(),p(),a()}if(s!=null&&s.aborted)return a();try{c(w=>{p(),h(w)},w=>{p(),f(w)})}catch(w){f(w)}s==null||s.addEventListener("abort",b)})}const Xe="The delay was aborted.";function Dt(c,t){let i;const{abortSignal:s,abortErrorMsg:r}={};return ze(h=>{i=setTimeout(h,c)},{cleanupBeforeAbort:()=>clearTimeout(i),abortSignal:s,abortErrorMsg:r??Xe})}function Je(c){return c&&c.__esModule&&Object.prototype.hasOwnProperty.call(c,"default")?c.default:c}var ne={exports:{}},xt=typeof Reflect=="object"?Reflect:null,de=xt&&typeof xt.apply=="function"?xt.apply:function(t,i,s){return Function.prototype.apply.call(t,i,s)},Nt;xt&&typeof xt.ownKeys=="function"?Nt=xt.ownKeys:Object.getOwnPropertySymbols?Nt=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:Nt=function(t){return Object.getOwnPropertyNames(t)};function Ze(c){console&&console.warn&&console.warn(c)}var Re=Number.isNaN||function(t){return t!==t};function B(){B.init.call(this)}ne.exports=B;ne.exports.once=ii;B.EventEmitter=B;B.prototype._events=void 0;B.prototype._eventsCount=0;B.prototype._maxListeners=void 0;var pe=10;function Gt(c){if(typeof c!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof c)}Object.defineProperty(B,"defaultMaxListeners",{enumerable:!0,get:function(){return pe},set:function(c){if(typeof c!="number"||c<0||Re(c))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+c+".");pe=c}});B.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};B.prototype.setMaxListeners=function(t){if(typeof t!="number"||t<0||Re(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function Ae(c){return c._maxListeners===void 0?B.defaultMaxListeners:c._maxListeners}B.prototype.getMaxListeners=function(){return Ae(this)};B.prototype.emit=function(t){for(var i=[],s=1;s<arguments.length;s++)i.push(arguments[s]);var r=t==="error",h=this._events;if(h!==void 0)r=r&&h.error===void 0;else if(!r)return!1;if(r){var f;if(i.length>0&&(f=i[0]),f instanceof Error)throw f;var a=new Error("Unhandled error."+(f?" ("+f.message+")":""));throw a.context=f,a}var p=h[t];if(p===void 0)return!1;if(typeof p=="function")de(p,this,i);else for(var b=p.length,w=Le(p,b),s=0;s<b;++s)de(w[s],this,i);return!0};function ke(c,t,i,s){var r,h,f;if(Gt(i),h=c._events,h===void 0?(h=c._events=Object.create(null),c._eventsCount=0):(h.newListener!==void 0&&(c.emit("newListener",t,i.listener?i.listener:i),h=c._events),f=h[t]),f===void 0)f=h[t]=i,++c._eventsCount;else if(typeof f=="function"?f=h[t]=s?[i,f]:[f,i]:s?f.unshift(i):f.push(i),r=Ae(c),r>0&&f.length>r&&!f.warned){f.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+f.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=c,a.type=t,a.count=f.length,Ze(a)}return c}B.prototype.addListener=function(t,i){return ke(this,t,i,!1)};B.prototype.on=B.prototype.addListener;B.prototype.prependListener=function(t,i){return ke(this,t,i,!0)};function Qe(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Be(c,t,i){var s={fired:!1,wrapFn:void 0,target:c,type:t,listener:i},r=Qe.bind(s);return r.listener=i,s.wrapFn=r,r}B.prototype.once=function(t,i){return Gt(i),this.on(t,Be(this,t,i)),this};B.prototype.prependOnceListener=function(t,i){return Gt(i),this.prependListener(t,Be(this,t,i)),this};B.prototype.removeListener=function(t,i){var s,r,h,f,a;if(Gt(i),r=this._events,r===void 0)return this;if(s=r[t],s===void 0)return this;if(s===i||s.listener===i)--this._eventsCount===0?this._events=Object.create(null):(delete r[t],r.removeListener&&this.emit("removeListener",t,s.listener||i));else if(typeof s!="function"){for(h=-1,f=s.length-1;f>=0;f--)if(s[f]===i||s[f].listener===i){a=s[f].listener,h=f;break}if(h<0)return this;h===0?s.shift():ti(s,h),s.length===1&&(r[t]=s[0]),r.removeListener!==void 0&&this.emit("removeListener",t,a||i)}return this};B.prototype.off=B.prototype.removeListener;B.prototype.removeAllListeners=function(t){var i,s,r;if(s=this._events,s===void 0)return this;if(s.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):s[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete s[t]),this;if(arguments.length===0){var h=Object.keys(s),f;for(r=0;r<h.length;++r)f=h[r],f!=="removeListener"&&this.removeAllListeners(f);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(i=s[t],typeof i=="function")this.removeListener(t,i);else if(i!==void 0)for(r=i.length-1;r>=0;r--)this.removeListener(t,i[r]);return this};function Ce(c,t,i){var s=c._events;if(s===void 0)return[];var r=s[t];return r===void 0?[]:typeof r=="function"?i?[r.listener||r]:[r]:i?ei(r):Le(r,r.length)}B.prototype.listeners=function(t){return Ce(this,t,!0)};B.prototype.rawListeners=function(t){return Ce(this,t,!1)};B.listenerCount=function(c,t){return typeof c.listenerCount=="function"?c.listenerCount(t):Pe.call(c,t)};B.prototype.listenerCount=Pe;function Pe(c){var t=this._events;if(t!==void 0){var i=t[c];if(typeof i=="function")return 1;if(i!==void 0)return i.length}return 0}B.prototype.eventNames=function(){return this._eventsCount>0?Nt(this._events):[]};function Le(c,t){for(var i=new Array(t),s=0;s<t;++s)i[s]=c[s];return i}function ti(c,t){for(;t+1<c.length;t++)c[t]=c[t+1];c.pop()}function ei(c){for(var t=new Array(c.length),i=0;i<t.length;++i)t[i]=c[i].listener||c[i];return t}function ii(c,t){return new Promise(function(i,s){function r(f){c.removeListener(t,h),s(f)}function h(){typeof c.removeListener=="function"&&c.removeListener("error",r),i([].slice.call(arguments))}Ue(c,t,h,{once:!0}),t!=="error"&&si(c,r,{once:!0})})}function si(c,t,i){typeof c.on=="function"&&Ue(c,"error",t,i)}function Ue(c,t,i,s){if(typeof c.on=="function")s.once?c.once(t,i):c.on(t,i);else if(typeof c.addEventListener=="function")c.addEventListener(t,function r(h){s.once&&c.removeEventListener(t,r),i(h)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof c)}var ni=ne.exports;const ri=Je(ni);class Ft extends Error{constructor(t,i){super(t),this.name="SendMessageError",this.ackId=i.ackId,this.errorDetail=i.errorDetail}}function oi(...c){if(c.length>0){const t=String(c[0]);t.includes(":error")?console.error(...c):t.includes(":warning")?console.warn(...c):t.includes(":info")?console.info(...c):t.includes(":verbose")?console.debug(...c):console.debug(...c)}}var ye={};const me=typeof process<"u"&&ye&&ye.DEBUG||void 0;let Oe,Zt=[],Qt=[];const jt=[];me&&re(me);const gt=Object.assign(c=>Fe(c),{enable:re,enabled:oe,disable:ai,log:oi});function re(c){Oe=c,Zt=[],Qt=[];const t=/\*/g,i=c.split(",").map(s=>s.trim().replace(t,".*?"));for(const s of i)s.startsWith("-")?Qt.push(new RegExp(`^${s.substr(1)}$`)):Zt.push(new RegExp(`^${s}$`));for(const s of jt)s.enabled=oe(s.namespace)}function oe(c){if(c.endsWith("*"))return!0;for(const t of Qt)if(t.test(c))return!1;for(const t of Zt)if(t.test(c))return!0;return!1}function ai(){const c=Oe||"";return re(""),c}function Fe(c){const t=Object.assign(i,{enabled:oe(c),destroy:hi,log:gt.log,namespace:c,extend:li});function i(...s){t.enabled&&(s.length>0&&(s[0]=`${c} ${s[0]}`),t.log(...s))}return jt.push(t),t}function hi(){const c=jt.indexOf(this);return c>=0?(jt.splice(c,1),!0):!1}function li(c){const t=Fe(`${this.namespace}:${c}`);return t.log=this.log,t}var we={};const te=["verbose","info","warning","error"],ge={verbose:400,info:300,warning:200,error:100};function be(c,t){t.log=(...i)=>{c.log(...i)}}function xe(c){return te.includes(c)}function De(c){const t=new Set,i=typeof process<"u"&&we&&we[c.logLevelEnvVarName]||void 0;let s;const r=gt(c.namespace);r.log=(...w)=>{gt.log(...w)};function h(w){if(w&&!xe(w))throw new Error(`Unknown log level '${w}'. Acceptable values: ${te.join(",")}`);s=w;const g=[];for(const u of t)f(u)&&g.push(u.namespace);gt.enable(g.join(","))}i&&(xe(i)?h(i):console.error(`${c.logLevelEnvVarName} set to unknown log level '${i}'; logging is not enabled. Acceptable values: ${te.join(", ")}.`));function f(w){return!!(s&&ge[w.level]<=ge[s])}function a(w,g){const u=Object.assign(w.extend(g),{level:g});if(be(w,u),f(u)){const m=gt.disable();gt.enable(m+","+u.namespace)}return t.add(u),u}function p(){return s}function b(w){const g=r.extend(w);return be(r,g),{error:a(g,"error"),warning:a(g,"warning"),info:a(g,"info"),verbose:a(g,"verbose")}}return{setLogLevel:h,getLogLevel:p,createClientLogger:b,logger:r}}De({logLevelEnvVarName:"TYPESPEC_RUNTIME_LOG_LEVEL",namespace:"typeSpecRuntime"});const ci=De({logLevelEnvVarName:"AZURE_LOG_LEVEL",namespace:"azure"});function fi(c){return ci.createClientLogger(c)}const z=fi("web-pubsub-client");var ae={},Wt={};Wt.byteLength=pi;Wt.toByteArray=mi;Wt.fromByteArray=bi;var ot=[],tt=[],ui=typeof Uint8Array<"u"?Uint8Array:Array,Kt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var wt=0,di=Kt.length;wt<di;++wt)ot[wt]=Kt[wt],tt[Kt.charCodeAt(wt)]=wt;tt[45]=62;tt[95]=63;function Ne(c){var t=c.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=c.indexOf("=");i===-1&&(i=t);var s=i===t?0:4-i%4;return[i,s]}function pi(c){var t=Ne(c),i=t[0],s=t[1];return(i+s)*3/4-s}function yi(c,t,i){return(t+i)*3/4-i}function mi(c){var t,i=Ne(c),s=i[0],r=i[1],h=new ui(yi(c,s,r)),f=0,a=r>0?s-4:s,p;for(p=0;p<a;p+=4)t=tt[c.charCodeAt(p)]<<18|tt[c.charCodeAt(p+1)]<<12|tt[c.charCodeAt(p+2)]<<6|tt[c.charCodeAt(p+3)],h[f++]=t>>16&255,h[f++]=t>>8&255,h[f++]=t&255;return r===2&&(t=tt[c.charCodeAt(p)]<<2|tt[c.charCodeAt(p+1)]>>4,h[f++]=t&255),r===1&&(t=tt[c.charCodeAt(p)]<<10|tt[c.charCodeAt(p+1)]<<4|tt[c.charCodeAt(p+2)]>>2,h[f++]=t>>8&255,h[f++]=t&255),h}function wi(c){return ot[c>>18&63]+ot[c>>12&63]+ot[c>>6&63]+ot[c&63]}function gi(c,t,i){for(var s,r=[],h=t;h<i;h+=3)s=(c[h]<<16&16711680)+(c[h+1]<<8&65280)+(c[h+2]&255),r.push(wi(s));return r.join("")}function bi(c){for(var t,i=c.length,s=i%3,r=[],h=16383,f=0,a=i-s;f<a;f+=h)r.push(gi(c,f,f+h>a?a:f+h));return s===1?(t=c[i-1],r.push(ot[t>>2]+ot[t<<4&63]+"==")):s===2&&(t=(c[i-2]<<8)+c[i-1],r.push(ot[t>>10]+ot[t>>4&63]+ot[t<<2&63]+"=")),r.join("")}var he={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */he.read=function(c,t,i,s,r){var h,f,a=r*8-s-1,p=(1<<a)-1,b=p>>1,w=-7,g=i?r-1:0,u=i?-1:1,m=c[t+g];for(g+=u,h=m&(1<<-w)-1,m>>=-w,w+=a;w>0;h=h*256+c[t+g],g+=u,w-=8);for(f=h&(1<<-w)-1,h>>=-w,w+=s;w>0;f=f*256+c[t+g],g+=u,w-=8);if(h===0)h=1-b;else{if(h===p)return f?NaN:(m?-1:1)*(1/0);f=f+Math.pow(2,s),h=h-b}return(m?-1:1)*f*Math.pow(2,h-s)};he.write=function(c,t,i,s,r,h){var f,a,p,b=h*8-r-1,w=(1<<b)-1,g=w>>1,u=r===23?Math.pow(2,-24)-Math.pow(2,-77):0,m=s?0:h-1,_=s?1:-1,M=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,f=w):(f=Math.floor(Math.log(t)/Math.LN2),t*(p=Math.pow(2,-f))<1&&(f--,p*=2),f+g>=1?t+=u/p:t+=u*Math.pow(2,1-g),t*p>=2&&(f++,p/=2),f+g>=w?(a=0,f=w):f+g>=1?(a=(t*p-1)*Math.pow(2,r),f=f+g):(a=t*Math.pow(2,g-1)*Math.pow(2,r),f=0));r>=8;c[i+m]=a&255,m+=_,a/=256,r-=8);for(f=f<<r|a,b+=r;b>0;c[i+m]=f&255,m+=_,f/=256,b-=8);c[i+m-_]|=M*128};/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(c){const t=Wt,i=he,s=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;c.Buffer=a,c.SlowBuffer=S,c.INSPECT_MAX_BYTES=50;const r=2147483647;c.kMaxLength=r,a.TYPED_ARRAY_SUPPORT=h(),!a.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function h(){try{const o=new Uint8Array(1),e={foo:function(){return 42}};return Object.setPrototypeOf(e,Uint8Array.prototype),Object.setPrototypeOf(o,e),o.foo()===42}catch{return!1}}Object.defineProperty(a.prototype,"parent",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.buffer}}),Object.defineProperty(a.prototype,"offset",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.byteOffset}});function f(o){if(o>r)throw new RangeError('The value "'+o+'" is invalid for option "size"');const e=new Uint8Array(o);return Object.setPrototypeOf(e,a.prototype),e}function a(o,e,n){if(typeof o=="number"){if(typeof e=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return g(o)}return p(o,e,n)}a.poolSize=8192;function p(o,e,n){if(typeof o=="string")return u(o,e);if(ArrayBuffer.isView(o))return _(o);if(o==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof o);if(nt(o,ArrayBuffer)||o&&nt(o.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(nt(o,SharedArrayBuffer)||o&&nt(o.buffer,SharedArrayBuffer)))return M(o,e,n);if(typeof o=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const l=o.valueOf&&o.valueOf();if(l!=null&&l!==o)return a.from(l,e,n);const d=E(o);if(d)return d;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof o[Symbol.toPrimitive]=="function")return a.from(o[Symbol.toPrimitive]("string"),e,n);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof o)}a.from=function(o,e,n){return p(o,e,n)},Object.setPrototypeOf(a.prototype,Uint8Array.prototype),Object.setPrototypeOf(a,Uint8Array);function b(o){if(typeof o!="number")throw new TypeError('"size" argument must be of type number');if(o<0)throw new RangeError('The value "'+o+'" is invalid for option "size"')}function w(o,e,n){return b(o),o<=0?f(o):e!==void 0?typeof n=="string"?f(o).fill(e,n):f(o).fill(e):f(o)}a.alloc=function(o,e,n){return w(o,e,n)};function g(o){return b(o),f(o<0?0:v(o)|0)}a.allocUnsafe=function(o){return g(o)},a.allocUnsafeSlow=function(o){return g(o)};function u(o,e){if((typeof e!="string"||e==="")&&(e="utf8"),!a.isEncoding(e))throw new TypeError("Unknown encoding: "+e);const n=T(o,e)|0;let l=f(n);const d=l.write(o,e);return d!==n&&(l=l.slice(0,d)),l}function m(o){const e=o.length<0?0:v(o.length)|0,n=f(e);for(let l=0;l<e;l+=1)n[l]=o[l]&255;return n}function _(o){if(nt(o,Uint8Array)){const e=new Uint8Array(o);return M(e.buffer,e.byteOffset,e.byteLength)}return m(o)}function M(o,e,n){if(e<0||o.byteLength<e)throw new RangeError('"offset" is outside of buffer bounds');if(o.byteLength<e+(n||0))throw new RangeError('"length" is outside of buffer bounds');let l;return e===void 0&&n===void 0?l=new Uint8Array(o):n===void 0?l=new Uint8Array(o,e):l=new Uint8Array(o,e,n),Object.setPrototypeOf(l,a.prototype),l}function E(o){if(a.isBuffer(o)){const e=v(o.length)|0,n=f(e);return n.length===0||o.copy(n,0,0,e),n}if(o.length!==void 0)return typeof o.length!="number"||Ht(o.length)?f(0):m(o);if(o.type==="Buffer"&&Array.isArray(o.data))return m(o.data)}function v(o){if(o>=r)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+r.toString(16)+" bytes");return o|0}function S(o){return+o!=o&&(o=0),a.alloc(+o)}a.isBuffer=function(e){return e!=null&&e._isBuffer===!0&&e!==a.prototype},a.compare=function(e,n){if(nt(e,Uint8Array)&&(e=a.from(e,e.offset,e.byteLength)),nt(n,Uint8Array)&&(n=a.from(n,n.offset,n.byteLength)),!a.isBuffer(e)||!a.isBuffer(n))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===n)return 0;let l=e.length,d=n.length;for(let y=0,x=Math.min(l,d);y<x;++y)if(e[y]!==n[y]){l=e[y],d=n[y];break}return l<d?-1:d<l?1:0},a.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},a.concat=function(e,n){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(e.length===0)return a.alloc(0);let l;if(n===void 0)for(n=0,l=0;l<e.length;++l)n+=e[l].length;const d=a.allocUnsafe(n);let y=0;for(l=0;l<e.length;++l){let x=e[l];if(nt(x,Uint8Array))y+x.length>d.length?(a.isBuffer(x)||(x=a.from(x)),x.copy(d,y)):Uint8Array.prototype.set.call(d,x,y);else if(a.isBuffer(x))x.copy(d,y);else throw new TypeError('"list" argument must be an Array of Buffers');y+=x.length}return d};function T(o,e){if(a.isBuffer(o))return o.length;if(ArrayBuffer.isView(o)||nt(o,ArrayBuffer))return o.byteLength;if(typeof o!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof o);const n=o.length,l=arguments.length>2&&arguments[2]===!0;if(!l&&n===0)return 0;let d=!1;for(;;)switch(e){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":return lt(o).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return n*2;case"hex":return n>>>1;case"base64":return ce(o).length;default:if(d)return l?-1:lt(o).length;e=(""+e).toLowerCase(),d=!0}}a.byteLength=T;function I(o,e,n){let l=!1;if((e===void 0||e<0)&&(e=0),e>this.length||((n===void 0||n>this.length)&&(n=this.length),n<=0)||(n>>>=0,e>>>=0,n<=e))return"";for(o||(o="utf8");;)switch(o){case"hex":return Bt(this,e,n);case"utf8":case"utf-8":return ft(this,e,n);case"ascii":return dt(this,e,n);case"latin1":case"binary":return Mt(this,e,n);case"base64":return st(this,e,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return St(this,e,n);default:if(l)throw new TypeError("Unknown encoding: "+o);o=(o+"").toLowerCase(),l=!0}}a.prototype._isBuffer=!0;function R(o,e,n){const l=o[e];o[e]=o[n],o[n]=l}a.prototype.swap16=function(){const e=this.length;if(e%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let n=0;n<e;n+=2)R(this,n,n+1);return this},a.prototype.swap32=function(){const e=this.length;if(e%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let n=0;n<e;n+=4)R(this,n,n+3),R(this,n+1,n+2);return this},a.prototype.swap64=function(){const e=this.length;if(e%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let n=0;n<e;n+=8)R(this,n,n+7),R(this,n+1,n+6),R(this,n+2,n+5),R(this,n+3,n+4);return this},a.prototype.toString=function(){const e=this.length;return e===0?"":arguments.length===0?ft(this,0,e):I.apply(this,arguments)},a.prototype.toLocaleString=a.prototype.toString,a.prototype.equals=function(e){if(!a.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e?!0:a.compare(this,e)===0},a.prototype.inspect=function(){let e="";const n=c.INSPECT_MAX_BYTES;return e=this.toString("hex",0,n).replace(/(.{2})/g,"$1 ").trim(),this.length>n&&(e+=" ... "),"<Buffer "+e+">"},s&&(a.prototype[s]=a.prototype.inspect),a.prototype.compare=function(e,n,l,d,y){if(nt(e,Uint8Array)&&(e=a.from(e,e.offset,e.byteLength)),!a.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(n===void 0&&(n=0),l===void 0&&(l=e?e.length:0),d===void 0&&(d=0),y===void 0&&(y=this.length),n<0||l>e.length||d<0||y>this.length)throw new RangeError("out of range index");if(d>=y&&n>=l)return 0;if(d>=y)return-1;if(n>=l)return 1;if(n>>>=0,l>>>=0,d>>>=0,y>>>=0,this===e)return 0;let x=y-d,A=l-n;const N=Math.min(x,A),F=this.slice(d,y),$=e.slice(n,l);for(let C=0;C<N;++C)if(F[C]!==$[C]){x=F[C],A=$[C];break}return x<A?-1:A<x?1:0};function k(o,e,n,l,d){if(o.length===0)return-1;if(typeof n=="string"?(l=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,Ht(n)&&(n=d?0:o.length-1),n<0&&(n=o.length+n),n>=o.length){if(d)return-1;n=o.length-1}else if(n<0)if(d)n=0;else return-1;if(typeof e=="string"&&(e=a.from(e,l)),a.isBuffer(e))return e.length===0?-1:H(o,e,n,l,d);if(typeof e=="number")return e=e&255,typeof Uint8Array.prototype.indexOf=="function"?d?Uint8Array.prototype.indexOf.call(o,e,n):Uint8Array.prototype.lastIndexOf.call(o,e,n):H(o,[e],n,l,d);throw new TypeError("val must be string, number or Buffer")}function H(o,e,n,l,d){let y=1,x=o.length,A=e.length;if(l!==void 0&&(l=String(l).toLowerCase(),l==="ucs2"||l==="ucs-2"||l==="utf16le"||l==="utf-16le")){if(o.length<2||e.length<2)return-1;y=2,x/=2,A/=2,n/=2}function N($,C){return y===1?$[C]:$.readUInt16BE(C*y)}let F;if(d){let $=-1;for(F=n;F<x;F++)if(N(o,F)===N(e,$===-1?0:F-$)){if($===-1&&($=F),F-$+1===A)return $*y}else $!==-1&&(F-=F-$),$=-1}else for(n+A>x&&(n=x-A),F=n;F>=0;F--){let $=!0;for(let C=0;C<A;C++)if(N(o,F+C)!==N(e,C)){$=!1;break}if($)return F}return-1}a.prototype.includes=function(e,n,l){return this.indexOf(e,n,l)!==-1},a.prototype.indexOf=function(e,n,l){return k(this,e,n,l,!0)},a.prototype.lastIndexOf=function(e,n,l){return k(this,e,n,l,!1)};function L(o,e,n,l){n=Number(n)||0;const d=o.length-n;l?(l=Number(l),l>d&&(l=d)):l=d;const y=e.length;l>y/2&&(l=y/2);let x;for(x=0;x<l;++x){const A=parseInt(e.substr(x*2,2),16);if(Ht(A))return x;o[n+x]=A}return x}function D(o,e,n,l){return Ot(lt(e,o.length-n),o,n,l)}function ht(o,e,n,l){return Ot(Lt(e),o,n,l)}function J(o,e,n,l){return Ot(ce(e),o,n,l)}function X(o,e,n,l){return Ot(Ut(e,o.length-n),o,n,l)}a.prototype.write=function(e,n,l,d){if(n===void 0)d="utf8",l=this.length,n=0;else if(l===void 0&&typeof n=="string")d=n,l=this.length,n=0;else if(isFinite(n))n=n>>>0,isFinite(l)?(l=l>>>0,d===void 0&&(d="utf8")):(d=l,l=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const y=this.length-n;if((l===void 0||l>y)&&(l=y),e.length>0&&(l<0||n<0)||n>this.length)throw new RangeError("Attempt to write outside buffer bounds");d||(d="utf8");let x=!1;for(;;)switch(d){case"hex":return L(this,e,n,l);case"utf8":case"utf-8":return D(this,e,n,l);case"ascii":case"latin1":case"binary":return ht(this,e,n,l);case"base64":return J(this,e,n,l);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return X(this,e,n,l);default:if(x)throw new TypeError("Unknown encoding: "+d);d=(""+d).toLowerCase(),x=!0}},a.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function st(o,e,n){return e===0&&n===o.length?t.fromByteArray(o):t.fromByteArray(o.slice(e,n))}function ft(o,e,n){n=Math.min(o.length,n);const l=[];let d=e;for(;d<n;){const y=o[d];let x=null,A=y>239?4:y>223?3:y>191?2:1;if(d+A<=n){let N,F,$,C;switch(A){case 1:y<128&&(x=y);break;case 2:N=o[d+1],(N&192)===128&&(C=(y&31)<<6|N&63,C>127&&(x=C));break;case 3:N=o[d+1],F=o[d+2],(N&192)===128&&(F&192)===128&&(C=(y&15)<<12|(N&63)<<6|F&63,C>2047&&(C<55296||C>57343)&&(x=C));break;case 4:N=o[d+1],F=o[d+2],$=o[d+3],(N&192)===128&&(F&192)===128&&($&192)===128&&(C=(y&15)<<18|(N&63)<<12|(F&63)<<6|$&63,C>65535&&C<1114112&&(x=C))}}x===null?(x=65533,A=1):x>65535&&(x-=65536,l.push(x>>>10&1023|55296),x=56320|x&1023),l.push(x),d+=A}return ut(l)}const vt=4096;function ut(o){const e=o.length;if(e<=vt)return String.fromCharCode.apply(String,o);let n="",l=0;for(;l<e;)n+=String.fromCharCode.apply(String,o.slice(l,l+=vt));return n}function dt(o,e,n){let l="";n=Math.min(o.length,n);for(let d=e;d<n;++d)l+=String.fromCharCode(o[d]&127);return l}function Mt(o,e,n){let l="";n=Math.min(o.length,n);for(let d=e;d<n;++d)l+=String.fromCharCode(o[d]);return l}function Bt(o,e,n){const l=o.length;(!e||e<0)&&(e=0),(!n||n<0||n>l)&&(n=l);let d="";for(let y=e;y<n;++y)d+=je[o[y]];return d}function St(o,e,n){const l=o.slice(e,n);let d="";for(let y=0;y<l.length-1;y+=2)d+=String.fromCharCode(l[y]+l[y+1]*256);return d}a.prototype.slice=function(e,n){const l=this.length;e=~~e,n=n===void 0?l:~~n,e<0?(e+=l,e<0&&(e=0)):e>l&&(e=l),n<0?(n+=l,n<0&&(n=0)):n>l&&(n=l),n<e&&(n=e);const d=this.subarray(e,n);return Object.setPrototypeOf(d,a.prototype),d};function j(o,e,n){if(o%1!==0||o<0)throw new RangeError("offset is not uint");if(o+e>n)throw new RangeError("Trying to access beyond buffer length")}a.prototype.readUintLE=a.prototype.readUIntLE=function(e,n,l){e=e>>>0,n=n>>>0,l||j(e,n,this.length);let d=this[e],y=1,x=0;for(;++x<n&&(y*=256);)d+=this[e+x]*y;return d},a.prototype.readUintBE=a.prototype.readUIntBE=function(e,n,l){e=e>>>0,n=n>>>0,l||j(e,n,this.length);let d=this[e+--n],y=1;for(;n>0&&(y*=256);)d+=this[e+--n]*y;return d},a.prototype.readUint8=a.prototype.readUInt8=function(e,n){return e=e>>>0,n||j(e,1,this.length),this[e]},a.prototype.readUint16LE=a.prototype.readUInt16LE=function(e,n){return e=e>>>0,n||j(e,2,this.length),this[e]|this[e+1]<<8},a.prototype.readUint16BE=a.prototype.readUInt16BE=function(e,n){return e=e>>>0,n||j(e,2,this.length),this[e]<<8|this[e+1]},a.prototype.readUint32LE=a.prototype.readUInt32LE=function(e,n){return e=e>>>0,n||j(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+this[e+3]*16777216},a.prototype.readUint32BE=a.prototype.readUInt32BE=function(e,n){return e=e>>>0,n||j(e,4,this.length),this[e]*16777216+(this[e+1]<<16|this[e+2]<<8|this[e+3])},a.prototype.readBigUInt64LE=ct(function(e){e=e>>>0,V(e,"offset");const n=this[e],l=this[e+7];(n===void 0||l===void 0)&&Y(e,this.length-8);const d=n+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24,y=this[++e]+this[++e]*2**8+this[++e]*2**16+l*2**24;return BigInt(d)+(BigInt(y)<<BigInt(32))}),a.prototype.readBigUInt64BE=ct(function(e){e=e>>>0,V(e,"offset");const n=this[e],l=this[e+7];(n===void 0||l===void 0)&&Y(e,this.length-8);const d=n*2**24+this[++e]*2**16+this[++e]*2**8+this[++e],y=this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+l;return(BigInt(d)<<BigInt(32))+BigInt(y)}),a.prototype.readIntLE=function(e,n,l){e=e>>>0,n=n>>>0,l||j(e,n,this.length);let d=this[e],y=1,x=0;for(;++x<n&&(y*=256);)d+=this[e+x]*y;return y*=128,d>=y&&(d-=Math.pow(2,8*n)),d},a.prototype.readIntBE=function(e,n,l){e=e>>>0,n=n>>>0,l||j(e,n,this.length);let d=n,y=1,x=this[e+--d];for(;d>0&&(y*=256);)x+=this[e+--d]*y;return y*=128,x>=y&&(x-=Math.pow(2,8*n)),x},a.prototype.readInt8=function(e,n){return e=e>>>0,n||j(e,1,this.length),this[e]&128?(255-this[e]+1)*-1:this[e]},a.prototype.readInt16LE=function(e,n){e=e>>>0,n||j(e,2,this.length);const l=this[e]|this[e+1]<<8;return l&32768?l|4294901760:l},a.prototype.readInt16BE=function(e,n){e=e>>>0,n||j(e,2,this.length);const l=this[e+1]|this[e]<<8;return l&32768?l|4294901760:l},a.prototype.readInt32LE=function(e,n){return e=e>>>0,n||j(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},a.prototype.readInt32BE=function(e,n){return e=e>>>0,n||j(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},a.prototype.readBigInt64LE=ct(function(e){e=e>>>0,V(e,"offset");const n=this[e],l=this[e+7];(n===void 0||l===void 0)&&Y(e,this.length-8);const d=this[e+4]+this[e+5]*2**8+this[e+6]*2**16+(l<<24);return(BigInt(d)<<BigInt(32))+BigInt(n+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24)}),a.prototype.readBigInt64BE=ct(function(e){e=e>>>0,V(e,"offset");const n=this[e],l=this[e+7];(n===void 0||l===void 0)&&Y(e,this.length-8);const d=(n<<24)+this[++e]*2**16+this[++e]*2**8+this[++e];return(BigInt(d)<<BigInt(32))+BigInt(this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+l)}),a.prototype.readFloatLE=function(e,n){return e=e>>>0,n||j(e,4,this.length),i.read(this,e,!0,23,4)},a.prototype.readFloatBE=function(e,n){return e=e>>>0,n||j(e,4,this.length),i.read(this,e,!1,23,4)},a.prototype.readDoubleLE=function(e,n){return e=e>>>0,n||j(e,8,this.length),i.read(this,e,!0,52,8)},a.prototype.readDoubleBE=function(e,n){return e=e>>>0,n||j(e,8,this.length),i.read(this,e,!1,52,8)};function K(o,e,n,l,d,y){if(!a.isBuffer(o))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>d||e<y)throw new RangeError('"value" argument is out of bounds');if(n+l>o.length)throw new RangeError("Index out of range")}a.prototype.writeUintLE=a.prototype.writeUIntLE=function(e,n,l,d){if(e=+e,n=n>>>0,l=l>>>0,!d){const A=Math.pow(2,8*l)-1;K(this,e,n,l,A,0)}let y=1,x=0;for(this[n]=e&255;++x<l&&(y*=256);)this[n+x]=e/y&255;return n+l},a.prototype.writeUintBE=a.prototype.writeUIntBE=function(e,n,l,d){if(e=+e,n=n>>>0,l=l>>>0,!d){const A=Math.pow(2,8*l)-1;K(this,e,n,l,A,0)}let y=l-1,x=1;for(this[n+y]=e&255;--y>=0&&(x*=256);)this[n+y]=e/x&255;return n+l},a.prototype.writeUint8=a.prototype.writeUInt8=function(e,n,l){return e=+e,n=n>>>0,l||K(this,e,n,1,255,0),this[n]=e&255,n+1},a.prototype.writeUint16LE=a.prototype.writeUInt16LE=function(e,n,l){return e=+e,n=n>>>0,l||K(this,e,n,2,65535,0),this[n]=e&255,this[n+1]=e>>>8,n+2},a.prototype.writeUint16BE=a.prototype.writeUInt16BE=function(e,n,l){return e=+e,n=n>>>0,l||K(this,e,n,2,65535,0),this[n]=e>>>8,this[n+1]=e&255,n+2},a.prototype.writeUint32LE=a.prototype.writeUInt32LE=function(e,n,l){return e=+e,n=n>>>0,l||K(this,e,n,4,4294967295,0),this[n+3]=e>>>24,this[n+2]=e>>>16,this[n+1]=e>>>8,this[n]=e&255,n+4},a.prototype.writeUint32BE=a.prototype.writeUInt32BE=function(e,n,l){return e=+e,n=n>>>0,l||K(this,e,n,4,4294967295,0),this[n]=e>>>24,this[n+1]=e>>>16,this[n+2]=e>>>8,this[n+3]=e&255,n+4};function pt(o,e,n,l,d){Q(e,l,d,o,n,7);let y=Number(e&BigInt(4294967295));o[n++]=y,y=y>>8,o[n++]=y,y=y>>8,o[n++]=y,y=y>>8,o[n++]=y;let x=Number(e>>BigInt(32)&BigInt(4294967295));return o[n++]=x,x=x>>8,o[n++]=x,x=x>>8,o[n++]=x,x=x>>8,o[n++]=x,n}function Ct(o,e,n,l,d){Q(e,l,d,o,n,7);let y=Number(e&BigInt(4294967295));o[n+7]=y,y=y>>8,o[n+6]=y,y=y>>8,o[n+5]=y,y=y>>8,o[n+4]=y;let x=Number(e>>BigInt(32)&BigInt(4294967295));return o[n+3]=x,x=x>>8,o[n+2]=x,x=x>>8,o[n+1]=x,x=x>>8,o[n]=x,n+8}a.prototype.writeBigUInt64LE=ct(function(e,n=0){return pt(this,e,n,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeBigUInt64BE=ct(function(e,n=0){return Ct(this,e,n,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeIntLE=function(e,n,l,d){if(e=+e,n=n>>>0,!d){const N=Math.pow(2,8*l-1);K(this,e,n,l,N-1,-N)}let y=0,x=1,A=0;for(this[n]=e&255;++y<l&&(x*=256);)e<0&&A===0&&this[n+y-1]!==0&&(A=1),this[n+y]=(e/x>>0)-A&255;return n+l},a.prototype.writeIntBE=function(e,n,l,d){if(e=+e,n=n>>>0,!d){const N=Math.pow(2,8*l-1);K(this,e,n,l,N-1,-N)}let y=l-1,x=1,A=0;for(this[n+y]=e&255;--y>=0&&(x*=256);)e<0&&A===0&&this[n+y+1]!==0&&(A=1),this[n+y]=(e/x>>0)-A&255;return n+l},a.prototype.writeInt8=function(e,n,l){return e=+e,n=n>>>0,l||K(this,e,n,1,127,-128),e<0&&(e=255+e+1),this[n]=e&255,n+1},a.prototype.writeInt16LE=function(e,n,l){return e=+e,n=n>>>0,l||K(this,e,n,2,32767,-32768),this[n]=e&255,this[n+1]=e>>>8,n+2},a.prototype.writeInt16BE=function(e,n,l){return e=+e,n=n>>>0,l||K(this,e,n,2,32767,-32768),this[n]=e>>>8,this[n+1]=e&255,n+2},a.prototype.writeInt32LE=function(e,n,l){return e=+e,n=n>>>0,l||K(this,e,n,4,2147483647,-2147483648),this[n]=e&255,this[n+1]=e>>>8,this[n+2]=e>>>16,this[n+3]=e>>>24,n+4},a.prototype.writeInt32BE=function(e,n,l){return e=+e,n=n>>>0,l||K(this,e,n,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[n]=e>>>24,this[n+1]=e>>>16,this[n+2]=e>>>8,this[n+3]=e&255,n+4},a.prototype.writeBigInt64LE=ct(function(e,n=0){return pt(this,e,n,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),a.prototype.writeBigInt64BE=ct(function(e,n=0){return Ct(this,e,n,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function _t(o,e,n,l,d,y){if(n+l>o.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function Pt(o,e,n,l,d){return e=+e,n=n>>>0,d||_t(o,e,n,4),i.write(o,e,n,l,23,4),n+4}a.prototype.writeFloatLE=function(e,n,l){return Pt(this,e,n,!0,l)},a.prototype.writeFloatBE=function(e,n,l){return Pt(this,e,n,!1,l)};function U(o,e,n,l,d){return e=+e,n=n>>>0,d||_t(o,e,n,8),i.write(o,e,n,l,52,8),n+8}a.prototype.writeDoubleLE=function(e,n,l){return U(this,e,n,!0,l)},a.prototype.writeDoubleBE=function(e,n,l){return U(this,e,n,!1,l)},a.prototype.copy=function(e,n,l,d){if(!a.isBuffer(e))throw new TypeError("argument should be a Buffer");if(l||(l=0),!d&&d!==0&&(d=this.length),n>=e.length&&(n=e.length),n||(n=0),d>0&&d<l&&(d=l),d===l||e.length===0||this.length===0)return 0;if(n<0)throw new RangeError("targetStart out of bounds");if(l<0||l>=this.length)throw new RangeError("Index out of range");if(d<0)throw new RangeError("sourceEnd out of bounds");d>this.length&&(d=this.length),e.length-n<d-l&&(d=e.length-n+l);const y=d-l;return this===e&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(n,l,d):Uint8Array.prototype.set.call(e,this.subarray(l,d),n),y},a.prototype.fill=function(e,n,l,d){if(typeof e=="string"){if(typeof n=="string"?(d=n,n=0,l=this.length):typeof l=="string"&&(d=l,l=this.length),d!==void 0&&typeof d!="string")throw new TypeError("encoding must be a string");if(typeof d=="string"&&!a.isEncoding(d))throw new TypeError("Unknown encoding: "+d);if(e.length===1){const x=e.charCodeAt(0);(d==="utf8"&&x<128||d==="latin1")&&(e=x)}}else typeof e=="number"?e=e&255:typeof e=="boolean"&&(e=Number(e));if(n<0||this.length<n||this.length<l)throw new RangeError("Out of range index");if(l<=n)return this;n=n>>>0,l=l===void 0?this.length:l>>>0,e||(e=0);let y;if(typeof e=="number")for(y=n;y<l;++y)this[y]=e;else{const x=a.isBuffer(e)?e:a.from(e,d),A=x.length;if(A===0)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(y=0;y<l-n;++y)this[y+n]=x[y%A]}return this};const G={};function O(o,e,n){G[o]=class extends n{constructor(){super(),Object.defineProperty(this,"message",{value:e.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${o}]`,this.stack,delete this.name}get code(){return o}set code(d){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:d,writable:!0})}toString(){return`${this.name} [${o}]: ${this.message}`}}}O("ERR_BUFFER_OUT_OF_BOUNDS",function(o){return o?`${o} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),O("ERR_INVALID_ARG_TYPE",function(o,e){return`The "${o}" argument must be of type number. Received type ${typeof e}`},TypeError),O("ERR_OUT_OF_RANGE",function(o,e,n){let l=`The value of "${o}" is out of range.`,d=n;return Number.isInteger(n)&&Math.abs(n)>2**32?d=q(String(n)):typeof n=="bigint"&&(d=String(n),(n>BigInt(2)**BigInt(32)||n<-(BigInt(2)**BigInt(32)))&&(d=q(d)),d+="n"),l+=` It must be ${e}. Received ${d}`,l},RangeError);function q(o){let e="",n=o.length;const l=o[0]==="-"?1:0;for(;n>=l+4;n-=3)e=`_${o.slice(n-3,n)}${e}`;return`${o.slice(0,n)}${e}`}function yt(o,e,n){V(e,"offset"),(o[e]===void 0||o[e+n]===void 0)&&Y(e,o.length-(n+1))}function Q(o,e,n,l,d,y){if(o>n||o<e){const x=typeof e=="bigint"?"n":"";let A;throw e===0||e===BigInt(0)?A=`>= 0${x} and < 2${x} ** ${(y+1)*8}${x}`:A=`>= -(2${x} ** ${(y+1)*8-1}${x}) and < 2 ** ${(y+1)*8-1}${x}`,new G.ERR_OUT_OF_RANGE("value",A,o)}yt(l,d,y)}function V(o,e){if(typeof o!="number")throw new G.ERR_INVALID_ARG_TYPE(e,"number",o)}function Y(o,e,n){throw Math.floor(o)!==o?(V(o,n),new G.ERR_OUT_OF_RANGE("offset","an integer",o)):e<0?new G.ERR_BUFFER_OUT_OF_BOUNDS:new G.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${e}`,o)}const at=/[^+/0-9A-Za-z-_]/g;function mt(o){if(o=o.split("=")[0],o=o.trim().replace(at,""),o.length<2)return"";for(;o.length%4!==0;)o=o+"=";return o}function lt(o,e){e=e||1/0;let n;const l=o.length;let d=null;const y=[];for(let x=0;x<l;++x){if(n=o.charCodeAt(x),n>55295&&n<57344){if(!d){if(n>56319){(e-=3)>-1&&y.push(239,191,189);continue}else if(x+1===l){(e-=3)>-1&&y.push(239,191,189);continue}d=n;continue}if(n<56320){(e-=3)>-1&&y.push(239,191,189),d=n;continue}n=(d-55296<<10|n-56320)+65536}else d&&(e-=3)>-1&&y.push(239,191,189);if(d=null,n<128){if((e-=1)<0)break;y.push(n)}else if(n<2048){if((e-=2)<0)break;y.push(n>>6|192,n&63|128)}else if(n<65536){if((e-=3)<0)break;y.push(n>>12|224,n>>6&63|128,n&63|128)}else if(n<1114112){if((e-=4)<0)break;y.push(n>>18|240,n>>12&63|128,n>>6&63|128,n&63|128)}else throw new Error("Invalid code point")}return y}function Lt(o){const e=[];for(let n=0;n<o.length;++n)e.push(o.charCodeAt(n)&255);return e}function Ut(o,e){let n,l,d;const y=[];for(let x=0;x<o.length&&!((e-=2)<0);++x)n=o.charCodeAt(x),l=n>>8,d=n%256,y.push(d),y.push(l);return y}function ce(o){return t.toByteArray(mt(o))}function Ot(o,e,n,l){let d;for(d=0;d<l&&!(d+n>=e.length||d>=o.length);++d)e[d+n]=o[d];return d}function nt(o,e){return o instanceof e||o!=null&&o.constructor!=null&&o.constructor.name!=null&&o.constructor.name===e.name}function Ht(o){return o!==o}const je=function(){const o="0123456789abcdef",e=new Array(256);for(let n=0;n<16;++n){const l=n*16;for(let d=0;d<16;++d)e[l+d]=o[n]+o[d]}return e}();function ct(o){return typeof BigInt>"u"?Ge:o}function Ge(){throw new Error("BigInt not supported")}})(ae);function xi(c){if(typeof c!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!c)throw new Error("No input");const t=JSON.parse(c),i=t;let s;if(i.type==="system")if(i.event==="connected")s=Object.assign(Object.assign({},t),{kind:"connected"});else if(i.event==="disconnected")s=Object.assign(Object.assign({},t),{kind:"disconnected"});else return null;else if(i.type==="message")if(i.from==="group"){const r=Me(t.data,t.dataType);if(r===null)return null;s=Object.assign(Object.assign({},t),{data:r,kind:"groupData"})}else if(i.from==="server"){const r=Me(t.data,t.dataType);if(r===null)return null;s=Object.assign(Object.assign({},t),{data:r,kind:"serverData"})}else return null;else if(i.type==="ack")s=Object.assign(Object.assign({},t),{kind:"ack"});else return null;return s}function vi(c){let t;switch(c.kind){case"joinGroup":{t={type:"joinGroup",group:c.group,ackId:c.ackId};break}case"leaveGroup":{t={type:"leaveGroup",group:c.group,ackId:c.ackId};break}case"sendEvent":{t={type:"event",event:c.event,ackId:c.ackId,dataType:c.dataType,data:ve(c.data,c.dataType)};break}case"sendToGroup":{t={type:"sendToGroup",group:c.group,ackId:c.ackId,dataType:c.dataType,data:ve(c.data,c.dataType),noEcho:c.noEcho};break}case"sequenceAck":{t={type:"sequenceAck",sequenceId:c.sequenceId};break}default:throw new Error(`Unsupported type: ${c.kind}`)}return JSON.stringify(t)}function ve(c,t){switch(t){case"text":{if(typeof c!="string")throw new TypeError("Message must be a string.");return c}case"json":return c;case"binary":case"protobuf":{if(c instanceof ArrayBuffer)return ae.Buffer.from(c).toString("base64");throw new TypeError("Message must be a ArrayBuffer")}}}function Me(c,t){if(t==="text"){if(typeof c!="string")throw new TypeError("Message must be a string when dataType is text");return c}else{if(t==="json")return c;if(t==="binary"||t==="protobuf"){const i=ae.Buffer.from(c,"base64");return i.buffer.slice(i.byteOffset,i.byteOffset+i.byteLength)}else return null}}class Mi{constructor(){this.isReliableSubProtocol=!0,this.name="json.reliable.webpubsub.azure.v1"}parseMessages(t){return xi(t)}writeMessage(t){return vi(t)}}const Si=()=>new Mi;class _i{constructor(t,i){this._socket=new WebSocket(t,i),this._socket.binaryType="arraybuffer"}onopen(t){this._socket.onopen=t}onclose(t){this._socket.onclose=i=>t(i.code,i.reason)}onerror(t){this._socket.onerror=i=>t(i)}onmessage(t){this._socket.onmessage=i=>t(i.data)}close(t,i){this._socket.close(t,i)}send(t,i){return new Promise((s,r)=>{try{this._socket.send(t),s()}catch(h){r(h)}})}isOpen(){return this._socket.readyState===WebSocket.OPEN}}class Ei{create(t,i){return new _i(t,i)}}async function Ti(c,t){if(t.aborted)throw new Jt("The operation was aborted.");let i;const s=new Promise((r,h)=>{i=()=>{h(new Jt("The operation was aborted."))},t.addEventListener("abort",i)});try{return await Promise.race([c,s])}finally{t.removeEventListener("abort",i)}}var Z;(function(c){c.Stopped="Stopped",c.Disconnected="Disconnected",c.Connecting="Connecting",c.Connected="Connected",c.Recovering="Recovering"})(Z||(Z={}));class Ii{nextAckId(){return this._ackId=this._ackId+1,this._ackId}constructor(t,i){this._quickSequenceAckDiff=300,this._activeTimeoutInMs=2e4,this._emitter=new ri,this._isStopping=!1,this._isInitialConnected=!1,typeof t=="string"?this._credential={getClientAccessUrl:t}:this._credential=t,i==null&&(i={}),this._buildDefaultOptions(i),this._options=i,this._messageRetryPolicy=new Se(this._options.messageRetryOptions),this._reconnectRetryPolicy=new Se(this._options.reconnectRetryOptions),this._protocol=this._options.protocol,this._groupMap=new Map,this._ackMap=new Map,this._sequenceId=new ki,this._state=Z.Stopped,this._ackId=0}async start(t){if(this._isStopping)throw new Error("Can't start a client during stopping");if(this._state!==Z.Stopped)throw new Error("Client can be only started when it's Stopped");let i;t&&(i=t.abortSignal),this._activeKeepaliveTask||(this._activeKeepaliveTask=this._getActiveKeepaliveTask());try{await this._startCore(i)}catch(s){throw this._changeState(Z.Stopped),this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0),this._isStopping=!1,s}}async _startFromRestarting(t){if(this._state!==Z.Disconnected)throw new Error("Client can be only restarted when it's Disconnected");try{z.verbose("Staring reconnecting."),await this._startCore(t)}catch(i){throw this._changeState(Z.Disconnected),i}}async _startCore(t){if(this._changeState(Z.Connecting),z.info("Staring a new connection"),this._sequenceId.reset(),this._isInitialConnected=!1,this._lastCloseEvent=void 0,this._lastDisconnectedMessage=void 0,this._connectionId=void 0,this._reconnectionToken=void 0,this._uri=void 0,typeof this._credential.getClientAccessUrl=="string"?this._uri=this._credential.getClientAccessUrl:this._uri=await this._credential.getClientAccessUrl({abortSignal:t}),typeof this._uri!="string")throw new Error(`The clientAccessUrl must be a string but currently it's ${typeof this._uri}`);await this._connectCore(this._uri)}stop(){this._state===Z.Stopped||this._isStopping||(this._isStopping=!0,this._wsClient&&this._wsClient.isOpen()?this._wsClient.close():this._isStopping=!1,this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0))}on(t,i){this._emitter.on(t,i)}off(t,i){this._emitter.removeListener(t,i)}_emitEvent(t,i){this._emitter.emit(t,i)}async sendEvent(t,i,s,r){return this._operationExecuteWithRetry(()=>this._sendEventAttempt(t,i,s,r),r==null?void 0:r.abortSignal)}async _sendEventAttempt(t,i,s,r){var h;if(!((h=r==null?void 0:r.fireAndForget)!==null&&h!==void 0?h:!1))return this._sendMessageWithAckId(p=>({kind:"sendEvent",dataType:s,data:i,ackId:p,event:t}),r==null?void 0:r.ackId,r==null?void 0:r.abortSignal);const a={kind:"sendEvent",dataType:s,data:i,event:t};return await this._sendMessage(a,r==null?void 0:r.abortSignal),{isDuplicated:!1}}async joinGroup(t,i){return this._operationExecuteWithRetry(()=>this._joinGroupAttempt(t,i),i==null?void 0:i.abortSignal)}async _joinGroupAttempt(t,i){const s=this._getOrAddGroup(t),r=await this._joinGroupCore(t,i);return s.isJoined=!0,r}async _joinGroupCore(t,i){return this._sendMessageWithAckId(s=>({group:t,ackId:s,kind:"joinGroup"}),i==null?void 0:i.ackId,i==null?void 0:i.abortSignal)}async leaveGroup(t,i){return this._operationExecuteWithRetry(()=>this._leaveGroupAttempt(t,i),i==null?void 0:i.abortSignal)}async _leaveGroupAttempt(t,i){const s=this._getOrAddGroup(t),r=await this._sendMessageWithAckId(h=>({group:t,ackId:h,kind:"leaveGroup"}),i==null?void 0:i.ackId,i==null?void 0:i.abortSignal);return s.isJoined=!1,r}async sendToGroup(t,i,s,r){return this._operationExecuteWithRetry(()=>this._sendToGroupAttempt(t,i,s,r),r==null?void 0:r.abortSignal)}async _sendToGroupAttempt(t,i,s,r){var h,f;const a=(h=r==null?void 0:r.fireAndForget)!==null&&h!==void 0?h:!1,p=(f=r==null?void 0:r.noEcho)!==null&&f!==void 0?f:!1;if(!a)return this._sendMessageWithAckId(w=>({kind:"sendToGroup",group:t,dataType:s,data:i,ackId:w,noEcho:p}),r==null?void 0:r.ackId,r==null?void 0:r.abortSignal);const b={kind:"sendToGroup",group:t,dataType:s,data:i,noEcho:p};return await this._sendMessage(b,r==null?void 0:r.abortSignal),{isDuplicated:!1}}_getWebSocketClientFactory(){return new Ei}async _trySendSequenceAck(){if(!this._protocol.isReliableSubProtocol)return;const[t,i]=this._sequenceId.tryGetSequenceId();if(t&&i!==null&&i!==void 0){const s={kind:"sequenceAck",sequenceId:i};try{await this._sendMessage(s)}catch{this._sequenceId.tryUpdate(i)}}}_connectCore(t){if(this._isStopping)throw new Error("Can't start a client during stopping");return new Promise((i,s)=>{const r=this._wsClient=this._getWebSocketClientFactory().create(t,this._protocol.name);r.onopen(()=>{if(this._isStopping){try{r.close()}catch{}s(new Error("The client is stopped"))}z.verbose("WebSocket connection has opened"),this._changeState(Z.Connected),this._protocol.isReliableSubProtocol&&(this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),this._sequenceAckTask=new _e(async()=>{await this._trySendSequenceAck()},1e3)),i()}),r.onerror(h=>{this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),s(h)}),r.onclose((h,f)=>{this._state===Z.Connected?(z.verbose("WebSocket closed after open"),this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),z.info(`WebSocket connection closed. Code: ${h}, Reason: ${f}`),this._lastCloseEvent={code:h,reason:f},this._handleConnectionClose.call(this)):(z.verbose("WebSocket closed before open"),s(new Error(`Failed to start WebSocket: ${h}`)))}),r.onmessage(h=>{const f=u=>{if(this._ackMap.has(u.ackId)){const m=this._ackMap.get(u.ackId);this._ackMap.delete(u.ackId);const _=u.error!=null&&u.error.name==="Duplicate";u.success||_?m.resolve({ackId:u.ackId,isDuplicated:_}):m.reject(new Ft("Failed to send message.",{ackId:u.ackId,errorDetail:u.error}))}},a=async u=>{if(this._connectionId=u.connectionId,this._reconnectionToken=u.reconnectionToken,!this._isInitialConnected){if(this._isInitialConnected=!0,this._options.autoRejoinGroups){const m=[];this._groupMap.forEach(_=>{_.isJoined&&m.push((async()=>{try{await this._joinGroupCore(_.name)}catch(M){this._safeEmitRejoinGroupFailed(_.name,M)}})())}),await Promise.all(m).catch(()=>{})}this._safeEmitConnected(u.connectionId,u.userId)}},p=u=>{this._lastDisconnectedMessage=u},b=u=>{if(u.sequenceId!=null){const m=this._sequenceId.tryUpdate(u.sequenceId);if(m===0)return;m>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitGroupMessage(u)},w=u=>{if(u.sequenceId!=null){const m=this._sequenceId.tryUpdate(u.sequenceId);if(m===0)return;m>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitServerMessage(u)};let g;try{let u;if(Array.isArray(h)?u=Buffer.concat(h):u=h,g=this._protocol.parseMessages(u),g===null)return}catch(u){throw z.warning("An error occurred while parsing the message from service",u),u}Array.isArray(g)||(g=[g]),g.forEach(u=>{try{switch(u.kind){case"ack":{f(u);break}case"connected":{a(u);break}case"disconnected":{p(u);break}case"groupData":{b(u);break}case"serverData":{w(u);break}}}catch(m){z.warning(`An error occurred while handling the message with kind: ${u.kind} from service`,m)}})})})}async _handleConnectionCloseAndNoRecovery(){this._state=Z.Disconnected,this._safeEmitDisconnected(this._connectionId,this._lastDisconnectedMessage),this._options.autoReconnect?await this._autoReconnect():await this._handleConnectionStopped()}async _autoReconnect(){let t=!1,i=0;try{for(;!this._isStopping;)try{await this._startFromRestarting(),t=!0;break}catch(s){z.warning("An attempt to reconnect connection failed.",s),i++;const r=this._reconnectRetryPolicy.nextRetryDelayInMs(i);if(r==null)break;z.verbose(`Delay time for reconnect attempt ${i}: ${r}`),await Dt(r).catch(()=>{})}}finally{t||this._handleConnectionStopped()}}_handleConnectionStopped(){this._isStopping=!1,this._state=Z.Stopped,this._safeEmitStopped()}_getActiveKeepaliveTask(){return new _e(async()=>{this._sequenceId.tryUpdate(0)},this._activeTimeoutInMs)}async _sendMessage(t,i){if(!this._wsClient||!this._wsClient.isOpen())throw new Error("The connection is not connected.");const s=this._protocol.writeMessage(t);await this._wsClient.send(s,i)}async _sendMessageWithAckId(t,i,s){i==null&&(i=this.nextAckId());const r=t(i);this._ackMap.has(i)||this._ackMap.set(i,new Ai(i));const h=this._ackMap.get(i);try{await this._sendMessage(r,s)}catch(f){this._ackMap.delete(i);let a="";throw f instanceof Error&&(a=f.message),new Ft(a,{ackId:i})}if(s)try{return await Ti(h.promise(),s)}catch(f){throw f instanceof Error&&f.name==="AbortError"?new Ft("Cancelled by abortSignal",{ackId:i}):f}return h.promise()}async _handleConnectionClose(){if(this._ackMap.forEach((r,h)=>{this._ackMap.delete(h)&&r.reject(new Ft("Connection is disconnected before receive ack from the service",{ackId:r.ackId}))}),this._isStopping){z.warning("The client is stopping state. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(this._lastCloseEvent&&this._lastCloseEvent.code===1008){z.warning("The websocket close with status code 1008. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(!this._protocol.isReliableSubProtocol){z.warning("The protocol is not reliable, recovery is not applicable"),this._handleConnectionCloseAndNoRecovery();return}const t=this._buildRecoveryUri();if(!t){z.warning("Connection id or reconnection token is not available"),this._handleConnectionCloseAndNoRecovery();return}let i=!1;this._state=Z.Recovering;const s=AbortSignal.timeout(30*1e3);try{for(;!s.aborted||this._isStopping;)try{await this._connectCore.call(this,t),i=!0;return}catch{await Dt(1e3)}}finally{i||(z.warning("Recovery attempts failed more then 30 seconds or the client is stopping"),this._handleConnectionCloseAndNoRecovery())}}_safeEmitConnected(t,i){this._emitEvent("connected",{connectionId:t,userId:i})}_safeEmitDisconnected(t,i){this._emitEvent("disconnected",{connectionId:t,message:i})}_safeEmitGroupMessage(t){this._emitEvent("group-message",{message:t})}_safeEmitServerMessage(t){this._emitEvent("server-message",{message:t})}_safeEmitStopped(){this._emitEvent("stopped",{})}_safeEmitRejoinGroupFailed(t,i){this._emitEvent("rejoin-group-failed",{group:t,error:i})}_buildDefaultOptions(t){return t.autoReconnect==null&&(t.autoReconnect=!0),t.autoRejoinGroups==null&&(t.autoRejoinGroups=!0),t.protocol==null&&(t.protocol=Si()),this._buildMessageRetryOptions(t),this._buildReconnectRetryOptions(t),t}_buildMessageRetryOptions(t){t.messageRetryOptions||(t.messageRetryOptions={}),(t.messageRetryOptions.maxRetries==null||t.messageRetryOptions.maxRetries<0)&&(t.messageRetryOptions.maxRetries=3),(t.messageRetryOptions.retryDelayInMs==null||t.messageRetryOptions.retryDelayInMs<0)&&(t.messageRetryOptions.retryDelayInMs=1e3),(t.messageRetryOptions.maxRetryDelayInMs==null||t.messageRetryOptions.maxRetryDelayInMs<0)&&(t.messageRetryOptions.maxRetryDelayInMs=3e4),t.messageRetryOptions.mode==null&&(t.messageRetryOptions.mode="Fixed")}_buildReconnectRetryOptions(t){t.reconnectRetryOptions||(t.reconnectRetryOptions={}),(t.reconnectRetryOptions.maxRetries==null||t.reconnectRetryOptions.maxRetries<0)&&(t.reconnectRetryOptions.maxRetries=Number.MAX_VALUE),(t.reconnectRetryOptions.retryDelayInMs==null||t.reconnectRetryOptions.retryDelayInMs<0)&&(t.reconnectRetryOptions.retryDelayInMs=1e3),(t.reconnectRetryOptions.maxRetryDelayInMs==null||t.reconnectRetryOptions.maxRetryDelayInMs<0)&&(t.reconnectRetryOptions.maxRetryDelayInMs=3e4),t.reconnectRetryOptions.mode==null&&(t.reconnectRetryOptions.mode="Fixed")}_buildRecoveryUri(){if(this._connectionId&&this._reconnectionToken&&this._uri){const t=new URL(this._uri);return t.searchParams.append("awps_connection_id",this._connectionId),t.searchParams.append("awps_reconnection_token",this._reconnectionToken),t.toString()}return null}_getOrAddGroup(t){return this._groupMap.has(t)||this._groupMap.set(t,new Ri(t)),this._groupMap.get(t)}_changeState(t){z.verbose(`The client state transfer from ${this._state.toString()} to ${t.toString()}`),this._state=t}async _operationExecuteWithRetry(t,i){let s=0;for(;;)try{return await t.call(this)}catch(r){s++;const h=this._messageRetryPolicy.nextRetryDelayInMs(s);if(h==null||(await Dt(h),i!=null&&i.aborted))throw r}}}class Se{constructor(t){this._retryOptions=t,this._maxRetriesToGetMaxDelay=Math.ceil(Math.log2(this._retryOptions.maxRetryDelayInMs)-Math.log2(this._retryOptions.retryDelayInMs)+1)}nextRetryDelayInMs(t){return t>this._retryOptions.maxRetries?null:this._retryOptions.mode==="Fixed"?this._retryOptions.retryDelayInMs:this._calculateExponentialDelay(t)}_calculateExponentialDelay(t){return t>=this._maxRetriesToGetMaxDelay?this._retryOptions.maxRetryDelayInMs:(1<<t-1)*this._retryOptions.retryDelayInMs}}class Ri{constructor(t){this.isJoined=!1,this.name=t}}class Ai{constructor(t){this._promise=new Promise((i,s)=>{this._resolve=i,this._reject=s}),this.ackId=t}promise(){return this._promise}resolve(t){this._resolve(t)}reject(t){this._reject(t)}}class ki{constructor(){this._sequenceId=0,this._isUpdate=!1}tryUpdate(t){if(this._isUpdate=!0,t>this._sequenceId){const i=t-this._sequenceId;return this._sequenceId=t,i}return 0}tryGetSequenceId(){return this._isUpdate?(this._isUpdate=!1,[!0,this._sequenceId]):[!1,null]}reset(){this._sequenceId=0,this._isUpdate=!1}}class _e{constructor(t,i,s){this._func=t,this._abortController=new AbortController,this._interval=i,this._obj=s,this._start()}abort(){try{this._abortController.abort()}catch{}}async _start(){const t=this._abortController.signal;for(;!t.aborted;)try{await this._func(this._obj)}catch{}finally{await Dt(this._interval)}}}class Ee{constructor(t){this.negotiateUrl=t,this.client=null,this.group=null,this.connected=!1,this.onDisc=[],this.onErr=[],this.mode="azure",this.bc=null,this.lastError=null,this.onMsgHandler=null,this.id=Math.random().toString(36).slice(2,8)}async connect(t){this.group=`room_${t}`;try{const i=await fetch(this.negotiateUrl,{credentials:"include"});if(!i.ok){const h=await i.text().catch(()=>"");throw this.lastError=`negotiate ${i.status}: ${h==null?void 0:h.slice(0,180)}`,new Error(this.lastError)}const{url:s}=await i.json().catch(()=>({url:null}));if(!s)throw new Error("no url");const r=new Ii(s);this.client=r,this.mode="azure",r.on("connected",()=>{this.connected=!0}),r.on("disconnected",()=>{this.connected=!1,this.onDisc.forEach(h=>h())}),r.on("stopped",()=>{this.connected=!1,this.onDisc.forEach(h=>h())}),r.on("group-message",({message:h})=>{var f;try{(f=this.onMsgHandler)==null||f.call(this,JSON.parse(String(h.data)))}catch{}}),await r.start(),await r.joinGroup(this.group),this.connected=!0}catch(i){this.lastError=(i==null?void 0:i.message)||String(i);const s=typeof window<"u"&&window.location.hostname||"";if(!(s==="localhost"||s==="127.0.0.1"||s.endsWith(".local")))throw this.onErr.forEach(h=>h(i)),i;try{this.mode="local",this.bc=new BroadcastChannel(this.group),this.bc.onmessage=h=>{var a;const f=h.data;try{(a=this.onMsgHandler)==null||a.call(this,f)}catch{}},this.connected=!0}catch{throw this.onErr.forEach(f=>f(i)),i}}}onMessage(t){this.onMsgHandler=t}onDisconnected(t){this.onDisc.push(t)}onError(t){this.onErr.push(t)}async send(t){if(!(!this.client||!this.connected||!this.group))try{this.mode==="azure"?await this.client.sendToGroup(this.group,JSON.stringify(t),"text"):this.mode==="local"&&this.bc&&this.bc.postMessage(t)}catch(i){this.onErr.forEach(s=>s(i))}}close(){var t;try{(t=this.bc)==null||t.close()}catch{}}getTransport(){return this.mode}getLastError(){return this.lastError}}class ee{constructor(t,i){this.p1=new At(80,140,26,26),this.p2=new At(120,220,26,26),this.obstacles=[],this.hud=new ie,this.s1=0,this.s2=0,this.speed=140,this.timeToNext=0,this.paused=!1,this.rt=null,this.bullets=[],this.enemyBullets=[],this.powerups=[],this.multishotUntil=0,this.bigshotUntil=0,this.slowmoUntil=0,this.magnetUntil=0,this.remoteHistory=[],this.sendAccum=0,this.toast=null,this.isLeader=!1,this.remoteId=null,this.reconnecting=!1,this.retries=0,this.unloadHandler=null,this.waiting=!0,this.bothReady=!1,this.presenceAccum=0,this.myId=null,this.lastMsgAt=0,this.starting=!1,this.startAt=0,this.lastCountdownSecond=0,this.trailAccum=0,this.particles=new $t,this.remoteParticles=new $t,this.roomId=t,this.name=i}async init(t){this.renderer=new se(t.canvas,t.ctx);const i="/api/negotiate";this.rt=new Ee(i);try{await this.rt.connect(this.roomId)}catch{this.toast={text:"Online: failed to connect",t:3};return}const s=this.rt.id;this.myId=s,this.rt.onMessage(r=>{if(this.lastMsgAt=performance.now(),r.type==="state"&&r.id!==s)this.remoteHistory.push({t:r.t,x:r.x,y:r.y,vy:r.vy,score:r.score,hp:r.hp,name:r.name}),this.remoteHistory.length>30&&this.remoteHistory.shift(),this.remoteName=r.name||this.remoteName;else if(r.type==="spawn"&&this.isLeader===!1){const h=t.canvas.height,f=80,a=t.canvas.width+f,p=r.topH,b=r.gap;this.speed=r.speed,this.obstacles.push(new rt(a,0,f,p,this.speed)),this.obstacles.push(new rt(a,p+b,f,h-(p+b),this.speed))}else if(r.type==="join"&&r.id!==s)this.remoteId=r.id,this.remoteName=r.name,this.isLeader=s<r.id,this.toast={text:`${r.name||"Opponent"} joined`,t:2.5},this.bothReady=!0,this.isLeader&&this.waiting&&setTimeout(()=>{var a;const f=performance.now()+2e3;(a=this.rt)==null||a.send({type:"start",id:s,roomId:this.roomId,t:performance.now(),startAt:f,delayMs:2e3}),this.startAt=f,this.waiting=!1,this.starting=!0,this.lastCountdownSecond=4},600);else if(r.type==="start"){const h=r.startAt,f=r.delayMs;typeof h=="number"?this.startAt=h:this.startAt=performance.now()+(typeof f=="number"?f:1500),this.waiting=!1,this.starting=!0,this.lastCountdownSecond=4}else if(r.type==="leave"&&r.id!==s)this.toast={text:"Opponent left",t:3},this.waiting=!0,this.bothReady=!1,this.remoteId=null;else if(r.type==="shoot"&&r.id!==s){const h=new Vt(r.x,r.y,r.vx,r.vy,"p2");r.w&&(h.width=r.w),r.h&&(h.height=r.h),r.color&&(h.color=r.color),this.enemyBullets.push(h)}else if(r.type==="powerSpawn"){const h=r.kind,f=new Yt(r.x,r.y,h);f.vx=r.vx,f.pid=r.pid,this.powerups.push(f)}else if(r.type==="pickup"){const h=r.pid,f=this.powerups.findIndex(a=>a.pid===h);f>=0&&this.powerups.splice(f,1)}}),this.toast={text:`Connected • Room ${this.roomId} • ${this.rt.getTransport().toUpperCase()}`,t:2.5},this.rt.send({type:"join",id:s,roomId:this.roomId,name:this.name}),this.rt.onDisconnected(()=>{this.toast={text:"Online: disconnected",t:3},!this.reconnecting&&this.retries<2&&(this.reconnecting=!0,this.retries++,setTimeout(()=>this.reconnect(i),1500))}),this.unloadHandler=r=>{var h;try{(h=this.rt)==null||h.send({type:"leave",id:s,roomId:this.roomId})}catch{}},window.addEventListener("beforeunload",this.unloadHandler)}dispose(){var t;try{this.rt&&this.myId&&this.rt.send({type:"leave",id:this.myId,roomId:this.roomId})}catch{}try{this.unloadHandler&&window.removeEventListener("beforeunload",this.unloadHandler)}catch{}try{(t=this.rt)==null||t.close()}catch{}}async reconnect(t){this.rt;const i=this.name;this.rt=new Ee(t);try{await this.rt.connect(this.roomId);const s=this.rt.id;this.toast={text:"Online: reconnected",t:2.5},this.rt.onMessage(r=>{if(this.lastMsgAt=performance.now(),r.type==="state"&&r.id!==s)this.remoteHistory.push({t:r.t,x:r.x,y:r.y,vy:r.vy,score:r.score,hp:r.hp,name:r.name}),this.remoteHistory.length>30&&this.remoteHistory.shift(),this.remoteName=r.name||this.remoteName;else if(r.type==="spawn"&&this.isLeader===!1){const h=this.renderer.canvas.height,f=80,a=this.renderer.canvas.width+f,p=r.topH,b=r.gap;this.speed=r.speed,this.obstacles.push(new rt(a,0,f,p,this.speed)),this.obstacles.push(new rt(a,p+b,f,h-(p+b),this.speed))}else r.type==="join"&&r.id!==s?(this.remoteId=r.id,this.remoteName=r.name,this.isLeader=s<r.id):r.type==="leave"&&r.id!==s&&(this.toast={text:"Opponent left",t:3})}),this.rt.onDisconnected(()=>{this.toast={text:"Online: disconnected",t:3}}),this.rt.send({type:"join",id:this.rt.id,roomId:this.roomId,name:i})}catch{this.toast={text:"Online: reconnection failed",t:3}}finally{this.reconnecting=!1}}update(t,i){var _,M,E;if(this.paused)return;if(this.waiting){this.rt&&this.myId&&(this.presenceAccum+=t,this.presenceAccum>=1&&(this.presenceAccum=0,this.rt.send({type:"join",id:this.myId,roomId:this.roomId,name:this.name})));return}if(this.starting){const v=performance.now(),S=Math.max(0,this.startAt-v),T=Math.ceil(S/1e3);if(T!==this.lastCountdownSecond)if(this.lastCountdownSecond=T,T>0){const I=800-(3-Math.min(3,T))*120;P.beep(I,.08,"triangle",.06)}else P.beep(1e3,.1,"square",.07);if(S<=0)this.starting=!1;else{this.particles.update(t),this.remoteParticles.update(t);return}}(i.input.wasPressed("Space")||i.input.wasPressed("ArrowUp"))&&(W.jump(this.p1),P.flap(),this.particles.burst(this.p1.x+this.p1.width*.2,this.p1.y+this.p1.height*.7,10,"#9bd1ff"));const s=i.input.getMovementDirection();this.p1.vx=s.x*80;const r=.35;(i.input.wasPressed("ShiftLeft")||i.input.wasPressed("KeyF"))&&this.p1.fireCooldown<=0&&(this.fireBullet(this.p1,"p1",i),this.p1.fireCooldown=r*(this.isRapid()?.55:1)),W.applyGravity(this.p1,t),this.p1.update(t);const h=i.canvas.height;if(this.p1.y=Math.max(0,Math.min(h-this.p1.height,this.p1.y)),this.rt){this.sendAccum+=t;const v=1/25;if(this.sendAccum>=v){this.sendAccum=0;const S={type:"state",id:this.rt.id,t:performance.now(),x:this.p1.x,y:this.p1.y,vy:this.p1.vy,score:this.s1,hp:this.p1.hp,name:this.name};this.rt.send(S)}}const a=performance.now()-100;for(;this.remoteHistory.length>=2&&this.remoteHistory[1].t<=a;)this.remoteHistory.shift();const p=this.remoteHistory[0],b=this.remoteHistory[1];if(p&&b){const v=(a-p.t)/Math.max(1,b.t-p.t),S=(T,I,R)=>T+(I-T)*Math.max(0,Math.min(1,R));this.p2.x=S(p.x,b.x,v),this.p2.y=S(p.y,b.y,v),this.p2.vy=S(p.vy,b.vy,v),this.s2=Math.max(p.score,b.score)}else p&&(this.p2.x=p.x,this.p2.y=p.y,this.p2.vy=p.vy,this.s2=p.score);this.trailAccum+=t;const w=(v,S,T)=>{this.particles.spawn(v,S,{vx:-40+Math.random()*20,vy:20+Math.random()*20,size:2.2,color:T+"cc",life:.35,g:150})};if(this.trailAccum>=.05&&(this.trailAccum=0,w(this.p1.x-4,this.p1.y+this.p1.height*.6,"#7cc1ff"),this.remoteParticles.spawn(this.p2.x-4,this.p2.y+this.p2.height*.6,{vx:-30+Math.random()*20,vy:20+Math.random()*15,size:2.2,color:"#ff9da0cc",life:.35,g:150})),this.particles.update(t),this.remoteParticles.update(t),this.timeToNext-=t,this.timeToNext<=0){this.speed=Math.min(260,this.speed+2);const v=Math.max(130,180-Math.max(this.s1,this.s2)*2);this.timeToNext=Math.max(1,1.7-Math.max(this.s1,this.s2)*.02);const S=40,T=h-v-40,I=Math.floor(Math.random()*(T-S+1))+S,R=80,k=i.canvas.width+R;if(this.isLeader&&(this.obstacles.push(new rt(k,0,R,I,this.speed)),this.obstacles.push(new rt(k,I+v,R,h-(I+v),this.speed)),(_=this.rt)==null||_.send({type:"spawn",id:this.rt.id,t:performance.now(),w:R,gap:v,topH:I,speed:this.speed}),Math.random()<.3)){const H=Ie(Math.max(this.s1,this.s2)),L=new Yt(k+140,Math.max(24,Math.min(h-40,I+v*.5-8)),H);L.vx=-Math.max(100,this.speed*.7);const D=`${Date.now()}-${Math.random().toString(36).slice(2,6)}`;L.pid=D,this.powerups.push(L),(M=this.rt)==null||M.send({type:"powerSpawn",id:this.rt.id,t:performance.now(),pid:D,kind:H,x:L.x,y:L.y,vx:L.vx})}}for(const v of this.obstacles)v.update(t);this.obstacles=this.obstacles.filter(v=>!v.isOffScreen());for(const v of this.powerups)v.update(t);this.powerups=this.powerups.filter(v=>!v.isOffScreen());for(const v of this.bullets)v.update(t);for(const v of this.enemyBullets)v.update(t);const g=i.canvas.width,u=i.canvas.height,m=(v,S)=>W.checkCollision({x:v.x,y:v.y,width:v.width,height:v.height},S);for(const v of this.bullets)for(const S of this.obstacles)m(v,S)&&(v.active=!1,P.combo(1));for(const v of this.enemyBullets)for(const S of this.obstacles)m(v,S)&&(v.active=!1);this.bullets=this.bullets.filter(v=>v.active&&!v.isOffScreen(g,u)),this.enemyBullets=this.enemyBullets.filter(v=>v.active&&!v.isOffScreen(g,u));for(let v=0;v<this.powerups.length;v++){const S=this.powerups[v];if(W.checkCollision(this.p1,S)){this.applyPowerUp(S.type);const T=S.pid;T&&((E=this.rt)==null||E.send({type:"pickup",id:this.rt.id,t:performance.now(),pid:T})),this.powerups.splice(v,1),v--,P.score()}}for(const v of this.obstacles)W.checkCollision&&W.checkCollision(this.p1,v)&&(this.p1.hp=Math.max(0,(this.p1.hp??3)-1),P.hit(),this.p1.hp<=0&&(this.paused=!0,this.toast={text:"You crashed!",t:3}));for(let v=0;v<this.obstacles.length;v+=2){const S=this.obstacles[v],T=S.x+S.width/2;S.counted!==!0&&T<this.p1.x&&(S.counted=!0,this.s1+=1,P.score())}}render(t,i){var m,_;if(this.renderer.clear(1/60),this.waiting){t.fillStyle="#e8e8f0",t.font="700 24px system-ui";const M=this.bothReady?"Found opponent! Starting…":`Waiting in room ${this.roomId}…`,E=t.measureText(M).width;t.fillText(M,Math.max(20,(i.canvas.width-E)/2),120),t.font="600 14px system-ui",t.fillStyle="#94a3b8";const v="Share the code with your friend. Game starts when they join.",S=t.measureText(v).width;t.fillText(v,Math.max(20,(i.canvas.width-S)/2),150);const T=(_=(m=this.rt)==null?void 0:m.getLastError)==null?void 0:_.call(m);if(T){t.fillStyle="#fca5a5",t.font="600 13px system-ui";const st=t.measureText(T).width;t.fillText(T,Math.max(20,(i.canvas.width-st)/2),170)}const R=`Connected players: ${1+(this.remoteId?1:0)}/2`;t.fillStyle="#cdd9e5",t.font="700 14px system-ui";const k=t.measureText(R).width,H=Math.max(20,(i.canvas.width-k)/2),L=180;t.fillText(R,H+18,L);const D=performance.now(),ht=D-this.lastMsgAt;let J="#ef4444";ht<2e3?J="#22c55e":ht<5e3&&(J="#facc15");const X=.6+.4*Math.sin(D/250);t.save(),t.fillStyle=J,t.beginPath(),t.arc(H+8,L-4,5*X,0,Math.PI*2),t.fill(),t.restore()}if(this.starting){const M=Math.max(0,this.startAt-performance.now()),E=Math.ceil(M/1e3);t.fillStyle="#e8e8f0",t.font="800 54px system-ui";const v=E>0?String(E):"GO!",S=t.measureText(v).width;t.fillText(v,(i.canvas.width-S)/2,i.canvas.height*.35)}this.renderer.drawPlayer(this.p1,"#58a6ff"),this.renderer.drawPlayer(this.p2,"#ff7b72"),this.particles.render(t),this.remoteParticles.render(t);for(const M of this.obstacles)this.renderer.drawObstacle(M);this.hud.render(t,this.s1,this.s2);const s=this.p1.fireCooldown>0?Math.min(1,this.p1.fireCooldown/.35):0,r=[],h=performance.now();h<this.multishotUntil&&r.push({label:"Multi",color:"#38bdf8",remain:(this.multishotUntil-h)/1e3}),h<this.bigshotUntil&&r.push({label:"Big",color:"#fb7185",remain:(this.bigshotUntil-h)/1e3}),h<this.slowmoUntil&&r.push({label:"Slow",color:"#a78bfa",remain:(this.slowmoUntil-h)/1e3}),h<this.magnetUntil&&r.push({label:"Mag",color:"#f472b6",remain:(this.magnetUntil-h)/1e3}),this.hud.renderStatus(t,16,52,s,r),t.fillStyle="#cdd9e5",t.font="700 12px system-ui",this.name&&t.fillText(this.name,this.p1.x,Math.max(12,this.p1.y-6)),this.remoteName&&t.fillText(this.remoteName,this.p2.x,Math.max(12,this.p2.y-6)),t.fillStyle="#94a3b8",t.font="600 12px system-ui";const f=this.isLeader?"Leader":"Follower",a=1+(this.remoteId?1:0),p=`Online • Room ${this.roomId} • ${f} • Players ${a}/2`;t.fillText(p,32,i.canvas.height-8);const b=performance.now(),w=b-this.lastMsgAt;let g="#ef4444";w<2e3?g="#22c55e":w<5e3&&(g="#facc15");const u=.6+.4*Math.sin(b/250);if(t.save(),t.fillStyle=g,t.beginPath(),t.arc(16,i.canvas.height-12,5*u,0,Math.PI*2),t.fill(),t.restore(),this.toast){this.toast.t-=1/60,t.save(),t.globalAlpha=Math.max(0,Math.min(1,this.toast.t/3)),t.fillStyle="#000000aa";const M=this.toast.text;t.font="700 16px system-ui";const E=t.measureText(M).width+20;t.fillRect(20,20,E,34),t.fillStyle="#e8e8f0",t.fillText(M,30,42),t.restore(),this.toast.t<=0&&(this.toast=null)}}isRapid(){const t=performance.now();return t<this.multishotUntil||t<this.bigshotUntil}fireBullet(t,i,s){const r=performance.now(),h=t.y+t.height*.5-2,f=420,a=i==="p1"?"#ffd166":"#ff7b72",p=performance.now()<this.bigshotUntil?1.6:1,b=(g,u)=>{var _;const m=new Vt(t.x+t.width,h,g,u,i);m.color=a,m.width=10*p,m.height=4*p,this.bullets.push(m),(_=this.rt)==null||_.send({type:"shoot",id:this.rt.id,t:r,x:m.x,y:m.y,vx:m.vx,vy:m.vy,w:m.width,h:m.height,color:a})};performance.now()<this.multishotUntil?(b(f,-40),b(f,0),b(f,40)):b(f,0)}applyPowerUp(t){const i=performance.now(),s=Ye[t];s&&(t==="heal"?this.p1.hp=Math.min(this.p1.maxHp,this.p1.hp+1):t==="shield"?(this.p1.maxHp+=1,this.p1.hp=Math.min(this.p1.maxHp,this.p1.hp+1)):t==="rapid"?this.multishotUntil=i+(s.duration??6)*1e3:t==="multishot"?this.multishotUntil=i+(s.duration??6)*1e3:t==="bigshot"?this.bigshotUntil=i+(s.duration??6)*1e3:t==="slowmo"?(this.slowmoUntil=i+(s.duration??3)*1e3,this.speed=Math.max(100,this.speed*.8)):t==="magnet"&&(this.magnetUntil=i+(s.duration??6)*1e3))}}class Bi{constructor(){this.t=0,this.onlineModalOpen=!1,this.modalCreateBtn=null,this.modalJoinBtn=null,this.modalCancelBtn=null,this.shareRoomCode=null,this.shareRoomName=null,this.btnS=null,this.btnV=null,this.btnVO=null,this.btnEditName=null}launchOnline(t){this.onlineModalOpen=!0}onResize(t){t.ctx.setTransform(1,0,0,1,0,0)}init(t){t.canvas.focus();try{const g=new URL(window.location.href),u=g.searchParams.get("room"),m=g.searchParams.get("name");u&&(this.shareRoomCode=u.toLowerCase(),m&&(this.shareRoomName=m),this.onlineModalOpen=!0)}catch{}let i=!1;const s=()=>{t.canvas.onpointerdown=null,t.canvas.ontouchstart=null,t.canvas.onclick=null,document.removeEventListener("touchstart",b),document.removeEventListener("pointerdown",p),document.removeEventListener("click",w)},r=(g,u=!1)=>{if(g&&u){this.launchOnline(t);return}this.onlineModalOpen||i||(i=!0,s(),t.setScene(g?new Xt:new kt))},h=g=>{try{g.stopPropagation()}catch{}if(this.btnS||this.btnV||this.btnEditName){const u=t.canvas.getBoundingClientRect(),m=t.canvas.width/u.width,_=t.canvas.height/u.height,M=(g.clientX-u.left)*m,E=(g.clientY-u.top)*_;if(this.onlineModalOpen){const v=S=>S&&M>=S.x&&M<=S.x+S.w&&E>=S.y&&E<=S.y+S.h;if(v(this.modalCreateBtn)){const S=et.getPlayerName()||this.shareRoomName||"Anon",T=typeof window<"u"&&window.prompt("Your name",S)||S;et.setPlayerName(T);const I=Math.random().toString(36).slice(2,6).toUpperCase();try{const R=new URL(window.location.href);R.searchParams.set("room",I.toLowerCase()),R.searchParams.delete("name");const k=R.toString();if(navigator.clipboard&&navigator.clipboard.writeText)(async()=>{try{await navigator.clipboard.writeText(k);try{window.alert(`Room code: ${I}
Invite link copied to clipboard!
${k}`)}catch{}}catch{try{window.alert(`Room code: ${I}
Share this link:
${k}`)}catch{}}})();else try{window.alert(`Room code: ${I}
Share this link:
${k}`)}catch{}}catch{}if(i)return;i=!0,s(),t.setScene(new ee(I.toLowerCase(),T));return}if(v(this.modalJoinBtn)){const S=et.getPlayerName()||this.shareRoomName||"Anon",T=typeof window<"u"&&window.prompt("Your name",S)||S;et.setPlayerName(T);let I=this.shareRoomCode||"";if(I||(I=((typeof window<"u"?window.prompt("Enter room code to join",""):"")||"").trim()),!I){this.onlineModalOpen=!1;return}if(i)return;i=!0,s(),t.setScene(new ee(I.toLowerCase(),T));return}if(v(this.modalCancelBtn)){this.onlineModalOpen=!1;return}return}if(this.btnS&&M>=this.btnS.x&&M<=this.btnS.x+this.btnS.w&&E>=this.btnS.y&&E<=this.btnS.y+this.btnS.h)return r(!1);if(this.btnV&&M>=this.btnV.x&&M<=this.btnV.x+this.btnV.w&&E>=this.btnV.y&&E<=this.btnV.y+this.btnV.h)return r(!0);if(this.btnVO&&M>=this.btnVO.x&&M<=this.btnVO.x+this.btnVO.w&&E>=this.btnVO.y&&E<=this.btnVO.y+this.btnVO.h)return r(!0,!0);if(this.btnEditName&&M>=this.btnEditName.x&&M<=this.btnEditName.x+this.btnEditName.w&&E>=this.btnEditName.y&&E<=this.btnEditName.y+this.btnEditName.h){try{const v=et.getPlayerName()||"Anon",S=typeof window<"u"?window.prompt("Your name",v):null;S!=null&&et.setPlayerName(S)}catch{}return}}r(!1)},f=g=>{var m;try{g.stopPropagation()}catch{}const u=((m=g.touches)==null?void 0:m.length)??0;r(u>=2)},a=g=>{try{g.stopPropagation()}catch{}r(!1)},p=g=>{this.onlineModalOpen||r(!1)},b=g=>{var m;const u=((m=g.touches)==null?void 0:m.length)??0;this.onlineModalOpen||r(u>=2)},w=g=>{this.onlineModalOpen||r(!1)};t.canvas.onpointerdown=h,t.canvas.ontouchstart=f,t.canvas.onclick=a,document.addEventListener("pointerdown",p,{passive:!0}),document.addEventListener("touchstart",b,{passive:!0}),document.addEventListener("click",w,{passive:!0})}update(t,i){this.t+=t,i.input.wasPressed("KeyS")&&i.setScene(new kt),i.input.wasPressed("KeyV")&&i.setScene(new Xt),i.input.wasPressed("KeyO")&&this.launchOnline(i),i.input.wasPressed("Escape")&&this.onlineModalOpen&&(this.onlineModalOpen=!1),i.input.wasPressed("KeyM")&&(P.muted=!P.muted),i.input.wasPressed("KeyR")&&it.toggleReducedMotion(),i.input.wasPressed("KeyC")&&et.clear();const{ctx:s}=i,r=i.canvas.width,h=i.canvas.height,f=s.createLinearGradient(0,0,0,h);f.addColorStop(0,"#0b1023"),f.addColorStop(1,"#1a2247"),s.fillStyle=f,s.fillRect(0,0,r,h),s.save(),s.globalAlpha=.2;for(let U=0;U<60;U++){const G=U*91%r,O=U*53%h;s.fillStyle=U%2?"#d0e0ff":"#a0b8ff",s.fillRect(G,O+(Math.sin(this.t+U)*2+2)|0,2,2)}s.restore();const a=Math.sin(this.t*2)*6;s.textBaseline="top";const p="CrappBird";s.font="900 72px system-ui, ui-sans-serif, -apple-system, Segoe UI";const b=s.measureText(p).width,w=Math.max(24,(r-b)/2),g=56+a,u=s.createLinearGradient(w,g,w,g+72);u.addColorStop(0,"#e6f0ff"),u.addColorStop(1,"#9cc9ff"),s.save(),s.shadowColor="#3b82f6aa",s.shadowBlur=18,s.fillStyle=u,s.fillText(p,w,g),s.restore(),s.strokeStyle="#58a6ff",s.lineWidth=5,s.beginPath(),s.moveTo(w,g+72+6),s.lineTo(w+Math.min(520,b*.65),g+72+6),s.stroke();const m=w-80,_=g+10,M=18,E=Math.sin(this.t*10)*.6;s.fillStyle="#58a6ff",s.beginPath(),s.arc(m,_,M,0,Math.PI*2),s.fill(),s.fillStyle="#ffffffaa",s.beginPath(),s.arc(m-M*.2,_+M*.1,M*.7,Math.PI*.1,Math.PI*1.2),s.fill(),s.save(),s.translate(m-M*.2,_),s.rotate(-.8+E),s.fillStyle="#00000022",s.beginPath(),s.ellipse(0,0,M*.9,M*.5,0,0,Math.PI*2),s.fill(),s.restore(),s.fillStyle="#ffd166",s.beginPath(),s.moveTo(m+M*.9,_),s.lineTo(m+M*1.4,_-M*.2),s.lineTo(m+M*.9,_+M*.2),s.closePath(),s.fill(),s.fillStyle="#fff",s.beginPath(),s.arc(m+M*.2,_-M*.3,M*.22,0,Math.PI*2),s.fill(),s.fillStyle="#000",s.beginPath(),s.arc(m+M*.25,_-M*.3,M*.1,0,Math.PI*2),s.fill(),s.save();const v=s.createRadialGradient(r/2,h/2,Math.min(r,h)*.2,r/2,h/2,Math.max(r,h)*.6);v.addColorStop(0,"rgba(0,0,0,0)"),v.addColorStop(1,"rgba(0,0,0,0.35)"),s.fillStyle=v,s.fillRect(0,0,r,h),s.restore();const S=Math.min(560,r-64),T=170,I=(r-S)/2;s.fillStyle="#0f172ae6",s.beginPath(),s.roundRect(I,T,S,150,14),s.fill(),s.fillStyle="#cdd9e5",s.font="700 22px system-ui",s.fillText("Play",I+16,T+16);const R=18,k=44,H=16,L=3,D=Math.floor((S-H*2-R*(L-1))/L),ht=D*L+R*(L-1),J=I+Math.max(H,(S-ht)/2),X=T+56,st=(U,G,O,q)=>{s.fillStyle="#15223f",s.strokeStyle="#58a6ffaa",s.lineWidth=3,s.beginPath(),s.roundRect(U,G,D,k,10),s.fill(),s.stroke(),q&&(s.fillStyle="#9cc9ff",s.font="700 18px system-ui",s.fillText(q,U+12,G+28)),s.fillStyle="#e8e8f0",s.font="600 18px system-ui",s.fillText(O,U+(q?36:14),G+28)};st(J,X,"S — Singleplayer","🎮"),st(J+D+R,X,"V — Versus (Local)","🤝"),st(J+(D+R)*2,X,"O — Versus (Online)","🌐"),this.btnS={x:J,y:X,w:D,h:k},this.btnV={x:J+D+R,y:X,w:D,h:k},this.btnVO={x:J+(D+R)*2,y:X,w:D,h:k};const ft=T+170,vt=Math.min(760,r-64),ut=(r-vt)/2;s.fillStyle="#0f172acc",s.beginPath(),s.roundRect(ut,ft,vt,160,14),s.fill(),s.fillStyle="#cdd9e5",s.font="700 20px system-ui",s.fillText("Controls",ut+16,ft+16),s.font="500 16px system-ui";let dt=ft+46;s.fillText("Singleplayer: Flap = Space/ArrowUp/W or Click/Tap • Move = ArrowLeft/Right or A/D • Shoot = Right Click or Ctrl/J (hold)",ut+16,dt),dt+=28,s.fillText("Versus (Local): P1 = Arrows + Space • P2 = W (flap), S (nudge down)",ut+16,dt),dt+=28,s.fillText(`Online: O — create or join room • Mute = M (${P.muted?"Muted":"Sound on"}) • Reduced motion = R (${it.reducedMotion?"On":"Off"}) • Esc returns here`,ut+16,dt);const Mt=ft+170,Bt=Math.min(760,r-64),St=(r-Bt)/2;s.fillStyle="#0f172acc",s.beginPath(),s.roundRect(St,Mt,Bt,130,14),s.fill(),s.fillStyle="#cdd9e5",s.font="700 20px system-ui",s.fillText("Power-ups",St+16,Mt+16),s.font="500 14px system-ui";let j=Mt+44;const K=[["+ Heal","gain 1 heart"],["R Rapid","shorter cooldown"],["S Shield","+1 max heart and heal"],["M Multishot","fires 3 bullets"],["B Bigshot","bigger bullets, +1 dmg"],["⌛ Slowmo","world slows briefly"],["U Magnet","pulls pickups nearby"]];for(const[U,G]of K)s.fillText(`${U} — ${G}`,St+16,j),j+=20;const pt=et.getTop(5);if(pt.length){const U=Math.min(420,r-40),G=28+pt.length*22+20,O=(r-U)/2,q=h-G-80;s.fillStyle="#0f172acc",s.beginPath(),s.roundRect(O,q,U,G,10),s.fill(),s.fillStyle="#cdd9e5",s.font="700 16px system-ui",s.fillText("Top Scores",O+12,q+20),s.font="500 14px system-ui";for(let at=0;at<pt.length;at++){const mt=pt[at],lt=`${at+1}. ${(mt.name||"Anon").slice(0,18)} — ${mt.score}`;s.fillText(lt,O+12,q+44+at*22)}s.font="400 12px system-ui",s.fillStyle="#94a3b8",s.fillText("Press C to clear • Name is saved locally",O+12,q+G-10);const yt=92,Q=22,V=O+U-yt-10,Y=q+10;s.fillStyle="#15223f",s.strokeStyle="#58a6ff88",s.lineWidth=2,s.beginPath(),s.roundRect(V,Y,yt,Q,6),s.fill(),s.stroke(),s.fillStyle="#e8e8f0",s.font="600 12px system-ui",s.fillText("Edit name",V+12,Y+15),this.btnEditName={x:V,y:Y,w:yt,h:Q}}const Ct=.5+.5*Math.sin(this.t*3);s.save(),s.globalAlpha=.6+.4*Ct,s.fillStyle="#7dd3fc",s.font="700 18px system-ui";const _t="Tap to start • Starts easy, ramps up • Two-finger tap for Versus (S/V)",Pt=s.measureText(_t).width;if(s.fillText(_t,Math.max(20,(r-Pt)/2),h-60),s.restore(),this.onlineModalOpen){s.save(),s.fillStyle="rgba(0,0,0,0.5)",s.fillRect(0,0,r,h);const U=Math.min(420,r-40),G=200,O=(r-U)/2,q=Math.max(60,h*.25);s.fillStyle="#0f172ae6",s.beginPath(),s.roundRect(O,q,U,G,12),s.fill(),s.strokeStyle="#58a6ff55",s.stroke(),s.fillStyle="#cdd9e5",s.font="700 20px system-ui",s.fillText("Online Match",O+16,q+16),s.font="500 14px system-ui",s.fillStyle="#94a3b8";const yt=this.shareRoomCode?`You were invited to room ${this.shareRoomCode.toUpperCase()}. Join to continue.`:"Create a room to host, or join with a code from a friend.";s.fillText(yt,O+16,q+44);const Q=(U-16*3)/2,V=40,Y=q+G-V-20;s.fillStyle="#15223f",s.strokeStyle="#58a6ffaa",s.lineWidth=3,s.beginPath(),s.roundRect(O+16,Y,Q,V,10),s.fill(),s.stroke(),s.fillStyle="#e8e8f0",s.font="600 16px system-ui",s.fillText("Create Room",O+16+14,Y+26),this.modalCreateBtn={x:O+16,y:Y,w:Q,h:V},s.fillStyle="#15223f",s.strokeStyle="#58a6ffaa",s.lineWidth=3,s.beginPath(),s.roundRect(O+16*2+Q,Y,Q,V,10),s.fill(),s.stroke(),s.fillStyle="#e8e8f0",s.font="600 16px system-ui";const at=this.shareRoomCode?`Join Room ${this.shareRoomCode.toUpperCase()}`:"Join Room";s.fillText(at,O+16*2+Q+14,Y+26),this.modalJoinBtn={x:O+16*2+Q,y:Y,w:Q,h:V},s.fillStyle="#9cc9ff",s.font="600 14px system-ui";const mt="Cancel (Esc)",lt=s.measureText(mt).width,Lt=O+U-lt-16,Ut=q+16;s.fillText(mt,Lt,Ut+2),this.modalCancelBtn={x:Lt-6,y:Ut-6,w:lt+12,h:24},s.restore()}else this.modalCreateBtn=this.modalJoinBtn=this.modalCancelBtn=null}render(){}}const le=document.getElementById("gameCanvas");le.style.width="100vw";le.style.height="100vh";const Et=new He(le);let $e="title";const Tt=c=>{switch($e=c,c){case"title":Et.setScene(new Bi);break;case"single":Et.setScene(new kt);break;case"versus":Et.setScene(new Xt);break;case"versusOnline":{const t="Anon",i="test";Et.setScene(new ee(i,t));break}}};Tt("title");window.addEventListener("keydown",c=>{$e==="title"?(c.code==="KeyS"&&Tt("single"),c.code==="KeyV"&&Tt("versus"),c.code==="KeyO"&&Tt("versusOnline")):c.code==="Escape"&&Tt("title")});window.addEventListener("resize",()=>Et.resizeToDisplay());
