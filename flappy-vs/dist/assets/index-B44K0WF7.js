(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const f of o)if(f.type==="childList")for(const u of f.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&s(u)}).observe(document,{childList:!0,subtree:!0});function i(o){const f={};return o.integrity&&(f.integrity=o.integrity),o.referrerPolicy&&(f.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?f.credentials="include":o.crossOrigin==="anonymous"?f.credentials="omit":f.credentials="same-origin",f}function s(o){if(o.ep)return;o.ep=!0;const f=i(o);fetch(o.href,f)}})();class He{constructor(){this.down=new Set,this.pressedThisFrame=new Set,window.addEventListener("keydown",t=>{this.down.has(t.code)||this.pressedThisFrame.add(t.code),this.down.add(t.code),["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","KeyW","KeyA","KeyS","KeyD"].includes(t.code)&&t.preventDefault()},{passive:!1}),window.addEventListener("keyup",t=>this.down.delete(t.code))}beginFrame(){this.pressedThisFrame.clear()}endFrame(){}isDown(t){return this.down.has(t)}wasPressed(t){return this.pressedThisFrame.has(t)}getMovementDirection(){return{x:(this.isDown("ArrowRight")?1:0)+(this.isDown("ArrowLeft")?-1:0),y:(this.isDown("ArrowDown")?1:0)+(this.isDown("ArrowUp")?-1:0)}}getWASDHorizontal(){return(this.isDown("KeyD")?1:0)+(this.isDown("KeyA")?-1:0)}}class Ke{constructor(t){this.lastTime=0,this.running=!1,this.scene=null,this.loop=s=>{if(!this.running||!this.scene)return;const o=Math.min(1/30,(s-this.lastTime)/1e3);this.lastTime=s,this.input.beginFrame(),this.scene.update(o,this),this.scene.render(this.ctx,this),this.input.endFrame(),requestAnimationFrame(this.loop)},this.canvas=t;const i=t.getContext("2d");if(!i)throw new Error("2D context not available");this.ctx=i,this.input=new He,this.resizeToDisplay()}resizeToDisplay(){var f,u;const t=Math.max(1,Math.min(window.devicePixelRatio||1,2)),i=this.canvas.getBoundingClientRect(),s=Math.floor(i.width*t)||800,o=Math.floor(i.height*t)||600;(this.canvas.width!==s||this.canvas.height!==o)&&(this.canvas.width=s,this.canvas.height=o),this.ctx.setTransform(1,0,0,1,0,0),(u=(f=this.scene)==null?void 0:f.onResize)==null||u.call(f,this)}setScene(t){this.scene=t,t.init(this),this.running||(this.running=!0,this.lastTime=performance.now(),requestAnimationFrame(this.loop))}}class kt{constructor(t=50,i=50,s=28,o=28,f){this.vx=0,this.vy=0,this._score=0,this.hp=3,this.maxHp=3,this.fireCooldown=0,this.x=t,this.y=i,this.width=s,this.height=o}setPosition(t,i){this.x=t,this.y=i}passObstacle(){this._score+=1}update(t){this.x+=this.vx*t,this.y+=this.vy*t,this.fireCooldown>0&&(this.fireCooldown=Math.max(0,this.fireCooldown-t))}get score(){return Math.max(0,this._score)}set score(t){this._score=Math.max(0,t)}}class ft{constructor(t,i,s,o,f=120){this.x=t,this.y=i,this.width=s,this.height=o,this.speed=f}update(t){this.x-=this.speed*t}isOffScreen(){return this.x+this.width<0}}class ie{render(t,i,s,o,f){t.fillStyle="#e8e8f0",t.font="700 20px system-ui, sans-serif",typeof s=="number"?t.fillText(`P1: ${i}   P2: ${s}`,16,24):t.fillText(`Score: ${i}`,16,24);const u=(a,y,d)=>{if(d!=null)for(let w=0;w<d;w++){t.fillStyle="#ff7b72",t.beginPath();const m=w*18;t.moveTo(a+m+6,y+10),t.arc(a+m+3,y+8,3,0,Math.PI),t.arc(a+m+9,y+8,3,0,Math.PI),t.lineTo(a+m+6,y+14),t.closePath(),t.fill()}};u(16,36,o),f!=null&&u(120,36,f)}renderStatus(t,i,s,o,f){if(typeof o=="number"){const u=Math.max(0,Math.min(1,o)),a=120,y=6;t.fillStyle="#334155",t.fillRect(i,s,a,y),t.fillStyle="#facc15",t.fillRect(i,s,a*(1-u),y),t.strokeStyle="#0f172a",t.strokeRect(i-.5,s-.5,a+1,y+1)}if(f&&f.length){let u=0;for(const a of f){const y=a.remain?`${a.label} ${Math.ceil(a.remain)}`:a.label;t.font="700 10px system-ui, sans-serif";const d=t.measureText(y).width,w=6,m=6;t.fillStyle=a.color||"#94a3b8",t.beginPath(),t.roundRect(i+u,s+10,d+w*2,16,m),t.fill(),t.fillStyle="#0f172a",t.fillText(y,i+u+w,s+10+12),u+=d+w*2+6}}}}const Mt=class Mt{static applyGravity(t,i){t.vy+=Mt.gravity*i}static jump(t){t.vy=Mt.jumpVelocity}static checkCollision(t,i){return!(t.x+t.width<i.x||t.x>i.x+i.width||t.y+t.height<i.y||t.y>i.y+i.height)}};Mt.gravity=900,Mt.jumpVelocity=-300;let j=Mt;class se{constructor(t,i){this.canvas=t,this.ctx=i,this.t=0,this.cloudOffset=0}clear(t=0){const{ctx:i}=this,s=this.canvas.width,o=this.canvas.height;this.t+=t,this.cloudOffset=(this.cloudOffset+t*20)%(s+200);const f=i.createLinearGradient(0,0,0,o);f.addColorStop(0,"#0f1630"),f.addColorStop(1,"#0b1022"),i.fillStyle=f,i.fillRect(0,0,s,o);const u=(a,y,d)=>{i.fillStyle="#ffffff14",i.beginPath(),i.roundRect(a,y,120*d,40*d,20*d),i.fill()};for(let a=0;a<4;a++){const y=s-(this.cloudOffset+a*180)%(s+200),d=40+a*45%(o*.5);u(y,d,1)}i.fillStyle="#1a2446",i.fillRect(0,o-20,s,20),i.fillStyle="#111a36";for(let a=0;a<s;a+=16)i.fillRect(a,o-22,8,2)}drawBird(t,i){const{ctx:s}=this,o=Math.min(t.width,t.height)/2,f=t.x+o,u=t.y+o,a=Math.sin(this.t*10)*.6;s.fillStyle=i,s.beginPath(),s.arc(f,u,o,0,Math.PI*2),s.fill(),s.fillStyle="#ffffff88",s.beginPath(),s.arc(f-o*.2,u+o*.1,o*.7,Math.PI*.1,Math.PI*1.2),s.fill(),s.save(),s.translate(f-o*.2,u),s.rotate(-.8+a),s.fillStyle="#00000022",s.beginPath(),s.ellipse(0,0,o*.9,o*.5,0,0,Math.PI*2),s.fill(),s.restore(),s.fillStyle="#ffd166",s.beginPath(),s.moveTo(f+o*.9,u),s.lineTo(f+o*1.4,u-o*.2),s.lineTo(f+o*.9,u+o*.2),s.closePath(),s.fill(),s.fillStyle="#fff",s.beginPath(),s.arc(f+o*.2,u-o*.3,o*.22,0,Math.PI*2),s.fill(),s.fillStyle="#000",s.beginPath(),s.arc(f+o*.25,u-o*.3,o*.1,0,Math.PI*2),s.fill()}drawPlayer(t,i="#58a6ff"){this.drawBird(t,i)}drawObstacle(t){const{ctx:i}=this,s=i.createLinearGradient(t.x,t.y,t.x+t.width,t.y);s.addColorStop(0,"#2bc072"),s.addColorStop(1,"#3be688"),i.fillStyle=s,i.fillRect(t.x,t.y,t.width,t.height),i.fillStyle="#ffffff18",i.fillRect(t.x+6,t.y,6,t.height)}drawHUD(t){this.ctx.fillStyle="#e8e8f0",this.ctx.font="700 24px system-ui, sans-serif",this.ctx.fillText(t,16,32)}drawProjectile(t,i="#ffd166"){const{ctx:s}=this;s.fillStyle=t.color||i,s.fillRect(t.x,t.y,t.width,t.height)}drawEnemy(t){const{ctx:i}=this,s=t.variant||"drone";s==="tank"?(i.fillStyle="#c65353",i.beginPath(),i.roundRect(t.x,t.y,t.width,t.height,4),i.fill(),i.fillStyle="#00000055",i.fillRect(t.x+3,t.y+t.height-6,t.width-6,4)):s==="bee"?(i.fillStyle="#ffd166",i.beginPath(),i.ellipse(t.x+t.width/2,t.y+t.height/2,t.width/2,t.height/2,0,0,Math.PI*2),i.fill(),i.fillStyle="#00000066",i.fillRect(t.x+4,t.y+4,t.width-8,4),i.fillRect(t.x+4,t.y+10,t.width-8,4)):s==="kamikaze"?(i.fillStyle="#ff7b72",i.beginPath(),i.ellipse(t.x+t.width/2,t.y+t.height/2,t.width/2,t.height/2,0,0,Math.PI*2),i.fill(),i.fillStyle="#ffffffaa",i.beginPath(),i.arc(t.x+t.width/2+3,t.y+t.height/2-2,3,0,Math.PI*2),i.fill()):(i.fillStyle="#ff7b72",i.beginPath(),i.ellipse(t.x+t.width/2,t.y+t.height/2,t.width/2,t.height/2,0,0,Math.PI*2),i.fill(),i.fillStyle="#00000055",i.fillRect(t.x+2,t.y+2,t.width-4,3))}drawPowerUp(t){const{ctx:i}=this,s={heal:"#7ee787",rapid:"#f7b84a",shield:"#8b8efb",multishot:"#38bdf8",bigshot:"#fb7185",slowmo:"#a78bfa",magnet:"#f472b6"};i.fillStyle=s[t.type]||"#f7b84a",i.beginPath(),i.roundRect(t.x,t.y,t.width,t.height,4),i.fill(),i.fillStyle="#0f172a",i.font="700 10px system-ui";const o=t.x+t.width/2,f=t.y+t.height/2+3,a={heal:"+",rapid:"R",shield:"S",multishot:"M",bigshot:"B",slowmo:"⌛",magnet:"U"}[t.type]||"?",y=i.measureText(a).width;i.fillText(a,o-y/2,f)}}class qe{constructor(){this.ctx=null,this._muted=!1}get muted(){return this._muted}set muted(t){this._muted=t;try{localStorage.setItem("mute",t?"1":"0")}catch{}}ensure(){this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext))}beep(t,i=.08,s="sine",o=.05){if(this._muted)return;this.ensure();const f=this.ctx,u=f.createOscillator(),a=f.createGain();u.type=s,u.frequency.value=t,a.gain.value=o,u.connect(a).connect(f.destination);const y=f.currentTime;u.start(y),u.stop(y+i)}flap(){this.beep(660,.05,"square",.05)}score(){this.beep(880,.08,"triangle",.06)}hit(){this.beep(120,.15,"sawtooth",.08)}combo(t){if(this._muted)return;const i=900+Math.min(4,t)*80;this.beep(i,.05,"triangle",.05)}}const L=new qe;try{L.muted=localStorage.getItem("mute")==="1"}catch{}class $t{constructor(){this.pool=[],this.active=[]}spawn(t,i,s){const o=this.pool.pop()||{x:t,y:i,vx:0,vy:0,life:.5,maxLife:.5,size:3,color:"#fff"};o.x=t,o.y=i,o.vx=(s==null?void 0:s.vx)??Math.random()*80-40,o.vy=(s==null?void 0:s.vy)??Math.random()*-80,o.life=(s==null?void 0:s.life)??.5,o.maxLife=o.life,o.size=(s==null?void 0:s.size)??3,o.color=(s==null?void 0:s.color)??"#ffffff88",o.g=(s==null?void 0:s.g)??200,this.active.push(o)}burst(t,i,s,o){for(let f=0;f<s;f++)this.spawn(t,i,{color:o,size:2+Math.random()*2,life:.4+Math.random()*.3})}update(t){for(let i=this.active.length-1;i>=0;i--){const s=this.active[i];s.vy+=(s.g||0)*t,s.x+=s.vx*t,s.y+=s.vy*t,s.life-=t,s.life<=0&&(this.pool.push(s),this.active.splice(i,1))}}render(t){for(const i of this.active){const s=Math.max(0,i.life/i.maxLife);t.fillStyle=i.color.replace(/\d?\.?\d*\)$/,"")||i.color,t.globalAlpha=s,t.beginPath(),t.arc(i.x,i.y,i.size,0,Math.PI*2),t.fill(),t.globalAlpha=1}}}function Ee(l){return l===2?"shoot":"flap"}class Vt{constructor(t,i,s,o,f="player"){this.width=10,this.height=4,this.active=!0,this.damage=1,this.x=t,this.y=i,this.vx=s,this.vy=o,this.owner=f}update(t){this.x+=this.vx*t,this.y+=this.vy*t}isOffScreen(t,i){return this.x>t+20||this.x+this.width<-20||this.y>i+20||this.y+this.height<-20}}class Ve{constructor(t,i,s=-120,o=0,f="drone"){this.x=t,this.y=i,this.vx=s,this.vy=o,this.variant=f,f==="tank"?(this.width=34,this.height=26,this.health=3):(this.width=24,this.height=18,this.health=1)}update(t){this.x+=this.vx*t,this.y+=this.vy*t}isOffScreen(){return this.x+this.width<-40}}class Yt{constructor(t,i,s){this.width=16,this.height=16,this.vx=-80,this.vy=0,this.x=t,this.y=i,this.type=s}update(t){this.x+=this.vx*t,this.y+=this.vy*t}isOffScreen(){return this.x+this.width<-40}}const Re="scores:v1",Kt="playerName";function fe(){try{const l=localStorage.getItem(Re);if(!l)return[];const t=JSON.parse(l);return Array.isArray(t)?t.map(i=>({score:Number(i.score)||0,date:Number(i.date)||Date.now(),name:typeof i.name=="string"?i.name:void 0})).filter(i=>i.score>=0&&Number.isFinite(i.date)):[]}catch{return[]}}function ue(l){try{localStorage.setItem(Re,JSON.stringify(l))}catch{}}const at={addScore(l,t=Date.now(),i){const s=fe(),o=(i??localStorage.getItem(Kt)??"Anon").toString().slice(0,18).trim()||"Anon";s.push({score:Math.max(0,Math.floor(l)),date:t,name:o}),s.sort((u,a)=>a.score-u.score||a.date-u.date);const f=s.slice(0,10);ue(f)},getTop(l=5){const t=fe();return t.sort((i,s)=>s.score-i.score||s.date-i.date),t.slice(0,l)},clear(){ue([])},getPlayerName(){try{return localStorage.getItem(Kt)}catch{return null}},setPlayerName(l){try{localStorage.setItem(Kt,(l||"").toString().slice(0,18).trim()||"Anon")}catch{}}},It=class It{constructor(){var t;this._reducedMotion=!1,this._usingSystemPreference=!0;try{const i=localStorage.getItem(It.STORAGE_KEY);if(i!=null)this._reducedMotion=i==="1",this._usingSystemPreference=!1;else if(typeof window<"u"&&"matchMedia"in window){const s=window.matchMedia("(prefers-reduced-motion: reduce)");this._reducedMotion=s.matches,this._usingSystemPreference=!0;try{(t=s.addEventListener)==null||t.call(s,"change",o=>{this._usingSystemPreference&&(this._reducedMotion=o.matches)})}catch{}}}catch{}}get reducedMotion(){return this._reducedMotion}set reducedMotion(t){this._reducedMotion=t,this._usingSystemPreference=!1;try{localStorage.setItem(It.STORAGE_KEY,t?"1":"0")}catch{}}toggleReducedMotion(){this.reducedMotion=!this.reducedMotion}};It.STORAGE_KEY="reducedMotion";let Xt=It;const lt=new Xt,Ye={heal:{color:"#7ee787",glyph:"+",label:"Heal",description:"Gain 1 heart"},shield:{color:"#8b8efb",glyph:"S",label:"Shield",description:"+1 max heart and heal"},rapid:{color:"#f7b84a",glyph:"R",label:"Rapid",description:"Shorter cooldown",duration:8,cooldownMul:.55},multishot:{color:"#38bdf8",glyph:"M",label:"Multi",description:"Fires 3 bullets",duration:8},bigshot:{color:"#fb7185",glyph:"B",label:"Big",description:"Bigger bullets, +1 dmg",duration:8},slowmo:{color:"#a78bfa",glyph:"⌛",label:"Slow",description:"World slows briefly",duration:3.5},magnet:{color:"#f472b6",glyph:"U",label:"Mag",description:"Pulls pickups nearby",duration:8}};function Ie(l,t=Math.random){let i={heal:2.2,shield:1.6,rapid:1.2,multishot:1,bigshot:.9,slowmo:.9,magnet:1};if(l<5)i.multishot*=.3,i.bigshot*=.3,i.slowmo*=.4,i.magnet*=.5,i.heal*=1.3,i.shield*=1.2;else if(l<15){const u=(l-5)/10;i.multishot*=.3+.7*u,i.bigshot*=.3+.7*u,i.slowmo*=.4+.6*u,i.magnet*=.5+.5*u}else i.rapid*=1.1,i.multishot*=1.15,i.bigshot*=1.1;const s=Object.entries(i).filter(([u,a])=>a>0),o=s.reduce((u,[,a])=>u+a,0);let f=t()*o;for(const[u,a]of s)if(f-=a,f<=0)return u;return s[s.length-1][0]}const At=class At{constructor(){this.player=new kt(80,150,26,26),this.obstacles=[],this.hud=new ie,this.timeToNext=0,this.score=0,this.best=0,this.gameOver=!1,this.paused=!1,this.speed=120,this.particles=new $t,this.shakeT=0,this.hintT=4,this.bullets=[],this.enemies=[],this.powerUps=[],this.enemyTimer=0,this.powerTimer=5,this.lastGapCenter=null,this.floats=[],this.playerName=null,this.hurtT=0,this.combo=0,this.comboT=0,this.ended=!1,this.multishotT=0,this.bigshotT=0,this.slowmoT=0,this.magnetT=0,this.rapidT=0,this.pickupBadgeT=0,this.mobileMoveX=0,this.isTouch="ontouchstart"in window,this.btnLeftDown=!1,this.btnRightDown=!1,this.btnShootDown=!1,this.btnRects=null,this.restartRect=null}init(t){this.renderer=new se(t.canvas,t.ctx),this.obstacles=[],this.score=0,this.timeToNext=0,this.gameOver=!1,this.paused=!1,this.speed=120,this.player.x=80,this.player.y=Math.max(0,(t.canvas.height-this.player.height)*.5),this.player.vx=0,this.player.vy=0,this.player.hp=this.player.maxHp=3,this.player.fireCooldown=0,this.bullets=[],this.enemies=[],this.powerUps=[],this.enemyTimer=2.5,this.powerTimer=5,this.hintT=4,this.shakeT=0,this.floats=[],this.lastGapCenter=null,this.ended=!1,this.btnLeftDown=this.btnRightDown=this.btnShootDown=!1,this.restartRect=null,this.multishotT=0,this.bigshotT=0,this.slowmoT=0,this.magnetT=0,this.rapidT=0;const i=()=>{const y=t.canvas.width,d=t.canvas.height,w=Math.max(60,Math.min(120,Math.floor(Math.min(y,d)*.14))),m=24;this.btnRects={left:{x:m,y:d-w-m,w,h:w},right:{x:m+w+16,y:d-w-m,w,h:w},shoot:{x:y-w-m,y:d-w-m,w,h:w}}},s=()=>{const y=t.canvas.width,d=t.canvas.height,w=Math.max(64,Math.min(120,Math.floor(Math.min(y,d)*.16)));this.restartRect={x:(y-w)/2,y:d*.55,w,h:w}},o=(y,d,w)=>{if(!this.btnRects)return!1;const m=this.btnRects[y];return d>=m.x&&d<=m.x+m.w&&w>=m.y&&w<=m.y+m.h},f=y=>{i(),this.btnLeftDown=this.btnRightDown=this.btnShootDown=!1;const d=t.canvas.getBoundingClientRect(),w=t.canvas.width/d.width,m=t.canvas.height/d.height;for(let c=0;c<y.touches.length;c++){const b=y.touches.item(c),M=(b.clientX-d.left)*w,x=(b.clientY-d.top)*m;o("left",M,x)?this.btnLeftDown=!0:o("right",M,x)?this.btnRightDown=!0:o("shoot",M,x)&&(this.btnShootDown=!0)}},u=y=>{var m;if(this.gameOver){if(y.touches!==void 0){s();const c=y,b=t.canvas.getBoundingClientRect(),M=t.canvas.width/b.width,x=t.canvas.height/b.height;for(let _=0;_<c.touches.length;_++){const E=c.touches.item(_),T=(E.clientX-b.left)*M,I=(E.clientY-b.top)*x,R=this.restartRect;if(T>=R.x&&T<=R.x+R.w&&I>=R.y&&I<=R.y+R.h){this.init(t);return}}}else{s();const c=this.restartRect,b=y,M=t.canvas.getBoundingClientRect(),x=t.canvas.width/M.width,_=t.canvas.height/M.height,E=(b.clientX-M.left)*x,T=(b.clientY-M.top)*_;if(E>=c.x&&E<=c.x+c.w&&T>=c.y&&T<=c.y+c.h){this.init(t);return}}return}if(y.touches!==void 0){const c=y;if(f(c),this.btnLeftDown||this.btnRightDown||this.btnShootDown){this.btnShootDown&&this.fireWeapon();return}const b=t.canvas.width,M=t.canvas.height,x=t.canvas.getBoundingClientRect(),_=b/x.width,E=M/x.height;let T=!1;for(let R=0;R<c.touches.length;R++){const B=c.touches.item(R),C=(B.clientX-x.left)*_,G=(B.clientY-x.top)*E;if(C>b*.7&&G>M*.6){T=!0;break}}if(T){this.fireWeapon();return}(((m=c.touches)==null?void 0:m.length)??0)>=2?this.fireWeapon():(j.jump(this.player),L.flap(),this.particles.burst(this.player.x+this.player.width*.2,this.player.y+this.player.height,lt.reducedMotion?4:8,"#88ccff88"));return}const d=y.button??0,w=Ee(d);w==="flap"?(j.jump(this.player),L.flap()):w==="shoot"&&this.fireWeapon()};t.canvas.oncontextmenu=y=>{y.preventDefault()},t.canvas.onpointerdown=u;const a=y=>{const d=t.canvas.getBoundingClientRect();let w=0,m=0;for(let c=0;c<y.touches.length;c++){const M=y.touches.item(c).clientX-d.left;M<d.width*.45?w=1:M>d.width*.55&&(m=1)}this.mobileMoveX=m-w};t.canvas.ontouchstart=y=>{a(y),u(y)},t.canvas.ontouchmove=y=>{a(y),f(y)},t.canvas.ontouchend=y=>{a(y),f(y)};try{const y=localStorage.getItem("best");y&&(this.best=parseInt(y,10)||0)}catch{}try{this.playerName=at.getPlayerName()}catch{this.playerName=null}document.addEventListener("visibilitychange",()=>{document.hidden&&(this.paused=!0)})}fireWeapon(){if(this.player.fireCooldown>0)return;const t=this.player.x+this.player.width,i=this.player.y+this.player.height*.5-2,s=f=>{const a=Math.cos(f)*360,y=Math.sin(f)*360,d=new Vt(t,i,a,y,"player");return this.bigshotT>0&&(d.width=14,d.damage=2,d.color="#ffa6a6"),d};this.multishotT>0?(this.bullets.push(s(0-.13)),this.bullets.push(s(0)),this.bullets.push(s(0+.13))):this.bullets.push(s(0));let o=this.bigshotT>0?.22:this.multishotT>0?.2:.18;this.rapidT>0&&(o=Math.max(.08,o*.55)),this.player.fireCooldown=o,L.beep(980,.05,"square",.05)}update(t,i){var w,m;const s=i.canvas.height;if(i.input.wasPressed("KeyP")&&(this.paused=!this.paused),i.input.wasPressed("KeyR")&&this.init(i),this.paused)return;const o=this.slowmoT>0?.7:1,f=t*o;(i.input.wasPressed("Space")||i.input.wasPressed("ArrowUp")||i.input.wasPressed("KeyW"))&&(j.jump(this.player),L.flap(),this.particles.burst(this.player.x+this.player.width*.2,this.player.y+this.player.height,lt.reducedMotion?4:8,"#88ccff88")),(i.input.isDown("KeyJ")||i.input.isDown("ControlLeft")||i.input.isDown("ControlRight")||this.btnShootDown)&&this.fireWeapon();const u=i.input.getMovementDirection(),a=((m=(w=i.input).getWASDHorizontal)==null?void 0:m.call(w))??(i.input.isDown("KeyD")?1:0)+(i.input.isDown("KeyA")?-1:0),y=(this.btnRightDown?1:0)-(this.btnLeftDown?1:0);if(this.player.vx=(u.x+a+this.mobileMoveX+y)*80,j.applyGravity(this.player,f),this.player.update(f),this.player.y=Math.max(0,Math.min(s-this.player.height,this.player.y)),this.timeToNext-=f,this.timeToNext<=0){const c=Math.min(1,this.score/30);this.speed=Math.min(280,120+c*140);const b=Math.max(150,230-this.score*2.2);this.timeToNext=Math.max(1.1,1.8-this.score*.02);const M=b,x=60,_=x+M/2,E=s-x-M/2,T=this.lastGapCenter??s/2,I=140+Math.min(100,this.score*2),R=Math.max(_,T-I),B=Math.min(E,T+I),C=R<=B?R+Math.random()*(B-R):Math.min(E,Math.max(_,T)),G=Math.floor(C-M/2);this.lastGapCenter=C;const W=80,$=i.canvas.width+W;this.obstacles.push(new ft($,0,W,G,this.speed)),this.obstacles.push(new ft($,G+M,W,s-(G+M),this.speed))}for(const c of this.obstacles)c.update(f);this.obstacles=this.obstacles.filter(c=>!c.isOffScreen());for(const c of this.obstacles)j.checkCollision(this.player,c)&&(this.player.hp-=1,L.hit(),this.particles.burst(this.player.x+this.player.width/2,this.player.y+this.player.height/2,lt.reducedMotion?6:12,"#ff7b72aa"),this.shakeT=lt.reducedMotion?0:.2,this.hurtT=.35,this.combo=0,this.comboT=0,this.player.x-=10,this.player.hp<=0&&this.finalizeGameOver());for(let c=0;c<this.obstacles.length;c+=2){const b=this.obstacles[c],M=b.x+b.width/2;!this.gameOver&&M<this.player.x&&b.counted!==!0&&(b.counted=!0,this.score+=1,this.player.passObstacle(),L.score())}if(this.enemyTimer-=f,this.enemyTimer<=0){let c=40,b=s-40;if(this.obstacles.length>=2){let W=0,$=-1/0;for(let A=0;A<this.obstacles.length-1;A+=2){const P=this.obstacles[A];P.x>$&&($=P.x,W=A)}const ht=this.obstacles[W],S=this.obstacles[W+1];c=ht.height,b=S.y}const M=12,x=Math.max(0,c+M),_=Math.min(s-20,b-M-18),E=i.canvas.width+40,T=x<_?x+(_-x)*(.35+Math.random()*.3):40+Math.random()*(s-120);let I="drone";this.score>6&&Math.random()<.5&&(I="bee"),this.score>15&&Math.random()<.35&&(I="tank"),this.score>25&&Math.random()<.25&&(I="kamikaze");const B=-((I==="tank"?90:120)+Math.random()*60+this.score*1.2),C=new Ve(E,T,B,0,I);C.minY=isFinite(x)?x:20,C.maxY=isFinite(_)?_:s-40,C.phase=Math.random()*Math.PI*2,this.enemies.push(C);const G=2.4-Math.min(1.2,this.score*.03);this.enemyTimer=Math.max(.8,G+(I==="tank"?.3:0))}if(this.powerTimer-=f,this.powerTimer<=0){const c=Ie(this.score);this.powerUps.push(new Yt(i.canvas.width+20,80+Math.random()*(s-160),c)),this.powerTimer=8+Math.random()*6}for(const c of this.bullets)c.update(f);for(const c of this.enemies){const b=(c.phase??0)+performance.now()/1e3;if(c.variant==="kamikaze"){const E=this.player.y-6-c.y;c.vy=Math.max(-120,Math.min(120,E*2))}else c.variant==="bee"?c.vy=Math.sin(b*1.5)*55:c.variant==="tank"?c.vy=Math.sin(b*.6)*24:c.vy=Math.sin(b)*35;c.update(f);const M=c.minY??20,x=c.maxY??s-40;c.y<M&&(c.y=M),c.y+c.height>x&&(c.y=x-c.height)}for(const c of this.powerUps){if(this.magnetT>0){const b=this.player.x+this.player.width/2,M=this.player.y+this.player.height/2,x=b-(c.x+c.width/2),_=M-(c.y+c.height/2);x*x+_*_<200*200&&(c.vx+=Math.sign(x)*20,c.vy+=Math.sign(_)*20,!lt.reducedMotion&&Math.random()<.25&&this.particles.burst(c.x+c.width/2,c.y+c.height/2,1,"#f472b6aa"))}c.update(f)}this.bullets=this.bullets.filter(c=>!c.isOffScreen(i.canvas.width,s)&&c.active),this.enemies=this.enemies.filter(c=>!c.isOffScreen()),this.powerUps=this.powerUps.filter(c=>!c.isOffScreen());const d=(c,b,M,x,_,E,T,I)=>c<_+T&&c+M>_&&b<E+I&&b+x>E;for(const c of this.bullets)for(const b of this.enemies)if(c.active&&d(c.x,c.y,c.width,c.height,b.x,b.y,b.width,b.height)&&(c.active=!1,b.health-=c.damage??1,this.particles.burst(b.x+b.width/2,b.y+b.height/2,lt.reducedMotion?6:10,"#ffd166aa"),b.health<=0)){const M=b.x+b.width/2,x=b.y+b.height/2;this.particles.burst(M,x,lt.reducedMotion?10:22,"#ffb347aa"),this.particles.burst(M,x,lt.reducedMotion?8:14,"#ff7b72aa"),b.x=-9999;const _=b.variant==="tank"?At.KILL_POINTS+1:At.KILL_POINTS,E=2.2;this.comboT>0?this.combo++:this.combo=1,this.comboT=E;const T=Math.max(0,this.combo-1);this.score+=_+T,this.floats.push({x:M,y:x,text:`+${_}`,ttl:.9,vy:-32}),T>0&&(this.floats.push({x:M+14,y:x-18,text:`x${this.combo}`,ttl:.8,vy:-26}),L.combo(this.combo)),this.shakeT=lt.reducedMotion?0:Math.max(this.shakeT,.12),L.score()}this.enemies=this.enemies.filter(c=>c.x>-9e3);for(const c of this.enemies)d(this.player.x,this.player.y,this.player.width,this.player.height,c.x,c.y,c.width,c.height)&&(this.player.hp-=1,L.hit(),this.particles.burst(c.x+c.width/2,c.y+c.height/2,10,"#ff7b72aa"),c.x=-9999,this.player.hp<=0&&this.finalizeGameOver());for(const c of this.powerUps)d(this.player.x,this.player.y,this.player.width,this.player.height,c.x,c.y,c.width,c.height)&&(c.type==="heal"&&(this.player.hp=Math.min(this.player.maxHp,this.player.hp+1)),c.type==="rapid"&&(this.rapidT=Math.max(this.rapidT,8)),c.type==="shield"&&(this.player.maxHp=Math.min(5,this.player.maxHp+1),this.player.hp=Math.min(this.player.maxHp,this.player.hp+1)),c.type==="multishot"&&(this.multishotT=Math.max(this.multishotT,8)),c.type==="bigshot"&&(this.bigshotT=Math.max(this.bigshotT,8)),c.type==="slowmo"&&(this.slowmoT=Math.max(this.slowmoT,3.5)),c.type==="magnet"&&(this.magnetT=Math.max(this.magnetT,8)),this.particles.burst(c.x+c.width/2,c.y+c.height/2,14,"#7ee787aa"),c.x=-9999,this.pickupBadgeT=1.4);this.particles.update(f),this.shakeT=Math.max(0,this.shakeT-t),this.hurtT=Math.max(0,this.hurtT-t),this.comboT>0&&(this.comboT=Math.max(0,this.comboT-t)),this.slowmoT=Math.max(0,this.slowmoT-t),this.multishotT=Math.max(0,this.multishotT-t),this.bigshotT=Math.max(0,this.bigshotT-t),this.magnetT=Math.max(0,this.magnetT-t),this.rapidT=Math.max(0,this.rapidT-t);for(const c of this.floats)c.ttl-=t,c.y+=c.vy*t;this.floats=this.floats.filter(c=>c.ttl>0),this.hintT=Math.max(0,this.hintT-t)}finalizeGameOver(){if(this.ended)return;this.ended=!0,this.gameOver=!0,this.best=Math.max(this.best,this.score);try{localStorage.setItem("best",String(this.best))}catch{}let t=at.getPlayerName()||"";try{const i=typeof window<"u"?window.prompt("Name for high score?",t||"Anon"):null;i!=null&&(t=i,at.setPlayerName(t))}catch{}at.addScore(this.score,Date.now(),t),this.playerName=t}render(t,i){const s=this.shakeT>0?(Math.random()-.5)*8:0;t.save(),t.translate(s,s),this.renderer.clear(1/60);for(const u of this.obstacles)this.renderer.drawObstacle(u);for(const u of this.enemies)this.renderer.drawEnemy(u);for(const u of this.powerUps)this.renderer.drawPowerUp(u);const o=this.hurtT>0?"#f87171":"#58a6ff";if(this.renderer.drawPlayer(this.player,o),this.playerName){const u=this.playerName.slice(0,18),a=this.player.x+this.player.width/2;let y=this.player.y-6;y<14&&(y=this.player.y+this.player.height+14),t.save(),t.textAlign="center",t.font="600 12px system-ui",t.lineWidth=3,t.strokeStyle="#00000077",t.strokeText(u,a,y),t.fillStyle="#cdd9e5",t.fillText(u,a,y),t.restore()}for(const u of this.bullets)this.renderer.drawProjectile(u);this.particles.render(t),this.hud.render(t,this.score,void 0,this.player.hp);{const u=[{active:this.rapidT>0,color:"#f7b84a",glyph:"R",rem:this.rapidT,dur:8},{active:this.multishotT>0,color:"#38bdf8",glyph:"M",rem:this.multishotT,dur:8},{active:this.bigshotT>0,color:"#fb7185",glyph:"B",rem:this.bigshotT,dur:8},{active:this.slowmoT>0,color:"#a78bfa",glyph:"⌛",rem:this.slowmoT,dur:3.5},{active:this.magnetT>0,color:"#f472b6",glyph:"U",rem:this.magnetT,dur:8}],y=16+(this.player.hp??0)*18+12;let d=y,w=36;const m=12,c=12,b=3,M=6,x=i.canvas.width-16;for(const _ of u){if(!_.active)continue;d+m>x&&(d=y,w+=c+6),t.save(),t.globalAlpha=.95,t.fillStyle=_.color,t.beginPath(),t.roundRect(d,w+2,m,c,b),t.fill();const E=Math.max(0,Math.min(1,_.rem/_.dur));t.strokeStyle="#0f172a",t.lineWidth=1.5,t.beginPath(),t.arc(d+m/2,w+2+c/2,6,-Math.PI/2,-Math.PI/2+E*Math.PI*2),t.stroke(),t.fillStyle="#0f172a",t.font="700 9px system-ui";const T=t.measureText(_.glyph).width;t.fillText(_.glyph,d+(m-T)/2,w+11),t.restore(),d+=m+M}}if(this.pickupBadgeT>0){const u=Math.min(1,this.pickupBadgeT/1.4);t.save(),t.globalAlpha=u*.9;const a=[{label:"Rapid",active:this.rapidT>0,color:"#f7b84a"},{label:"Multi",active:this.multishotT>0,color:"#38bdf8"},{label:"Big",active:this.bigshotT>0,color:"#fb7185"},{label:"Slow",active:this.slowmoT>0,color:"#a78bfa"},{label:"Mag",active:this.magnetT>0,color:"#f472b6"}].filter(w=>w.active);let y=16,d=82;for(const w of a)t.fillStyle="#0f172acc",t.beginPath(),t.roundRect(y,d,86,22,8),t.fill(),t.fillStyle=w.color+"dd",t.beginPath(),t.roundRect(y+2,d+2,82,18,6),t.strokeStyle=w.color+"66",t.lineWidth=2,t.stroke(),t.fillStyle="#e8e8f0",t.font="700 12px system-ui",t.fillText(w.label,y+10,d+15),y+=94;t.restore()}if(this.slowmoT>0){const u=Math.min(.25,.15+this.slowmoT/4*.1);t.save(),t.globalAlpha=u,t.fillStyle="#0b1022",t.fillRect(0,0,i.canvas.width,i.canvas.height),t.restore()}const f=[];if(this.rapidT>0&&f.push({label:"Rapid",t:this.rapidT,d:8,color:"#f7b84a"}),this.multishotT>0&&f.push({label:"Multi",t:this.multishotT,d:8,color:"#38bdf8"}),this.bigshotT>0&&f.push({label:"Big",t:this.bigshotT,d:8,color:"#fb7185"}),this.slowmoT>0&&f.push({label:"Slow",t:this.slowmoT,d:4,color:"#a78bfa"}),this.magnetT>0&&f.push({label:"Mag",t:this.magnetT,d:8,color:"#f472b6"}),f.length){let u=16,a=56;for(const y of f){t.save(),t.globalAlpha=.9,t.fillStyle="#0f172acc",t.beginPath(),t.roundRect(u,a,74,20,8),t.fill();const c=Math.max(0,Math.min(1,y.t/y.d));t.fillStyle=y.color+"aa",t.beginPath(),t.roundRect(u+2,a+20-6,70*c,4,3),t.fill(),t.fillStyle="#e8e8f0",t.font="600 12px system-ui",t.fillText(y.label,u+8,a+14),t.restore(),u+=82}}if(this.comboT>0&&this.combo>1&&(t.save(),t.fillStyle="#ffd166",t.font="700 14px system-ui",t.fillText(`Combo x${this.combo}`,16,46),t.restore()),this.floats.length)for(const u of this.floats){const a=Math.max(0,Math.min(1,u.ttl/.9));t.save(),t.globalAlpha=a,t.fillStyle="#ffd166",t.font="700 18px system-ui",t.fillText(u.text,u.x,u.y),t.restore()}if(this.isTouch){const u=i.canvas.width,a=i.canvas.height,y=Math.max(60,Math.min(120,Math.floor(Math.min(u,a)*.14))),d=24;this.btnRects={left:{x:d,y:a-y-d,w:y,h:y},right:{x:d+y+16,y:a-y-d,w:y,h:y},shoot:{x:u-y-d,y:a-y-d,w:y,h:y}};const w=(m,c,b)=>{t.save(),t.globalAlpha=.5,t.fillStyle=c?"#58a6ff":"#0f172a",t.strokeStyle="#58a6ff88",t.lineWidth=4,t.beginPath(),t.roundRect(m.x,m.y,m.w,m.h,16),t.fill(),t.stroke(),t.fillStyle="#e8e8f0",t.font="700 28px system-ui";const M=b==="L"?"◀":b==="R"?"▶":"●",x=t.measureText(M).width;t.fillText(M,m.x+(m.w-x)/2,m.y+m.h/2+10),t.restore()};w(this.btnRects.left,this.btnLeftDown,"L"),w(this.btnRects.right,this.btnRightDown,"R"),w(this.btnRects.shoot,this.btnShootDown,"S")}if(this.hintT>0){const u=Math.min(.8,this.hintT/4);t.save(),t.globalAlpha=u,t.fillStyle="#00000088",t.fillRect(20,70,520,56),t.fillStyle="#e8e8f0",t.font="600 16px system-ui",t.fillText("Flap: Space/ArrowUp/W or Click • Move: Arrows or A/D • Shoot: Right Click or Ctrl/J (hold)",28,100),t.restore()}if(t.restore(),this.paused&&(t.fillStyle="#00000088",t.fillRect(0,0,i.canvas.width,i.canvas.height),t.fillStyle="#e8e8f0",t.font="700 28px system-ui",t.fillText("Paused (P). R = Restart, Esc = Title",40,120)),this.gameOver){t.fillStyle="#00000088",t.fillRect(0,0,i.canvas.width,i.canvas.height),t.fillStyle="#e8e8f0",t.font="700 28px system-ui",t.fillText(`Game Over — Score ${this.score}  Best ${this.best}`,40,120),t.font="500 18px system-ui",t.fillText("Press R or tap the restart button",40,160);const u=i.canvas.width,a=i.canvas.height,y=Math.max(64,Math.min(120,Math.floor(Math.min(u,a)*.16))),d=(u-y)/2,w=a*.55;this.restartRect={x:d,y:w,w:y,h:y},t.save(),t.globalAlpha=.9,t.fillStyle="#0f172a",t.strokeStyle="#58a6ff88",t.lineWidth=5,t.beginPath(),t.roundRect(d,w,y,y,18),t.fill(),t.stroke(),t.fillStyle="#e8e8f0",t.font="700 28px system-ui",t.fillText("⟲",d+y/2-10,w+y/2+12),t.restore()}}};At.KILL_POINTS=2;let Bt=At;class zt{constructor(){this.p1=new kt(80,140,26,26),this.p2=new kt(120,220,26,26),this.obstacles=[],this.hud=new ie,this.timeToNext=0,this.s1=0,this.s2=0,this.paused=!1,this.speed=140,this.particles=new $t,this.shakeT=0}init(t){this.renderer=new se(t.canvas,t.ctx),this.obstacles=[],this.timeToNext=0,this.s1=0,this.s2=0,this.paused=!1,this.speed=140;const i=()=>{j.jump(this.p1),L.flap()};t.canvas.ontouchstart=i,t.canvas.onpointerdown=i}update(t,i){const s=i.canvas.height;if(i.input.wasPressed("KeyP")&&(this.paused=!this.paused),i.input.wasPressed("KeyR")&&this.init(i),this.paused)return;(i.input.wasPressed("Space")||i.input.wasPressed("ArrowUp"))&&(j.jump(this.p1),L.flap(),this.particles.burst(this.p1.x,this.p1.y+this.p1.height,6,"#88ccff88")),i.input.wasPressed("KeyW")&&(j.jump(this.p2),L.flap(),this.particles.burst(this.p2.x,this.p2.y+this.p2.height,6,"#ffb08888"));const o=i.input.getMovementDirection();if(this.p1.vx=o.x*80,this.p2.vx=0,this.p2.vy+=(i.input.isDown("KeyS")?1:0)*300*t,j.applyGravity(this.p1,t),j.applyGravity(this.p2,t),this.p1.update(t),this.p2.update(t),this.p1.y=Math.max(0,Math.min(s-this.p1.height,this.p1.y)),this.p2.y=Math.max(0,Math.min(s-this.p2.height,this.p2.y)),this.timeToNext-=t,this.timeToNext<=0){this.speed=Math.min(260,this.speed+2);const f=Math.max(130,180-Math.max(this.s1,this.s2)*2);this.timeToNext=Math.max(1,1.7-Math.max(this.s1,this.s2)*.02);const u=40,a=s-f-40,y=Math.floor(Math.random()*(a-u+1))+u,d=80,w=i.canvas.width+d;this.obstacles.push(new ft(w,0,d,y,this.speed)),this.obstacles.push(new ft(w,y+f,d,s-(y+f),this.speed))}for(const f of this.obstacles)f.update(t);this.obstacles=this.obstacles.filter(f=>!f.isOffScreen());for(const f of this.obstacles)if(j.checkCollision(this.p1,f)||j.checkCollision(this.p2,f)){L.hit(),this.particles.burst((this.p1.x+this.p2.x)/2,(this.p1.y+this.p2.y)/2,16,"#ff7b72aa"),this.shakeT=.25,this.init(i);return}for(let f=0;f<this.obstacles.length;f+=2){const u=this.obstacles[f],a=u.x+u.width/2;a<this.p1.x&&u.p1c!==!0&&(u.p1c=!0,this.s1+=1,this.p1.passObstacle(),L.score()),a<this.p2.x&&u.p2c!==!0&&(u.p2c=!0,this.s2+=1,this.p2.passObstacle(),L.score())}}render(t,i){const s=this.shakeT>0?(Math.random()-.5)*8:0;t.save(),t.translate(s,s),this.renderer.clear(1/60);for(const o of this.obstacles)this.renderer.drawObstacle(o);this.renderer.drawPlayer(this.p1,"#58a6ff"),this.renderer.drawPlayer(this.p2,"#ff7b72"),this.particles.render(t),this.hud.render(t,this.s1,this.s2),t.restore(),this.paused&&(t.fillStyle="#00000088",t.fillRect(0,0,i.canvas.width,i.canvas.height),t.fillStyle="#e8e8f0",t.font="700 28px system-ui",t.fillText("Paused (P). R = Restart, Esc = Title",40,120))}}class Jt extends Error{constructor(t){super(t),this.name="AbortError"}}function Xe(l,t){const{cleanupBeforeAbort:i,abortSignal:s,abortErrorMsg:o}=t??{};return new Promise((f,u)=>{function a(){u(new Jt(o??"The operation was aborted."))}function y(){s==null||s.removeEventListener("abort",d)}function d(){i==null||i(),y(),a()}if(s!=null&&s.aborted)return a();try{l(w=>{y(),f(w)},w=>{y(),u(w)})}catch(w){u(w)}s==null||s.addEventListener("abort",d)})}const ze="The delay was aborted.";function Ft(l,t){let i;const{abortSignal:s,abortErrorMsg:o}={};return Xe(f=>{i=setTimeout(f,l)},{cleanupBeforeAbort:()=>clearTimeout(i),abortSignal:s,abortErrorMsg:o??ze})}function Je(l){return l&&l.__esModule&&Object.prototype.hasOwnProperty.call(l,"default")?l.default:l}var ne={exports:{}},St=typeof Reflect=="object"?Reflect:null,de=St&&typeof St.apply=="function"?St.apply:function(t,i,s){return Function.prototype.apply.call(t,i,s)},Nt;St&&typeof St.ownKeys=="function"?Nt=St.ownKeys:Object.getOwnPropertySymbols?Nt=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:Nt=function(t){return Object.getOwnPropertyNames(t)};function Ze(l){console&&console.warn&&console.warn(l)}var Ae=Number.isNaN||function(t){return t!==t};function D(){D.init.call(this)}ne.exports=D;ne.exports.once=ii;D.EventEmitter=D;D.prototype._events=void 0;D.prototype._eventsCount=0;D.prototype._maxListeners=void 0;var pe=10;function Gt(l){if(typeof l!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof l)}Object.defineProperty(D,"defaultMaxListeners",{enumerable:!0,get:function(){return pe},set:function(l){if(typeof l!="number"||l<0||Ae(l))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+l+".");pe=l}});D.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};D.prototype.setMaxListeners=function(t){if(typeof t!="number"||t<0||Ae(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function ke(l){return l._maxListeners===void 0?D.defaultMaxListeners:l._maxListeners}D.prototype.getMaxListeners=function(){return ke(this)};D.prototype.emit=function(t){for(var i=[],s=1;s<arguments.length;s++)i.push(arguments[s]);var o=t==="error",f=this._events;if(f!==void 0)o=o&&f.error===void 0;else if(!o)return!1;if(o){var u;if(i.length>0&&(u=i[0]),u instanceof Error)throw u;var a=new Error("Unhandled error."+(u?" ("+u.message+")":""));throw a.context=u,a}var y=f[t];if(y===void 0)return!1;if(typeof y=="function")de(y,this,i);else for(var d=y.length,w=De(y,d),s=0;s<d;++s)de(w[s],this,i);return!0};function Be(l,t,i,s){var o,f,u;if(Gt(i),f=l._events,f===void 0?(f=l._events=Object.create(null),l._eventsCount=0):(f.newListener!==void 0&&(l.emit("newListener",t,i.listener?i.listener:i),f=l._events),u=f[t]),u===void 0)u=f[t]=i,++l._eventsCount;else if(typeof u=="function"?u=f[t]=s?[i,u]:[u,i]:s?u.unshift(i):u.push(i),o=ke(l),o>0&&u.length>o&&!u.warned){u.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+u.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=l,a.type=t,a.count=u.length,Ze(a)}return l}D.prototype.addListener=function(t,i){return Be(this,t,i,!1)};D.prototype.on=D.prototype.addListener;D.prototype.prependListener=function(t,i){return Be(this,t,i,!0)};function Qe(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Ce(l,t,i){var s={fired:!1,wrapFn:void 0,target:l,type:t,listener:i},o=Qe.bind(s);return o.listener=i,s.wrapFn=o,o}D.prototype.once=function(t,i){return Gt(i),this.on(t,Ce(this,t,i)),this};D.prototype.prependOnceListener=function(t,i){return Gt(i),this.prependListener(t,Ce(this,t,i)),this};D.prototype.removeListener=function(t,i){var s,o,f,u,a;if(Gt(i),o=this._events,o===void 0)return this;if(s=o[t],s===void 0)return this;if(s===i||s.listener===i)--this._eventsCount===0?this._events=Object.create(null):(delete o[t],o.removeListener&&this.emit("removeListener",t,s.listener||i));else if(typeof s!="function"){for(f=-1,u=s.length-1;u>=0;u--)if(s[u]===i||s[u].listener===i){a=s[u].listener,f=u;break}if(f<0)return this;f===0?s.shift():ti(s,f),s.length===1&&(o[t]=s[0]),o.removeListener!==void 0&&this.emit("removeListener",t,a||i)}return this};D.prototype.off=D.prototype.removeListener;D.prototype.removeAllListeners=function(t){var i,s,o;if(s=this._events,s===void 0)return this;if(s.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):s[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete s[t]),this;if(arguments.length===0){var f=Object.keys(s),u;for(o=0;o<f.length;++o)u=f[o],u!=="removeListener"&&this.removeAllListeners(u);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(i=s[t],typeof i=="function")this.removeListener(t,i);else if(i!==void 0)for(o=i.length-1;o>=0;o--)this.removeListener(t,i[o]);return this};function Pe(l,t,i){var s=l._events;if(s===void 0)return[];var o=s[t];return o===void 0?[]:typeof o=="function"?i?[o.listener||o]:[o]:i?ei(o):De(o,o.length)}D.prototype.listeners=function(t){return Pe(this,t,!0)};D.prototype.rawListeners=function(t){return Pe(this,t,!1)};D.listenerCount=function(l,t){return typeof l.listenerCount=="function"?l.listenerCount(t):Le.call(l,t)};D.prototype.listenerCount=Le;function Le(l){var t=this._events;if(t!==void 0){var i=t[l];if(typeof i=="function")return 1;if(i!==void 0)return i.length}return 0}D.prototype.eventNames=function(){return this._eventsCount>0?Nt(this._events):[]};function De(l,t){for(var i=new Array(t),s=0;s<t;++s)i[s]=l[s];return i}function ti(l,t){for(;t+1<l.length;t++)l[t]=l[t+1];l.pop()}function ei(l){for(var t=new Array(l.length),i=0;i<t.length;++i)t[i]=l[i].listener||l[i];return t}function ii(l,t){return new Promise(function(i,s){function o(u){l.removeListener(t,f),s(u)}function f(){typeof l.removeListener=="function"&&l.removeListener("error",o),i([].slice.call(arguments))}Ue(l,t,f,{once:!0}),t!=="error"&&si(l,o,{once:!0})})}function si(l,t,i){typeof l.on=="function"&&Ue(l,"error",t,i)}function Ue(l,t,i,s){if(typeof l.on=="function")s.once?l.once(t,i):l.on(t,i);else if(typeof l.addEventListener=="function")l.addEventListener(t,function o(f){s.once&&l.removeEventListener(t,o),i(f)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof l)}var ni=ne.exports;const ri=Je(ni);class Ot extends Error{constructor(t,i){super(t),this.name="SendMessageError",this.ackId=i.ackId,this.errorDetail=i.errorDetail}}function oi(...l){if(l.length>0){const t=String(l[0]);t.includes(":error")?console.error(...l):t.includes(":warning")?console.warn(...l):t.includes(":info")?console.info(...l):t.includes(":verbose")?console.debug(...l):console.debug(...l)}}var ye={};const me=typeof process<"u"&&ye&&ye.DEBUG||void 0;let Oe,Zt=[],Qt=[];const jt=[];me&&re(me);const xt=Object.assign(l=>Fe(l),{enable:re,enabled:oe,disable:ai,log:oi});function re(l){Oe=l,Zt=[],Qt=[];const t=/\*/g,i=l.split(",").map(s=>s.trim().replace(t,".*?"));for(const s of i)s.startsWith("-")?Qt.push(new RegExp(`^${s.substr(1)}$`)):Zt.push(new RegExp(`^${s}$`));for(const s of jt)s.enabled=oe(s.namespace)}function oe(l){if(l.endsWith("*"))return!0;for(const t of Qt)if(t.test(l))return!1;for(const t of Zt)if(t.test(l))return!0;return!1}function ai(){const l=Oe||"";return re(""),l}function Fe(l){const t=Object.assign(i,{enabled:oe(l),destroy:hi,log:xt.log,namespace:l,extend:li});function i(...s){t.enabled&&(s.length>0&&(s[0]=`${l} ${s[0]}`),t.log(...s))}return jt.push(t),t}function hi(){const l=jt.indexOf(this);return l>=0?(jt.splice(l,1),!0):!1}function li(l){const t=Fe(`${this.namespace}:${l}`);return t.log=this.log,t}var we={};const te=["verbose","info","warning","error"],ge={verbose:400,info:300,warning:200,error:100};function be(l,t){t.log=(...i)=>{l.log(...i)}}function ve(l){return te.includes(l)}function Ne(l){const t=new Set,i=typeof process<"u"&&we&&we[l.logLevelEnvVarName]||void 0;let s;const o=xt(l.namespace);o.log=(...w)=>{xt.log(...w)};function f(w){if(w&&!ve(w))throw new Error(`Unknown log level '${w}'. Acceptable values: ${te.join(",")}`);s=w;const m=[];for(const c of t)u(c)&&m.push(c.namespace);xt.enable(m.join(","))}i&&(ve(i)?f(i):console.error(`${l.logLevelEnvVarName} set to unknown log level '${i}'; logging is not enabled. Acceptable values: ${te.join(", ")}.`));function u(w){return!!(s&&ge[w.level]<=ge[s])}function a(w,m){const c=Object.assign(w.extend(m),{level:m});if(be(w,c),u(c)){const b=xt.disable();xt.enable(b+","+c.namespace)}return t.add(c),c}function y(){return s}function d(w){const m=o.extend(w);return be(o,m),{error:a(m,"error"),warning:a(m,"warning"),info:a(m,"info"),verbose:a(m,"verbose")}}return{setLogLevel:f,getLogLevel:y,createClientLogger:d,logger:o}}Ne({logLevelEnvVarName:"TYPESPEC_RUNTIME_LOG_LEVEL",namespace:"typeSpecRuntime"});const ci=Ne({logLevelEnvVarName:"AZURE_LOG_LEVEL",namespace:"azure"});function fi(l){return ci.createClientLogger(l)}const et=fi("web-pubsub-client");var ae={},Wt={};Wt.byteLength=pi;Wt.toByteArray=mi;Wt.fromByteArray=bi;var ut=[],ot=[],ui=typeof Uint8Array<"u"?Uint8Array:Array,qt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var vt=0,di=qt.length;vt<di;++vt)ut[vt]=qt[vt],ot[qt.charCodeAt(vt)]=vt;ot[45]=62;ot[95]=63;function $e(l){var t=l.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=l.indexOf("=");i===-1&&(i=t);var s=i===t?0:4-i%4;return[i,s]}function pi(l){var t=$e(l),i=t[0],s=t[1];return(i+s)*3/4-s}function yi(l,t,i){return(t+i)*3/4-i}function mi(l){var t,i=$e(l),s=i[0],o=i[1],f=new ui(yi(l,s,o)),u=0,a=o>0?s-4:s,y;for(y=0;y<a;y+=4)t=ot[l.charCodeAt(y)]<<18|ot[l.charCodeAt(y+1)]<<12|ot[l.charCodeAt(y+2)]<<6|ot[l.charCodeAt(y+3)],f[u++]=t>>16&255,f[u++]=t>>8&255,f[u++]=t&255;return o===2&&(t=ot[l.charCodeAt(y)]<<2|ot[l.charCodeAt(y+1)]>>4,f[u++]=t&255),o===1&&(t=ot[l.charCodeAt(y)]<<10|ot[l.charCodeAt(y+1)]<<4|ot[l.charCodeAt(y+2)]>>2,f[u++]=t>>8&255,f[u++]=t&255),f}function wi(l){return ut[l>>18&63]+ut[l>>12&63]+ut[l>>6&63]+ut[l&63]}function gi(l,t,i){for(var s,o=[],f=t;f<i;f+=3)s=(l[f]<<16&16711680)+(l[f+1]<<8&65280)+(l[f+2]&255),o.push(wi(s));return o.join("")}function bi(l){for(var t,i=l.length,s=i%3,o=[],f=16383,u=0,a=i-s;u<a;u+=f)o.push(gi(l,u,u+f>a?a:u+f));return s===1?(t=l[i-1],o.push(ut[t>>2]+ut[t<<4&63]+"==")):s===2&&(t=(l[i-2]<<8)+l[i-1],o.push(ut[t>>10]+ut[t>>4&63]+ut[t<<2&63]+"=")),o.join("")}var he={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */he.read=function(l,t,i,s,o){var f,u,a=o*8-s-1,y=(1<<a)-1,d=y>>1,w=-7,m=i?o-1:0,c=i?-1:1,b=l[t+m];for(m+=c,f=b&(1<<-w)-1,b>>=-w,w+=a;w>0;f=f*256+l[t+m],m+=c,w-=8);for(u=f&(1<<-w)-1,f>>=-w,w+=s;w>0;u=u*256+l[t+m],m+=c,w-=8);if(f===0)f=1-d;else{if(f===y)return u?NaN:(b?-1:1)*(1/0);u=u+Math.pow(2,s),f=f-d}return(b?-1:1)*u*Math.pow(2,f-s)};he.write=function(l,t,i,s,o,f){var u,a,y,d=f*8-o-1,w=(1<<d)-1,m=w>>1,c=o===23?Math.pow(2,-24)-Math.pow(2,-77):0,b=s?0:f-1,M=s?1:-1,x=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,u=w):(u=Math.floor(Math.log(t)/Math.LN2),t*(y=Math.pow(2,-u))<1&&(u--,y*=2),u+m>=1?t+=c/y:t+=c*Math.pow(2,1-m),t*y>=2&&(u++,y/=2),u+m>=w?(a=0,u=w):u+m>=1?(a=(t*y-1)*Math.pow(2,o),u=u+m):(a=t*Math.pow(2,m-1)*Math.pow(2,o),u=0));o>=8;l[i+b]=a&255,b+=M,a/=256,o-=8);for(u=u<<o|a,d+=o;d>0;l[i+b]=u&255,b+=M,u/=256,d-=8);l[i+b-M]|=x*128};/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(l){const t=Wt,i=he,s=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;l.Buffer=a,l.SlowBuffer=T,l.INSPECT_MAX_BYTES=50;const o=2147483647;l.kMaxLength=o,a.TYPED_ARRAY_SUPPORT=f(),!a.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function f(){try{const r=new Uint8Array(1),e={foo:function(){return 42}};return Object.setPrototypeOf(e,Uint8Array.prototype),Object.setPrototypeOf(r,e),r.foo()===42}catch{return!1}}Object.defineProperty(a.prototype,"parent",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.buffer}}),Object.defineProperty(a.prototype,"offset",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.byteOffset}});function u(r){if(r>o)throw new RangeError('The value "'+r+'" is invalid for option "size"');const e=new Uint8Array(r);return Object.setPrototypeOf(e,a.prototype),e}function a(r,e,n){if(typeof r=="number"){if(typeof e=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return m(r)}return y(r,e,n)}a.poolSize=8192;function y(r,e,n){if(typeof r=="string")return c(r,e);if(ArrayBuffer.isView(r))return M(r);if(r==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof r);if(ct(r,ArrayBuffer)||r&&ct(r.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(ct(r,SharedArrayBuffer)||r&&ct(r.buffer,SharedArrayBuffer)))return x(r,e,n);if(typeof r=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const h=r.valueOf&&r.valueOf();if(h!=null&&h!==r)return a.from(h,e,n);const p=_(r);if(p)return p;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof r[Symbol.toPrimitive]=="function")return a.from(r[Symbol.toPrimitive]("string"),e,n);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof r)}a.from=function(r,e,n){return y(r,e,n)},Object.setPrototypeOf(a.prototype,Uint8Array.prototype),Object.setPrototypeOf(a,Uint8Array);function d(r){if(typeof r!="number")throw new TypeError('"size" argument must be of type number');if(r<0)throw new RangeError('The value "'+r+'" is invalid for option "size"')}function w(r,e,n){return d(r),r<=0?u(r):e!==void 0?typeof n=="string"?u(r).fill(e,n):u(r).fill(e):u(r)}a.alloc=function(r,e,n){return w(r,e,n)};function m(r){return d(r),u(r<0?0:E(r)|0)}a.allocUnsafe=function(r){return m(r)},a.allocUnsafeSlow=function(r){return m(r)};function c(r,e){if((typeof e!="string"||e==="")&&(e="utf8"),!a.isEncoding(e))throw new TypeError("Unknown encoding: "+e);const n=I(r,e)|0;let h=u(n);const p=h.write(r,e);return p!==n&&(h=h.slice(0,p)),h}function b(r){const e=r.length<0?0:E(r.length)|0,n=u(e);for(let h=0;h<e;h+=1)n[h]=r[h]&255;return n}function M(r){if(ct(r,Uint8Array)){const e=new Uint8Array(r);return x(e.buffer,e.byteOffset,e.byteLength)}return b(r)}function x(r,e,n){if(e<0||r.byteLength<e)throw new RangeError('"offset" is outside of buffer bounds');if(r.byteLength<e+(n||0))throw new RangeError('"length" is outside of buffer bounds');let h;return e===void 0&&n===void 0?h=new Uint8Array(r):n===void 0?h=new Uint8Array(r,e):h=new Uint8Array(r,e,n),Object.setPrototypeOf(h,a.prototype),h}function _(r){if(a.isBuffer(r)){const e=E(r.length)|0,n=u(e);return n.length===0||r.copy(n,0,0,e),n}if(r.length!==void 0)return typeof r.length!="number"||Ht(r.length)?u(0):b(r);if(r.type==="Buffer"&&Array.isArray(r.data))return b(r.data)}function E(r){if(r>=o)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+o.toString(16)+" bytes");return r|0}function T(r){return+r!=r&&(r=0),a.alloc(+r)}a.isBuffer=function(e){return e!=null&&e._isBuffer===!0&&e!==a.prototype},a.compare=function(e,n){if(ct(e,Uint8Array)&&(e=a.from(e,e.offset,e.byteLength)),ct(n,Uint8Array)&&(n=a.from(n,n.offset,n.byteLength)),!a.isBuffer(e)||!a.isBuffer(n))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===n)return 0;let h=e.length,p=n.length;for(let g=0,v=Math.min(h,p);g<v;++g)if(e[g]!==n[g]){h=e[g],p=n[g];break}return h<p?-1:p<h?1:0},a.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},a.concat=function(e,n){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(e.length===0)return a.alloc(0);let h;if(n===void 0)for(n=0,h=0;h<e.length;++h)n+=e[h].length;const p=a.allocUnsafe(n);let g=0;for(h=0;h<e.length;++h){let v=e[h];if(ct(v,Uint8Array))g+v.length>p.length?(a.isBuffer(v)||(v=a.from(v)),v.copy(p,g)):Uint8Array.prototype.set.call(p,v,g);else if(a.isBuffer(v))v.copy(p,g);else throw new TypeError('"list" argument must be an Array of Buffers');g+=v.length}return p};function I(r,e){if(a.isBuffer(r))return r.length;if(ArrayBuffer.isView(r)||ct(r,ArrayBuffer))return r.byteLength;if(typeof r!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof r);const n=r.length,h=arguments.length>2&&arguments[2]===!0;if(!h&&n===0)return 0;let p=!1;for(;;)switch(e){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":return pt(r).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return n*2;case"hex":return n>>>1;case"base64":return ce(r).length;default:if(p)return h?-1:pt(r).length;e=(""+e).toLowerCase(),p=!0}}a.byteLength=I;function R(r,e,n){let h=!1;if((e===void 0||e<0)&&(e=0),e>this.length||((n===void 0||n>this.length)&&(n=this.length),n<=0)||(n>>>=0,e>>>=0,n<=e))return"";for(r||(r="utf8");;)switch(r){case"hex":return mt(this,e,n);case"utf8":case"utf-8":return Y(this,e,n);case"ascii":return J(this,e,n);case"latin1":case"binary":return rt(this,e,n);case"base64":return P(this,e,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return _t(this,e,n);default:if(h)throw new TypeError("Unknown encoding: "+r);r=(r+"").toLowerCase(),h=!0}}a.prototype._isBuffer=!0;function B(r,e,n){const h=r[e];r[e]=r[n],r[n]=h}a.prototype.swap16=function(){const e=this.length;if(e%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let n=0;n<e;n+=2)B(this,n,n+1);return this},a.prototype.swap32=function(){const e=this.length;if(e%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let n=0;n<e;n+=4)B(this,n,n+3),B(this,n+1,n+2);return this},a.prototype.swap64=function(){const e=this.length;if(e%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let n=0;n<e;n+=8)B(this,n,n+7),B(this,n+1,n+6),B(this,n+2,n+5),B(this,n+3,n+4);return this},a.prototype.toString=function(){const e=this.length;return e===0?"":arguments.length===0?Y(this,0,e):R.apply(this,arguments)},a.prototype.toLocaleString=a.prototype.toString,a.prototype.equals=function(e){if(!a.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e?!0:a.compare(this,e)===0},a.prototype.inspect=function(){let e="";const n=l.INSPECT_MAX_BYTES;return e=this.toString("hex",0,n).replace(/(.{2})/g,"$1 ").trim(),this.length>n&&(e+=" ... "),"<Buffer "+e+">"},s&&(a.prototype[s]=a.prototype.inspect),a.prototype.compare=function(e,n,h,p,g){if(ct(e,Uint8Array)&&(e=a.from(e,e.offset,e.byteLength)),!a.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(n===void 0&&(n=0),h===void 0&&(h=e?e.length:0),p===void 0&&(p=0),g===void 0&&(g=this.length),n<0||h>e.length||p<0||g>this.length)throw new RangeError("out of range index");if(p>=g&&n>=h)return 0;if(p>=g)return-1;if(n>=h)return 1;if(n>>>=0,h>>>=0,p>>>=0,g>>>=0,this===e)return 0;let v=g-p,k=h-n;const H=Math.min(v,k),N=this.slice(p,g),K=e.slice(n,h);for(let U=0;U<H;++U)if(N[U]!==K[U]){v=N[U],k=K[U];break}return v<k?-1:k<v?1:0};function C(r,e,n,h,p){if(r.length===0)return-1;if(typeof n=="string"?(h=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,Ht(n)&&(n=p?0:r.length-1),n<0&&(n=r.length+n),n>=r.length){if(p)return-1;n=r.length-1}else if(n<0)if(p)n=0;else return-1;if(typeof e=="string"&&(e=a.from(e,h)),a.isBuffer(e))return e.length===0?-1:G(r,e,n,h,p);if(typeof e=="number")return e=e&255,typeof Uint8Array.prototype.indexOf=="function"?p?Uint8Array.prototype.indexOf.call(r,e,n):Uint8Array.prototype.lastIndexOf.call(r,e,n):G(r,[e],n,h,p);throw new TypeError("val must be string, number or Buffer")}function G(r,e,n,h,p){let g=1,v=r.length,k=e.length;if(h!==void 0&&(h=String(h).toLowerCase(),h==="ucs2"||h==="ucs-2"||h==="utf16le"||h==="utf-16le")){if(r.length<2||e.length<2)return-1;g=2,v/=2,k/=2,n/=2}function H(K,U){return g===1?K[U]:K.readUInt16BE(U*g)}let N;if(p){let K=-1;for(N=n;N<v;N++)if(H(r,N)===H(e,K===-1?0:N-K)){if(K===-1&&(K=N),N-K+1===k)return K*g}else K!==-1&&(N-=N-K),K=-1}else for(n+k>v&&(n=v-k),N=n;N>=0;N--){let K=!0;for(let U=0;U<k;U++)if(H(r,N+U)!==H(e,U)){K=!1;break}if(K)return N}return-1}a.prototype.includes=function(e,n,h){return this.indexOf(e,n,h)!==-1},a.prototype.indexOf=function(e,n,h){return C(this,e,n,h,!0)},a.prototype.lastIndexOf=function(e,n,h){return C(this,e,n,h,!1)};function W(r,e,n,h){n=Number(n)||0;const p=r.length-n;h?(h=Number(h),h>p&&(h=p)):h=p;const g=e.length;h>g/2&&(h=g/2);let v;for(v=0;v<h;++v){const k=parseInt(e.substr(v*2,2),16);if(Ht(k))return v;r[n+v]=k}return v}function $(r,e,n,h){return Ut(pt(e,r.length-n),r,n,h)}function ht(r,e,n,h){return Ut(Lt(e),r,n,h)}function S(r,e,n,h){return Ut(ce(e),r,n,h)}function A(r,e,n,h){return Ut(Dt(e,r.length-n),r,n,h)}a.prototype.write=function(e,n,h,p){if(n===void 0)p="utf8",h=this.length,n=0;else if(h===void 0&&typeof n=="string")p=n,h=this.length,n=0;else if(isFinite(n))n=n>>>0,isFinite(h)?(h=h>>>0,p===void 0&&(p="utf8")):(p=h,h=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const g=this.length-n;if((h===void 0||h>g)&&(h=g),e.length>0&&(h<0||n<0)||n>this.length)throw new RangeError("Attempt to write outside buffer bounds");p||(p="utf8");let v=!1;for(;;)switch(p){case"hex":return W(this,e,n,h);case"utf8":case"utf-8":return $(this,e,n,h);case"ascii":case"latin1":case"binary":return ht(this,e,n,h);case"base64":return S(this,e,n,h);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return A(this,e,n,h);default:if(v)throw new TypeError("Unknown encoding: "+p);p=(""+p).toLowerCase(),v=!0}},a.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function P(r,e,n){return e===0&&n===r.length?t.fromByteArray(r):t.fromByteArray(r.slice(e,n))}function Y(r,e,n){n=Math.min(r.length,n);const h=[];let p=e;for(;p<n;){const g=r[p];let v=null,k=g>239?4:g>223?3:g>191?2:1;if(p+k<=n){let H,N,K,U;switch(k){case 1:g<128&&(v=g);break;case 2:H=r[p+1],(H&192)===128&&(U=(g&31)<<6|H&63,U>127&&(v=U));break;case 3:H=r[p+1],N=r[p+2],(H&192)===128&&(N&192)===128&&(U=(g&15)<<12|(H&63)<<6|N&63,U>2047&&(U<55296||U>57343)&&(v=U));break;case 4:H=r[p+1],N=r[p+2],K=r[p+3],(H&192)===128&&(N&192)===128&&(K&192)===128&&(U=(g&15)<<18|(H&63)<<12|(N&63)<<6|K&63,U>65535&&U<1114112&&(v=U))}}v===null?(v=65533,k=1):v>65535&&(v-=65536,h.push(v>>>10&1023|55296),v=56320|v&1023),h.push(v),p+=k}return st(h)}const X=4096;function st(r){const e=r.length;if(e<=X)return String.fromCharCode.apply(String,r);let n="",h=0;for(;h<e;)n+=String.fromCharCode.apply(String,r.slice(h,h+=X));return n}function J(r,e,n){let h="";n=Math.min(r.length,n);for(let p=e;p<n;++p)h+=String.fromCharCode(r[p]&127);return h}function rt(r,e,n){let h="";n=Math.min(r.length,n);for(let p=e;p<n;++p)h+=String.fromCharCode(r[p]);return h}function mt(r,e,n){const h=r.length;(!e||e<0)&&(e=0),(!n||n<0||n>h)&&(n=h);let p="";for(let g=e;g<n;++g)p+=Ge[r[g]];return p}function _t(r,e,n){const h=r.slice(e,n);let p="";for(let g=0;g<h.length-1;g+=2)p+=String.fromCharCode(h[g]+h[g+1]*256);return p}a.prototype.slice=function(e,n){const h=this.length;e=~~e,n=n===void 0?h:~~n,e<0?(e+=h,e<0&&(e=0)):e>h&&(e=h),n<0?(n+=h,n<0&&(n=0)):n>h&&(n=h),n<e&&(n=e);const p=this.subarray(e,n);return Object.setPrototypeOf(p,a.prototype),p};function q(r,e,n){if(r%1!==0||r<0)throw new RangeError("offset is not uint");if(r+e>n)throw new RangeError("Trying to access beyond buffer length")}a.prototype.readUintLE=a.prototype.readUIntLE=function(e,n,h){e=e>>>0,n=n>>>0,h||q(e,n,this.length);let p=this[e],g=1,v=0;for(;++v<n&&(g*=256);)p+=this[e+v]*g;return p},a.prototype.readUintBE=a.prototype.readUIntBE=function(e,n,h){e=e>>>0,n=n>>>0,h||q(e,n,this.length);let p=this[e+--n],g=1;for(;n>0&&(g*=256);)p+=this[e+--n]*g;return p},a.prototype.readUint8=a.prototype.readUInt8=function(e,n){return e=e>>>0,n||q(e,1,this.length),this[e]},a.prototype.readUint16LE=a.prototype.readUInt16LE=function(e,n){return e=e>>>0,n||q(e,2,this.length),this[e]|this[e+1]<<8},a.prototype.readUint16BE=a.prototype.readUInt16BE=function(e,n){return e=e>>>0,n||q(e,2,this.length),this[e]<<8|this[e+1]},a.prototype.readUint32LE=a.prototype.readUInt32LE=function(e,n){return e=e>>>0,n||q(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+this[e+3]*16777216},a.prototype.readUint32BE=a.prototype.readUInt32BE=function(e,n){return e=e>>>0,n||q(e,4,this.length),this[e]*16777216+(this[e+1]<<16|this[e+2]<<8|this[e+3])},a.prototype.readBigUInt64LE=yt(function(e){e=e>>>0,Q(e,"offset");const n=this[e],h=this[e+7];(n===void 0||h===void 0)&&tt(e,this.length-8);const p=n+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24,g=this[++e]+this[++e]*2**8+this[++e]*2**16+h*2**24;return BigInt(p)+(BigInt(g)<<BigInt(32))}),a.prototype.readBigUInt64BE=yt(function(e){e=e>>>0,Q(e,"offset");const n=this[e],h=this[e+7];(n===void 0||h===void 0)&&tt(e,this.length-8);const p=n*2**24+this[++e]*2**16+this[++e]*2**8+this[++e],g=this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+h;return(BigInt(p)<<BigInt(32))+BigInt(g)}),a.prototype.readIntLE=function(e,n,h){e=e>>>0,n=n>>>0,h||q(e,n,this.length);let p=this[e],g=1,v=0;for(;++v<n&&(g*=256);)p+=this[e+v]*g;return g*=128,p>=g&&(p-=Math.pow(2,8*n)),p},a.prototype.readIntBE=function(e,n,h){e=e>>>0,n=n>>>0,h||q(e,n,this.length);let p=n,g=1,v=this[e+--p];for(;p>0&&(g*=256);)v+=this[e+--p]*g;return g*=128,v>=g&&(v-=Math.pow(2,8*n)),v},a.prototype.readInt8=function(e,n){return e=e>>>0,n||q(e,1,this.length),this[e]&128?(255-this[e]+1)*-1:this[e]},a.prototype.readInt16LE=function(e,n){e=e>>>0,n||q(e,2,this.length);const h=this[e]|this[e+1]<<8;return h&32768?h|4294901760:h},a.prototype.readInt16BE=function(e,n){e=e>>>0,n||q(e,2,this.length);const h=this[e+1]|this[e]<<8;return h&32768?h|4294901760:h},a.prototype.readInt32LE=function(e,n){return e=e>>>0,n||q(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},a.prototype.readInt32BE=function(e,n){return e=e>>>0,n||q(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},a.prototype.readBigInt64LE=yt(function(e){e=e>>>0,Q(e,"offset");const n=this[e],h=this[e+7];(n===void 0||h===void 0)&&tt(e,this.length-8);const p=this[e+4]+this[e+5]*2**8+this[e+6]*2**16+(h<<24);return(BigInt(p)<<BigInt(32))+BigInt(n+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24)}),a.prototype.readBigInt64BE=yt(function(e){e=e>>>0,Q(e,"offset");const n=this[e],h=this[e+7];(n===void 0||h===void 0)&&tt(e,this.length-8);const p=(n<<24)+this[++e]*2**16+this[++e]*2**8+this[++e];return(BigInt(p)<<BigInt(32))+BigInt(this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+h)}),a.prototype.readFloatLE=function(e,n){return e=e>>>0,n||q(e,4,this.length),i.read(this,e,!0,23,4)},a.prototype.readFloatBE=function(e,n){return e=e>>>0,n||q(e,4,this.length),i.read(this,e,!1,23,4)},a.prototype.readDoubleLE=function(e,n){return e=e>>>0,n||q(e,8,this.length),i.read(this,e,!0,52,8)},a.prototype.readDoubleBE=function(e,n){return e=e>>>0,n||q(e,8,this.length),i.read(this,e,!1,52,8)};function Z(r,e,n,h,p,g){if(!a.isBuffer(r))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>p||e<g)throw new RangeError('"value" argument is out of bounds');if(n+h>r.length)throw new RangeError("Index out of range")}a.prototype.writeUintLE=a.prototype.writeUIntLE=function(e,n,h,p){if(e=+e,n=n>>>0,h=h>>>0,!p){const k=Math.pow(2,8*h)-1;Z(this,e,n,h,k,0)}let g=1,v=0;for(this[n]=e&255;++v<h&&(g*=256);)this[n+v]=e/g&255;return n+h},a.prototype.writeUintBE=a.prototype.writeUIntBE=function(e,n,h,p){if(e=+e,n=n>>>0,h=h>>>0,!p){const k=Math.pow(2,8*h)-1;Z(this,e,n,h,k,0)}let g=h-1,v=1;for(this[n+g]=e&255;--g>=0&&(v*=256);)this[n+g]=e/v&255;return n+h},a.prototype.writeUint8=a.prototype.writeUInt8=function(e,n,h){return e=+e,n=n>>>0,h||Z(this,e,n,1,255,0),this[n]=e&255,n+1},a.prototype.writeUint16LE=a.prototype.writeUInt16LE=function(e,n,h){return e=+e,n=n>>>0,h||Z(this,e,n,2,65535,0),this[n]=e&255,this[n+1]=e>>>8,n+2},a.prototype.writeUint16BE=a.prototype.writeUInt16BE=function(e,n,h){return e=+e,n=n>>>0,h||Z(this,e,n,2,65535,0),this[n]=e>>>8,this[n+1]=e&255,n+2},a.prototype.writeUint32LE=a.prototype.writeUInt32LE=function(e,n,h){return e=+e,n=n>>>0,h||Z(this,e,n,4,4294967295,0),this[n+3]=e>>>24,this[n+2]=e>>>16,this[n+1]=e>>>8,this[n]=e&255,n+4},a.prototype.writeUint32BE=a.prototype.writeUInt32BE=function(e,n,h){return e=+e,n=n>>>0,h||Z(this,e,n,4,4294967295,0),this[n]=e>>>24,this[n+1]=e>>>16,this[n+2]=e>>>8,this[n+3]=e&255,n+4};function wt(r,e,n,h,p){nt(e,h,p,r,n,7);let g=Number(e&BigInt(4294967295));r[n++]=g,g=g>>8,r[n++]=g,g=g>>8,r[n++]=g,g=g>>8,r[n++]=g;let v=Number(e>>BigInt(32)&BigInt(4294967295));return r[n++]=v,v=v>>8,r[n++]=v,v=v>>8,r[n++]=v,v=v>>8,r[n++]=v,n}function Ct(r,e,n,h,p){nt(e,h,p,r,n,7);let g=Number(e&BigInt(4294967295));r[n+7]=g,g=g>>8,r[n+6]=g,g=g>>8,r[n+5]=g,g=g>>8,r[n+4]=g;let v=Number(e>>BigInt(32)&BigInt(4294967295));return r[n+3]=v,v=v>>8,r[n+2]=v,v=v>>8,r[n+1]=v,v=v>>8,r[n]=v,n+8}a.prototype.writeBigUInt64LE=yt(function(e,n=0){return wt(this,e,n,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeBigUInt64BE=yt(function(e,n=0){return Ct(this,e,n,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeIntLE=function(e,n,h,p){if(e=+e,n=n>>>0,!p){const H=Math.pow(2,8*h-1);Z(this,e,n,h,H-1,-H)}let g=0,v=1,k=0;for(this[n]=e&255;++g<h&&(v*=256);)e<0&&k===0&&this[n+g-1]!==0&&(k=1),this[n+g]=(e/v>>0)-k&255;return n+h},a.prototype.writeIntBE=function(e,n,h,p){if(e=+e,n=n>>>0,!p){const H=Math.pow(2,8*h-1);Z(this,e,n,h,H-1,-H)}let g=h-1,v=1,k=0;for(this[n+g]=e&255;--g>=0&&(v*=256);)e<0&&k===0&&this[n+g+1]!==0&&(k=1),this[n+g]=(e/v>>0)-k&255;return n+h},a.prototype.writeInt8=function(e,n,h){return e=+e,n=n>>>0,h||Z(this,e,n,1,127,-128),e<0&&(e=255+e+1),this[n]=e&255,n+1},a.prototype.writeInt16LE=function(e,n,h){return e=+e,n=n>>>0,h||Z(this,e,n,2,32767,-32768),this[n]=e&255,this[n+1]=e>>>8,n+2},a.prototype.writeInt16BE=function(e,n,h){return e=+e,n=n>>>0,h||Z(this,e,n,2,32767,-32768),this[n]=e>>>8,this[n+1]=e&255,n+2},a.prototype.writeInt32LE=function(e,n,h){return e=+e,n=n>>>0,h||Z(this,e,n,4,2147483647,-2147483648),this[n]=e&255,this[n+1]=e>>>8,this[n+2]=e>>>16,this[n+3]=e>>>24,n+4},a.prototype.writeInt32BE=function(e,n,h){return e=+e,n=n>>>0,h||Z(this,e,n,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[n]=e>>>24,this[n+1]=e>>>16,this[n+2]=e>>>8,this[n+3]=e&255,n+4},a.prototype.writeBigInt64LE=yt(function(e,n=0){return wt(this,e,n,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),a.prototype.writeBigInt64BE=yt(function(e,n=0){return Ct(this,e,n,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function Tt(r,e,n,h,p,g){if(n+h>r.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function Pt(r,e,n,h,p){return e=+e,n=n>>>0,p||Tt(r,e,n,4),i.write(r,e,n,h,23,4),n+4}a.prototype.writeFloatLE=function(e,n,h){return Pt(this,e,n,!0,h)},a.prototype.writeFloatBE=function(e,n,h){return Pt(this,e,n,!1,h)};function O(r,e,n,h,p){return e=+e,n=n>>>0,p||Tt(r,e,n,8),i.write(r,e,n,h,52,8),n+8}a.prototype.writeDoubleLE=function(e,n,h){return O(this,e,n,!0,h)},a.prototype.writeDoubleBE=function(e,n,h){return O(this,e,n,!1,h)},a.prototype.copy=function(e,n,h,p){if(!a.isBuffer(e))throw new TypeError("argument should be a Buffer");if(h||(h=0),!p&&p!==0&&(p=this.length),n>=e.length&&(n=e.length),n||(n=0),p>0&&p<h&&(p=h),p===h||e.length===0||this.length===0)return 0;if(n<0)throw new RangeError("targetStart out of bounds");if(h<0||h>=this.length)throw new RangeError("Index out of range");if(p<0)throw new RangeError("sourceEnd out of bounds");p>this.length&&(p=this.length),e.length-n<p-h&&(p=e.length-n+h);const g=p-h;return this===e&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(n,h,p):Uint8Array.prototype.set.call(e,this.subarray(h,p),n),g},a.prototype.fill=function(e,n,h,p){if(typeof e=="string"){if(typeof n=="string"?(p=n,n=0,h=this.length):typeof h=="string"&&(p=h,h=this.length),p!==void 0&&typeof p!="string")throw new TypeError("encoding must be a string");if(typeof p=="string"&&!a.isEncoding(p))throw new TypeError("Unknown encoding: "+p);if(e.length===1){const v=e.charCodeAt(0);(p==="utf8"&&v<128||p==="latin1")&&(e=v)}}else typeof e=="number"?e=e&255:typeof e=="boolean"&&(e=Number(e));if(n<0||this.length<n||this.length<h)throw new RangeError("Out of range index");if(h<=n)return this;n=n>>>0,h=h===void 0?this.length:h>>>0,e||(e=0);let g;if(typeof e=="number")for(g=n;g<h;++g)this[g]=e;else{const v=a.isBuffer(e)?e:a.from(e,p),k=v.length;if(k===0)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(g=0;g<h-n;++g)this[g+n]=v[g%k]}return this};const V={};function F(r,e,n){V[r]=class extends n{constructor(){super(),Object.defineProperty(this,"message",{value:e.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${r}]`,this.stack,delete this.name}get code(){return r}set code(p){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:p,writable:!0})}toString(){return`${this.name} [${r}]: ${this.message}`}}}F("ERR_BUFFER_OUT_OF_BOUNDS",function(r){return r?`${r} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),F("ERR_INVALID_ARG_TYPE",function(r,e){return`The "${r}" argument must be of type number. Received type ${typeof e}`},TypeError),F("ERR_OUT_OF_RANGE",function(r,e,n){let h=`The value of "${r}" is out of range.`,p=n;return Number.isInteger(n)&&Math.abs(n)>2**32?p=z(String(n)):typeof n=="bigint"&&(p=String(n),(n>BigInt(2)**BigInt(32)||n<-(BigInt(2)**BigInt(32)))&&(p=z(p)),p+="n"),h+=` It must be ${e}. Received ${p}`,h},RangeError);function z(r){let e="",n=r.length;const h=r[0]==="-"?1:0;for(;n>=h+4;n-=3)e=`_${r.slice(n-3,n)}${e}`;return`${r.slice(0,n)}${e}`}function gt(r,e,n){Q(e,"offset"),(r[e]===void 0||r[e+n]===void 0)&&tt(e,r.length-(n+1))}function nt(r,e,n,h,p,g){if(r>n||r<e){const v=typeof e=="bigint"?"n":"";let k;throw e===0||e===BigInt(0)?k=`>= 0${v} and < 2${v} ** ${(g+1)*8}${v}`:k=`>= -(2${v} ** ${(g+1)*8-1}${v}) and < 2 ** ${(g+1)*8-1}${v}`,new V.ERR_OUT_OF_RANGE("value",k,r)}gt(h,p,g)}function Q(r,e){if(typeof r!="number")throw new V.ERR_INVALID_ARG_TYPE(e,"number",r)}function tt(r,e,n){throw Math.floor(r)!==r?(Q(r,n),new V.ERR_OUT_OF_RANGE("offset","an integer",r)):e<0?new V.ERR_BUFFER_OUT_OF_BOUNDS:new V.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${e}`,r)}const dt=/[^+/0-9A-Za-z-_]/g;function bt(r){if(r=r.split("=")[0],r=r.trim().replace(dt,""),r.length<2)return"";for(;r.length%4!==0;)r=r+"=";return r}function pt(r,e){e=e||1/0;let n;const h=r.length;let p=null;const g=[];for(let v=0;v<h;++v){if(n=r.charCodeAt(v),n>55295&&n<57344){if(!p){if(n>56319){(e-=3)>-1&&g.push(239,191,189);continue}else if(v+1===h){(e-=3)>-1&&g.push(239,191,189);continue}p=n;continue}if(n<56320){(e-=3)>-1&&g.push(239,191,189),p=n;continue}n=(p-55296<<10|n-56320)+65536}else p&&(e-=3)>-1&&g.push(239,191,189);if(p=null,n<128){if((e-=1)<0)break;g.push(n)}else if(n<2048){if((e-=2)<0)break;g.push(n>>6|192,n&63|128)}else if(n<65536){if((e-=3)<0)break;g.push(n>>12|224,n>>6&63|128,n&63|128)}else if(n<1114112){if((e-=4)<0)break;g.push(n>>18|240,n>>12&63|128,n>>6&63|128,n&63|128)}else throw new Error("Invalid code point")}return g}function Lt(r){const e=[];for(let n=0;n<r.length;++n)e.push(r.charCodeAt(n)&255);return e}function Dt(r,e){let n,h,p;const g=[];for(let v=0;v<r.length&&!((e-=2)<0);++v)n=r.charCodeAt(v),h=n>>8,p=n%256,g.push(p),g.push(h);return g}function ce(r){return t.toByteArray(bt(r))}function Ut(r,e,n,h){let p;for(p=0;p<h&&!(p+n>=e.length||p>=r.length);++p)e[p+n]=r[p];return p}function ct(r,e){return r instanceof e||r!=null&&r.constructor!=null&&r.constructor.name!=null&&r.constructor.name===e.name}function Ht(r){return r!==r}const Ge=function(){const r="0123456789abcdef",e=new Array(256);for(let n=0;n<16;++n){const h=n*16;for(let p=0;p<16;++p)e[h+p]=r[n]+r[p]}return e}();function yt(r){return typeof BigInt>"u"?We:r}function We(){throw new Error("BigInt not supported")}})(ae);function vi(l){if(typeof l!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!l)throw new Error("No input");const t=JSON.parse(l),i=t;let s;if(i.type==="system")if(i.event==="connected")s=Object.assign(Object.assign({},t),{kind:"connected"});else if(i.event==="disconnected")s=Object.assign(Object.assign({},t),{kind:"disconnected"});else return null;else if(i.type==="message")if(i.from==="group"){const o=Me(t.data,t.dataType);if(o===null)return null;s=Object.assign(Object.assign({},t),{data:o,kind:"groupData"})}else if(i.from==="server"){const o=Me(t.data,t.dataType);if(o===null)return null;s=Object.assign(Object.assign({},t),{data:o,kind:"serverData"})}else return null;else if(i.type==="ack")s=Object.assign(Object.assign({},t),{kind:"ack"});else return null;return s}function xi(l){let t;switch(l.kind){case"joinGroup":{t={type:"joinGroup",group:l.group,ackId:l.ackId};break}case"leaveGroup":{t={type:"leaveGroup",group:l.group,ackId:l.ackId};break}case"sendEvent":{t={type:"event",event:l.event,ackId:l.ackId,dataType:l.dataType,data:xe(l.data,l.dataType)};break}case"sendToGroup":{t={type:"sendToGroup",group:l.group,ackId:l.ackId,dataType:l.dataType,data:xe(l.data,l.dataType),noEcho:l.noEcho};break}case"sequenceAck":{t={type:"sequenceAck",sequenceId:l.sequenceId};break}default:throw new Error(`Unsupported type: ${l.kind}`)}return JSON.stringify(t)}function xe(l,t){switch(t){case"text":{if(typeof l!="string")throw new TypeError("Message must be a string.");return l}case"json":return l;case"binary":case"protobuf":{if(l instanceof ArrayBuffer)return ae.Buffer.from(l).toString("base64");throw new TypeError("Message must be a ArrayBuffer")}}}function Me(l,t){if(t==="text"){if(typeof l!="string")throw new TypeError("Message must be a string when dataType is text");return l}else{if(t==="json")return l;if(t==="binary"||t==="protobuf"){const i=ae.Buffer.from(l,"base64");return i.buffer.slice(i.byteOffset,i.byteOffset+i.byteLength)}else return null}}class Mi{constructor(){this.isReliableSubProtocol=!0,this.name="json.reliable.webpubsub.azure.v1"}parseMessages(t){return vi(t)}writeMessage(t){return xi(t)}}const Si=()=>new Mi;class _i{constructor(t,i){this._socket=new WebSocket(t,i),this._socket.binaryType="arraybuffer"}onopen(t){this._socket.onopen=t}onclose(t){this._socket.onclose=i=>t(i.code,i.reason)}onerror(t){this._socket.onerror=i=>t(i)}onmessage(t){this._socket.onmessage=i=>t(i.data)}close(t,i){this._socket.close(t,i)}send(t,i){return new Promise((s,o)=>{try{this._socket.send(t),s()}catch(f){o(f)}})}isOpen(){return this._socket.readyState===WebSocket.OPEN}}class Ti{create(t,i){return new _i(t,i)}}async function Ei(l,t){if(t.aborted)throw new Jt("The operation was aborted.");let i;const s=new Promise((o,f)=>{i=()=>{f(new Jt("The operation was aborted."))},t.addEventListener("abort",i)});try{return await Promise.race([l,s])}finally{t.removeEventListener("abort",i)}}var it;(function(l){l.Stopped="Stopped",l.Disconnected="Disconnected",l.Connecting="Connecting",l.Connected="Connected",l.Recovering="Recovering"})(it||(it={}));class Ri{nextAckId(){return this._ackId=this._ackId+1,this._ackId}constructor(t,i){this._quickSequenceAckDiff=300,this._activeTimeoutInMs=2e4,this._emitter=new ri,this._isStopping=!1,this._isInitialConnected=!1,typeof t=="string"?this._credential={getClientAccessUrl:t}:this._credential=t,i==null&&(i={}),this._buildDefaultOptions(i),this._options=i,this._messageRetryPolicy=new Se(this._options.messageRetryOptions),this._reconnectRetryPolicy=new Se(this._options.reconnectRetryOptions),this._protocol=this._options.protocol,this._groupMap=new Map,this._ackMap=new Map,this._sequenceId=new ki,this._state=it.Stopped,this._ackId=0}async start(t){if(this._isStopping)throw new Error("Can't start a client during stopping");if(this._state!==it.Stopped)throw new Error("Client can be only started when it's Stopped");let i;t&&(i=t.abortSignal),this._activeKeepaliveTask||(this._activeKeepaliveTask=this._getActiveKeepaliveTask());try{await this._startCore(i)}catch(s){throw this._changeState(it.Stopped),this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0),this._isStopping=!1,s}}async _startFromRestarting(t){if(this._state!==it.Disconnected)throw new Error("Client can be only restarted when it's Disconnected");try{et.verbose("Staring reconnecting."),await this._startCore(t)}catch(i){throw this._changeState(it.Disconnected),i}}async _startCore(t){if(this._changeState(it.Connecting),et.info("Staring a new connection"),this._sequenceId.reset(),this._isInitialConnected=!1,this._lastCloseEvent=void 0,this._lastDisconnectedMessage=void 0,this._connectionId=void 0,this._reconnectionToken=void 0,this._uri=void 0,typeof this._credential.getClientAccessUrl=="string"?this._uri=this._credential.getClientAccessUrl:this._uri=await this._credential.getClientAccessUrl({abortSignal:t}),typeof this._uri!="string")throw new Error(`The clientAccessUrl must be a string but currently it's ${typeof this._uri}`);await this._connectCore(this._uri)}stop(){this._state===it.Stopped||this._isStopping||(this._isStopping=!0,this._wsClient&&this._wsClient.isOpen()?this._wsClient.close():this._isStopping=!1,this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0))}on(t,i){this._emitter.on(t,i)}off(t,i){this._emitter.removeListener(t,i)}_emitEvent(t,i){this._emitter.emit(t,i)}async sendEvent(t,i,s,o){return this._operationExecuteWithRetry(()=>this._sendEventAttempt(t,i,s,o),o==null?void 0:o.abortSignal)}async _sendEventAttempt(t,i,s,o){var f;if(!((f=o==null?void 0:o.fireAndForget)!==null&&f!==void 0?f:!1))return this._sendMessageWithAckId(y=>({kind:"sendEvent",dataType:s,data:i,ackId:y,event:t}),o==null?void 0:o.ackId,o==null?void 0:o.abortSignal);const a={kind:"sendEvent",dataType:s,data:i,event:t};return await this._sendMessage(a,o==null?void 0:o.abortSignal),{isDuplicated:!1}}async joinGroup(t,i){return this._operationExecuteWithRetry(()=>this._joinGroupAttempt(t,i),i==null?void 0:i.abortSignal)}async _joinGroupAttempt(t,i){const s=this._getOrAddGroup(t),o=await this._joinGroupCore(t,i);return s.isJoined=!0,o}async _joinGroupCore(t,i){return this._sendMessageWithAckId(s=>({group:t,ackId:s,kind:"joinGroup"}),i==null?void 0:i.ackId,i==null?void 0:i.abortSignal)}async leaveGroup(t,i){return this._operationExecuteWithRetry(()=>this._leaveGroupAttempt(t,i),i==null?void 0:i.abortSignal)}async _leaveGroupAttempt(t,i){const s=this._getOrAddGroup(t),o=await this._sendMessageWithAckId(f=>({group:t,ackId:f,kind:"leaveGroup"}),i==null?void 0:i.ackId,i==null?void 0:i.abortSignal);return s.isJoined=!1,o}async sendToGroup(t,i,s,o){return this._operationExecuteWithRetry(()=>this._sendToGroupAttempt(t,i,s,o),o==null?void 0:o.abortSignal)}async _sendToGroupAttempt(t,i,s,o){var f,u;const a=(f=o==null?void 0:o.fireAndForget)!==null&&f!==void 0?f:!1,y=(u=o==null?void 0:o.noEcho)!==null&&u!==void 0?u:!1;if(!a)return this._sendMessageWithAckId(w=>({kind:"sendToGroup",group:t,dataType:s,data:i,ackId:w,noEcho:y}),o==null?void 0:o.ackId,o==null?void 0:o.abortSignal);const d={kind:"sendToGroup",group:t,dataType:s,data:i,noEcho:y};return await this._sendMessage(d,o==null?void 0:o.abortSignal),{isDuplicated:!1}}_getWebSocketClientFactory(){return new Ti}async _trySendSequenceAck(){if(!this._protocol.isReliableSubProtocol)return;const[t,i]=this._sequenceId.tryGetSequenceId();if(t&&i!==null&&i!==void 0){const s={kind:"sequenceAck",sequenceId:i};try{await this._sendMessage(s)}catch{this._sequenceId.tryUpdate(i)}}}_connectCore(t){if(this._isStopping)throw new Error("Can't start a client during stopping");return new Promise((i,s)=>{const o=this._wsClient=this._getWebSocketClientFactory().create(t,this._protocol.name);o.onopen(()=>{if(this._isStopping){try{o.close()}catch{}s(new Error("The client is stopped"))}et.verbose("WebSocket connection has opened"),this._changeState(it.Connected),this._protocol.isReliableSubProtocol&&(this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),this._sequenceAckTask=new _e(async()=>{await this._trySendSequenceAck()},1e3)),i()}),o.onerror(f=>{this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),s(f)}),o.onclose((f,u)=>{this._state===it.Connected?(et.verbose("WebSocket closed after open"),this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),et.info(`WebSocket connection closed. Code: ${f}, Reason: ${u}`),this._lastCloseEvent={code:f,reason:u},this._handleConnectionClose.call(this)):(et.verbose("WebSocket closed before open"),s(new Error(`Failed to start WebSocket: ${f}`)))}),o.onmessage(f=>{const u=c=>{if(this._ackMap.has(c.ackId)){const b=this._ackMap.get(c.ackId);this._ackMap.delete(c.ackId);const M=c.error!=null&&c.error.name==="Duplicate";c.success||M?b.resolve({ackId:c.ackId,isDuplicated:M}):b.reject(new Ot("Failed to send message.",{ackId:c.ackId,errorDetail:c.error}))}},a=async c=>{if(this._connectionId=c.connectionId,this._reconnectionToken=c.reconnectionToken,!this._isInitialConnected){if(this._isInitialConnected=!0,this._options.autoRejoinGroups){const b=[];this._groupMap.forEach(M=>{M.isJoined&&b.push((async()=>{try{await this._joinGroupCore(M.name)}catch(x){this._safeEmitRejoinGroupFailed(M.name,x)}})())}),await Promise.all(b).catch(()=>{})}this._safeEmitConnected(c.connectionId,c.userId)}},y=c=>{this._lastDisconnectedMessage=c},d=c=>{if(c.sequenceId!=null){const b=this._sequenceId.tryUpdate(c.sequenceId);if(b===0)return;b>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitGroupMessage(c)},w=c=>{if(c.sequenceId!=null){const b=this._sequenceId.tryUpdate(c.sequenceId);if(b===0)return;b>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitServerMessage(c)};let m;try{let c;if(Array.isArray(f)?c=Buffer.concat(f):c=f,m=this._protocol.parseMessages(c),m===null)return}catch(c){throw et.warning("An error occurred while parsing the message from service",c),c}Array.isArray(m)||(m=[m]),m.forEach(c=>{try{switch(c.kind){case"ack":{u(c);break}case"connected":{a(c);break}case"disconnected":{y(c);break}case"groupData":{d(c);break}case"serverData":{w(c);break}}}catch(b){et.warning(`An error occurred while handling the message with kind: ${c.kind} from service`,b)}})})})}async _handleConnectionCloseAndNoRecovery(){this._state=it.Disconnected,this._safeEmitDisconnected(this._connectionId,this._lastDisconnectedMessage),this._options.autoReconnect?await this._autoReconnect():await this._handleConnectionStopped()}async _autoReconnect(){let t=!1,i=0;try{for(;!this._isStopping;)try{await this._startFromRestarting(),t=!0;break}catch(s){et.warning("An attempt to reconnect connection failed.",s),i++;const o=this._reconnectRetryPolicy.nextRetryDelayInMs(i);if(o==null)break;et.verbose(`Delay time for reconnect attempt ${i}: ${o}`),await Ft(o).catch(()=>{})}}finally{t||this._handleConnectionStopped()}}_handleConnectionStopped(){this._isStopping=!1,this._state=it.Stopped,this._safeEmitStopped()}_getActiveKeepaliveTask(){return new _e(async()=>{this._sequenceId.tryUpdate(0)},this._activeTimeoutInMs)}async _sendMessage(t,i){if(!this._wsClient||!this._wsClient.isOpen())throw new Error("The connection is not connected.");const s=this._protocol.writeMessage(t);await this._wsClient.send(s,i)}async _sendMessageWithAckId(t,i,s){i==null&&(i=this.nextAckId());const o=t(i);this._ackMap.has(i)||this._ackMap.set(i,new Ai(i));const f=this._ackMap.get(i);try{await this._sendMessage(o,s)}catch(u){this._ackMap.delete(i);let a="";throw u instanceof Error&&(a=u.message),new Ot(a,{ackId:i})}if(s)try{return await Ei(f.promise(),s)}catch(u){throw u instanceof Error&&u.name==="AbortError"?new Ot("Cancelled by abortSignal",{ackId:i}):u}return f.promise()}async _handleConnectionClose(){if(this._ackMap.forEach((o,f)=>{this._ackMap.delete(f)&&o.reject(new Ot("Connection is disconnected before receive ack from the service",{ackId:o.ackId}))}),this._isStopping){et.warning("The client is stopping state. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(this._lastCloseEvent&&this._lastCloseEvent.code===1008){et.warning("The websocket close with status code 1008. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(!this._protocol.isReliableSubProtocol){et.warning("The protocol is not reliable, recovery is not applicable"),this._handleConnectionCloseAndNoRecovery();return}const t=this._buildRecoveryUri();if(!t){et.warning("Connection id or reconnection token is not available"),this._handleConnectionCloseAndNoRecovery();return}let i=!1;this._state=it.Recovering;const s=AbortSignal.timeout(30*1e3);try{for(;!s.aborted||this._isStopping;)try{await this._connectCore.call(this,t),i=!0;return}catch{await Ft(1e3)}}finally{i||(et.warning("Recovery attempts failed more then 30 seconds or the client is stopping"),this._handleConnectionCloseAndNoRecovery())}}_safeEmitConnected(t,i){this._emitEvent("connected",{connectionId:t,userId:i})}_safeEmitDisconnected(t,i){this._emitEvent("disconnected",{connectionId:t,message:i})}_safeEmitGroupMessage(t){this._emitEvent("group-message",{message:t})}_safeEmitServerMessage(t){this._emitEvent("server-message",{message:t})}_safeEmitStopped(){this._emitEvent("stopped",{})}_safeEmitRejoinGroupFailed(t,i){this._emitEvent("rejoin-group-failed",{group:t,error:i})}_buildDefaultOptions(t){return t.autoReconnect==null&&(t.autoReconnect=!0),t.autoRejoinGroups==null&&(t.autoRejoinGroups=!0),t.protocol==null&&(t.protocol=Si()),this._buildMessageRetryOptions(t),this._buildReconnectRetryOptions(t),t}_buildMessageRetryOptions(t){t.messageRetryOptions||(t.messageRetryOptions={}),(t.messageRetryOptions.maxRetries==null||t.messageRetryOptions.maxRetries<0)&&(t.messageRetryOptions.maxRetries=3),(t.messageRetryOptions.retryDelayInMs==null||t.messageRetryOptions.retryDelayInMs<0)&&(t.messageRetryOptions.retryDelayInMs=1e3),(t.messageRetryOptions.maxRetryDelayInMs==null||t.messageRetryOptions.maxRetryDelayInMs<0)&&(t.messageRetryOptions.maxRetryDelayInMs=3e4),t.messageRetryOptions.mode==null&&(t.messageRetryOptions.mode="Fixed")}_buildReconnectRetryOptions(t){t.reconnectRetryOptions||(t.reconnectRetryOptions={}),(t.reconnectRetryOptions.maxRetries==null||t.reconnectRetryOptions.maxRetries<0)&&(t.reconnectRetryOptions.maxRetries=Number.MAX_VALUE),(t.reconnectRetryOptions.retryDelayInMs==null||t.reconnectRetryOptions.retryDelayInMs<0)&&(t.reconnectRetryOptions.retryDelayInMs=1e3),(t.reconnectRetryOptions.maxRetryDelayInMs==null||t.reconnectRetryOptions.maxRetryDelayInMs<0)&&(t.reconnectRetryOptions.maxRetryDelayInMs=3e4),t.reconnectRetryOptions.mode==null&&(t.reconnectRetryOptions.mode="Fixed")}_buildRecoveryUri(){if(this._connectionId&&this._reconnectionToken&&this._uri){const t=new URL(this._uri);return t.searchParams.append("awps_connection_id",this._connectionId),t.searchParams.append("awps_reconnection_token",this._reconnectionToken),t.toString()}return null}_getOrAddGroup(t){return this._groupMap.has(t)||this._groupMap.set(t,new Ii(t)),this._groupMap.get(t)}_changeState(t){et.verbose(`The client state transfer from ${this._state.toString()} to ${t.toString()}`),this._state=t}async _operationExecuteWithRetry(t,i){let s=0;for(;;)try{return await t.call(this)}catch(o){s++;const f=this._messageRetryPolicy.nextRetryDelayInMs(s);if(f==null||(await Ft(f),i!=null&&i.aborted))throw o}}}class Se{constructor(t){this._retryOptions=t,this._maxRetriesToGetMaxDelay=Math.ceil(Math.log2(this._retryOptions.maxRetryDelayInMs)-Math.log2(this._retryOptions.retryDelayInMs)+1)}nextRetryDelayInMs(t){return t>this._retryOptions.maxRetries?null:this._retryOptions.mode==="Fixed"?this._retryOptions.retryDelayInMs:this._calculateExponentialDelay(t)}_calculateExponentialDelay(t){return t>=this._maxRetriesToGetMaxDelay?this._retryOptions.maxRetryDelayInMs:(1<<t-1)*this._retryOptions.retryDelayInMs}}class Ii{constructor(t){this.isJoined=!1,this.name=t}}class Ai{constructor(t){this._promise=new Promise((i,s)=>{this._resolve=i,this._reject=s}),this.ackId=t}promise(){return this._promise}resolve(t){this._resolve(t)}reject(t){this._reject(t)}}class ki{constructor(){this._sequenceId=0,this._isUpdate=!1}tryUpdate(t){if(this._isUpdate=!0,t>this._sequenceId){const i=t-this._sequenceId;return this._sequenceId=t,i}return 0}tryGetSequenceId(){return this._isUpdate?(this._isUpdate=!1,[!0,this._sequenceId]):[!1,null]}reset(){this._sequenceId=0,this._isUpdate=!1}}class _e{constructor(t,i,s){this._func=t,this._abortController=new AbortController,this._interval=i,this._obj=s,this._start()}abort(){try{this._abortController.abort()}catch{}}async _start(){const t=this._abortController.signal;for(;!t.aborted;)try{await this._func(this._obj)}catch{}finally{await Ft(this._interval)}}}class Te{constructor(t){this.negotiateUrl=t,this.client=null,this.group=null,this.connected=!1,this.onDisc=[],this.onErr=[],this.mode="azure",this.bc=null,this.lastError=null,this.onMsgHandler=null,this.id=Math.random().toString(36).slice(2,8)}async connect(t){this.group=`room_${t}`;try{const i=await fetch(this.negotiateUrl,{credentials:"include"});if(!i.ok){const f=await i.text().catch(()=>"");throw this.lastError=`negotiate ${i.status}: ${f==null?void 0:f.slice(0,180)}`,new Error(this.lastError)}const{url:s}=await i.json().catch(()=>({url:null}));if(!s)throw new Error("no url");const o=new Ri(s);this.client=o,this.mode="azure",o.on("connected",()=>{this.connected=!0}),o.on("disconnected",()=>{this.connected=!1,this.onDisc.forEach(f=>f())}),o.on("stopped",()=>{this.connected=!1,this.onDisc.forEach(f=>f())}),o.on("group-message",({message:f})=>{var u;try{(u=this.onMsgHandler)==null||u.call(this,JSON.parse(String(f.data)))}catch{}}),await o.start(),await o.joinGroup(this.group),this.connected=!0}catch(i){this.lastError=(i==null?void 0:i.message)||String(i);const s=typeof window<"u"&&window.location.hostname||"";if(!(s==="localhost"||s==="127.0.0.1"||s.endsWith(".local")))throw this.onErr.forEach(f=>f(i)),i;try{this.mode="local",this.bc=new BroadcastChannel(this.group),this.bc.onmessage=f=>{var a;const u=f.data;try{(a=this.onMsgHandler)==null||a.call(this,u)}catch{}},this.connected=!0,this.lastError=null}catch{throw this.onErr.forEach(u=>u(i)),i}}}onMessage(t){this.onMsgHandler=t}onDisconnected(t){this.onDisc.push(t)}onError(t){this.onErr.push(t)}async send(t){if(!(!this.client||!this.connected||!this.group))try{this.mode==="azure"?await this.client.sendToGroup(this.group,JSON.stringify(t),"text"):this.mode==="local"&&this.bc&&this.bc.postMessage(t)}catch(i){this.onErr.forEach(s=>s(i))}}close(){var t;try{(t=this.bc)==null||t.close()}catch{}}getTransport(){return this.mode}getLastError(){return this.lastError}}class ee{constructor(t,i){this.p1=new kt(80,140,26,26),this.p2=new kt(120,220,26,26),this.obstacles=[],this.hud=new ie,this.s1=0,this.s2=0,this.speed=140,this.timeToNext=0,this.paused=!1,this.rt=null,this.bullets=[],this.enemyBullets=[],this.powerups=[],this.multishotUntil=0,this.bigshotUntil=0,this.slowmoUntil=0,this.magnetUntil=0,this.isTouch="ontouchstart"in window,this.mobileMoveX=0,this.shootingHeld=!1,this.touchShootHeld=!1,this.hintT=4,this.btnRects=null,this.btnLeftDown=!1,this.btnRightDown=!1,this.btnShootDown=!1,this.lefty=!1,this.lastLeftCornerTap=0,this.prevPadButtons=[],this.remoteHistory=[],this.sendAccum=0,this.toast=null,this.isLeader=!1,this.remoteId=null,this.reconnecting=!1,this.retries=0,this.unloadHandler=null,this.waiting=!0,this.bothReady=!1,this.presenceAccum=0,this.myId=null,this.lastMsgAt=0,this.starting=!1,this.startAt=0,this.lastCountdownSecond=0,this.trailAccum=0,this.particles=new $t,this.remoteParticles=new $t,this.roomId=t,this.name=i}async init(t){this.renderer=new se(t.canvas,t.ctx);const i="/api/negotiate";this.rt=new Te(i);try{await this.rt.connect(this.roomId)}catch{this.toast={text:"Online: failed to connect",t:3};return}const s=this.rt.id;this.myId=s,this.rt.onMessage(d=>{if(this.lastMsgAt=performance.now(),d.type==="state"&&d.id!==s)this.remoteHistory.push({t:d.t,x:d.x,y:d.y,vy:d.vy,score:d.score,hp:d.hp,name:d.name}),this.remoteHistory.length>30&&this.remoteHistory.shift(),this.remoteName=d.name||this.remoteName;else if(d.type==="spawn"&&this.isLeader===!1){const w=t.canvas.height,m=80,c=t.canvas.width+m,b=d.topH,M=d.gap;this.speed=d.speed,this.obstacles.push(new ft(c,0,m,b,this.speed)),this.obstacles.push(new ft(c,b+M,m,w-(b+M),this.speed))}else if(d.type==="join"&&d.id!==s)this.remoteId=d.id,this.remoteName=d.name,this.isLeader=s<d.id,this.toast={text:`${d.name||"Opponent"} joined`,t:2.5},this.bothReady=!0,this.isLeader&&this.waiting&&setTimeout(()=>{var c;const m=performance.now()+2e3;(c=this.rt)==null||c.send({type:"start",id:s,roomId:this.roomId,t:performance.now(),startAt:m,delayMs:2e3}),this.startAt=m,this.waiting=!1,this.starting=!0,this.lastCountdownSecond=4},600);else if(d.type==="start"){const w=d.startAt,m=d.delayMs;typeof w=="number"?this.startAt=w:this.startAt=performance.now()+(typeof m=="number"?m:1500),this.waiting=!1,this.starting=!0,this.lastCountdownSecond=4}else if(d.type==="leave"&&d.id!==s)this.toast={text:"Opponent left",t:3},this.waiting=!0,this.bothReady=!1,this.remoteId=null;else if(d.type==="shoot"&&d.id!==s){const w=new Vt(d.x,d.y,d.vx,d.vy,"p2");d.w&&(w.width=d.w),d.h&&(w.height=d.h),d.color&&(w.color=d.color),this.enemyBullets.push(w)}else if(d.type==="powerSpawn"){const w=d.kind,m=new Yt(d.x,d.y,w);m.vx=d.vx,m.pid=d.pid,this.powerups.push(m)}else if(d.type==="pickup"){const w=d.pid,m=this.powerups.findIndex(c=>c.pid===w);m>=0&&this.powerups.splice(m,1)}}),this.toast={text:`Connected • Room ${this.roomId} • ${this.rt.getTransport().toUpperCase()}`,t:2.5},this.rt.send({type:"join",id:s,roomId:this.roomId,name:this.name}),this.rt.onDisconnected(()=>{this.toast={text:"Online: disconnected",t:3},!this.reconnecting&&this.retries<2&&(this.reconnecting=!0,this.retries++,setTimeout(()=>this.reconnect(i),1500))}),this.unloadHandler=d=>{var w;try{(w=this.rt)==null||w.send({type:"leave",id:s,roomId:this.roomId})}catch{}},window.addEventListener("beforeunload",this.unloadHandler);try{const d=localStorage.getItem("lefty");this.lefty=d==="1"}catch{}try{t.canvas.style.touchAction="none"}catch{}const o=d=>{d.button===2&&d.preventDefault();const w=Ee(d.button??0);w==="flap"?(j.jump(this.p1),L.flap(),this.particles.burst(this.p1.x+this.p1.width*.2,this.p1.y+this.p1.height*.7,10,"#9bd1ff")):w==="shoot"&&(this.p1.fireCooldown<=0&&(this.fireBullet(this.p1,"p1",t),this.p1.fireCooldown=.35*(this.isRapid()?.55:1)),this.shootingHeld=!0)};t.canvas.onpointerdown=o,t.canvas.oncontextmenu=d=>{d.preventDefault()},t.canvas.onpointerup=d=>{(d.button??0)===2&&(this.shootingHeld=!1)};const f=d=>{const w=t.canvas.getBoundingClientRect();let m=0,c=0;for(let b=0;b<d.touches.length;b++){const x=d.touches.item(b).clientX-w.left;x<w.width*.45?m=1:x>w.width*.55&&(c=1)}this.mobileMoveX=c-m},u=()=>{const d=t.canvas.width,w=t.canvas.height,m=Math.max(60,Math.min(120,Math.floor(Math.min(d,w)*.14))),c=24;this.btnRects={left:{x:c,y:w-m-c,w:m,h:m},right:{x:c+m+16,y:w-m-c,w:m,h:m},shoot:{x:this.lefty?c:d-m-c,y:w-m-c,w:m,h:m}}},a=(d,w,m)=>{if(!this.btnRects)return!1;const c=this.btnRects[d];return w>=c.x&&w<=c.x+c.w&&m>=c.y&&m<=c.y+c.h},y=d=>{var _;const w=t.canvas.width,m=t.canvas.height,c=t.canvas.getBoundingClientRect(),b=w/c.width,M=m/c.height;u(),this.btnLeftDown=this.btnRightDown=this.btnShootDown=!1;for(let E=0;E<d.touches.length;E++){const T=d.touches.item(E),I=(T.clientX-c.left)*b,R=(T.clientY-c.top)*M;a("left",I,R)?this.btnLeftDown=!0:a("right",I,R)?this.btnRightDown=!0:a("shoot",I,R)&&(this.btnShootDown=!0)}let x=!1;for(let E=0;E<d.touches.length;E++){const T=d.touches.item(E),I=(T.clientX-c.left)*b,R=(T.clientY-c.top)*M;if(!this.lefty?I>w*.7&&R>m*.6:I<w*.3&&R>m*.6){x=!0;break}}if(d.touches.length>=2||x||this.btnShootDown){this.p1.fireCooldown<=0&&(this.fireBullet(this.p1,"p1",t),this.p1.fireCooldown=.35*(this.isRapid()?.55:1)),this.touchShootHeld=!0;return}if(d.touches.length===1){const E=d.touches.item(0),T=(E.clientX-c.left)*b,I=(E.clientY-c.top)*M;if(T<w*.2&&I>m*.8){const R=performance.now();if(R-this.lastLeftCornerTap<500){this.lefty=!this.lefty,this.toast={text:`Left-handed ${this.lefty?"ON":"OFF"}`,t:2.2};try{localStorage.setItem("lefty",this.lefty?"1":"0")}catch{}}this.lastLeftCornerTap=R}}j.jump(this.p1),L.flap();try{(_=navigator.vibrate)==null||_.call(navigator,10)}catch{}this.particles.burst(this.p1.x+this.p1.width*.2,this.p1.y+this.p1.height*.7,10,"#9bd1ff")};t.canvas.ontouchstart=d=>{d.preventDefault(),f(d),y(d)},t.canvas.ontouchmove=d=>{d.preventDefault(),f(d)},t.canvas.ontouchend=d=>{d.preventDefault(),f(d),this.touchShootHeld=!1}}dispose(){var t;try{this.rt&&this.myId&&this.rt.send({type:"leave",id:this.myId,roomId:this.roomId})}catch{}try{this.unloadHandler&&window.removeEventListener("beforeunload",this.unloadHandler)}catch{}try{(t=this.rt)==null||t.close()}catch{}}async reconnect(t){this.rt;const i=this.name;this.rt=new Te(t);try{await this.rt.connect(this.roomId);const s=this.rt.id;this.toast={text:"Online: reconnected",t:2.5},this.rt.onMessage(o=>{if(this.lastMsgAt=performance.now(),o.type==="state"&&o.id!==s)this.remoteHistory.push({t:o.t,x:o.x,y:o.y,vy:o.vy,score:o.score,hp:o.hp,name:o.name}),this.remoteHistory.length>30&&this.remoteHistory.shift(),this.remoteName=o.name||this.remoteName;else if(o.type==="spawn"&&this.isLeader===!1){const f=this.renderer.canvas.height,u=80,a=this.renderer.canvas.width+u,y=o.topH,d=o.gap;this.speed=o.speed,this.obstacles.push(new ft(a,0,u,y,this.speed)),this.obstacles.push(new ft(a,y+d,u,f-(y+d),this.speed))}else o.type==="join"&&o.id!==s?(this.remoteId=o.id,this.remoteName=o.name,this.isLeader=s<o.id):o.type==="leave"&&o.id!==s&&(this.toast={text:"Opponent left",t:3})}),this.rt.onDisconnected(()=>{this.toast={text:"Online: disconnected",t:3}}),this.rt.send({type:"join",id:this.rt.id,roomId:this.roomId,name:i})}catch{this.toast={text:"Online: reconnection failed",t:3}}finally{this.reconnecting=!1}}update(t,i){var B,C,G,W,$,ht;if(this.paused)return;if(this.waiting){this.rt&&this.myId&&(this.presenceAccum+=t,this.presenceAccum>=1&&(this.presenceAccum=0,this.rt.send({type:"join",id:this.myId,roomId:this.roomId,name:this.name})));return}if(this.starting){const S=performance.now(),A=Math.max(0,this.startAt-S),P=Math.ceil(A/1e3);if(P!==this.lastCountdownSecond)if(this.lastCountdownSecond=P,P>0){const Y=800-(3-Math.min(3,P))*120;L.beep(Y,.08,"triangle",.06)}else L.beep(1e3,.1,"square",.07);if(A<=0)this.starting=!1;else{this.particles.update(t),this.remoteParticles.update(t);return}}if(i.input.wasPressed("Space")||i.input.wasPressed("ArrowUp")){j.jump(this.p1),L.flap();try{(B=navigator.vibrate)==null||B.call(navigator,10)}catch{}this.particles.burst(this.p1.x+this.p1.width*.2,this.p1.y+this.p1.height*.7,10,"#9bd1ff")}const s=navigator.getGamepads?navigator.getGamepads():[],o=s&&s[0];let f=0;if(o&&o.connected){const S=o.axes&&o.axes[0]||0;f=Math.abs(S)>.2?S:0;const P=o.buttons||[],Y=this.prevPadButtons,X=J=>!!(P[J]&&P[J].pressed),st=J=>!!Y[J];if(X(0)&&!st(0)){j.jump(this.p1),L.flap();try{(C=navigator.vibrate)==null||C.call(navigator,10)}catch{}}X(1)||X(2)?this.shootingHeld=!0:!X(1)&&!X(2)&&(this.shootingHeld=!1),this.prevPadButtons=P.map(J=>!!J.pressed)}const u=i.input.getMovementDirection(),a=i.input.getWASDHorizontal?i.input.getWASDHorizontal():0,y=(this.btnRightDown?1:0)-(this.btnLeftDown?1:0);this.p1.vx=(u.x+a+this.mobileMoveX+y+f)*80;const d=.35,w=i.input.isDown("ControlLeft")||i.input.isDown("ControlRight")||i.input.isDown("KeyJ")||i.input.isDown("ShiftLeft")||i.input.isDown("KeyF");if((this.shootingHeld||this.touchShootHeld||!!w)&&this.p1.fireCooldown<=0){this.fireBullet(this.p1,"p1",i);try{(G=navigator.vibrate)==null||G.call(navigator,5)}catch{}this.p1.fireCooldown=d*(this.isRapid()?.55:1)}j.applyGravity(this.p1,t),this.p1.update(t);const c=i.canvas.height;if(this.p1.y=Math.max(0,Math.min(c-this.p1.height,this.p1.y)),this.rt){this.sendAccum+=t;const S=1/25;if(this.sendAccum>=S){this.sendAccum=0;const A={type:"state",id:this.rt.id,t:performance.now(),x:this.p1.x,y:this.p1.y,vy:this.p1.vy,score:this.s1,hp:this.p1.hp,name:this.name};this.rt.send(A)}}const M=performance.now()-100;for(;this.remoteHistory.length>=2&&this.remoteHistory[1].t<=M;)this.remoteHistory.shift();const x=this.remoteHistory[0],_=this.remoteHistory[1];if(x&&_){const S=(M-x.t)/Math.max(1,_.t-x.t),A=(P,Y,X)=>P+(Y-P)*Math.max(0,Math.min(1,X));this.p2.x=A(x.x,_.x,S),this.p2.y=A(x.y,_.y,S),this.p2.vy=A(x.vy,_.vy,S),this.s2=Math.max(x.score,_.score)}else x&&(this.p2.x=x.x,this.p2.y=x.y,this.p2.vy=x.vy,this.s2=x.score);this.trailAccum+=t;const E=(S,A,P)=>{this.particles.spawn(S,A,{vx:-40+Math.random()*20,vy:20+Math.random()*20,size:2.2,color:P+"cc",life:.35,g:150})};if(this.trailAccum>=.05&&(this.trailAccum=0,E(this.p1.x-4,this.p1.y+this.p1.height*.6,"#7cc1ff"),this.remoteParticles.spawn(this.p2.x-4,this.p2.y+this.p2.height*.6,{vx:-30+Math.random()*20,vy:20+Math.random()*15,size:2.2,color:"#ff9da0cc",life:.35,g:150})),this.particles.update(t),this.remoteParticles.update(t),this.hintT=Math.max(0,this.hintT-t),this.timeToNext-=t,this.timeToNext<=0){this.speed=Math.min(260,this.speed+2);const S=Math.max(130,180-Math.max(this.s1,this.s2)*2);this.timeToNext=Math.max(1,1.7-Math.max(this.s1,this.s2)*.02);const A=40,P=c-S-40,Y=Math.floor(Math.random()*(P-A+1))+A,X=80,st=i.canvas.width+X;if(this.isLeader&&(this.obstacles.push(new ft(st,0,X,Y,this.speed)),this.obstacles.push(new ft(st,Y+S,X,c-(Y+S),this.speed)),(W=this.rt)==null||W.send({type:"spawn",id:this.rt.id,t:performance.now(),w:X,gap:S,topH:Y,speed:this.speed}),Math.random()<.3)){const J=Ie(Math.max(this.s1,this.s2)),rt=new Yt(st+140,Math.max(24,Math.min(c-40,Y+S*.5-8)),J);rt.vx=-Math.max(100,this.speed*.7);const mt=`${Date.now()}-${Math.random().toString(36).slice(2,6)}`;rt.pid=mt,this.powerups.push(rt),($=this.rt)==null||$.send({type:"powerSpawn",id:this.rt.id,t:performance.now(),pid:mt,kind:J,x:rt.x,y:rt.y,vx:rt.vx})}}for(const S of this.obstacles)S.update(t);this.obstacles=this.obstacles.filter(S=>!S.isOffScreen());for(const S of this.powerups)S.update(t);this.powerups=this.powerups.filter(S=>!S.isOffScreen());for(const S of this.bullets)S.update(t);for(const S of this.enemyBullets)S.update(t);const T=i.canvas.width,I=i.canvas.height,R=(S,A)=>j.checkCollision({x:S.x,y:S.y,width:S.width,height:S.height},A);for(const S of this.bullets)for(const A of this.obstacles)R(S,A)&&(S.active=!1,L.combo(1));for(const S of this.enemyBullets)for(const A of this.obstacles)R(S,A)&&(S.active=!1);this.bullets=this.bullets.filter(S=>S.active&&!S.isOffScreen(T,I)),this.enemyBullets=this.enemyBullets.filter(S=>S.active&&!S.isOffScreen(T,I));for(let S=0;S<this.powerups.length;S++){const A=this.powerups[S];if(j.checkCollision(this.p1,A)){this.applyPowerUp(A.type);const P=A.pid;P&&((ht=this.rt)==null||ht.send({type:"pickup",id:this.rt.id,t:performance.now(),pid:P})),this.powerups.splice(S,1),S--,L.score()}}for(const S of this.obstacles)j.checkCollision&&j.checkCollision(this.p1,S)&&(this.p1.hp=Math.max(0,(this.p1.hp??3)-1),L.hit(),this.p1.hp<=0&&(this.paused=!0,this.toast={text:"You crashed!",t:3}));for(let S=0;S<this.obstacles.length;S+=2){const A=this.obstacles[S],P=A.x+A.width/2;A.counted!==!0&&P<this.p1.x&&(A.counted=!0,this.s1+=1,L.score())}}render(t,i){var b,M;if(this.renderer.clear(1/60),this.waiting){t.fillStyle="#e8e8f0",t.font="700 24px system-ui";const x=this.bothReady?"Found opponent! Starting…":`Waiting in room ${this.roomId}…`,_=t.measureText(x).width;t.fillText(x,Math.max(20,(i.canvas.width-_)/2),120),t.font="600 14px system-ui",t.fillStyle="#94a3b8";const E="Share the code with your friend. Game starts when they join.",T=t.measureText(E).width;t.fillText(E,Math.max(20,(i.canvas.width-T)/2),150);const I=(M=(b=this.rt)==null?void 0:b.getLastError)==null?void 0:M.call(b);if(I){t.fillStyle="#fca5a5",t.font="600 13px system-ui";const P=t.measureText(I).width;t.fillText(I,Math.max(20,(i.canvas.width-P)/2),170)}const B=`Connected players: ${1+(this.remoteId?1:0)}/2`;t.fillStyle="#cdd9e5",t.font="700 14px system-ui";const C=t.measureText(B).width,G=Math.max(20,(i.canvas.width-C)/2),W=180;t.fillText(B,G+18,W);const $=performance.now(),ht=$-this.lastMsgAt;let S="#ef4444";ht<2e3?S="#22c55e":ht<5e3&&(S="#facc15");const A=.6+.4*Math.sin($/250);t.save(),t.fillStyle=S,t.beginPath(),t.arc(G+8,W-4,5*A,0,Math.PI*2),t.fill(),t.restore()}if(this.starting){const x=Math.max(0,this.startAt-performance.now()),_=Math.ceil(x/1e3);t.fillStyle="#e8e8f0",t.font="800 54px system-ui";const E=_>0?String(_):"GO!",T=t.measureText(E).width;t.fillText(E,(i.canvas.width-T)/2,i.canvas.height*.35)}this.renderer.drawPlayer(this.p1,"#58a6ff"),this.renderer.drawPlayer(this.p2,"#ff7b72"),this.particles.render(t),this.remoteParticles.render(t);for(const x of this.obstacles)this.renderer.drawObstacle(x);this.hud.render(t,this.s1,this.s2);const s=this.p1.fireCooldown>0?Math.min(1,this.p1.fireCooldown/.35):0,o=[],f=performance.now();f<this.multishotUntil&&o.push({label:"Multi",color:"#38bdf8",remain:(this.multishotUntil-f)/1e3}),f<this.bigshotUntil&&o.push({label:"Big",color:"#fb7185",remain:(this.bigshotUntil-f)/1e3}),f<this.slowmoUntil&&o.push({label:"Slow",color:"#a78bfa",remain:(this.slowmoUntil-f)/1e3}),f<this.magnetUntil&&o.push({label:"Mag",color:"#f472b6",remain:(this.magnetUntil-f)/1e3}),this.hud.renderStatus(t,16,52,s,o),t.fillStyle="#cdd9e5",t.font="700 12px system-ui",this.name&&t.fillText(this.name,this.p1.x,Math.max(12,this.p1.y-6)),this.remoteName&&t.fillText(this.remoteName,this.p2.x,Math.max(12,this.p2.y-6)),t.fillStyle="#94a3b8",t.font="600 12px system-ui";const u=this.isLeader?"Leader":"Follower",a=1+(this.remoteId?1:0),y=`Online • Room ${this.roomId} • ${u} • Players ${a}/2`;t.fillText(y,32,i.canvas.height-8);const d=performance.now(),w=d-this.lastMsgAt;let m="#ef4444";w<2e3?m="#22c55e":w<5e3&&(m="#facc15");const c=.6+.4*Math.sin(d/250);if(t.save(),t.fillStyle=m,t.beginPath(),t.arc(16,i.canvas.height-12,5*c,0,Math.PI*2),t.fill(),t.restore(),this.isTouch){const x=i.canvas.width,_=i.canvas.height,E=Math.max(60,Math.min(120,Math.floor(Math.min(x,_)*.14))),T=24;this.btnRects={left:{x:T,y:_-E-T,w:E,h:E},right:{x:T+E+16,y:_-E-T,w:E,h:E},shoot:{x:this.lefty?T:x-E-T,y:_-E-T,w:E,h:E}};const I=(R,B,C)=>{t.save(),t.globalAlpha=.5,t.fillStyle=B?"#58a6ff":"#0f172a",t.strokeStyle="#58a6ff88",t.lineWidth=4,t.beginPath(),t.roundRect(R.x,R.y,R.w,R.h,16),t.fill(),t.stroke(),t.fillStyle="#e8e8f0",t.font="700 28px system-ui";const G=C==="L"?"◀":C==="R"?"▶":"●",W=t.measureText(G).width;t.fillText(G,R.x+(R.w-W)/2,R.y+R.h/2+10),t.restore()};I(this.btnRects.left,this.btnLeftDown,"L"),I(this.btnRects.right,this.btnRightDown,"R"),I(this.btnRects.shoot,this.btnShootDown||this.touchShootHeld,"S")}if(this.hintT>0){const x=Math.min(.8,this.hintT/4);t.save(),t.globalAlpha=x,t.fillStyle="#00000088",t.fillRect(20,70,560,56),t.fillStyle="#e8e8f0",t.font="600 16px system-ui",t.fillText("Flap: Click/Space/ArrowUp • Move: ←/→ or A/D • Shoot: Right Click or Ctrl/J (hold)",28,100),t.restore()}if(this.toast){this.toast.t-=1/60,t.save(),t.globalAlpha=Math.max(0,Math.min(1,this.toast.t/3)),t.fillStyle="#000000aa";const x=this.toast.text;t.font="700 16px system-ui";const _=t.measureText(x).width+20;t.fillRect(20,20,_,34),t.fillStyle="#e8e8f0",t.fillText(x,30,42),t.restore(),this.toast.t<=0&&(this.toast=null)}}isRapid(){const t=performance.now();return t<this.multishotUntil||t<this.bigshotUntil}fireBullet(t,i,s){const o=performance.now(),f=t.y+t.height*.5-2,u=420,a=i==="p1"?"#ffd166":"#ff7b72",y=performance.now()<this.bigshotUntil?1.6:1,d=(m,c)=>{var M;const b=new Vt(t.x+t.width,f,m,c,i);b.color=a,b.width=10*y,b.height=4*y,this.bullets.push(b),(M=this.rt)==null||M.send({type:"shoot",id:this.rt.id,t:o,x:b.x,y:b.y,vx:b.vx,vy:b.vy,w:b.width,h:b.height,color:a})};performance.now()<this.multishotUntil?(d(u,-40),d(u,0),d(u,40)):d(u,0)}applyPowerUp(t){const i=performance.now(),s=Ye[t];s&&(t==="heal"?this.p1.hp=Math.min(this.p1.maxHp,this.p1.hp+1):t==="shield"?(this.p1.maxHp+=1,this.p1.hp=Math.min(this.p1.maxHp,this.p1.hp+1)):t==="rapid"?this.multishotUntil=i+(s.duration??6)*1e3:t==="multishot"?this.multishotUntil=i+(s.duration??6)*1e3:t==="bigshot"?this.bigshotUntil=i+(s.duration??6)*1e3:t==="slowmo"?(this.slowmoUntil=i+(s.duration??3)*1e3,this.speed=Math.max(100,this.speed*.8)):t==="magnet"&&(this.magnetUntil=i+(s.duration??6)*1e3))}}class Bi{constructor(){this.t=0,this.onlineModalOpen=!1,this.modalCreateBtn=null,this.modalJoinBtn=null,this.modalCancelBtn=null,this.shareRoomCode=null,this.shareRoomName=null,this.btnS=null,this.btnV=null,this.btnVO=null,this.btnEditName=null}launchOnline(t){this.onlineModalOpen=!0}onResize(t){t.ctx.setTransform(1,0,0,1,0,0)}init(t){t.canvas.focus();try{const m=new URL(window.location.href),c=m.searchParams.get("room"),b=m.searchParams.get("name");c&&(this.shareRoomCode=c.toLowerCase(),b&&(this.shareRoomName=b),this.onlineModalOpen=!0)}catch{}let i=!1;const s=()=>{t.canvas.onpointerdown=null,t.canvas.ontouchstart=null,t.canvas.onclick=null,document.removeEventListener("touchstart",d),document.removeEventListener("pointerdown",y),document.removeEventListener("click",w)},o=(m,c=!1)=>{if(m&&c){this.launchOnline(t);return}this.onlineModalOpen||i||(i=!0,s(),t.setScene(m?new zt:new Bt))},f=m=>{try{m.stopPropagation()}catch{}if(this.btnS||this.btnV||this.btnEditName){const c=t.canvas.getBoundingClientRect(),b=t.canvas.width/c.width,M=t.canvas.height/c.height,x=(m.clientX-c.left)*b,_=(m.clientY-c.top)*M;if(this.onlineModalOpen){const E=T=>T&&x>=T.x&&x<=T.x+T.w&&_>=T.y&&_<=T.y+T.h;if(E(this.modalCreateBtn)){const T=at.getPlayerName()||this.shareRoomName||"Anon",I=typeof window<"u"&&window.prompt("Your name",T)||T;at.setPlayerName(I);const R=Math.random().toString(36).slice(2,6).toUpperCase();try{const B=new URL(window.location.href);B.searchParams.set("room",R.toLowerCase()),B.searchParams.delete("name");const C=B.toString();if(navigator.clipboard&&navigator.clipboard.writeText)(async()=>{try{await navigator.clipboard.writeText(C);try{window.alert(`Room code: ${R}
Invite link copied to clipboard!
${C}`)}catch{}}catch{try{window.alert(`Room code: ${R}
Share this link:
${C}`)}catch{}}})();else try{window.alert(`Room code: ${R}
Share this link:
${C}`)}catch{}}catch{}if(i)return;i=!0,s(),t.setScene(new ee(R.toLowerCase(),I));return}if(E(this.modalJoinBtn)){const T=at.getPlayerName()||this.shareRoomName||"Anon",I=typeof window<"u"&&window.prompt("Your name",T)||T;at.setPlayerName(I);let R=this.shareRoomCode||"";if(R||(R=((typeof window<"u"?window.prompt("Enter room code to join",""):"")||"").trim()),!R){this.onlineModalOpen=!1;return}if(i)return;i=!0,s(),t.setScene(new ee(R.toLowerCase(),I));return}if(E(this.modalCancelBtn)){this.onlineModalOpen=!1;return}return}if(this.btnS&&x>=this.btnS.x&&x<=this.btnS.x+this.btnS.w&&_>=this.btnS.y&&_<=this.btnS.y+this.btnS.h)return o(!1);if(this.btnV&&x>=this.btnV.x&&x<=this.btnV.x+this.btnV.w&&_>=this.btnV.y&&_<=this.btnV.y+this.btnV.h)return o(!0);if(this.btnVO&&x>=this.btnVO.x&&x<=this.btnVO.x+this.btnVO.w&&_>=this.btnVO.y&&_<=this.btnVO.y+this.btnVO.h)return o(!0,!0);if(this.btnEditName&&x>=this.btnEditName.x&&x<=this.btnEditName.x+this.btnEditName.w&&_>=this.btnEditName.y&&_<=this.btnEditName.y+this.btnEditName.h){try{const E=at.getPlayerName()||"Anon",T=typeof window<"u"?window.prompt("Your name",E):null;T!=null&&at.setPlayerName(T)}catch{}return}}o(!1)},u=m=>{var b;try{m.stopPropagation()}catch{}const c=((b=m.touches)==null?void 0:b.length)??0;o(c>=2)},a=m=>{try{m.stopPropagation()}catch{}o(!1)},y=m=>{this.onlineModalOpen||o(!1)},d=m=>{var b;const c=((b=m.touches)==null?void 0:b.length)??0;this.onlineModalOpen||o(c>=2)},w=m=>{this.onlineModalOpen||o(!1)};t.canvas.onpointerdown=f,t.canvas.ontouchstart=u,t.canvas.onclick=a,document.addEventListener("pointerdown",y,{passive:!0}),document.addEventListener("touchstart",d,{passive:!0}),document.addEventListener("click",w,{passive:!0})}update(t,i){this.t+=t,i.input.wasPressed("KeyS")&&i.setScene(new Bt),i.input.wasPressed("KeyV")&&i.setScene(new zt),i.input.wasPressed("KeyO")&&this.launchOnline(i),i.input.wasPressed("Escape")&&this.onlineModalOpen&&(this.onlineModalOpen=!1),i.input.wasPressed("KeyM")&&(L.muted=!L.muted),i.input.wasPressed("KeyR")&&lt.toggleReducedMotion(),i.input.wasPressed("KeyC")&&at.clear();const{ctx:s}=i,o=i.canvas.width,f=i.canvas.height,u=s.createLinearGradient(0,0,0,f);u.addColorStop(0,"#0b1023"),u.addColorStop(1,"#1a2247"),s.fillStyle=u,s.fillRect(0,0,o,f),s.save(),s.globalAlpha=.2;for(let O=0;O<60;O++){const V=O*91%o,F=O*53%f;s.fillStyle=O%2?"#d0e0ff":"#a0b8ff",s.fillRect(V,F+(Math.sin(this.t+O)*2+2)|0,2,2)}s.restore();const a=Math.sin(this.t*2)*6;s.textBaseline="top";const y="CrappBird";s.font="900 72px system-ui, ui-sans-serif, -apple-system, Segoe UI";const d=s.measureText(y).width,w=Math.max(24,(o-d)/2),m=56+a,c=s.createLinearGradient(w,m,w,m+72);c.addColorStop(0,"#e6f0ff"),c.addColorStop(1,"#9cc9ff"),s.save(),s.shadowColor="#3b82f6aa",s.shadowBlur=18,s.fillStyle=c,s.fillText(y,w,m),s.restore(),s.strokeStyle="#58a6ff",s.lineWidth=5,s.beginPath(),s.moveTo(w,m+72+6),s.lineTo(w+Math.min(520,d*.65),m+72+6),s.stroke();const b=w-80,M=m+10,x=18,_=Math.sin(this.t*10)*.6;s.fillStyle="#58a6ff",s.beginPath(),s.arc(b,M,x,0,Math.PI*2),s.fill(),s.fillStyle="#ffffffaa",s.beginPath(),s.arc(b-x*.2,M+x*.1,x*.7,Math.PI*.1,Math.PI*1.2),s.fill(),s.save(),s.translate(b-x*.2,M),s.rotate(-.8+_),s.fillStyle="#00000022",s.beginPath(),s.ellipse(0,0,x*.9,x*.5,0,0,Math.PI*2),s.fill(),s.restore(),s.fillStyle="#ffd166",s.beginPath(),s.moveTo(b+x*.9,M),s.lineTo(b+x*1.4,M-x*.2),s.lineTo(b+x*.9,M+x*.2),s.closePath(),s.fill(),s.fillStyle="#fff",s.beginPath(),s.arc(b+x*.2,M-x*.3,x*.22,0,Math.PI*2),s.fill(),s.fillStyle="#000",s.beginPath(),s.arc(b+x*.25,M-x*.3,x*.1,0,Math.PI*2),s.fill(),s.save();const E=s.createRadialGradient(o/2,f/2,Math.min(o,f)*.2,o/2,f/2,Math.max(o,f)*.6);E.addColorStop(0,"rgba(0,0,0,0)"),E.addColorStop(1,"rgba(0,0,0,0.35)"),s.fillStyle=E,s.fillRect(0,0,o,f),s.restore();const T=Math.min(560,o-64),I=170,R=(o-T)/2;s.fillStyle="#0f172ae6",s.beginPath(),s.roundRect(R,I,T,150,14),s.fill(),s.fillStyle="#cdd9e5",s.font="700 22px system-ui",s.fillText("Play",R+16,I+16);const B=18,C=44,G=16,W=3,$=Math.floor((T-G*2-B*(W-1))/W),ht=$*W+B*(W-1),S=R+Math.max(G,(T-ht)/2),A=I+56,P=(O,V,F,z)=>{s.fillStyle="#15223f",s.strokeStyle="#58a6ffaa",s.lineWidth=3,s.beginPath(),s.roundRect(O,V,$,C,10),s.fill(),s.stroke(),z&&(s.fillStyle="#9cc9ff",s.font="700 18px system-ui",s.fillText(z,O+12,V+28)),s.fillStyle="#e8e8f0",s.font="600 18px system-ui",s.fillText(F,O+(z?36:14),V+28)};P(S,A,"S — Singleplayer","🎮"),P(S+$+B,A,"V — Versus (Local)","🤝"),P(S+($+B)*2,A,"O — Versus (Online)","🌐"),this.btnS={x:S,y:A,w:$,h:C},this.btnV={x:S+$+B,y:A,w:$,h:C},this.btnVO={x:S+($+B)*2,y:A,w:$,h:C};const Y=I+170,X=Math.min(760,o-64),st=(o-X)/2;s.fillStyle="#0f172acc",s.beginPath(),s.roundRect(st,Y,X,160,14),s.fill(),s.fillStyle="#cdd9e5",s.font="700 20px system-ui",s.fillText("Controls",st+16,Y+16),s.font="500 16px system-ui";let J=Y+46;s.fillText("Singleplayer: Flap = Space/ArrowUp/W or Click/Tap • Move = ArrowLeft/Right or A/D • Shoot = Right Click or Ctrl/J (hold)",st+16,J),J+=28,s.fillText("Versus (Local): P1 = Arrows + Space • P2 = W (flap), S (nudge down)",st+16,J),J+=28,s.fillText(`Online: O — create or join room • Mute = M (${L.muted?"Muted":"Sound on"}) • Reduced motion = R (${lt.reducedMotion?"On":"Off"}) • Esc returns here`,st+16,J);const rt=Y+170,mt=Math.min(760,o-64),_t=(o-mt)/2;s.fillStyle="#0f172acc",s.beginPath(),s.roundRect(_t,rt,mt,130,14),s.fill(),s.fillStyle="#cdd9e5",s.font="700 20px system-ui",s.fillText("Power-ups",_t+16,rt+16),s.font="500 14px system-ui";let q=rt+44;const Z=[["+ Heal","gain 1 heart"],["R Rapid","shorter cooldown"],["S Shield","+1 max heart and heal"],["M Multishot","fires 3 bullets"],["B Bigshot","bigger bullets, +1 dmg"],["⌛ Slowmo","world slows briefly"],["U Magnet","pulls pickups nearby"]];for(const[O,V]of Z)s.fillText(`${O} — ${V}`,_t+16,q),q+=20;const wt=at.getTop(5);if(wt.length){const O=Math.min(420,o-40),V=28+wt.length*22+20,F=(o-O)/2,z=f-V-80;s.fillStyle="#0f172acc",s.beginPath(),s.roundRect(F,z,O,V,10),s.fill(),s.fillStyle="#cdd9e5",s.font="700 16px system-ui",s.fillText("Top Scores",F+12,z+20),s.font="500 14px system-ui";for(let dt=0;dt<wt.length;dt++){const bt=wt[dt],pt=`${dt+1}. ${(bt.name||"Anon").slice(0,18)} — ${bt.score}`;s.fillText(pt,F+12,z+44+dt*22)}s.font="400 12px system-ui",s.fillStyle="#94a3b8",s.fillText("Press C to clear • Name is saved locally",F+12,z+V-10);const gt=92,nt=22,Q=F+O-gt-10,tt=z+10;s.fillStyle="#15223f",s.strokeStyle="#58a6ff88",s.lineWidth=2,s.beginPath(),s.roundRect(Q,tt,gt,nt,6),s.fill(),s.stroke(),s.fillStyle="#e8e8f0",s.font="600 12px system-ui",s.fillText("Edit name",Q+12,tt+15),this.btnEditName={x:Q,y:tt,w:gt,h:nt}}const Ct=.5+.5*Math.sin(this.t*3);s.save(),s.globalAlpha=.6+.4*Ct,s.fillStyle="#7dd3fc",s.font="700 18px system-ui";const Tt="Tap to start • Starts easy, ramps up • Two-finger tap for Versus (S/V)",Pt=s.measureText(Tt).width;if(s.fillText(Tt,Math.max(20,(o-Pt)/2),f-60),s.restore(),this.onlineModalOpen){s.save(),s.fillStyle="rgba(0,0,0,0.5)",s.fillRect(0,0,o,f);const O=Math.min(420,o-40),V=200,F=(o-O)/2,z=Math.max(60,f*.25);s.fillStyle="#0f172ae6",s.beginPath(),s.roundRect(F,z,O,V,12),s.fill(),s.strokeStyle="#58a6ff55",s.stroke(),s.fillStyle="#cdd9e5",s.font="700 20px system-ui",s.fillText("Online Match",F+16,z+16),s.font="500 14px system-ui",s.fillStyle="#94a3b8";const gt=this.shareRoomCode?`You were invited to room ${this.shareRoomCode.toUpperCase()}. Join to continue.`:"Create a room to host, or join with a code from a friend.";s.fillText(gt,F+16,z+44);const nt=(O-16*3)/2,Q=40,tt=z+V-Q-20;s.fillStyle="#15223f",s.strokeStyle="#58a6ffaa",s.lineWidth=3,s.beginPath(),s.roundRect(F+16,tt,nt,Q,10),s.fill(),s.stroke(),s.fillStyle="#e8e8f0",s.font="600 16px system-ui",s.fillText("Create Room",F+16+14,tt+26),this.modalCreateBtn={x:F+16,y:tt,w:nt,h:Q},s.fillStyle="#15223f",s.strokeStyle="#58a6ffaa",s.lineWidth=3,s.beginPath(),s.roundRect(F+16*2+nt,tt,nt,Q,10),s.fill(),s.stroke(),s.fillStyle="#e8e8f0",s.font="600 16px system-ui";const dt=this.shareRoomCode?`Join Room ${this.shareRoomCode.toUpperCase()}`:"Join Room";s.fillText(dt,F+16*2+nt+14,tt+26),this.modalJoinBtn={x:F+16*2+nt,y:tt,w:nt,h:Q},s.fillStyle="#9cc9ff",s.font="600 14px system-ui";const bt="Cancel (Esc)",pt=s.measureText(bt).width,Lt=F+O-pt-16,Dt=z+16;s.fillText(bt,Lt,Dt+2),this.modalCancelBtn={x:Lt-6,y:Dt-6,w:pt+12,h:24},s.restore()}else this.modalCreateBtn=this.modalJoinBtn=this.modalCancelBtn=null}render(){}}const le=document.getElementById("gameCanvas");le.style.width="100vw";le.style.height="100vh";const Et=new Ke(le);let je="title";const Rt=l=>{switch(je=l,l){case"title":Et.setScene(new Bi);break;case"single":Et.setScene(new Bt);break;case"versus":Et.setScene(new zt);break;case"versusOnline":{const t="Anon",i="test";Et.setScene(new ee(i,t));break}}};Rt("title");window.addEventListener("keydown",l=>{je==="title"?(l.code==="KeyS"&&Rt("single"),l.code==="KeyV"&&Rt("versus"),l.code==="KeyO"&&Rt("versusOnline")):l.code==="Escape"&&Rt("title")});window.addEventListener("resize",()=>Et.resizeToDisplay());
