(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const l of r)if(l.type==="childList")for(const f of l.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&s(f)}).observe(document,{childList:!0,subtree:!0});function e(r){const l={};return r.integrity&&(l.integrity=r.integrity),r.referrerPolicy&&(l.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?l.credentials="include":r.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function s(r){if(r.ep)return;r.ep=!0;const l=e(r);fetch(r.href,l)}})();class qe{constructor(){this.down=new Set,this.pressedThisFrame=new Set,window.addEventListener("keydown",t=>{this.down.has(t.code)||this.pressedThisFrame.add(t.code),this.down.add(t.code),["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","KeyW","KeyA","KeyS","KeyD"].includes(t.code)&&t.preventDefault()},{passive:!1}),window.addEventListener("keyup",t=>this.down.delete(t.code))}beginFrame(){this.pressedThisFrame.clear()}endFrame(){}isDown(t){return this.down.has(t)}wasPressed(t){return this.pressedThisFrame.has(t)}getMovementDirection(){return{x:(this.isDown("ArrowRight")?1:0)+(this.isDown("ArrowLeft")?-1:0),y:(this.isDown("ArrowDown")?1:0)+(this.isDown("ArrowUp")?-1:0)}}getWASDHorizontal(){return(this.isDown("KeyD")?1:0)+(this.isDown("KeyA")?-1:0)}}class Ke{constructor(t){this.lastTime=0,this.running=!1,this.scene=null,this.loop=s=>{if(!this.running||!this.scene)return;const r=Math.min(1/30,(s-this.lastTime)/1e3);this.lastTime=s,this.input.beginFrame(),this.scene.update(r,this),this.scene.render(this.ctx,this),this.input.endFrame(),requestAnimationFrame(this.loop)},this.canvas=t;const e=t.getContext("2d");if(!e)throw new Error("2D context not available");this.ctx=e,this.input=new qe,this.resizeToDisplay()}resizeToDisplay(){var l,f;const t=Math.max(1,Math.min(window.devicePixelRatio||1,2)),e=this.canvas.getBoundingClientRect(),s=Math.floor(e.width*t)||800,r=Math.floor(e.height*t)||600;(this.canvas.width!==s||this.canvas.height!==r)&&(this.canvas.width=s,this.canvas.height=r),this.ctx.setTransform(1,0,0,1,0,0),(f=(l=this.scene)==null?void 0:l.onResize)==null||f.call(l,this)}setScene(t){this.scene=t,t.init(this),this.running||(this.running=!0,this.lastTime=performance.now(),requestAnimationFrame(this.loop))}}class Dt{constructor(t=50,e=50,s=28,r=28,l){this.vx=0,this.vy=0,this._score=0,this.hp=3,this.maxHp=3,this.fireCooldown=0,this.x=t,this.y=e,this.width=s,this.height=r}setPosition(t,e){this.x=t,this.y=e}passObstacle(){this._score+=1}update(t){this.x+=this.vx*t,this.y+=this.vy*t,this.fireCooldown>0&&(this.fireCooldown=Math.max(0,this.fireCooldown-t))}get score(){return Math.max(0,this._score)}set score(t){this._score=Math.max(0,t)}}class ct{constructor(t,e,s,r,l=120){this.x=t,this.y=e,this.width=s,this.height=r,this.speed=l}update(t){this.x-=this.speed*t}isOffScreen(){return this.x+this.width<0}}class oe{render(t,e,s,r,l){t.fillStyle="#e8e8f0",t.font="700 20px system-ui, sans-serif",typeof s=="number"?t.fillText(`P1: ${e}   P2: ${s}`,16,24):t.fillText(`Score: ${e}`,16,24);const f=(a,y,d)=>{if(d!=null)for(let m=0;m<d;m++){t.fillStyle="#ff7b72",t.beginPath();const w=m*18;t.moveTo(a+w+6,y+10),t.arc(a+w+3,y+8,3,0,Math.PI),t.arc(a+w+9,y+8,3,0,Math.PI),t.lineTo(a+w+6,y+14),t.closePath(),t.fill()}};f(16,36,r),l!=null&&f(120,36,l)}renderStatus(t,e,s,r,l){if(typeof r=="number"){const f=Math.max(0,Math.min(1,r)),a=120,y=6;t.fillStyle="#334155",t.fillRect(e,s,a,y),t.fillStyle="#facc15",t.fillRect(e,s,a*(1-f),y),t.strokeStyle="#0f172a",t.strokeRect(e-.5,s-.5,a+1,y+1)}if(l&&l.length){let f=0;for(const a of l){const y=a.remain?`${a.label} ${Math.ceil(a.remain)}`:a.label;t.font="700 10px system-ui, sans-serif";const d=t.measureText(y).width,m=6,w=6;t.fillStyle=a.color||"#94a3b8",t.beginPath(),t.roundRect(e+f,s+10,d+m*2,16,w),t.fill(),t.fillStyle="#0f172a",t.fillText(y,e+f+m,s+10+12),f+=d+m*2+6}}}}const Rt=class Rt{static applyGravity(t,e){t.vy+=Rt.gravity*e}static jump(t){t.vy=Rt.jumpVelocity}static checkCollision(t,e){return!(t.x+t.width<e.x||t.x>e.x+e.width||t.y+t.height<e.y||t.y>e.y+e.height)}};Rt.gravity=900,Rt.jumpVelocity=-300;let q=Rt;class ae{constructor(t,e){this.canvas=t,this.ctx=e,this.t=0,this.cloudOffset=0}clear(t=0){const{ctx:e}=this,s=this.canvas.width,r=this.canvas.height;this.t+=t,this.cloudOffset=(this.cloudOffset+t*20)%(s+200);const l=e.createLinearGradient(0,0,0,r);l.addColorStop(0,"#0f1630"),l.addColorStop(1,"#0b1022"),e.fillStyle=l,e.fillRect(0,0,s,r);const f=(a,y,d)=>{e.fillStyle="#ffffff14",e.beginPath(),e.roundRect(a,y,120*d,40*d,20*d),e.fill()};for(let a=0;a<4;a++){const y=s-(this.cloudOffset+a*180)%(s+200),d=40+a*45%(r*.5);f(y,d,1)}e.fillStyle="#1a2446",e.fillRect(0,r-20,s,20),e.fillStyle="#111a36";for(let a=0;a<s;a+=16)e.fillRect(a,r-22,8,2)}drawBird(t,e){const{ctx:s}=this,r=Math.min(t.width,t.height)/2,l=t.x+r,f=t.y+r,a=Math.sin(this.t*10)*.6;s.fillStyle=e,s.beginPath(),s.arc(l,f,r,0,Math.PI*2),s.fill(),s.fillStyle="#ffffff88",s.beginPath(),s.arc(l-r*.2,f+r*.1,r*.7,Math.PI*.1,Math.PI*1.2),s.fill(),s.save(),s.translate(l-r*.2,f),s.rotate(-.8+a),s.fillStyle="#00000022",s.beginPath(),s.ellipse(0,0,r*.9,r*.5,0,0,Math.PI*2),s.fill(),s.restore(),s.fillStyle="#ffd166",s.beginPath(),s.moveTo(l+r*.9,f),s.lineTo(l+r*1.4,f-r*.2),s.lineTo(l+r*.9,f+r*.2),s.closePath(),s.fill(),s.fillStyle="#fff",s.beginPath(),s.arc(l+r*.2,f-r*.3,r*.22,0,Math.PI*2),s.fill(),s.fillStyle="#000",s.beginPath(),s.arc(l+r*.25,f-r*.3,r*.1,0,Math.PI*2),s.fill()}drawPlayer(t,e="#58a6ff"){this.drawBird(t,e)}drawObstacle(t){const{ctx:e}=this,s=t.x,r=t.y,l=t.width,f=t.height;e.save();const a=e.createLinearGradient(s,r,s+l,r);a.addColorStop(0,"#1e7755"),a.addColorStop(1,"#2a9a6d"),e.fillStyle=a,e.beginPath(),e.roundRect(s,r,l,f,Math.min(8,l*.25)),e.fill();const y=e.createLinearGradient(s,r,s+l,r);y.addColorStop(0,"rgba(255,255,255,0.10)"),y.addColorStop(.2,"rgba(255,255,255,0.03)"),y.addColorStop(.8,"rgba(0,0,0,0.08)"),y.addColorStop(1,"rgba(0,0,0,0.12)"),e.fillStyle=y,e.beginPath(),e.roundRect(s,r,l,f,Math.min(8,l*.25)),e.fill(),e.globalAlpha=.06,e.fillStyle="#ffffff";for(let w=4;w<l;w+=10)e.fillRect(s+w,r,1,f);e.globalAlpha=1;const d=Math.min(10,f*.1),m=e.createLinearGradient(s,r,s,r+d);m.addColorStop(0,"rgba(255,255,255,0.25)"),m.addColorStop(1,"rgba(255,255,255,0.05)"),e.fillStyle=m,e.beginPath(),e.roundRect(s-2,r-2,l+4,d+4,6),e.fill(),e.restore()}drawHUD(t){this.ctx.fillStyle="#e8e8f0",this.ctx.font="700 24px system-ui, sans-serif",this.ctx.fillText(t,16,32)}drawProjectile(t,e="#ffd166"){const{ctx:s}=this,r=t.color||e;s.save(),s.shadowColor=r+"aa",s.shadowBlur=10,s.fillStyle=r,s.beginPath(),s.roundRect(t.x,t.y,t.width,t.height,Math.min(6,t.height/2)),s.fill(),s.globalAlpha=.35,s.shadowBlur=0,s.fillStyle=r,s.fillRect(t.x-Math.min(16,t.width*2),t.y+t.height*.25,Math.min(16,t.width*2),t.height*.5),s.restore()}drawEnemy(t){const{ctx:e}=this,s=t.variant||"drone";if(e.save(),s==="tank"){const r=e.createLinearGradient(t.x,t.y,t.x,t.y+t.height);r.addColorStop(0,"#d86a6a"),r.addColorStop(1,"#a83e3e"),e.fillStyle=r,e.beginPath(),e.roundRect(t.x,t.y,t.width,t.height,4),e.fill(),e.lineWidth=2,e.strokeStyle="#00000055",e.stroke(),e.fillStyle="#0f172a88",e.fillRect(t.x+3,t.y+t.height-6,t.width-6,5),e.fillStyle="#7f1d1d",e.fillRect(t.x+t.width-8,t.y+t.height/2-2,10,4)}else if(s==="bee"){e.fillStyle="#ffd166",e.beginPath(),e.ellipse(t.x+t.width/2,t.y+t.height/2,t.width/2,t.height/2,0,0,Math.PI*2),e.fill(),e.fillStyle="#00000066",e.fillRect(t.x+4,t.y+4,t.width-8,3),e.fillRect(t.x+4,t.y+9,t.width-8,3);const r=Math.sin(this.t*30)*.4;e.fillStyle="#ffffff88",e.save(),e.translate(t.x+t.width/2-4,t.y+2),e.rotate(-.6+r),e.beginPath(),e.ellipse(0,0,6,3,0,0,Math.PI*2),e.fill(),e.restore(),e.save(),e.translate(t.x+t.width/2+4,t.y+2),e.rotate(.6-r),e.beginPath(),e.ellipse(0,0,6,3,0,0,Math.PI*2),e.fill(),e.restore(),e.fillStyle="#111827",e.beginPath(),e.arc(t.x+t.width-6,t.y+6,2,0,Math.PI*2),e.fill()}else if(s==="kamikaze"){const r=.6+.4*Math.sin(this.t*6);e.shadowColor="#ff3b30aa",e.shadowBlur=18*r,e.fillStyle="#ff7b72",e.beginPath(),e.ellipse(t.x+t.width/2,t.y+t.height/2,t.width/2,t.height/2,0,0,Math.PI*2),e.fill(),e.shadowBlur=0,e.fillStyle="#ffffffaa",e.beginPath(),e.arc(t.x+t.width/2+3,t.y+t.height/2-2,3,0,Math.PI*2),e.fill()}else{const r=e.createLinearGradient(t.x,t.y,t.x,t.y+t.height);r.addColorStop(0,"#ff8a82"),r.addColorStop(1,"#ff6a60"),e.fillStyle=r,e.beginPath(),e.ellipse(t.x+t.width/2,t.y+t.height/2,t.width/2,t.height/2,0,0,Math.PI*2),e.fill(),e.fillStyle="#00000055",e.fillRect(t.x+2,t.y+2,t.width-4,3);const l=Math.floor(this.t*4)%2===0?1:0;e.globalAlpha=.6+.4*l,e.fillStyle="#38bdf8",e.beginPath(),e.arc(t.x+t.width-6,t.y+t.height-6,2,0,Math.PI*2),e.fill(),e.globalAlpha=1}e.restore()}drawPowerUp(t){const{ctx:e}=this,r={heal:"#7ee787",rapid:"#f7b84a",shield:"#8b8efb",multishot:"#38bdf8",bigshot:"#fb7185",slowmo:"#a78bfa",magnet:"#f472b6"}[t.type]||"#f7b84a",l=Math.sin(this.t*3+(t.x+t.y)*.01)*2,f=.75+.25*Math.sin(this.t*4+t.x*.03),a=t.x,y=t.y+l,d=t.width,m=t.height;e.save(),e.shadowColor=r+"aa",e.shadowBlur=14*f;const w=e.createLinearGradient(a,y,a,y+m);w.addColorStop(0,r),w.addColorStop(1,"#ffffff55"),e.fillStyle=w,e.beginPath(),e.roundRect(a,y,d,m,6),e.fill(),e.lineWidth=2,e.strokeStyle="#0f172a66",e.stroke(),e.shadowBlur=0,e.fillStyle="#0f172a";const u=a+d/2,v=y+m/2;e.save(),e.translate(u,v),e.scale(1+(f-1)*.5,1+(f-1)*.5),t.type==="heal"?(e.fillStyle="#0f172a",e.fillRect(-2,-6,4,12),e.fillRect(-6,-2,12,4)):t.type==="shield"?(e.strokeStyle="#0f172a",e.lineWidth=2,e.beginPath(),e.moveTo(0,-6),e.quadraticCurveTo(8,-4,8,2),e.quadraticCurveTo(0,8,0,10),e.quadraticCurveTo(0,8,-8,2),e.quadraticCurveTo(-8,-4,0,-6),e.stroke()):t.type==="multishot"?(e.fillStyle="#0f172a",e.fillRect(-6,-2,4,4),e.fillRect(-1,-2,4,4),e.fillRect(4,-2,4,4)):t.type==="rapid"?(e.fillStyle="#0f172a",e.beginPath(),e.moveTo(-5,-6),e.lineTo(1,0),e.lineTo(-3,0),e.lineTo(5,6),e.closePath(),e.fill()):t.type==="bigshot"?(e.fillStyle="#0f172a",e.beginPath(),e.roundRect(-4,-3,8,6,3),e.fill()):t.type==="slowmo"?(e.fillStyle="#0f172a",e.beginPath(),e.arc(0,0,6,0,Math.PI*2),e.strokeStyle="#0f172a",e.lineWidth=2,e.stroke(),e.fillRect(-1,-4,2,4),e.fillRect(-1,0,2,4)):t.type==="magnet"?(e.strokeStyle="#0f172a",e.lineWidth=3,e.beginPath(),e.arc(0,0,6,Math.PI*.2,Math.PI*.8),e.stroke(),e.beginPath(),e.arc(0,0,6,-Math.PI*.8,-Math.PI*.2),e.stroke()):(e.fillStyle="#0f172a",e.beginPath(),e.arc(0,0,3,0,Math.PI*2),e.fill()),e.restore(),e.restore()}}class Ve{constructor(){this.ctx=null,this._muted=!1}get muted(){return this._muted}set muted(t){this._muted=t;try{localStorage.setItem("mute",t?"1":"0")}catch{}}ensure(){this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext))}beep(t,e=.08,s="sine",r=.05){if(this._muted)return;this.ensure();const l=this.ctx,f=l.createOscillator(),a=l.createGain();f.type=s,f.frequency.value=t,a.gain.value=r,f.connect(a).connect(l.destination);const y=l.currentTime;f.start(y),f.stop(y+e)}flap(){this.beep(660,.05,"square",.05)}score(){this.beep(880,.08,"triangle",.06)}hit(){this.beep(120,.15,"sawtooth",.08)}combo(t){if(this._muted)return;const e=900+Math.min(4,t)*80;this.beep(e,.05,"triangle",.05)}}const D=new Ve;try{D.muted=localStorage.getItem("mute")==="1"}catch{}class qt{constructor(){this.pool=[],this.active=[]}spawn(t,e,s){const r=this.pool.pop()||{x:t,y:e,vx:0,vy:0,life:.5,maxLife:.5,size:3,color:"#fff"};r.x=t,r.y=e,r.vx=(s==null?void 0:s.vx)??Math.random()*80-40,r.vy=(s==null?void 0:s.vy)??Math.random()*-80,r.life=(s==null?void 0:s.life)??.5,r.maxLife=r.life,r.size=(s==null?void 0:s.size)??3,r.color=(s==null?void 0:s.color)??"#ffffff88",r.g=(s==null?void 0:s.g)??200,this.active.push(r)}burst(t,e,s,r){for(let l=0;l<s;l++)this.spawn(t,e,{color:r,size:2+Math.random()*2,life:.4+Math.random()*.3})}update(t){for(let e=this.active.length-1;e>=0;e--){const s=this.active[e];s.vy+=(s.g||0)*t,s.x+=s.vx*t,s.y+=s.vy*t,s.life-=t,s.life<=0&&(this.pool.push(s),this.active.splice(e,1))}}render(t){for(const e of this.active){const s=Math.max(0,e.life/e.maxLife);t.fillStyle=e.color.replace(/\d?\.?\d*\)$/,"")||e.color,t.globalAlpha=s,t.beginPath(),t.arc(e.x,e.y,e.size,0,Math.PI*2),t.fill(),t.globalAlpha=1}}}function ke(c){return c===2?"shoot":"flap"}class Zt{constructor(t,e,s,r,l="player"){this.width=10,this.height=4,this.active=!0,this.damage=1,this.x=t,this.y=e,this.vx=s,this.vy=r,this.owner=l}update(t){this.x+=this.vx*t,this.y+=this.vy*t}isOffScreen(t,e){return this.x>t+20||this.x+this.width<-20||this.y>e+20||this.y+this.height<-20}}class Ye{constructor(t,e,s=-120,r=0,l="drone"){this.x=t,this.y=e,this.vx=s,this.vy=r,this.variant=l,l==="tank"?(this.width=34,this.height=26,this.health=3):(this.width=24,this.height=18,this.health=1)}update(t){this.x+=this.vx*t,this.y+=this.vy*t}isOffScreen(){return this.x+this.width<-40}}class Gt{constructor(t,e,s){this.width=16,this.height=16,this.vx=-80,this.vy=0,this.x=t,this.y=e,this.type=s}update(t){this.x+=this.vx*t,this.y+=this.vy*t}isOffScreen(){return this.x+this.width<-40}}const Ae="scores:v1",Xt="playerName";function pe(){try{const c=localStorage.getItem(Ae);if(!c)return[];const t=JSON.parse(c);return Array.isArray(t)?t.map(e=>({score:Number(e.score)||0,date:Number(e.date)||Date.now(),name:typeof e.name=="string"?e.name:void 0})).filter(e=>e.score>=0&&Number.isFinite(e.date)):[]}catch{return[]}}function ye(c){try{localStorage.setItem(Ae,JSON.stringify(c))}catch{}}const ft={addScore(c,t=Date.now(),e){const s=pe(),r=(e??localStorage.getItem(Xt)??"Anon").toString().slice(0,18).trim()||"Anon";s.push({score:Math.max(0,Math.floor(c)),date:t,name:r}),s.sort((f,a)=>a.score-f.score||a.date-f.date);const l=s.slice(0,10);ye(l)},getTop(c=5){const t=pe();return t.sort((e,s)=>s.score-e.score||s.date-e.date),t.slice(0,c)},clear(){ye([])},getPlayerName(){try{return localStorage.getItem(Xt)}catch{return null}},setPlayerName(c){try{localStorage.setItem(Xt,(c||"").toString().slice(0,18).trim()||"Anon")}catch{}}},Bt=class Bt{constructor(){var t;this._reducedMotion=!1,this._usingSystemPreference=!0;try{const e=localStorage.getItem(Bt.STORAGE_KEY);if(e!=null)this._reducedMotion=e==="1",this._usingSystemPreference=!1;else if(typeof window<"u"&&"matchMedia"in window){const s=window.matchMedia("(prefers-reduced-motion: reduce)");this._reducedMotion=s.matches,this._usingSystemPreference=!0;try{(t=s.addEventListener)==null||t.call(s,"change",r=>{this._usingSystemPreference&&(this._reducedMotion=r.matches)})}catch{}}}catch{}}get reducedMotion(){return this._reducedMotion}set reducedMotion(t){this._reducedMotion=t,this._usingSystemPreference=!1;try{localStorage.setItem(Bt.STORAGE_KEY,t?"1":"0")}catch{}}toggleReducedMotion(){this.reducedMotion=!this.reducedMotion}};Bt.STORAGE_KEY="reducedMotion";let Qt=Bt;const it=new Qt,ze={heal:{color:"#7ee787",glyph:"+",label:"Heal",description:"Gain 1 heart"},shield:{color:"#8b8efb",glyph:"S",label:"Shield",description:"+1 max heart and heal"},rapid:{color:"#f7b84a",glyph:"R",label:"Rapid",description:"Shorter cooldown",duration:8,cooldownMul:.55},multishot:{color:"#38bdf8",glyph:"M",label:"Multi",description:"Fires 3 bullets",duration:8},bigshot:{color:"#fb7185",glyph:"B",label:"Big",description:"Bigger bullets, +1 dmg",duration:8},slowmo:{color:"#a78bfa",glyph:"⌛",label:"Slow",description:"World slows briefly",duration:3.5},magnet:{color:"#f472b6",glyph:"U",label:"Mag",description:"Pulls pickups nearby",duration:8}};function Pe(c,t=Math.random){let e={heal:2.2,shield:1.6,rapid:1.2,multishot:1,bigshot:.9,slowmo:.9,magnet:1};if(c<5)e.multishot*=.3,e.bigshot*=.3,e.slowmo*=.4,e.magnet*=.5,e.heal*=1.3,e.shield*=1.2;else if(c<15){const f=(c-5)/10;e.multishot*=.3+.7*f,e.bigshot*=.3+.7*f,e.slowmo*=.4+.6*f,e.magnet*=.5+.5*f}else e.rapid*=1.1,e.multishot*=1.15,e.bigshot*=1.1;const s=Object.entries(e).filter(([f,a])=>a>0),r=s.reduce((f,[,a])=>f+a,0);let l=t()*r;for(const[f,a]of s)if(l-=a,l<=0)return f;return s[s.length-1][0]}const Lt=class Lt{constructor(){this.player=new Dt(80,150,26,26),this.obstacles=[],this.hud=new oe,this.timeToNext=0,this.score=0,this.best=0,this.gameOver=!1,this.paused=!1,this.speed=120,this.particles=new qt,this.shakeT=0,this.hintT=4,this.bullets=[],this.enemies=[],this.powerUps=[],this.enemyTimer=0,this.powerTimer=5,this.lastGapCenter=null,this.floats=[],this.playerName=null,this.hurtT=0,this.combo=0,this.comboT=0,this.ended=!1,this.multishotT=0,this.bigshotT=0,this.slowmoT=0,this.magnetT=0,this.rapidT=0,this.pickupBadgeT=0,this.mobileMoveX=0,this.isTouch="ontouchstart"in window,this.btnLeftDown=!1,this.btnRightDown=!1,this.btnShootDown=!1,this.btnRects=null,this.restartRect=null}init(t){this.renderer=new ae(t.canvas,t.ctx),this.obstacles=[],this.score=0,this.timeToNext=0,this.gameOver=!1,this.paused=!1,this.speed=120,this.player.x=80,this.player.y=Math.max(0,(t.canvas.height-this.player.height)*.5),this.player.vx=0,this.player.vy=0,this.player.hp=this.player.maxHp=3,this.player.fireCooldown=0,this.bullets=[],this.enemies=[],this.powerUps=[],this.enemyTimer=2.5,this.powerTimer=5,this.hintT=4,this.shakeT=0,this.floats=[],this.lastGapCenter=null,this.ended=!1,this.btnLeftDown=this.btnRightDown=this.btnShootDown=!1,this.restartRect=null,this.multishotT=0,this.bigshotT=0,this.slowmoT=0,this.magnetT=0,this.rapidT=0;const e=()=>{const y=t.canvas.width,d=t.canvas.height,m=Math.max(60,Math.min(120,Math.floor(Math.min(y,d)*.14))),w=24;this.btnRects={left:{x:w,y:d-m-w,w:m,h:m},right:{x:w+m+16,y:d-m-w,w:m,h:m},shoot:{x:y-m-w,y:d-m-w,w:m,h:m}}},s=()=>{const y=t.canvas.width,d=t.canvas.height,m=Math.max(64,Math.min(120,Math.floor(Math.min(y,d)*.16)));this.restartRect={x:(y-m)/2,y:d*.55,w:m,h:m}},r=(y,d,m)=>{if(!this.btnRects)return!1;const w=this.btnRects[y];return d>=w.x&&d<=w.x+w.w&&m>=w.y&&m<=w.y+w.h},l=y=>{e(),this.btnLeftDown=this.btnRightDown=this.btnShootDown=!1;const d=t.canvas.getBoundingClientRect(),m=t.canvas.width/d.width,w=t.canvas.height/d.height;for(let u=0;u<y.touches.length;u++){const v=y.touches.item(u),M=(v.clientX-d.left)*m,g=(v.clientY-d.top)*w;r("left",M,g)?this.btnLeftDown=!0:r("right",M,g)?this.btnRightDown=!0:r("shoot",M,g)&&(this.btnShootDown=!0)}},f=y=>{var w;if(this.gameOver){if(y.touches!==void 0){s();const u=y,v=t.canvas.getBoundingClientRect(),M=t.canvas.width/v.width,g=t.canvas.height/v.height;for(let S=0;S<u.touches.length;S++){const E=u.touches.item(S),T=(E.clientX-v.left)*M,R=(E.clientY-v.top)*g,I=this.restartRect;if(T>=I.x&&T<=I.x+I.w&&R>=I.y&&R<=I.y+I.h){this.init(t);return}}}else{s();const u=this.restartRect,v=y,M=t.canvas.getBoundingClientRect(),g=t.canvas.width/M.width,S=t.canvas.height/M.height,E=(v.clientX-M.left)*g,T=(v.clientY-M.top)*S;if(E>=u.x&&E<=u.x+u.w&&T>=u.y&&T<=u.y+u.h){this.init(t);return}}return}if(y.touches!==void 0){const u=y;if(l(u),this.btnLeftDown||this.btnRightDown||this.btnShootDown){this.btnShootDown&&this.fireWeapon();return}const v=t.canvas.width,M=t.canvas.height,g=t.canvas.getBoundingClientRect(),S=v/g.width,E=M/g.height;let T=!1;for(let I=0;I<u.touches.length;I++){const A=u.touches.item(I),C=(A.clientX-g.left)*S,O=(A.clientY-g.top)*E;if(C>v*.7&&O>M*.6){T=!0;break}}if(T){this.fireWeapon();return}(((w=u.touches)==null?void 0:w.length)??0)>=2?this.fireWeapon():(q.jump(this.player),D.flap(),this.particles.burst(this.player.x+this.player.width*.2,this.player.y+this.player.height,it.reducedMotion?4:8,"#88ccff88"));return}const d=y.button??0,m=ke(d);m==="flap"?(q.jump(this.player),D.flap()):m==="shoot"&&this.fireWeapon()};t.canvas.oncontextmenu=y=>{y.preventDefault()},t.canvas.onpointerdown=f;const a=y=>{const d=t.canvas.getBoundingClientRect();let m=0,w=0;for(let u=0;u<y.touches.length;u++){const M=y.touches.item(u).clientX-d.left;M<d.width*.45?m=1:M>d.width*.55&&(w=1)}this.mobileMoveX=w-m};t.canvas.ontouchstart=y=>{a(y),f(y)},t.canvas.ontouchmove=y=>{a(y),l(y)},t.canvas.ontouchend=y=>{a(y),l(y)};try{const y=localStorage.getItem("best");y&&(this.best=parseInt(y,10)||0)}catch{}try{this.playerName=ft.getPlayerName()}catch{this.playerName=null}document.addEventListener("visibilitychange",()=>{document.hidden&&(this.paused=!0)})}fireWeapon(){if(this.player.fireCooldown>0)return;const t=this.player.x+this.player.width,e=this.player.y+this.player.height*.5-2,s=l=>{const a=Math.cos(l)*360,y=Math.sin(l)*360,d=new Zt(t,e,a,y,"player");return this.bigshotT>0&&(d.width=14,d.damage=2,d.color="#ffa6a6"),d};this.multishotT>0?(this.bullets.push(s(0-.13)),this.bullets.push(s(0)),this.bullets.push(s(0+.13))):this.bullets.push(s(0));let r=this.bigshotT>0?.22:this.multishotT>0?.2:.18;this.rapidT>0&&(r=Math.max(.08,r*.55)),this.player.fireCooldown=r,D.beep(980,.05,"square",.05)}update(t,e){var m,w;const s=e.canvas.height;if((e.input.wasPressed("Escape")||e.input.wasPressed("KeyP"))&&(this.paused=!this.paused),this.paused){if(e.input.wasPressed("KeyR")){this.init(e),this.paused=!1;return}if(e.input.wasPressed("Enter")||e.input.wasPressed("KeyT")){e.setScene(new zt);return}return}e.input.wasPressed("KeyR")&&this.init(e);const r=this.slowmoT>0?.7:1,l=t*r;(e.input.wasPressed("Space")||e.input.wasPressed("ArrowUp")||e.input.wasPressed("KeyW"))&&(q.jump(this.player),D.flap(),this.particles.burst(this.player.x+this.player.width*.2,this.player.y+this.player.height,it.reducedMotion?4:8,"#88ccff88")),(e.input.isDown("KeyJ")||e.input.isDown("ControlLeft")||e.input.isDown("ControlRight")||this.btnShootDown)&&this.fireWeapon();const f=e.input.getMovementDirection(),a=((w=(m=e.input).getWASDHorizontal)==null?void 0:w.call(m))??(e.input.isDown("KeyD")?1:0)+(e.input.isDown("KeyA")?-1:0),y=(this.btnRightDown?1:0)-(this.btnLeftDown?1:0);if(this.player.vx=(f.x+a+this.mobileMoveX+y)*80,q.applyGravity(this.player,l),this.player.update(l),this.player.y=Math.max(0,Math.min(s-this.player.height,this.player.y)),this.timeToNext-=l,this.timeToNext<=0){const u=Math.min(1,this.score/30);this.speed=Math.min(280,120+u*140);const v=Math.max(150,230-this.score*2.2);this.timeToNext=Math.max(1.1,1.8-this.score*.02);const M=v,g=60,S=g+M/2,E=s-g-M/2,T=this.lastGapCenter??s/2,R=140+Math.min(100,this.score*2),I=Math.max(S,T-R),A=Math.min(E,T+R),C=I<=A?I+Math.random()*(A-I):Math.min(E,Math.max(S,T)),O=Math.floor(C-M/2);this.lastGapCenter=C;const G=80,F=e.canvas.width+G;this.obstacles.push(new ct(F,0,G,O,this.speed)),this.obstacles.push(new ct(F,O+M,G,s-(O+M),this.speed))}for(const u of this.obstacles)u.update(l);this.obstacles=this.obstacles.filter(u=>!u.isOffScreen());for(const u of this.obstacles)q.checkCollision(this.player,u)&&(this.player.hp-=1,D.hit(),this.particles.burst(this.player.x+this.player.width/2,this.player.y+this.player.height/2,it.reducedMotion?6:12,"#ff7b72aa"),this.shakeT=it.reducedMotion?0:.2,this.hurtT=.35,this.combo=0,this.comboT=0,this.player.x-=10,this.player.hp<=0&&this.finalizeGameOver());for(let u=0;u<this.obstacles.length;u+=2){const v=this.obstacles[u],M=v.x+v.width/2;!this.gameOver&&M<this.player.x&&v.counted!==!0&&(v.counted=!0,this.score+=1,this.player.passObstacle(),D.score())}if(this.enemyTimer-=l,this.enemyTimer<=0){let u=40,v=s-40;if(this.obstacles.length>=2){let G=0,F=-1/0;for(let k=0;k<this.obstacles.length-1;k+=2){const L=this.obstacles[k];L.x>F&&(F=L.x,G=k)}const ut=this.obstacles[G],_=this.obstacles[G+1];u=ut.height,v=_.y}const M=12,g=Math.max(0,u+M),S=Math.min(s-20,v-M-18),E=e.canvas.width+40,T=g<S?g+(S-g)*(.35+Math.random()*.3):40+Math.random()*(s-120);let R="drone";this.score>6&&Math.random()<.5&&(R="bee"),this.score>15&&Math.random()<.35&&(R="tank"),this.score>25&&Math.random()<.25&&(R="kamikaze");const A=-((R==="tank"?90:120)+Math.random()*60+this.score*1.2),C=new Ye(E,T,A,0,R);C.minY=isFinite(g)?g:20,C.maxY=isFinite(S)?S:s-40,C.phase=Math.random()*Math.PI*2,this.enemies.push(C);const O=2.4-Math.min(1.2,this.score*.03);this.enemyTimer=Math.max(.8,O+(R==="tank"?.3:0))}if(this.powerTimer-=l,this.powerTimer<=0){const u=Pe(this.score);this.powerUps.push(new Gt(e.canvas.width+20,80+Math.random()*(s-160),u)),this.powerTimer=8+Math.random()*6}for(const u of this.bullets)u.update(l);for(const u of this.enemies){const v=(u.phase??0)+performance.now()/1e3;if(u.variant==="kamikaze"){const E=this.player.y-6-u.y;u.vy=Math.max(-120,Math.min(120,E*2))}else u.variant==="bee"?u.vy=Math.sin(v*1.5)*55:u.variant==="tank"?u.vy=Math.sin(v*.6)*24:u.vy=Math.sin(v)*35;u.update(l);const M=u.minY??20,g=u.maxY??s-40;u.y<M&&(u.y=M),u.y+u.height>g&&(u.y=g-u.height)}for(const u of this.powerUps){if(this.magnetT>0){const v=this.player.x+this.player.width/2,M=this.player.y+this.player.height/2,g=v-(u.x+u.width/2),S=M-(u.y+u.height/2);g*g+S*S<200*200&&(u.vx+=Math.sign(g)*20,u.vy+=Math.sign(S)*20,!it.reducedMotion&&Math.random()<.25&&this.particles.burst(u.x+u.width/2,u.y+u.height/2,1,"#f472b6aa"))}u.update(l)}this.bullets=this.bullets.filter(u=>!u.isOffScreen(e.canvas.width,s)&&u.active),this.enemies=this.enemies.filter(u=>!u.isOffScreen()),this.powerUps=this.powerUps.filter(u=>!u.isOffScreen());const d=(u,v,M,g,S,E,T,R)=>u<S+T&&u+M>S&&v<E+R&&v+g>E;for(const u of this.bullets)for(const v of this.enemies)if(u.active&&d(u.x,u.y,u.width,u.height,v.x,v.y,v.width,v.height)&&(u.active=!1,v.health-=u.damage??1,this.particles.burst(v.x+v.width/2,v.y+v.height/2,it.reducedMotion?6:10,"#ffd166aa"),v.health<=0)){const M=v.x+v.width/2,g=v.y+v.height/2;this.particles.burst(M,g,it.reducedMotion?10:22,"#ffb347aa"),this.particles.burst(M,g,it.reducedMotion?8:14,"#ff7b72aa"),v.x=-9999;const S=v.variant==="tank"?Lt.KILL_POINTS+1:Lt.KILL_POINTS,E=2.2;this.comboT>0?this.combo++:this.combo=1,this.comboT=E;const T=Math.max(0,this.combo-1);this.score+=S+T,this.floats.push({x:M,y:g,text:`+${S}`,ttl:.9,vy:-32}),T>0&&(this.floats.push({x:M+14,y:g-18,text:`x${this.combo}`,ttl:.8,vy:-26}),D.combo(this.combo)),this.shakeT=it.reducedMotion?0:Math.max(this.shakeT,.12),D.score()}this.enemies=this.enemies.filter(u=>u.x>-9e3);for(const u of this.enemies)d(this.player.x,this.player.y,this.player.width,this.player.height,u.x,u.y,u.width,u.height)&&(this.player.hp-=1,D.hit(),this.particles.burst(u.x+u.width/2,u.y+u.height/2,10,"#ff7b72aa"),u.x=-9999,this.player.hp<=0&&this.finalizeGameOver());for(const u of this.powerUps)d(this.player.x,this.player.y,this.player.width,this.player.height,u.x,u.y,u.width,u.height)&&(u.type==="heal"&&(this.player.hp=Math.min(this.player.maxHp,this.player.hp+1)),u.type==="rapid"&&(this.rapidT=Math.max(this.rapidT,8)),u.type==="shield"&&(this.player.maxHp=Math.min(5,this.player.maxHp+1),this.player.hp=Math.min(this.player.maxHp,this.player.hp+1)),u.type==="multishot"&&(this.multishotT=Math.max(this.multishotT,8)),u.type==="bigshot"&&(this.bigshotT=Math.max(this.bigshotT,8)),u.type==="slowmo"&&(this.slowmoT=Math.max(this.slowmoT,3.5)),u.type==="magnet"&&(this.magnetT=Math.max(this.magnetT,8)),this.particles.burst(u.x+u.width/2,u.y+u.height/2,14,"#7ee787aa"),u.x=-9999,this.pickupBadgeT=1.4);this.particles.update(l),this.shakeT=Math.max(0,this.shakeT-t),this.hurtT=Math.max(0,this.hurtT-t),this.comboT>0&&(this.comboT=Math.max(0,this.comboT-t)),this.slowmoT=Math.max(0,this.slowmoT-t),this.multishotT=Math.max(0,this.multishotT-t),this.bigshotT=Math.max(0,this.bigshotT-t),this.magnetT=Math.max(0,this.magnetT-t),this.rapidT=Math.max(0,this.rapidT-t);for(const u of this.floats)u.ttl-=t,u.y+=u.vy*t;this.floats=this.floats.filter(u=>u.ttl>0),this.hintT=Math.max(0,this.hintT-t)}finalizeGameOver(){if(this.ended)return;this.ended=!0,this.gameOver=!0,this.best=Math.max(this.best,this.score);try{localStorage.setItem("best",String(this.best))}catch{}let t=ft.getPlayerName()||"";try{const e=typeof window<"u"?window.prompt("Name for high score?",t||"Anon"):null;e!=null&&(t=e,ft.setPlayerName(t))}catch{}ft.addScore(this.score,Date.now(),t),this.playerName=t}render(t,e){t.save(),this.renderer.clear(1/60);for(const f of this.obstacles)this.renderer.drawObstacle(f);for(const f of this.enemies)this.renderer.drawEnemy(f);for(const f of this.powerUps)this.renderer.drawPowerUp(f);const s=4,r=it.reducedMotion?0:this.shakeT>0?Math.min(s,s*Math.min(1,this.shakeT/.2)):0;if(t.save(),r>0){const f=(Math.random()-.5)*2*r,a=(Math.random()-.5)*2*r;t.translate(f,a)}const l=this.hurtT>0?"#f87171":"#58a6ff";if(this.renderer.drawPlayer(this.player,l),this.playerName){const f=this.playerName.slice(0,18),a=this.player.x+this.player.width/2;let y=this.player.y-6;y<14&&(y=this.player.y+this.player.height+14),t.save(),t.textAlign="center",t.font="600 12px system-ui",t.lineWidth=3,t.strokeStyle="#00000077",t.strokeText(f,a,y),t.fillStyle="#cdd9e5",t.fillText(f,a,y),t.restore()}for(const f of this.bullets)this.renderer.drawProjectile(f);this.particles.render(t),t.restore(),this.hud.render(t,this.score,void 0,this.player.hp);{const f=[{active:this.rapidT>0,color:"#f7b84a",glyph:"R",rem:this.rapidT,dur:8},{active:this.multishotT>0,color:"#38bdf8",glyph:"M",rem:this.multishotT,dur:8},{active:this.bigshotT>0,color:"#fb7185",glyph:"B",rem:this.bigshotT,dur:8},{active:this.slowmoT>0,color:"#a78bfa",glyph:"⌛",rem:this.slowmoT,dur:3.5},{active:this.magnetT>0,color:"#f472b6",glyph:"U",rem:this.magnetT,dur:8}],y=16+(this.player.hp??0)*18+12;let d=y,m=36;const w=12,u=12,v=3,M=6,g=e.canvas.width-16;for(const S of f){if(!S.active)continue;d+w>g&&(d=y,m+=u+6),t.save(),t.globalAlpha=.95,t.fillStyle=S.color,t.beginPath(),t.roundRect(d,m+2,w,u,v),t.fill();const E=Math.max(0,Math.min(1,S.rem/S.dur));t.strokeStyle="#0f172a",t.lineWidth=1.5,t.beginPath(),t.arc(d+w/2,m+2+u/2,6,-Math.PI/2,-Math.PI/2+E*Math.PI*2),t.stroke(),t.fillStyle="#0f172a",t.font="700 9px system-ui";const T=t.measureText(S.glyph).width;t.fillText(S.glyph,d+(w-T)/2,m+11),t.restore(),d+=w+M}}if(this.pickupBadgeT>0){const f=Math.min(1,this.pickupBadgeT/1.4);t.save(),t.globalAlpha=f*.9;const a=[{label:"Rapid",active:this.rapidT>0,color:"#f7b84a"},{label:"Multi",active:this.multishotT>0,color:"#38bdf8"},{label:"Big",active:this.bigshotT>0,color:"#fb7185"},{label:"Slow",active:this.slowmoT>0,color:"#a78bfa"},{label:"Mag",active:this.magnetT>0,color:"#f472b6"}].filter(m=>m.active);let y=16,d=82;for(const m of a)t.fillStyle="#0f172acc",t.beginPath(),t.roundRect(y,d,86,22,8),t.fill(),t.fillStyle=m.color+"dd",t.beginPath(),t.roundRect(y+2,d+2,82,18,6),t.strokeStyle=m.color+"66",t.lineWidth=2,t.stroke(),t.fillStyle="#e8e8f0",t.font="700 12px system-ui",t.fillText(m.label,y+10,d+15),y+=94;t.restore()}if(this.slowmoT>0){const f=Math.min(.25,.15+this.slowmoT/4*.1);t.save(),t.globalAlpha=f,t.fillStyle="#0b1022",t.fillRect(0,0,e.canvas.width,e.canvas.height),t.restore()}if(this.comboT>0&&this.combo>1&&(t.save(),t.fillStyle="#ffd166",t.font="700 14px system-ui",t.fillText(`Combo x${this.combo}`,16,46),t.restore()),this.floats.length)for(const f of this.floats){const a=Math.max(0,Math.min(1,f.ttl/.9));t.save(),t.globalAlpha=a,t.fillStyle="#ffd166",t.font="700 18px system-ui",t.fillText(f.text,f.x,f.y),t.restore()}if(this.isTouch){const f=e.canvas.width,a=e.canvas.height,y=Math.max(60,Math.min(120,Math.floor(Math.min(f,a)*.14))),d=24;this.btnRects={left:{x:d,y:a-y-d,w:y,h:y},right:{x:d+y+16,y:a-y-d,w:y,h:y},shoot:{x:f-y-d,y:a-y-d,w:y,h:y}};const m=(w,u,v)=>{t.save(),t.globalAlpha=.6,t.fillStyle=u?"#58a6ff":"#0f172a",t.strokeStyle="#58a6ff88",t.lineWidth=4,t.beginPath(),t.roundRect(w.x,w.y,w.w,w.h,16),t.fill(),t.stroke(),t.fillStyle="#e8e8f0",t.font="700 16px system-ui";const M=t.measureText(v).width;t.fillText(v,w.x+(w.w-M)/2,w.y+w.h/2+6),t.restore()};m(this.btnRects.left,this.btnLeftDown,"L"),m(this.btnRects.right,this.btnRightDown,"R"),m(this.btnRects.shoot,this.btnShootDown,"S")}if(this.hintT>0){const f=Math.min(.8,this.hintT/4);t.save(),t.globalAlpha=f,t.fillStyle="#00000088",t.fillRect(20,70,520,56),t.fillStyle="#e8e8f0",t.font="600 16px system-ui",t.fillText("Flap: Space/ArrowUp/W or Click • Move: Arrows or A/D • Shoot: Right Click or Ctrl/J (hold)",28,100),t.restore()}if(t.restore(),this.paused){t.fillStyle="#00000088",t.fillRect(0,0,e.canvas.width,e.canvas.height);const f=Math.min(420,e.canvas.width-40),a=180,y=(e.canvas.width-f)/2,d=Math.max(60,e.canvas.height*.3);t.fillStyle="#0f172ae6",t.beginPath(),t.roundRect(y,d,f,a,12),t.fill(),t.strokeStyle="#58a6ff55",t.stroke(),t.fillStyle="#e8e8f0",t.font="800 24px system-ui",t.fillText("Paused",y+16,d+34),t.font="600 15px system-ui",t.fillText("Enter/T: Return to Main Menu",y+16,d+74),t.fillText("R: Restart",y+16,d+100),t.fillText("Esc/P: Resume",y+16,d+126)}if(this.gameOver){t.fillStyle="#00000088",t.fillRect(0,0,e.canvas.width,e.canvas.height),t.fillStyle="#e8e8f0",t.font="700 28px system-ui",t.fillText(`Game Over — Score ${this.score}  Best ${this.best}`,40,120),t.font="500 18px system-ui",t.fillText("Press R or tap the restart button",40,160);const f=e.canvas.width,a=e.canvas.height,y=Math.max(64,Math.min(120,Math.floor(Math.min(f,a)*.16))),d=(f-y)/2,m=a*.55;this.restartRect={x:d,y:m,w:y,h:y},t.save(),t.globalAlpha=.9,t.fillStyle="#0f172a",t.strokeStyle="#58a6ff88",t.lineWidth=5,t.beginPath(),t.roundRect(d,m,y,y,18),t.fill(),t.stroke(),t.fillStyle="#e8e8f0",t.font="700 28px system-ui",t.fillText("⟲",d+y/2-10,m+y/2+12),t.restore()}}};Lt.KILL_POINTS=2;let Ot=Lt;class te{constructor(){this.p1=new Dt(80,140,26,26),this.p2=new Dt(120,220,26,26),this.obstacles=[],this.hud=new oe,this.timeToNext=0,this.s1=0,this.s2=0,this.paused=!1,this.speed=140,this.particles=new qt,this.shakeT=0}init(t){this.renderer=new ae(t.canvas,t.ctx),this.obstacles=[],this.timeToNext=0,this.s1=0,this.s2=0,this.paused=!1,this.speed=140;const e=()=>{q.jump(this.p1),D.flap()};t.canvas.ontouchstart=e,t.canvas.onpointerdown=e}update(t,e){const s=e.canvas.height;if(this.shakeT=Math.max(0,this.shakeT-t),(e.input.wasPressed("Escape")||e.input.wasPressed("KeyP"))&&(this.paused=!this.paused),this.paused){if(e.input.wasPressed("KeyR")){this.init(e),this.paused=!1;return}if(e.input.wasPressed("Enter")||e.input.wasPressed("KeyT")){e.setScene(new zt);return}return}e.input.wasPressed("KeyR")&&this.init(e),(e.input.wasPressed("Space")||e.input.wasPressed("ArrowUp"))&&(q.jump(this.p1),D.flap(),this.particles.burst(this.p1.x,this.p1.y+this.p1.height,6,"#88ccff88")),e.input.wasPressed("KeyW")&&(q.jump(this.p2),D.flap(),this.particles.burst(this.p2.x,this.p2.y+this.p2.height,6,"#ffb08888"));const r=e.input.getMovementDirection();if(this.p1.vx=r.x*80,this.p2.vx=0,this.p2.vy+=(e.input.isDown("KeyS")?1:0)*300*t,q.applyGravity(this.p1,t),q.applyGravity(this.p2,t),this.p1.update(t),this.p2.update(t),this.p1.y=Math.max(0,Math.min(s-this.p1.height,this.p1.y)),this.p2.y=Math.max(0,Math.min(s-this.p2.height,this.p2.y)),this.timeToNext-=t,this.timeToNext<=0){this.speed=Math.min(260,this.speed+2);const l=Math.max(130,180-Math.max(this.s1,this.s2)*2);this.timeToNext=Math.max(1,1.7-Math.max(this.s1,this.s2)*.02);const f=40,a=s-l-40,y=Math.floor(Math.random()*(a-f+1))+f,d=80,m=e.canvas.width+d;this.obstacles.push(new ct(m,0,d,y,this.speed)),this.obstacles.push(new ct(m,y+l,d,s-(y+l),this.speed))}for(const l of this.obstacles)l.update(t);this.obstacles=this.obstacles.filter(l=>!l.isOffScreen());for(const l of this.obstacles)if(q.checkCollision(this.p1,l)||q.checkCollision(this.p2,l)){D.hit(),this.particles.burst((this.p1.x+this.p2.x)/2,(this.p1.y+this.p2.y)/2,16,"#ff7b72aa"),this.shakeT=.25,this.init(e);return}for(let l=0;l<this.obstacles.length;l+=2){const f=this.obstacles[l],a=f.x+f.width/2;a<this.p1.x&&f.p1c!==!0&&(f.p1c=!0,this.s1+=1,this.p1.passObstacle(),D.score()),a<this.p2.x&&f.p2c!==!0&&(f.p2c=!0,this.s2+=1,this.p2.passObstacle(),D.score())}}render(t,e){t.save(),this.renderer.clear(1/60);for(const l of this.obstacles)this.renderer.drawObstacle(l);const r=it.reducedMotion?0:this.shakeT>0?Math.min(4,8*Math.min(1,this.shakeT/.25)):0;if(t.save(),r>0){const l=(Math.random()-.5)*2*r,f=(Math.random()-.5)*2*r;t.translate(l,f)}if(this.renderer.drawPlayer(this.p1,"#58a6ff"),this.renderer.drawPlayer(this.p2,"#ff7b72"),this.particles.render(t),t.restore(),this.hud.render(t,this.s1,this.s2),t.restore(),this.paused){t.fillStyle="#00000088",t.fillRect(0,0,e.canvas.width,e.canvas.height);const l=Math.min(420,e.canvas.width-40),f=160,a=(e.canvas.width-l)/2,y=Math.max(60,e.canvas.height*.3);t.fillStyle="#0f172ae6",t.beginPath(),t.roundRect(a,y,l,f,12),t.fill(),t.strokeStyle="#58a6ff55",t.stroke(),t.fillStyle="#e8e8f0",t.font="800 24px system-ui",t.fillText("Paused",a+16,y+34),t.font="600 15px system-ui",t.fillText("Enter/T: Return to Main Menu",a+16,y+74),t.fillText("R: Restart",a+16,y+100),t.fillText("Esc/P: Resume",a+16,y+126)}}}class ee extends Error{constructor(t){super(t),this.name="AbortError"}}function Xe(c,t){const{cleanupBeforeAbort:e,abortSignal:s,abortErrorMsg:r}=t??{};return new Promise((l,f)=>{function a(){f(new ee(r??"The operation was aborted."))}function y(){s==null||s.removeEventListener("abort",d)}function d(){e==null||e(),y(),a()}if(s!=null&&s.aborted)return a();try{c(m=>{y(),l(m)},m=>{y(),f(m)})}catch(m){f(m)}s==null||s.addEventListener("abort",d)})}const Je="The delay was aborted.";function Wt(c,t){let e;const{abortSignal:s,abortErrorMsg:r}={};return Xe(l=>{e=setTimeout(l,c)},{cleanupBeforeAbort:()=>clearTimeout(e),abortSignal:s,abortErrorMsg:r??Je})}function Ze(c){return c&&c.__esModule&&Object.prototype.hasOwnProperty.call(c,"default")?c.default:c}var he={exports:{}},It=typeof Reflect=="object"?Reflect:null,me=It&&typeof It.apply=="function"?It.apply:function(t,e,s){return Function.prototype.apply.call(t,e,s)},Ht;It&&typeof It.ownKeys=="function"?Ht=It.ownKeys:Object.getOwnPropertySymbols?Ht=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:Ht=function(t){return Object.getOwnPropertyNames(t)};function Qe(c){console&&console.warn&&console.warn(c)}var Ce=Number.isNaN||function(t){return t!==t};function U(){U.init.call(this)}he.exports=U;he.exports.once=si;U.EventEmitter=U;U.prototype._events=void 0;U.prototype._eventsCount=0;U.prototype._maxListeners=void 0;var we=10;function Vt(c){if(typeof c!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof c)}Object.defineProperty(U,"defaultMaxListeners",{enumerable:!0,get:function(){return we},set:function(c){if(typeof c!="number"||c<0||Ce(c))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+c+".");we=c}});U.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};U.prototype.setMaxListeners=function(t){if(typeof t!="number"||t<0||Ce(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function Be(c){return c._maxListeners===void 0?U.defaultMaxListeners:c._maxListeners}U.prototype.getMaxListeners=function(){return Be(this)};U.prototype.emit=function(t){for(var e=[],s=1;s<arguments.length;s++)e.push(arguments[s]);var r=t==="error",l=this._events;if(l!==void 0)r=r&&l.error===void 0;else if(!r)return!1;if(r){var f;if(e.length>0&&(f=e[0]),f instanceof Error)throw f;var a=new Error("Unhandled error."+(f?" ("+f.message+")":""));throw a.context=f,a}var y=l[t];if(y===void 0)return!1;if(typeof y=="function")me(y,this,e);else for(var d=y.length,m=Fe(y,d),s=0;s<d;++s)me(m[s],this,e);return!0};function Le(c,t,e,s){var r,l,f;if(Vt(e),l=c._events,l===void 0?(l=c._events=Object.create(null),c._eventsCount=0):(l.newListener!==void 0&&(c.emit("newListener",t,e.listener?e.listener:e),l=c._events),f=l[t]),f===void 0)f=l[t]=e,++c._eventsCount;else if(typeof f=="function"?f=l[t]=s?[e,f]:[f,e]:s?f.unshift(e):f.push(e),r=Be(c),r>0&&f.length>r&&!f.warned){f.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+f.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=c,a.type=t,a.count=f.length,Qe(a)}return c}U.prototype.addListener=function(t,e){return Le(this,t,e,!1)};U.prototype.on=U.prototype.addListener;U.prototype.prependListener=function(t,e){return Le(this,t,e,!0)};function ti(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function De(c,t,e){var s={fired:!1,wrapFn:void 0,target:c,type:t,listener:e},r=ti.bind(s);return r.listener=e,s.wrapFn=r,r}U.prototype.once=function(t,e){return Vt(e),this.on(t,De(this,t,e)),this};U.prototype.prependOnceListener=function(t,e){return Vt(e),this.prependListener(t,De(this,t,e)),this};U.prototype.removeListener=function(t,e){var s,r,l,f,a;if(Vt(e),r=this._events,r===void 0)return this;if(s=r[t],s===void 0)return this;if(s===e||s.listener===e)--this._eventsCount===0?this._events=Object.create(null):(delete r[t],r.removeListener&&this.emit("removeListener",t,s.listener||e));else if(typeof s!="function"){for(l=-1,f=s.length-1;f>=0;f--)if(s[f]===e||s[f].listener===e){a=s[f].listener,l=f;break}if(l<0)return this;l===0?s.shift():ei(s,l),s.length===1&&(r[t]=s[0]),r.removeListener!==void 0&&this.emit("removeListener",t,a||e)}return this};U.prototype.off=U.prototype.removeListener;U.prototype.removeAllListeners=function(t){var e,s,r;if(s=this._events,s===void 0)return this;if(s.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):s[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete s[t]),this;if(arguments.length===0){var l=Object.keys(s),f;for(r=0;r<l.length;++r)f=l[r],f!=="removeListener"&&this.removeAllListeners(f);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(e=s[t],typeof e=="function")this.removeListener(t,e);else if(e!==void 0)for(r=e.length-1;r>=0;r--)this.removeListener(t,e[r]);return this};function Oe(c,t,e){var s=c._events;if(s===void 0)return[];var r=s[t];return r===void 0?[]:typeof r=="function"?e?[r.listener||r]:[r]:e?ii(r):Fe(r,r.length)}U.prototype.listeners=function(t){return Oe(this,t,!0)};U.prototype.rawListeners=function(t){return Oe(this,t,!1)};U.listenerCount=function(c,t){return typeof c.listenerCount=="function"?c.listenerCount(t):Ue.call(c,t)};U.prototype.listenerCount=Ue;function Ue(c){var t=this._events;if(t!==void 0){var e=t[c];if(typeof e=="function")return 1;if(e!==void 0)return e.length}return 0}U.prototype.eventNames=function(){return this._eventsCount>0?Ht(this._events):[]};function Fe(c,t){for(var e=new Array(t),s=0;s<t;++s)e[s]=c[s];return e}function ei(c,t){for(;t+1<c.length;t++)c[t]=c[t+1];c.pop()}function ii(c){for(var t=new Array(c.length),e=0;e<t.length;++e)t[e]=c[e].listener||c[e];return t}function si(c,t){return new Promise(function(e,s){function r(f){c.removeListener(t,l),s(f)}function l(){typeof c.removeListener=="function"&&c.removeListener("error",r),e([].slice.call(arguments))}Ne(c,t,l,{once:!0}),t!=="error"&&ni(c,r,{once:!0})})}function ni(c,t,e){typeof c.on=="function"&&Ne(c,"error",t,e)}function Ne(c,t,e,s){if(typeof c.on=="function")s.once?c.once(t,e):c.on(t,e);else if(typeof c.addEventListener=="function")c.addEventListener(t,function r(l){s.once&&c.removeEventListener(t,r),e(l)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof c)}var ri=he.exports;const oi=Ze(ri);class jt extends Error{constructor(t,e){super(t),this.name="SendMessageError",this.ackId=e.ackId,this.errorDetail=e.errorDetail}}function ai(...c){if(c.length>0){const t=String(c[0]);t.includes(":error")?console.error(...c):t.includes(":warning")?console.warn(...c):t.includes(":info")?console.info(...c):t.includes(":verbose")?console.debug(...c):console.debug(...c)}}var ge={};const be=typeof process<"u"&&ge&&ge.DEBUG||void 0;let $e,ie=[],se=[];const Kt=[];be&&le(be);const Et=Object.assign(c=>je(c),{enable:le,enabled:ce,disable:hi,log:ai});function le(c){$e=c,ie=[],se=[];const t=/\*/g,e=c.split(",").map(s=>s.trim().replace(t,".*?"));for(const s of e)s.startsWith("-")?se.push(new RegExp(`^${s.substr(1)}$`)):ie.push(new RegExp(`^${s}$`));for(const s of Kt)s.enabled=ce(s.namespace)}function ce(c){if(c.endsWith("*"))return!0;for(const t of se)if(t.test(c))return!1;for(const t of ie)if(t.test(c))return!0;return!1}function hi(){const c=$e||"";return le(""),c}function je(c){const t=Object.assign(e,{enabled:ce(c),destroy:li,log:Et.log,namespace:c,extend:ci});function e(...s){t.enabled&&(s.length>0&&(s[0]=`${c} ${s[0]}`),t.log(...s))}return Kt.push(t),t}function li(){const c=Kt.indexOf(this);return c>=0?(Kt.splice(c,1),!0):!1}function ci(c){const t=je(`${this.namespace}:${c}`);return t.log=this.log,t}var ve={};const ne=["verbose","info","warning","error"],xe={verbose:400,info:300,warning:200,error:100};function Me(c,t){t.log=(...e)=>{c.log(...e)}}function Se(c){return ne.includes(c)}function Ge(c){const t=new Set,e=typeof process<"u"&&ve&&ve[c.logLevelEnvVarName]||void 0;let s;const r=Et(c.namespace);r.log=(...m)=>{Et.log(...m)};function l(m){if(m&&!Se(m))throw new Error(`Unknown log level '${m}'. Acceptable values: ${ne.join(",")}`);s=m;const w=[];for(const u of t)f(u)&&w.push(u.namespace);Et.enable(w.join(","))}e&&(Se(e)?l(e):console.error(`${c.logLevelEnvVarName} set to unknown log level '${e}'; logging is not enabled. Acceptable values: ${ne.join(", ")}.`));function f(m){return!!(s&&xe[m.level]<=xe[s])}function a(m,w){const u=Object.assign(m.extend(w),{level:w});if(Me(m,u),f(u)){const v=Et.disable();Et.enable(v+","+u.namespace)}return t.add(u),u}function y(){return s}function d(m){const w=r.extend(m);return Me(r,w),{error:a(w,"error"),warning:a(w,"warning"),info:a(w,"info"),verbose:a(w,"verbose")}}return{setLogLevel:l,getLogLevel:y,createClientLogger:d,logger:r}}Ge({logLevelEnvVarName:"TYPESPEC_RUNTIME_LOG_LEVEL",namespace:"typeSpecRuntime"});const fi=Ge({logLevelEnvVarName:"AZURE_LOG_LEVEL",namespace:"azure"});function ui(c){return fi.createClientLogger(c)}const nt=ui("web-pubsub-client");var fe={},Yt={};Yt.byteLength=yi;Yt.toByteArray=wi;Yt.fromByteArray=vi;var yt=[],lt=[],di=typeof Uint8Array<"u"?Uint8Array:Array,Jt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var _t=0,pi=Jt.length;_t<pi;++_t)yt[_t]=Jt[_t],lt[Jt.charCodeAt(_t)]=_t;lt[45]=62;lt[95]=63;function We(c){var t=c.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var e=c.indexOf("=");e===-1&&(e=t);var s=e===t?0:4-e%4;return[e,s]}function yi(c){var t=We(c),e=t[0],s=t[1];return(e+s)*3/4-s}function mi(c,t,e){return(t+e)*3/4-e}function wi(c){var t,e=We(c),s=e[0],r=e[1],l=new di(mi(c,s,r)),f=0,a=r>0?s-4:s,y;for(y=0;y<a;y+=4)t=lt[c.charCodeAt(y)]<<18|lt[c.charCodeAt(y+1)]<<12|lt[c.charCodeAt(y+2)]<<6|lt[c.charCodeAt(y+3)],l[f++]=t>>16&255,l[f++]=t>>8&255,l[f++]=t&255;return r===2&&(t=lt[c.charCodeAt(y)]<<2|lt[c.charCodeAt(y+1)]>>4,l[f++]=t&255),r===1&&(t=lt[c.charCodeAt(y)]<<10|lt[c.charCodeAt(y+1)]<<4|lt[c.charCodeAt(y+2)]>>2,l[f++]=t>>8&255,l[f++]=t&255),l}function gi(c){return yt[c>>18&63]+yt[c>>12&63]+yt[c>>6&63]+yt[c&63]}function bi(c,t,e){for(var s,r=[],l=t;l<e;l+=3)s=(c[l]<<16&16711680)+(c[l+1]<<8&65280)+(c[l+2]&255),r.push(gi(s));return r.join("")}function vi(c){for(var t,e=c.length,s=e%3,r=[],l=16383,f=0,a=e-s;f<a;f+=l)r.push(bi(c,f,f+l>a?a:f+l));return s===1?(t=c[e-1],r.push(yt[t>>2]+yt[t<<4&63]+"==")):s===2&&(t=(c[e-2]<<8)+c[e-1],r.push(yt[t>>10]+yt[t>>4&63]+yt[t<<2&63]+"=")),r.join("")}var ue={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */ue.read=function(c,t,e,s,r){var l,f,a=r*8-s-1,y=(1<<a)-1,d=y>>1,m=-7,w=e?r-1:0,u=e?-1:1,v=c[t+w];for(w+=u,l=v&(1<<-m)-1,v>>=-m,m+=a;m>0;l=l*256+c[t+w],w+=u,m-=8);for(f=l&(1<<-m)-1,l>>=-m,m+=s;m>0;f=f*256+c[t+w],w+=u,m-=8);if(l===0)l=1-d;else{if(l===y)return f?NaN:(v?-1:1)*(1/0);f=f+Math.pow(2,s),l=l-d}return(v?-1:1)*f*Math.pow(2,l-s)};ue.write=function(c,t,e,s,r,l){var f,a,y,d=l*8-r-1,m=(1<<d)-1,w=m>>1,u=r===23?Math.pow(2,-24)-Math.pow(2,-77):0,v=s?0:l-1,M=s?1:-1,g=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,f=m):(f=Math.floor(Math.log(t)/Math.LN2),t*(y=Math.pow(2,-f))<1&&(f--,y*=2),f+w>=1?t+=u/y:t+=u*Math.pow(2,1-w),t*y>=2&&(f++,y/=2),f+w>=m?(a=0,f=m):f+w>=1?(a=(t*y-1)*Math.pow(2,r),f=f+w):(a=t*Math.pow(2,w-1)*Math.pow(2,r),f=0));r>=8;c[e+v]=a&255,v+=M,a/=256,r-=8);for(f=f<<r|a,d+=r;d>0;c[e+v]=f&255,v+=M,f/=256,d-=8);c[e+v-M]|=g*128};/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(c){const t=Yt,e=ue,s=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;c.Buffer=a,c.SlowBuffer=T,c.INSPECT_MAX_BYTES=50;const r=2147483647;c.kMaxLength=r,a.TYPED_ARRAY_SUPPORT=l(),!a.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function l(){try{const o=new Uint8Array(1),i={foo:function(){return 42}};return Object.setPrototypeOf(i,Uint8Array.prototype),Object.setPrototypeOf(o,i),o.foo()===42}catch{return!1}}Object.defineProperty(a.prototype,"parent",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.buffer}}),Object.defineProperty(a.prototype,"offset",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.byteOffset}});function f(o){if(o>r)throw new RangeError('The value "'+o+'" is invalid for option "size"');const i=new Uint8Array(o);return Object.setPrototypeOf(i,a.prototype),i}function a(o,i,n){if(typeof o=="number"){if(typeof i=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return w(o)}return y(o,i,n)}a.poolSize=8192;function y(o,i,n){if(typeof o=="string")return u(o,i);if(ArrayBuffer.isView(o))return M(o);if(o==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof o);if(Y(o,ArrayBuffer)||o&&Y(o.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(Y(o,SharedArrayBuffer)||o&&Y(o.buffer,SharedArrayBuffer)))return g(o,i,n);if(typeof o=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const h=o.valueOf&&o.valueOf();if(h!=null&&h!==o)return a.from(h,i,n);const p=S(o);if(p)return p;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof o[Symbol.toPrimitive]=="function")return a.from(o[Symbol.toPrimitive]("string"),i,n);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof o)}a.from=function(o,i,n){return y(o,i,n)},Object.setPrototypeOf(a.prototype,Uint8Array.prototype),Object.setPrototypeOf(a,Uint8Array);function d(o){if(typeof o!="number")throw new TypeError('"size" argument must be of type number');if(o<0)throw new RangeError('The value "'+o+'" is invalid for option "size"')}function m(o,i,n){return d(o),o<=0?f(o):i!==void 0?typeof n=="string"?f(o).fill(i,n):f(o).fill(i):f(o)}a.alloc=function(o,i,n){return m(o,i,n)};function w(o){return d(o),f(o<0?0:E(o)|0)}a.allocUnsafe=function(o){return w(o)},a.allocUnsafeSlow=function(o){return w(o)};function u(o,i){if((typeof i!="string"||i==="")&&(i="utf8"),!a.isEncoding(i))throw new TypeError("Unknown encoding: "+i);const n=R(o,i)|0;let h=f(n);const p=h.write(o,i);return p!==n&&(h=h.slice(0,p)),h}function v(o){const i=o.length<0?0:E(o.length)|0,n=f(i);for(let h=0;h<i;h+=1)n[h]=o[h]&255;return n}function M(o){if(Y(o,Uint8Array)){const i=new Uint8Array(o);return g(i.buffer,i.byteOffset,i.byteLength)}return v(o)}function g(o,i,n){if(i<0||o.byteLength<i)throw new RangeError('"offset" is outside of buffer bounds');if(o.byteLength<i+(n||0))throw new RangeError('"length" is outside of buffer bounds');let h;return i===void 0&&n===void 0?h=new Uint8Array(o):n===void 0?h=new Uint8Array(o,i):h=new Uint8Array(o,i,n),Object.setPrototypeOf(h,a.prototype),h}function S(o){if(a.isBuffer(o)){const i=E(o.length)|0,n=f(i);return n.length===0||o.copy(n,0,0,i),n}if(o.length!==void 0)return typeof o.length!="number"||dt(o.length)?f(0):v(o);if(o.type==="Buffer"&&Array.isArray(o.data))return v(o.data)}function E(o){if(o>=r)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+r.toString(16)+" bytes");return o|0}function T(o){return+o!=o&&(o=0),a.alloc(+o)}a.isBuffer=function(i){return i!=null&&i._isBuffer===!0&&i!==a.prototype},a.compare=function(i,n){if(Y(i,Uint8Array)&&(i=a.from(i,i.offset,i.byteLength)),Y(n,Uint8Array)&&(n=a.from(n,n.offset,n.byteLength)),!a.isBuffer(i)||!a.isBuffer(n))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(i===n)return 0;let h=i.length,p=n.length;for(let b=0,x=Math.min(h,p);b<x;++b)if(i[b]!==n[b]){h=i[b],p=n[b];break}return h<p?-1:p<h?1:0},a.isEncoding=function(i){switch(String(i).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},a.concat=function(i,n){if(!Array.isArray(i))throw new TypeError('"list" argument must be an Array of Buffers');if(i.length===0)return a.alloc(0);let h;if(n===void 0)for(n=0,h=0;h<i.length;++h)n+=i[h].length;const p=a.allocUnsafe(n);let b=0;for(h=0;h<i.length;++h){let x=i[h];if(Y(x,Uint8Array))b+x.length>p.length?(a.isBuffer(x)||(x=a.from(x)),x.copy(p,b)):Uint8Array.prototype.set.call(p,x,b);else if(a.isBuffer(x))x.copy(p,b);else throw new TypeError('"list" argument must be an Array of Buffers');b+=x.length}return p};function R(o,i){if(a.isBuffer(o))return o.length;if(ArrayBuffer.isView(o)||Y(o,ArrayBuffer))return o.byteLength;if(typeof o!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof o);const n=o.length,h=arguments.length>2&&arguments[2]===!0;if(!h&&n===0)return 0;let p=!1;for(;;)switch(i){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":return j(o).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return n*2;case"hex":return n>>>1;case"base64":return et(o).length;default:if(p)return h?-1:j(o).length;i=(""+i).toLowerCase(),p=!0}}a.byteLength=R;function I(o,i,n){let h=!1;if((i===void 0||i<0)&&(i=0),i>this.length||((n===void 0||n>this.length)&&(n=this.length),n<=0)||(n>>>=0,i>>>=0,n<=i))return"";for(o||(o="utf8");;)switch(o){case"hex":return mt(this,i,n);case"utf8":case"utf-8":return W(this,i,n);case"ascii":return st(this,i,n);case"latin1":case"binary":return at(this,i,n);case"base64":return L(this,i,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Ut(this,i,n);default:if(h)throw new TypeError("Unknown encoding: "+o);o=(o+"").toLowerCase(),h=!0}}a.prototype._isBuffer=!0;function A(o,i,n){const h=o[i];o[i]=o[n],o[n]=h}a.prototype.swap16=function(){const i=this.length;if(i%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let n=0;n<i;n+=2)A(this,n,n+1);return this},a.prototype.swap32=function(){const i=this.length;if(i%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let n=0;n<i;n+=4)A(this,n,n+3),A(this,n+1,n+2);return this},a.prototype.swap64=function(){const i=this.length;if(i%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let n=0;n<i;n+=8)A(this,n,n+7),A(this,n+1,n+6),A(this,n+2,n+5),A(this,n+3,n+4);return this},a.prototype.toString=function(){const i=this.length;return i===0?"":arguments.length===0?W(this,0,i):I.apply(this,arguments)},a.prototype.toLocaleString=a.prototype.toString,a.prototype.equals=function(i){if(!a.isBuffer(i))throw new TypeError("Argument must be a Buffer");return this===i?!0:a.compare(this,i)===0},a.prototype.inspect=function(){let i="";const n=c.INSPECT_MAX_BYTES;return i=this.toString("hex",0,n).replace(/(.{2})/g,"$1 ").trim(),this.length>n&&(i+=" ... "),"<Buffer "+i+">"},s&&(a.prototype[s]=a.prototype.inspect),a.prototype.compare=function(i,n,h,p,b){if(Y(i,Uint8Array)&&(i=a.from(i,i.offset,i.byteLength)),!a.isBuffer(i))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof i);if(n===void 0&&(n=0),h===void 0&&(h=i?i.length:0),p===void 0&&(p=0),b===void 0&&(b=this.length),n<0||h>i.length||p<0||b>this.length)throw new RangeError("out of range index");if(p>=b&&n>=h)return 0;if(p>=b)return-1;if(n>=h)return 1;if(n>>>=0,h>>>=0,p>>>=0,b>>>=0,this===i)return 0;let x=b-p,P=h-n;const K=Math.min(x,P),H=this.slice(p,b),V=i.slice(n,h);for(let $=0;$<K;++$)if(H[$]!==V[$]){x=H[$],P=V[$];break}return x<P?-1:P<x?1:0};function C(o,i,n,h,p){if(o.length===0)return-1;if(typeof n=="string"?(h=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,dt(n)&&(n=p?0:o.length-1),n<0&&(n=o.length+n),n>=o.length){if(p)return-1;n=o.length-1}else if(n<0)if(p)n=0;else return-1;if(typeof i=="string"&&(i=a.from(i,h)),a.isBuffer(i))return i.length===0?-1:O(o,i,n,h,p);if(typeof i=="number")return i=i&255,typeof Uint8Array.prototype.indexOf=="function"?p?Uint8Array.prototype.indexOf.call(o,i,n):Uint8Array.prototype.lastIndexOf.call(o,i,n):O(o,[i],n,h,p);throw new TypeError("val must be string, number or Buffer")}function O(o,i,n,h,p){let b=1,x=o.length,P=i.length;if(h!==void 0&&(h=String(h).toLowerCase(),h==="ucs2"||h==="ucs-2"||h==="utf16le"||h==="utf-16le")){if(o.length<2||i.length<2)return-1;b=2,x/=2,P/=2,n/=2}function K(V,$){return b===1?V[$]:V.readUInt16BE($*b)}let H;if(p){let V=-1;for(H=n;H<x;H++)if(K(o,H)===K(i,V===-1?0:H-V)){if(V===-1&&(V=H),H-V+1===P)return V*b}else V!==-1&&(H-=H-V),V=-1}else for(n+P>x&&(n=x-P),H=n;H>=0;H--){let V=!0;for(let $=0;$<P;$++)if(K(o,H+$)!==K(i,$)){V=!1;break}if(V)return H}return-1}a.prototype.includes=function(i,n,h){return this.indexOf(i,n,h)!==-1},a.prototype.indexOf=function(i,n,h){return C(this,i,n,h,!0)},a.prototype.lastIndexOf=function(i,n,h){return C(this,i,n,h,!1)};function G(o,i,n,h){n=Number(n)||0;const p=o.length-n;h?(h=Number(h),h>p&&(h=p)):h=p;const b=i.length;h>b/2&&(h=b/2);let x;for(x=0;x<h;++x){const P=parseInt(i.substr(x*2,2),16);if(dt(P))return x;o[n+x]=P}return x}function F(o,i,n,h){return rt(j(i,o.length-n),o,n,h)}function ut(o,i,n,h){return rt(Z(i),o,n,h)}function _(o,i,n,h){return rt(et(i),o,n,h)}function k(o,i,n,h){return rt(Q(i,o.length-n),o,n,h)}a.prototype.write=function(i,n,h,p){if(n===void 0)p="utf8",h=this.length,n=0;else if(h===void 0&&typeof n=="string")p=n,h=this.length,n=0;else if(isFinite(n))n=n>>>0,isFinite(h)?(h=h>>>0,p===void 0&&(p="utf8")):(p=h,h=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const b=this.length-n;if((h===void 0||h>b)&&(h=b),i.length>0&&(h<0||n<0)||n>this.length)throw new RangeError("Attempt to write outside buffer bounds");p||(p="utf8");let x=!1;for(;;)switch(p){case"hex":return G(this,i,n,h);case"utf8":case"utf-8":return F(this,i,n,h);case"ascii":case"latin1":case"binary":return ut(this,i,n,h);case"base64":return _(this,i,n,h);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return k(this,i,n,h);default:if(x)throw new TypeError("Unknown encoding: "+p);p=(""+p).toLowerCase(),x=!0}},a.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function L(o,i,n){return i===0&&n===o.length?t.fromByteArray(o):t.fromByteArray(o.slice(i,n))}function W(o,i,n){n=Math.min(o.length,n);const h=[];let p=i;for(;p<n;){const b=o[p];let x=null,P=b>239?4:b>223?3:b>191?2:1;if(p+P<=n){let K,H,V,$;switch(P){case 1:b<128&&(x=b);break;case 2:K=o[p+1],(K&192)===128&&($=(b&31)<<6|K&63,$>127&&(x=$));break;case 3:K=o[p+1],H=o[p+2],(K&192)===128&&(H&192)===128&&($=(b&15)<<12|(K&63)<<6|H&63,$>2047&&($<55296||$>57343)&&(x=$));break;case 4:K=o[p+1],H=o[p+2],V=o[p+3],(K&192)===128&&(H&192)===128&&(V&192)===128&&($=(b&15)<<18|(K&63)<<12|(H&63)<<6|V&63,$>65535&&$<1114112&&(x=$))}}x===null?(x=65533,P=1):x>65535&&(x-=65536,h.push(x>>>10&1023|55296),x=56320|x&1023),h.push(x),p+=P}return tt(h)}const B=4096;function tt(o){const i=o.length;if(i<=B)return String.fromCharCode.apply(String,o);let n="",h=0;for(;h<i;)n+=String.fromCharCode.apply(String,o.slice(h,h+=B));return n}function st(o,i,n){let h="";n=Math.min(o.length,n);for(let p=i;p<n;++p)h+=String.fromCharCode(o[p]&127);return h}function at(o,i,n){let h="";n=Math.min(o.length,n);for(let p=i;p<n;++p)h+=String.fromCharCode(o[p]);return h}function mt(o,i,n){const h=o.length;(!i||i<0)&&(i=0),(!n||n<0||n>h)&&(n=h);let p="";for(let b=i;b<n;++b)p+=xt[o[b]];return p}function Ut(o,i,n){const h=o.slice(i,n);let p="";for(let b=0;b<h.length-1;b+=2)p+=String.fromCharCode(h[b]+h[b+1]*256);return p}a.prototype.slice=function(i,n){const h=this.length;i=~~i,n=n===void 0?h:~~n,i<0?(i+=h,i<0&&(i=0)):i>h&&(i=h),n<0?(n+=h,n<0&&(n=0)):n>h&&(n=h),n<i&&(n=i);const p=this.subarray(i,n);return Object.setPrototypeOf(p,a.prototype),p};function z(o,i,n){if(o%1!==0||o<0)throw new RangeError("offset is not uint");if(o+i>n)throw new RangeError("Trying to access beyond buffer length")}a.prototype.readUintLE=a.prototype.readUIntLE=function(i,n,h){i=i>>>0,n=n>>>0,h||z(i,n,this.length);let p=this[i],b=1,x=0;for(;++x<n&&(b*=256);)p+=this[i+x]*b;return p},a.prototype.readUintBE=a.prototype.readUIntBE=function(i,n,h){i=i>>>0,n=n>>>0,h||z(i,n,this.length);let p=this[i+--n],b=1;for(;n>0&&(b*=256);)p+=this[i+--n]*b;return p},a.prototype.readUint8=a.prototype.readUInt8=function(i,n){return i=i>>>0,n||z(i,1,this.length),this[i]},a.prototype.readUint16LE=a.prototype.readUInt16LE=function(i,n){return i=i>>>0,n||z(i,2,this.length),this[i]|this[i+1]<<8},a.prototype.readUint16BE=a.prototype.readUInt16BE=function(i,n){return i=i>>>0,n||z(i,2,this.length),this[i]<<8|this[i+1]},a.prototype.readUint32LE=a.prototype.readUInt32LE=function(i,n){return i=i>>>0,n||z(i,4,this.length),(this[i]|this[i+1]<<8|this[i+2]<<16)+this[i+3]*16777216},a.prototype.readUint32BE=a.prototype.readUInt32BE=function(i,n){return i=i>>>0,n||z(i,4,this.length),this[i]*16777216+(this[i+1]<<16|this[i+2]<<8|this[i+3])},a.prototype.readBigUInt64LE=ht(function(i){i=i>>>0,wt(i,"offset");const n=this[i],h=this[i+7];(n===void 0||h===void 0)&&vt(i,this.length-8);const p=n+this[++i]*2**8+this[++i]*2**16+this[++i]*2**24,b=this[++i]+this[++i]*2**8+this[++i]*2**16+h*2**24;return BigInt(p)+(BigInt(b)<<BigInt(32))}),a.prototype.readBigUInt64BE=ht(function(i){i=i>>>0,wt(i,"offset");const n=this[i],h=this[i+7];(n===void 0||h===void 0)&&vt(i,this.length-8);const p=n*2**24+this[++i]*2**16+this[++i]*2**8+this[++i],b=this[++i]*2**24+this[++i]*2**16+this[++i]*2**8+h;return(BigInt(p)<<BigInt(32))+BigInt(b)}),a.prototype.readIntLE=function(i,n,h){i=i>>>0,n=n>>>0,h||z(i,n,this.length);let p=this[i],b=1,x=0;for(;++x<n&&(b*=256);)p+=this[i+x]*b;return b*=128,p>=b&&(p-=Math.pow(2,8*n)),p},a.prototype.readIntBE=function(i,n,h){i=i>>>0,n=n>>>0,h||z(i,n,this.length);let p=n,b=1,x=this[i+--p];for(;p>0&&(b*=256);)x+=this[i+--p]*b;return b*=128,x>=b&&(x-=Math.pow(2,8*n)),x},a.prototype.readInt8=function(i,n){return i=i>>>0,n||z(i,1,this.length),this[i]&128?(255-this[i]+1)*-1:this[i]},a.prototype.readInt16LE=function(i,n){i=i>>>0,n||z(i,2,this.length);const h=this[i]|this[i+1]<<8;return h&32768?h|4294901760:h},a.prototype.readInt16BE=function(i,n){i=i>>>0,n||z(i,2,this.length);const h=this[i+1]|this[i]<<8;return h&32768?h|4294901760:h},a.prototype.readInt32LE=function(i,n){return i=i>>>0,n||z(i,4,this.length),this[i]|this[i+1]<<8|this[i+2]<<16|this[i+3]<<24},a.prototype.readInt32BE=function(i,n){return i=i>>>0,n||z(i,4,this.length),this[i]<<24|this[i+1]<<16|this[i+2]<<8|this[i+3]},a.prototype.readBigInt64LE=ht(function(i){i=i>>>0,wt(i,"offset");const n=this[i],h=this[i+7];(n===void 0||h===void 0)&&vt(i,this.length-8);const p=this[i+4]+this[i+5]*2**8+this[i+6]*2**16+(h<<24);return(BigInt(p)<<BigInt(32))+BigInt(n+this[++i]*2**8+this[++i]*2**16+this[++i]*2**24)}),a.prototype.readBigInt64BE=ht(function(i){i=i>>>0,wt(i,"offset");const n=this[i],h=this[i+7];(n===void 0||h===void 0)&&vt(i,this.length-8);const p=(n<<24)+this[++i]*2**16+this[++i]*2**8+this[++i];return(BigInt(p)<<BigInt(32))+BigInt(this[++i]*2**24+this[++i]*2**16+this[++i]*2**8+h)}),a.prototype.readFloatLE=function(i,n){return i=i>>>0,n||z(i,4,this.length),e.read(this,i,!0,23,4)},a.prototype.readFloatBE=function(i,n){return i=i>>>0,n||z(i,4,this.length),e.read(this,i,!1,23,4)},a.prototype.readDoubleLE=function(i,n){return i=i>>>0,n||z(i,8,this.length),e.read(this,i,!0,52,8)},a.prototype.readDoubleBE=function(i,n){return i=i>>>0,n||z(i,8,this.length),e.read(this,i,!1,52,8)};function J(o,i,n,h,p,b){if(!a.isBuffer(o))throw new TypeError('"buffer" argument must be a Buffer instance');if(i>p||i<b)throw new RangeError('"value" argument is out of bounds');if(n+h>o.length)throw new RangeError("Index out of range")}a.prototype.writeUintLE=a.prototype.writeUIntLE=function(i,n,h,p){if(i=+i,n=n>>>0,h=h>>>0,!p){const P=Math.pow(2,8*h)-1;J(this,i,n,h,P,0)}let b=1,x=0;for(this[n]=i&255;++x<h&&(b*=256);)this[n+x]=i/b&255;return n+h},a.prototype.writeUintBE=a.prototype.writeUIntBE=function(i,n,h,p){if(i=+i,n=n>>>0,h=h>>>0,!p){const P=Math.pow(2,8*h)-1;J(this,i,n,h,P,0)}let b=h-1,x=1;for(this[n+b]=i&255;--b>=0&&(x*=256);)this[n+b]=i/x&255;return n+h},a.prototype.writeUint8=a.prototype.writeUInt8=function(i,n,h){return i=+i,n=n>>>0,h||J(this,i,n,1,255,0),this[n]=i&255,n+1},a.prototype.writeUint16LE=a.prototype.writeUInt16LE=function(i,n,h){return i=+i,n=n>>>0,h||J(this,i,n,2,65535,0),this[n]=i&255,this[n+1]=i>>>8,n+2},a.prototype.writeUint16BE=a.prototype.writeUInt16BE=function(i,n,h){return i=+i,n=n>>>0,h||J(this,i,n,2,65535,0),this[n]=i>>>8,this[n+1]=i&255,n+2},a.prototype.writeUint32LE=a.prototype.writeUInt32LE=function(i,n,h){return i=+i,n=n>>>0,h||J(this,i,n,4,4294967295,0),this[n+3]=i>>>24,this[n+2]=i>>>16,this[n+1]=i>>>8,this[n]=i&255,n+4},a.prototype.writeUint32BE=a.prototype.writeUInt32BE=function(i,n,h){return i=+i,n=n>>>0,h||J(this,i,n,4,4294967295,0),this[n]=i>>>24,this[n+1]=i>>>16,this[n+2]=i>>>8,this[n+3]=i&255,n+4};function kt(o,i,n,h,p){Nt(i,h,p,o,n,7);let b=Number(i&BigInt(4294967295));o[n++]=b,b=b>>8,o[n++]=b,b=b>>8,o[n++]=b,b=b>>8,o[n++]=b;let x=Number(i>>BigInt(32)&BigInt(4294967295));return o[n++]=x,x=x>>8,o[n++]=x,x=x>>8,o[n++]=x,x=x>>8,o[n++]=x,n}function gt(o,i,n,h,p){Nt(i,h,p,o,n,7);let b=Number(i&BigInt(4294967295));o[n+7]=b,b=b>>8,o[n+6]=b,b=b>>8,o[n+5]=b,b=b>>8,o[n+4]=b;let x=Number(i>>BigInt(32)&BigInt(4294967295));return o[n+3]=x,x=x>>8,o[n+2]=x,x=x>>8,o[n+1]=x,x=x>>8,o[n]=x,n+8}a.prototype.writeBigUInt64LE=ht(function(i,n=0){return kt(this,i,n,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeBigUInt64BE=ht(function(i,n=0){return gt(this,i,n,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeIntLE=function(i,n,h,p){if(i=+i,n=n>>>0,!p){const K=Math.pow(2,8*h-1);J(this,i,n,h,K-1,-K)}let b=0,x=1,P=0;for(this[n]=i&255;++b<h&&(x*=256);)i<0&&P===0&&this[n+b-1]!==0&&(P=1),this[n+b]=(i/x>>0)-P&255;return n+h},a.prototype.writeIntBE=function(i,n,h,p){if(i=+i,n=n>>>0,!p){const K=Math.pow(2,8*h-1);J(this,i,n,h,K-1,-K)}let b=h-1,x=1,P=0;for(this[n+b]=i&255;--b>=0&&(x*=256);)i<0&&P===0&&this[n+b+1]!==0&&(P=1),this[n+b]=(i/x>>0)-P&255;return n+h},a.prototype.writeInt8=function(i,n,h){return i=+i,n=n>>>0,h||J(this,i,n,1,127,-128),i<0&&(i=255+i+1),this[n]=i&255,n+1},a.prototype.writeInt16LE=function(i,n,h){return i=+i,n=n>>>0,h||J(this,i,n,2,32767,-32768),this[n]=i&255,this[n+1]=i>>>8,n+2},a.prototype.writeInt16BE=function(i,n,h){return i=+i,n=n>>>0,h||J(this,i,n,2,32767,-32768),this[n]=i>>>8,this[n+1]=i&255,n+2},a.prototype.writeInt32LE=function(i,n,h){return i=+i,n=n>>>0,h||J(this,i,n,4,2147483647,-2147483648),this[n]=i&255,this[n+1]=i>>>8,this[n+2]=i>>>16,this[n+3]=i>>>24,n+4},a.prototype.writeInt32BE=function(i,n,h){return i=+i,n=n>>>0,h||J(this,i,n,4,2147483647,-2147483648),i<0&&(i=4294967295+i+1),this[n]=i>>>24,this[n+1]=i>>>16,this[n+2]=i>>>8,this[n+3]=i&255,n+4},a.prototype.writeBigInt64LE=ht(function(i,n=0){return kt(this,i,n,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),a.prototype.writeBigInt64BE=ht(function(i,n=0){return gt(this,i,n,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function bt(o,i,n,h,p,b){if(n+h>o.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function Mt(o,i,n,h,p){return i=+i,n=n>>>0,p||bt(o,i,n,4),e.write(o,i,n,h,23,4),n+4}a.prototype.writeFloatLE=function(i,n,h){return Mt(this,i,n,!0,h)},a.prototype.writeFloatBE=function(i,n,h){return Mt(this,i,n,!1,h)};function At(o,i,n,h,p){return i=+i,n=n>>>0,p||bt(o,i,n,8),e.write(o,i,n,h,52,8),n+8}a.prototype.writeDoubleLE=function(i,n,h){return At(this,i,n,!0,h)},a.prototype.writeDoubleBE=function(i,n,h){return At(this,i,n,!1,h)},a.prototype.copy=function(i,n,h,p){if(!a.isBuffer(i))throw new TypeError("argument should be a Buffer");if(h||(h=0),!p&&p!==0&&(p=this.length),n>=i.length&&(n=i.length),n||(n=0),p>0&&p<h&&(p=h),p===h||i.length===0||this.length===0)return 0;if(n<0)throw new RangeError("targetStart out of bounds");if(h<0||h>=this.length)throw new RangeError("Index out of range");if(p<0)throw new RangeError("sourceEnd out of bounds");p>this.length&&(p=this.length),i.length-n<p-h&&(p=i.length-n+h);const b=p-h;return this===i&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(n,h,p):Uint8Array.prototype.set.call(i,this.subarray(h,p),n),b},a.prototype.fill=function(i,n,h,p){if(typeof i=="string"){if(typeof n=="string"?(p=n,n=0,h=this.length):typeof h=="string"&&(p=h,h=this.length),p!==void 0&&typeof p!="string")throw new TypeError("encoding must be a string");if(typeof p=="string"&&!a.isEncoding(p))throw new TypeError("Unknown encoding: "+p);if(i.length===1){const x=i.charCodeAt(0);(p==="utf8"&&x<128||p==="latin1")&&(i=x)}}else typeof i=="number"?i=i&255:typeof i=="boolean"&&(i=Number(i));if(n<0||this.length<n||this.length<h)throw new RangeError("Out of range index");if(h<=n)return this;n=n>>>0,h=h===void 0?this.length:h>>>0,i||(i=0);let b;if(typeof i=="number")for(b=n;b<h;++b)this[b]=i;else{const x=a.isBuffer(i)?i:a.from(i,p),P=x.length;if(P===0)throw new TypeError('The value "'+i+'" is invalid for argument "value"');for(b=0;b<h-n;++b)this[b+n]=x[b%P]}return this};const pt={};function St(o,i,n){pt[o]=class extends n{constructor(){super(),Object.defineProperty(this,"message",{value:i.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${o}]`,this.stack,delete this.name}get code(){return o}set code(p){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:p,writable:!0})}toString(){return`${this.name} [${o}]: ${this.message}`}}}St("ERR_BUFFER_OUT_OF_BOUNDS",function(o){return o?`${o} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),St("ERR_INVALID_ARG_TYPE",function(o,i){return`The "${o}" argument must be of type number. Received type ${typeof i}`},TypeError),St("ERR_OUT_OF_RANGE",function(o,i,n){let h=`The value of "${o}" is out of range.`,p=n;return Number.isInteger(n)&&Math.abs(n)>2**32?p=Ft(String(n)):typeof n=="bigint"&&(p=String(n),(n>BigInt(2)**BigInt(32)||n<-(BigInt(2)**BigInt(32)))&&(p=Ft(p)),p+="n"),h+=` It must be ${i}. Received ${p}`,h},RangeError);function Ft(o){let i="",n=o.length;const h=o[0]==="-"?1:0;for(;n>=h+4;n-=3)i=`_${o.slice(n-3,n)}${i}`;return`${o.slice(0,n)}${i}`}function Tt(o,i,n){wt(i,"offset"),(o[i]===void 0||o[i+n]===void 0)&&vt(i,o.length-(n+1))}function Nt(o,i,n,h,p,b){if(o>n||o<i){const x=typeof i=="bigint"?"n":"";let P;throw i===0||i===BigInt(0)?P=`>= 0${x} and < 2${x} ** ${(b+1)*8}${x}`:P=`>= -(2${x} ** ${(b+1)*8-1}${x}) and < 2 ** ${(b+1)*8-1}${x}`,new pt.ERR_OUT_OF_RANGE("value",P,o)}Tt(h,p,b)}function wt(o,i){if(typeof o!="number")throw new pt.ERR_INVALID_ARG_TYPE(i,"number",o)}function vt(o,i,n){throw Math.floor(o)!==o?(wt(o,n),new pt.ERR_OUT_OF_RANGE("offset","an integer",o)):i<0?new pt.ERR_BUFFER_OUT_OF_BOUNDS:new pt.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${i}`,o)}const N=/[^+/0-9A-Za-z-_]/g;function X(o){if(o=o.split("=")[0],o=o.trim().replace(N,""),o.length<2)return"";for(;o.length%4!==0;)o=o+"=";return o}function j(o,i){i=i||1/0;let n;const h=o.length;let p=null;const b=[];for(let x=0;x<h;++x){if(n=o.charCodeAt(x),n>55295&&n<57344){if(!p){if(n>56319){(i-=3)>-1&&b.push(239,191,189);continue}else if(x+1===h){(i-=3)>-1&&b.push(239,191,189);continue}p=n;continue}if(n<56320){(i-=3)>-1&&b.push(239,191,189),p=n;continue}n=(p-55296<<10|n-56320)+65536}else p&&(i-=3)>-1&&b.push(239,191,189);if(p=null,n<128){if((i-=1)<0)break;b.push(n)}else if(n<2048){if((i-=2)<0)break;b.push(n>>6|192,n&63|128)}else if(n<65536){if((i-=3)<0)break;b.push(n>>12|224,n>>6&63|128,n&63|128)}else if(n<1114112){if((i-=4)<0)break;b.push(n>>18|240,n>>12&63|128,n>>6&63|128,n&63|128)}else throw new Error("Invalid code point")}return b}function Z(o){const i=[];for(let n=0;n<o.length;++n)i.push(o.charCodeAt(n)&255);return i}function Q(o,i){let n,h,p;const b=[];for(let x=0;x<o.length&&!((i-=2)<0);++x)n=o.charCodeAt(x),h=n>>8,p=n%256,b.push(p),b.push(h);return b}function et(o){return t.toByteArray(X(o))}function rt(o,i,n,h){let p;for(p=0;p<h&&!(p+n>=i.length||p>=o.length);++p)i[p+n]=o[p];return p}function Y(o,i){return o instanceof i||o!=null&&o.constructor!=null&&o.constructor.name!=null&&o.constructor.name===i.name}function dt(o){return o!==o}const xt=function(){const o="0123456789abcdef",i=new Array(256);for(let n=0;n<16;++n){const h=n*16;for(let p=0;p<16;++p)i[h+p]=o[n]+o[p]}return i}();function ht(o){return typeof BigInt>"u"?$t:o}function $t(){throw new Error("BigInt not supported")}})(fe);function xi(c){if(typeof c!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!c)throw new Error("No input");const t=JSON.parse(c),e=t;let s;if(e.type==="system")if(e.event==="connected")s=Object.assign(Object.assign({},t),{kind:"connected"});else if(e.event==="disconnected")s=Object.assign(Object.assign({},t),{kind:"disconnected"});else return null;else if(e.type==="message")if(e.from==="group"){const r=_e(t.data,t.dataType);if(r===null)return null;s=Object.assign(Object.assign({},t),{data:r,kind:"groupData"})}else if(e.from==="server"){const r=_e(t.data,t.dataType);if(r===null)return null;s=Object.assign(Object.assign({},t),{data:r,kind:"serverData"})}else return null;else if(e.type==="ack")s=Object.assign(Object.assign({},t),{kind:"ack"});else return null;return s}function Mi(c){let t;switch(c.kind){case"joinGroup":{t={type:"joinGroup",group:c.group,ackId:c.ackId};break}case"leaveGroup":{t={type:"leaveGroup",group:c.group,ackId:c.ackId};break}case"sendEvent":{t={type:"event",event:c.event,ackId:c.ackId,dataType:c.dataType,data:Te(c.data,c.dataType)};break}case"sendToGroup":{t={type:"sendToGroup",group:c.group,ackId:c.ackId,dataType:c.dataType,data:Te(c.data,c.dataType),noEcho:c.noEcho};break}case"sequenceAck":{t={type:"sequenceAck",sequenceId:c.sequenceId};break}default:throw new Error(`Unsupported type: ${c.kind}`)}return JSON.stringify(t)}function Te(c,t){switch(t){case"text":{if(typeof c!="string")throw new TypeError("Message must be a string.");return c}case"json":return c;case"binary":case"protobuf":{if(c instanceof ArrayBuffer)return fe.Buffer.from(c).toString("base64");throw new TypeError("Message must be a ArrayBuffer")}}}function _e(c,t){if(t==="text"){if(typeof c!="string")throw new TypeError("Message must be a string when dataType is text");return c}else{if(t==="json")return c;if(t==="binary"||t==="protobuf"){const e=fe.Buffer.from(c,"base64");return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}else return null}}class Si{constructor(){this.isReliableSubProtocol=!0,this.name="json.reliable.webpubsub.azure.v1"}parseMessages(t){return xi(t)}writeMessage(t){return Mi(t)}}const Ti=()=>new Si;class _i{constructor(t,e){this._socket=new WebSocket(t,e),this._socket.binaryType="arraybuffer"}onopen(t){this._socket.onopen=t}onclose(t){this._socket.onclose=e=>t(e.code,e.reason)}onerror(t){this._socket.onerror=e=>t(e)}onmessage(t){this._socket.onmessage=e=>t(e.data)}close(t,e){this._socket.close(t,e)}send(t,e){return new Promise((s,r)=>{try{this._socket.send(t),s()}catch(l){r(l)}})}isOpen(){return this._socket.readyState===WebSocket.OPEN}}class Ei{create(t,e){return new _i(t,e)}}async function Ri(c,t){if(t.aborted)throw new ee("The operation was aborted.");let e;const s=new Promise((r,l)=>{e=()=>{l(new ee("The operation was aborted."))},t.addEventListener("abort",e)});try{return await Promise.race([c,s])}finally{t.removeEventListener("abort",e)}}var ot;(function(c){c.Stopped="Stopped",c.Disconnected="Disconnected",c.Connecting="Connecting",c.Connected="Connected",c.Recovering="Recovering"})(ot||(ot={}));class Ii{nextAckId(){return this._ackId=this._ackId+1,this._ackId}constructor(t,e){this._quickSequenceAckDiff=300,this._activeTimeoutInMs=2e4,this._emitter=new oi,this._isStopping=!1,this._isInitialConnected=!1,typeof t=="string"?this._credential={getClientAccessUrl:t}:this._credential=t,e==null&&(e={}),this._buildDefaultOptions(e),this._options=e,this._messageRetryPolicy=new Ee(this._options.messageRetryOptions),this._reconnectRetryPolicy=new Ee(this._options.reconnectRetryOptions),this._protocol=this._options.protocol,this._groupMap=new Map,this._ackMap=new Map,this._sequenceId=new Pi,this._state=ot.Stopped,this._ackId=0}async start(t){if(this._isStopping)throw new Error("Can't start a client during stopping");if(this._state!==ot.Stopped)throw new Error("Client can be only started when it's Stopped");let e;t&&(e=t.abortSignal),this._activeKeepaliveTask||(this._activeKeepaliveTask=this._getActiveKeepaliveTask());try{await this._startCore(e)}catch(s){throw this._changeState(ot.Stopped),this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0),this._isStopping=!1,s}}async _startFromRestarting(t){if(this._state!==ot.Disconnected)throw new Error("Client can be only restarted when it's Disconnected");try{nt.verbose("Staring reconnecting."),await this._startCore(t)}catch(e){throw this._changeState(ot.Disconnected),e}}async _startCore(t){if(this._changeState(ot.Connecting),nt.info("Staring a new connection"),this._sequenceId.reset(),this._isInitialConnected=!1,this._lastCloseEvent=void 0,this._lastDisconnectedMessage=void 0,this._connectionId=void 0,this._reconnectionToken=void 0,this._uri=void 0,typeof this._credential.getClientAccessUrl=="string"?this._uri=this._credential.getClientAccessUrl:this._uri=await this._credential.getClientAccessUrl({abortSignal:t}),typeof this._uri!="string")throw new Error(`The clientAccessUrl must be a string but currently it's ${typeof this._uri}`);await this._connectCore(this._uri)}stop(){this._state===ot.Stopped||this._isStopping||(this._isStopping=!0,this._wsClient&&this._wsClient.isOpen()?this._wsClient.close():this._isStopping=!1,this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0))}on(t,e){this._emitter.on(t,e)}off(t,e){this._emitter.removeListener(t,e)}_emitEvent(t,e){this._emitter.emit(t,e)}async sendEvent(t,e,s,r){return this._operationExecuteWithRetry(()=>this._sendEventAttempt(t,e,s,r),r==null?void 0:r.abortSignal)}async _sendEventAttempt(t,e,s,r){var l;if(!((l=r==null?void 0:r.fireAndForget)!==null&&l!==void 0?l:!1))return this._sendMessageWithAckId(y=>({kind:"sendEvent",dataType:s,data:e,ackId:y,event:t}),r==null?void 0:r.ackId,r==null?void 0:r.abortSignal);const a={kind:"sendEvent",dataType:s,data:e,event:t};return await this._sendMessage(a,r==null?void 0:r.abortSignal),{isDuplicated:!1}}async joinGroup(t,e){return this._operationExecuteWithRetry(()=>this._joinGroupAttempt(t,e),e==null?void 0:e.abortSignal)}async _joinGroupAttempt(t,e){const s=this._getOrAddGroup(t),r=await this._joinGroupCore(t,e);return s.isJoined=!0,r}async _joinGroupCore(t,e){return this._sendMessageWithAckId(s=>({group:t,ackId:s,kind:"joinGroup"}),e==null?void 0:e.ackId,e==null?void 0:e.abortSignal)}async leaveGroup(t,e){return this._operationExecuteWithRetry(()=>this._leaveGroupAttempt(t,e),e==null?void 0:e.abortSignal)}async _leaveGroupAttempt(t,e){const s=this._getOrAddGroup(t),r=await this._sendMessageWithAckId(l=>({group:t,ackId:l,kind:"leaveGroup"}),e==null?void 0:e.ackId,e==null?void 0:e.abortSignal);return s.isJoined=!1,r}async sendToGroup(t,e,s,r){return this._operationExecuteWithRetry(()=>this._sendToGroupAttempt(t,e,s,r),r==null?void 0:r.abortSignal)}async _sendToGroupAttempt(t,e,s,r){var l,f;const a=(l=r==null?void 0:r.fireAndForget)!==null&&l!==void 0?l:!1,y=(f=r==null?void 0:r.noEcho)!==null&&f!==void 0?f:!1;if(!a)return this._sendMessageWithAckId(m=>({kind:"sendToGroup",group:t,dataType:s,data:e,ackId:m,noEcho:y}),r==null?void 0:r.ackId,r==null?void 0:r.abortSignal);const d={kind:"sendToGroup",group:t,dataType:s,data:e,noEcho:y};return await this._sendMessage(d,r==null?void 0:r.abortSignal),{isDuplicated:!1}}_getWebSocketClientFactory(){return new Ei}async _trySendSequenceAck(){if(!this._protocol.isReliableSubProtocol)return;const[t,e]=this._sequenceId.tryGetSequenceId();if(t&&e!==null&&e!==void 0){const s={kind:"sequenceAck",sequenceId:e};try{await this._sendMessage(s)}catch{this._sequenceId.tryUpdate(e)}}}_connectCore(t){if(this._isStopping)throw new Error("Can't start a client during stopping");return new Promise((e,s)=>{const r=this._wsClient=this._getWebSocketClientFactory().create(t,this._protocol.name);r.onopen(()=>{if(this._isStopping){try{r.close()}catch{}s(new Error("The client is stopped"))}nt.verbose("WebSocket connection has opened"),this._changeState(ot.Connected),this._protocol.isReliableSubProtocol&&(this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),this._sequenceAckTask=new Re(async()=>{await this._trySendSequenceAck()},1e3)),e()}),r.onerror(l=>{this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),s(l)}),r.onclose((l,f)=>{this._state===ot.Connected?(nt.verbose("WebSocket closed after open"),this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),nt.info(`WebSocket connection closed. Code: ${l}, Reason: ${f}`),this._lastCloseEvent={code:l,reason:f},this._handleConnectionClose.call(this)):(nt.verbose("WebSocket closed before open"),s(new Error(`Failed to start WebSocket: ${l}`)))}),r.onmessage(l=>{const f=u=>{if(this._ackMap.has(u.ackId)){const v=this._ackMap.get(u.ackId);this._ackMap.delete(u.ackId);const M=u.error!=null&&u.error.name==="Duplicate";u.success||M?v.resolve({ackId:u.ackId,isDuplicated:M}):v.reject(new jt("Failed to send message.",{ackId:u.ackId,errorDetail:u.error}))}},a=async u=>{if(this._connectionId=u.connectionId,this._reconnectionToken=u.reconnectionToken,!this._isInitialConnected){if(this._isInitialConnected=!0,this._options.autoRejoinGroups){const v=[];this._groupMap.forEach(M=>{M.isJoined&&v.push((async()=>{try{await this._joinGroupCore(M.name)}catch(g){this._safeEmitRejoinGroupFailed(M.name,g)}})())}),await Promise.all(v).catch(()=>{})}this._safeEmitConnected(u.connectionId,u.userId)}},y=u=>{this._lastDisconnectedMessage=u},d=u=>{if(u.sequenceId!=null){const v=this._sequenceId.tryUpdate(u.sequenceId);if(v===0)return;v>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitGroupMessage(u)},m=u=>{if(u.sequenceId!=null){const v=this._sequenceId.tryUpdate(u.sequenceId);if(v===0)return;v>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitServerMessage(u)};let w;try{let u;if(Array.isArray(l)?u=Buffer.concat(l):u=l,w=this._protocol.parseMessages(u),w===null)return}catch(u){throw nt.warning("An error occurred while parsing the message from service",u),u}Array.isArray(w)||(w=[w]),w.forEach(u=>{try{switch(u.kind){case"ack":{f(u);break}case"connected":{a(u);break}case"disconnected":{y(u);break}case"groupData":{d(u);break}case"serverData":{m(u);break}}}catch(v){nt.warning(`An error occurred while handling the message with kind: ${u.kind} from service`,v)}})})})}async _handleConnectionCloseAndNoRecovery(){this._state=ot.Disconnected,this._safeEmitDisconnected(this._connectionId,this._lastDisconnectedMessage),this._options.autoReconnect?await this._autoReconnect():await this._handleConnectionStopped()}async _autoReconnect(){let t=!1,e=0;try{for(;!this._isStopping;)try{await this._startFromRestarting(),t=!0;break}catch(s){nt.warning("An attempt to reconnect connection failed.",s),e++;const r=this._reconnectRetryPolicy.nextRetryDelayInMs(e);if(r==null)break;nt.verbose(`Delay time for reconnect attempt ${e}: ${r}`),await Wt(r).catch(()=>{})}}finally{t||this._handleConnectionStopped()}}_handleConnectionStopped(){this._isStopping=!1,this._state=ot.Stopped,this._safeEmitStopped()}_getActiveKeepaliveTask(){return new Re(async()=>{this._sequenceId.tryUpdate(0)},this._activeTimeoutInMs)}async _sendMessage(t,e){if(!this._wsClient||!this._wsClient.isOpen())throw new Error("The connection is not connected.");const s=this._protocol.writeMessage(t);await this._wsClient.send(s,e)}async _sendMessageWithAckId(t,e,s){e==null&&(e=this.nextAckId());const r=t(e);this._ackMap.has(e)||this._ackMap.set(e,new Ai(e));const l=this._ackMap.get(e);try{await this._sendMessage(r,s)}catch(f){this._ackMap.delete(e);let a="";throw f instanceof Error&&(a=f.message),new jt(a,{ackId:e})}if(s)try{return await Ri(l.promise(),s)}catch(f){throw f instanceof Error&&f.name==="AbortError"?new jt("Cancelled by abortSignal",{ackId:e}):f}return l.promise()}async _handleConnectionClose(){if(this._ackMap.forEach((r,l)=>{this._ackMap.delete(l)&&r.reject(new jt("Connection is disconnected before receive ack from the service",{ackId:r.ackId}))}),this._isStopping){nt.warning("The client is stopping state. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(this._lastCloseEvent&&this._lastCloseEvent.code===1008){nt.warning("The websocket close with status code 1008. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(!this._protocol.isReliableSubProtocol){nt.warning("The protocol is not reliable, recovery is not applicable"),this._handleConnectionCloseAndNoRecovery();return}const t=this._buildRecoveryUri();if(!t){nt.warning("Connection id or reconnection token is not available"),this._handleConnectionCloseAndNoRecovery();return}let e=!1;this._state=ot.Recovering;const s=AbortSignal.timeout(30*1e3);try{for(;!s.aborted||this._isStopping;)try{await this._connectCore.call(this,t),e=!0;return}catch{await Wt(1e3)}}finally{e||(nt.warning("Recovery attempts failed more then 30 seconds or the client is stopping"),this._handleConnectionCloseAndNoRecovery())}}_safeEmitConnected(t,e){this._emitEvent("connected",{connectionId:t,userId:e})}_safeEmitDisconnected(t,e){this._emitEvent("disconnected",{connectionId:t,message:e})}_safeEmitGroupMessage(t){this._emitEvent("group-message",{message:t})}_safeEmitServerMessage(t){this._emitEvent("server-message",{message:t})}_safeEmitStopped(){this._emitEvent("stopped",{})}_safeEmitRejoinGroupFailed(t,e){this._emitEvent("rejoin-group-failed",{group:t,error:e})}_buildDefaultOptions(t){return t.autoReconnect==null&&(t.autoReconnect=!0),t.autoRejoinGroups==null&&(t.autoRejoinGroups=!0),t.protocol==null&&(t.protocol=Ti()),this._buildMessageRetryOptions(t),this._buildReconnectRetryOptions(t),t}_buildMessageRetryOptions(t){t.messageRetryOptions||(t.messageRetryOptions={}),(t.messageRetryOptions.maxRetries==null||t.messageRetryOptions.maxRetries<0)&&(t.messageRetryOptions.maxRetries=3),(t.messageRetryOptions.retryDelayInMs==null||t.messageRetryOptions.retryDelayInMs<0)&&(t.messageRetryOptions.retryDelayInMs=1e3),(t.messageRetryOptions.maxRetryDelayInMs==null||t.messageRetryOptions.maxRetryDelayInMs<0)&&(t.messageRetryOptions.maxRetryDelayInMs=3e4),t.messageRetryOptions.mode==null&&(t.messageRetryOptions.mode="Fixed")}_buildReconnectRetryOptions(t){t.reconnectRetryOptions||(t.reconnectRetryOptions={}),(t.reconnectRetryOptions.maxRetries==null||t.reconnectRetryOptions.maxRetries<0)&&(t.reconnectRetryOptions.maxRetries=Number.MAX_VALUE),(t.reconnectRetryOptions.retryDelayInMs==null||t.reconnectRetryOptions.retryDelayInMs<0)&&(t.reconnectRetryOptions.retryDelayInMs=1e3),(t.reconnectRetryOptions.maxRetryDelayInMs==null||t.reconnectRetryOptions.maxRetryDelayInMs<0)&&(t.reconnectRetryOptions.maxRetryDelayInMs=3e4),t.reconnectRetryOptions.mode==null&&(t.reconnectRetryOptions.mode="Fixed")}_buildRecoveryUri(){if(this._connectionId&&this._reconnectionToken&&this._uri){const t=new URL(this._uri);return t.searchParams.append("awps_connection_id",this._connectionId),t.searchParams.append("awps_reconnection_token",this._reconnectionToken),t.toString()}return null}_getOrAddGroup(t){return this._groupMap.has(t)||this._groupMap.set(t,new ki(t)),this._groupMap.get(t)}_changeState(t){nt.verbose(`The client state transfer from ${this._state.toString()} to ${t.toString()}`),this._state=t}async _operationExecuteWithRetry(t,e){let s=0;for(;;)try{return await t.call(this)}catch(r){s++;const l=this._messageRetryPolicy.nextRetryDelayInMs(s);if(l==null||(await Wt(l),e!=null&&e.aborted))throw r}}}class Ee{constructor(t){this._retryOptions=t,this._maxRetriesToGetMaxDelay=Math.ceil(Math.log2(this._retryOptions.maxRetryDelayInMs)-Math.log2(this._retryOptions.retryDelayInMs)+1)}nextRetryDelayInMs(t){return t>this._retryOptions.maxRetries?null:this._retryOptions.mode==="Fixed"?this._retryOptions.retryDelayInMs:this._calculateExponentialDelay(t)}_calculateExponentialDelay(t){return t>=this._maxRetriesToGetMaxDelay?this._retryOptions.maxRetryDelayInMs:(1<<t-1)*this._retryOptions.retryDelayInMs}}class ki{constructor(t){this.isJoined=!1,this.name=t}}class Ai{constructor(t){this._promise=new Promise((e,s)=>{this._resolve=e,this._reject=s}),this.ackId=t}promise(){return this._promise}resolve(t){this._resolve(t)}reject(t){this._reject(t)}}class Pi{constructor(){this._sequenceId=0,this._isUpdate=!1}tryUpdate(t){if(this._isUpdate=!0,t>this._sequenceId){const e=t-this._sequenceId;return this._sequenceId=t,e}return 0}tryGetSequenceId(){return this._isUpdate?(this._isUpdate=!1,[!0,this._sequenceId]):[!1,null]}reset(){this._sequenceId=0,this._isUpdate=!1}}class Re{constructor(t,e,s){this._func=t,this._abortController=new AbortController,this._interval=e,this._obj=s,this._start()}abort(){try{this._abortController.abort()}catch{}}async _start(){const t=this._abortController.signal;for(;!t.aborted;)try{await this._func(this._obj)}catch{}finally{await Wt(this._interval)}}}class Ie{constructor(t){this.negotiateUrl=t,this.client=null,this.group=null,this.connected=!1,this.onDisc=[],this.onErr=[],this.mode="azure",this.bc=null,this.lastError=null,this.onMsgHandler=null,this.id=Math.random().toString(36).slice(2,8)}async connect(t){this.group=`room_${t}`;try{const e=await fetch(this.negotiateUrl,{credentials:"include"});if(!e.ok){const l=await e.text().catch(()=>"");throw this.lastError=`negotiate ${e.status}: ${l==null?void 0:l.slice(0,180)}`,new Error(this.lastError)}const{url:s}=await e.json().catch(()=>({url:null}));if(!s)throw new Error("no url");const r=new Ii(s);this.client=r,this.mode="azure",r.on("connected",()=>{this.connected=!0}),r.on("disconnected",()=>{this.connected=!1,this.onDisc.forEach(l=>l())}),r.on("stopped",()=>{this.connected=!1,this.onDisc.forEach(l=>l())}),r.on("group-message",({message:l})=>{var f;try{(f=this.onMsgHandler)==null||f.call(this,JSON.parse(String(l.data)))}catch{}}),await r.start(),await r.joinGroup(this.group),this.connected=!0}catch(e){this.lastError=(e==null?void 0:e.message)||String(e);const s=typeof window<"u"&&window.location.hostname||"";if(!(s==="localhost"||s==="127.0.0.1"||s.endsWith(".local")))throw this.onErr.forEach(l=>l(e)),e;try{this.mode="local",this.bc=new BroadcastChannel(this.group),this.bc.onmessage=l=>{var a;const f=l.data;try{(a=this.onMsgHandler)==null||a.call(this,f)}catch{}},this.connected=!0,this.lastError=null}catch{throw this.onErr.forEach(f=>f(e)),e}}}onMessage(t){this.onMsgHandler=t}onDisconnected(t){this.onDisc.push(t)}onError(t){this.onErr.push(t)}async send(t){if(!(!this.client||!this.connected||!this.group))try{this.mode==="azure"?await this.client.sendToGroup(this.group,JSON.stringify(t),"text"):this.mode==="local"&&this.bc&&this.bc.postMessage(t)}catch(e){this.onErr.forEach(s=>s(e))}}close(){var t;try{(t=this.bc)==null||t.close()}catch{}}getTransport(){return this.mode}getLastError(){return this.lastError}}class re{constructor(t,e){this.p1=new Dt(80,140,26,26),this.p2=new Dt(120,220,26,26),this.obstacles=[],this.hud=new oe,this.s1=0,this.s2=0,this.speed=140,this.timeToNext=0,this.paused=!1,this.rt=null,this.bullets=[],this.enemyBullets=[],this.powerups=[],this.multishotUntil=0,this.bigshotUntil=0,this.slowmoUntil=0,this.magnetUntil=0,this.isTouch="ontouchstart"in window,this.mobileMoveX=0,this.shootingHeld=!1,this.touchShootHeld=!1,this.hintT=4,this.btnRects=null,this.btnLeftDown=!1,this.btnRightDown=!1,this.btnShootDown=!1,this.lefty=!1,this.lastLeftCornerTap=0,this.prevPadButtons=[],this.remoteHistory=[],this.sendAccum=0,this.toast=null,this.isLeader=!1,this.remoteId=null,this.reconnecting=!1,this.retries=0,this.unloadHandler=null,this.waiting=!0,this.bothReady=!1,this.gameStarted=!1,this.presenceAccum=0,this.myId=null,this.lastMsgAt=0,this.starting=!1,this.startAt=0,this.lastCountdownSecond=0,this.trailAccum=0,this.particles=new qt,this.remoteParticles=new qt,this.floaters=[],this.shakeT=0,this.shakeTotal=0,this.shakeAmp=0,this.queuedSpawns=[],this.queuedPowerSpawns=[],this.roomId=t,this.name=e}async init(t){this.renderer=new ae(t.canvas,t.ctx);const e="/api/negotiate";this.rt=new Ie(e);try{await this.rt.connect(this.roomId)}catch{this.toast={text:"Online: failed to connect",t:3};return}const s=this.rt.id;this.myId=s,this.rt.onMessage(d=>{if(this.lastMsgAt=performance.now(),d.type==="state"&&d.id!==s)this.remoteHistory.push({t:d.t,x:d.x,y:d.y,vy:d.vy,score:d.score,hp:d.hp,name:d.name}),this.remoteHistory.length>30&&this.remoteHistory.shift(),this.remoteName=d.name||this.remoteName;else if(d.type==="spawn"&&this.isLeader===!1){const m=t.canvas.height,w=d.w??80,u=t.canvas.width+w,v=d.topH,M=d.gap;this.speed=d.speed,this.waiting||this.starting||!this.gameStarted?this.queuedSpawns.push({x:u,topH:v,gap:M,speed:this.speed,w}):(this.obstacles.push(new ct(u,0,w,v,this.speed)),this.obstacles.push(new ct(u,v+M,w,m-(v+M),this.speed)))}else if(d.type==="join"&&d.id!==s)this.remoteId=d.id,this.remoteName=d.name,this.isLeader=s<d.id,this.toast={text:`${d.name||"Opponent"} joined`,t:2.5},this.bothReady=!0,this.isLeader&&this.waiting&&setTimeout(()=>{var v;const w=Date.now()+2200;(v=this.rt)==null||v.send({type:"start",id:s,roomId:this.roomId,t:performance.now(),startAt:w,delayMs:2200});const u=Math.max(400,w-Date.now());this.startAt=performance.now()+u,this.waiting=!1,this.starting=!0,this.gameStarted=!1,this.lastCountdownSecond=4},600);else if(d.type==="start"){const m=d.startAt;if(typeof m=="number"&&isFinite(m)){const w=Math.max(300,m-Date.now());this.startAt=performance.now()+w}else{const w=typeof d.delayMs=="number"?d.delayMs:1500;this.startAt=performance.now()+w}this.waiting=!1,this.starting=!0,this.gameStarted=!1,this.lastCountdownSecond=4}else if(d.type==="leave"&&d.id!==s)this.toast={text:"Opponent left",t:3},this.waiting=!0,this.bothReady=!1,this.remoteId=null;else if(d.type==="shoot"&&d.id!==s){const m=new Zt(d.x,d.y,d.vx,d.vy,"p2");d.w&&(m.width=d.w),d.h&&(m.height=d.h),d.color&&(m.color=d.color),this.enemyBullets.push(m)}else if(d.type==="powerSpawn"){const m=d.kind,w=new Gt(d.x,d.y,m);w.vx=d.vx,w.pid=d.pid,this.waiting||this.starting||!this.gameStarted?this.queuedPowerSpawns.push({pid:d.pid,kind:m,x:d.x,y:d.y,vx:d.vx}):this.powerups.push(w)}else if(d.type==="pickup"){const m=d.pid,w=this.powerups.findIndex(u=>u.pid===m);w>=0&&this.powerups.splice(w,1)}}),this.toast={text:`Connected • Room ${this.roomId} • ${this.rt.getTransport().toUpperCase()}`,t:2.5},this.rt.send({type:"join",id:s,roomId:this.roomId,name:this.name}),this.rt.onDisconnected(()=>{this.toast={text:"Online: disconnected",t:3},!this.reconnecting&&this.retries<2&&(this.reconnecting=!0,this.retries++,setTimeout(()=>this.reconnect(e),1500))}),this.unloadHandler=d=>{var m;try{(m=this.rt)==null||m.send({type:"leave",id:s,roomId:this.roomId})}catch{}},window.addEventListener("beforeunload",this.unloadHandler);try{const d=localStorage.getItem("lefty");this.lefty=d==="1"}catch{}try{t.canvas.style.touchAction="none"}catch{}const r=d=>{if(this.waiting||this.starting){d.preventDefault();return}d.button===2&&d.preventDefault();const m=ke(d.button??0);m==="flap"?(q.jump(this.p1),D.flap(),this.particles.burst(this.p1.x+this.p1.width*.2,this.p1.y+this.p1.height*.7,10,"#9bd1ff")):m==="shoot"&&(this.p1.fireCooldown<=0&&(this.fireBullet(this.p1,"p1",t),this.p1.fireCooldown=.35*(this.isRapid()?.55:1)),this.shootingHeld=!0)};t.canvas.onpointerdown=r,t.canvas.oncontextmenu=d=>{d.preventDefault()},t.canvas.onpointerup=d=>{(d.button??0)===2&&(this.shootingHeld=!1)};const l=d=>{const m=t.canvas.getBoundingClientRect();let w=0,u=0;for(let v=0;v<d.touches.length;v++){const g=d.touches.item(v).clientX-m.left;g<m.width*.45?w=1:g>m.width*.55&&(u=1)}this.mobileMoveX=u-w},f=()=>{const d=t.canvas.width,m=t.canvas.height,w=Math.max(60,Math.min(120,Math.floor(Math.min(d,m)*.14))),u=24;this.btnRects={left:{x:u,y:m-w-u,w,h:w},right:{x:u+w+16,y:m-w-u,w,h:w},shoot:{x:this.lefty?u:d-w-u,y:m-w-u,w,h:w}}},a=(d,m,w)=>{if(!this.btnRects)return!1;const u=this.btnRects[d];return m>=u.x&&m<=u.x+u.w&&w>=u.y&&w<=u.y+u.h},y=d=>{var E;const m=this.waiting||this.starting,w=t.canvas.width,u=t.canvas.height,v=t.canvas.getBoundingClientRect(),M=w/v.width,g=u/v.height;f(),this.btnLeftDown=this.btnRightDown=this.btnShootDown=!1;for(let T=0;T<d.touches.length;T++){const R=d.touches.item(T),I=(R.clientX-v.left)*M,A=(R.clientY-v.top)*g;a("left",I,A)?this.btnLeftDown=!0:a("right",I,A)?this.btnRightDown=!0:a("shoot",I,A)&&(this.btnShootDown=!0)}if(d.touches.length===1){const T=d.touches.item(0),R=(T.clientX-v.left)*M,I=(T.clientY-v.top)*g;if(R<w*.2&&I>u*.8){const A=performance.now();if(A-this.lastLeftCornerTap<500){this.lefty=!this.lefty,this.toast={text:`Left-handed ${this.lefty?"ON":"OFF"}`,t:2.2};try{localStorage.setItem("lefty",this.lefty?"1":"0")}catch{}}this.lastLeftCornerTap=A}}if(m)return;let S=!1;for(let T=0;T<d.touches.length;T++){const R=d.touches.item(T),I=(R.clientX-v.left)*M,A=(R.clientY-v.top)*g;if(!this.lefty?I>w*.7&&A>u*.6:I<w*.3&&A>u*.6){S=!0;break}}if(d.touches.length>=2||S||this.btnShootDown){this.p1.fireCooldown<=0&&(this.fireBullet(this.p1,"p1",t),this.p1.fireCooldown=.35*(this.isRapid()?.55:1)),this.touchShootHeld=!0;return}q.jump(this.p1),D.flap();try{(E=navigator.vibrate)==null||E.call(navigator,10)}catch{}this.particles.burst(this.p1.x+this.p1.width*.2,this.p1.y+this.p1.height*.7,10,"#9bd1ff")};t.canvas.ontouchstart=d=>{d.preventDefault(),l(d),y(d)},t.canvas.ontouchmove=d=>{d.preventDefault(),l(d)},t.canvas.ontouchend=d=>{d.preventDefault(),l(d),this.touchShootHeld=!1}}dispose(){var t;try{this.rt&&this.myId&&this.rt.send({type:"leave",id:this.myId,roomId:this.roomId})}catch{}try{this.unloadHandler&&window.removeEventListener("beforeunload",this.unloadHandler)}catch{}try{(t=this.rt)==null||t.close()}catch{}}async reconnect(t){this.rt;const e=this.name;this.rt=new Ie(t);try{await this.rt.connect(this.roomId);const s=this.rt.id;this.toast={text:"Online: reconnected",t:2.5},this.rt.onMessage(r=>{if(this.lastMsgAt=performance.now(),r.type==="state"&&r.id!==s)this.remoteHistory.push({t:r.t,x:r.x,y:r.y,vy:r.vy,score:r.score,hp:r.hp,name:r.name}),this.remoteHistory.length>30&&this.remoteHistory.shift(),this.remoteName=r.name||this.remoteName;else if(r.type==="spawn"&&this.isLeader===!1){const l=this.renderer.canvas.height,f=80,a=this.renderer.canvas.width+f,y=r.topH,d=r.gap;this.speed=r.speed,this.obstacles.push(new ct(a,0,f,y,this.speed)),this.obstacles.push(new ct(a,y+d,f,l-(y+d),this.speed))}else r.type==="join"&&r.id!==s?(this.remoteId=r.id,this.remoteName=r.name,this.isLeader=s<r.id):r.type==="leave"&&r.id!==s&&(this.toast={text:"Opponent left",t:3})}),this.rt.onDisconnected(()=>{this.toast={text:"Online: disconnected",t:3}}),this.rt.send({type:"join",id:this.rt.id,roomId:this.roomId,name:e})}catch{this.toast={text:"Online: reconnection failed",t:3}}finally{this.reconnecting=!1}}update(t,e){var A,C,O,G,F,ut;if((e.input.wasPressed("Escape")||e.input.wasPressed("KeyP"))&&(this.paused=!this.paused),this.paused){if(e.input.wasPressed("KeyR")&&(this.s1=this.s2=0,this.obstacles=[],this.powerups=[],this.bullets=[],this.enemyBullets=[],this.paused=!1),e.input.wasPressed("Enter")||e.input.wasPressed("KeyT")){try{this.dispose()}catch{}e.setScene(new zt);return}return}for(let _=this.floaters.length-1;_>=0;_--){const k=this.floaters[_];k.t-=t,k.y+=k.vy*t,k.t<=0&&this.floaters.splice(_,1)}if(this.shakeT>0&&(this.shakeT=Math.max(0,this.shakeT-t)),this.waiting){this.rt&&this.myId&&(this.presenceAccum+=t,this.presenceAccum>=1&&(this.presenceAccum=0,this.rt.send({type:"join",id:this.myId,roomId:this.roomId,name:this.name})));return}if(this.starting){const _=performance.now(),k=Math.max(0,this.startAt-_),L=Math.ceil(k/1e3);if(L!==this.lastCountdownSecond)if(this.lastCountdownSecond=L,L>0){const W=800-(3-Math.min(3,L))*120;D.beep(W,.08,"triangle",.06)}else D.beep(1e3,.1,"square",.07);if(k<=0){this.starting=!1,this.gameStarted=!0;const W=e.canvas.height;for(const B of this.queuedSpawns){const tt=e.canvas.width+(B.w??80),st=B.w??80;this.speed=B.speed,this.obstacles.push(new ct(tt,0,st,B.topH,this.speed)),this.obstacles.push(new ct(tt,B.topH+B.gap,st,W-(B.topH+B.gap),this.speed))}this.queuedSpawns=[];for(const B of this.queuedPowerSpawns){const tt=new Gt(B.x,B.y,B.kind);tt.vx=B.vx,tt.pid=B.pid,this.powerups.push(tt)}this.queuedPowerSpawns=[]}else{this.particles.update(t),this.remoteParticles.update(t);return}}if(!this.waiting&&!this.starting&&(e.input.wasPressed("Space")||e.input.wasPressed("ArrowUp"))){q.jump(this.p1),D.flap();try{(A=navigator.vibrate)==null||A.call(navigator,10)}catch{}this.particles.burst(this.p1.x+this.p1.width*.2,this.p1.y+this.p1.height*.7,10,"#9bd1ff")}const s=navigator.getGamepads?navigator.getGamepads():[],r=s&&s[0];let l=0;if(r&&r.connected){const _=r.axes&&r.axes[0]||0;l=Math.abs(_)>.2?_:0;const L=r.buttons||[],W=this.prevPadButtons,B=st=>!!(L[st]&&L[st].pressed),tt=st=>!!W[st];if(B(0)&&!tt(0)){q.jump(this.p1),D.flap();try{(C=navigator.vibrate)==null||C.call(navigator,10)}catch{}}!this.waiting&&!this.starting&&(B(1)||B(2))?this.shootingHeld=!0:!B(1)&&!B(2)&&(this.shootingHeld=!1),this.prevPadButtons=L.map(st=>!!st.pressed)}const f=e.input.getMovementDirection(),a=e.input.getWASDHorizontal?e.input.getWASDHorizontal():0,y=(this.btnRightDown?1:0)-(this.btnLeftDown?1:0);this.p1.vx=(f.x+a+this.mobileMoveX+y+l)*80;const d=.35,m=e.input.isDown("ControlLeft")||e.input.isDown("ControlRight")||e.input.isDown("KeyJ")||e.input.isDown("ShiftLeft")||e.input.isDown("KeyF");if(!this.waiting&&!this.starting&&(this.shootingHeld||this.touchShootHeld||!!m)&&this.p1.fireCooldown<=0){this.fireBullet(this.p1,"p1",e);try{(O=navigator.vibrate)==null||O.call(navigator,5)}catch{}this.p1.fireCooldown=d*(this.isRapid()?.55:1)}q.applyGravity(this.p1,t),this.p1.update(t);const u=e.canvas.height;if(this.p1.y=Math.max(0,Math.min(u-this.p1.height,this.p1.y)),this.rt){this.sendAccum+=t;const _=1/25;if(this.sendAccum>=_){this.sendAccum=0;const k={type:"state",id:this.rt.id,t:performance.now(),x:this.p1.x,y:this.p1.y,vy:this.p1.vy,score:this.s1,hp:this.p1.hp,name:this.name};this.rt.send(k)}}const M=performance.now()-100;for(;this.remoteHistory.length>=2&&this.remoteHistory[1].t<=M;)this.remoteHistory.shift();const g=this.remoteHistory[0],S=this.remoteHistory[1];if(g&&S){const _=(M-g.t)/Math.max(1,S.t-g.t),k=(L,W,B)=>L+(W-L)*Math.max(0,Math.min(1,B));this.p2.x=k(g.x,S.x,_),this.p2.y=k(g.y,S.y,_),this.p2.vy=k(g.vy,S.vy,_),this.s2=Math.max(g.score,S.score)}else g&&(this.p2.x=g.x,this.p2.y=g.y,this.p2.vy=g.vy,this.s2=g.score);this.trailAccum+=t;const E=(_,k,L)=>{this.particles.spawn(_,k,{vx:-40+Math.random()*20,vy:20+Math.random()*20,size:2.2,color:L+"cc",life:.35,g:150})};if(this.trailAccum>=.05&&(this.trailAccum=0,E(this.p1.x-4,this.p1.y+this.p1.height*.6,"#7cc1ff"),this.remoteParticles.spawn(this.p2.x-4,this.p2.y+this.p2.height*.6,{vx:-30+Math.random()*20,vy:20+Math.random()*15,size:2.2,color:"#ff9da0cc",life:.35,g:150})),this.particles.update(t),this.remoteParticles.update(t),this.hintT=Math.max(0,this.hintT-t),this.timeToNext-=t,this.timeToNext<=0){this.speed=Math.min(260,this.speed+2);const _=Math.max(130,180-Math.max(this.s1,this.s2)*2);this.timeToNext=Math.max(1,1.7-Math.max(this.s1,this.s2)*.02);const k=40,L=u-_-40,W=Math.floor(Math.random()*(L-k+1))+k,B=80,tt=e.canvas.width+B;if(this.isLeader&&this.gameStarted&&(this.obstacles.push(new ct(tt,0,B,W,this.speed)),this.obstacles.push(new ct(tt,W+_,B,u-(W+_),this.speed)),(G=this.rt)==null||G.send({type:"spawn",id:this.rt.id,t:performance.now(),w:B,gap:_,topH:W,speed:this.speed}),Math.random()<.3)){const st=Pe(Math.max(this.s1,this.s2)),at=new Gt(tt+140,Math.max(24,Math.min(u-40,W+_*.5-8)),st);at.vx=-Math.max(100,this.speed*.7);const mt=`${Date.now()}-${Math.random().toString(36).slice(2,6)}`;at.pid=mt,this.powerups.push(at),(F=this.rt)==null||F.send({type:"powerSpawn",id:this.rt.id,t:performance.now(),pid:mt,kind:st,x:at.x,y:at.y,vx:at.vx})}}for(const _ of this.obstacles)_.update(t);this.obstacles=this.obstacles.filter(_=>!_.isOffScreen());for(const _ of this.powerups)_.update(t);this.powerups=this.powerups.filter(_=>!_.isOffScreen());for(const _ of this.bullets)_.update(t);for(const _ of this.enemyBullets)_.update(t);const T=e.canvas.width,R=e.canvas.height,I=(_,k)=>q.checkCollision({x:_.x,y:_.y,width:_.width,height:_.height},k);for(const _ of this.bullets)for(const k of this.obstacles)if(I(_,k)){_.active=!1,D.combo(1);const L=_.x+_.width*.5,W=_.y+_.height*.5;this.particles.burst(L,W,6,_.color||"#ffd166")}for(const _ of this.enemyBullets)for(const k of this.obstacles)I(_,k)&&(_.active=!1,this.particles.burst(_.x+_.width*.5,_.y+_.height*.5,4,"#ff7b72"));this.bullets=this.bullets.filter(_=>_.active&&!_.isOffScreen(T,R)),this.enemyBullets=this.enemyBullets.filter(_=>_.active&&!_.isOffScreen(T,R));for(let _=0;_<this.powerups.length;_++){const k=this.powerups[_];if(q.checkCollision(this.p1,k)){this.applyPowerUp(k.type);const L=k.pid;L&&((ut=this.rt)==null||ut.send({type:"pickup",id:this.rt.id,t:performance.now(),pid:L}));const W={heal:"#7ee787",rapid:"#f7b84a",shield:"#8b8efb",multishot:"#38bdf8",bigshot:"#fb7185",slowmo:"#a78bfa",magnet:"#f472b6"};this.particles.burst(k.x+k.width/2,k.y+k.height/2,12,W[k.type]||"#ffffff"),this.powerups.splice(_,1),_--,D.score()}}for(const _ of this.obstacles)q.checkCollision&&q.checkCollision(this.p1,_)&&(this.p1.hp=Math.max(0,(this.p1.hp??3)-1),D.hit(),this.triggerShake(4,.25),this.p1.hp<=0&&(this.paused=!0,this.toast={text:"You crashed!",t:3}));for(let _=0;_<this.obstacles.length;_+=2){const k=this.obstacles[_],L=k.x+k.width/2;k.counted!==!0&&L<this.p1.x&&(k.counted=!0,this.s1+=1,D.score(),this.floaters.push({text:"+1",x:56,y:28,vy:-20,t:1,life:1,color:"#7ee787"}))}}render(t,e){var v,M;if(t.save(),this.renderer.clear(1/60),this.waiting){t.fillStyle="#e8e8f0",t.font="700 24px system-ui";const g=this.bothReady?"Found opponent! Starting…":`Waiting in room ${this.roomId}…`,S=t.measureText(g).width;t.fillText(g,Math.max(20,(e.canvas.width-S)/2),120),t.font="600 14px system-ui",t.fillStyle="#94a3b8";const E="Share the code with your friend. Game starts when they join.",T=t.measureText(E).width;t.fillText(E,Math.max(20,(e.canvas.width-T)/2),150);const R=(M=(v=this.rt)==null?void 0:v.getLastError)==null?void 0:M.call(v);if(R){t.fillStyle="#fca5a5",t.font="600 13px system-ui";const L=t.measureText(R).width;t.fillText(R,Math.max(20,(e.canvas.width-L)/2),170)}const A=`Connected players: ${1+(this.remoteId?1:0)}/2`;t.fillStyle="#cdd9e5",t.font="700 14px system-ui";const C=t.measureText(A).width,O=Math.max(20,(e.canvas.width-C)/2),G=180;t.fillText(A,O+18,G);const F=performance.now(),ut=F-this.lastMsgAt;let _="#ef4444";ut<2e3?_="#22c55e":ut<5e3&&(_="#facc15");const k=.6+.4*Math.sin(F/250);t.save(),t.fillStyle=_,t.beginPath(),t.arc(O+8,G-4,5*k,0,Math.PI*2),t.fill(),t.restore()}if(this.starting){const g=Math.max(0,this.startAt-performance.now()),S=Math.ceil(g/1e3);t.fillStyle="#e8e8f0",t.font="800 54px system-ui";const E=S>0?String(S):"GO!",T=t.measureText(E).width;t.fillText(E,(e.canvas.width-T)/2,e.canvas.height*.35)}if(t.save(),this.shakeT>0&&this.shakeTotal>0){const g=this.shakeT/this.shakeTotal,S=this.shakeAmp*(.5+.5*g),T=typeof(it==null?void 0:it.reducedMotion)<"u"&&it.reducedMotion?0:Math.min(4,S);if(T>0){const R=(Math.random()*2-1)*T,I=(Math.random()*2-1)*T;t.translate(R,I)}}this.renderer.drawPlayer(this.p1,"#58a6ff"),this.renderer.drawPlayer(this.p2,"#ff7b72");for(const g of this.bullets)this.renderer.drawProjectile(g);for(const g of this.enemyBullets)this.renderer.drawProjectile(g);for(const g of this.powerups)this.renderer.drawPowerUp(g);if(performance.now()<this.magnetUntil){t.save(),t.globalAlpha=.6;for(const g of this.powerups){const S=g.x+g.width/2,E=g.y+g.height/2,T=this.p1.x+this.p1.width/2-S,R=this.p1.y+this.p1.height/2-E,I=Math.max(1,Math.hypot(T,R)),A=T/I,C=R/I;t.fillStyle="#f472b6aa";for(let O=1;O<=2;O++){const G=S+A*O*8,F=E+C*O*8;t.beginPath(),t.arc(G,F,2,0,Math.PI*2),t.fill()}}t.restore()}this.particles.render(t),this.remoteParticles.render(t),t.restore();for(const g of this.obstacles)this.renderer.drawObstacle(g);this.hud.render(t,this.s1,this.s2);const s=this.p1.fireCooldown>0?Math.min(1,this.p1.fireCooldown/.35):0,r=[],l=performance.now();l<this.multishotUntil&&r.push({label:"Multi",color:"#38bdf8",remain:(this.multishotUntil-l)/1e3}),l<this.bigshotUntil&&r.push({label:"Big",color:"#fb7185",remain:(this.bigshotUntil-l)/1e3}),l<this.slowmoUntil&&r.push({label:"Slow",color:"#a78bfa",remain:(this.slowmoUntil-l)/1e3}),l<this.magnetUntil&&r.push({label:"Mag",color:"#f472b6",remain:(this.magnetUntil-l)/1e3}),this.hud.renderStatus(t,16,52,s,r),t.fillStyle="#cdd9e5",t.font="700 12px system-ui",this.name&&t.fillText(this.name,this.p1.x,Math.max(12,this.p1.y-6)),this.remoteName&&t.fillText(this.remoteName,this.p2.x,Math.max(12,this.p2.y-6)),t.fillStyle="#94a3b8",t.font="600 12px system-ui";const f=this.isLeader?"Leader":"Follower",a=1+(this.remoteId?1:0),y=`Online • Room ${this.roomId} • ${f} • Players ${a}/2`;t.fillText(y,32,e.canvas.height-8);const d=performance.now(),m=d-this.lastMsgAt;let w="#ef4444";m<2e3?w="#22c55e":m<5e3&&(w="#facc15");const u=.6+.4*Math.sin(d/250);if(t.save(),t.fillStyle=w,t.beginPath(),t.arc(16,e.canvas.height-12,5*u,0,Math.PI*2),t.fill(),t.restore(),this.isTouch){const g=e.canvas.width,S=e.canvas.height,E=Math.max(60,Math.min(120,Math.floor(Math.min(g,S)*.14))),T=24;this.btnRects={left:{x:T,y:S-E-T,w:E,h:E},right:{x:T+E+16,y:S-E-T,w:E,h:E},shoot:{x:this.lefty?T:g-E-T,y:S-E-T,w:E,h:E}};const R=(I,A,C)=>{t.save(),t.globalAlpha=.5,t.fillStyle=A?"#58a6ff":"#0f172a",t.strokeStyle="#58a6ff88",t.lineWidth=4,t.beginPath(),t.roundRect(I.x,I.y,I.w,I.h,16),t.fill(),t.stroke(),t.fillStyle="#e8e8f0",t.font="700 28px system-ui";const O=C==="L"?"◀":C==="R"?"▶":"●",G=t.measureText(O).width;t.fillText(O,I.x+(I.w-G)/2,I.y+I.h/2+10),t.restore()};R(this.btnRects.left,this.btnLeftDown,"L"),R(this.btnRects.right,this.btnRightDown,"R"),R(this.btnRects.shoot,this.btnShootDown||this.touchShootHeld,"S")}if(this.hintT>0){const g=Math.min(.8,this.hintT/4);if(t.save(),t.globalAlpha=g,t.fillStyle="#00000088",t.fillRect(20,70,560,56),t.fillStyle="#e8e8f0",t.font="600 16px system-ui",t.fillText("Flap: Click/Space/ArrowUp • Move: ←/→ or A/D • Shoot: Right Click or Ctrl/J (hold)",28,100),t.restore(),this.paused){t.fillStyle="#00000088",t.fillRect(0,0,e.canvas.width,e.canvas.height);const S=Math.min(460,e.canvas.width-40),E=190,T=(e.canvas.width-S)/2,R=Math.max(60,e.canvas.height*.3);t.fillStyle="#0f172ae6",t.beginPath(),t.roundRect(T,R,S,E,12),t.fill(),t.strokeStyle="#58a6ff55",t.stroke(),t.fillStyle="#e8e8f0",t.font="800 22px system-ui",t.fillText("Paused",T+16,R+36),t.font="600 15px system-ui",t.fillText("R: Reset Round",T+16,R+76),t.fillText("Esc/P: Resume",T+16,R+102),t.fillText("Open a new tab to return to menu",T+16,R+128)}}for(const g of this.floaters){const S=Math.max(0,g.t/g.life);t.save(),t.globalAlpha=S,t.fillStyle=g.color||"#e8e8f0",t.font="700 16px system-ui",t.fillText(g.text,g.x,g.y),t.restore()}if(this.toast){this.toast.t-=1/60,t.save(),t.globalAlpha=Math.max(0,Math.min(1,this.toast.t/3)),t.fillStyle="#000000aa";const g=this.toast.text;t.font="700 16px system-ui";const S=t.measureText(g).width+20;t.fillRect(20,20,S,34),t.fillStyle="#e8e8f0",t.fillText(g,30,42),t.restore(),this.toast.t<=0&&(this.toast=null)}t.restore()}isRapid(){const t=performance.now();return t<this.multishotUntil||t<this.bigshotUntil}fireBullet(t,e,s){const r=performance.now(),l=t.y+t.height*.5-2,f=420,a=e==="p1"?"#ffd166":"#ff7b72",y=performance.now()<this.bigshotUntil?1.6:1;e==="p1"&&y>1&&this.triggerShake(1.2,.12);const d=(w,u)=>{var M;const v=new Zt(t.x+t.width,l,w,u,e);v.color=a,v.width=10*y,v.height=4*y,this.bullets.push(v),(M=this.rt)==null||M.send({type:"shoot",id:this.rt.id,t:r,x:v.x,y:v.y,vx:v.vx,vy:v.vy,w:v.width,h:v.height,color:a})};performance.now()<this.multishotUntil?(d(f,-40),d(f,0),d(f,40)):d(f,0)}triggerShake(t,e){this.shakeAmp=t,this.shakeT=e,this.shakeTotal=e}applyPowerUp(t){const e=performance.now(),s=ze[t];s&&(t==="heal"?this.p1.hp=Math.min(this.p1.maxHp,this.p1.hp+1):t==="shield"?(this.p1.maxHp+=1,this.p1.hp=Math.min(this.p1.maxHp,this.p1.hp+1)):t==="rapid"?this.multishotUntil=e+(s.duration??6)*1e3:t==="multishot"?this.multishotUntil=e+(s.duration??6)*1e3:t==="bigshot"?this.bigshotUntil=e+(s.duration??6)*1e3:t==="slowmo"?(this.slowmoUntil=e+(s.duration??3)*1e3,this.speed=Math.max(100,this.speed*.8)):t==="magnet"&&(this.magnetUntil=e+(s.duration??6)*1e3))}}class zt{constructor(){this.t=0,this.onlineModalOpen=!1,this.modalCreateBtn=null,this.modalJoinBtn=null,this.modalCancelBtn=null,this.shareRoomCode=null,this.shareRoomName=null,this.btnS=null,this.btnV=null,this.btnVO=null,this.btnEditName=null,this.lastPointer=null,this.pointerDown=!1,this.lefty=!1,this.leftyRect=null}launchOnline(t){this.onlineModalOpen=!0}onResize(t){t.ctx.setTransform(1,0,0,1,0,0)}init(t){t.canvas.focus();try{const M=localStorage.getItem("lefty");this.lefty=M==="1"}catch{}try{const M=new URL(window.location.href),g=M.searchParams.get("room"),S=M.searchParams.get("name");g&&(this.shareRoomCode=g.toLowerCase(),S&&(this.shareRoomName=S),this.onlineModalOpen=!0)}catch{}let e=!1;const s=()=>{t.canvas.onpointerdown=null,t.canvas.ontouchstart=null,t.canvas.onclick=null,document.removeEventListener("touchstart",u),document.removeEventListener("pointerdown",w),document.removeEventListener("click",v)},r=(M,g=!1)=>{if(M&&g){this.launchOnline(t);return}this.onlineModalOpen||e||(e=!0,s(),t.setScene(M?new te:new Ot))},l=M=>{const g=t.canvas.getBoundingClientRect(),S=t.canvas.width/g.width,E=t.canvas.height/g.height,T=(M.clientX-g.left)*S,R=(M.clientY-g.top)*E;return this.lastPointer={x:T,y:R},{x:T,y:R}},f=M=>{try{M.stopPropagation()}catch{}l(M)},a=M=>{try{M.stopPropagation()}catch{}this.pointerDown=!0;const{x:g,y:S}=l(M);if(this.btnS||this.btnV||this.btnEditName){if(this.onlineModalOpen){const E=T=>T&&g>=T.x&&g<=T.x+T.w&&S>=T.y&&S<=T.y+T.h;if(E(this.modalCreateBtn)){const T=ft.getPlayerName()||this.shareRoomName||"Anon",R=typeof window<"u"&&window.prompt("Your name",T)||T;ft.setPlayerName(R);const I=Math.random().toString(36).slice(2,6).toUpperCase();try{const A=new URL(window.location.href);A.searchParams.set("room",I.toLowerCase()),A.searchParams.delete("name");const C=A.toString();if(navigator.clipboard&&navigator.clipboard.writeText)(async()=>{try{await navigator.clipboard.writeText(C);try{window.alert(`Room code: ${I}
Invite link copied to clipboard!
${C}`)}catch{}}catch{try{window.alert(`Room code: ${I}
Share this link:
${C}`)}catch{}}})();else try{window.alert(`Room code: ${I}
Share this link:
${C}`)}catch{}}catch{}if(e)return;e=!0,s(),t.setScene(new re(I.toLowerCase(),R));return}if(E(this.modalJoinBtn)){const T=ft.getPlayerName()||this.shareRoomName||"Anon",R=typeof window<"u"&&window.prompt("Your name",T)||T;ft.setPlayerName(R);let I=this.shareRoomCode||"";if(I||(I=((typeof window<"u"?window.prompt("Enter room code to join",""):"")||"").trim()),!I){this.onlineModalOpen=!1;return}if(e)return;e=!0,s(),t.setScene(new re(I.toLowerCase(),R));return}if(E(this.modalCancelBtn)){this.onlineModalOpen=!1;return}return}if(this.leftyRect&&g>=this.leftyRect.x&&g<=this.leftyRect.x+this.leftyRect.w&&S>=this.leftyRect.y&&S<=this.leftyRect.y+this.leftyRect.h){this.lefty=!this.lefty;try{localStorage.setItem("lefty",this.lefty?"1":"0")}catch{}return}if(this.btnS&&g>=this.btnS.x&&g<=this.btnS.x+this.btnS.w&&S>=this.btnS.y&&S<=this.btnS.y+this.btnS.h)return r(!1);if(this.btnV&&g>=this.btnV.x&&g<=this.btnV.x+this.btnV.w&&S>=this.btnV.y&&S<=this.btnV.y+this.btnV.h)return r(!0);if(this.btnVO&&g>=this.btnVO.x&&g<=this.btnVO.x+this.btnVO.w&&S>=this.btnVO.y&&S<=this.btnVO.y+this.btnVO.h)return r(!0,!0);if(this.btnEditName&&g>=this.btnEditName.x&&g<=this.btnEditName.x+this.btnEditName.w&&S>=this.btnEditName.y&&S<=this.btnEditName.y+this.btnEditName.h){try{const E=ft.getPlayerName()||"Anon",T=typeof window<"u"?window.prompt("Your name",E):null;T!=null&&ft.setPlayerName(T)}catch{}return}}r(!1)},y=M=>{try{M.stopPropagation()}catch{}this.pointerDown=!1,l(M)},d=M=>{var S;try{M.stopPropagation()}catch{}const g=((S=M.touches)==null?void 0:S.length)??0;r(g>=2)},m=M=>{try{M.stopPropagation()}catch{}r(!1)},w=M=>{this.onlineModalOpen||r(!1)},u=M=>{var S;const g=((S=M.touches)==null?void 0:S.length)??0;this.onlineModalOpen||r(g>=2)},v=M=>{this.onlineModalOpen||r(!1)};t.canvas.onpointermove=f,t.canvas.onpointerdown=a,t.canvas.onpointerup=y,t.canvas.ontouchstart=d,t.canvas.onclick=m,document.addEventListener("pointerdown",w,{passive:!0}),document.addEventListener("touchstart",u,{passive:!0}),document.addEventListener("click",v,{passive:!0})}update(t,e){this.t+=t,e.input.wasPressed("KeyS")&&e.setScene(new Ot),e.input.wasPressed("KeyV")&&e.setScene(new te),e.input.wasPressed("KeyO")&&this.launchOnline(e),e.input.wasPressed("Escape")&&this.onlineModalOpen&&(this.onlineModalOpen=!1),e.input.wasPressed("KeyM")&&(D.muted=!D.muted),e.input.wasPressed("KeyR")&&it.toggleReducedMotion(),e.input.wasPressed("KeyC")&&ft.clear();const{ctx:s}=e,r=e.canvas.width,l=e.canvas.height,f=s.createLinearGradient(0,0,0,l);f.addColorStop(0,"#0b1023"),f.addColorStop(1,"#1a2247"),s.fillStyle=f,s.fillRect(0,0,r,l),s.save(),s.globalAlpha=.2;for(let N=0;N<60;N++){const X=N*91%r,j=N*53%l;s.fillStyle=N%2?"#d0e0ff":"#a0b8ff",s.fillRect(X,j+(Math.sin(this.t+N)*2+2)|0,2,2)}s.restore();const a=Math.sin(this.t*2)*6;s.textBaseline="top";const y="CrappyBird";s.font="900 72px system-ui, ui-sans-serif, -apple-system, Segoe UI";const d=s.measureText(y).width,m=Math.max(24,(r-d)/2),w=56+a,u=s.createLinearGradient(m,w,m,w+72);u.addColorStop(0,"#e6f0ff"),u.addColorStop(1,"#9cc9ff"),s.save(),s.shadowColor="#3b82f6aa",s.shadowBlur=18,s.fillStyle=u,s.fillText(y,m,w),s.restore(),s.strokeStyle="#58a6ff",s.lineWidth=5,s.beginPath(),s.moveTo(m,w+72+6),s.lineTo(m+Math.min(520,d*.65),w+72+6),s.stroke();const v=m-80,M=w+10,g=18,S=Math.sin(this.t*10)*.6;s.fillStyle="#58a6ff",s.beginPath(),s.arc(v,M,g,0,Math.PI*2),s.fill(),s.fillStyle="#ffffffaa",s.beginPath(),s.arc(v-g*.2,M+g*.1,g*.7,Math.PI*.1,Math.PI*1.2),s.fill(),s.save(),s.translate(v-g*.2,M),s.rotate(-.8+S),s.fillStyle="#00000022",s.beginPath(),s.ellipse(0,0,g*.9,g*.5,0,0,Math.PI*2),s.fill(),s.restore(),s.fillStyle="#ffd166",s.beginPath(),s.moveTo(v+g*.9,M),s.lineTo(v+g*1.4,M-g*.2),s.lineTo(v+g*.9,M+g*.2),s.closePath(),s.fill(),s.fillStyle="#fff",s.beginPath(),s.arc(v+g*.2,M-g*.3,g*.22,0,Math.PI*2),s.fill(),s.fillStyle="#000",s.beginPath(),s.arc(v+g*.25,M-g*.3,g*.1,0,Math.PI*2),s.fill(),s.save();const E=s.createRadialGradient(r/2,l/2,Math.min(r,l)*.2,r/2,l/2,Math.max(r,l)*.6);E.addColorStop(0,"rgba(0,0,0,0)"),E.addColorStop(1,"rgba(0,0,0,0.35)"),s.fillStyle=E,s.fillRect(0,0,r,l),s.restore();const T=Math.min(560,r-64),R=170,I=(r-T)/2;s.fillStyle="#0f172ae6",s.beginPath(),s.roundRect(I,R,T,150,14),s.fill(),s.fillStyle="#cdd9e5",s.font="700 22px system-ui",s.fillText("Play",I+16,R+16);const A=18,C=44,O=16,G=3,F=Math.floor((T-O*2-A*(G-1))/G),ut=F*G+A*(G-1),_=I+Math.max(O,(T-ut)/2),k=R+56,L=(N,X,j,Z)=>{const Q=this.lastPointer;return Q?Q.x>=N&&Q.x<=N+j&&Q.y>=X&&Q.y<=X+Z:!1},W=(N,X,j,Z)=>{const Q=L(N,X,F,C),et=Q&&this.pointerDown;s.save(),s.shadowColor=Q?"#58a6ff66":"#00000044",s.shadowBlur=Q?12:6,s.fillStyle=et?"#0f1a33":Q?"#16284f":"#15223f",s.strokeStyle=Q?"#58a6ffcc":"#58a6ffaa",s.lineWidth=3,s.beginPath(),s.roundRect(N,X+(et?1:0),F,C-(et?1:0),10),s.fill(),s.stroke(),Z&&(s.fillStyle="#9cc9ff",s.font="700 18px system-ui",s.fillText(Z,N+12,X+28)),s.fillStyle="#e8e8f0",s.font="600 18px system-ui",s.fillText(j,N+(Z?36:14),X+28),s.restore()};W(_,k,"S — Singleplayer","🎮"),W(_+F+A,k,"V — Versus (Local)","🤝"),W(_+(F+A)*2,k,"O — Versus (Online)","🌐"),this.btnS={x:_,y:k,w:F,h:C},this.btnV={x:_+F+A,y:k,w:F,h:C},this.btnVO={x:_+(F+A)*2,y:k,w:F,h:C};const B=120,tt=24,st=10,at=this.btnVO.x+F-B,mt=k+C+10;s.save();const Ut=L(at,mt,B,tt);s.globalAlpha=.95,s.fillStyle=this.lefty?Ut?"#25406f":"#1f365e":Ut?"#18274a":"#14223f",s.strokeStyle=this.lefty?"#93c5fd":"#58a6ff88",s.lineWidth=2,s.beginPath(),s.roundRect(at,mt,B,tt,12),s.fill(),s.stroke(),s.fillStyle="#cdd9e5",s.font="600 12px system-ui";const z=`Left-handed: ${this.lefty?"ON":"OFF"}`;s.fillText(z,at+st,mt+16),s.restore(),this.leftyRect={x:at,y:mt,w:B,h:tt};const J=R+170,kt=Math.min(760,r-64),gt=(r-kt)/2;s.fillStyle="#0f172acc",s.beginPath(),s.roundRect(gt,J,kt,160,14),s.fill(),s.fillStyle="#cdd9e5",s.font="700 20px system-ui",s.fillText("Controls",gt+16,J+16),s.font="500 16px system-ui";let bt=J+46;s.fillText("Singleplayer: Flap = Space/ArrowUp/W or Click/Tap • Move = ArrowLeft/Right or A/D • Shoot = Right Click or Ctrl/J (hold)",gt+16,bt),bt+=28,s.fillText("Versus (Local): P1 = Arrows + Space • P2 = W (flap), S (nudge down)",gt+16,bt),bt+=28,s.fillText(`Online: O — create or join room • Mute = M (${D.muted?"Muted":"Sound on"}) • Reduced motion = R (${it.reducedMotion?"On":"Off"}) • Esc returns here`,gt+16,bt);const Mt=J+170,At=Math.min(760,r-64),pt=(r-At)/2;s.fillStyle="#0f172acc",s.beginPath(),s.roundRect(pt,Mt,At,130,14),s.fill(),s.fillStyle="#cdd9e5",s.font="700 20px system-ui",s.fillText("Power-ups",pt+16,Mt+16),s.font="500 14px system-ui";let St=Mt+44;const Ft=[["+ Heal","gain 1 heart"],["R Rapid","shorter cooldown"],["S Shield","+1 max heart and heal"],["M Multishot","fires 3 bullets"],["B Bigshot","bigger bullets, +1 dmg"],["⌛ Slowmo","world slows briefly"],["U Magnet","pulls pickups nearby"]];for(const[N,X]of Ft)s.fillText(`${N} — ${X}`,pt+16,St),St+=20;const Tt=ft.getTop(5);if(Tt.length){const N=Math.min(420,r-40),X=28+Tt.length*22+20,j=(r-N)/2,Z=l-X-80;s.fillStyle="#0f172acc",s.beginPath(),s.roundRect(j,Z,N,X,10),s.fill(),s.fillStyle="#cdd9e5",s.font="700 16px system-ui",s.fillText("Top Scores",j+12,Z+20),s.font="500 14px system-ui";for(let dt=0;dt<Tt.length;dt++){const xt=Tt[dt],ht=`${dt+1}. ${(xt.name||"Anon").slice(0,18)} — ${xt.score}`;s.fillText(ht,j+12,Z+44+dt*22)}s.font="400 12px system-ui",s.fillStyle="#94a3b8",s.fillText("Press C to clear • Name is saved locally",j+12,Z+X-10);const Q=92,et=22,rt=j+N-Q-10,Y=Z+10;s.fillStyle="#15223f",s.strokeStyle="#58a6ff88",s.lineWidth=2,s.beginPath(),s.roundRect(rt,Y,Q,et,6),s.fill(),s.stroke(),s.fillStyle="#e8e8f0",s.font="600 12px system-ui",s.fillText("Edit name",rt+12,Y+15),this.btnEditName={x:rt,y:Y,w:Q,h:et}}const Nt=.5+.5*Math.sin(this.t*3);s.save(),s.globalAlpha=.6+.4*Nt,s.fillStyle="#7dd3fc",s.font="700 18px system-ui";const wt="Tap to start • Starts easy, ramps up • Two-finger tap for Versus (S/V)",vt=s.measureText(wt).width;if(s.fillText(wt,Math.max(20,(r-vt)/2),l-60),s.restore(),this.onlineModalOpen){s.save(),s.fillStyle="rgba(0,0,0,0.5)",s.fillRect(0,0,r,l);const N=Math.min(420,r-40),X=200,j=(r-N)/2,Z=Math.max(60,l*.25);s.fillStyle="#0f172ae6",s.beginPath(),s.roundRect(j,Z,N,X,12),s.fill(),s.strokeStyle="#58a6ff55",s.stroke(),s.fillStyle="#cdd9e5",s.font="700 20px system-ui",s.fillText("Online Match",j+16,Z+16),s.font="500 14px system-ui",s.fillStyle="#94a3b8";const Q=this.shareRoomCode?`You were invited to room ${this.shareRoomCode.toUpperCase()}. Join to continue.`:"Create a room to host, or join with a code from a friend.";s.fillText(Q,j+16,Z+44);const et=(N-16*3)/2,rt=40,Y=Z+X-rt-20;s.fillStyle="#15223f",s.strokeStyle="#58a6ffaa",s.lineWidth=3,s.beginPath(),s.roundRect(j+16,Y,et,rt,10),s.fill(),s.stroke(),s.fillStyle="#e8e8f0",s.font="600 16px system-ui",s.fillText("Create Room",j+16+14,Y+26),this.modalCreateBtn={x:j+16,y:Y,w:et,h:rt},s.fillStyle="#15223f",s.strokeStyle="#58a6ffaa",s.lineWidth=3,s.beginPath(),s.roundRect(j+16*2+et,Y,et,rt,10),s.fill(),s.stroke(),s.fillStyle="#e8e8f0",s.font="600 16px system-ui";const dt=this.shareRoomCode?`Join Room ${this.shareRoomCode.toUpperCase()}`:"Join Room";s.fillText(dt,j+16*2+et+14,Y+26),this.modalJoinBtn={x:j+16*2+et,y:Y,w:et,h:rt},s.fillStyle="#9cc9ff",s.font="600 14px system-ui";const xt="Cancel (Esc)",ht=s.measureText(xt).width,$t=j+N-ht-16,o=Z+16;s.fillText(xt,$t,o+2),this.modalCancelBtn={x:$t-6,y:o-6,w:ht+12,h:24},s.restore()}else this.modalCreateBtn=this.modalJoinBtn=this.modalCancelBtn=null}render(){}}const de=document.getElementById("gameCanvas");de.style.width="100vw";de.style.height="100vh";const Pt=new Ke(de);let He="title";const Ct=c=>{switch(He=c,c){case"title":Pt.setScene(new zt);break;case"single":Pt.setScene(new Ot);break;case"versus":Pt.setScene(new te);break;case"versusOnline":{const t="Anon",e="test";Pt.setScene(new re(e,t));break}}};Ct("title");window.addEventListener("keydown",c=>{He==="title"?(c.code==="KeyS"&&Ct("single"),c.code==="KeyV"&&Ct("versus"),c.code==="KeyO"&&Ct("versusOnline")):c.code==="Escape"&&Ct("title")});window.addEventListener("resize",()=>Pt.resizeToDisplay());
