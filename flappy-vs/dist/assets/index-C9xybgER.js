(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const c of r)if(c.type==="childList")for(const f of c.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&i(f)}).observe(document,{childList:!0,subtree:!0});function n(r){const c={};return r.integrity&&(c.integrity=r.integrity),r.referrerPolicy&&(c.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?c.credentials="include":r.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function i(r){if(r.ep)return;r.ep=!0;const c=n(r);fetch(r.href,c)}})();class je{constructor(){this.down=new Set,this.pressedThisFrame=new Set,window.addEventListener("keydown",t=>{this.down.has(t.code)||this.pressedThisFrame.add(t.code),this.down.add(t.code),["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","KeyW","KeyA","KeyS","KeyD"].includes(t.code)&&t.preventDefault()},{passive:!1}),window.addEventListener("keyup",t=>this.down.delete(t.code))}beginFrame(){this.pressedThisFrame.clear()}endFrame(){}isDown(t){return this.down.has(t)}wasPressed(t){return this.pressedThisFrame.has(t)}getMovementDirection(){return{x:(this.isDown("ArrowRight")?1:0)+(this.isDown("ArrowLeft")?-1:0),y:(this.isDown("ArrowDown")?1:0)+(this.isDown("ArrowUp")?-1:0)}}getWASDHorizontal(){return(this.isDown("KeyD")?1:0)+(this.isDown("KeyA")?-1:0)}}class Ge{constructor(t){this.lastTime=0,this.running=!1,this.scene=null,this.loop=i=>{if(!this.running||!this.scene)return;const r=Math.min(1/30,(i-this.lastTime)/1e3);this.lastTime=i,this.input.beginFrame(),this.scene.update(r,this),this.scene.render(this.ctx,this),this.input.endFrame(),requestAnimationFrame(this.loop)},this.canvas=t;const n=t.getContext("2d");if(!n)throw new Error("2D context not available");this.ctx=n,this.input=new je,this.resizeToDisplay()}resizeToDisplay(){var c,f;const t=Math.max(1,Math.min(window.devicePixelRatio||1,2)),n=this.canvas.getBoundingClientRect(),i=Math.floor(n.width*t)||800,r=Math.floor(n.height*t)||600;(this.canvas.width!==i||this.canvas.height!==r)&&(this.canvas.width=i,this.canvas.height=r),this.ctx.setTransform(1,0,0,1,0,0),(f=(c=this.scene)==null?void 0:c.onResize)==null||f.call(c,this)}setScene(t){this.scene=t,t.init(this),this.running||(this.running=!0,this.lastTime=performance.now(),requestAnimationFrame(this.loop))}}class At{constructor(t=50,n=50,i=28,r=28,c){this.vx=0,this.vy=0,this._score=0,this.hp=3,this.maxHp=3,this.fireCooldown=0,this.x=t,this.y=n,this.width=i,this.height=r}setPosition(t,n){this.x=t,this.y=n}passObstacle(){this._score+=1}update(t){this.x+=this.vx*t,this.y+=this.vy*t,this.fireCooldown>0&&(this.fireCooldown=Math.max(0,this.fireCooldown-t))}get score(){return Math.max(0,this._score)}set score(t){this._score=Math.max(0,t)}}class ot{constructor(t,n,i,r,c=120){this.x=t,this.y=n,this.width=i,this.height=r,this.speed=c}update(t){this.x-=this.speed*t}isOffScreen(){return this.x+this.width<0}}class Jt{render(t,n,i,r,c){t.fillStyle="#e8e8f0",t.font="700 20px system-ui, sans-serif",typeof i=="number"?t.fillText(`P1: ${n}   P2: ${i}`,16,24):t.fillText(`Score: ${n}`,16,24);const f=(l,p,x)=>{if(x!=null)for(let m=0;m<x;m++){t.fillStyle="#ff7b72",t.beginPath();const w=m*18;t.moveTo(l+w+6,p+10),t.arc(l+w+3,p+8,3,0,Math.PI),t.arc(l+w+9,p+8,3,0,Math.PI),t.lineTo(l+w+6,p+14),t.closePath(),t.fill()}};f(16,36,r),c!=null&&f(120,36,c)}}const gt=class gt{static applyGravity(t,n){t.vy+=gt.gravity*n}static jump(t){t.vy=gt.jumpVelocity}static checkCollision(t,n){return!(t.x+t.width<n.x||t.x>n.x+n.width||t.y+t.height<n.y||t.y>n.y+n.height)}};gt.gravity=900,gt.jumpVelocity=-300;let H=gt;class Zt{constructor(t,n){this.canvas=t,this.ctx=n,this.t=0,this.cloudOffset=0}clear(t=0){const{ctx:n}=this,i=this.canvas.width,r=this.canvas.height;this.t+=t,this.cloudOffset=(this.cloudOffset+t*20)%(i+200);const c=n.createLinearGradient(0,0,0,r);c.addColorStop(0,"#0f1630"),c.addColorStop(1,"#0b1022"),n.fillStyle=c,n.fillRect(0,0,i,r);const f=(l,p,x)=>{n.fillStyle="#ffffff14",n.beginPath(),n.roundRect(l,p,120*x,40*x,20*x),n.fill()};for(let l=0;l<4;l++){const p=i-(this.cloudOffset+l*180)%(i+200),x=40+l*45%(r*.5);f(p,x,1)}n.fillStyle="#1a2446",n.fillRect(0,r-20,i,20),n.fillStyle="#111a36";for(let l=0;l<i;l+=16)n.fillRect(l,r-22,8,2)}drawBird(t,n){const{ctx:i}=this,r=Math.min(t.width,t.height)/2,c=t.x+r,f=t.y+r,l=Math.sin(this.t*10)*.6;i.fillStyle=n,i.beginPath(),i.arc(c,f,r,0,Math.PI*2),i.fill(),i.fillStyle="#ffffff88",i.beginPath(),i.arc(c-r*.2,f+r*.1,r*.7,Math.PI*.1,Math.PI*1.2),i.fill(),i.save(),i.translate(c-r*.2,f),i.rotate(-.8+l),i.fillStyle="#00000022",i.beginPath(),i.ellipse(0,0,r*.9,r*.5,0,0,Math.PI*2),i.fill(),i.restore(),i.fillStyle="#ffd166",i.beginPath(),i.moveTo(c+r*.9,f),i.lineTo(c+r*1.4,f-r*.2),i.lineTo(c+r*.9,f+r*.2),i.closePath(),i.fill(),i.fillStyle="#fff",i.beginPath(),i.arc(c+r*.2,f-r*.3,r*.22,0,Math.PI*2),i.fill(),i.fillStyle="#000",i.beginPath(),i.arc(c+r*.25,f-r*.3,r*.1,0,Math.PI*2),i.fill()}drawPlayer(t,n="#58a6ff"){this.drawBird(t,n)}drawObstacle(t){const{ctx:n}=this,i=n.createLinearGradient(t.x,t.y,t.x+t.width,t.y);i.addColorStop(0,"#2bc072"),i.addColorStop(1,"#3be688"),n.fillStyle=i,n.fillRect(t.x,t.y,t.width,t.height),n.fillStyle="#ffffff18",n.fillRect(t.x+6,t.y,6,t.height)}drawHUD(t){this.ctx.fillStyle="#e8e8f0",this.ctx.font="700 24px system-ui, sans-serif",this.ctx.fillText(t,16,32)}drawProjectile(t,n="#ffd166"){const{ctx:i}=this;i.fillStyle=t.color||n,i.fillRect(t.x,t.y,t.width,t.height)}drawEnemy(t){const{ctx:n}=this,i=t.variant||"drone";i==="tank"?(n.fillStyle="#c65353",n.beginPath(),n.roundRect(t.x,t.y,t.width,t.height,4),n.fill(),n.fillStyle="#00000055",n.fillRect(t.x+3,t.y+t.height-6,t.width-6,4)):i==="bee"?(n.fillStyle="#ffd166",n.beginPath(),n.ellipse(t.x+t.width/2,t.y+t.height/2,t.width/2,t.height/2,0,0,Math.PI*2),n.fill(),n.fillStyle="#00000066",n.fillRect(t.x+4,t.y+4,t.width-8,4),n.fillRect(t.x+4,t.y+10,t.width-8,4)):i==="kamikaze"?(n.fillStyle="#ff7b72",n.beginPath(),n.ellipse(t.x+t.width/2,t.y+t.height/2,t.width/2,t.height/2,0,0,Math.PI*2),n.fill(),n.fillStyle="#ffffffaa",n.beginPath(),n.arc(t.x+t.width/2+3,t.y+t.height/2-2,3,0,Math.PI*2),n.fill()):(n.fillStyle="#ff7b72",n.beginPath(),n.ellipse(t.x+t.width/2,t.y+t.height/2,t.width/2,t.height/2,0,0,Math.PI*2),n.fill(),n.fillStyle="#00000055",n.fillRect(t.x+2,t.y+2,t.width-4,3))}drawPowerUp(t){const{ctx:n}=this,i={heal:"#7ee787",rapid:"#f7b84a",shield:"#8b8efb",multishot:"#38bdf8",bigshot:"#fb7185",slowmo:"#a78bfa",magnet:"#f472b6"};n.fillStyle=i[t.type]||"#f7b84a",n.beginPath(),n.roundRect(t.x,t.y,t.width,t.height,4),n.fill(),n.fillStyle="#0f172a",n.font="700 10px system-ui";const r=t.x+t.width/2,c=t.y+t.height/2+3,l={heal:"+",rapid:"R",shield:"S",multishot:"M",bigshot:"B",slowmo:"⌛",magnet:"U"}[t.type]||"?",p=n.measureText(l).width;n.fillText(l,r-p/2,c)}}class $e{constructor(){this.ctx=null,this._muted=!1}get muted(){return this._muted}set muted(t){this._muted=t;try{localStorage.setItem("mute",t?"1":"0")}catch{}}ensure(){this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext))}beep(t,n=.08,i="sine",r=.05){if(this._muted)return;this.ensure();const c=this.ctx,f=c.createOscillator(),l=c.createGain();f.type=i,f.frequency.value=t,l.gain.value=r,f.connect(l).connect(c.destination);const p=c.currentTime;f.start(p),f.stop(p+n)}flap(){this.beep(660,.05,"square",.05)}score(){this.beep(880,.08,"triangle",.06)}hit(){this.beep(120,.15,"sawtooth",.08)}combo(t){if(this._muted)return;const n=900+Math.min(4,t)*80;this.beep(n,.05,"triangle",.05)}}const N=new $e;try{N.muted=localStorage.getItem("mute")==="1"}catch{}class ve{constructor(){this.pool=[],this.active=[]}spawn(t,n,i){const r=this.pool.pop()||{x:t,y:n,vx:0,vy:0,life:.5,maxLife:.5,size:3,color:"#fff"};r.x=t,r.y=n,r.vx=(i==null?void 0:i.vx)??Math.random()*80-40,r.vy=(i==null?void 0:i.vy)??Math.random()*-80,r.life=(i==null?void 0:i.life)??.5,r.maxLife=r.life,r.size=(i==null?void 0:i.size)??3,r.color=(i==null?void 0:i.color)??"#ffffff88",r.g=(i==null?void 0:i.g)??200,this.active.push(r)}burst(t,n,i,r){for(let c=0;c<i;c++)this.spawn(t,n,{color:r,size:2+Math.random()*2,life:.4+Math.random()*.3})}update(t){for(let n=this.active.length-1;n>=0;n--){const i=this.active[n];i.vy+=(i.g||0)*t,i.x+=i.vx*t,i.y+=i.vy*t,i.life-=t,i.life<=0&&(this.pool.push(i),this.active.splice(n,1))}}render(t){for(const n of this.active){const i=Math.max(0,n.life/n.maxLife);t.fillStyle=n.color.replace(/\d?\.?\d*\)$/,"")||n.color,t.globalAlpha=i,t.beginPath(),t.arc(n.x,n.y,n.size,0,Math.PI*2),t.fill(),t.globalAlpha=1}}}function We(h){return h===2?"shoot":"flap"}class qe{constructor(t,n,i,r,c="player"){this.width=10,this.height=4,this.active=!0,this.damage=1,this.x=t,this.y=n,this.vx=i,this.vy=r,this.owner=c}update(t){this.x+=this.vx*t,this.y+=this.vy*t}isOffScreen(t,n){return this.x>t+20||this.x+this.width<-20||this.y>n+20||this.y+this.height<-20}}class Ke{constructor(t,n,i=-120,r=0,c="drone"){this.x=t,this.y=n,this.vx=i,this.vy=r,this.variant=c,c==="tank"?(this.width=34,this.height=26,this.health=3):(this.width=24,this.height=18,this.health=1)}update(t){this.x+=this.vx*t,this.y+=this.vy*t}isOffScreen(){return this.x+this.width<-40}}class He{constructor(t,n,i){this.width=16,this.height=16,this.vx=-80,this.vy=0,this.x=t,this.y=n,this.type=i}update(t){this.x+=this.vx*t,this.y+=this.vy*t}isOffScreen(){return this.x+this.width<-40}}const Me="scores:v1",$t="playerName";function oe(){try{const h=localStorage.getItem(Me);if(!h)return[];const t=JSON.parse(h);return Array.isArray(t)?t.map(n=>({score:Number(n.score)||0,date:Number(n.date)||Date.now(),name:typeof n.name=="string"?n.name:void 0})).filter(n=>n.score>=0&&Number.isFinite(n.date)):[]}catch{return[]}}function ae(h){try{localStorage.setItem(Me,JSON.stringify(h))}catch{}}const tt={addScore(h,t=Date.now(),n){const i=oe(),r=(n??localStorage.getItem($t)??"Anon").toString().slice(0,18).trim()||"Anon";i.push({score:Math.max(0,Math.floor(h)),date:t,name:r}),i.sort((f,l)=>l.score-f.score||l.date-f.date);const c=i.slice(0,10);ae(c)},getTop(h=5){const t=oe();return t.sort((n,i)=>i.score-n.score||i.date-n.date),t.slice(0,h)},clear(){ae([])},getPlayerName(){try{return localStorage.getItem($t)}catch{return null}},setPlayerName(h){try{localStorage.setItem($t,(h||"").toString().slice(0,18).trim()||"Anon")}catch{}}},It=class It{constructor(){var t;this._reducedMotion=!1,this._usingSystemPreference=!0;try{const n=localStorage.getItem(It.STORAGE_KEY);if(n!=null)this._reducedMotion=n==="1",this._usingSystemPreference=!1;else if(typeof window<"u"&&"matchMedia"in window){const i=window.matchMedia("(prefers-reduced-motion: reduce)");this._reducedMotion=i.matches,this._usingSystemPreference=!0;try{(t=i.addEventListener)==null||t.call(i,"change",r=>{this._usingSystemPreference&&(this._reducedMotion=r.matches)})}catch{}}}catch{}}get reducedMotion(){return this._reducedMotion}set reducedMotion(t){this._reducedMotion=t,this._usingSystemPreference=!1;try{localStorage.setItem(It.STORAGE_KEY,t?"1":"0")}catch{}}toggleReducedMotion(){this.reducedMotion=!this.reducedMotion}};It.STORAGE_KEY="reducedMotion";let qt=It;const it=new qt;function Ve(h,t=Math.random){let n={heal:2.2,shield:1.6,rapid:1.2,multishot:1,bigshot:.9,slowmo:.9,magnet:1};if(h<5)n.multishot*=.3,n.bigshot*=.3,n.slowmo*=.4,n.magnet*=.5,n.heal*=1.3,n.shield*=1.2;else if(h<15){const f=(h-5)/10;n.multishot*=.3+.7*f,n.bigshot*=.3+.7*f,n.slowmo*=.4+.6*f,n.magnet*=.5+.5*f}else n.rapid*=1.1,n.multishot*=1.15,n.bigshot*=1.1;const i=Object.entries(n).filter(([f,l])=>l>0),r=i.reduce((f,[,l])=>f+l,0);let c=t()*r;for(const[f,l]of i)if(c-=l,c<=0)return f;return i[i.length-1][0]}const Rt=class Rt{constructor(){this.player=new At(80,150,26,26),this.obstacles=[],this.hud=new Jt,this.timeToNext=0,this.score=0,this.best=0,this.gameOver=!1,this.paused=!1,this.speed=120,this.particles=new ve,this.shakeT=0,this.hintT=4,this.bullets=[],this.enemies=[],this.powerUps=[],this.enemyTimer=0,this.powerTimer=5,this.lastGapCenter=null,this.floats=[],this.playerName=null,this.hurtT=0,this.combo=0,this.comboT=0,this.ended=!1,this.multishotT=0,this.bigshotT=0,this.slowmoT=0,this.magnetT=0,this.rapidT=0,this.pickupBadgeT=0,this.mobileMoveX=0,this.isTouch="ontouchstart"in window,this.btnLeftDown=!1,this.btnRightDown=!1,this.btnShootDown=!1,this.btnRects=null,this.restartRect=null}init(t){this.renderer=new Zt(t.canvas,t.ctx),this.obstacles=[],this.score=0,this.timeToNext=0,this.gameOver=!1,this.paused=!1,this.speed=120,this.player.x=80,this.player.y=Math.max(0,(t.canvas.height-this.player.height)*.5),this.player.vx=0,this.player.vy=0,this.player.hp=this.player.maxHp=3,this.player.fireCooldown=0,this.bullets=[],this.enemies=[],this.powerUps=[],this.enemyTimer=2.5,this.powerTimer=5,this.hintT=4,this.shakeT=0,this.floats=[],this.lastGapCenter=null,this.ended=!1,this.btnLeftDown=this.btnRightDown=this.btnShootDown=!1,this.restartRect=null,this.multishotT=0,this.bigshotT=0,this.slowmoT=0,this.magnetT=0,this.rapidT=0;const n=()=>{const p=t.canvas.width,x=t.canvas.height,m=Math.max(60,Math.min(120,Math.floor(Math.min(p,x)*.14))),w=24;this.btnRects={left:{x:w,y:x-m-w,w:m,h:m},right:{x:w+m+16,y:x-m-w,w:m,h:m},shoot:{x:p-m-w,y:x-m-w,w:m,h:m}}},i=()=>{const p=t.canvas.width,x=t.canvas.height,m=Math.max(64,Math.min(120,Math.floor(Math.min(p,x)*.16)));this.restartRect={x:(p-m)/2,y:x*.55,w:m,h:m}},r=(p,x,m)=>{if(!this.btnRects)return!1;const w=this.btnRects[p];return x>=w.x&&x<=w.x+w.w&&m>=w.y&&m<=w.y+w.h},c=p=>{n(),this.btnLeftDown=this.btnRightDown=this.btnShootDown=!1;const x=t.canvas.getBoundingClientRect(),m=t.canvas.width/x.width,w=t.canvas.height/x.height;for(let u=0;u<p.touches.length;u++){const g=p.touches.item(u),M=(g.clientX-x.left)*m,v=(g.clientY-x.top)*w;r("left",M,v)?this.btnLeftDown=!0:r("right",M,v)?this.btnRightDown=!0:r("shoot",M,v)&&(this.btnShootDown=!0)}},f=p=>{var w;if(this.gameOver){if(p.touches!==void 0){i();const u=p,g=t.canvas.getBoundingClientRect(),M=t.canvas.width/g.width,v=t.canvas.height/g.height;for(let _=0;_<u.touches.length;_++){const E=u.touches.item(_),S=(E.clientX-g.left)*M,I=(E.clientY-g.top)*v,A=this.restartRect;if(S>=A.x&&S<=A.x+A.w&&I>=A.y&&I<=A.y+A.h){this.init(t);return}}}else{i();const u=this.restartRect,g=p,M=t.canvas.getBoundingClientRect(),v=t.canvas.width/M.width,_=t.canvas.height/M.height,E=(g.clientX-M.left)*v,S=(g.clientY-M.top)*_;if(E>=u.x&&E<=u.x+u.w&&S>=u.y&&S<=u.y+u.h){this.init(t);return}}return}if(p.touches!==void 0){const u=p;if(c(u),this.btnLeftDown||this.btnRightDown||this.btnShootDown){this.btnShootDown&&this.fireWeapon();return}const g=t.canvas.width,M=t.canvas.height,v=t.canvas.getBoundingClientRect(),_=g/v.width,E=M/v.height;let S=!1;for(let A=0;A<u.touches.length;A++){const R=u.touches.item(A),j=(R.clientX-v.left)*_,z=(R.clientY-v.top)*E;if(j>g*.7&&z>M*.6){S=!0;break}}if(S){this.fireWeapon();return}(((w=u.touches)==null?void 0:w.length)??0)>=2?this.fireWeapon():(H.jump(this.player),N.flap(),this.particles.burst(this.player.x+this.player.width*.2,this.player.y+this.player.height,it.reducedMotion?4:8,"#88ccff88"));return}const x=p.button??0,m=We(x);m==="flap"?(H.jump(this.player),N.flap()):m==="shoot"&&this.fireWeapon()};t.canvas.oncontextmenu=p=>{p.preventDefault()},t.canvas.onpointerdown=f;const l=p=>{const x=t.canvas.getBoundingClientRect();let m=0,w=0;for(let u=0;u<p.touches.length;u++){const M=p.touches.item(u).clientX-x.left;M<x.width*.45?m=1:M>x.width*.55&&(w=1)}this.mobileMoveX=w-m};t.canvas.ontouchstart=p=>{l(p),f(p)},t.canvas.ontouchmove=p=>{l(p),c(p)},t.canvas.ontouchend=p=>{l(p),c(p)};try{const p=localStorage.getItem("best");p&&(this.best=parseInt(p,10)||0)}catch{}try{this.playerName=tt.getPlayerName()}catch{this.playerName=null}document.addEventListener("visibilitychange",()=>{document.hidden&&(this.paused=!0)})}fireWeapon(){if(this.player.fireCooldown>0)return;const t=this.player.x+this.player.width,n=this.player.y+this.player.height*.5-2,i=c=>{const l=Math.cos(c)*360,p=Math.sin(c)*360,x=new qe(t,n,l,p,"player");return this.bigshotT>0&&(x.width=14,x.damage=2,x.color="#ffa6a6"),x};this.multishotT>0?(this.bullets.push(i(0-.13)),this.bullets.push(i(0)),this.bullets.push(i(0+.13))):this.bullets.push(i(0));let r=this.bigshotT>0?.22:this.multishotT>0?.2:.18;this.rapidT>0&&(r=Math.max(.08,r*.55)),this.player.fireCooldown=r,N.beep(980,.05,"square",.05)}update(t,n){var m,w;const i=n.canvas.height;if(n.input.wasPressed("KeyP")&&(this.paused=!this.paused),n.input.wasPressed("KeyR")&&this.init(n),this.paused)return;const r=this.slowmoT>0?.7:1,c=t*r;(n.input.wasPressed("Space")||n.input.wasPressed("ArrowUp")||n.input.wasPressed("KeyW"))&&(H.jump(this.player),N.flap(),this.particles.burst(this.player.x+this.player.width*.2,this.player.y+this.player.height,it.reducedMotion?4:8,"#88ccff88")),(n.input.isDown("KeyJ")||n.input.isDown("ControlLeft")||n.input.isDown("ControlRight")||this.btnShootDown)&&this.fireWeapon();const f=n.input.getMovementDirection(),l=((w=(m=n.input).getWASDHorizontal)==null?void 0:w.call(m))??(n.input.isDown("KeyD")?1:0)+(n.input.isDown("KeyA")?-1:0),p=(this.btnRightDown?1:0)-(this.btnLeftDown?1:0);if(this.player.vx=(f.x+l+this.mobileMoveX+p)*80,H.applyGravity(this.player,c),this.player.update(c),this.player.y=Math.max(0,Math.min(i-this.player.height,this.player.y)),this.timeToNext-=c,this.timeToNext<=0){const u=Math.min(1,this.score/30);this.speed=Math.min(280,120+u*140);const g=Math.max(150,230-this.score*2.2);this.timeToNext=Math.max(1.1,1.8-this.score*.02);const M=g,v=60,_=v+M/2,E=i-v-M/2,S=this.lastGapCenter??i/2,I=140+Math.min(100,this.score*2),A=Math.max(_,S-I),R=Math.min(E,S+I),j=A<=R?A+Math.random()*(R-A):Math.min(E,Math.max(_,S)),z=Math.floor(j-M/2);this.lastGapCenter=j;const V=80,$=n.canvas.width+V;this.obstacles.push(new ot($,0,V,z,this.speed)),this.obstacles.push(new ot($,z+M,V,i-(z+M),this.speed))}for(const u of this.obstacles)u.update(c);this.obstacles=this.obstacles.filter(u=>!u.isOffScreen());for(const u of this.obstacles)H.checkCollision(this.player,u)&&(this.player.hp-=1,N.hit(),this.particles.burst(this.player.x+this.player.width/2,this.player.y+this.player.height/2,it.reducedMotion?6:12,"#ff7b72aa"),this.shakeT=it.reducedMotion?0:.2,this.hurtT=.35,this.combo=0,this.comboT=0,this.player.x-=10,this.player.hp<=0&&this.finalizeGameOver());for(let u=0;u<this.obstacles.length;u+=2){const g=this.obstacles[u],M=g.x+g.width/2;!this.gameOver&&M<this.player.x&&g.counted!==!0&&(g.counted=!0,this.score+=1,this.player.passObstacle(),N.score())}if(this.enemyTimer-=c,this.enemyTimer<=0){let u=40,g=i-40;if(this.obstacles.length>=2){let V=0,$=-1/0;for(let X=0;X<this.obstacles.length-1;X+=2){const ht=this.obstacles[X];ht.x>$&&($=ht.x,V=X)}const xt=this.obstacles[V],st=this.obstacles[V+1];u=xt.height,g=st.y}const M=12,v=Math.max(0,u+M),_=Math.min(i-20,g-M-18),E=n.canvas.width+40,S=v<_?v+(_-v)*(.35+Math.random()*.3):40+Math.random()*(i-120);let I="drone";this.score>6&&Math.random()<.5&&(I="bee"),this.score>15&&Math.random()<.35&&(I="tank"),this.score>25&&Math.random()<.25&&(I="kamikaze");const R=-((I==="tank"?90:120)+Math.random()*60+this.score*1.2),j=new Ke(E,S,R,0,I);j.minY=isFinite(v)?v:20,j.maxY=isFinite(_)?_:i-40,j.phase=Math.random()*Math.PI*2,this.enemies.push(j);const z=2.4-Math.min(1.2,this.score*.03);this.enemyTimer=Math.max(.8,z+(I==="tank"?.3:0))}if(this.powerTimer-=c,this.powerTimer<=0){const u=Ve(this.score);this.powerUps.push(new He(n.canvas.width+20,80+Math.random()*(i-160),u)),this.powerTimer=8+Math.random()*6}for(const u of this.bullets)u.update(c);for(const u of this.enemies){const g=(u.phase??0)+performance.now()/1e3;if(u.variant==="kamikaze"){const E=this.player.y-6-u.y;u.vy=Math.max(-120,Math.min(120,E*2))}else u.variant==="bee"?u.vy=Math.sin(g*1.5)*55:u.variant==="tank"?u.vy=Math.sin(g*.6)*24:u.vy=Math.sin(g)*35;u.update(c);const M=u.minY??20,v=u.maxY??i-40;u.y<M&&(u.y=M),u.y+u.height>v&&(u.y=v-u.height)}for(const u of this.powerUps){if(this.magnetT>0){const g=this.player.x+this.player.width/2,M=this.player.y+this.player.height/2,v=g-(u.x+u.width/2),_=M-(u.y+u.height/2);v*v+_*_<200*200&&(u.vx+=Math.sign(v)*20,u.vy+=Math.sign(_)*20,!it.reducedMotion&&Math.random()<.25&&this.particles.burst(u.x+u.width/2,u.y+u.height/2,1,"#f472b6aa"))}u.update(c)}this.bullets=this.bullets.filter(u=>!u.isOffScreen(n.canvas.width,i)&&u.active),this.enemies=this.enemies.filter(u=>!u.isOffScreen()),this.powerUps=this.powerUps.filter(u=>!u.isOffScreen());const x=(u,g,M,v,_,E,S,I)=>u<_+S&&u+M>_&&g<E+I&&g+v>E;for(const u of this.bullets)for(const g of this.enemies)if(u.active&&x(u.x,u.y,u.width,u.height,g.x,g.y,g.width,g.height)&&(u.active=!1,g.health-=u.damage??1,this.particles.burst(g.x+g.width/2,g.y+g.height/2,it.reducedMotion?6:10,"#ffd166aa"),g.health<=0)){const M=g.x+g.width/2,v=g.y+g.height/2;this.particles.burst(M,v,it.reducedMotion?10:22,"#ffb347aa"),this.particles.burst(M,v,it.reducedMotion?8:14,"#ff7b72aa"),g.x=-9999;const _=g.variant==="tank"?Rt.KILL_POINTS+1:Rt.KILL_POINTS,E=2.2;this.comboT>0?this.combo++:this.combo=1,this.comboT=E;const S=Math.max(0,this.combo-1);this.score+=_+S,this.floats.push({x:M,y:v,text:`+${_}`,ttl:.9,vy:-32}),S>0&&(this.floats.push({x:M+14,y:v-18,text:`x${this.combo}`,ttl:.8,vy:-26}),N.combo(this.combo)),this.shakeT=it.reducedMotion?0:Math.max(this.shakeT,.12),N.score()}this.enemies=this.enemies.filter(u=>u.x>-9e3);for(const u of this.enemies)x(this.player.x,this.player.y,this.player.width,this.player.height,u.x,u.y,u.width,u.height)&&(this.player.hp-=1,N.hit(),this.particles.burst(u.x+u.width/2,u.y+u.height/2,10,"#ff7b72aa"),u.x=-9999,this.player.hp<=0&&this.finalizeGameOver());for(const u of this.powerUps)x(this.player.x,this.player.y,this.player.width,this.player.height,u.x,u.y,u.width,u.height)&&(u.type==="heal"&&(this.player.hp=Math.min(this.player.maxHp,this.player.hp+1)),u.type==="rapid"&&(this.rapidT=Math.max(this.rapidT,8)),u.type==="shield"&&(this.player.maxHp=Math.min(5,this.player.maxHp+1),this.player.hp=Math.min(this.player.maxHp,this.player.hp+1)),u.type==="multishot"&&(this.multishotT=Math.max(this.multishotT,8)),u.type==="bigshot"&&(this.bigshotT=Math.max(this.bigshotT,8)),u.type==="slowmo"&&(this.slowmoT=Math.max(this.slowmoT,3.5)),u.type==="magnet"&&(this.magnetT=Math.max(this.magnetT,8)),this.particles.burst(u.x+u.width/2,u.y+u.height/2,14,"#7ee787aa"),u.x=-9999,this.pickupBadgeT=1.4);this.particles.update(c),this.shakeT=Math.max(0,this.shakeT-t),this.hurtT=Math.max(0,this.hurtT-t),this.comboT>0&&(this.comboT=Math.max(0,this.comboT-t)),this.slowmoT=Math.max(0,this.slowmoT-t),this.multishotT=Math.max(0,this.multishotT-t),this.bigshotT=Math.max(0,this.bigshotT-t),this.magnetT=Math.max(0,this.magnetT-t),this.rapidT=Math.max(0,this.rapidT-t);for(const u of this.floats)u.ttl-=t,u.y+=u.vy*t;this.floats=this.floats.filter(u=>u.ttl>0),this.hintT=Math.max(0,this.hintT-t)}finalizeGameOver(){if(this.ended)return;this.ended=!0,this.gameOver=!0,this.best=Math.max(this.best,this.score);try{localStorage.setItem("best",String(this.best))}catch{}let t=tt.getPlayerName()||"";try{const n=typeof window<"u"?window.prompt("Name for high score?",t||"Anon"):null;n!=null&&(t=n,tt.setPlayerName(t))}catch{}tt.addScore(this.score,Date.now(),t),this.playerName=t}render(t,n){const i=this.shakeT>0?(Math.random()-.5)*8:0;t.save(),t.translate(i,i),this.renderer.clear(1/60);for(const f of this.obstacles)this.renderer.drawObstacle(f);for(const f of this.enemies)this.renderer.drawEnemy(f);for(const f of this.powerUps)this.renderer.drawPowerUp(f);const r=this.hurtT>0?"#f87171":"#58a6ff";if(this.renderer.drawPlayer(this.player,r),this.playerName){const f=this.playerName.slice(0,18),l=this.player.x+this.player.width/2;let p=this.player.y-6;p<14&&(p=this.player.y+this.player.height+14),t.save(),t.textAlign="center",t.font="600 12px system-ui",t.lineWidth=3,t.strokeStyle="#00000077",t.strokeText(f,l,p),t.fillStyle="#cdd9e5",t.fillText(f,l,p),t.restore()}for(const f of this.bullets)this.renderer.drawProjectile(f);this.particles.render(t),this.hud.render(t,this.score,void 0,this.player.hp);{const f=[{active:this.rapidT>0,color:"#f7b84a",glyph:"R",rem:this.rapidT,dur:8},{active:this.multishotT>0,color:"#38bdf8",glyph:"M",rem:this.multishotT,dur:8},{active:this.bigshotT>0,color:"#fb7185",glyph:"B",rem:this.bigshotT,dur:8},{active:this.slowmoT>0,color:"#a78bfa",glyph:"⌛",rem:this.slowmoT,dur:3.5},{active:this.magnetT>0,color:"#f472b6",glyph:"U",rem:this.magnetT,dur:8}],p=16+(this.player.hp??0)*18+12;let x=p,m=36;const w=12,u=12,g=3,M=6,v=n.canvas.width-16;for(const _ of f){if(!_.active)continue;x+w>v&&(x=p,m+=u+6),t.save(),t.globalAlpha=.95,t.fillStyle=_.color,t.beginPath(),t.roundRect(x,m+2,w,u,g),t.fill();const E=Math.max(0,Math.min(1,_.rem/_.dur));t.strokeStyle="#0f172a",t.lineWidth=1.5,t.beginPath(),t.arc(x+w/2,m+2+u/2,6,-Math.PI/2,-Math.PI/2+E*Math.PI*2),t.stroke(),t.fillStyle="#0f172a",t.font="700 9px system-ui";const S=t.measureText(_.glyph).width;t.fillText(_.glyph,x+(w-S)/2,m+11),t.restore(),x+=w+M}}if(this.pickupBadgeT>0){const f=Math.min(1,this.pickupBadgeT/1.4);t.save(),t.globalAlpha=f*.9;const l=[{label:"Rapid",active:this.rapidT>0,color:"#f7b84a"},{label:"Multi",active:this.multishotT>0,color:"#38bdf8"},{label:"Big",active:this.bigshotT>0,color:"#fb7185"},{label:"Slow",active:this.slowmoT>0,color:"#a78bfa"},{label:"Mag",active:this.magnetT>0,color:"#f472b6"}].filter(m=>m.active);let p=16,x=82;for(const m of l)t.fillStyle="#0f172acc",t.beginPath(),t.roundRect(p,x,86,22,8),t.fill(),t.fillStyle=m.color+"dd",t.beginPath(),t.roundRect(p+2,x+2,82,18,6),t.strokeStyle=m.color+"66",t.lineWidth=2,t.stroke(),t.fillStyle="#e8e8f0",t.font="700 12px system-ui",t.fillText(m.label,p+10,x+15),p+=94;t.restore()}if(this.slowmoT>0){const f=Math.min(.25,.15+this.slowmoT/4*.1);t.save(),t.globalAlpha=f,t.fillStyle="#0b1022",t.fillRect(0,0,n.canvas.width,n.canvas.height),t.restore()}const c=[];if(this.rapidT>0&&c.push({label:"Rapid",t:this.rapidT,d:8,color:"#f7b84a"}),this.multishotT>0&&c.push({label:"Multi",t:this.multishotT,d:8,color:"#38bdf8"}),this.bigshotT>0&&c.push({label:"Big",t:this.bigshotT,d:8,color:"#fb7185"}),this.slowmoT>0&&c.push({label:"Slow",t:this.slowmoT,d:4,color:"#a78bfa"}),this.magnetT>0&&c.push({label:"Mag",t:this.magnetT,d:8,color:"#f472b6"}),c.length){let f=16,l=56;for(const p of c){t.save(),t.globalAlpha=.9,t.fillStyle="#0f172acc",t.beginPath(),t.roundRect(f,l,74,20,8),t.fill();const u=Math.max(0,Math.min(1,p.t/p.d));t.fillStyle=p.color+"aa",t.beginPath(),t.roundRect(f+2,l+20-6,70*u,4,3),t.fill(),t.fillStyle="#e8e8f0",t.font="600 12px system-ui",t.fillText(p.label,f+8,l+14),t.restore(),f+=82}}if(this.comboT>0&&this.combo>1&&(t.save(),t.fillStyle="#ffd166",t.font="700 14px system-ui",t.fillText(`Combo x${this.combo}`,16,46),t.restore()),this.floats.length)for(const f of this.floats){const l=Math.max(0,Math.min(1,f.ttl/.9));t.save(),t.globalAlpha=l,t.fillStyle="#ffd166",t.font="700 18px system-ui",t.fillText(f.text,f.x,f.y),t.restore()}if(this.isTouch){const f=n.canvas.width,l=n.canvas.height,p=Math.max(60,Math.min(120,Math.floor(Math.min(f,l)*.14))),x=24;this.btnRects={left:{x,y:l-p-x,w:p,h:p},right:{x:x+p+16,y:l-p-x,w:p,h:p},shoot:{x:f-p-x,y:l-p-x,w:p,h:p}};const m=(w,u,g)=>{t.save(),t.globalAlpha=.5,t.fillStyle=u?"#58a6ff":"#0f172a",t.strokeStyle="#58a6ff88",t.lineWidth=4,t.beginPath(),t.roundRect(w.x,w.y,w.w,w.h,16),t.fill(),t.stroke(),t.fillStyle="#e8e8f0",t.font="700 28px system-ui";const M=g==="L"?"◀":g==="R"?"▶":"●",v=t.measureText(M).width;t.fillText(M,w.x+(w.w-v)/2,w.y+w.h/2+10),t.restore()};m(this.btnRects.left,this.btnLeftDown,"L"),m(this.btnRects.right,this.btnRightDown,"R"),m(this.btnRects.shoot,this.btnShootDown,"S")}if(this.hintT>0){const f=Math.min(.8,this.hintT/4);t.save(),t.globalAlpha=f,t.fillStyle="#00000088",t.fillRect(20,70,520,56),t.fillStyle="#e8e8f0",t.font="600 16px system-ui",t.fillText("Flap: Space/ArrowUp/W or Click • Move: Arrows or A/D • Shoot: Right Click or Ctrl/J (hold)",28,100),t.restore()}if(t.restore(),this.paused&&(t.fillStyle="#00000088",t.fillRect(0,0,n.canvas.width,n.canvas.height),t.fillStyle="#e8e8f0",t.font="700 28px system-ui",t.fillText("Paused (P). R = Restart, Esc = Title",40,120)),this.gameOver){t.fillStyle="#00000088",t.fillRect(0,0,n.canvas.width,n.canvas.height),t.fillStyle="#e8e8f0",t.font="700 28px system-ui",t.fillText(`Game Over — Score ${this.score}  Best ${this.best}`,40,120),t.font="500 18px system-ui",t.fillText("Press R or tap the restart button",40,160);const f=n.canvas.width,l=n.canvas.height,p=Math.max(64,Math.min(120,Math.floor(Math.min(f,l)*.16))),x=(f-p)/2,m=l*.55;this.restartRect={x,y:m,w:p,h:p},t.save(),t.globalAlpha=.9,t.fillStyle="#0f172a",t.strokeStyle="#58a6ff88",t.lineWidth=5,t.beginPath(),t.roundRect(x,m,p,p,18),t.fill(),t.stroke(),t.fillStyle="#e8e8f0",t.font="700 28px system-ui",t.fillText("⟲",x+p/2-10,m+p/2+12),t.restore()}}};Rt.KILL_POINTS=2;let kt=Rt;class Kt{constructor(){this.p1=new At(80,140,26,26),this.p2=new At(120,220,26,26),this.obstacles=[],this.hud=new Jt,this.timeToNext=0,this.s1=0,this.s2=0,this.paused=!1,this.speed=140,this.particles=new ve,this.shakeT=0}init(t){this.renderer=new Zt(t.canvas,t.ctx),this.obstacles=[],this.timeToNext=0,this.s1=0,this.s2=0,this.paused=!1,this.speed=140;const n=()=>{H.jump(this.p1),N.flap()};t.canvas.ontouchstart=n,t.canvas.onpointerdown=n}update(t,n){const i=n.canvas.height;if(n.input.wasPressed("KeyP")&&(this.paused=!this.paused),n.input.wasPressed("KeyR")&&this.init(n),this.paused)return;(n.input.wasPressed("Space")||n.input.wasPressed("ArrowUp"))&&(H.jump(this.p1),N.flap(),this.particles.burst(this.p1.x,this.p1.y+this.p1.height,6,"#88ccff88")),n.input.wasPressed("KeyW")&&(H.jump(this.p2),N.flap(),this.particles.burst(this.p2.x,this.p2.y+this.p2.height,6,"#ffb08888"));const r=n.input.getMovementDirection();if(this.p1.vx=r.x*80,this.p2.vx=0,this.p2.vy+=(n.input.isDown("KeyS")?1:0)*300*t,H.applyGravity(this.p1,t),H.applyGravity(this.p2,t),this.p1.update(t),this.p2.update(t),this.p1.y=Math.max(0,Math.min(i-this.p1.height,this.p1.y)),this.p2.y=Math.max(0,Math.min(i-this.p2.height,this.p2.y)),this.timeToNext-=t,this.timeToNext<=0){this.speed=Math.min(260,this.speed+2);const c=Math.max(130,180-Math.max(this.s1,this.s2)*2);this.timeToNext=Math.max(1,1.7-Math.max(this.s1,this.s2)*.02);const f=40,l=i-c-40,p=Math.floor(Math.random()*(l-f+1))+f,x=80,m=n.canvas.width+x;this.obstacles.push(new ot(m,0,x,p,this.speed)),this.obstacles.push(new ot(m,p+c,x,i-(p+c),this.speed))}for(const c of this.obstacles)c.update(t);this.obstacles=this.obstacles.filter(c=>!c.isOffScreen());for(const c of this.obstacles)if(H.checkCollision(this.p1,c)||H.checkCollision(this.p2,c)){N.hit(),this.particles.burst((this.p1.x+this.p2.x)/2,(this.p1.y+this.p2.y)/2,16,"#ff7b72aa"),this.shakeT=.25,this.init(n);return}for(let c=0;c<this.obstacles.length;c+=2){const f=this.obstacles[c],l=f.x+f.width/2;l<this.p1.x&&f.p1c!==!0&&(f.p1c=!0,this.s1+=1,this.p1.passObstacle(),N.score()),l<this.p2.x&&f.p2c!==!0&&(f.p2c=!0,this.s2+=1,this.p2.passObstacle(),N.score())}}render(t,n){const i=this.shakeT>0?(Math.random()-.5)*8:0;t.save(),t.translate(i,i),this.renderer.clear(1/60);for(const r of this.obstacles)this.renderer.drawObstacle(r);this.renderer.drawPlayer(this.p1,"#58a6ff"),this.renderer.drawPlayer(this.p2,"#ff7b72"),this.particles.render(t),this.hud.render(t,this.s1,this.s2),t.restore(),this.paused&&(t.fillStyle="#00000088",t.fillRect(0,0,n.canvas.width,n.canvas.height),t.fillStyle="#e8e8f0",t.font="700 28px system-ui",t.fillText("Paused (P). R = Restart, Esc = Title",40,120))}}class Ht extends Error{constructor(t){super(t),this.name="AbortError"}}function Ye(h,t){const{cleanupBeforeAbort:n,abortSignal:i,abortErrorMsg:r}=t??{};return new Promise((c,f)=>{function l(){f(new Ht(r??"The operation was aborted."))}function p(){i==null||i.removeEventListener("abort",x)}function x(){n==null||n(),p(),l()}if(i!=null&&i.aborted)return l();try{h(m=>{p(),c(m)},m=>{p(),f(m)})}catch(m){f(m)}i==null||i.addEventListener("abort",x)})}const ze="The delay was aborted.";function Ft(h,t){let n;const{abortSignal:i,abortErrorMsg:r}={};return Ye(c=>{n=setTimeout(c,h)},{cleanupBeforeAbort:()=>clearTimeout(n),abortSignal:i,abortErrorMsg:r??ze})}function Xe(h){return h&&h.__esModule&&Object.prototype.hasOwnProperty.call(h,"default")?h.default:h}var Qt={exports:{}},bt=typeof Reflect=="object"?Reflect:null,he=bt&&typeof bt.apply=="function"?bt.apply:function(t,n,i){return Function.prototype.apply.call(t,n,i)},Dt;bt&&typeof bt.ownKeys=="function"?Dt=bt.ownKeys:Object.getOwnPropertySymbols?Dt=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:Dt=function(t){return Object.getOwnPropertyNames(t)};function Je(h){console&&console.warn&&console.warn(h)}var _e=Number.isNaN||function(t){return t!==t};function k(){k.init.call(this)}Qt.exports=k;Qt.exports.once=ei;k.EventEmitter=k;k.prototype._events=void 0;k.prototype._eventsCount=0;k.prototype._maxListeners=void 0;var le=10;function Nt(h){if(typeof h!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof h)}Object.defineProperty(k,"defaultMaxListeners",{enumerable:!0,get:function(){return le},set:function(h){if(typeof h!="number"||h<0||_e(h))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+h+".");le=h}});k.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};k.prototype.setMaxListeners=function(t){if(typeof t!="number"||t<0||_e(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function Se(h){return h._maxListeners===void 0?k.defaultMaxListeners:h._maxListeners}k.prototype.getMaxListeners=function(){return Se(this)};k.prototype.emit=function(t){for(var n=[],i=1;i<arguments.length;i++)n.push(arguments[i]);var r=t==="error",c=this._events;if(c!==void 0)r=r&&c.error===void 0;else if(!r)return!1;if(r){var f;if(n.length>0&&(f=n[0]),f instanceof Error)throw f;var l=new Error("Unhandled error."+(f?" ("+f.message+")":""));throw l.context=f,l}var p=c[t];if(p===void 0)return!1;if(typeof p=="function")he(p,this,n);else for(var x=p.length,m=Ae(p,x),i=0;i<x;++i)he(m[i],this,n);return!0};function Ee(h,t,n,i){var r,c,f;if(Nt(n),c=h._events,c===void 0?(c=h._events=Object.create(null),h._eventsCount=0):(c.newListener!==void 0&&(h.emit("newListener",t,n.listener?n.listener:n),c=h._events),f=c[t]),f===void 0)f=c[t]=n,++h._eventsCount;else if(typeof f=="function"?f=c[t]=i?[n,f]:[f,n]:i?f.unshift(n):f.push(n),r=Se(h),r>0&&f.length>r&&!f.warned){f.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+f.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=h,l.type=t,l.count=f.length,Je(l)}return h}k.prototype.addListener=function(t,n){return Ee(this,t,n,!1)};k.prototype.on=k.prototype.addListener;k.prototype.prependListener=function(t,n){return Ee(this,t,n,!0)};function Ze(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Te(h,t,n){var i={fired:!1,wrapFn:void 0,target:h,type:t,listener:n},r=Ze.bind(i);return r.listener=n,i.wrapFn=r,r}k.prototype.once=function(t,n){return Nt(n),this.on(t,Te(this,t,n)),this};k.prototype.prependOnceListener=function(t,n){return Nt(n),this.prependListener(t,Te(this,t,n)),this};k.prototype.removeListener=function(t,n){var i,r,c,f,l;if(Nt(n),r=this._events,r===void 0)return this;if(i=r[t],i===void 0)return this;if(i===n||i.listener===n)--this._eventsCount===0?this._events=Object.create(null):(delete r[t],r.removeListener&&this.emit("removeListener",t,i.listener||n));else if(typeof i!="function"){for(c=-1,f=i.length-1;f>=0;f--)if(i[f]===n||i[f].listener===n){l=i[f].listener,c=f;break}if(c<0)return this;c===0?i.shift():Qe(i,c),i.length===1&&(r[t]=i[0]),r.removeListener!==void 0&&this.emit("removeListener",t,l||n)}return this};k.prototype.off=k.prototype.removeListener;k.prototype.removeAllListeners=function(t){var n,i,r;if(i=this._events,i===void 0)return this;if(i.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):i[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete i[t]),this;if(arguments.length===0){var c=Object.keys(i),f;for(r=0;r<c.length;++r)f=c[r],f!=="removeListener"&&this.removeAllListeners(f);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(n=i[t],typeof n=="function")this.removeListener(t,n);else if(n!==void 0)for(r=n.length-1;r>=0;r--)this.removeListener(t,n[r]);return this};function Ie(h,t,n){var i=h._events;if(i===void 0)return[];var r=i[t];return r===void 0?[]:typeof r=="function"?n?[r.listener||r]:[r]:n?ti(r):Ae(r,r.length)}k.prototype.listeners=function(t){return Ie(this,t,!0)};k.prototype.rawListeners=function(t){return Ie(this,t,!1)};k.listenerCount=function(h,t){return typeof h.listenerCount=="function"?h.listenerCount(t):Re.call(h,t)};k.prototype.listenerCount=Re;function Re(h){var t=this._events;if(t!==void 0){var n=t[h];if(typeof n=="function")return 1;if(n!==void 0)return n.length}return 0}k.prototype.eventNames=function(){return this._eventsCount>0?Dt(this._events):[]};function Ae(h,t){for(var n=new Array(t),i=0;i<t;++i)n[i]=h[i];return n}function Qe(h,t){for(;t+1<h.length;t++)h[t]=h[t+1];h.pop()}function ti(h){for(var t=new Array(h.length),n=0;n<t.length;++n)t[n]=h[n].listener||h[n];return t}function ei(h,t){return new Promise(function(n,i){function r(f){h.removeListener(t,c),i(f)}function c(){typeof h.removeListener=="function"&&h.removeListener("error",r),n([].slice.call(arguments))}ke(h,t,c,{once:!0}),t!=="error"&&ii(h,r,{once:!0})})}function ii(h,t,n){typeof h.on=="function"&&ke(h,"error",t,n)}function ke(h,t,n,i){if(typeof h.on=="function")i.once?h.once(t,n):h.on(t,n);else if(typeof h.addEventListener=="function")h.addEventListener(t,function r(c){i.once&&h.removeEventListener(t,r),n(c)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof h)}var si=Qt.exports;const ni=Xe(si);class Ot extends Error{constructor(t,n){super(t),this.name="SendMessageError",this.ackId=n.ackId,this.errorDetail=n.errorDetail}}function ri(...h){if(h.length>0){const t=String(h[0]);t.includes(":error")?console.error(...h):t.includes(":warning")?console.warn(...h):t.includes(":info")?console.info(...h):t.includes(":verbose")?console.debug(...h):console.debug(...h)}}var ce={};const fe=typeof process<"u"&&ce&&ce.DEBUG||void 0;let Be,Vt=[],Yt=[];const Ut=[];fe&&te(fe);const wt=Object.assign(h=>Ce(h),{enable:te,enabled:ee,disable:oi,log:ri});function te(h){Be=h,Vt=[],Yt=[];const t=/\*/g,n=h.split(",").map(i=>i.trim().replace(t,".*?"));for(const i of n)i.startsWith("-")?Yt.push(new RegExp(`^${i.substr(1)}$`)):Vt.push(new RegExp(`^${i}$`));for(const i of Ut)i.enabled=ee(i.namespace)}function ee(h){if(h.endsWith("*"))return!0;for(const t of Yt)if(t.test(h))return!1;for(const t of Vt)if(t.test(h))return!0;return!1}function oi(){const h=Be||"";return te(""),h}function Ce(h){const t=Object.assign(n,{enabled:ee(h),destroy:ai,log:wt.log,namespace:h,extend:hi});function n(...i){t.enabled&&(i.length>0&&(i[0]=`${h} ${i[0]}`),t.log(...i))}return Ut.push(t),t}function ai(){const h=Ut.indexOf(this);return h>=0?(Ut.splice(h,1),!0):!1}function hi(h){const t=Ce(`${this.namespace}:${h}`);return t.log=this.log,t}var ue={};const zt=["verbose","info","warning","error"],de={verbose:400,info:300,warning:200,error:100};function pe(h,t){t.log=(...n)=>{h.log(...n)}}function ye(h){return zt.includes(h)}function Pe(h){const t=new Set,n=typeof process<"u"&&ue&&ue[h.logLevelEnvVarName]||void 0;let i;const r=wt(h.namespace);r.log=(...m)=>{wt.log(...m)};function c(m){if(m&&!ye(m))throw new Error(`Unknown log level '${m}'. Acceptable values: ${zt.join(",")}`);i=m;const w=[];for(const u of t)f(u)&&w.push(u.namespace);wt.enable(w.join(","))}n&&(ye(n)?c(n):console.error(`${h.logLevelEnvVarName} set to unknown log level '${n}'; logging is not enabled. Acceptable values: ${zt.join(", ")}.`));function f(m){return!!(i&&de[m.level]<=de[i])}function l(m,w){const u=Object.assign(m.extend(w),{level:w});if(pe(m,u),f(u)){const g=wt.disable();wt.enable(g+","+u.namespace)}return t.add(u),u}function p(){return i}function x(m){const w=r.extend(m);return pe(r,w),{error:l(w,"error"),warning:l(w,"warning"),info:l(w,"info"),verbose:l(w,"verbose")}}return{setLogLevel:c,getLogLevel:p,createClientLogger:x,logger:r}}Pe({logLevelEnvVarName:"TYPESPEC_RUNTIME_LOG_LEVEL",namespace:"typeSpecRuntime"});const li=Pe({logLevelEnvVarName:"AZURE_LOG_LEVEL",namespace:"azure"});function ci(h){return li.createClientLogger(h)}const K=ci("web-pubsub-client");var ie={},jt={};jt.byteLength=di;jt.toByteArray=yi;jt.fromByteArray=gi;var at=[],Q=[],fi=typeof Uint8Array<"u"?Uint8Array:Array,Wt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var mt=0,ui=Wt.length;mt<ui;++mt)at[mt]=Wt[mt],Q[Wt.charCodeAt(mt)]=mt;Q[45]=62;Q[95]=63;function Le(h){var t=h.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=h.indexOf("=");n===-1&&(n=t);var i=n===t?0:4-n%4;return[n,i]}function di(h){var t=Le(h),n=t[0],i=t[1];return(n+i)*3/4-i}function pi(h,t,n){return(t+n)*3/4-n}function yi(h){var t,n=Le(h),i=n[0],r=n[1],c=new fi(pi(h,i,r)),f=0,l=r>0?i-4:i,p;for(p=0;p<l;p+=4)t=Q[h.charCodeAt(p)]<<18|Q[h.charCodeAt(p+1)]<<12|Q[h.charCodeAt(p+2)]<<6|Q[h.charCodeAt(p+3)],c[f++]=t>>16&255,c[f++]=t>>8&255,c[f++]=t&255;return r===2&&(t=Q[h.charCodeAt(p)]<<2|Q[h.charCodeAt(p+1)]>>4,c[f++]=t&255),r===1&&(t=Q[h.charCodeAt(p)]<<10|Q[h.charCodeAt(p+1)]<<4|Q[h.charCodeAt(p+2)]>>2,c[f++]=t>>8&255,c[f++]=t&255),c}function mi(h){return at[h>>18&63]+at[h>>12&63]+at[h>>6&63]+at[h&63]}function wi(h,t,n){for(var i,r=[],c=t;c<n;c+=3)i=(h[c]<<16&16711680)+(h[c+1]<<8&65280)+(h[c+2]&255),r.push(mi(i));return r.join("")}function gi(h){for(var t,n=h.length,i=n%3,r=[],c=16383,f=0,l=n-i;f<l;f+=c)r.push(wi(h,f,f+c>l?l:f+c));return i===1?(t=h[n-1],r.push(at[t>>2]+at[t<<4&63]+"==")):i===2&&(t=(h[n-2]<<8)+h[n-1],r.push(at[t>>10]+at[t>>4&63]+at[t<<2&63]+"=")),r.join("")}var se={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */se.read=function(h,t,n,i,r){var c,f,l=r*8-i-1,p=(1<<l)-1,x=p>>1,m=-7,w=n?r-1:0,u=n?-1:1,g=h[t+w];for(w+=u,c=g&(1<<-m)-1,g>>=-m,m+=l;m>0;c=c*256+h[t+w],w+=u,m-=8);for(f=c&(1<<-m)-1,c>>=-m,m+=i;m>0;f=f*256+h[t+w],w+=u,m-=8);if(c===0)c=1-x;else{if(c===p)return f?NaN:(g?-1:1)*(1/0);f=f+Math.pow(2,i),c=c-x}return(g?-1:1)*f*Math.pow(2,c-i)};se.write=function(h,t,n,i,r,c){var f,l,p,x=c*8-r-1,m=(1<<x)-1,w=m>>1,u=r===23?Math.pow(2,-24)-Math.pow(2,-77):0,g=i?0:c-1,M=i?1:-1,v=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(l=isNaN(t)?1:0,f=m):(f=Math.floor(Math.log(t)/Math.LN2),t*(p=Math.pow(2,-f))<1&&(f--,p*=2),f+w>=1?t+=u/p:t+=u*Math.pow(2,1-w),t*p>=2&&(f++,p/=2),f+w>=m?(l=0,f=m):f+w>=1?(l=(t*p-1)*Math.pow(2,r),f=f+w):(l=t*Math.pow(2,w-1)*Math.pow(2,r),f=0));r>=8;h[n+g]=l&255,g+=M,l/=256,r-=8);for(f=f<<r|l,x+=r;x>0;h[n+g]=f&255,g+=M,f/=256,x-=8);h[n+g-M]|=v*128};/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(h){const t=jt,n=se,i=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;h.Buffer=l,h.SlowBuffer=S,h.INSPECT_MAX_BYTES=50;const r=2147483647;h.kMaxLength=r,l.TYPED_ARRAY_SUPPORT=c(),!l.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function c(){try{const o=new Uint8Array(1),e={foo:function(){return 42}};return Object.setPrototypeOf(e,Uint8Array.prototype),Object.setPrototypeOf(o,e),o.foo()===42}catch{return!1}}Object.defineProperty(l.prototype,"parent",{enumerable:!0,get:function(){if(l.isBuffer(this))return this.buffer}}),Object.defineProperty(l.prototype,"offset",{enumerable:!0,get:function(){if(l.isBuffer(this))return this.byteOffset}});function f(o){if(o>r)throw new RangeError('The value "'+o+'" is invalid for option "size"');const e=new Uint8Array(o);return Object.setPrototypeOf(e,l.prototype),e}function l(o,e,s){if(typeof o=="number"){if(typeof e=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return w(o)}return p(o,e,s)}l.poolSize=8192;function p(o,e,s){if(typeof o=="string")return u(o,e);if(ArrayBuffer.isView(o))return M(o);if(o==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof o);if(rt(o,ArrayBuffer)||o&&rt(o.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(rt(o,SharedArrayBuffer)||o&&rt(o.buffer,SharedArrayBuffer)))return v(o,e,s);if(typeof o=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const a=o.valueOf&&o.valueOf();if(a!=null&&a!==o)return l.from(a,e,s);const d=_(o);if(d)return d;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof o[Symbol.toPrimitive]=="function")return l.from(o[Symbol.toPrimitive]("string"),e,s);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof o)}l.from=function(o,e,s){return p(o,e,s)},Object.setPrototypeOf(l.prototype,Uint8Array.prototype),Object.setPrototypeOf(l,Uint8Array);function x(o){if(typeof o!="number")throw new TypeError('"size" argument must be of type number');if(o<0)throw new RangeError('The value "'+o+'" is invalid for option "size"')}function m(o,e,s){return x(o),o<=0?f(o):e!==void 0?typeof s=="string"?f(o).fill(e,s):f(o).fill(e):f(o)}l.alloc=function(o,e,s){return m(o,e,s)};function w(o){return x(o),f(o<0?0:E(o)|0)}l.allocUnsafe=function(o){return w(o)},l.allocUnsafeSlow=function(o){return w(o)};function u(o,e){if((typeof e!="string"||e==="")&&(e="utf8"),!l.isEncoding(e))throw new TypeError("Unknown encoding: "+e);const s=I(o,e)|0;let a=f(s);const d=a.write(o,e);return d!==s&&(a=a.slice(0,d)),a}function g(o){const e=o.length<0?0:E(o.length)|0,s=f(e);for(let a=0;a<e;a+=1)s[a]=o[a]&255;return s}function M(o){if(rt(o,Uint8Array)){const e=new Uint8Array(o);return v(e.buffer,e.byteOffset,e.byteLength)}return g(o)}function v(o,e,s){if(e<0||o.byteLength<e)throw new RangeError('"offset" is outside of buffer bounds');if(o.byteLength<e+(s||0))throw new RangeError('"length" is outside of buffer bounds');let a;return e===void 0&&s===void 0?a=new Uint8Array(o):s===void 0?a=new Uint8Array(o,e):a=new Uint8Array(o,e,s),Object.setPrototypeOf(a,l.prototype),a}function _(o){if(l.isBuffer(o)){const e=E(o.length)|0,s=f(e);return s.length===0||o.copy(s,0,0,e),s}if(o.length!==void 0)return typeof o.length!="number"||Gt(o.length)?f(0):g(o);if(o.type==="Buffer"&&Array.isArray(o.data))return g(o.data)}function E(o){if(o>=r)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+r.toString(16)+" bytes");return o|0}function S(o){return+o!=o&&(o=0),l.alloc(+o)}l.isBuffer=function(e){return e!=null&&e._isBuffer===!0&&e!==l.prototype},l.compare=function(e,s){if(rt(e,Uint8Array)&&(e=l.from(e,e.offset,e.byteLength)),rt(s,Uint8Array)&&(s=l.from(s,s.offset,s.byteLength)),!l.isBuffer(e)||!l.isBuffer(s))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===s)return 0;let a=e.length,d=s.length;for(let y=0,b=Math.min(a,d);y<b;++y)if(e[y]!==s[y]){a=e[y],d=s[y];break}return a<d?-1:d<a?1:0},l.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},l.concat=function(e,s){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(e.length===0)return l.alloc(0);let a;if(s===void 0)for(s=0,a=0;a<e.length;++a)s+=e[a].length;const d=l.allocUnsafe(s);let y=0;for(a=0;a<e.length;++a){let b=e[a];if(rt(b,Uint8Array))y+b.length>d.length?(l.isBuffer(b)||(b=l.from(b)),b.copy(d,y)):Uint8Array.prototype.set.call(d,b,y);else if(l.isBuffer(b))b.copy(d,y);else throw new TypeError('"list" argument must be an Array of Buffers');y+=b.length}return d};function I(o,e){if(l.isBuffer(o))return o.length;if(ArrayBuffer.isView(o)||rt(o,ArrayBuffer))return o.byteLength;if(typeof o!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof o);const s=o.length,a=arguments.length>2&&arguments[2]===!0;if(!a&&s===0)return 0;let d=!1;for(;;)switch(e){case"ascii":case"latin1":case"binary":return s;case"utf8":case"utf-8":return lt(o).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return s*2;case"hex":return s>>>1;case"base64":return re(o).length;default:if(d)return a?-1:lt(o).length;e=(""+e).toLowerCase(),d=!0}}l.byteLength=I;function A(o,e,s){let a=!1;if((e===void 0||e<0)&&(e=0),e>this.length||((s===void 0||s>this.length)&&(s=this.length),s<=0)||(s>>>=0,e>>>=0,s<=e))return"";for(o||(o="utf8");;)switch(o){case"hex":return Bt(this,e,s);case"utf8":case"utf-8":return ft(this,e,s);case"ascii":return dt(this,e,s);case"latin1":case"binary":return Mt(this,e,s);case"base64":return ht(this,e,s);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return _t(this,e,s);default:if(a)throw new TypeError("Unknown encoding: "+o);o=(o+"").toLowerCase(),a=!0}}l.prototype._isBuffer=!0;function R(o,e,s){const a=o[e];o[e]=o[s],o[s]=a}l.prototype.swap16=function(){const e=this.length;if(e%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let s=0;s<e;s+=2)R(this,s,s+1);return this},l.prototype.swap32=function(){const e=this.length;if(e%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let s=0;s<e;s+=4)R(this,s,s+3),R(this,s+1,s+2);return this},l.prototype.swap64=function(){const e=this.length;if(e%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let s=0;s<e;s+=8)R(this,s,s+7),R(this,s+1,s+6),R(this,s+2,s+5),R(this,s+3,s+4);return this},l.prototype.toString=function(){const e=this.length;return e===0?"":arguments.length===0?ft(this,0,e):A.apply(this,arguments)},l.prototype.toLocaleString=l.prototype.toString,l.prototype.equals=function(e){if(!l.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e?!0:l.compare(this,e)===0},l.prototype.inspect=function(){let e="";const s=h.INSPECT_MAX_BYTES;return e=this.toString("hex",0,s).replace(/(.{2})/g,"$1 ").trim(),this.length>s&&(e+=" ... "),"<Buffer "+e+">"},i&&(l.prototype[i]=l.prototype.inspect),l.prototype.compare=function(e,s,a,d,y){if(rt(e,Uint8Array)&&(e=l.from(e,e.offset,e.byteLength)),!l.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(s===void 0&&(s=0),a===void 0&&(a=e?e.length:0),d===void 0&&(d=0),y===void 0&&(y=this.length),s<0||a>e.length||d<0||y>this.length)throw new RangeError("out of range index");if(d>=y&&s>=a)return 0;if(d>=y)return-1;if(s>=a)return 1;if(s>>>=0,a>>>=0,d>>>=0,y>>>=0,this===e)return 0;let b=y-d,T=a-s;const O=Math.min(b,T),L=this.slice(d,y),F=e.slice(s,a);for(let B=0;B<O;++B)if(L[B]!==F[B]){b=L[B],T=F[B];break}return b<T?-1:T<b?1:0};function j(o,e,s,a,d){if(o.length===0)return-1;if(typeof s=="string"?(a=s,s=0):s>2147483647?s=2147483647:s<-2147483648&&(s=-2147483648),s=+s,Gt(s)&&(s=d?0:o.length-1),s<0&&(s=o.length+s),s>=o.length){if(d)return-1;s=o.length-1}else if(s<0)if(d)s=0;else return-1;if(typeof e=="string"&&(e=l.from(e,a)),l.isBuffer(e))return e.length===0?-1:z(o,e,s,a,d);if(typeof e=="number")return e=e&255,typeof Uint8Array.prototype.indexOf=="function"?d?Uint8Array.prototype.indexOf.call(o,e,s):Uint8Array.prototype.lastIndexOf.call(o,e,s):z(o,[e],s,a,d);throw new TypeError("val must be string, number or Buffer")}function z(o,e,s,a,d){let y=1,b=o.length,T=e.length;if(a!==void 0&&(a=String(a).toLowerCase(),a==="ucs2"||a==="ucs-2"||a==="utf16le"||a==="utf-16le")){if(o.length<2||e.length<2)return-1;y=2,b/=2,T/=2,s/=2}function O(F,B){return y===1?F[B]:F.readUInt16BE(B*y)}let L;if(d){let F=-1;for(L=s;L<b;L++)if(O(o,L)===O(e,F===-1?0:L-F)){if(F===-1&&(F=L),L-F+1===T)return F*y}else F!==-1&&(L-=L-F),F=-1}else for(s+T>b&&(s=b-T),L=s;L>=0;L--){let F=!0;for(let B=0;B<T;B++)if(O(o,L+B)!==O(e,B)){F=!1;break}if(F)return L}return-1}l.prototype.includes=function(e,s,a){return this.indexOf(e,s,a)!==-1},l.prototype.indexOf=function(e,s,a){return j(this,e,s,a,!0)},l.prototype.lastIndexOf=function(e,s,a){return j(this,e,s,a,!1)};function V(o,e,s,a){s=Number(s)||0;const d=o.length-s;a?(a=Number(a),a>d&&(a=d)):a=d;const y=e.length;a>y/2&&(a=y/2);let b;for(b=0;b<a;++b){const T=parseInt(e.substr(b*2,2),16);if(Gt(T))return b;o[s+b]=T}return b}function $(o,e,s,a){return Lt(lt(e,o.length-s),o,s,a)}function xt(o,e,s,a){return Lt(Fe(e),o,s,a)}function st(o,e,s,a){return Lt(re(e),o,s,a)}function X(o,e,s,a){return Lt(De(e,o.length-s),o,s,a)}l.prototype.write=function(e,s,a,d){if(s===void 0)d="utf8",a=this.length,s=0;else if(a===void 0&&typeof s=="string")d=s,a=this.length,s=0;else if(isFinite(s))s=s>>>0,isFinite(a)?(a=a>>>0,d===void 0&&(d="utf8")):(d=a,a=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const y=this.length-s;if((a===void 0||a>y)&&(a=y),e.length>0&&(a<0||s<0)||s>this.length)throw new RangeError("Attempt to write outside buffer bounds");d||(d="utf8");let b=!1;for(;;)switch(d){case"hex":return V(this,e,s,a);case"utf8":case"utf-8":return $(this,e,s,a);case"ascii":case"latin1":case"binary":return xt(this,e,s,a);case"base64":return st(this,e,s,a);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return X(this,e,s,a);default:if(b)throw new TypeError("Unknown encoding: "+d);d=(""+d).toLowerCase(),b=!0}},l.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function ht(o,e,s){return e===0&&s===o.length?t.fromByteArray(o):t.fromByteArray(o.slice(e,s))}function ft(o,e,s){s=Math.min(o.length,s);const a=[];let d=e;for(;d<s;){const y=o[d];let b=null,T=y>239?4:y>223?3:y>191?2:1;if(d+T<=s){let O,L,F,B;switch(T){case 1:y<128&&(b=y);break;case 2:O=o[d+1],(O&192)===128&&(B=(y&31)<<6|O&63,B>127&&(b=B));break;case 3:O=o[d+1],L=o[d+2],(O&192)===128&&(L&192)===128&&(B=(y&15)<<12|(O&63)<<6|L&63,B>2047&&(B<55296||B>57343)&&(b=B));break;case 4:O=o[d+1],L=o[d+2],F=o[d+3],(O&192)===128&&(L&192)===128&&(F&192)===128&&(B=(y&15)<<18|(O&63)<<12|(L&63)<<6|F&63,B>65535&&B<1114112&&(b=B))}}b===null?(b=65533,T=1):b>65535&&(b-=65536,a.push(b>>>10&1023|55296),b=56320|b&1023),a.push(b),d+=T}return ut(a)}const vt=4096;function ut(o){const e=o.length;if(e<=vt)return String.fromCharCode.apply(String,o);let s="",a=0;for(;a<e;)s+=String.fromCharCode.apply(String,o.slice(a,a+=vt));return s}function dt(o,e,s){let a="";s=Math.min(o.length,s);for(let d=e;d<s;++d)a+=String.fromCharCode(o[d]&127);return a}function Mt(o,e,s){let a="";s=Math.min(o.length,s);for(let d=e;d<s;++d)a+=String.fromCharCode(o[d]);return a}function Bt(o,e,s){const a=o.length;(!e||e<0)&&(e=0),(!s||s<0||s>a)&&(s=a);let d="";for(let y=e;y<s;++y)d+=Ue[o[y]];return d}function _t(o,e,s){const a=o.slice(e,s);let d="";for(let y=0;y<a.length-1;y+=2)d+=String.fromCharCode(a[y]+a[y+1]*256);return d}l.prototype.slice=function(e,s){const a=this.length;e=~~e,s=s===void 0?a:~~s,e<0?(e+=a,e<0&&(e=0)):e>a&&(e=a),s<0?(s+=a,s<0&&(s=0)):s>a&&(s=a),s<e&&(s=e);const d=this.subarray(e,s);return Object.setPrototypeOf(d,l.prototype),d};function D(o,e,s){if(o%1!==0||o<0)throw new RangeError("offset is not uint");if(o+e>s)throw new RangeError("Trying to access beyond buffer length")}l.prototype.readUintLE=l.prototype.readUIntLE=function(e,s,a){e=e>>>0,s=s>>>0,a||D(e,s,this.length);let d=this[e],y=1,b=0;for(;++b<s&&(y*=256);)d+=this[e+b]*y;return d},l.prototype.readUintBE=l.prototype.readUIntBE=function(e,s,a){e=e>>>0,s=s>>>0,a||D(e,s,this.length);let d=this[e+--s],y=1;for(;s>0&&(y*=256);)d+=this[e+--s]*y;return d},l.prototype.readUint8=l.prototype.readUInt8=function(e,s){return e=e>>>0,s||D(e,1,this.length),this[e]},l.prototype.readUint16LE=l.prototype.readUInt16LE=function(e,s){return e=e>>>0,s||D(e,2,this.length),this[e]|this[e+1]<<8},l.prototype.readUint16BE=l.prototype.readUInt16BE=function(e,s){return e=e>>>0,s||D(e,2,this.length),this[e]<<8|this[e+1]},l.prototype.readUint32LE=l.prototype.readUInt32LE=function(e,s){return e=e>>>0,s||D(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+this[e+3]*16777216},l.prototype.readUint32BE=l.prototype.readUInt32BE=function(e,s){return e=e>>>0,s||D(e,4,this.length),this[e]*16777216+(this[e+1]<<16|this[e+2]<<8|this[e+3])},l.prototype.readBigUInt64LE=ct(function(e){e=e>>>0,W(e,"offset");const s=this[e],a=this[e+7];(s===void 0||a===void 0)&&Z(e,this.length-8);const d=s+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24,y=this[++e]+this[++e]*2**8+this[++e]*2**16+a*2**24;return BigInt(d)+(BigInt(y)<<BigInt(32))}),l.prototype.readBigUInt64BE=ct(function(e){e=e>>>0,W(e,"offset");const s=this[e],a=this[e+7];(s===void 0||a===void 0)&&Z(e,this.length-8);const d=s*2**24+this[++e]*2**16+this[++e]*2**8+this[++e],y=this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+a;return(BigInt(d)<<BigInt(32))+BigInt(y)}),l.prototype.readIntLE=function(e,s,a){e=e>>>0,s=s>>>0,a||D(e,s,this.length);let d=this[e],y=1,b=0;for(;++b<s&&(y*=256);)d+=this[e+b]*y;return y*=128,d>=y&&(d-=Math.pow(2,8*s)),d},l.prototype.readIntBE=function(e,s,a){e=e>>>0,s=s>>>0,a||D(e,s,this.length);let d=s,y=1,b=this[e+--d];for(;d>0&&(y*=256);)b+=this[e+--d]*y;return y*=128,b>=y&&(b-=Math.pow(2,8*s)),b},l.prototype.readInt8=function(e,s){return e=e>>>0,s||D(e,1,this.length),this[e]&128?(255-this[e]+1)*-1:this[e]},l.prototype.readInt16LE=function(e,s){e=e>>>0,s||D(e,2,this.length);const a=this[e]|this[e+1]<<8;return a&32768?a|4294901760:a},l.prototype.readInt16BE=function(e,s){e=e>>>0,s||D(e,2,this.length);const a=this[e+1]|this[e]<<8;return a&32768?a|4294901760:a},l.prototype.readInt32LE=function(e,s){return e=e>>>0,s||D(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},l.prototype.readInt32BE=function(e,s){return e=e>>>0,s||D(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},l.prototype.readBigInt64LE=ct(function(e){e=e>>>0,W(e,"offset");const s=this[e],a=this[e+7];(s===void 0||a===void 0)&&Z(e,this.length-8);const d=this[e+4]+this[e+5]*2**8+this[e+6]*2**16+(a<<24);return(BigInt(d)<<BigInt(32))+BigInt(s+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24)}),l.prototype.readBigInt64BE=ct(function(e){e=e>>>0,W(e,"offset");const s=this[e],a=this[e+7];(s===void 0||a===void 0)&&Z(e,this.length-8);const d=(s<<24)+this[++e]*2**16+this[++e]*2**8+this[++e];return(BigInt(d)<<BigInt(32))+BigInt(this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+a)}),l.prototype.readFloatLE=function(e,s){return e=e>>>0,s||D(e,4,this.length),n.read(this,e,!0,23,4)},l.prototype.readFloatBE=function(e,s){return e=e>>>0,s||D(e,4,this.length),n.read(this,e,!1,23,4)},l.prototype.readDoubleLE=function(e,s){return e=e>>>0,s||D(e,8,this.length),n.read(this,e,!0,52,8)},l.prototype.readDoubleBE=function(e,s){return e=e>>>0,s||D(e,8,this.length),n.read(this,e,!1,52,8)};function q(o,e,s,a,d,y){if(!l.isBuffer(o))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>d||e<y)throw new RangeError('"value" argument is out of bounds');if(s+a>o.length)throw new RangeError("Index out of range")}l.prototype.writeUintLE=l.prototype.writeUIntLE=function(e,s,a,d){if(e=+e,s=s>>>0,a=a>>>0,!d){const T=Math.pow(2,8*a)-1;q(this,e,s,a,T,0)}let y=1,b=0;for(this[s]=e&255;++b<a&&(y*=256);)this[s+b]=e/y&255;return s+a},l.prototype.writeUintBE=l.prototype.writeUIntBE=function(e,s,a,d){if(e=+e,s=s>>>0,a=a>>>0,!d){const T=Math.pow(2,8*a)-1;q(this,e,s,a,T,0)}let y=a-1,b=1;for(this[s+y]=e&255;--y>=0&&(b*=256);)this[s+y]=e/b&255;return s+a},l.prototype.writeUint8=l.prototype.writeUInt8=function(e,s,a){return e=+e,s=s>>>0,a||q(this,e,s,1,255,0),this[s]=e&255,s+1},l.prototype.writeUint16LE=l.prototype.writeUInt16LE=function(e,s,a){return e=+e,s=s>>>0,a||q(this,e,s,2,65535,0),this[s]=e&255,this[s+1]=e>>>8,s+2},l.prototype.writeUint16BE=l.prototype.writeUInt16BE=function(e,s,a){return e=+e,s=s>>>0,a||q(this,e,s,2,65535,0),this[s]=e>>>8,this[s+1]=e&255,s+2},l.prototype.writeUint32LE=l.prototype.writeUInt32LE=function(e,s,a){return e=+e,s=s>>>0,a||q(this,e,s,4,4294967295,0),this[s+3]=e>>>24,this[s+2]=e>>>16,this[s+1]=e>>>8,this[s]=e&255,s+4},l.prototype.writeUint32BE=l.prototype.writeUInt32BE=function(e,s,a){return e=+e,s=s>>>0,a||q(this,e,s,4,4294967295,0),this[s]=e>>>24,this[s+1]=e>>>16,this[s+2]=e>>>8,this[s+3]=e&255,s+4};function pt(o,e,s,a,d){et(e,a,d,o,s,7);let y=Number(e&BigInt(4294967295));o[s++]=y,y=y>>8,o[s++]=y,y=y>>8,o[s++]=y,y=y>>8,o[s++]=y;let b=Number(e>>BigInt(32)&BigInt(4294967295));return o[s++]=b,b=b>>8,o[s++]=b,b=b>>8,o[s++]=b,b=b>>8,o[s++]=b,s}function Ct(o,e,s,a,d){et(e,a,d,o,s,7);let y=Number(e&BigInt(4294967295));o[s+7]=y,y=y>>8,o[s+6]=y,y=y>>8,o[s+5]=y,y=y>>8,o[s+4]=y;let b=Number(e>>BigInt(32)&BigInt(4294967295));return o[s+3]=b,b=b>>8,o[s+2]=b,b=b>>8,o[s+1]=b,b=b>>8,o[s]=b,s+8}l.prototype.writeBigUInt64LE=ct(function(e,s=0){return pt(this,e,s,BigInt(0),BigInt("0xffffffffffffffff"))}),l.prototype.writeBigUInt64BE=ct(function(e,s=0){return Ct(this,e,s,BigInt(0),BigInt("0xffffffffffffffff"))}),l.prototype.writeIntLE=function(e,s,a,d){if(e=+e,s=s>>>0,!d){const O=Math.pow(2,8*a-1);q(this,e,s,a,O-1,-O)}let y=0,b=1,T=0;for(this[s]=e&255;++y<a&&(b*=256);)e<0&&T===0&&this[s+y-1]!==0&&(T=1),this[s+y]=(e/b>>0)-T&255;return s+a},l.prototype.writeIntBE=function(e,s,a,d){if(e=+e,s=s>>>0,!d){const O=Math.pow(2,8*a-1);q(this,e,s,a,O-1,-O)}let y=a-1,b=1,T=0;for(this[s+y]=e&255;--y>=0&&(b*=256);)e<0&&T===0&&this[s+y+1]!==0&&(T=1),this[s+y]=(e/b>>0)-T&255;return s+a},l.prototype.writeInt8=function(e,s,a){return e=+e,s=s>>>0,a||q(this,e,s,1,127,-128),e<0&&(e=255+e+1),this[s]=e&255,s+1},l.prototype.writeInt16LE=function(e,s,a){return e=+e,s=s>>>0,a||q(this,e,s,2,32767,-32768),this[s]=e&255,this[s+1]=e>>>8,s+2},l.prototype.writeInt16BE=function(e,s,a){return e=+e,s=s>>>0,a||q(this,e,s,2,32767,-32768),this[s]=e>>>8,this[s+1]=e&255,s+2},l.prototype.writeInt32LE=function(e,s,a){return e=+e,s=s>>>0,a||q(this,e,s,4,2147483647,-2147483648),this[s]=e&255,this[s+1]=e>>>8,this[s+2]=e>>>16,this[s+3]=e>>>24,s+4},l.prototype.writeInt32BE=function(e,s,a){return e=+e,s=s>>>0,a||q(this,e,s,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[s]=e>>>24,this[s+1]=e>>>16,this[s+2]=e>>>8,this[s+3]=e&255,s+4},l.prototype.writeBigInt64LE=ct(function(e,s=0){return pt(this,e,s,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),l.prototype.writeBigInt64BE=ct(function(e,s=0){return Ct(this,e,s,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function St(o,e,s,a,d,y){if(s+a>o.length)throw new RangeError("Index out of range");if(s<0)throw new RangeError("Index out of range")}function Pt(o,e,s,a,d){return e=+e,s=s>>>0,d||St(o,e,s,4),n.write(o,e,s,a,23,4),s+4}l.prototype.writeFloatLE=function(e,s,a){return Pt(this,e,s,!0,a)},l.prototype.writeFloatBE=function(e,s,a){return Pt(this,e,s,!1,a)};function C(o,e,s,a,d){return e=+e,s=s>>>0,d||St(o,e,s,8),n.write(o,e,s,a,52,8),s+8}l.prototype.writeDoubleLE=function(e,s,a){return C(this,e,s,!0,a)},l.prototype.writeDoubleBE=function(e,s,a){return C(this,e,s,!1,a)},l.prototype.copy=function(e,s,a,d){if(!l.isBuffer(e))throw new TypeError("argument should be a Buffer");if(a||(a=0),!d&&d!==0&&(d=this.length),s>=e.length&&(s=e.length),s||(s=0),d>0&&d<a&&(d=a),d===a||e.length===0||this.length===0)return 0;if(s<0)throw new RangeError("targetStart out of bounds");if(a<0||a>=this.length)throw new RangeError("Index out of range");if(d<0)throw new RangeError("sourceEnd out of bounds");d>this.length&&(d=this.length),e.length-s<d-a&&(d=e.length-s+a);const y=d-a;return this===e&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(s,a,d):Uint8Array.prototype.set.call(e,this.subarray(a,d),s),y},l.prototype.fill=function(e,s,a,d){if(typeof e=="string"){if(typeof s=="string"?(d=s,s=0,a=this.length):typeof a=="string"&&(d=a,a=this.length),d!==void 0&&typeof d!="string")throw new TypeError("encoding must be a string");if(typeof d=="string"&&!l.isEncoding(d))throw new TypeError("Unknown encoding: "+d);if(e.length===1){const b=e.charCodeAt(0);(d==="utf8"&&b<128||d==="latin1")&&(e=b)}}else typeof e=="number"?e=e&255:typeof e=="boolean"&&(e=Number(e));if(s<0||this.length<s||this.length<a)throw new RangeError("Out of range index");if(a<=s)return this;s=s>>>0,a=a===void 0?this.length:a>>>0,e||(e=0);let y;if(typeof e=="number")for(y=s;y<a;++y)this[y]=e;else{const b=l.isBuffer(e)?e:l.from(e,d),T=b.length;if(T===0)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(y=0;y<a-s;++y)this[y+s]=b[y%T]}return this};const U={};function P(o,e,s){U[o]=class extends s{constructor(){super(),Object.defineProperty(this,"message",{value:e.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${o}]`,this.stack,delete this.name}get code(){return o}set code(d){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:d,writable:!0})}toString(){return`${this.name} [${o}]: ${this.message}`}}}P("ERR_BUFFER_OUT_OF_BOUNDS",function(o){return o?`${o} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),P("ERR_INVALID_ARG_TYPE",function(o,e){return`The "${o}" argument must be of type number. Received type ${typeof e}`},TypeError),P("ERR_OUT_OF_RANGE",function(o,e,s){let a=`The value of "${o}" is out of range.`,d=s;return Number.isInteger(s)&&Math.abs(s)>2**32?d=G(String(s)):typeof s=="bigint"&&(d=String(s),(s>BigInt(2)**BigInt(32)||s<-(BigInt(2)**BigInt(32)))&&(d=G(d)),d+="n"),a+=` It must be ${e}. Received ${d}`,a},RangeError);function G(o){let e="",s=o.length;const a=o[0]==="-"?1:0;for(;s>=a+4;s-=3)e=`_${o.slice(s-3,s)}${e}`;return`${o.slice(0,s)}${e}`}function J(o,e,s){W(e,"offset"),(o[e]===void 0||o[e+s]===void 0)&&Z(e,o.length-(s+1))}function et(o,e,s,a,d,y){if(o>s||o<e){const b=typeof e=="bigint"?"n":"";let T;throw e===0||e===BigInt(0)?T=`>= 0${b} and < 2${b} ** ${(y+1)*8}${b}`:T=`>= -(2${b} ** ${(y+1)*8-1}${b}) and < 2 ** ${(y+1)*8-1}${b}`,new U.ERR_OUT_OF_RANGE("value",T,o)}J(a,d,y)}function W(o,e){if(typeof o!="number")throw new U.ERR_INVALID_ARG_TYPE(e,"number",o)}function Z(o,e,s){throw Math.floor(o)!==o?(W(o,s),new U.ERR_OUT_OF_RANGE("offset","an integer",o)):e<0?new U.ERR_BUFFER_OUT_OF_BOUNDS:new U.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${e}`,o)}const nt=/[^+/0-9A-Za-z-_]/g;function yt(o){if(o=o.split("=")[0],o=o.trim().replace(nt,""),o.length<2)return"";for(;o.length%4!==0;)o=o+"=";return o}function lt(o,e){e=e||1/0;let s;const a=o.length;let d=null;const y=[];for(let b=0;b<a;++b){if(s=o.charCodeAt(b),s>55295&&s<57344){if(!d){if(s>56319){(e-=3)>-1&&y.push(239,191,189);continue}else if(b+1===a){(e-=3)>-1&&y.push(239,191,189);continue}d=s;continue}if(s<56320){(e-=3)>-1&&y.push(239,191,189),d=s;continue}s=(d-55296<<10|s-56320)+65536}else d&&(e-=3)>-1&&y.push(239,191,189);if(d=null,s<128){if((e-=1)<0)break;y.push(s)}else if(s<2048){if((e-=2)<0)break;y.push(s>>6|192,s&63|128)}else if(s<65536){if((e-=3)<0)break;y.push(s>>12|224,s>>6&63|128,s&63|128)}else if(s<1114112){if((e-=4)<0)break;y.push(s>>18|240,s>>12&63|128,s>>6&63|128,s&63|128)}else throw new Error("Invalid code point")}return y}function Fe(o){const e=[];for(let s=0;s<o.length;++s)e.push(o.charCodeAt(s)&255);return e}function De(o,e){let s,a,d;const y=[];for(let b=0;b<o.length&&!((e-=2)<0);++b)s=o.charCodeAt(b),a=s>>8,d=s%256,y.push(d),y.push(a);return y}function re(o){return t.toByteArray(yt(o))}function Lt(o,e,s,a){let d;for(d=0;d<a&&!(d+s>=e.length||d>=o.length);++d)e[d+s]=o[d];return d}function rt(o,e){return o instanceof e||o!=null&&o.constructor!=null&&o.constructor.name!=null&&o.constructor.name===e.name}function Gt(o){return o!==o}const Ue=function(){const o="0123456789abcdef",e=new Array(256);for(let s=0;s<16;++s){const a=s*16;for(let d=0;d<16;++d)e[a+d]=o[s]+o[d]}return e}();function ct(o){return typeof BigInt>"u"?Ne:o}function Ne(){throw new Error("BigInt not supported")}})(ie);function bi(h){if(typeof h!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!h)throw new Error("No input");const t=JSON.parse(h),n=t;let i;if(n.type==="system")if(n.event==="connected")i=Object.assign(Object.assign({},t),{kind:"connected"});else if(n.event==="disconnected")i=Object.assign(Object.assign({},t),{kind:"disconnected"});else return null;else if(n.type==="message")if(n.from==="group"){const r=we(t.data,t.dataType);if(r===null)return null;i=Object.assign(Object.assign({},t),{data:r,kind:"groupData"})}else if(n.from==="server"){const r=we(t.data,t.dataType);if(r===null)return null;i=Object.assign(Object.assign({},t),{data:r,kind:"serverData"})}else return null;else if(n.type==="ack")i=Object.assign(Object.assign({},t),{kind:"ack"});else return null;return i}function xi(h){let t;switch(h.kind){case"joinGroup":{t={type:"joinGroup",group:h.group,ackId:h.ackId};break}case"leaveGroup":{t={type:"leaveGroup",group:h.group,ackId:h.ackId};break}case"sendEvent":{t={type:"event",event:h.event,ackId:h.ackId,dataType:h.dataType,data:me(h.data,h.dataType)};break}case"sendToGroup":{t={type:"sendToGroup",group:h.group,ackId:h.ackId,dataType:h.dataType,data:me(h.data,h.dataType),noEcho:h.noEcho};break}case"sequenceAck":{t={type:"sequenceAck",sequenceId:h.sequenceId};break}default:throw new Error(`Unsupported type: ${h.kind}`)}return JSON.stringify(t)}function me(h,t){switch(t){case"text":{if(typeof h!="string")throw new TypeError("Message must be a string.");return h}case"json":return h;case"binary":case"protobuf":{if(h instanceof ArrayBuffer)return ie.Buffer.from(h).toString("base64");throw new TypeError("Message must be a ArrayBuffer")}}}function we(h,t){if(t==="text"){if(typeof h!="string")throw new TypeError("Message must be a string when dataType is text");return h}else{if(t==="json")return h;if(t==="binary"||t==="protobuf"){const n=ie.Buffer.from(h,"base64");return n.buffer.slice(n.byteOffset,n.byteOffset+n.byteLength)}else return null}}class vi{constructor(){this.isReliableSubProtocol=!0,this.name="json.reliable.webpubsub.azure.v1"}parseMessages(t){return bi(t)}writeMessage(t){return xi(t)}}const Mi=()=>new vi;class _i{constructor(t,n){this._socket=new WebSocket(t,n),this._socket.binaryType="arraybuffer"}onopen(t){this._socket.onopen=t}onclose(t){this._socket.onclose=n=>t(n.code,n.reason)}onerror(t){this._socket.onerror=n=>t(n)}onmessage(t){this._socket.onmessage=n=>t(n.data)}close(t,n){this._socket.close(t,n)}send(t,n){return new Promise((i,r)=>{try{this._socket.send(t),i()}catch(c){r(c)}})}isOpen(){return this._socket.readyState===WebSocket.OPEN}}class Si{create(t,n){return new _i(t,n)}}async function Ei(h,t){if(t.aborted)throw new Ht("The operation was aborted.");let n;const i=new Promise((r,c)=>{n=()=>{c(new Ht("The operation was aborted."))},t.addEventListener("abort",n)});try{return await Promise.race([h,i])}finally{t.removeEventListener("abort",n)}}var Y;(function(h){h.Stopped="Stopped",h.Disconnected="Disconnected",h.Connecting="Connecting",h.Connected="Connected",h.Recovering="Recovering"})(Y||(Y={}));class Ti{nextAckId(){return this._ackId=this._ackId+1,this._ackId}constructor(t,n){this._quickSequenceAckDiff=300,this._activeTimeoutInMs=2e4,this._emitter=new ni,this._isStopping=!1,this._isInitialConnected=!1,typeof t=="string"?this._credential={getClientAccessUrl:t}:this._credential=t,n==null&&(n={}),this._buildDefaultOptions(n),this._options=n,this._messageRetryPolicy=new ge(this._options.messageRetryOptions),this._reconnectRetryPolicy=new ge(this._options.reconnectRetryOptions),this._protocol=this._options.protocol,this._groupMap=new Map,this._ackMap=new Map,this._sequenceId=new Ai,this._state=Y.Stopped,this._ackId=0}async start(t){if(this._isStopping)throw new Error("Can't start a client during stopping");if(this._state!==Y.Stopped)throw new Error("Client can be only started when it's Stopped");let n;t&&(n=t.abortSignal),this._activeKeepaliveTask||(this._activeKeepaliveTask=this._getActiveKeepaliveTask());try{await this._startCore(n)}catch(i){throw this._changeState(Y.Stopped),this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0),this._isStopping=!1,i}}async _startFromRestarting(t){if(this._state!==Y.Disconnected)throw new Error("Client can be only restarted when it's Disconnected");try{K.verbose("Staring reconnecting."),await this._startCore(t)}catch(n){throw this._changeState(Y.Disconnected),n}}async _startCore(t){if(this._changeState(Y.Connecting),K.info("Staring a new connection"),this._sequenceId.reset(),this._isInitialConnected=!1,this._lastCloseEvent=void 0,this._lastDisconnectedMessage=void 0,this._connectionId=void 0,this._reconnectionToken=void 0,this._uri=void 0,typeof this._credential.getClientAccessUrl=="string"?this._uri=this._credential.getClientAccessUrl:this._uri=await this._credential.getClientAccessUrl({abortSignal:t}),typeof this._uri!="string")throw new Error(`The clientAccessUrl must be a string but currently it's ${typeof this._uri}`);await this._connectCore(this._uri)}stop(){this._state===Y.Stopped||this._isStopping||(this._isStopping=!0,this._wsClient&&this._wsClient.isOpen()?this._wsClient.close():this._isStopping=!1,this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0))}on(t,n){this._emitter.on(t,n)}off(t,n){this._emitter.removeListener(t,n)}_emitEvent(t,n){this._emitter.emit(t,n)}async sendEvent(t,n,i,r){return this._operationExecuteWithRetry(()=>this._sendEventAttempt(t,n,i,r),r==null?void 0:r.abortSignal)}async _sendEventAttempt(t,n,i,r){var c;if(!((c=r==null?void 0:r.fireAndForget)!==null&&c!==void 0?c:!1))return this._sendMessageWithAckId(p=>({kind:"sendEvent",dataType:i,data:n,ackId:p,event:t}),r==null?void 0:r.ackId,r==null?void 0:r.abortSignal);const l={kind:"sendEvent",dataType:i,data:n,event:t};return await this._sendMessage(l,r==null?void 0:r.abortSignal),{isDuplicated:!1}}async joinGroup(t,n){return this._operationExecuteWithRetry(()=>this._joinGroupAttempt(t,n),n==null?void 0:n.abortSignal)}async _joinGroupAttempt(t,n){const i=this._getOrAddGroup(t),r=await this._joinGroupCore(t,n);return i.isJoined=!0,r}async _joinGroupCore(t,n){return this._sendMessageWithAckId(i=>({group:t,ackId:i,kind:"joinGroup"}),n==null?void 0:n.ackId,n==null?void 0:n.abortSignal)}async leaveGroup(t,n){return this._operationExecuteWithRetry(()=>this._leaveGroupAttempt(t,n),n==null?void 0:n.abortSignal)}async _leaveGroupAttempt(t,n){const i=this._getOrAddGroup(t),r=await this._sendMessageWithAckId(c=>({group:t,ackId:c,kind:"leaveGroup"}),n==null?void 0:n.ackId,n==null?void 0:n.abortSignal);return i.isJoined=!1,r}async sendToGroup(t,n,i,r){return this._operationExecuteWithRetry(()=>this._sendToGroupAttempt(t,n,i,r),r==null?void 0:r.abortSignal)}async _sendToGroupAttempt(t,n,i,r){var c,f;const l=(c=r==null?void 0:r.fireAndForget)!==null&&c!==void 0?c:!1,p=(f=r==null?void 0:r.noEcho)!==null&&f!==void 0?f:!1;if(!l)return this._sendMessageWithAckId(m=>({kind:"sendToGroup",group:t,dataType:i,data:n,ackId:m,noEcho:p}),r==null?void 0:r.ackId,r==null?void 0:r.abortSignal);const x={kind:"sendToGroup",group:t,dataType:i,data:n,noEcho:p};return await this._sendMessage(x,r==null?void 0:r.abortSignal),{isDuplicated:!1}}_getWebSocketClientFactory(){return new Si}async _trySendSequenceAck(){if(!this._protocol.isReliableSubProtocol)return;const[t,n]=this._sequenceId.tryGetSequenceId();if(t&&n!==null&&n!==void 0){const i={kind:"sequenceAck",sequenceId:n};try{await this._sendMessage(i)}catch{this._sequenceId.tryUpdate(n)}}}_connectCore(t){if(this._isStopping)throw new Error("Can't start a client during stopping");return new Promise((n,i)=>{const r=this._wsClient=this._getWebSocketClientFactory().create(t,this._protocol.name);r.onopen(()=>{if(this._isStopping){try{r.close()}catch{}i(new Error("The client is stopped"))}K.verbose("WebSocket connection has opened"),this._changeState(Y.Connected),this._protocol.isReliableSubProtocol&&(this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),this._sequenceAckTask=new be(async()=>{await this._trySendSequenceAck()},1e3)),n()}),r.onerror(c=>{this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),i(c)}),r.onclose((c,f)=>{this._state===Y.Connected?(K.verbose("WebSocket closed after open"),this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),K.info(`WebSocket connection closed. Code: ${c}, Reason: ${f}`),this._lastCloseEvent={code:c,reason:f},this._handleConnectionClose.call(this)):(K.verbose("WebSocket closed before open"),i(new Error(`Failed to start WebSocket: ${c}`)))}),r.onmessage(c=>{const f=u=>{if(this._ackMap.has(u.ackId)){const g=this._ackMap.get(u.ackId);this._ackMap.delete(u.ackId);const M=u.error!=null&&u.error.name==="Duplicate";u.success||M?g.resolve({ackId:u.ackId,isDuplicated:M}):g.reject(new Ot("Failed to send message.",{ackId:u.ackId,errorDetail:u.error}))}},l=async u=>{if(this._connectionId=u.connectionId,this._reconnectionToken=u.reconnectionToken,!this._isInitialConnected){if(this._isInitialConnected=!0,this._options.autoRejoinGroups){const g=[];this._groupMap.forEach(M=>{M.isJoined&&g.push((async()=>{try{await this._joinGroupCore(M.name)}catch(v){this._safeEmitRejoinGroupFailed(M.name,v)}})())}),await Promise.all(g).catch(()=>{})}this._safeEmitConnected(u.connectionId,u.userId)}},p=u=>{this._lastDisconnectedMessage=u},x=u=>{if(u.sequenceId!=null){const g=this._sequenceId.tryUpdate(u.sequenceId);if(g===0)return;g>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitGroupMessage(u)},m=u=>{if(u.sequenceId!=null){const g=this._sequenceId.tryUpdate(u.sequenceId);if(g===0)return;g>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitServerMessage(u)};let w;try{let u;if(Array.isArray(c)?u=Buffer.concat(c):u=c,w=this._protocol.parseMessages(u),w===null)return}catch(u){throw K.warning("An error occurred while parsing the message from service",u),u}Array.isArray(w)||(w=[w]),w.forEach(u=>{try{switch(u.kind){case"ack":{f(u);break}case"connected":{l(u);break}case"disconnected":{p(u);break}case"groupData":{x(u);break}case"serverData":{m(u);break}}}catch(g){K.warning(`An error occurred while handling the message with kind: ${u.kind} from service`,g)}})})})}async _handleConnectionCloseAndNoRecovery(){this._state=Y.Disconnected,this._safeEmitDisconnected(this._connectionId,this._lastDisconnectedMessage),this._options.autoReconnect?await this._autoReconnect():await this._handleConnectionStopped()}async _autoReconnect(){let t=!1,n=0;try{for(;!this._isStopping;)try{await this._startFromRestarting(),t=!0;break}catch(i){K.warning("An attempt to reconnect connection failed.",i),n++;const r=this._reconnectRetryPolicy.nextRetryDelayInMs(n);if(r==null)break;K.verbose(`Delay time for reconnect attempt ${n}: ${r}`),await Ft(r).catch(()=>{})}}finally{t||this._handleConnectionStopped()}}_handleConnectionStopped(){this._isStopping=!1,this._state=Y.Stopped,this._safeEmitStopped()}_getActiveKeepaliveTask(){return new be(async()=>{this._sequenceId.tryUpdate(0)},this._activeTimeoutInMs)}async _sendMessage(t,n){if(!this._wsClient||!this._wsClient.isOpen())throw new Error("The connection is not connected.");const i=this._protocol.writeMessage(t);await this._wsClient.send(i,n)}async _sendMessageWithAckId(t,n,i){n==null&&(n=this.nextAckId());const r=t(n);this._ackMap.has(n)||this._ackMap.set(n,new Ri(n));const c=this._ackMap.get(n);try{await this._sendMessage(r,i)}catch(f){this._ackMap.delete(n);let l="";throw f instanceof Error&&(l=f.message),new Ot(l,{ackId:n})}if(i)try{return await Ei(c.promise(),i)}catch(f){throw f instanceof Error&&f.name==="AbortError"?new Ot("Cancelled by abortSignal",{ackId:n}):f}return c.promise()}async _handleConnectionClose(){if(this._ackMap.forEach((r,c)=>{this._ackMap.delete(c)&&r.reject(new Ot("Connection is disconnected before receive ack from the service",{ackId:r.ackId}))}),this._isStopping){K.warning("The client is stopping state. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(this._lastCloseEvent&&this._lastCloseEvent.code===1008){K.warning("The websocket close with status code 1008. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(!this._protocol.isReliableSubProtocol){K.warning("The protocol is not reliable, recovery is not applicable"),this._handleConnectionCloseAndNoRecovery();return}const t=this._buildRecoveryUri();if(!t){K.warning("Connection id or reconnection token is not available"),this._handleConnectionCloseAndNoRecovery();return}let n=!1;this._state=Y.Recovering;const i=AbortSignal.timeout(30*1e3);try{for(;!i.aborted||this._isStopping;)try{await this._connectCore.call(this,t),n=!0;return}catch{await Ft(1e3)}}finally{n||(K.warning("Recovery attempts failed more then 30 seconds or the client is stopping"),this._handleConnectionCloseAndNoRecovery())}}_safeEmitConnected(t,n){this._emitEvent("connected",{connectionId:t,userId:n})}_safeEmitDisconnected(t,n){this._emitEvent("disconnected",{connectionId:t,message:n})}_safeEmitGroupMessage(t){this._emitEvent("group-message",{message:t})}_safeEmitServerMessage(t){this._emitEvent("server-message",{message:t})}_safeEmitStopped(){this._emitEvent("stopped",{})}_safeEmitRejoinGroupFailed(t,n){this._emitEvent("rejoin-group-failed",{group:t,error:n})}_buildDefaultOptions(t){return t.autoReconnect==null&&(t.autoReconnect=!0),t.autoRejoinGroups==null&&(t.autoRejoinGroups=!0),t.protocol==null&&(t.protocol=Mi()),this._buildMessageRetryOptions(t),this._buildReconnectRetryOptions(t),t}_buildMessageRetryOptions(t){t.messageRetryOptions||(t.messageRetryOptions={}),(t.messageRetryOptions.maxRetries==null||t.messageRetryOptions.maxRetries<0)&&(t.messageRetryOptions.maxRetries=3),(t.messageRetryOptions.retryDelayInMs==null||t.messageRetryOptions.retryDelayInMs<0)&&(t.messageRetryOptions.retryDelayInMs=1e3),(t.messageRetryOptions.maxRetryDelayInMs==null||t.messageRetryOptions.maxRetryDelayInMs<0)&&(t.messageRetryOptions.maxRetryDelayInMs=3e4),t.messageRetryOptions.mode==null&&(t.messageRetryOptions.mode="Fixed")}_buildReconnectRetryOptions(t){t.reconnectRetryOptions||(t.reconnectRetryOptions={}),(t.reconnectRetryOptions.maxRetries==null||t.reconnectRetryOptions.maxRetries<0)&&(t.reconnectRetryOptions.maxRetries=Number.MAX_VALUE),(t.reconnectRetryOptions.retryDelayInMs==null||t.reconnectRetryOptions.retryDelayInMs<0)&&(t.reconnectRetryOptions.retryDelayInMs=1e3),(t.reconnectRetryOptions.maxRetryDelayInMs==null||t.reconnectRetryOptions.maxRetryDelayInMs<0)&&(t.reconnectRetryOptions.maxRetryDelayInMs=3e4),t.reconnectRetryOptions.mode==null&&(t.reconnectRetryOptions.mode="Fixed")}_buildRecoveryUri(){if(this._connectionId&&this._reconnectionToken&&this._uri){const t=new URL(this._uri);return t.searchParams.append("awps_connection_id",this._connectionId),t.searchParams.append("awps_reconnection_token",this._reconnectionToken),t.toString()}return null}_getOrAddGroup(t){return this._groupMap.has(t)||this._groupMap.set(t,new Ii(t)),this._groupMap.get(t)}_changeState(t){K.verbose(`The client state transfer from ${this._state.toString()} to ${t.toString()}`),this._state=t}async _operationExecuteWithRetry(t,n){let i=0;for(;;)try{return await t.call(this)}catch(r){i++;const c=this._messageRetryPolicy.nextRetryDelayInMs(i);if(c==null||(await Ft(c),n!=null&&n.aborted))throw r}}}class ge{constructor(t){this._retryOptions=t,this._maxRetriesToGetMaxDelay=Math.ceil(Math.log2(this._retryOptions.maxRetryDelayInMs)-Math.log2(this._retryOptions.retryDelayInMs)+1)}nextRetryDelayInMs(t){return t>this._retryOptions.maxRetries?null:this._retryOptions.mode==="Fixed"?this._retryOptions.retryDelayInMs:this._calculateExponentialDelay(t)}_calculateExponentialDelay(t){return t>=this._maxRetriesToGetMaxDelay?this._retryOptions.maxRetryDelayInMs:(1<<t-1)*this._retryOptions.retryDelayInMs}}class Ii{constructor(t){this.isJoined=!1,this.name=t}}class Ri{constructor(t){this._promise=new Promise((n,i)=>{this._resolve=n,this._reject=i}),this.ackId=t}promise(){return this._promise}resolve(t){this._resolve(t)}reject(t){this._reject(t)}}class Ai{constructor(){this._sequenceId=0,this._isUpdate=!1}tryUpdate(t){if(this._isUpdate=!0,t>this._sequenceId){const n=t-this._sequenceId;return this._sequenceId=t,n}return 0}tryGetSequenceId(){return this._isUpdate?(this._isUpdate=!1,[!0,this._sequenceId]):[!1,null]}reset(){this._sequenceId=0,this._isUpdate=!1}}class be{constructor(t,n,i){this._func=t,this._abortController=new AbortController,this._interval=n,this._obj=i,this._start()}abort(){try{this._abortController.abort()}catch{}}async _start(){const t=this._abortController.signal;for(;!t.aborted;)try{await this._func(this._obj)}catch{}finally{await Ft(this._interval)}}}class xe{constructor(t){this.negotiateUrl=t,this.client=null,this.group=null,this.connected=!1,this.onDisc=[],this.onErr=[],this.mode="azure",this.bc=null,this.onMsgHandler=null,this.id=Math.random().toString(36).slice(2,8)}async connect(t){this.group=`room:${t}`;try{const n=await fetch(this.negotiateUrl,{credentials:"include"});if(!n.ok)throw new Error("negotiate failed");const{url:i}=await n.json();if(!i)throw new Error("no url");const r=new Ti(i);this.client=r,this.mode="azure",r.on("connected",()=>{this.connected=!0}),r.on("disconnected",()=>{this.connected=!1,this.onDisc.forEach(c=>c())}),r.on("stopped",()=>{this.connected=!1,this.onDisc.forEach(c=>c())}),await r.start(),await r.joinGroup(this.group),this.connected=!0}catch(n){try{this.mode="local",this.bc=new BroadcastChannel(this.group),this.bc.onmessage=i=>{var c;const r=i.data;try{(c=this.onMsgHandler)==null||c.call(this,r)}catch{}},this.connected=!0}catch{throw n}}}onMessage(t){var n;this.onMsgHandler=t,this.mode==="azure"&&((n=this.client)==null||n.on("group-message",({message:i})=>{try{t(JSON.parse(String(i.data)))}catch{}}))}onDisconnected(t){this.onDisc.push(t)}onError(t){this.onErr.push(t)}async send(t){if(!(!this.client||!this.connected||!this.group))try{this.mode==="azure"?await this.client.sendToGroup(this.group,JSON.stringify(t),"text"):this.mode==="local"&&this.bc&&this.bc.postMessage(t)}catch(n){this.onErr.forEach(i=>i(n))}}close(){var t;try{(t=this.bc)==null||t.close()}catch{}}}class Xt{constructor(t,n){this.p1=new At(80,140,26,26),this.p2=new At(120,220,26,26),this.obstacles=[],this.hud=new Jt,this.s1=0,this.s2=0,this.speed=140,this.timeToNext=0,this.paused=!1,this.rt=null,this.remoteHistory=[],this.sendAccum=0,this.toast=null,this.isLeader=!1,this.remoteId=null,this.reconnecting=!1,this.retries=0,this.unloadHandler=null,this.waiting=!0,this.bothReady=!1,this.presenceAccum=0,this.myId=null,this.lastMsgAt=0,this.roomId=t,this.name=n}async init(t){this.renderer=new Zt(t.canvas,t.ctx);const n="/api/negotiate";this.rt=new xe(n);try{await this.rt.connect(this.roomId)}catch{this.toast={text:"Online: failed to connect",t:3};return}const i=this.rt.id;this.myId=i,this.rt.onMessage(r=>{if(this.lastMsgAt=performance.now(),r.type==="state"&&r.id!==i)this.remoteHistory.push({t:r.t,x:r.x,y:r.y,vy:r.vy,score:r.score,hp:r.hp,name:r.name}),this.remoteHistory.length>30&&this.remoteHistory.shift(),this.remoteName=r.name||this.remoteName;else if(r.type==="spawn"&&this.isLeader===!1){const c=t.canvas.height,f=80,l=t.canvas.width+f,p=r.topH,x=r.gap;this.speed=r.speed,this.obstacles.push(new ot(l,0,f,p,this.speed)),this.obstacles.push(new ot(l,p+x,f,c-(p+x),this.speed))}else r.type==="join"&&r.id!==i?(this.remoteId=r.id,this.remoteName=r.name,this.isLeader=i<r.id,this.toast={text:`${r.name||"Opponent"} joined`,t:2.5},this.bothReady=!0,this.isLeader&&this.waiting&&setTimeout(()=>{var c;(c=this.rt)==null||c.send({type:"start",id:i,roomId:this.roomId,t:performance.now()}),this.waiting=!1},800)):r.type==="start"?this.waiting=!1:r.type==="leave"&&r.id!==i&&(this.toast={text:"Opponent left",t:3},this.waiting=!0,this.bothReady=!1,this.remoteId=null)}),this.toast={text:`Connected • Room ${this.roomId}`,t:2.5},this.rt.send({type:"join",id:i,roomId:this.roomId,name:this.name}),this.rt.onDisconnected(()=>{this.toast={text:"Online: disconnected",t:3},!this.reconnecting&&this.retries<2&&(this.reconnecting=!0,this.retries++,setTimeout(()=>this.reconnect(n),1500))}),this.unloadHandler=r=>{var c;try{(c=this.rt)==null||c.send({type:"leave",id:i,roomId:this.roomId})}catch{}},window.addEventListener("beforeunload",this.unloadHandler)}dispose(){var t;try{this.rt&&this.myId&&this.rt.send({type:"leave",id:this.myId,roomId:this.roomId})}catch{}try{this.unloadHandler&&window.removeEventListener("beforeunload",this.unloadHandler)}catch{}try{(t=this.rt)==null||t.close()}catch{}}async reconnect(t){this.rt;const n=this.name;this.rt=new xe(t);try{await this.rt.connect(this.roomId);const i=this.rt.id;this.toast={text:"Online: reconnected",t:2.5},this.rt.onMessage(r=>{if(this.lastMsgAt=performance.now(),r.type==="state"&&r.id!==i)this.remoteHistory.push({t:r.t,x:r.x,y:r.y,vy:r.vy,score:r.score,hp:r.hp,name:r.name}),this.remoteHistory.length>30&&this.remoteHistory.shift(),this.remoteName=r.name||this.remoteName;else if(r.type==="spawn"&&this.isLeader===!1){const c=this.renderer.canvas.height,f=80,l=this.renderer.canvas.width+f,p=r.topH,x=r.gap;this.speed=r.speed,this.obstacles.push(new ot(l,0,f,p,this.speed)),this.obstacles.push(new ot(l,p+x,f,c-(p+x),this.speed))}else r.type==="join"&&r.id!==i?(this.remoteId=r.id,this.remoteName=r.name,this.isLeader=i<r.id):r.type==="leave"&&r.id!==i&&(this.toast={text:"Opponent left",t:3})}),this.rt.onDisconnected(()=>{this.toast={text:"Online: disconnected",t:3}}),this.rt.send({type:"join",id:this.rt.id,roomId:this.roomId,name:n})}catch{this.toast={text:"Online: reconnection failed",t:3}}finally{this.reconnecting=!1}}update(t,n){var x;if(this.paused)return;if(this.waiting){this.rt&&this.myId&&(this.presenceAccum+=t,this.presenceAccum>=1&&(this.presenceAccum=0,this.rt.send({type:"join",id:this.myId,roomId:this.roomId,name:this.name})));return}(n.input.wasPressed("Space")||n.input.wasPressed("ArrowUp"))&&(H.jump(this.p1),N.flap());const i=n.input.getMovementDirection();this.p1.vx=i.x*80,H.applyGravity(this.p1,t),this.p1.update(t);const r=n.canvas.height;if(this.p1.y=Math.max(0,Math.min(r-this.p1.height,this.p1.y)),this.rt){this.sendAccum+=t;const m=1/25;if(this.sendAccum>=m){this.sendAccum=0;const w={type:"state",id:this.rt.id,t:performance.now(),x:this.p1.x,y:this.p1.y,vy:this.p1.vy,score:this.s1,hp:this.p1.hp,name:this.name};this.rt.send(w)}}const f=performance.now()-100;for(;this.remoteHistory.length>=2&&this.remoteHistory[1].t<=f;)this.remoteHistory.shift();const l=this.remoteHistory[0],p=this.remoteHistory[1];if(l&&p){const m=(f-l.t)/Math.max(1,p.t-l.t),w=(u,g,M)=>u+(g-u)*Math.max(0,Math.min(1,M));this.p2.x=w(l.x,p.x,m),this.p2.y=w(l.y,p.y,m),this.p2.vy=w(l.vy,p.vy,m),this.s2=Math.max(l.score,p.score)}else l&&(this.p2.x=l.x,this.p2.y=l.y,this.p2.vy=l.vy,this.s2=l.score);if(this.timeToNext-=t,this.timeToNext<=0){this.speed=Math.min(260,this.speed+2);const m=Math.max(130,180-Math.max(this.s1,this.s2)*2);this.timeToNext=Math.max(1,1.7-Math.max(this.s1,this.s2)*.02);const w=40,u=r-m-40,g=Math.floor(Math.random()*(u-w+1))+w,M=80,v=n.canvas.width+M;this.isLeader&&(this.obstacles.push(new ot(v,0,M,g,this.speed)),this.obstacles.push(new ot(v,g+m,M,r-(g+m),this.speed)),(x=this.rt)==null||x.send({type:"spawn",id:this.rt.id,t:performance.now(),w:M,gap:m,topH:g,speed:this.speed}))}for(const m of this.obstacles)m.update(t);this.obstacles=this.obstacles.filter(m=>!m.isOffScreen())}render(t,n){if(this.renderer.clear(1/60),this.waiting){t.fillStyle="#e8e8f0",t.font="700 24px system-ui";const m=this.bothReady?"Found opponent! Starting…":`Waiting in room ${this.roomId}…`,w=t.measureText(m).width;t.fillText(m,Math.max(20,(n.canvas.width-w)/2),120),t.font="600 14px system-ui",t.fillStyle="#94a3b8";const u="Share the code with your friend. Game starts when they join.",g=t.measureText(u).width;t.fillText(u,Math.max(20,(n.canvas.width-g)/2),150);const v=`Connected players: ${1+(this.remoteId?1:0)}/2`;t.fillStyle="#cdd9e5",t.font="700 14px system-ui";const _=t.measureText(v).width,E=Math.max(20,(n.canvas.width-_)/2),S=180;t.fillText(v,E+18,S);const I=performance.now(),A=I-this.lastMsgAt;let R="#ef4444";A<2e3?R="#22c55e":A<5e3&&(R="#facc15");const j=.6+.4*Math.sin(I/250);t.save(),t.fillStyle=R,t.beginPath(),t.arc(E+8,S-4,5*j,0,Math.PI*2),t.fill(),t.restore()}this.renderer.drawPlayer(this.p1,"#58a6ff"),this.renderer.drawPlayer(this.p2,"#ff7b72");for(const m of this.obstacles)this.renderer.drawObstacle(m);this.hud.render(t,this.s1,this.s2),t.fillStyle="#cdd9e5",t.font="700 12px system-ui",this.name&&t.fillText(this.name,this.p1.x,Math.max(12,this.p1.y-6)),this.remoteName&&t.fillText(this.remoteName,this.p2.x,Math.max(12,this.p2.y-6)),t.fillStyle="#94a3b8",t.font="600 12px system-ui";const i=this.isLeader?"Leader":"Follower",r=1+(this.remoteId?1:0),c=`Online • Room ${this.roomId} • ${i} • Players ${r}/2`;t.fillText(c,32,n.canvas.height-8);const f=performance.now(),l=f-this.lastMsgAt;let p="#ef4444";l<2e3?p="#22c55e":l<5e3&&(p="#facc15");const x=.6+.4*Math.sin(f/250);if(t.save(),t.fillStyle=p,t.beginPath(),t.arc(16,n.canvas.height-12,5*x,0,Math.PI*2),t.fill(),t.restore(),this.toast){this.toast.t-=1/60,t.save(),t.globalAlpha=Math.max(0,Math.min(1,this.toast.t/3)),t.fillStyle="#000000aa";const m=this.toast.text;t.font="700 16px system-ui";const w=t.measureText(m).width+20;t.fillRect(20,20,w,34),t.fillStyle="#e8e8f0",t.fillText(m,30,42),t.restore(),this.toast.t<=0&&(this.toast=null)}}}class ki{constructor(){this.t=0,this.onlineModalOpen=!1,this.modalCreateBtn=null,this.modalJoinBtn=null,this.modalCancelBtn=null,this.btnS=null,this.btnV=null,this.btnVO=null,this.btnEditName=null}launchOnline(t){this.onlineModalOpen=!0}onResize(t){t.ctx.setTransform(1,0,0,1,0,0)}init(t){t.canvas.focus();let n=!1;const i=()=>{t.canvas.onpointerdown=null,t.canvas.ontouchstart=null,t.canvas.onclick=null,document.removeEventListener("touchstart",x),document.removeEventListener("pointerdown",p),document.removeEventListener("click",m)},r=(w,u=!1)=>{if(w&&u){this.launchOnline(t);return}this.onlineModalOpen||n||(n=!0,i(),t.setScene(w?new Kt:new kt))},c=w=>{try{w.stopPropagation()}catch{}if(this.btnS||this.btnV||this.btnEditName){const u=t.canvas.getBoundingClientRect(),g=t.canvas.width/u.width,M=t.canvas.height/u.height,v=(w.clientX-u.left)*g,_=(w.clientY-u.top)*M;if(this.onlineModalOpen){const E=S=>S&&v>=S.x&&v<=S.x+S.w&&_>=S.y&&_<=S.y+S.h;if(E(this.modalCreateBtn)){const S=tt.getPlayerName()||"Anon",I=typeof window<"u"&&window.prompt("Your name",S)||S;tt.setPlayerName(I);const A=Math.random().toString(36).slice(2,6).toUpperCase();if(typeof window<"u")try{window.alert(`Room code: ${A}
Share this code with your friend to join.`)}catch{}if(n)return;n=!0,i(),t.setScene(new Xt(A.toLowerCase(),I));return}if(E(this.modalJoinBtn)){const S=tt.getPlayerName()||"Anon",I=typeof window<"u"&&window.prompt("Your name",S)||S;tt.setPlayerName(I);const R=((typeof window<"u"?window.prompt("Enter room code to join",""):"")||"").trim();if(!R){this.onlineModalOpen=!1;return}if(n)return;n=!0,i(),t.setScene(new Xt(R.toLowerCase(),I));return}if(E(this.modalCancelBtn)){this.onlineModalOpen=!1;return}return}if(this.btnS&&v>=this.btnS.x&&v<=this.btnS.x+this.btnS.w&&_>=this.btnS.y&&_<=this.btnS.y+this.btnS.h)return r(!1);if(this.btnV&&v>=this.btnV.x&&v<=this.btnV.x+this.btnV.w&&_>=this.btnV.y&&_<=this.btnV.y+this.btnV.h)return r(!0);if(this.btnVO&&v>=this.btnVO.x&&v<=this.btnVO.x+this.btnVO.w&&_>=this.btnVO.y&&_<=this.btnVO.y+this.btnVO.h)return r(!0,!0);if(this.btnEditName&&v>=this.btnEditName.x&&v<=this.btnEditName.x+this.btnEditName.w&&_>=this.btnEditName.y&&_<=this.btnEditName.y+this.btnEditName.h){try{const E=tt.getPlayerName()||"Anon",S=typeof window<"u"?window.prompt("Your name",E):null;S!=null&&tt.setPlayerName(S)}catch{}return}}r(!1)},f=w=>{var g;try{w.stopPropagation()}catch{}const u=((g=w.touches)==null?void 0:g.length)??0;r(u>=2)},l=w=>{try{w.stopPropagation()}catch{}r(!1)},p=w=>{this.onlineModalOpen||r(!1)},x=w=>{var g;const u=((g=w.touches)==null?void 0:g.length)??0;this.onlineModalOpen||r(u>=2)},m=w=>{this.onlineModalOpen||r(!1)};t.canvas.onpointerdown=c,t.canvas.ontouchstart=f,t.canvas.onclick=l,document.addEventListener("pointerdown",p,{passive:!0}),document.addEventListener("touchstart",x,{passive:!0}),document.addEventListener("click",m,{passive:!0})}update(t,n){this.t+=t,n.input.wasPressed("KeyS")&&n.setScene(new kt),n.input.wasPressed("KeyV")&&n.setScene(new Kt),n.input.wasPressed("KeyO")&&this.launchOnline(n),n.input.wasPressed("Escape")&&this.onlineModalOpen&&(this.onlineModalOpen=!1),n.input.wasPressed("KeyM")&&(N.muted=!N.muted),n.input.wasPressed("KeyR")&&it.toggleReducedMotion(),n.input.wasPressed("KeyC")&&tt.clear();const{ctx:i}=n,r=n.canvas.width,c=n.canvas.height,f=i.createLinearGradient(0,0,0,c);f.addColorStop(0,"#0b1023"),f.addColorStop(1,"#1a2247"),i.fillStyle=f,i.fillRect(0,0,r,c),i.save(),i.globalAlpha=.2;for(let C=0;C<60;C++){const U=C*91%r,P=C*53%c;i.fillStyle=C%2?"#d0e0ff":"#a0b8ff",i.fillRect(U,P+(Math.sin(this.t+C)*2+2)|0,2,2)}i.restore();const l=Math.sin(this.t*2)*6;i.textBaseline="top";const p="CrappBird";i.font="900 72px system-ui, ui-sans-serif, -apple-system, Segoe UI";const x=i.measureText(p).width,m=Math.max(24,(r-x)/2),w=56+l,u=i.createLinearGradient(m,w,m,w+72);u.addColorStop(0,"#e6f0ff"),u.addColorStop(1,"#9cc9ff"),i.save(),i.shadowColor="#3b82f6aa",i.shadowBlur=18,i.fillStyle=u,i.fillText(p,m,w),i.restore(),i.strokeStyle="#58a6ff",i.lineWidth=5,i.beginPath(),i.moveTo(m,w+72+6),i.lineTo(m+Math.min(520,x*.65),w+72+6),i.stroke();const g=m-80,M=w+10,v=18,_=Math.sin(this.t*10)*.6;i.fillStyle="#58a6ff",i.beginPath(),i.arc(g,M,v,0,Math.PI*2),i.fill(),i.fillStyle="#ffffffaa",i.beginPath(),i.arc(g-v*.2,M+v*.1,v*.7,Math.PI*.1,Math.PI*1.2),i.fill(),i.save(),i.translate(g-v*.2,M),i.rotate(-.8+_),i.fillStyle="#00000022",i.beginPath(),i.ellipse(0,0,v*.9,v*.5,0,0,Math.PI*2),i.fill(),i.restore(),i.fillStyle="#ffd166",i.beginPath(),i.moveTo(g+v*.9,M),i.lineTo(g+v*1.4,M-v*.2),i.lineTo(g+v*.9,M+v*.2),i.closePath(),i.fill(),i.fillStyle="#fff",i.beginPath(),i.arc(g+v*.2,M-v*.3,v*.22,0,Math.PI*2),i.fill(),i.fillStyle="#000",i.beginPath(),i.arc(g+v*.25,M-v*.3,v*.1,0,Math.PI*2),i.fill(),i.save();const E=i.createRadialGradient(r/2,c/2,Math.min(r,c)*.2,r/2,c/2,Math.max(r,c)*.6);E.addColorStop(0,"rgba(0,0,0,0)"),E.addColorStop(1,"rgba(0,0,0,0.35)"),i.fillStyle=E,i.fillRect(0,0,r,c),i.restore();const S=Math.min(560,r-64),I=170,A=(r-S)/2;i.fillStyle="#0f172ae6",i.beginPath(),i.roundRect(A,I,S,150,14),i.fill(),i.fillStyle="#cdd9e5",i.font="700 22px system-ui",i.fillText("Play",A+16,I+16);const R=18,j=44,z=16,V=3,$=Math.floor((S-z*2-R*(V-1))/V),xt=$*V+R*(V-1),st=A+Math.max(z,(S-xt)/2),X=I+56,ht=(C,U,P,G)=>{i.fillStyle="#15223f",i.strokeStyle="#58a6ffaa",i.lineWidth=3,i.beginPath(),i.roundRect(C,U,$,j,10),i.fill(),i.stroke(),G&&(i.fillStyle="#9cc9ff",i.font="700 18px system-ui",i.fillText(G,C+12,U+28)),i.fillStyle="#e8e8f0",i.font="600 18px system-ui",i.fillText(P,C+(G?36:14),U+28)};ht(st,X,"S — Singleplayer","🎮"),ht(st+$+R,X,"V — Versus (Local)","🤝"),ht(st+($+R)*2,X,"O — Versus (Online)","🌐"),this.btnS={x:st,y:X,w:$,h:j},this.btnV={x:st+$+R,y:X,w:$,h:j},this.btnVO={x:st+($+R)*2,y:X,w:$,h:j};const ft=I+170,vt=Math.min(760,r-64),ut=(r-vt)/2;i.fillStyle="#0f172acc",i.beginPath(),i.roundRect(ut,ft,vt,160,14),i.fill(),i.fillStyle="#cdd9e5",i.font="700 20px system-ui",i.fillText("Controls",ut+16,ft+16),i.font="500 16px system-ui";let dt=ft+46;i.fillText("Singleplayer: Flap = Space/ArrowUp/W or Click/Tap • Move = ArrowLeft/Right or A/D • Shoot = Right Click or Ctrl/J (hold)",ut+16,dt),dt+=28,i.fillText("Versus (Local): P1 = Arrows + Space • P2 = W (flap), S (nudge down)",ut+16,dt),dt+=28,i.fillText(`Online: O — create or join room • Mute = M (${N.muted?"Muted":"Sound on"}) • Reduced motion = R (${it.reducedMotion?"On":"Off"}) • Esc returns here`,ut+16,dt);const Mt=ft+170,Bt=Math.min(760,r-64),_t=(r-Bt)/2;i.fillStyle="#0f172acc",i.beginPath(),i.roundRect(_t,Mt,Bt,130,14),i.fill(),i.fillStyle="#cdd9e5",i.font="700 20px system-ui",i.fillText("Power-ups",_t+16,Mt+16),i.font="500 14px system-ui";let D=Mt+44;const q=[["+ Heal","gain 1 heart"],["R Rapid","shorter cooldown"],["S Shield","+1 max heart and heal"],["M Multishot","fires 3 bullets"],["B Bigshot","bigger bullets, +1 dmg"],["⌛ Slowmo","world slows briefly"],["U Magnet","pulls pickups nearby"]];for(const[C,U]of q)i.fillText(`${C} — ${U}`,_t+16,D),D+=20;const pt=tt.getTop(5);if(pt.length){const C=Math.min(420,r-40),U=28+pt.length*22+20,P=(r-C)/2,G=c-U-80;i.fillStyle="#0f172acc",i.beginPath(),i.roundRect(P,G,C,U,10),i.fill(),i.fillStyle="#cdd9e5",i.font="700 16px system-ui",i.fillText("Top Scores",P+12,G+20),i.font="500 14px system-ui";for(let nt=0;nt<pt.length;nt++){const yt=pt[nt],lt=`${nt+1}. ${(yt.name||"Anon").slice(0,18)} — ${yt.score}`;i.fillText(lt,P+12,G+44+nt*22)}i.font="400 12px system-ui",i.fillStyle="#94a3b8",i.fillText("Press C to clear • Name is saved locally",P+12,G+U-10);const J=92,et=22,W=P+C-J-10,Z=G+10;i.fillStyle="#15223f",i.strokeStyle="#58a6ff88",i.lineWidth=2,i.beginPath(),i.roundRect(W,Z,J,et,6),i.fill(),i.stroke(),i.fillStyle="#e8e8f0",i.font="600 12px system-ui",i.fillText("Edit name",W+12,Z+15),this.btnEditName={x:W,y:Z,w:J,h:et}}const Ct=.5+.5*Math.sin(this.t*3);i.save(),i.globalAlpha=.6+.4*Ct,i.fillStyle="#7dd3fc",i.font="700 18px system-ui";const St="Tap to start • Starts easy, ramps up • Two-finger tap for Versus (S/V)",Pt=i.measureText(St).width;if(i.fillText(St,Math.max(20,(r-Pt)/2),c-60),i.restore(),this.onlineModalOpen){i.save(),i.fillStyle="rgba(0,0,0,0.5)",i.fillRect(0,0,r,c);const C=Math.min(420,r-40),U=200,P=(r-C)/2,G=Math.max(60,c*.25);i.fillStyle="#0f172ae6",i.beginPath(),i.roundRect(P,G,C,U,12),i.fill(),i.strokeStyle="#58a6ff55",i.stroke(),i.fillStyle="#cdd9e5",i.font="700 20px system-ui",i.fillText("Online Match",P+16,G+16),i.font="500 14px system-ui",i.fillStyle="#94a3b8",i.fillText("Create a room to host, or join with a code from a friend.",P+16,G+44);const J=(C-16*3)/2,et=40,W=G+U-et-20;i.fillStyle="#15223f",i.strokeStyle="#58a6ffaa",i.lineWidth=3,i.beginPath(),i.roundRect(P+16,W,J,et,10),i.fill(),i.stroke(),i.fillStyle="#e8e8f0",i.font="600 16px system-ui",i.fillText("Create Room",P+16+14,W+26),this.modalCreateBtn={x:P+16,y:W,w:J,h:et},i.fillStyle="#15223f",i.strokeStyle="#58a6ffaa",i.lineWidth=3,i.beginPath(),i.roundRect(P+16*2+J,W,J,et,10),i.fill(),i.stroke(),i.fillStyle="#e8e8f0",i.font="600 16px system-ui",i.fillText("Join Room",P+16*2+J+14,W+26),this.modalJoinBtn={x:P+16*2+J,y:W,w:J,h:et},i.fillStyle="#9cc9ff",i.font="600 14px system-ui";const Z="Cancel (Esc)",nt=i.measureText(Z).width,yt=P+C-nt-16,lt=G+16;i.fillText(Z,yt,lt+2),this.modalCancelBtn={x:yt-6,y:lt-6,w:nt+12,h:24},i.restore()}else this.modalCreateBtn=this.modalJoinBtn=this.modalCancelBtn=null}render(){}}const ne=document.getElementById("gameCanvas");ne.style.width="100vw";ne.style.height="100vh";const Et=new Ge(ne);let Oe="title";const Tt=h=>{switch(Oe=h,h){case"title":Et.setScene(new ki);break;case"single":Et.setScene(new kt);break;case"versus":Et.setScene(new Kt);break;case"versusOnline":{const t="Anon",n="test";Et.setScene(new Xt(n,t));break}}};Tt("title");window.addEventListener("keydown",h=>{Oe==="title"?(h.code==="KeyS"&&Tt("single"),h.code==="KeyV"&&Tt("versus"),h.code==="KeyO"&&Tt("versusOnline")):h.code==="Escape"&&Tt("title")});window.addEventListener("resize",()=>Et.resizeToDisplay());
